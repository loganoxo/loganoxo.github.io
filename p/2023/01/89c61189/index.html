<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="SpringCloud相关"><meta name=keywords content="SpringCloud,分布式,教程"><title>1.SpringCloud实用篇01</title>
<link rel=canonical href=https://logan.wssw.fun/p/2023/01/89c61189/><link rel=stylesheet href=/scss/style.min.1780358b3b0c34cedae95c6394b24756f04ccbd83bae6b515b374e6933250f75.css><meta property='og:title' content="1.SpringCloud实用篇01"><meta property='og:description' content="SpringCloud相关"><meta property='og:url' content='https://logan.wssw.fun/p/2023/01/89c61189/'><meta property='og:site_name' content='Logan的博客'><meta property='og:type' content='article'><meta property='article:section' content='Draft'><meta property='article:tag' content='SpringCloud'><meta property='article:published_time' content='2023-01-03T15:49:51+08:00'><meta property='article:modified_time' content='2024-05-09T01:20:49+08:00'><meta property='og:image' content='https://logan.wssw.fun/img/share.jpg'><meta name=twitter:site content="@loganovo297796"><meta name=twitter:creator content="@loganovo297796"><meta name=twitter:title content="1.SpringCloud实用篇01"><meta name=twitter:description content="SpringCloud相关"><meta name=twitter:card content="summary"><meta name=twitter:image content='https://logan.wssw.fun/img/share.jpg'><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script async src="https://www.googletagmanager.com/gtag/js?id=G-R7GQB9XXQW"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-R7GQB9XXQW")}</script><meta name=google-site-verification content="3CAZCWVpDIWQxfZCqLMpov13bCzaH1QdnlHZTNnNjfM"><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css crossorigin=anonymous><script src=https://cdn.bootcdn.net/ajax/libs/busuanzi/2.3.0/bsz.pure.mini.min.js crossorigin=anonymous async></script><meta name=referrer content="no-referrer-when-downgrade"><script src=/js/sceneanimation.min.8c8c65611aaf0c8996e6d8a06f3e3bc82e6c8d2d2ab542e7cde8df7bceeeba9e.js integrity="sha256-jIxlYRqvDImW5tigbz47yC5sjS0qtULnzejfe87uup4=" crossorigin=anonymous async></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e==="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar-3K_hu560d426f92925c766fafa78be2429fd1_3226_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy decoding=async alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>Logan🌀</a></h1><h2 class=site-description>Starry serenade ✍️</h2></div></header><ol class=menu-social><li><a href=https://github.com/loganoxo target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://blog.csdn.net/u014229652 target=_blank title=my_csdn rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/articles/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-heart" width="44" height="44" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/></svg>
<span>我的</span></a></li><li><a href=/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/page/photos/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-camera" width="44" height="44" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7h1a2 2 0 002-2 1 1 0 011-1h6a1 1 0 011 1 2 2 0 002 2h1a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9a2 2 0 012-2"/><path d="M9 13a3 3 0 106 0 3 3 0 00-6 0"/></svg>
<span>相册</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/timeline/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-fish-christianity" width="44" height="44" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 7S16.354 17 9.692 17c-3.226.025-6.194-1.905-7.692-5 1.498-3.095 4.466-5.025 7.692-5C16.354 7 22 17 22 17"/></svg>
<span>年轴</span></a></li><li><a href=/page/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友链</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" p-id="14930" width="128" height="128"><path d="M253.939302 502.92736a269.74208 269.74208.0 00122.90048 235.84768 257.024 257.024.0 00259.95264 9.07264c81.46944-44.27776 135.70048-130.49856 139.0592-226.7136 5.14048-147.3536-107.37664-270.1312-250.63424-275.1488-145.32608-5.05856-266.1376 109.568-271.27808 256.94208zM531.730022.3072c16.384.57344 32.256 15.48288 31.62112 33.8944l-3.72736 106.43456c-.57344 16.384-15.4624 32.256-33.8944 31.60064-16.384-.57344-32.23552-15.4624-31.60064-33.8944l3.72736-106.43456c2.74432-20.3776 15.4624-32.23552 33.87392-31.60064zm493.89568 527.52384c-.57344 16.384-13.35296 30.26944-33.8944 31.60064l-104.36608-3.64544c-16.384-.57344-32.19456-17.53088-31.62112-33.8944.57344-16.384 15.48288-32.256 33.8944-31.60064l104.38656 3.64544a32.3584 32.3584.0 0131.60064 33.8944zm-855.53152-29.9008c-.57344 16.384-13.35296 30.28992-33.8944 31.62112l-104.38656-3.64544c-16.384-.57344-32.17408-17.5104-31.60064-33.8944.57344-16.384 15.4624-32.256 33.8944-31.60064l104.38656 3.64544a32.3584 32.3584.0 0131.60064 33.8944zm325.91872 525.76256c-16.384-.57344-32.256-15.48288-31.62112-33.8944l3.72736-106.43456c.57344-16.384 15.4624-32.256 33.8944-31.60064 16.384.57344 32.23552 15.4624 31.60064 33.8944l-3.72736 106.43456c-2.74432 20.3776-17.5104 32.1536-33.87392 31.60064zm401.32608-871.26016c11.85792 12.6976 11.0592 35.2256-1.6384 47.06304l-78.37696 73.09312c-12.6976 11.85792-33.1776 11.14112-47.08352-1.6384-11.83744-12.6976-11.0592-35.2256 1.6384-47.08352l78.39744-73.09312c16.85504-13.74208 35.2256-11.0592 47.06304 1.6384zm-15.50336 737.1776c-12.6976 11.85792-31.1296 11.22304-47.06304-1.6384l-70.9632-80.34304c-11.85792-12.6976-11.0592-35.2256 1.6384-47.08352s35.2256-11.0592 47.08352 1.6384l73.07264 78.37696c9.728 14.68416 8.94976 37.21216-3.76832 49.0496zm-596.31616-645.8368c-12.6976 11.85792-31.1296 11.20256-47.06304-1.6384l-73.09312-78.37696c-11.85792-12.6976-11.0592-35.2256 1.6384-47.08352s35.2256-11.0592 47.08352 1.6384l73.09312 78.37696c11.776 14.7456 11.0592 35.2256-1.6384 47.08352zm-138.24 614.05184c-11.85792-12.71808-11.0592-35.2256 1.6384-47.08352l78.37696-73.09312c12.6976-11.83744 33.1776-11.12064 47.08352 1.6384 11.83744 12.71808 11.0592 35.2256-1.6384 47.104l-78.39744 73.07264c-16.7936 11.71456-35.2256 11.0592-47.06304-1.6384z" fill="#ffb948"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="128" height="128"><path d="M578.256332 591.814252v-82.970701m0 95.54202a12.655127 12.655127.0 01-12.571318-12.571319v-82.970701a12.571318 12.571318.0 1125.142636.0v82.970701a12.571318 12.571318.0 01-12.571318 12.571319z" fill="#f89b1b"/><path d="M598.873294 479.342858a36.959676 36.959676.0 01-27.573092-61.59946 52.380493 52.380493.0 1062.521357 36.540632 36.875867 36.875867.0 01-34.948265 25.058828zm204.0744-109.035234v-82.970701m0 95.542019a12.571318 12.571318.0 01-12.571318-12.571318v-82.970701a12.571318 12.571318.0 1125.142636.0v82.970701a12.571318 12.571318.0 01-12.571318 12.571318z" fill="#f89b1b"/><path d="M823.9837 257.83623a36.959676 36.959676.0 01-27.6569-61.515651 52.129067 52.129067.0 1064.616576 50.285273 53.050963 53.050963.0 00-2.011411-14.163685A36.875867 36.875867.0 01823.9837 257.83623z" fill="#f89b1b"/><path d="M803.282929 328.822274a59.588049 59.588049.0 0159.588049 59.588048V785.66398H743.694881V388.410322a59.588049 59.588049.0 0159.588048-59.588048zM581.776301 551.16699a143.145411 143.145411.0 01143.145411 143.145411V837.54162H438.463272V694.312401A143.145411 143.145411.0 01581.776301 551.16699z" fill="#612273"/><path d="M600.968514 198.667225l-49.111951-4.693292a8.380879 8.380879.0 01-7.039938-5.196145l-17.599845-42.658674a8.380879 8.380879.0 00-15.672244.0l-17.432228 42.658674a8.380879 8.380879.0 01-7.039938 5.196145l-49.11195 4.693292a8.380879 8.380879.0 00-4.777101 14.750347l36.959676 32.51781a8.380879 8.380879.0 012.681881 8.380878l-11.06276 45.67579a8.380879 8.380879.0 0012.487509 9.302776L515.232123 285.074086a8.380879 8.380879.0 018.380879.0l40.982497 24.136931a8.380879 8.380879.0 0012.571319-9.302776l-10.978952-45.675789a8.380879 8.380879.0 012.681882-8.380879L606.08085 213.417572a8.380879 8.380879.0 00-5.028528-14.750347z" fill="#fed150"/><path d="M470.897274 246.77347l1.927602-8.380879a8.380879 8.380879.0 00-2.681881-8.380879l-35.032074-30.506399a8.380879 8.380879.0 00-1.927602 13.912259l36.959676 32.51781a6.788512 6.788512.0 01.754279.838088zM603.98563 199.589122l-34.948265 30.674016a8.380879 8.380879.0 00-2.681881 8.380879l1.927602 8.380879a6.788512 6.788512.0 01.754279-.838088l37.043485-32.769236a8.380879 8.380879.0 00-2.09522-13.82845zm-28.578797 92.189667a8.380879 8.380879.0 01-10.643716 1.759985l-40.982498-24.053123a8.380879 8.380879.0 00-8.380879.0L474.249625 293.454965a8.380879 8.380879.0 01-10.643716-1.676176l-1.927602 8.380879a8.380879 8.380879.0 0012.487509 9.302775l41.066307-24.388357a8.380879 8.380879.0 018.380879.0l40.982497 24.136931a8.380879 8.380879.0 0012.571319-9.302776z" fill="#fed150" opacity=".5"/><path d="M434.608068 426.543321l-28.159753-2.681881a4.86091 4.86091.0 01-4.022822-3.017117l-10.057054-24.388357a4.86091 4.86091.0 00-8.967541.0l-9.973245 24.388357a4.693292 4.693292.0 01-4.022822 3.017117l-28.159753 2.681881a4.86091 4.86091.0 00-2.76569 8.380879l21.203623 18.605551a4.944719 4.944719.0 011.592367 4.777101L354.654484 484.455194a4.86091 4.86091.0 007.123747 5.363762l23.466461-13.82845a5.196145 5.196145.0 014.944718.0l23.466461 13.82845a4.86091 4.86091.0 007.123747-5.363762l-6.285659-26.064533a4.86091 4.86091.0 011.508558-4.777101l21.203624-18.605551a4.86091 4.86091.0 00-2.849499-8.380879z" fill="#fed150"/><path d="M360.102055 454.032604l1.173323-4.609484a4.944719 4.944719.0 00-1.592367-5.112336l-20.0303-17.683654a4.944719 4.944719.0 00-1.173323 8.380879l21.203623 18.605551zm76.182189-26.98643-20.0303 17.26461a4.86091 4.86091.0 00-1.508559 4.777101l1.173323 4.693292v-.502852l21.203624-18.605551a4.86091 4.86091.0 00-.838088-7.6266zM419.94153 479.845711a4.777101 4.777101.0 01-6.034233 1.005705l-23.46646-13.82845a5.196145 5.196145.0 00-4.944719.0l-23.466461 13.82845a4.777101 4.777101.0 01-6.034233-1.005705l-1.089514 4.609483a4.86091 4.86091.0 007.123747 5.363762l23.466461-13.82845a5.196145 5.196145.0 014.944719.0l23.46646 13.82845a4.86091 4.86091.0 007.123747-5.363762z" fill="#fed150" opacity=".5"/><path d="M635.413926 803.68287A414.685886 414.685886.0 01459.41547 18.729756 9.805628 9.805628.0 00453.967898.124205a513.831683 513.831683.0 10567.050264 607.027056 9.805628 9.805628.0 00-18.186507-6.704704A414.350651 414.350651.0 01635.413926 803.68287z" fill="#fed150" p-id="22313"/><path d="M50.931434 292.868303a460.110249 460.110249.0 00275.311871 359.455895 413.847798 413.847798.0 01133.339782-633.594442A9.805628 9.805628.0 00453.967898.124205 513.915492 513.915492.0 0050.931434 292.868303z" fill="#fed150" opacity=".4" p-id="22314"/><path d="M1006.016389 597.261823A513.664065 513.664065.0 013.914704 475.320036c-.670471 10.308481-1.257132 20.616962-1.257132 31.093061a513.831683 513.831683.0 001018.36059 100.570546 9.805628 9.805628.0 00-15.001773-9.72182zM231.539373 332.258434c0 7.458982.67047 14.917964 1.257132 22.293138A414.769695 414.769695.0 01459.583087 18.729756 9.805628 9.805628.0 00453.967898.124205a505.869848 505.869848.0 00-94.620122 20.868388A413.177328 413.177328.0 00231.539373 332.258434z" fill="#fed150" opacity=".5" p-id="22315"/><path d="M715.032275 421.514794m17.683654.0h141.217809q17.683654.0 17.683655 17.683654v-.083809q0 17.683654-17.683655 17.683655H732.715929q-17.683654.0-17.683654-17.683655v.083809q0-17.683654 17.683654-17.683654z" fill="#eb3d72" p-id="22316"/><path d="M205.139605 319.603307c4.441866-6.872321 22.041711-45.340555-11.817039-67.047031s-51.626214 8.380879-51.626214 8.380879a25.142637 25.142637.0 1042.742482 27.489282s2.179029 5.950424-6.537085 18.437934-25.142637 12.236083-43.077718.754279-47.01673-65.789899-.67047-138.787354c1.592367-2.514264 3.352352-4.693292 5.028527-7.039938a26.818812 26.818812.0 00-23.047417-2.430455 33.523515 33.523515.0 00-18.689359 17.683654c-31.260678 64.36515-22.628373 127.724594 21.203623 155.884347 48.944333 31.093061 82.048804-6.453277 86.49067-13.325597zM734.224488 931.491272c6.453277-2.681881 37.713955-21.45505 24.304548-53.386198s-40.647262-19.35983-40.647262-19.35983a21.874094 21.874094.0 1016.761757 40.312027s-1.340941 5.363762-13.577023 9.973246S697.264812 905.259122 689.889638 888.497364s-1.340941-69.561295 67.047031-98.894371c2.346646-1.005705 4.693292-1.676176 7.039938-2.514263a31.931148 31.931148.0 00-1.927602-3.352352 28.578797 28.578797.0 00-38.635851-7.542791c-51.87764 30.841634-74.422204 81.545951-57.325212 122.277023 19.778874 46.262451 61.59946 35.786353 68.136546 33.020662zM279.813236 802.844782c-5.950424-3.687587-39.390131-18.354125-57.660447 11.146569s7.794217 44.334849 7.794217 44.334849a21.874094 21.874094.0 1023.047417-36.875867s5.112336-2.011411 16.007479 5.279954 10.811334 21.622667 1.173323 37.211102-55.984271 41.317733-119.511333 2.430455c-2.179029-1.340941-4.106631-2.849499-6.118041-4.274249a22.376947 22.376947.0 00-1.676176 3.51997 28.662606 28.662606.0 0016.342714 36.037779c55.146183 24.388357 109.538087 13.409406 132.920739-24.136931 26.399768-42.9101-6.369468-70.902235-12.319892-74.673631zM431.00429 694.312401h302.298301m0 20.952197H431.00429a20.952197 20.952197.0 010-41.904394h302.298301a20.952197 20.952197.0 010 41.904394z" fill="#eb3d72" p-id="22317"/><path d="M255.760113 683.082023m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".4" p-id="22318"/><path d="M356.246851 840.977781m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".4" p-id="22319"/><path d="M54.870447 472.135302m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".4" p-id="22320"/><path d="M561.410765 873.914635m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".5" p-id="22321"/><path d="M445.167976 825.13792m-19.862683.0a19.862683 19.862683.0 1039.725365.0 19.862683 19.862683.0 10-39.725365.0z" fill="#fed150" opacity=".5" p-id="22322"/><path d="M149.406761 689.786726m-19.862683.0a19.862683 19.862683.0 1039.725365.0 19.862683 19.862683.0 10-39.725365.0z" fill="#fed150" opacity=".5" p-id="22323"/><path d="M132.225959 633.299603m-18.940786.0a18.940786 18.940786.0 1037.881572.0 18.940786 18.940786.0 10-37.881572.0z" fill="#fed150" opacity=".4" p-id="22324"/><path d="M475.339139 906.935297m-18.940786.0a18.940786 18.940786.0 1037.881573.0 18.940786 18.940786.0 10-37.881573.0z" fill="#fed150" opacity=".4" p-id="22325"/></svg>
<span>主题</span></li></ol></li></ol></aside><main class="main full-width"><div class=breadcrumb><li><a href=/>首页</a></li><li><a href=/p/>未整理</a></li><li class=active><a href=/p/2023/01/89c61189/>1.SpringCloud实用篇01</a></li></div><article class=main-article><header class="article-header not-page"><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352z"/></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"/><use href="#gentle-wave" x="48" y="3"/><use href="#gentle-wave" x="48" y="5"/><use href="#gentle-wave" x="48" y="7"/></g></svg></section><div class=article-details><header class=article-category><a href=/categories/spring-cloud/ style=background-color:#43766c;color:#fff>Spring Cloud</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/2023/01/89c61189/>1.SpringCloud实用篇01</a></h2><h3 class=article-subtitle>SpringCloud相关</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2023年1月3日</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 20 分钟</time></div></footer></div></header><section class=article-content><h1 id=springcloud01><a href=#springcloud01 class=header-anchor>#</a>
SpringCloud01</h1><h1 id=1认识微服务><a href=#1%e8%ae%a4%e8%af%86%e5%be%ae%e6%9c%8d%e5%8a%a1 class=header-anchor>#</a>
1.认识微服务</h1><p>随着互联网行业的发展，对服务的要求也越来越高，服务架构也从单体架构逐渐演变为现在流行的微服务架构。这些架构之间有怎样的差别呢？</p><h2 id=10学习目标><a href=#10%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87 class=header-anchor>#</a>
1.0.学习目标</h2><p>了解微服务架构的优缺点</p><h2 id=11单体架构><a href=#11%e5%8d%95%e4%bd%93%e6%9e%b6%e6%9e%84 class=header-anchor>#</a>
1.1.单体架构</h2><p><strong>单体架构</strong>：将业务的所有功能集中在一个项目中开发，打成一个包部署。</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-eb9a1224d4e49b.png width=900 height=600 loading=lazy decoding=async alt=image-20210713202807818 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>单体架构的优缺点如下：</p><p><strong>优点：</strong></p><ul><li>架构简单</li><li>部署成本低</li></ul><p><strong>缺点：</strong></p><ul><li>耦合度高（维护困难、升级困难）</li></ul><h2 id=12分布式架构><a href=#12%e5%88%86%e5%b8%83%e5%bc%8f%e6%9e%b6%e6%9e%84 class=header-anchor>#</a>
1.2.分布式架构</h2><p><strong>分布式架构</strong>：根据业务功能对系统做拆分，每个业务功能模块作为独立项目开发，称为一个服务。</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-15a1cd88f139e2.png width=900 height=600 loading=lazy decoding=async alt=image-20210713203124797 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>分布式架构的优缺点：</p><p><strong>优点：</strong></p><ul><li>降低服务耦合</li><li>有利于服务升级和拓展</li></ul><p><strong>缺点：</strong></p><ul><li>服务调用关系错综复杂</li></ul><p>分布式架构虽然降低了服务耦合，但是服务拆分时也有很多问题需要思考：</p><ul><li>服务拆分的粒度如何界定？</li><li>服务之间如何调用？</li><li>服务的调用关系如何管理？</li></ul><p>人们需要制定一套行之有效的标准来约束分布式架构。</p><h2 id=13微服务><a href=#13%e5%be%ae%e6%9c%8d%e5%8a%a1 class=header-anchor>#</a>
1.3.微服务</h2><p>微服务的架构特征：</p><ul><li>单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责</li><li>自治：团队独立、技术独立、数据独立，独立部署和交付</li><li>面向服务：服务提供统一标准的接口，与语言和技术无关</li><li>隔离性强：服务调用做好隔离、容错、降级，避免出现级联问题</li></ul><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-f97e4d64984d2c.png width=900 height=600 loading=lazy decoding=async alt=image-20210713203753373 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>微服务的上述特性其实是在给分布式架构制定一个标准，进一步降低服务之间的耦合度，提供服务的独立性和灵活性。做到高内聚，低耦合。</p><p>因此，可以认为<strong>微服务</strong>是一种经过良好架构设计的<strong>分布式架构方案</strong> 。</p><p>但方案该怎么落地？选用什么样的技术栈？全球的互联网公司都在积极尝试自己的微服务落地方案。</p><p>其中在Java领域最引人注目的就是SpringCloud提供的方案了。</p><h2 id=14springcloud><a href=#14springcloud class=header-anchor>#</a>
1.4.SpringCloud</h2><p>SpringCloud是目前国内使用最广泛的微服务框架。官网地址：https://spring.io/projects/spring-cloud。</p><p>SpringCloud集成了各种微服务功能组件，并基于SpringBoot实现了这些组件的自动装配，从而提供了良好的开箱即用体验。</p><p>其中常见的组件包括：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-3d0f11479d543f.png width=900 height=600 loading=lazy decoding=async alt=image-20210713204155887 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>另外，SpringCloud底层是依赖于SpringBoot的，并且有版本的兼容关系，如下：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-6b9c0e96398832.png width=900 height=600 loading=lazy decoding=async alt=image-20210713205003790 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>我们课堂学习的版本是 Hoxton.SR10，因此对应的SpringBoot版本是2.3.x版本。</p><h2 id=15总结><a href=#15%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
1.5.总结</h2><ul><li><p>单体架构：简单方便，高度耦合，扩展性差，适合小型项目。例如：学生管理系统</p></li><li><p>分布式架构：松耦合，扩展性好，但架构复杂，难度大。适合大型互联网项目，例如：京东、淘宝</p></li><li><p>微服务：一种良好的分布式架构方案</p><p>①优点：拆分粒度更小、服务更独立、耦合度更低</p><p>②缺点：架构非常复杂，运维、监控、部署难度提高</p></li><li><p>SpringCloud是微服务架构的一站式解决方案，集成了各种优秀微服务功能组件</p></li></ul><h1 id=2服务拆分和远程调用><a href=#2%e6%9c%8d%e5%8a%a1%e6%8b%86%e5%88%86%e5%92%8c%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8 class=header-anchor>#</a>
2.服务拆分和远程调用</h1><p>任何分布式架构都离不开服务的拆分，微服务也是一样。</p><h2 id=21服务拆分原则><a href=#21%e6%9c%8d%e5%8a%a1%e6%8b%86%e5%88%86%e5%8e%9f%e5%88%99 class=header-anchor>#</a>
2.1.服务拆分原则</h2><p>这里我总结了微服务拆分时的几个原则：</p><ul><li>不同微服务，不要重复开发相同业务</li><li>微服务数据独立，不要访问其它微服务的数据库</li><li>微服务可以将自己的业务暴露为接口，供其它微服务调用</li></ul><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-a5fcb3f2c14dbb.png width=900 height=600 loading=lazy decoding=async alt=image-20210713210800950 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=22服务拆分示例><a href=#22%e6%9c%8d%e5%8a%a1%e6%8b%86%e5%88%86%e7%a4%ba%e4%be%8b class=header-anchor>#</a>
2.2.服务拆分示例</h2><p>以课前资料中的微服务cloud-demo为例，其结构如下：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-86110964ef7705.png width=900 height=600 loading=lazy decoding=async alt=image-20210713211009593 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>cloud-demo：父工程，管理依赖</p><ul><li>order-service：订单微服务，负责订单相关业务</li><li>user-service：用户微服务，负责用户相关业务</li></ul><p>要求：</p><ul><li>订单微服务和用户微服务都必须有各自的数据库，相互独立</li><li>订单服务和用户服务都对外暴露Restful的接口</li><li>订单服务如果需要查询用户信息，只能调用用户服务的Restful接口，不能查询用户数据库</li></ul><h3 id=221导入sql语句><a href=#221%e5%af%bc%e5%85%a5sql%e8%af%ad%e5%8f%a5 class=header-anchor>#</a>
2.2.1.导入Sql语句</h3><p>首先，将课前资料提供的<code>cloud-order.sql</code>和<code>cloud-user.sql</code>导入到mysql中：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-da6086a4f5008e.png width=900 height=600 loading=lazy decoding=async alt=image-20210713211417049 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>cloud-user表中初始数据如下：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-02d1276e119efc.png width=900 height=600 loading=lazy decoding=async alt=image-20210713211550169 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>cloud-order表中初始数据如下：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-c4624331021a4e.png width=900 height=600 loading=lazy decoding=async alt=image-20210713211657319 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>cloud-order表中持有cloud-user表中的id字段。</p><h3 id=222导入demo工程><a href=#222%e5%af%bc%e5%85%a5demo%e5%b7%a5%e7%a8%8b class=header-anchor>#</a>
2.2.2.导入demo工程</h3><p>用IDEA导入课前资料提供的Demo：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-3b235b0623cb24.png width=900 height=600 loading=lazy decoding=async alt=image-20210713211814094 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>项目结构如下：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-99774f945e5ecf.png width=900 height=600 loading=lazy decoding=async alt=image-20210713212656887 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>导入后，会在IDEA右下角出现弹窗：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-14bda477c09d17.png width=900 height=600 loading=lazy decoding=async alt=image-20210713212349272 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>点击弹窗，然后按下图选择：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-8a4e2c22056c2f.png width=900 height=600 loading=lazy decoding=async alt=image-20210713212336185 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>会出现这样的菜单：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-a378b2c221a85b.png width=900 height=600 loading=lazy decoding=async alt=image-20210713212513324 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>配置下项目使用的JDK：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-e3db32e58797bc.png width=900 height=600 loading=lazy decoding=async alt=image-20210713220736408 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=23实现远程调用案例><a href=#23%e5%ae%9e%e7%8e%b0%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8%e6%a1%88%e4%be%8b class=header-anchor>#</a>
2.3.实现远程调用案例</h2><p>在order-service服务中，有一个根据id查询订单的接口：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-4743a60b356f9a.png width=900 height=600 loading=lazy decoding=async alt=image-20210713212749575 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>根据id查询订单，返回值是Order对象，如图：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-4db8d739f59f35.png width=900 height=600 loading=lazy decoding=async alt=image-20210713212901725 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>其中的user为null</p><p>在user-service中有一个根据id查询用户的接口：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-9cc322f14a6494.png width=900 height=600 loading=lazy decoding=async alt=image-20210713213146089 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>查询的结果如图：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-b6698f74b85258.png width=900 height=600 loading=lazy decoding=async alt=image-20210713213213075 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h3 id=231案例需求><a href=#231%e6%a1%88%e4%be%8b%e9%9c%80%e6%b1%82 class=header-anchor>#</a>
2.3.1.案例需求：</h3><p>修改order-service中的根据id查询订单业务，要求在查询订单的同时，根据订单中包含的userId查询出用户信息，一起返回。</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-b7a851b0a4e8e5.png width=900 height=600 loading=lazy decoding=async alt=image-20210713213312278 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>因此，我们需要在order-service中 向user-service发起一个http的请求，调用http://localhost:8081/user/{userId}这个接口。</p><p>大概的步骤是这样的：</p><ul><li>注册一个RestTemplate的实例到Spring容器</li><li>修改order-service服务中的OrderService类中的queryOrderById方法，根据Order对象中的userId查询User</li><li>将查询的User填充到Order对象，一起返回</li></ul><h3 id=232注册resttemplate><a href=#232%e6%b3%a8%e5%86%8cresttemplate class=header-anchor>#</a>
2.3.2.注册RestTemplate</h3><p>首先，我们在order-service服务中的OrderApplication启动类中，注册RestTemplate实例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>cn.itcast.order</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.mybatis.spring.annotation.MapperScan</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.SpringApplication</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.autoconfigure.SpringBootApplication</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.client.RestTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@MapperScan</span><span class=p>(</span><span class=s>&#34;cn.itcast.order.mapper&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@SpringBootApplication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderApplication</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>OrderApplication</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RestTemplate</span><span class=w> </span><span class=nf>restTemplate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RestTemplate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=233实现远程调用><a href=#233%e5%ae%9e%e7%8e%b0%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8 class=header-anchor>#</a>
2.3.3.实现远程调用</h3><p>修改order-service服务中的cn.itcast.order.service包下的OrderService类中的queryOrderById方法：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-1f8f9b8c7ff6ad.png width=900 height=600 loading=lazy decoding=async alt=image-20210713213959569 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=24提供者与消费者><a href=#24%e6%8f%90%e4%be%9b%e8%80%85%e4%b8%8e%e6%b6%88%e8%b4%b9%e8%80%85 class=header-anchor>#</a>
2.4.提供者与消费者</h2><p>在服务调用关系中，会有两个不同的角色：</p><p><strong>服务提供者</strong>：一次业务中，被其它微服务调用的服务。（提供接口给其它微服务）</p><p><strong>服务消费者</strong>：一次业务中，调用其它微服务的服务。（调用其它微服务提供的接口）</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-6a502bcb496038.png width=900 height=600 loading=lazy decoding=async alt=image-20210713214404481 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>但是，服务提供者与服务消费者的角色并不是绝对的，而是相对于业务而言。</p><p>如果服务A调用了服务B，而服务B又调用了服务C，服务B的角色是什么？</p><ul><li>对于A调用B的业务而言：A是服务消费者，B是服务提供者</li><li>对于B调用C的业务而言：B是服务消费者，C是服务提供者</li></ul><p>因此，服务B既可以是服务提供者，也可以是服务消费者。</p><h1 id=3eureka注册中心><a href=#3eureka%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83 class=header-anchor>#</a>
3.Eureka注册中心</h1><p>假如我们的服务提供者user-service部署了多个实例，如图：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-31ada1cfe857fe.png width=900 height=600 loading=lazy decoding=async alt=image-20210713214925388 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>大家思考几个问题：</p><ul><li>order-service在发起远程调用的时候，该如何得知user-service实例的ip地址和端口？</li><li>有多个user-service实例地址，order-service调用时该如何选择？</li><li>order-service如何得知某个user-service实例是否依然健康，是不是已经宕机？</li></ul><h2 id=31eureka的结构和作用><a href=#31eureka%e7%9a%84%e7%bb%93%e6%9e%84%e5%92%8c%e4%bd%9c%e7%94%a8 class=header-anchor>#</a>
3.1.Eureka的结构和作用</h2><p>这些问题都需要利用SpringCloud中的注册中心来解决，其中最广为人知的注册中心就是Eureka，其结构如下：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-f7fbeac2424d7c.png width=900 height=600 loading=lazy decoding=async alt=image-20210713220104956 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>回答之前的各个问题。</p><p>问题1：order-service如何得知user-service实例地址？</p><p>获取地址信息的流程如下：</p><ul><li>user-service服务实例启动后，将自己的信息注册到eureka-server（Eureka服务端）。这个叫服务注册</li><li>eureka-server保存服务名称到服务实例地址列表的映射关系</li><li>order-service根据服务名称，拉取实例地址列表。这个叫服务发现或服务拉取</li></ul><p>问题2：order-service如何从多个user-service实例中选择具体的实例？</p><ul><li>order-service从实例列表中利用负载均衡算法选中一个实例地址</li><li>向该实例地址发起远程调用</li></ul><p>问题3：order-service如何得知某个user-service实例是否依然健康，是不是已经宕机？</p><ul><li>user-service会每隔一段时间（默认30秒）向eureka-server发起请求，报告自己状态，称为心跳</li><li>当超过一定时间没有发送心跳时，eureka-server会认为微服务实例故障，将该实例从服务列表中剔除</li><li>order-service拉取服务时，就能将故障实例排除了</li></ul><blockquote><p>注意：一个微服务，既可以是服务提供者，又可以是服务消费者，因此eureka将服务注册、服务发现等功能统一封装到了eureka-client端</p></blockquote><p>因此，接下来我们动手实践的步骤包括：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-d718306e66034f.png width=900 height=600 loading=lazy decoding=async alt=image-20210713220509769 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=32搭建eureka-server><a href=#32%e6%90%ad%e5%bb%baeureka-server class=header-anchor>#</a>
3.2.搭建eureka-server</h2><p>首先大家注册中心服务端：eureka-server，这必须是一个独立的微服务</p><h3 id=321创建eureka-server服务><a href=#321%e5%88%9b%e5%bb%baeureka-server%e6%9c%8d%e5%8a%a1 class=header-anchor>#</a>
3.2.1.创建eureka-server服务</h3><p>在cloud-demo父工程下，创建一个子模块：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-267d6f93613f35.png width=900 height=600 loading=lazy decoding=async alt=image-20210713220605881 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>填写模块信息：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-8a716a00569edd.png width=900 height=600 loading=lazy decoding=async alt=image-20210713220857396 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>然后填写服务信息：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-0ec8e5a245d6aa.png width=900 height=600 loading=lazy decoding=async alt=image-20210713221339022 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h3 id=322引入eureka依赖><a href=#322%e5%bc%95%e5%85%a5eureka%e4%be%9d%e8%b5%96 class=header-anchor>#</a>
3.2.2.引入eureka依赖</h3><p>引入SpringCloud为eureka提供的starter依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=323编写启动类><a href=#323%e7%bc%96%e5%86%99%e5%90%af%e5%8a%a8%e7%b1%bb class=header-anchor>#</a>
3.2.3.编写启动类</h3><p>给eureka-server服务编写一个启动类，一定要添加一个@EnableEurekaServer注解，开启eureka的注册中心功能：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>cn.itcast.eureka</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.SpringApplication</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.autoconfigure.SpringBootApplication</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.cloud.netflix.eureka.server.EnableEurekaServer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@SpringBootApplication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableEurekaServer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>EurekaApplication</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>EurekaApplication</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=324编写配置文件><a href=#324%e7%bc%96%e5%86%99%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 class=header-anchor>#</a>
3.2.4.编写配置文件</h3><p>编写一个application.yml文件，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4>4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5>5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6>6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7>7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8>8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>10086</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>eureka-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>eureka</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service-url</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultZone</span><span class=p>:</span><span class=w> </span><span class=l>http://127.0.0.1:10086/eureka</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=325启动服务><a href=#325%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1 class=header-anchor>#</a>
3.2.5.启动服务</h3><p>启动微服务，然后在浏览器访问：http://127.0.0.1:10086</p><p>看到下面结果应该是成功了：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-ca5f92688fe83b.png width=900 height=600 loading=lazy decoding=async alt=image-20210713222157190 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=33服务注册><a href=#33%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c class=header-anchor>#</a>
3.3.服务注册</h2><p>下面，我们将user-service注册到eureka-server中去。</p><h3 id=1引入依赖><a href=#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96 class=header-anchor>#</a>
1）引入依赖</h3><p>在user-service的pom文件中，引入下面的eureka-client依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2>2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3>3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2配置文件><a href=#2%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 class=header-anchor>#</a>
2）配置文件</h3><p>在user-service中，修改application.yml文件，添加服务名称、eureka地址：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2>2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3>3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4>4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5>5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6>6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>userservice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>eureka</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service-url</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultZone</span><span class=p>:</span><span class=w> </span><span class=l>http://127.0.0.1:10086/eureka</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3启动多个user-service实例><a href=#3%e5%90%af%e5%8a%a8%e5%a4%9a%e4%b8%aauser-service%e5%ae%9e%e4%be%8b class=header-anchor>#</a>
3）启动多个user-service实例</h3><p>为了演示一个服务有多个实例的场景，我们添加一个SpringBoot的启动配置，再启动一个user-service。</p><p>首先，复制原来的user-service启动配置：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-44432a514fd4d2.png width=900 height=600 loading=lazy decoding=async alt=image-20210713222656562 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>然后，在弹出的窗口中，填写信息：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-3f72c6e94da5aa.png width=900 height=600 loading=lazy decoding=async alt=image-20210713222757702 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>现在，SpringBoot窗口会出现两个user-service启动配置：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-e4ffcfb4dcdd42.png width=900 height=600 loading=lazy decoding=async alt=image-20210713222841951 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>不过，第一个是8081端口，第二个是8082端口。</p><p>启动两个user-service实例：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-33813862b2c4ca.png width=900 height=600 loading=lazy decoding=async alt=image-20210713223041491 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>查看eureka-server管理页面：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-333425d905efd2.png width=900 height=600 loading=lazy decoding=async alt=image-20210713223150650 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=34服务发现><a href=#34%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0 class=header-anchor>#</a>
3.4.服务发现</h2><p>下面，我们将order-service的逻辑修改：向eureka-server拉取user-service的信息，实现服务发现。</p><h3 id=1引入依赖-1><a href=#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96-1 class=header-anchor>#</a>
1）引入依赖</h3><p>之前说过，服务发现、服务注册统一都封装在eureka-client依赖，因此这一步与服务注册时一致。</p><p>在order-service的pom文件中，引入下面的eureka-client依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1>1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2>2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3>3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2配置文件-1><a href=#2%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6-1 class=header-anchor>#</a>
2）配置文件</h3><p>服务发现也需要知道eureka地址，因此第二步与服务注册一致，都是配置eureka信息：</p><p>在order-service中，修改application.yml文件，添加服务名称、eureka地址：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5>5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6>6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>orderservice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>eureka</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service-url</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultZone</span><span class=p>:</span><span class=w> </span><span class=l>http://127.0.0.1:10086/eureka</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3服务拉取和负载均衡><a href=#3%e6%9c%8d%e5%8a%a1%e6%8b%89%e5%8f%96%e5%92%8c%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1 class=header-anchor>#</a>
3）服务拉取和负载均衡</h3><p>最后，我们要去eureka-server中拉取user-service服务的实例列表，并且实现负载均衡。</p><p>不过这些动作不用我们去做，只需要添加一些注解即可。</p><p>在order-service的OrderApplication中，给RestTemplate这个Bean添加一个@LoadBalanced注解：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-665428243226d6.png width=900 height=600 loading=lazy decoding=async alt=image-20210713224049419 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>修改order-service服务中的cn.itcast.order.service包下的OrderService类中的queryOrderById方法。修改访问的url路径，用服务名代替ip、端口：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-eacf4a8c31a299.png width=900 height=600 loading=lazy decoding=async alt=image-20210713224245731 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>spring会自动帮助我们从eureka-server端，根据userservice这个服务名称，获取实例列表，而后完成负载均衡。</p><h1 id=4ribbon负载均衡><a href=#4ribbon%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1 class=header-anchor>#</a>
4.Ribbon负载均衡</h1><p>上一节中，我们添加了@LoadBalanced注解，即可实现负载均衡功能，这是什么原理呢？</p><h2 id=41负载均衡原理><a href=#41%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
4.1.负载均衡原理</h2><p>SpringCloud底层其实是利用了一个名为Ribbon的组件，来实现负载均衡功能的。</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-9ff17fd9513b46.png width=900 height=600 loading=lazy decoding=async alt=image-20210713224517686 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>那么我们发出的请求明明是http://userservice/user/1，怎么变成了http://localhost:8081的呢？</p><h2 id=42源码跟踪><a href=#42%e6%ba%90%e7%a0%81%e8%b7%9f%e8%b8%aa class=header-anchor>#</a>
4.2.源码跟踪</h2><p>为什么我们只输入了service名称就可以访问了呢？之前还要获取ip和端口。</p><p>显然有人帮我们根据service名称，获取到了服务实例的ip和端口。它就是<code>LoadBalancerInterceptor</code>，这个类会在对RestTemplate的请求进行拦截，然后从Eureka根据服务id获取服务列表，随后利用负载均衡算法得到真实的服务地址信息，替换服务id。</p><p>我们进行源码跟踪：</p><h3 id=1loadbalancerintercepor><a href=#1loadbalancerintercepor class=header-anchor>#</a>
1）LoadBalancerIntercepor</h3><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-854fca6cf4dd5a.png width=900 height=600 loading=lazy decoding=async alt=1525620483637 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>可以看到这里的intercept方法，拦截了用户的HttpRequest请求，然后做了几件事：</p><ul><li><code>request.getURI()</code>：获取请求uri，本例中就是 http://user-service/user/8</li><li><code>originalUri.getHost()</code>：获取uri路径的主机名，其实就是服务id，<code>user-service</code></li><li><code>this.loadBalancer.execute()</code>：处理服务id，和用户请求。</li></ul><p>这里的<code>this.loadBalancer</code>是<code>LoadBalancerClient</code>类型，我们继续跟入。</p><h3 id=2loadbalancerclient><a href=#2loadbalancerclient class=header-anchor>#</a>
2）LoadBalancerClient</h3><p>继续跟入execute方法：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-163ff00dc9d648.png width=900 height=600 loading=lazy decoding=async alt=1525620787090 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>代码是这样的：</p><ul><li>getLoadBalancer(serviceId)：根据服务id获取ILoadBalancer，而ILoadBalancer会拿着服务id去eureka中获取服务列表并保存起来。</li><li>getServer(loadBalancer)：利用内置的负载均衡算法，从服务列表中选择一个。本例中，可以看到获取了8082端口的服务</li></ul><p>放行后，再次访问并跟踪，发现获取的是8081：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-7cf43a6005d41c.png width=900 height=600 loading=lazy decoding=async alt=1525620835911 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>果然实现了负载均衡。</p><h3 id=3负载均衡策略irule><a href=#3%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5irule class=header-anchor>#</a>
3）负载均衡策略IRule</h3><p>在刚才的代码中，可以看到获取服务使通过一个<code>getServer</code>方法来做负载均衡:</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-7cf43a6005d41c.png width=900 height=600 loading=lazy decoding=async alt=1525620835911 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>我们继续跟入：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-1d97c11ca26fdf.png width=900 height=600 loading=lazy decoding=async alt=1544361421671 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>继续跟踪源码chooseServer方法，发现这么一段代码：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-3a6ea4d4515d55.png width=900 height=600 loading=lazy decoding=async alt=1525622652849 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>我们看看这个rule是谁：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-8e084f98b5530c.png width=900 height=600 loading=lazy decoding=async alt=1525622699666 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>这里的rule默认值是一个<code>RoundRobinRule</code>，看类的介绍：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-de3841292f752f.png width=900 height=600 loading=lazy decoding=async alt=1525622754316 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>这不就是轮询的意思嘛。</p><p>到这里，整个负载均衡的流程我们就清楚了。</p><h3 id=4总结><a href=#4%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
4）总结</h3><p>SpringCloudRibbon的底层采用了一个拦截器，拦截了RestTemplate发出的请求，对地址做了修改。用一幅图来总结一下：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-592a1f4e8f30d2.png width=900 height=600 loading=lazy decoding=async alt=image-20210713224724673 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>基本流程如下：</p><ul><li>拦截我们的RestTemplate请求http://userservice/user/1</li><li>RibbonLoadBalancerClient会从请求url中获取服务名称，也就是user-service</li><li>DynamicServerListLoadBalancer根据user-service到eureka拉取服务列表</li><li>eureka返回列表，localhost:8081、localhost:8082</li><li>IRule利用内置负载均衡规则，从列表中选择一个，例如localhost:8081</li><li>RibbonLoadBalancerClient修改请求地址，用localhost:8081替代userservice，得到http://localhost:8081/user/1，发起真实请求</li></ul><h2 id=43负载均衡策略><a href=#43%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5 class=header-anchor>#</a>
4.3.负载均衡策略</h2><h3 id=431负载均衡策略><a href=#431%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5 class=header-anchor>#</a>
4.3.1.负载均衡策略</h3><p>负载均衡的规则都定义在IRule接口中，而IRule有很多不同的实现类：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-6d8e8e9d8e4aec.png width=900 height=600 loading=lazy decoding=async alt=image-20210713225653000 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>不同规则的含义如下：</p><div class=table-wrapper><table><thead><tr><th><strong>内置负载均衡规则类</strong></th><th><strong>规则描述</strong></th></tr></thead><tbody><tr><td>RoundRobinRule</td><td>简单轮询服务列表来选择服务器。它是Ribbon默认的负载均衡规则。</td></tr><tr><td>AvailabilityFilteringRule</td><td>对以下两种服务器进行忽略： （1）在默认情况下，这台服务器如果3次连接失败，这台服务器就会被设置为“短路”状态。短路状态将持续30秒，如果再次连接失败，短路的持续时间就会几何级地增加。 （2）并发数过高的服务器。如果一个服务器的并发连接数过高，配置了AvailabilityFilteringRule规则的客户端也会将其忽略。并发连接数的上限，可以由客户端的<clientname>.<clientconfignamespace>.ActiveConnectionsLimit属性进行配置。</td></tr><tr><td>WeightedResponseTimeRule</td><td>为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。</td></tr><tr><td><strong>ZoneAvoidanceRule</strong></td><td>以区域可用的服务器为基础进行服务器的选择。使用Zone对服务器进行分类，这个Zone可以理解为一个机房、一个机架等。而后再对Zone内的多个服务做轮询。</td></tr><tr><td>BestAvailableRule</td><td>忽略那些短路的服务器，并选择并发数较低的服务器。</td></tr><tr><td>RandomRule</td><td>随机选择一个可用的服务器。</td></tr><tr><td>RetryRule</td><td>重试机制的选择逻辑</td></tr></tbody></table></div><p>默认的实现就是ZoneAvoidanceRule，是一种轮询方案</p><h3 id=432自定义负载均衡策略><a href=#432%e8%87%aa%e5%ae%9a%e4%b9%89%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5 class=header-anchor>#</a>
4.3.2.自定义负载均衡策略</h3><p>通过定义IRule实现可以修改负载均衡规则，有两种方式：</p><ol><li>代码方式：在order-service中的OrderApplication类中，定义一个新的IRule：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2>2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3>3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>IRule</span><span class=w> </span><span class=nf>randomRule</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RandomRule</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol start=2><li>配置文件方式：在order-service的application.yml文件中，添加新的配置也可以修改规则：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2>2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>userservice</span><span class=p>:</span><span class=w> </span><span class=c># 给某个微服务配置负载均衡规则，这里是userservice服务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ribbon</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>NFLoadBalancerRuleClassName</span><span class=p>:</span><span class=w> </span><span class=l>com.netflix.loadbalancer.RandomRule</span><span class=w> </span><span class=c># 负载均衡规则 </span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong>，一般用默认的负载均衡规则，不做修改。</p></blockquote><h2 id=44饥饿加载><a href=#44%e9%a5%a5%e9%a5%bf%e5%8a%a0%e8%bd%bd class=header-anchor>#</a>
4.4.饥饿加载</h2><p>Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间会很长。</p><p>而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，通过下面配置开启饥饿加载：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2>2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3>3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>ribbon</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>eager-load</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clients</span><span class=p>:</span><span class=w> </span><span class=l>userservice</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h1 id=5nacos注册中心><a href=#5nacos%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83 class=header-anchor>#</a>
5.Nacos注册中心</h1><p>国内公司一般都推崇阿里巴巴的技术，比如注册中心，SpringCloudAlibaba也推出了一个名为Nacos的注册中心。</p><h2 id=51认识和安装nacos><a href=#51%e8%ae%a4%e8%af%86%e5%92%8c%e5%ae%89%e8%a3%85nacos class=header-anchor>#</a>
5.1.认识和安装Nacos</h2><p><a class=link href=https://nacos.io/ target=_blank rel=noopener>Nacos
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>是阿里巴巴的产品，现在是<a class=link href=https://spring.io/projects/spring-cloud target=_blank rel=noopener>SpringCloud
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>中的一个组件。相比<a class=link href=https://github.com/Netflix/eureka target=_blank rel=noopener>Eureka
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>功能更加丰富，在国内受欢迎程度较高。</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-282dd7a06c9a48.png width=900 height=600 loading=lazy decoding=async alt=image-20210713230444308 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>安装方式可以参考课前资料《Nacos安装指南.md》</p><h2 id=52服务注册到nacos><a href=#52%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e5%88%b0nacos class=header-anchor>#</a>
5.2.服务注册到nacos</h2><p>Nacos是SpringCloudAlibaba的组件，而SpringCloudAlibaba也遵循SpringCloud中定义的服务注册、服务发现规范。因此使用Nacos和使用Eureka对于微服务来说，并没有太大区别。</p><p>主要差异在于：</p><ul><li>依赖不同</li><li>服务地址不同</li></ul><h3 id=1引入依赖-2><a href=#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96-2 class=header-anchor>#</a>
1）引入依赖</h3><p>在cloud-demo父工程的pom文件中的<code>&lt;dependencyManagement></code>中引入SpringCloudAlibaba的依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1>1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2>2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3>3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4>4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5>5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6>6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.alibaba.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-alibaba-dependencies<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>2.2.6.RELEASE<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;type&gt;</span>pom<span class=nt>&lt;/type&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;scope&gt;</span>import<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>然后在user-service和order-service中的pom文件中引入nacos-discovery依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.alibaba.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong>：不要忘了注释掉eureka的依赖。</p></blockquote><h3 id=2配置nacos地址><a href=#2%e9%85%8d%e7%bd%aenacos%e5%9c%b0%e5%9d%80 class=header-anchor>#</a>
2）配置nacos地址</h3><p>在user-service和order-service的application.yml中添加nacos地址：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3>3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nacos</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>server-addr</span><span class=p>:</span><span class=w> </span><span class=l>localhost:8848</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong>：不要忘了注释掉eureka的地址</p></blockquote><h3 id=3重启><a href=#3%e9%87%8d%e5%90%af class=header-anchor>#</a>
3）重启</h3><p>重启微服务后，登录nacos管理页面，可以看到微服务信息：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-eed3c224fd4737.png width=900 height=600 loading=lazy decoding=async alt=image-20210713231439607 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=53服务分级存储模型><a href=#53%e6%9c%8d%e5%8a%a1%e5%88%86%e7%ba%a7%e5%ad%98%e5%82%a8%e6%a8%a1%e5%9e%8b class=header-anchor>#</a>
5.3.服务分级存储模型</h2><p>一个<strong>服务</strong>可以有多个<strong>实例</strong>，例如我们的user-service，可以有:</p><ul><li>127.0.0.1:8081</li><li>127.0.0.1:8082</li><li>127.0.0.1:8083</li></ul><p>假如这些实例分布于全国各地的不同机房，例如：</p><ul><li>127.0.0.1:8081，在上海机房</li><li>127.0.0.1:8082，在上海机房</li><li>127.0.0.1:8083，在杭州机房</li></ul><p>Nacos就将同一机房内的实例 划分为一个<strong>集群</strong>。</p><p>也就是说，user-service是服务，一个服务可以包含多个集群，如杭州、上海，每个集群下可以有多个实例，形成分级模型，如图：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-0431eeea9ab1ed.png width=900 height=600 loading=lazy decoding=async alt=image-20210713232522531 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>微服务互相访问时，应该尽可能访问同集群实例，因为本地访问速度更快。当本集群内不可用时，才访问其它集群。例如：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-662350aca151c4.png width=900 height=600 loading=lazy decoding=async alt=image-20210713232658928 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>杭州机房内的order-service应该优先访问同机房的user-service。</p><h3 id=531给user-service配置集群><a href=#531%e7%bb%99user-service%e9%85%8d%e7%bd%ae%e9%9b%86%e7%be%a4 class=header-anchor>#</a>
5.3.1.给user-service配置集群</h3><p>修改user-service的application.yml文件，添加集群配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1>1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2>2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3>3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4>4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5>5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nacos</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>server-addr</span><span class=p>:</span><span class=w> </span><span class=l>localhost:8848</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>discovery</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cluster-name</span><span class=p>:</span><span class=w> </span><span class=l>HZ</span><span class=w> </span><span class=c># 集群名称</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>重启两个user-service实例后，我们可以在nacos控制台看到下面结果：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-463d7e6c7ee441.png width=900 height=600 loading=lazy decoding=async alt=image-20210713232916215 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>我们再次复制一个user-service启动配置，添加属性：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>-Dserver.port<span class=o>=</span><span class=m>8083</span> -Dspring.cloud.nacos.discovery.cluster-name<span class=o>=</span>SH
</span></span></code></pre></td></tr></table></div></div><p>配置如图所示：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-2feebca061cd40.png width=900 height=600 loading=lazy decoding=async alt=image-20210713233528982 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>启动UserApplication3后再次查看nacos控制台：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-c93f19bb52b619.png width=900 height=600 loading=lazy decoding=async alt=image-20210713233727923 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h3 id=532同集群优先的负载均衡><a href=#532%e5%90%8c%e9%9b%86%e7%be%a4%e4%bc%98%e5%85%88%e7%9a%84%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1 class=header-anchor>#</a>
5.3.2.同集群优先的负载均衡</h3><p>默认的<code>ZoneAvoidanceRule</code>并不能实现根据同集群优先来实现负载均衡。</p><p>因此Nacos中提供了一个<code>NacosRule</code>的实现，可以优先从同集群中挑选实例。</p><p>1）给order-service配置集群信息</p><p>修改order-service的application.yml文件，添加集群配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1>1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2>2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3>3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4>4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5>5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>spring:
</span></span><span class=line><span class=cl>  cloud:
</span></span><span class=line><span class=cl>    nacos:
</span></span><span class=line><span class=cl>      server-addr: localhost:8848
</span></span><span class=line><span class=cl>      discovery:
</span></span><span class=line><span class=cl>        cluster-name: HZ <span class=c1># 集群名称</span>
</span></span></code></pre></td></tr></table></div></div><p>2）修改负载均衡规则</p><p>修改order-service的application.yml文件，修改负载均衡规则：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1>1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2>2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>userservice</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ribbon</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>NFLoadBalancerRuleClassName</span><span class=p>:</span><span class=w> </span><span class=l>com.alibaba.cloud.nacos.ribbon.NacosRule</span><span class=w> </span><span class=c># 负载均衡规则 </span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=54权重配置><a href=#54%e6%9d%83%e9%87%8d%e9%85%8d%e7%bd%ae class=header-anchor>#</a>
5.4.权重配置</h2><p>实际部署中会出现这样的场景：</p><p>服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求。</p><p>但默认情况下NacosRule是同集群内随机挑选，不会考虑机器的性能问题。</p><p>因此，Nacos提供了权重配置来控制访问频率，权重越大则访问频率越高。</p><p>在nacos控制台，找到user-service的实例列表，点击编辑，即可修改权重：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-9276f165ea963b.png width=900 height=600 loading=lazy decoding=async alt=image-20210713235133225 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>在弹出的编辑窗口，修改权重：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-da55227d5cb54d.png width=900 height=600 loading=lazy decoding=async alt=image-20210713235235219 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><blockquote><p><strong>注意</strong>：如果权重修改为0，则该实例永远不会被访问</p></blockquote><h2 id=55环境隔离><a href=#55%e7%8e%af%e5%a2%83%e9%9a%94%e7%a6%bb class=header-anchor>#</a>
5.5.环境隔离</h2><p>Nacos提供了namespace来实现环境隔离功能。</p><ul><li>nacos中可以有多个namespace</li><li>namespace下可以有group、service等</li><li>不同namespace之间相互隔离，例如不同namespace的服务互相不可见</li></ul><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-a06af0d99675ad.png width=900 height=600 loading=lazy decoding=async alt=image-20210714000101516 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h3 id=551创建namespace><a href=#551%e5%88%9b%e5%bb%banamespace class=header-anchor>#</a>
5.5.1.创建namespace</h3><p>默认情况下，所有service、data、group都在同一个namespace，名为public：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-74d3683551affb.png width=900 height=600 loading=lazy decoding=async alt=image-20210714000414781 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>我们可以点击页面新增按钮，添加一个namespace：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-8e609c509c8f82.png width=900 height=600 loading=lazy decoding=async alt=image-20210714000440143 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>然后，填写表单：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-210831bd7b94d0.png width=900 height=600 loading=lazy decoding=async alt=image-20210714000505928 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>就能在页面看到一个新的namespace：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-48bed856c71924.png width=900 height=600 loading=lazy decoding=async alt=image-20210714000522913 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h3 id=552给微服务配置namespace><a href=#552%e7%bb%99%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%85%8d%e7%bd%aenamespace class=header-anchor>#</a>
5.5.2.给微服务配置namespace</h3><p>给微服务配置namespace只能通过修改配置来实现。</p><p>例如，修改order-service的application.yml文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1>1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2>2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3>3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4>4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5>5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6>6</a>
</span><span class=lnt id=hl-18-7><a class=lnlinks href=#hl-18-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nacos</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>server-addr</span><span class=p>:</span><span class=w> </span><span class=l>localhost:8848</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>discovery</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cluster-name</span><span class=p>:</span><span class=w> </span><span class=l>HZ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>492a7d5d-237b-46a1-a99a-fa8e98e4b0f9</span><span class=w> </span><span class=c># 命名空间，填ID</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>重启order-service后，访问控制台，可以看到下面的结果：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-cee41a9a0357dd.png width=900 height=600 loading=lazy decoding=async alt=image-20210714000830703 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-e3b1bea18c2f17.png width=900 height=600 loading=lazy decoding=async alt=image-20210714000837140 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>此时访问order-service，因为namespace不同，会导致找不到userservice，控制台会报错：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-cef5d409ebf04a.png width=900 height=600 loading=lazy decoding=async alt=image-20210714000941256 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=56nacos与eureka的区别><a href=#56nacos%e4%b8%8eeureka%e7%9a%84%e5%8c%ba%e5%88%ab class=header-anchor>#</a>
5.6.Nacos与Eureka的区别</h2><p>Nacos的服务实例分为两种l类型：</p><ul><li><p>临时实例：如果实例宕机超过一定时间，会从服务列表剔除，默认的类型。</p></li><li><p>非临时实例：如果实例宕机，不会从服务列表剔除，也可以叫永久实例。</p></li></ul><p>配置一个服务实例为永久实例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1>1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2>2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3>3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4>4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nacos</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>discovery</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ephemeral</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># 设置为非临时实例</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Nacos和Eureka整体结构类似，服务注册、服务拉取、心跳等待，但是也存在一些差异：</p><p><img src=https://logan.1357810.xyz/img/20220528/1653736909-25fe0e81a59833.png width=900 height=600 loading=lazy decoding=async alt=image-20210714001728017 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li><p>Nacos与eureka的共同点</p><ul><li>都支持服务注册和服务拉取</li><li>都支持服务提供者心跳方式做健康检测</li></ul></li><li><p>Nacos与Eureka的区别</p><ul><li>Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式</li><li>临时实例心跳不正常会被剔除，非临时实例则不会被剔除</li><li>Nacos支持服务列表变更的消息推送模式，服务列表更新更及时</li><li>Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka采用AP方式</li></ul></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/springcloud/>SpringCloud</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2024年5月9日 01:20</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/2023/01/91a71491/><div class=article-details><h2 class=article-title>10.Redis集群</h2></div></a></article><article><a href=/p/2023/01/57138157/><div class=article-details><h2 class=article-title>10.分布式缓存</h2></div></a></article><article><a href=/p/2023/01/38u56138/><div class=article-details><h2 class=article-title>11.多级缓存</h2></div></a></article><article><a href=/p/2023/01/49z67149/><div class=article-details><h2 class=article-title>11.安装Canal</h2></div></a></article><article><a href=/p/2023/01/451178u5/><div class=article-details><h2 class=article-title>11.安装OpenResty</h2></div></a></article></div></div></aside><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/waline/2.15.8/waline.min.css crossorigin=anonymous><script src=https://cdn.bootcdn.net/ajax/libs/waline/2.15.8/waline.min.js crossorigin=anonymous></script><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({copyright:!1,dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://unpkg.com/@waline/emojis@1.2.0/weibo"],lang:"zh-cn",locale:{admin:"Admin",placeholder:null},requiredMeta:["nick"],serverURL:"https://waline.wssw.fun/",turnstileKey:"0x4AAAAAAAZ2cXI-LS3tIUAh",wordLimit:100})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 &nbsp;&nbsp;by &nbsp; logan</section><section class=powerby>发表了88篇文章 ·
总计566.00k字</section><section class=powerby><div class=powerby><span id=busuanzi_container_site_pv>本站总访问量<span id=busuanzi_value_site_pv></span>次
</span><span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span></div></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.js crossorigin=anonymous defer></script><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.css crossorigin=anonymous><script src=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js crossorigin=anonymous defer></script><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css crossorigin=anonymous></main></div><script type=text/javascript src=/ts/main.js defer></script><a href=javascript:void(0) class=right_things id=back-to-top title=返回顶部></a><style>html{scroll-behavior:smooth}#back-to-top{z-index:998!important;transition:1.5s ease,opacity 2s ease,visibility 2s ease,right .8s ease;opacity:0;display:inline-block;visibility:hidden;position:fixed;bottom:10px;right:10px;width:55px;height:55px;font-size:30px;text-align:center;line-height:50px;border-radius:20px;box-shadow:var(--shadow-l1);cursor:pointer;color:var(--body-text-color);background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #241348 0%, #4d0404 100%); }}#back-to-top:before{content:' ';display:inline-block;position:relative;top:0;transform:rotate(135deg);height:10px;width:10px;border-width:0 0 2px 2px;border-style:solid}#back-to-top:hover{transform:scale(1.1,1.1);background-image:linear-gradient(-225deg,#E3FDF5 0%,#FFE6FA 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #432581 0%, #861818 100%); }}#back-to-top:hover:before{border-color:#2674e0}@media screen and (max-width:768px){#back-to-top{width:35px;height:35px;font-size:10px;right:15px}}</style><script>function resizeRight(){var t=document.querySelectorAll(".right_things"),e=window.innerWidth;t.length>0&&t.forEach(function(t){e>2100?t.style.right="280px":e>1800?t.style.right="120px":e<1800&&(t.style.right="10px")})}window.addEventListener("resize",function(){requestAnimationFrame(resizeRight)});function backToTop(){window.scrollTo({top:0,behavior:"smooth"})}window.onload=function(){requestAnimationFrame(resizeRight);var t=this.document.documentElement.scrollTop||this.document.body.scrollTop,e=this.document.getElementById("back-to-top");t>0?(e.style.visibility="visible",e.style.opacity="1"):(e.style.opacity="0",e.style.visibility="hidden")},window.onscroll=function(){var t=this.document.documentElement.scrollTop||this.document.body.scrollTop,e=this.document.getElementById("back-to-top");t<400?(e.style.opacity="0",e.style.visibility="hidden"):(e.style.visibility="visible",e.style.opacity="1",e.addEventListener("click",backToTop,!1))}</script><style>.toggle-toc-inner,.toggle-toc-inner svg{z-index:1!important;pointer-events:none}.toggle-toc-inner{width:100%;height:100%;display:flex;align-items:center;justify-content:center}.toggle-toc-inner svg{display:none}#toc-container{display:none;position:fixed;bottom:120px;right:80px;padding:5px;border:1px solid #96979a50;border-radius:var(--card-border-radius);box-shadow:rgba(14,30,37,.12)0 2px 4px,rgba(14,30,37,.32)0 2px 16px;z-index:997!important;max-height:80vh;overflow-y:auto;width:auto;max-width:500px;background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #241348 0%, #4d0404 100%); color: #FFFFFFB2; }}#TableOfContents{background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #241348 0%, #4d0404 100%); }}#TableOfContents a:hover{font-weight:bolder}[data-scheme=dark] #TableOfContents a{color:#ffffffb2}[data-scheme=dark] #TableOfContents a:hover{color:#052ed3}#toggle-toc{transition:1.5s ease,opacity 2s ease,visibility 2s ease,right .8s ease;opacity:0;display:block;visibility:hidden;position:fixed;bottom:75px;right:10px;width:55px;height:55px;font-size:1.7rem;padding:5px;z-index:1000!important;border:0 solid #96979a50;border-radius:20px;box-shadow:var(--shadow-l1);color:#707070;cursor:pointer;background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #241348 0%, #4d0404 100%); color: #FFFFFFB2; } animation: jump 0.3s 4;animation-delay:.6s}#toggle-toc:hover{transform:scale(1.1,1.1);background-image:linear-gradient(-225deg,#E3FDF5 0%,#FFE6FA 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #432581 0%, #861818 100%); }}.widget--toc #TableOfContents{overflow-x:auto;max-height:66vh;width:auto}.toggle-toc-inner::before{content:'目录'}@media screen and (max-width:1280px){#toc-container{bottom:100px;right:70px;max-width:400px}}@media screen and (max-width:768px){#toggle-toc{width:35px;height:35px;font-size:10px;bottom:60px;right:15px}.toggle-toc-inner::before{content:''}.toggle-toc-inner svg{display:block}#toc-container{bottom:100px;right:60px;max-width:290px}}</style><a id=toggle-toc class=right_things title=目录 href=javascript:void(0)><div class=toggle-toc-inner><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></div></a><section class="widget archives" id=toc-container><h2 class=section-title style=padding-left:10px>目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#springcloud01>SpringCloud01</a></li><li><a href=#1认识微服务>1.认识微服务</a><ol><li><a href=#10学习目标>1.0.学习目标</a></li><li><a href=#11单体架构>1.1.单体架构</a></li><li><a href=#12分布式架构>1.2.分布式架构</a></li><li><a href=#13微服务>1.3.微服务</a></li><li><a href=#14springcloud>1.4.SpringCloud</a></li><li><a href=#15总结>1.5.总结</a></li></ol></li><li><a href=#2服务拆分和远程调用>2.服务拆分和远程调用</a><ol><li><a href=#21服务拆分原则>2.1.服务拆分原则</a></li><li><a href=#22服务拆分示例>2.2.服务拆分示例</a><ol><li><a href=#221导入sql语句>2.2.1.导入Sql语句</a></li><li><a href=#222导入demo工程>2.2.2.导入demo工程</a></li></ol></li><li><a href=#23实现远程调用案例>2.3.实现远程调用案例</a><ol><li><a href=#231案例需求>2.3.1.案例需求：</a></li><li><a href=#232注册resttemplate>2.3.2.注册RestTemplate</a></li><li><a href=#233实现远程调用>2.3.3.实现远程调用</a></li></ol></li><li><a href=#24提供者与消费者>2.4.提供者与消费者</a></li></ol></li><li><a href=#3eureka注册中心>3.Eureka注册中心</a><ol><li><a href=#31eureka的结构和作用>3.1.Eureka的结构和作用</a></li><li><a href=#32搭建eureka-server>3.2.搭建eureka-server</a><ol><li><a href=#321创建eureka-server服务>3.2.1.创建eureka-server服务</a></li><li><a href=#322引入eureka依赖>3.2.2.引入eureka依赖</a></li><li><a href=#323编写启动类>3.2.3.编写启动类</a></li><li><a href=#324编写配置文件>3.2.4.编写配置文件</a></li><li><a href=#325启动服务>3.2.5.启动服务</a></li></ol></li><li><a href=#33服务注册>3.3.服务注册</a><ol><li><a href=#1引入依赖>1）引入依赖</a></li><li><a href=#2配置文件>2）配置文件</a></li><li><a href=#3启动多个user-service实例>3）启动多个user-service实例</a></li></ol></li><li><a href=#34服务发现>3.4.服务发现</a><ol><li><a href=#1引入依赖-1>1）引入依赖</a></li><li><a href=#2配置文件-1>2）配置文件</a></li><li><a href=#3服务拉取和负载均衡>3）服务拉取和负载均衡</a></li></ol></li></ol></li><li><a href=#4ribbon负载均衡>4.Ribbon负载均衡</a><ol><li><a href=#41负载均衡原理>4.1.负载均衡原理</a></li><li><a href=#42源码跟踪>4.2.源码跟踪</a><ol><li><a href=#1loadbalancerintercepor>1）LoadBalancerIntercepor</a></li><li><a href=#2loadbalancerclient>2）LoadBalancerClient</a></li><li><a href=#3负载均衡策略irule>3）负载均衡策略IRule</a></li><li><a href=#4总结>4）总结</a></li></ol></li><li><a href=#43负载均衡策略>4.3.负载均衡策略</a><ol><li><a href=#431负载均衡策略>4.3.1.负载均衡策略</a></li><li><a href=#432自定义负载均衡策略>4.3.2.自定义负载均衡策略</a></li></ol></li><li><a href=#44饥饿加载>4.4.饥饿加载</a></li></ol></li><li><a href=#5nacos注册中心>5.Nacos注册中心</a><ol><li><a href=#51认识和安装nacos>5.1.认识和安装Nacos</a></li><li><a href=#52服务注册到nacos>5.2.服务注册到nacos</a><ol><li><a href=#1引入依赖-2>1）引入依赖</a></li><li><a href=#2配置nacos地址>2）配置nacos地址</a></li><li><a href=#3重启>3）重启</a></li></ol></li><li><a href=#53服务分级存储模型>5.3.服务分级存储模型</a><ol><li><a href=#531给user-service配置集群>5.3.1.给user-service配置集群</a></li><li><a href=#532同集群优先的负载均衡>5.3.2.同集群优先的负载均衡</a></li></ol></li><li><a href=#54权重配置>5.4.权重配置</a></li><li><a href=#55环境隔离>5.5.环境隔离</a><ol><li><a href=#551创建namespace>5.5.1.创建namespace</a></li><li><a href=#552给微服务配置namespace>5.5.2.给微服务配置namespace</a></li></ol></li><li><a href=#56nacos与eureka的区别>5.6.Nacos与Eureka的区别</a></li></ol></li></ol></nav></div></section><script>var toggleButton=document.getElementById("toggle-toc"),tocContainer=document.getElementById("toc-container"),scrollThreshold=400;function extracted(){var e=window.scrollY||window.pageYOffset;e>=scrollThreshold?(toggleButton.style.visibility="visible",toggleButton.style.opacity="1"):(toggleButton.style.opacity="0",toggleButton.style.visibility="hidden")}window.addEventListener("scroll",function(){extracted()}),window.onload=function(){extracted()},toggleButton.addEventListener("click",function(e){tocContainer.style.display==="none"||tocContainer.style.display===""?tocContainer.style.display="block":tocContainer.style.display="none",e.stopPropagation()}),"ontouchstart"in window||toggleButton.addEventListener("mouseover",function(){tocContainer.style.display="block"}),document.addEventListener("click",function(e){!tocContainer.contains(e.target)&&!toggleButton.contains(e.target)&&e.target!==toggleButton&&e.target!==tocContainer&&(tocContainer.style.display="none")})</script><script src=https://cdn.bootcdn.net/ajax/libs/nprogress/0.2.0/nprogress.min.js crossorigin=anonymous></script><div class=top-scroll-bar></div><style>.top-scroll-bar,.page-load-progress-bar{position:fixed;top:0;left:0;z-index:9999;display:none;width:0;height:4px;border-radius:5px;background-image:linear-gradient(to right,#5a0ca6 0%,rgba(208,114,155,.84) 50%,#29d 100%); [data-scheme="light"] & { background-image: linear-gradient(to right, #78ee6e 0%, #5069e3 50%, #29d 100%); }}#nprogress{pointer-events:none}#nprogress .my_bar{background-image:linear-gradient(to right,#5a0ca6 0%,rgba(208,114,155,.84) 50%,#29d 100%); [data-scheme="light"] & { background-image: linear-gradient(to right, #78ee6e 0%, #5069e3 50%, #29d 100%); } position: fixed;z-index:9999;top:0;left:0;border-radius:10px;width:100%;height:5px}#nprogress .my_peg{display:block;position:absolute;right:0;width:100px;height:100%;box-shadow:0 0 10px #29d,0 0 5px #29d;opacity:1;-webkit-transform:rotate(3deg)translate(0,-4px);-ms-transform:rotate(3deg)translate(0,-4px);transform:rotate(3deg)translate(0,-4px)}#nprogress .my_spinner{display:block;position:fixed;z-index:1031;top:15px;right:15px}#nprogress .my_spinner-icon{width:25px;height:25px;box-sizing:border-box;border:solid 3px transparent;border-top-color:#29d;border-left-color:#29d;border-radius:50%;-webkit-animation:nprogress-spinner 400ms linear infinite;animation:nprogress-spinner 400ms linear infinite}.nprogress-custom-parent{overflow:hidden;position:relative}.nprogress-custom-parent #nprogress .my_spinner,.nprogress-custom-parent #nprogress .my_bar{position:absolute}@-webkit-keyframes nprogress-spinner{0%{-webkit-transform:rotate(0)}100%{-webkit-transform:rotate(360deg)}}@keyframes nprogress-spinner{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style><script>var my_template='<div class="my_bar" role="bar"><div class="my_peg"></div></div><div class="my_spinner" role="spinner"><div class="my_spinner-icon"></div></div>';NProgress.configure({template:my_template}),NProgress.start(),document.addEventListener("readystatechange",()=>{if(document.readyState==="interactive"&&NProgress.inc(.6),document.readyState==="complete"){NProgress.done(!0),NProgress.configure({template:my_template,minimum:0,trickle:!1,showSpinner:!1});var e=document.querySelector(".top-scroll-bar");window.addEventListener("scroll",function(){var t=document.documentElement.scrollTop||document.body.scrollTop,n=document.documentElement.scrollHeight-document.documentElement.clientHeight,s=t/n*100;e.style.width=s+"%",e.style.display="block"})}})</script><script>function loadScript(e,t){var n=document.querySelector('script[src="'+e+'"]'),s=!1;n.onload=function(){s||(s=!0,t&&window[t]())},n.onreadystatechange=function(){!s&&(n.readyState==="loaded"||n.readyState==="complete")&&(s=!0,t&&window[t]())}}</script></body></html>