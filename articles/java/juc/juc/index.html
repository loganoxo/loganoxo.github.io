<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="java多线程,JUC,线程安全"><meta name=keywords content="java多线程,JUC,线程安全,线程锁"><title>JUC</title>
<link rel=canonical href=https://logan.wssw.fun/articles/java/juc/juc/><link rel=stylesheet href=/scss/style.min.13aa7f8d1031a866f598038f5f109d260d836a6b68cfc49d43713498eb7a1e2b.css><meta property='og:title' content="JUC"><meta property='og:description' content="java多线程,JUC,线程安全"><meta property='og:url' content='https://logan.wssw.fun/articles/java/juc/juc/'><meta property='og:site_name' content='Logan的博客'><meta property='og:type' content='article'><meta property='article:section' content='Articles'><meta property='article:tag' content='java'><meta property='article:tag' content='juc'><meta property='article:published_time' content='2024-03-03T12:49:51+08:00'><meta property='article:modified_time' content='2024-05-08T21:39:00+08:00'><meta property='og:image' content='https://logan.wssw.fun/img/ttg.jpg'><meta name=twitter:title content="JUC"><meta name=twitter:description content="java多线程,JUC,线程安全"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://logan.wssw.fun/img/ttg.jpg'><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script async src="https://www.googletagmanager.com/gtag/js?id=G-R7GQB9XXQW"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-R7GQB9XXQW")}</script><meta name=google-site-verification content="3CAZCWVpDIWQxfZCqLMpov13bCzaH1QdnlHZTNnNjfM"><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css crossorigin=anonymous><script src=https://cdn.bootcdn.net/ajax/libs/busuanzi/2.3.0/bsz.pure.mini.min.js crossorigin=anonymous async></script><meta name=referrer content="no-referrer-when-downgrade"><script src=/js/sceneanimation.min.8c8c65611aaf0c8996e6d8a06f3e3bc82e6c8d2d2ab542e7cde8df7bceeeba9e.js integrity="sha256-jIxlYRqvDImW5tigbz47yC5sjS0qtULnzejfe87uup4=" crossorigin=anonymous async></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e==="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar-3K_hu560d426f92925c766fafa78be2429fd1_3226_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy decoding=async alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>Logan🌀</a></h1><h2 class=site-description>Starry serenade ✍️</h2></div></header><ol class=menu-social><li><a href=https://github.com/loganoxo target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://blog.csdn.net/u014229652 target=_blank title=my_csdn rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li class=current><a href=/articles/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-heart" width="44" height="44" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/></svg>
<span>我的</span></a></li><li><a href=/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/page/photos/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-camera" width="44" height="44" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7h1a2 2 0 002-2 1 1 0 011-1h6a1 1 0 011 1 2 2 0 002 2h1a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9a2 2 0 012-2"/><path d="M9 13a3 3 0 106 0 3 3 0 00-6 0"/></svg>
<span>相册</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/timeline/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-fish-christianity" width="44" height="44" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 7S16.354 17 9.692 17c-3.226.025-6.194-1.905-7.692-5 1.498-3.095 4.466-5.025 7.692-5C16.354 7 22 17 22 17"/></svg>
<span>年轴</span></a></li><li><a href=/page/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友链</span></a></li><li><a href=/page/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" p-id="14930" width="128" height="128"><path d="M253.939302 502.92736a269.74208 269.74208.0 00122.90048 235.84768 257.024 257.024.0 00259.95264 9.07264c81.46944-44.27776 135.70048-130.49856 139.0592-226.7136 5.14048-147.3536-107.37664-270.1312-250.63424-275.1488-145.32608-5.05856-266.1376 109.568-271.27808 256.94208zM531.730022.3072c16.384.57344 32.256 15.48288 31.62112 33.8944l-3.72736 106.43456c-.57344 16.384-15.4624 32.256-33.8944 31.60064-16.384-.57344-32.23552-15.4624-31.60064-33.8944l3.72736-106.43456c2.74432-20.3776 15.4624-32.23552 33.87392-31.60064zm493.89568 527.52384c-.57344 16.384-13.35296 30.26944-33.8944 31.60064l-104.36608-3.64544c-16.384-.57344-32.19456-17.53088-31.62112-33.8944.57344-16.384 15.48288-32.256 33.8944-31.60064l104.38656 3.64544a32.3584 32.3584.0 0131.60064 33.8944zm-855.53152-29.9008c-.57344 16.384-13.35296 30.28992-33.8944 31.62112l-104.38656-3.64544c-16.384-.57344-32.17408-17.5104-31.60064-33.8944.57344-16.384 15.4624-32.256 33.8944-31.60064l104.38656 3.64544a32.3584 32.3584.0 0131.60064 33.8944zm325.91872 525.76256c-16.384-.57344-32.256-15.48288-31.62112-33.8944l3.72736-106.43456c.57344-16.384 15.4624-32.256 33.8944-31.60064 16.384.57344 32.23552 15.4624 31.60064 33.8944l-3.72736 106.43456c-2.74432 20.3776-17.5104 32.1536-33.87392 31.60064zm401.32608-871.26016c11.85792 12.6976 11.0592 35.2256-1.6384 47.06304l-78.37696 73.09312c-12.6976 11.85792-33.1776 11.14112-47.08352-1.6384-11.83744-12.6976-11.0592-35.2256 1.6384-47.08352l78.39744-73.09312c16.85504-13.74208 35.2256-11.0592 47.06304 1.6384zm-15.50336 737.1776c-12.6976 11.85792-31.1296 11.22304-47.06304-1.6384l-70.9632-80.34304c-11.85792-12.6976-11.0592-35.2256 1.6384-47.08352s35.2256-11.0592 47.08352 1.6384l73.07264 78.37696c9.728 14.68416 8.94976 37.21216-3.76832 49.0496zm-596.31616-645.8368c-12.6976 11.85792-31.1296 11.20256-47.06304-1.6384l-73.09312-78.37696c-11.85792-12.6976-11.0592-35.2256 1.6384-47.08352s35.2256-11.0592 47.08352 1.6384l73.09312 78.37696c11.776 14.7456 11.0592 35.2256-1.6384 47.08352zm-138.24 614.05184c-11.85792-12.71808-11.0592-35.2256 1.6384-47.08352l78.37696-73.09312c12.6976-11.83744 33.1776-11.12064 47.08352 1.6384 11.83744 12.71808 11.0592 35.2256-1.6384 47.104l-78.39744 73.07264c-16.7936 11.71456-35.2256 11.0592-47.06304-1.6384z" fill="#ffb948"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="128" height="128"><path d="M578.256332 591.814252v-82.970701m0 95.54202a12.655127 12.655127.0 01-12.571318-12.571319v-82.970701a12.571318 12.571318.0 1125.142636.0v82.970701a12.571318 12.571318.0 01-12.571318 12.571319z" fill="#f89b1b"/><path d="M598.873294 479.342858a36.959676 36.959676.0 01-27.573092-61.59946 52.380493 52.380493.0 1062.521357 36.540632 36.875867 36.875867.0 01-34.948265 25.058828zm204.0744-109.035234v-82.970701m0 95.542019a12.571318 12.571318.0 01-12.571318-12.571318v-82.970701a12.571318 12.571318.0 1125.142636.0v82.970701a12.571318 12.571318.0 01-12.571318 12.571318z" fill="#f89b1b"/><path d="M823.9837 257.83623a36.959676 36.959676.0 01-27.6569-61.515651 52.129067 52.129067.0 1064.616576 50.285273 53.050963 53.050963.0 00-2.011411-14.163685A36.875867 36.875867.0 01823.9837 257.83623z" fill="#f89b1b"/><path d="M803.282929 328.822274a59.588049 59.588049.0 0159.588049 59.588048V785.66398H743.694881V388.410322a59.588049 59.588049.0 0159.588048-59.588048zM581.776301 551.16699a143.145411 143.145411.0 01143.145411 143.145411V837.54162H438.463272V694.312401A143.145411 143.145411.0 01581.776301 551.16699z" fill="#612273"/><path d="M600.968514 198.667225l-49.111951-4.693292a8.380879 8.380879.0 01-7.039938-5.196145l-17.599845-42.658674a8.380879 8.380879.0 00-15.672244.0l-17.432228 42.658674a8.380879 8.380879.0 01-7.039938 5.196145l-49.11195 4.693292a8.380879 8.380879.0 00-4.777101 14.750347l36.959676 32.51781a8.380879 8.380879.0 012.681881 8.380878l-11.06276 45.67579a8.380879 8.380879.0 0012.487509 9.302776L515.232123 285.074086a8.380879 8.380879.0 018.380879.0l40.982497 24.136931a8.380879 8.380879.0 0012.571319-9.302776l-10.978952-45.675789a8.380879 8.380879.0 012.681882-8.380879L606.08085 213.417572a8.380879 8.380879.0 00-5.028528-14.750347z" fill="#fed150"/><path d="M470.897274 246.77347l1.927602-8.380879a8.380879 8.380879.0 00-2.681881-8.380879l-35.032074-30.506399a8.380879 8.380879.0 00-1.927602 13.912259l36.959676 32.51781a6.788512 6.788512.0 01.754279.838088zM603.98563 199.589122l-34.948265 30.674016a8.380879 8.380879.0 00-2.681881 8.380879l1.927602 8.380879a6.788512 6.788512.0 01.754279-.838088l37.043485-32.769236a8.380879 8.380879.0 00-2.09522-13.82845zm-28.578797 92.189667a8.380879 8.380879.0 01-10.643716 1.759985l-40.982498-24.053123a8.380879 8.380879.0 00-8.380879.0L474.249625 293.454965a8.380879 8.380879.0 01-10.643716-1.676176l-1.927602 8.380879a8.380879 8.380879.0 0012.487509 9.302775l41.066307-24.388357a8.380879 8.380879.0 018.380879.0l40.982497 24.136931a8.380879 8.380879.0 0012.571319-9.302776z" fill="#fed150" opacity=".5"/><path d="M434.608068 426.543321l-28.159753-2.681881a4.86091 4.86091.0 01-4.022822-3.017117l-10.057054-24.388357a4.86091 4.86091.0 00-8.967541.0l-9.973245 24.388357a4.693292 4.693292.0 01-4.022822 3.017117l-28.159753 2.681881a4.86091 4.86091.0 00-2.76569 8.380879l21.203623 18.605551a4.944719 4.944719.0 011.592367 4.777101L354.654484 484.455194a4.86091 4.86091.0 007.123747 5.363762l23.466461-13.82845a5.196145 5.196145.0 014.944718.0l23.466461 13.82845a4.86091 4.86091.0 007.123747-5.363762l-6.285659-26.064533a4.86091 4.86091.0 011.508558-4.777101l21.203624-18.605551a4.86091 4.86091.0 00-2.849499-8.380879z" fill="#fed150"/><path d="M360.102055 454.032604l1.173323-4.609484a4.944719 4.944719.0 00-1.592367-5.112336l-20.0303-17.683654a4.944719 4.944719.0 00-1.173323 8.380879l21.203623 18.605551zm76.182189-26.98643-20.0303 17.26461a4.86091 4.86091.0 00-1.508559 4.777101l1.173323 4.693292v-.502852l21.203624-18.605551a4.86091 4.86091.0 00-.838088-7.6266zM419.94153 479.845711a4.777101 4.777101.0 01-6.034233 1.005705l-23.46646-13.82845a5.196145 5.196145.0 00-4.944719.0l-23.466461 13.82845a4.777101 4.777101.0 01-6.034233-1.005705l-1.089514 4.609483a4.86091 4.86091.0 007.123747 5.363762l23.466461-13.82845a5.196145 5.196145.0 014.944719.0l23.46646 13.82845a4.86091 4.86091.0 007.123747-5.363762z" fill="#fed150" opacity=".5"/><path d="M635.413926 803.68287A414.685886 414.685886.0 01459.41547 18.729756 9.805628 9.805628.0 00453.967898.124205a513.831683 513.831683.0 10567.050264 607.027056 9.805628 9.805628.0 00-18.186507-6.704704A414.350651 414.350651.0 01635.413926 803.68287z" fill="#fed150" p-id="22313"/><path d="M50.931434 292.868303a460.110249 460.110249.0 00275.311871 359.455895 413.847798 413.847798.0 01133.339782-633.594442A9.805628 9.805628.0 00453.967898.124205 513.915492 513.915492.0 0050.931434 292.868303z" fill="#fed150" opacity=".4" p-id="22314"/><path d="M1006.016389 597.261823A513.664065 513.664065.0 013.914704 475.320036c-.670471 10.308481-1.257132 20.616962-1.257132 31.093061a513.831683 513.831683.0 001018.36059 100.570546 9.805628 9.805628.0 00-15.001773-9.72182zM231.539373 332.258434c0 7.458982.67047 14.917964 1.257132 22.293138A414.769695 414.769695.0 01459.583087 18.729756 9.805628 9.805628.0 00453.967898.124205a505.869848 505.869848.0 00-94.620122 20.868388A413.177328 413.177328.0 00231.539373 332.258434z" fill="#fed150" opacity=".5" p-id="22315"/><path d="M715.032275 421.514794m17.683654.0h141.217809q17.683654.0 17.683655 17.683654v-.083809q0 17.683654-17.683655 17.683655H732.715929q-17.683654.0-17.683654-17.683655v.083809q0-17.683654 17.683654-17.683654z" fill="#eb3d72" p-id="22316"/><path d="M205.139605 319.603307c4.441866-6.872321 22.041711-45.340555-11.817039-67.047031s-51.626214 8.380879-51.626214 8.380879a25.142637 25.142637.0 1042.742482 27.489282s2.179029 5.950424-6.537085 18.437934-25.142637 12.236083-43.077718.754279-47.01673-65.789899-.67047-138.787354c1.592367-2.514264 3.352352-4.693292 5.028527-7.039938a26.818812 26.818812.0 00-23.047417-2.430455 33.523515 33.523515.0 00-18.689359 17.683654c-31.260678 64.36515-22.628373 127.724594 21.203623 155.884347 48.944333 31.093061 82.048804-6.453277 86.49067-13.325597zM734.224488 931.491272c6.453277-2.681881 37.713955-21.45505 24.304548-53.386198s-40.647262-19.35983-40.647262-19.35983a21.874094 21.874094.0 1016.761757 40.312027s-1.340941 5.363762-13.577023 9.973246S697.264812 905.259122 689.889638 888.497364s-1.340941-69.561295 67.047031-98.894371c2.346646-1.005705 4.693292-1.676176 7.039938-2.514263a31.931148 31.931148.0 00-1.927602-3.352352 28.578797 28.578797.0 00-38.635851-7.542791c-51.87764 30.841634-74.422204 81.545951-57.325212 122.277023 19.778874 46.262451 61.59946 35.786353 68.136546 33.020662zM279.813236 802.844782c-5.950424-3.687587-39.390131-18.354125-57.660447 11.146569s7.794217 44.334849 7.794217 44.334849a21.874094 21.874094.0 1023.047417-36.875867s5.112336-2.011411 16.007479 5.279954 10.811334 21.622667 1.173323 37.211102-55.984271 41.317733-119.511333 2.430455c-2.179029-1.340941-4.106631-2.849499-6.118041-4.274249a22.376947 22.376947.0 00-1.676176 3.51997 28.662606 28.662606.0 0016.342714 36.037779c55.146183 24.388357 109.538087 13.409406 132.920739-24.136931 26.399768-42.9101-6.369468-70.902235-12.319892-74.673631zM431.00429 694.312401h302.298301m0 20.952197H431.00429a20.952197 20.952197.0 010-41.904394h302.298301a20.952197 20.952197.0 010 41.904394z" fill="#eb3d72" p-id="22317"/><path d="M255.760113 683.082023m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".4" p-id="22318"/><path d="M356.246851 840.977781m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".4" p-id="22319"/><path d="M54.870447 472.135302m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".4" p-id="22320"/><path d="M561.410765 873.914635m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".5" p-id="22321"/><path d="M445.167976 825.13792m-19.862683.0a19.862683 19.862683.0 1039.725365.0 19.862683 19.862683.0 10-39.725365.0z" fill="#fed150" opacity=".5" p-id="22322"/><path d="M149.406761 689.786726m-19.862683.0a19.862683 19.862683.0 1039.725365.0 19.862683 19.862683.0 10-39.725365.0z" fill="#fed150" opacity=".5" p-id="22323"/><path d="M132.225959 633.299603m-18.940786.0a18.940786 18.940786.0 1037.881572.0 18.940786 18.940786.0 10-37.881572.0z" fill="#fed150" opacity=".4" p-id="22324"/><path d="M475.339139 906.935297m-18.940786.0a18.940786 18.940786.0 1037.881573.0 18.940786 18.940786.0 10-37.881573.0z" fill="#fed150" opacity=".4" p-id="22325"/></svg>
<span>主题</span></li></ol></li></ol></aside><main class="main full-width"><div class=breadcrumb><li><a href=/>首页</a></li><li><a href=/articles/>我的发布</a></li><li class=active><a href=/articles/java/juc/juc/>JUC</a></li></div><article class=main-article><header class="article-header not-page"><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352z"/></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"/><use href="#gentle-wave" x="48" y="3"/><use href="#gentle-wave" x="48" y="5"/><use href="#gentle-wave" x="48" y="7"/></g></svg></section><style>.main-hero-waves-area{--icat-post-waveone:rgba(17, 17, 17, 0.78);--icat-post-wavetwo:rgba(17, 17, 17, 0.51);--icat-post-wavethree:rgba(17, 17, 17, 0.212);--icat-post-wavefour:rgb(17, 17, 17);opacity:1; [data-scheme="light"] & { --icat-post-waveone: rgba(255, 255, 255, 0.741); --icat-post-wavetwo: rgba(255, 255, 255, 0.51); --icat-post-wavethree: rgba(255, 255, 255, 0.212); --icat-post-wavefour: #fff; }}.waves-area{width:100%;position:absolute;left:0;bottom:0;z-index:5}.waves-area .waves-svg{width:100%;height:8rem}@media screen and (max-width:768px){.waves-area .waves-svg{height:40px;min-height:40px}}.waves-area .waves-svg .parallax>use{-webkit-animation:move-forever 25s cubic-bezier(.55,.5,.45,.5)infinite;-moz-animation:move-forever 25s cubic-bezier(.55,.5,.45,.5)infinite;-o-animation:move-forever 25s cubic-bezier(.55,.5,.45,.5)infinite;-ms-animation:move-forever 25s cubic-bezier(.55,.5,.45,.5)infinite;animation:move-forever 25s cubic-bezier(.55,.5,.45,.5)infinite}.waves-area .waves-svg .parallax>use:nth-child(1){-webkit-animation-delay:-2s;-moz-animation-delay:-2s;-o-animation-delay:-2s;-ms-animation-delay:-2s;animation-delay:-2s;-webkit-animation-duration:7s;-moz-animation-duration:7s;-o-animation-duration:7s;-ms-animation-duration:7s;animation-duration:7s;fill:var(--icat-post-waveone)}.waves-area .waves-svg .parallax>use:nth-child(2){-webkit-animation-delay:-3s;-moz-animation-delay:-3s;-o-animation-delay:-3s;-ms-animation-delay:-3s;animation-delay:-3s;-webkit-animation-duration:10s;-moz-animation-duration:10s;-o-animation-duration:10s;-ms-animation-duration:10s;animation-duration:10s;fill:var(--icat-post-wavetwo)}.waves-area .waves-svg .parallax>use:nth-child(3){-webkit-animation-delay:-4s;-moz-animation-delay:-4s;-o-animation-delay:-4s;-ms-animation-delay:-4s;animation-delay:-4s;-webkit-animation-duration:13s;-moz-animation-duration:13s;-o-animation-duration:13s;-ms-animation-duration:13s;animation-duration:13s;fill:var(--icat-post-wavethree)}.waves-area .waves-svg .parallax>use:nth-child(4){-webkit-animation-delay:-5s;-moz-animation-delay:-5s;-o-animation-delay:-5s;-ms-animation-delay:-5s;animation-delay:-5s;-webkit-animation-duration:20s;-moz-animation-duration:20s;-o-animation-duration:20s;-ms-animation-duration:20s;animation-duration:20s;fill:var(--icat-post-wavefour)}@keyframes move-forever{0%{transform:translate3d(-90px,0,0)}100%{transform:translate3d(85px,0,0)}}</style><div class=article-details><header class=article-category><a href=/categories/java/>Java</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/articles/java/juc/juc/>JUC</a></h2><h3 class=article-subtitle>java多线程,JUC,线程安全</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024年3月3日</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 199 分钟</time></div></footer></div></header><section class=article-content><p>1.准备</p><p>pom.xml 依赖如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;properties&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class=nt>&lt;/project.build.sourceEncoding&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;maven.compiler.source&gt;</span>1.8<span class=nt>&lt;/maven.compiler.source&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;maven.compiler.target&gt;</span>1.8<span class=nt>&lt;/maven.compiler.target&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/properties&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;dependencies&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>junit<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>junit<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;version&gt;</span>4.11<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;scope&gt;</span>test<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>org.projectlombok<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>lombok<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;version&gt;</span>1.18.22<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;scope&gt;</span>provided<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>slf4j-api<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;version&gt;</span>1.7.22<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>ch.qos.logback<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>logback-classic<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;version&gt;</span>1.2.3<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>org.junit.jupiter<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>junit-jupiter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;version&gt;</span>RELEASE<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;scope&gt;</span>compile<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>logback.xml 配置如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;configuration</span> <span class=na>scan=</span><span class=s>&#34;true&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;appender</span> <span class=na>name=</span><span class=s>&#34;STDOUT&#34;</span> <span class=na>class=</span><span class=s>&#34;ch.qos.logback.core.ConsoleAppender&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;encoder&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;pattern&gt;</span>%date{HH:mm:ss} [%t] %logger - %m%n<span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/encoder&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/appender&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;logger</span> <span class=na>name=</span><span class=s>&#34;c&#34;</span> <span class=na>level=</span><span class=s>&#34;debug&#34;</span> <span class=na>additivity=</span><span class=s>&#34;false&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;appender-ref</span> <span class=na>ref=</span><span class=s>&#34;STDOUT&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/logger&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;root</span> <span class=na>level=</span><span class=s>&#34;ERROR&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;appender-ref</span> <span class=na>ref=</span><span class=s>&#34;STDOUT&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/root&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=2进程与线程><a href=#2%e8%bf%9b%e7%a8%8b%e4%b8%8e%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
2.进程与线程</h1><h2 id=21-进程与线程><a href=#21-%e8%bf%9b%e7%a8%8b%e4%b8%8e%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
2.1 进程与线程</h2><h3 id=进程><a href=#%e8%bf%9b%e7%a8%8b class=header-anchor>#</a>
进程</h3><ul><li>程序由指令和数据组成，但这些指令要运行，数据要读写，就必须将指令加载至 CPU，数据加载至内存。在 指令运行过程中还需要用到磁盘、网络等设备。进程就是用来加载指令、管理内存、管理 IO 的 。</li><li>当一个程序被运行，从磁盘加载这个程序的代码至内存，这时就开启了一个进程。</li><li>进程就可以视为程序的一个实例。大部分程序可以同时运行多个实例进程（例如记事本、画图、浏览器 等），也有的程序只能启动一个实例进程（例如网易云音乐、360 安全卫士等）</li></ul><h3 id=线程><a href=#%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
线程</h3><ul><li><p>一个进程之内可以分为一到多个线程。</p></li><li><p>一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给 CPU 执行</p></li><li><p>Java 中，线程作为最小调度单位，进程作为资源分配的最小单位。 在 windows 中进程是不活动的，只是作 为线程的容器</p></li></ul><h3 id=二者对比><a href=#%e4%ba%8c%e8%80%85%e5%af%b9%e6%af%94 class=header-anchor>#</a>
二者对比</h3><ul><li><p>进程基本上相互独立的，而线程存在于进程内，是进程的一个子集</p></li><li><p>进程拥有共享的资源，如内存空间等，供其内部的线程共享</p></li><li><p>进程间通信较为复杂</p><ul><li>同一台计算机的进程通信称为 IPC（Inter-process communication）</li><li>不同计算机之间的进程通信，需要通过网络，并遵守共同的协议，例如 HTTP</li></ul></li><li><p>线程通信相对简单，因为它们共享进程内的内存，一个例子是多个线程可以访问同一个共享变量</p></li><li><p>线程更轻量，线程上下文切换成本一般上要比进程上下文切换低</p></li></ul><h2 id=22-并行与并发><a href=#22-%e5%b9%b6%e8%a1%8c%e4%b8%8e%e5%b9%b6%e5%8f%91 class=header-anchor>#</a>
2.2 并行与并发</h2><p>单核cpu下，线程实际还是<strong>串行执行</strong>的。操作系统中有一个组件叫做任务调度器，将 cpu 的时间片（windows 下时间片最小约为 15 毫秒）分给不同的程序使用，只是由于 cpu 在线程间（时间片很短）的切换非常快，人类感觉是同时运行的 。总结为一句话就是： <strong>微观串行，宏观并行</strong> 。</p><p>一般会将这种线程轮流使用 CPU 的做法称为并发， concurrent</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>CPU</th><th style=text-align:center>时间片 1</th><th style=text-align:center>时间片 2</th><th style=text-align:center>时间片 3</th><th style=text-align:center>时间片 4</th></tr></thead><tbody><tr><td style=text-align:center>core</td><td style=text-align:center>线程 1</td><td style=text-align:center>线程 2</td><td style=text-align:center>线程 3</td><td style=text-align:center>线程 4</td></tr></tbody></table></div><p>多核 cpu下，每个 核（core） 都可以调度运行线程，这时候线程可以是并行的。</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>CPU</th><th style=text-align:center>时间片 1</th><th style=text-align:center>时间片 2</th><th style=text-align:center>时间片 3</th><th style=text-align:center>时间片 4</th></tr></thead><tbody><tr><td style=text-align:center>core1</td><td style=text-align:center>线程 1</td><td style=text-align:center>线程 2</td><td style=text-align:center>线程 3</td><td style=text-align:center>线程 4</td></tr><tr><td style=text-align:center>core2</td><td style=text-align:center>线程 4</td><td style=text-align:center>线程 4</td><td style=text-align:center>线程 2</td><td style=text-align:center>线程 2</td></tr></tbody></table></div><p>引用 Rob Pike 的一段描述：</p><p>​ 并发（concurrent）是同一时间应对（dealing with）多件事情的能力 。</p><p>​ 并行（parallel）是同一时间动手做（doing）多件事情的能力。</p><h2 id=23-应用><a href=#23-%e5%ba%94%e7%94%a8 class=header-anchor>#</a>
2.3 应用</h2><h3 id=textcolorgreen应用之异步调用案例1-><a href=#textcolorgreen%e5%ba%94%e7%94%a8%e4%b9%8b%e5%bc%82%e6%ad%a5%e8%b0%83%e7%94%a8%e6%a1%88%e4%be%8b1- class=header-anchor>#</a>
$\textcolor{Green}{*应用之异步调用（案例1）} $</h3><h4 id=需要等待结果><a href=#%e9%9c%80%e8%a6%81%e7%ad%89%e5%be%85%e7%bb%93%e6%9e%9c class=header-anchor>#</a>
需要等待结果</h4><p>这时既可以使用同步处理，也可以使用异步来处理</p><p>join 实现（同步）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结束&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结果为:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:30:40.453 <span class=o>[</span>main<span class=o>]</span> c.TestJoin - 开始
</span></span><span class=line><span class=cl>20:30:40.541 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestJoin - 开始
</span></span><span class=line><span class=cl>20:30:41.543 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestJoin - 结束
</span></span><span class=line><span class=cl>20:30:41.551 <span class=o>[</span>main<span class=o>]</span> c.TestJoin - 结果为:10
</span></span></code></pre></td></tr></table></div></div><p>评价</p><ul><li>需要外部共享变量，不符合面向对象封装的思想</li><li>必须等待线程结束，不能配合线程池使用</li></ul><h5 id=future-实现同步><a href=#future-%e5%ae%9e%e7%8e%b0%e5%90%8c%e6%ad%a5 class=header-anchor>#</a>
Future 实现（同步）</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FutureTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FutureTask</span><span class=o>&lt;&gt;</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结束&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结果为:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2>2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3>3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>10:11:57.880 c.TestSync <span class=o>[</span>main<span class=o>]</span> - 开始
</span></span><span class=line><span class=cl>10:11:57.942 c.TestSync <span class=o>[</span>t1<span class=o>]</span> - 开始
</span></span><span class=line><span class=cl>10:11:58.943 c.TestSync <span class=o>[</span>t1<span class=o>]</span> - 结束
</span></span><span class=line><span class=cl>10:11:58.943 c.TestSync <span class=o>[</span>main<span class=o>]</span> - 结果为:10
</span></span></code></pre></td></tr></table></div></div><p>评价</p><ul><li>规避了使用 join 之前的缺点</li><li>可以方便配合线程池使用</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结束&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结果为:{}, result 的类型:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(),</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>10:17:40.090 c.TestSync <span class=o>[</span>main<span class=o>]</span> - 开始
</span></span><span class=line><span class=cl>10:17:40.150 c.TestSync <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 开始
</span></span><span class=line><span class=cl>10:17:41.151 c.TestSync <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 结束
</span></span><span class=line><span class=cl>10:17:41.151 c.TestSync <span class=o>[</span>main<span class=o>]</span> - 结果为:10, result 的类型:class java.util.concurrent.FutureTask
</span></span></code></pre></td></tr></table></div></div><p>评价</p><ul><li>仍然是 main 线程接收结果</li><li>get 方法是让调用线程同步等待</li></ul><h5 id=自定义实现同步><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%ae%9e%e7%8e%b0%e5%90%8c%e6%ad%a5 class=header-anchor>#</a>
自定义实现（同步）</h5><p>见模式篇：保护性暂停模式</p><h5 id=completablefuture-实现异步><a href=#completablefuture-%e5%ae%9e%e7%8e%b0%e5%bc%82%e6%ad%a5 class=header-anchor>#</a>
CompletableFuture 实现（异步）</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test4</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 进行计算的线程池</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>computeService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 接收结果的线程池</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>resultService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CompletableFuture</span><span class=p>.</span><span class=na>supplyAsync</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结束&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=n>computeService</span><span class=p>).</span><span class=na>thenAcceptAsync</span><span class=p>((</span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结果为:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=n>resultService</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2>2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3>3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>10:36:28.114 c.TestSync <span class=o>[</span>main<span class=o>]</span> - 开始
</span></span><span class=line><span class=cl>10:36:28.164 c.TestSync <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 开始
</span></span><span class=line><span class=cl>10:36:29.165 c.TestSync <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 结束
</span></span><span class=line><span class=cl>10:36:29.165 c.TestSync <span class=o>[</span>pool-2-thread-1<span class=o>]</span> - 结果为:10
</span></span></code></pre></td></tr></table></div></div><p>评价</p><ul><li>可以让调用线程异步处理结果，实际是其他线程去同步等待</li><li>可以方便地分离不同职责的线程池</li><li>以任务为中心，而不是以线程为中心</li></ul><h5 id=blockingqueue-实现异步><a href=#blockingqueue-%e5%ae%9e%e7%8e%b0%e5%bc%82%e6%ad%a5 class=header-anchor>#</a>
BlockingQueue 实现（异步）</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14>14</a>
</span><span class=lnt id=hl-10-15><a class=lnlinks href=#hl-10-15>15</a>
</span><span class=lnt id=hl-10-16><a class=lnlinks href=#hl-10-16>16</a>
</span><span class=lnt id=hl-10-17><a class=lnlinks href=#hl-10-17>17</a>
</span><span class=lnt id=hl-10-18><a class=lnlinks href=#hl-10-18>18</a>
</span><span class=lnt id=hl-10-19><a class=lnlinks href=#hl-10-19>19</a>
</span><span class=lnt id=hl-10-20><a class=lnlinks href=#hl-10-20>20</a>
</span><span class=lnt id=hl-10-21><a class=lnlinks href=#hl-10-21>21</a>
</span><span class=lnt id=hl-10-22><a class=lnlinks href=#hl-10-22>22</a>
</span><span class=lnt id=hl-10-23><a class=lnlinks href=#hl-10-23>23</a>
</span><span class=lnt id=hl-10-24><a class=lnlinks href=#hl-10-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test6</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>consumer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>producer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SynchronousQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>producer</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结束&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>consumer</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Integer</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结果为:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=不需等待结果><a href=#%e4%b8%8d%e9%9c%80%e7%ad%89%e5%be%85%e7%bb%93%e6%9e%9c class=header-anchor>#</a>
不需等待结果</h4><p>这时最好是使用异步来处理</p><h5 id=普通线程实现><a href=#%e6%99%ae%e9%80%9a%e7%ba%bf%e7%a8%8b%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
普通线程实现</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span><span class=lnt id=hl-11-13><a class=lnlinks href=#hl-11-13>13</a>
</span><span class=lnt id=hl-11-14><a class=lnlinks href=#hl-11-14>14</a>
</span><span class=lnt id=hl-11-15><a class=lnlinks href=#hl-11-15>15</a>
</span><span class=lnt id=hl-11-16><a class=lnlinks href=#hl-11-16>16</a>
</span><span class=lnt id=hl-11-17><a class=lnlinks href=#hl-11-17>17</a>
</span><span class=lnt id=hl-11-18><a class=lnlinks href=#hl-11-18>18</a>
</span><span class=lnt id=hl-11-19><a class=lnlinks href=#hl-11-19>19</a>
</span><span class=lnt id=hl-11-20><a class=lnlinks href=#hl-11-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.FileReader&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FileReader</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>read</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>filename</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>filename</span><span class=p>.</span><span class=na>lastIndexOf</span><span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>separator</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>shortName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>filename</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>idx</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>FileInputStream</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=n>filename</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read [{}] start ...&#34;</span><span class=p>,</span><span class=w> </span><span class=n>shortName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>1024</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read [{}] end ... cost: {} ms&#34;</span><span class=p>,</span><span class=w> </span><span class=n>shortName</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>没有用线程时，方法的调用是同步的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5>5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6>6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7>7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Sync&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>fullPath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;E:\\1.mp4&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FileReader</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>fullPath</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;do other things ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:39:15 <span class=o>[</span>main<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ...
</span></span><span class=line><span class=cl>18:39:19 <span class=o>[</span>main<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>4090</span> ms
</span></span><span class=line><span class=cl>18:39:19 <span class=o>[</span>main<span class=o>]</span> c.Sync - <span class=k>do</span> other things ...
</span></span></code></pre></td></tr></table></div></div><p>使用了线程后，方法的调用时异步的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1>1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2>2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3>3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>FileReader</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>MP4_FULL_PATH</span><span class=p>)).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;do other things ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1>1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2>2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:41:53 <span class=o>[</span>main<span class=o>]</span> c.Async - <span class=k>do</span> other things ...
</span></span><span class=line><span class=cl>18:41:53 <span class=o>[</span>Thread-0<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ...
</span></span><span class=line><span class=cl>18:41:57 <span class=o>[</span>Thread-0<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>4197</span> ms
</span></span></code></pre></td></tr></table></div></div><h5 id=线程池实现><a href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
线程池实现</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1>1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2>2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3>3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4>4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5>5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>execute</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>FileReader</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>MP4_FULL_PATH</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;do other things ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1>1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2>2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:03:31.245 c.TestAsyc <span class=o>[</span>main<span class=o>]</span> - <span class=k>do</span> other things ... 
</span></span><span class=line><span class=cl>11:03:31.245 c.FileReader <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ... 
</span></span><span class=line><span class=cl>11:03:33.479 c.FileReader <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>2235</span> ms
</span></span></code></pre></td></tr></table></div></div><h5 id=completablefuture-实现><a href=#completablefuture-%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
CompletableFuture 实现</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1>1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2>2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3>3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4>4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CompletableFuture</span><span class=p>.</span><span class=na>runAsync</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>FileReader</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>MP4_FULL_PATH</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;do other things ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>in</span><span class=p>.</span><span class=na>read</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1>1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2>2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:09:38.145 c.TestAsyc <span class=o>[</span>main<span class=o>]</span> - <span class=k>do</span> other things ... 
</span></span><span class=line><span class=cl>11:09:38.145 c.FileReader <span class=o>[</span>ForkJoinPool.commonPool-worker-1<span class=o>]</span> - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ... 
</span></span><span class=line><span class=cl>11:09:40.514 c.FileReader <span class=o>[</span>ForkJoinPool.commonPool-worker-1<span class=o>]</span> - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>2369</span> ms 
</span></span></code></pre></td></tr></table></div></div><p>以调用方角度来讲，</p><ul><li>如果 需要等待结果返回，才能继续运行就是同步</li><li>不需要等待结果返回，就能继续运行就是异步</li></ul><p><strong>1.设计</strong></p><p>多线程可以让方法执行变为异步的（即不要巴巴干等着）、比如说读取磁盘文件时，假设读取操作花费了 5 秒钟，如果没有线程调度机制，这 5 秒 cpu 什么都做不了，其它代码都得暂停&mldr;</p><p><strong>2.结论</strong></p><ul><li>比如在项目中，视频文件需要转换格式等操作比较费时，这时开一个新线程处理视频转换，避免阻塞主线程</li><li>tomcat 的异步 servlet 也是类似的目的，让用户线程处理耗时较长的操作，避免阻塞 tomcat 的工作线程</li><li>ui 程序中，开线程进行其他操作，避免阻塞 ui 线程</li></ul><h3 id=textcolorgreen应用之提高效率案例1-><a href=#textcolorgreen%e5%ba%94%e7%94%a8%e4%b9%8b%e6%8f%90%e9%ab%98%e6%95%88%e7%8e%87%e6%a1%88%e4%be%8b1- class=header-anchor>#</a>
$\textcolor{Green}{*应用之提高效率（案例1） }$</h3><p>充分利用多核 cpu 的优势，提高运行效率。想象下面的场景，执行 3 个计算，最后将计算结果汇总。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1>1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2>2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3>3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>计算 1 花费 10 ms
</span></span><span class=line><span class=cl>计算 2 花费 11 ms
</span></span><span class=line><span class=cl>计算 3 花费 9 ms
</span></span><span class=line><span class=cl>汇总需要 1 ms
</span></span></code></pre></td></tr></table></div></div><ul><li><p>如果是串行执行，那么总共花费的时间是 10 + 11 + 9 + 1 = 31ms</p></li><li><p>但如果是四核 cpu，各个核心分别使用线程 1 执行计算 1，线程 2 执行计算 2，线程 3 执行计算 3，那么 3 个 线程是并行的，花费时间只取决于最长的那个线程运行的时间，即 11ms 最后加上汇总时间只会花费 12ms</p></li></ul><blockquote><p><strong>注意：</strong></p><p>需要在多核 cpu 才能提高效率，单核仍然时是轮流执行</p></blockquote><h5 id=1设计><a href=#1%e8%ae%be%e8%ae%a1 class=header-anchor>#</a>
1.设计</h5><blockquote><p>代码见【应用之效率-案例1】</p></blockquote><h5 id=2结论><a href=#2%e7%bb%93%e8%ae%ba class=header-anchor>#</a>
2.结论</h5><ol><li>单核 cpu 下，多线程不能实际提高程序运行效率，只是为了能够在不同的任务之间切换，不同线程轮流使用 cpu ，不至于一个线程总占用 cpu，别的线程没法干活</li><li>多核 cpu 可以并行跑多个线程，但能否提高程序运行效率还是要分情况的<ul><li>有些任务，经过精心设计，将任务拆分，并行执行，当然可以提高程序的运行效率。但不是所有计算任 务都能拆分（参考后文的【阿姆达尔定律】）</li><li>也不是所有任务都需要拆分，任务的目的如果不同，谈拆分和效率没啥意义</li></ul></li><li>IO 操作不占用 cpu，只是我们一般拷贝文件使用的是【阻塞 IO】，这时相当于线程虽然不用 cpu，但需要一 直等待 IO 结束，没能充分利用线程。所以才有后面的【非阻塞 IO】和【异步 IO】优化。</li></ol><h1 id=3java-线程><a href=#3java-%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
3.Java 线程</h1><h2 id=31-创建和运行线程><a href=#31-%e5%88%9b%e5%bb%ba%e5%92%8c%e8%bf%90%e8%a1%8c%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
3.1 创建和运行线程</h2><h3 id=方法一直接使用-thread><a href=#%e6%96%b9%e6%b3%95%e4%b8%80%e7%9b%b4%e6%8e%a5%e4%bd%bf%e7%94%a8-thread class=header-anchor>#</a>
方法一，直接使用 Thread</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1>1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2>2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3>3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4>4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5>5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6>6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7>7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 创建线程对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 要执行的任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 启动线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1>1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2>2</a>
</span><span class=lnt id=hl-22-3><a class=lnlinks href=#hl-22-3>3</a>
</span><span class=lnt id=hl-22-4><a class=lnlinks href=#hl-22-4>4</a>
</span><span class=lnt id=hl-22-5><a class=lnlinks href=#hl-22-5>5</a>
</span><span class=lnt id=hl-22-6><a class=lnlinks href=#hl-22-6>6</a>
</span><span class=lnt id=hl-22-7><a class=lnlinks href=#hl-22-7>7</a>
</span><span class=lnt id=hl-22-8><a class=lnlinks href=#hl-22-8>8</a>
</span><span class=lnt id=hl-22-9><a class=lnlinks href=#hl-22-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 构造方法的参数是给线程指定名字，推荐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=s>&#34;t1&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// run 方法内实现了要执行的任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>19:19:00 [t1] c.ThreadStarter - hello
</span></span></code></pre></td></tr></table></div></div><h3 id=方法二使用-runnable-配合-thread><a href=#%e6%96%b9%e6%b3%95%e4%ba%8c%e4%bd%bf%e7%94%a8-runnable-%e9%85%8d%e5%90%88-thread class=header-anchor>#</a>
方法二，使用 Runnable 配合 Thread</h3><p>把【线程】和【任务】（要执行的代码）分开</p><ul><li>Thread 代表线程</li><li>Runnable 可运行的任务（线程要执行的代码）</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1>1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2>2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3>3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4>4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5>5</a>
</span><span class=lnt id=hl-24-6><a class=lnlinks href=#hl-24-6>6</a>
</span><span class=lnt id=hl-24-7><a class=lnlinks href=#hl-24-7>7</a>
</span><span class=lnt id=hl-24-8><a class=lnlinks href=#hl-24-8>8</a>
</span><span class=lnt id=hl-24-9><a class=lnlinks href=#hl-24-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Runnable</span><span class=w> </span><span class=n>runnable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 要执行的任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 创建线程对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=w> </span><span class=n>runnable</span><span class=w> </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 启动线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 创建任务对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Runnable</span><span class=w> </span><span class=n>task2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 参数1 是任务对象; 参数2 是线程名字，推荐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>task2</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>9:19:00 [t2] c.ThreadStarter - hello
</span></span></code></pre></td></tr></table></div></div><p>Java 8 以后可以使用 lambda 精简代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1>1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2>2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3>3</a>
</span><span class=lnt id=hl-27-4><a class=lnlinks href=#hl-27-4>4</a>
</span><span class=lnt id=hl-27-5><a class=lnlinks href=#hl-27-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 创建任务对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Runnable</span><span class=w> </span><span class=n>task2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 参数1 是任务对象; 参数2 是线程名字，推荐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>task2</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=thread-与-runnable-的关系><a href=#thread-%e4%b8%8e-runnable-%e7%9a%84%e5%85%b3%e7%b3%bb class=header-anchor>#</a>
Thread 与 Runnable 的关系</h5><p>分析 Thread 的源码，理清它与 Runnable 的关系</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1>1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2>2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3>3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//Runnable源码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a class=lnlinks href=#hl-29-1> 1</a>
</span><span class=lnt id=hl-29-2><a class=lnlinks href=#hl-29-2> 2</a>
</span><span class=lnt id=hl-29-3><a class=lnlinks href=#hl-29-3> 3</a>
</span><span class=lnt id=hl-29-4><a class=lnlinks href=#hl-29-4> 4</a>
</span><span class=lnt id=hl-29-5><a class=lnlinks href=#hl-29-5> 5</a>
</span><span class=lnt id=hl-29-6><a class=lnlinks href=#hl-29-6> 6</a>
</span><span class=lnt id=hl-29-7><a class=lnlinks href=#hl-29-7> 7</a>
</span><span class=lnt id=hl-29-8><a class=lnlinks href=#hl-29-8> 8</a>
</span><span class=lnt id=hl-29-9><a class=lnlinks href=#hl-29-9> 9</a>
</span><span class=lnt id=hl-29-10><a class=lnlinks href=#hl-29-10>10</a>
</span><span class=lnt id=hl-29-11><a class=lnlinks href=#hl-29-11>11</a>
</span><span class=lnt id=hl-29-12><a class=lnlinks href=#hl-29-12>12</a>
</span><span class=lnt id=hl-29-13><a class=lnlinks href=#hl-29-13>13</a>
</span><span class=lnt id=hl-29-14><a class=lnlinks href=#hl-29-14>14</a>
</span><span class=lnt id=hl-29-15><a class=lnlinks href=#hl-29-15>15</a>
</span><span class=lnt id=hl-29-16><a class=lnlinks href=#hl-29-16>16</a>
</span><span class=lnt id=hl-29-17><a class=lnlinks href=#hl-29-17>17</a>
</span><span class=lnt id=hl-29-18><a class=lnlinks href=#hl-29-18>18</a>
</span><span class=lnt id=hl-29-19><a class=lnlinks href=#hl-29-19>19</a>
</span><span class=lnt id=hl-29-20><a class=lnlinks href=#hl-29-20>20</a>
</span><span class=lnt id=hl-29-21><a class=lnlinks href=#hl-29-21>21</a>
</span><span class=lnt id=hl-29-22><a class=lnlinks href=#hl-29-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//Thread源码（部分）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Thread</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* What will be run. */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Thread</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>init</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Thread-&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>nextThreadNum</span><span class=p>(),</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>ThreadGroup</span><span class=w> </span><span class=n>g</span><span class=p>,</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=kt>long</span><span class=w> </span><span class=n>stackSize</span><span class=p>,</span><span class=w> </span><span class=n>AccessControlContext</span><span class=w> </span><span class=n>acc</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=kt>boolean</span><span class=w> </span><span class=n>inheritThreadLocals</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>target</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>target</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=小结><a href=#%e5%b0%8f%e7%bb%93 class=header-anchor>#</a>
小结</h5><ul><li>方法1 是把线程和任务合并在了一起，方法2 是把线程和任务分开了</li><li>用 Runnable 更容易与线程池等高级API 配合</li><li>用 Runnable 让任务类脱离了 Thread 继承体系，更灵活</li></ul><h3 id=方法三futuretask-配合-thread><a href=#%e6%96%b9%e6%b3%95%e4%b8%89futuretask-%e9%85%8d%e5%90%88-thread class=header-anchor>#</a>
方法三，FutureTask 配合 Thread</h3><p>FutureTask 能够接收 Callable 类型的参数，用来处理有返回结果的情况</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-30-1><a class=lnlinks href=#hl-30-1> 1</a>
</span><span class=lnt id=hl-30-2><a class=lnlinks href=#hl-30-2> 2</a>
</span><span class=lnt id=hl-30-3><a class=lnlinks href=#hl-30-3> 3</a>
</span><span class=lnt id=hl-30-4><a class=lnlinks href=#hl-30-4> 4</a>
</span><span class=lnt id=hl-30-5><a class=lnlinks href=#hl-30-5> 5</a>
</span><span class=lnt id=hl-30-6><a class=lnlinks href=#hl-30-6> 6</a>
</span><span class=lnt id=hl-30-7><a class=lnlinks href=#hl-30-7> 7</a>
</span><span class=lnt id=hl-30-8><a class=lnlinks href=#hl-30-8> 8</a>
</span><span class=lnt id=hl-30-9><a class=lnlinks href=#hl-30-9> 9</a>
</span><span class=lnt id=hl-30-10><a class=lnlinks href=#hl-30-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 创建任务对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>FutureTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>task3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FutureTask</span><span class=o>&lt;&gt;</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 参数1 是任务对象; 参数2 是线程名字，推荐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>task3</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t3&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 主线程阻塞，同步等待 task 执行完毕的结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Integer</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task3</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结果是:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-31-1><a class=lnlinks href=#hl-31-1>1</a>
</span><span class=lnt id=hl-31-2><a class=lnlinks href=#hl-31-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>19:22:27 [t3] c.ThreadStarter - hello
</span></span><span class=line><span class=cl>19:22:27 [main] c.ThreadStarter - 结果是:100
</span></span></code></pre></td></tr></table></div></div><p>源码分析</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-32-1><a class=lnlinks href=#hl-32-1> 1</a>
</span><span class=lnt id=hl-32-2><a class=lnlinks href=#hl-32-2> 2</a>
</span><span class=lnt id=hl-32-3><a class=lnlinks href=#hl-32-3> 3</a>
</span><span class=lnt id=hl-32-4><a class=lnlinks href=#hl-32-4> 4</a>
</span><span class=lnt id=hl-32-5><a class=lnlinks href=#hl-32-5> 5</a>
</span><span class=lnt id=hl-32-6><a class=lnlinks href=#hl-32-6> 6</a>
</span><span class=lnt id=hl-32-7><a class=lnlinks href=#hl-32-7> 7</a>
</span><span class=lnt id=hl-32-8><a class=lnlinks href=#hl-32-8> 8</a>
</span><span class=lnt id=hl-32-9><a class=lnlinks href=#hl-32-9> 9</a>
</span><span class=lnt id=hl-32-10><a class=lnlinks href=#hl-32-10>10</a>
</span><span class=lnt id=hl-32-11><a class=lnlinks href=#hl-32-11>11</a>
</span><span class=lnt id=hl-32-12><a class=lnlinks href=#hl-32-12>12</a>
</span><span class=lnt id=hl-32-13><a class=lnlinks href=#hl-32-13>13</a>
</span><span class=lnt id=hl-32-14><a class=lnlinks href=#hl-32-14>14</a>
</span><span class=lnt id=hl-32-15><a class=lnlinks href=#hl-32-15>15</a>
</span><span class=lnt id=hl-32-16><a class=lnlinks href=#hl-32-16>16</a>
</span><span class=lnt id=hl-32-17><a class=lnlinks href=#hl-32-17>17</a>
</span><span class=lnt id=hl-32-18><a class=lnlinks href=#hl-32-18>18</a>
</span><span class=lnt id=hl-32-19><a class=lnlinks href=#hl-32-19>19</a>
</span><span class=lnt id=hl-32-20><a class=lnlinks href=#hl-32-20>20</a>
</span><span class=lnt id=hl-32-21><a class=lnlinks href=#hl-32-21>21</a>
</span><span class=lnt id=hl-32-22><a class=lnlinks href=#hl-32-22>22</a>
</span><span class=lnt id=hl-32-23><a class=lnlinks href=#hl-32-23>23</a>
</span><span class=lnt id=hl-32-24><a class=lnlinks href=#hl-32-24>24</a>
</span><span class=lnt id=hl-32-25><a class=lnlinks href=#hl-32-25>25</a>
</span><span class=lnt id=hl-32-26><a class=lnlinks href=#hl-32-26>26</a>
</span><span class=lnt id=hl-32-27><a class=lnlinks href=#hl-32-27>27</a>
</span><span class=lnt id=hl-32-28><a class=lnlinks href=#hl-32-28>28</a>
</span><span class=lnt id=hl-32-29><a class=lnlinks href=#hl-32-29>29</a>
</span><span class=lnt id=hl-32-30><a class=lnlinks href=#hl-32-30>30</a>
</span><span class=lnt id=hl-32-31><a class=lnlinks href=#hl-32-31>31</a>
</span><span class=lnt id=hl-32-32><a class=lnlinks href=#hl-32-32>32</a>
</span><span class=lnt id=hl-32-33><a class=lnlinks href=#hl-32-33>33</a>
</span><span class=lnt id=hl-32-34><a class=lnlinks href=#hl-32-34>34</a>
</span><span class=lnt id=hl-32-35><a class=lnlinks href=#hl-32-35>35</a>
</span><span class=lnt id=hl-32-36><a class=lnlinks href=#hl-32-36>36</a>
</span><span class=lnt id=hl-32-37><a class=lnlinks href=#hl-32-37>37</a>
</span><span class=lnt id=hl-32-38><a class=lnlinks href=#hl-32-38>38</a>
</span><span class=lnt id=hl-32-39><a class=lnlinks href=#hl-32-39>39</a>
</span><span class=lnt id=hl-32-40><a class=lnlinks href=#hl-32-40>40</a>
</span><span class=lnt id=hl-32-41><a class=lnlinks href=#hl-32-41>41</a>
</span><span class=lnt id=hl-32-42><a class=lnlinks href=#hl-32-42>42</a>
</span><span class=lnt id=hl-32-43><a class=lnlinks href=#hl-32-43>43</a>
</span><span class=lnt id=hl-32-44><a class=lnlinks href=#hl-32-44>44</a>
</span><span class=lnt id=hl-32-45><a class=lnlinks href=#hl-32-45>45</a>
</span><span class=lnt id=hl-32-46><a class=lnlinks href=#hl-32-46>46</a>
</span><span class=lnt id=hl-32-47><a class=lnlinks href=#hl-32-47>47</a>
</span><span class=lnt id=hl-32-48><a class=lnlinks href=#hl-32-48>48</a>
</span><span class=lnt id=hl-32-49><a class=lnlinks href=#hl-32-49>49</a>
</span><span class=lnt id=hl-32-50><a class=lnlinks href=#hl-32-50>50</a>
</span><span class=lnt id=hl-32-51><a class=lnlinks href=#hl-32-51>51</a>
</span><span class=lnt id=hl-32-52><a class=lnlinks href=#hl-32-52>52</a>
</span><span class=lnt id=hl-32-53><a class=lnlinks href=#hl-32-53>53</a>
</span><span class=lnt id=hl-32-54><a class=lnlinks href=#hl-32-54>54</a>
</span><span class=lnt id=hl-32-55><a class=lnlinks href=#hl-32-55>55</a>
</span><span class=lnt id=hl-32-56><a class=lnlinks href=#hl-32-56>56</a>
</span><span class=lnt id=hl-32-57><a class=lnlinks href=#hl-32-57>57</a>
</span><span class=lnt id=hl-32-58><a class=lnlinks href=#hl-32-58>58</a>
</span><span class=lnt id=hl-32-59><a class=lnlinks href=#hl-32-59>59</a>
</span><span class=lnt id=hl-32-60><a class=lnlinks href=#hl-32-60>60</a>
</span><span class=lnt id=hl-32-61><a class=lnlinks href=#hl-32-61>61</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//FutureTask源码（部分）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FutureTask</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>RunnableFuture</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** The underlying callable; nulled out after running */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>callable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** The result to return or exception to throw from get() */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>outcome</span><span class=p>;</span><span class=w> </span><span class=c1>// non-volatile, protected by state reads/writes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>FutureTask</span><span class=p>(</span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>callable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>callable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NullPointerException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>callable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NEW</span><span class=p>;</span><span class=w>       </span><span class=c1>// ensure visibility of callable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>V</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>ran</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>call</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ran</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ran</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ran</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>set</span><span class=p>(</span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>V</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>stateOffset</span><span class=p>,</span><span class=w> </span><span class=n>NEW</span><span class=p>,</span><span class=w> </span><span class=n>COMPLETING</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>outcome</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>putOrderedInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>stateOffset</span><span class=p>,</span><span class=w> </span><span class=n>NORMAL</span><span class=p>);</span><span class=w> </span><span class=c1>// final state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>finishCompletion</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>COMPLETING</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>awaitDone</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>0L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>report</span><span class=p>(</span><span class=n>s</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>report</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>outcome</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NORMAL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>V</span><span class=p>)</span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>CANCELLED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CancellationException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>((</span><span class=n>Throwable</span><span class=p>)</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>    
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-33-1><a class=lnlinks href=#hl-33-1> 1</a>
</span><span class=lnt id=hl-33-2><a class=lnlinks href=#hl-33-2> 2</a>
</span><span class=lnt id=hl-33-3><a class=lnlinks href=#hl-33-3> 3</a>
</span><span class=lnt id=hl-33-4><a class=lnlinks href=#hl-33-4> 4</a>
</span><span class=lnt id=hl-33-5><a class=lnlinks href=#hl-33-5> 5</a>
</span><span class=lnt id=hl-33-6><a class=lnlinks href=#hl-33-6> 6</a>
</span><span class=lnt id=hl-33-7><a class=lnlinks href=#hl-33-7> 7</a>
</span><span class=lnt id=hl-33-8><a class=lnlinks href=#hl-33-8> 8</a>
</span><span class=lnt id=hl-33-9><a class=lnlinks href=#hl-33-9> 9</a>
</span><span class=lnt id=hl-33-10><a class=lnlinks href=#hl-33-10>10</a>
</span><span class=lnt id=hl-33-11><a class=lnlinks href=#hl-33-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//Callable源码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@FunctionalInterface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Computes a result, or throws an exception if unable to do so.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return computed result
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws Exception if unable to compute a result
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>V</span><span class=w> </span><span class=nf>call</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>说明：</p><ul><li>FutureTask内置了一个Callable对象，初始化方法将指定的Callable赋给这个对象。</li><li>FutureTask实现了Runnable接口，并重写了Run方法，在Run方法中调用了Callable中的call方法，并将返回值赋值给outcome变量</li><li>get方法就是取出outcome的值。</li></ul><h2 id=32-观察多个线程同时运行><a href=#32-%e8%a7%82%e5%af%9f%e5%a4%9a%e4%b8%aa%e7%ba%bf%e7%a8%8b%e5%90%8c%e6%97%b6%e8%bf%90%e8%a1%8c class=header-anchor>#</a>
3.2 观察多个线程同时运行</h2><p>主要是理解</p><ul><li>交替执行</li><li>谁先谁后，不由我们控制</li></ul><p>示例代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-34-1><a class=lnlinks href=#hl-34-1> 1</a>
</span><span class=lnt id=hl-34-2><a class=lnlinks href=#hl-34-2> 2</a>
</span><span class=lnt id=hl-34-3><a class=lnlinks href=#hl-34-3> 3</a>
</span><span class=lnt id=hl-34-4><a class=lnlinks href=#hl-34-4> 4</a>
</span><span class=lnt id=hl-34-5><a class=lnlinks href=#hl-34-5> 5</a>
</span><span class=lnt id=hl-34-6><a class=lnlinks href=#hl-34-6> 6</a>
</span><span class=lnt id=hl-34-7><a class=lnlinks href=#hl-34-7> 7</a>
</span><span class=lnt id=hl-34-8><a class=lnlinks href=#hl-34-8> 8</a>
</span><span class=lnt id=hl-34-9><a class=lnlinks href=#hl-34-9> 9</a>
</span><span class=lnt id=hl-34-10><a class=lnlinks href=#hl-34-10>10</a>
</span><span class=lnt id=hl-34-11><a class=lnlinks href=#hl-34-11>11</a>
</span><span class=lnt id=hl-34-12><a class=lnlinks href=#hl-34-12>12</a>
</span><span class=lnt id=hl-34-13><a class=lnlinks href=#hl-34-13>13</a>
</span><span class=lnt id=hl-34-14><a class=lnlinks href=#hl-34-14>14</a>
</span><span class=lnt id=hl-34-15><a class=lnlinks href=#hl-34-15>15</a>
</span><span class=lnt id=hl-34-16><a class=lnlinks href=#hl-34-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.TestMultiThread&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestMultiThread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>运行结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-35-1><a class=lnlinks href=#hl-35-1> 1</a>
</span><span class=lnt id=hl-35-2><a class=lnlinks href=#hl-35-2> 2</a>
</span><span class=lnt id=hl-35-3><a class=lnlinks href=#hl-35-3> 3</a>
</span><span class=lnt id=hl-35-4><a class=lnlinks href=#hl-35-4> 4</a>
</span><span class=lnt id=hl-35-5><a class=lnlinks href=#hl-35-5> 5</a>
</span><span class=lnt id=hl-35-6><a class=lnlinks href=#hl-35-6> 6</a>
</span><span class=lnt id=hl-35-7><a class=lnlinks href=#hl-35-7> 7</a>
</span><span class=lnt id=hl-35-8><a class=lnlinks href=#hl-35-8> 8</a>
</span><span class=lnt id=hl-35-9><a class=lnlinks href=#hl-35-9> 9</a>
</span><span class=lnt id=hl-35-10><a class=lnlinks href=#hl-35-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t2<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t2<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t2<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t2<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span></code></pre></td></tr></table></div></div><h2 id=33-查看进程线程的方法><a href=#33-%e6%9f%a5%e7%9c%8b%e8%bf%9b%e7%a8%8b%e7%ba%bf%e7%a8%8b%e7%9a%84%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
3.3 查看进程线程的方法</h2><h3 id=windows><a href=#windows class=header-anchor>#</a>
windows</h3><ul><li>任务管理器可以查看进程和线程数，也可以用来杀死进程</li><li>tasklist 查看进程<ul><li><code>tasklist</code> | <code>findstr</code> (查找关键字)</li></ul></li><li>taskkill 杀死进程<ul><li>taskkill /F(彻底杀死）/PID(进程PID)</li></ul></li></ul><h3 id=linux><a href=#linux class=header-anchor>#</a>
Linux</h3><ul><li>ps -fe 查看所有进程</li><li>ps -fT -p 查看某个进程（PID）的所有线程</li><li>kill 杀死进程 top 按大写 H 切换是否显示线程</li><li>top -H -p 查看某个进程（PID）的所有线程</li></ul><h3 id=java><a href=#java class=header-anchor>#</a>
Java</h3><ul><li>jps 命令查看所有 Java 进程</li><li>jstack 查看某个 Java 进程（PID）的所有线程状态</li><li>jconsole 来查看某个 Java 进程中线程的运行情况（图形界面）</li></ul><p>jconsole 远程监控配置</p><ul><li><p>需要以如下方式运行你的 java 类</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-36-1><a class=lnlinks href=#hl-36-1>1</a>
</span><span class=lnt id=hl-36-2><a class=lnlinks href=#hl-36-2>2</a>
</span><span class=lnt id=hl-36-3><a class=lnlinks href=#hl-36-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>java -Djava.rmi.server.hostname<span class=o>=</span><span class=sb>`</span>ip地址<span class=sb>`</span> -Dcom.sun.management.jmxremote -
</span></span><span class=line><span class=cl>Dcom.sun.management.jmxremote.port<span class=o>=</span><span class=sb>`</span>连接端口<span class=sb>`</span> -Dcom.sun.management.jmxremote.ssl<span class=o>=</span>是否安全连接 -
</span></span><span class=line><span class=cl>Dcom.sun.management.jmxremote.authenticate<span class=o>=</span>是否认证 java类
</span></span></code></pre></td></tr></table></div></div></li><li><p>关闭防火墙，允许端口</p></li><li><p>修改 /etc/hosts 文件将 127.0.0.1 映射至主机名</p></li></ul><p>如果要认证访问，还需要做如下步骤</p><ul><li>复制 jmxremote.password 文件</li><li>修改 jmxremote.password 和 jmxremote.access 文件的权限为 600 即文件所有者可读写</li><li>连接时填入 controlRole（用户名），R&amp;D（密码）</li></ul><h2 id=textcolorblue34--原理之线程运行-><a href=#textcolorblue34--%e5%8e%9f%e7%90%86%e4%b9%8b%e7%ba%bf%e7%a8%8b%e8%bf%90%e8%a1%8c- class=header-anchor>#</a>
$\textcolor{Blue}{3.4 * 原理之线程运行} $</h2><h3 id=栈与栈帧><a href=#%e6%a0%88%e4%b8%8e%e6%a0%88%e5%b8%a7 class=header-anchor>#</a>
栈与栈帧</h3><p>Java Virtual Machine Stacks （Java 虚拟机栈）</p><p>我们都知道 JVM 中由堆、栈、方法区所组成，其中栈内存是给谁用的呢？其实就是线程，每个线程启动后，虚拟 机就会为其分配一块栈内存。</p><ul><li>每个栈由多个栈帧（Frame）组成，对应着每次方法调用时所占用的内存</li><li>每个线程只能有一个活动栈帧，对应着当前正在执行的那个方法</li></ul><h3 id=线程上下文切换thread-context-switch><a href=#%e7%ba%bf%e7%a8%8b%e4%b8%8a%e4%b8%8b%e6%96%87%e5%88%87%e6%8d%a2thread-context-switch class=header-anchor>#</a>
线程上下文切换（Thread Context Switch）</h3><p>因为以下一些原因导致 cpu 不再执行当前的线程，转而执行另一个线程的代码</p><ul><li>线程的 cpu 时间片用完</li><li>垃圾回收</li><li>有更高优先级的线程需要运行</li><li>线程自己调用了 sleep、yield、wait、join、park、synchronized、lock 等方法</li></ul><p>当 Context Switch 发生时，需要由操作系统保存当前线程的状态，并恢复另一个线程的状态，Java 中对应的概念 就是程序计数器（Program Counter Register），它的作用是记住下一条 jvm 指令的执行地址，是线程私有的</p><ul><li>状态包括程序计数器、虚拟机栈中每个栈帧的信息，如局部变量、操作数栈、返回地址等</li><li>Context Switch 频繁发生会影响性能</li></ul><h2 id=35常见方法><a href=#35%e5%b8%b8%e8%a7%81%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
3.5常见方法</h2><div class=table-wrapper><table><thead><tr><th>方法</th><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><strong>public void start()</strong></td><td>启动一个新线程；Java虚拟机调用此线程的run方法</td><td>start 方法只是让线程进入就绪，里面代码不一定立刻 运行（CPU 的时间片还没分给它）。每个线程对象的 start方法只能调用一次，如果调用了多次会出现 IllegalThreadStateException</td></tr><tr><td><strong>public void run()</strong></td><td>线程启动后调用该方法</td><td>如果在构造 Thread 对象时传递了 Runnable 参数，则 线程启动后会调用 Runnable 中的 run 方法，否则默 认不执行任何操作。但可以创建 Thread 的子类对象， 来覆盖默认行为</td></tr><tr><td><strong>public void setName(String name)</strong></td><td>给当前线程取名字</td><td></td></tr><tr><td><strong>public void getName()</strong></td><td>获取当前线程的名字。线程存在默认名称：子线程是Thread-索引，主线程是main</td><td></td></tr><tr><td><strong>public static Thread currentThread()</strong></td><td>获取当前线程对象，代码在哪个线程中执行</td><td></td></tr><tr><td><strong>public static void sleep(long time)</strong></td><td>让当前线程休眠多少毫秒再继续执行。<strong>Thread.sleep(0)</strong> : 让操作系统立刻重新进行一次cpu竞争</td><td></td></tr><tr><td><strong>public static native void yield()</strong></td><td>提示线程调度器让出当前线程对CPU的使用</td><td>主要是为了测试和调试</td></tr><tr><td><strong>public final int getPriority()</strong></td><td>返回此线程的优先级</td><td></td></tr><tr><td><strong>public final void setPriority(int priority)</strong></td><td>更改此线程的优先级，常用1 5 10</td><td>java中规定线程优先级是1~10 的整数，较大的优先级 能提高该线程被 CPU 调度的机率</td></tr><tr><td><strong>public void interrupt()</strong></td><td>中断这个线程，异常处理机制</td><td></td></tr><tr><td><strong>public static boolean interrupted()</strong></td><td>判断当前线程是否被打断，清除打断标记</td><td></td></tr><tr><td><strong>public boolean isInterrupted()</strong></td><td>判断当前线程是否被打断，不清除打断标记</td><td></td></tr><tr><td><strong>public final void join()</strong></td><td>等待这个线程结束</td><td></td></tr><tr><td><strong>public final void join(long millis)</strong></td><td>等待这个线程死亡millis毫秒，0意味着永远等待</td><td></td></tr><tr><td><strong>public final native boolean isAlive()</strong></td><td>线程是否存活（还没有运行完毕）</td><td></td></tr><tr><td><strong>public final void setDaemon(boolean on)</strong></td><td>将此线程标记为守护线程或用户线程</td><td></td></tr><tr><td><strong>public long getId()</strong></td><td>获取线程长整型 的 id</td><td>id 唯一</td></tr><tr><td><strong>public state getState()</strong></td><td>获取线程状态</td><td>Java 中线程状态是用 6 个 enum 表示，分别为： NEW, RUNNABLE, BLOCKED, WAITING, TIMED_WAITING, TERMINATED</td></tr><tr><td><strong>public boolean isInterrupted()</strong></td><td>判断是否被打 断</td><td>不会清除 打断标记</td></tr></tbody></table></div><h2 id=36-start-与-run><a href=#36-start-%e4%b8%8e-run class=header-anchor>#</a>
3.6 start 与 run</h2><h3 id=调用-run><a href=#%e8%b0%83%e7%94%a8-run class=header-anchor>#</a>
调用 run</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-37-1><a class=lnlinks href=#hl-37-1> 1</a>
</span><span class=lnt id=hl-37-2><a class=lnlinks href=#hl-37-2> 2</a>
</span><span class=lnt id=hl-37-3><a class=lnlinks href=#hl-37-3> 3</a>
</span><span class=lnt id=hl-37-4><a class=lnlinks href=#hl-37-4> 4</a>
</span><span class=lnt id=hl-37-5><a class=lnlinks href=#hl-37-5> 5</a>
</span><span class=lnt id=hl-37-6><a class=lnlinks href=#hl-37-6> 6</a>
</span><span class=lnt id=hl-37-7><a class=lnlinks href=#hl-37-7> 7</a>
</span><span class=lnt id=hl-37-8><a class=lnlinks href=#hl-37-8> 8</a>
</span><span class=lnt id=hl-37-9><a class=lnlinks href=#hl-37-9> 9</a>
</span><span class=lnt id=hl-37-10><a class=lnlinks href=#hl-37-10>10</a>
</span><span class=lnt id=hl-37-11><a class=lnlinks href=#hl-37-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=s>&#34;t1&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>FileReader</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>MP4_FULL_PATH</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;do other things ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-38-1><a class=lnlinks href=#hl-38-1>1</a>
</span><span class=lnt id=hl-38-2><a class=lnlinks href=#hl-38-2>2</a>
</span><span class=lnt id=hl-38-3><a class=lnlinks href=#hl-38-3>3</a>
</span><span class=lnt id=hl-38-4><a class=lnlinks href=#hl-38-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:39:14 <span class=o>[</span>main<span class=o>]</span> c.TestStart - main
</span></span><span class=line><span class=cl>19:39:14 <span class=o>[</span>main<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ...
</span></span><span class=line><span class=cl>19:39:18 <span class=o>[</span>main<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>4227</span> ms
</span></span><span class=line><span class=cl>19:39:18 <span class=o>[</span>main<span class=o>]</span> c.TestStart - <span class=k>do</span> other things ...
</span></span></code></pre></td></tr></table></div></div><p>程序仍在 main 线程运行， FileReader.read() 方法调用还是同步的</p><h3 id=调用start><a href=#%e8%b0%83%e7%94%a8start class=header-anchor>#</a>
调用start</h3><p>将上述代码的 t1.run() 改为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-39-1><a class=lnlinks href=#hl-39-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-40-1><a class=lnlinks href=#hl-40-1>1</a>
</span><span class=lnt id=hl-40-2><a class=lnlinks href=#hl-40-2>2</a>
</span><span class=lnt id=hl-40-3><a class=lnlinks href=#hl-40-3>3</a>
</span><span class=lnt id=hl-40-4><a class=lnlinks href=#hl-40-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:41:30 <span class=o>[</span>main<span class=o>]</span> c.TestStart - <span class=k>do</span> other things ...
</span></span><span class=line><span class=cl>19:41:30 <span class=o>[</span>t1<span class=o>]</span> c.TestStart - t1
</span></span><span class=line><span class=cl>19:41:30 <span class=o>[</span>t1<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ...
</span></span><span class=line><span class=cl>19:41:35 <span class=o>[</span>t1<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>4542</span> ms
</span></span></code></pre></td></tr></table></div></div><p>程序在 t1 线程运行， FileReader.read() 方法调用是异步的</p><h3 id=小结-1><a href=#%e5%b0%8f%e7%bb%93-1 class=header-anchor>#</a>
小结</h3><ul><li><p>直接调用 run 是在主线程中执行了 run，没有启动新的线程</p></li><li><p>使用 start 是启动新的线程，通过新的线程间接执行 run 中的代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-41-1><a class=lnlinks href=#hl-41-1> 1</a>
</span><span class=lnt id=hl-41-2><a class=lnlinks href=#hl-41-2> 2</a>
</span><span class=lnt id=hl-41-3><a class=lnlinks href=#hl-41-3> 3</a>
</span><span class=lnt id=hl-41-4><a class=lnlinks href=#hl-41-4> 4</a>
</span><span class=lnt id=hl-41-5><a class=lnlinks href=#hl-41-5> 5</a>
</span><span class=lnt id=hl-41-6><a class=lnlinks href=#hl-41-6> 6</a>
</span><span class=lnt id=hl-41-7><a class=lnlinks href=#hl-41-7> 7</a>
</span><span class=lnt id=hl-41-8><a class=lnlinks href=#hl-41-8> 8</a>
</span><span class=lnt id=hl-41-9><a class=lnlinks href=#hl-41-9> 9</a>
</span><span class=lnt id=hl-41-10><a class=lnlinks href=#hl-41-10>10</a>
</span><span class=lnt id=hl-41-11><a class=lnlinks href=#hl-41-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=s>&#34;t1&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>t1</span><span class=p>.</span><span class=na>getState</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>t1</span><span class=p>.</span><span class=na>getState</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以看见，start方法创建了一个新线程，将线程从就绪状态切换为Runnable</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-42-1><a class=lnlinks href=#hl-42-1>1</a>
</span><span class=lnt id=hl-42-2><a class=lnlinks href=#hl-42-2>2</a>
</span><span class=lnt id=hl-42-3><a class=lnlinks href=#hl-42-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>NEW
</span></span><span class=line><span class=cl>RUNNABLE
</span></span><span class=line><span class=cl>03:45:12.255 c.Test5 <span class=o>[</span>t1<span class=o>]</span> - running...
</span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=37-sleep-与-yield><a href=#37-sleep-%e4%b8%8e-yield class=header-anchor>#</a>
3.7 sleep 与 yield</h2><h3 id=sleep><a href=#sleep class=header-anchor>#</a>
sleep</h3><ol><li><p>调用 sleep 会让当前线程从 Running 进入 Timed Waiting 状态（阻塞）</p></li><li><p>其它线程可以使用 interrupt 方法打断正在睡眠的线程，这时 sleep 方法会抛出 InterruptedException</p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-43-1><a class=lnlinks href=#hl-43-1> 1</a>
</span><span class=lnt id=hl-43-2><a class=lnlinks href=#hl-43-2> 2</a>
</span><span class=lnt id=hl-43-3><a class=lnlinks href=#hl-43-3> 3</a>
</span><span class=lnt id=hl-43-4><a class=lnlinks href=#hl-43-4> 4</a>
</span><span class=lnt id=hl-43-5><a class=lnlinks href=#hl-43-5> 5</a>
</span><span class=lnt id=hl-43-6><a class=lnlinks href=#hl-43-6> 6</a>
</span><span class=lnt id=hl-43-7><a class=lnlinks href=#hl-43-7> 7</a>
</span><span class=lnt id=hl-43-8><a class=lnlinks href=#hl-43-8> 8</a>
</span><span class=lnt id=hl-43-9><a class=lnlinks href=#hl-43-9> 9</a>
</span><span class=lnt id=hl-43-10><a class=lnlinks href=#hl-43-10>10</a>
</span><span class=lnt id=hl-43-11><a class=lnlinks href=#hl-43-11>11</a>
</span><span class=lnt id=hl-43-12><a class=lnlinks href=#hl-43-12>12</a>
</span><span class=lnt id=hl-43-13><a class=lnlinks href=#hl-43-13>13</a>
</span><span class=lnt id=hl-43-14><a class=lnlinks href=#hl-43-14>14</a>
</span><span class=lnt id=hl-43-15><a class=lnlinks href=#hl-43-15>15</a>
</span><span class=lnt id=hl-43-16><a class=lnlinks href=#hl-43-16>16</a>
</span><span class=lnt id=hl-43-17><a class=lnlinks href=#hl-43-17>17</a>
</span><span class=lnt id=hl-43-18><a class=lnlinks href=#hl-43-18>18</a>
</span><span class=lnt id=hl-43-19><a class=lnlinks href=#hl-43-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=s>&#34;t1&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;enter sleep...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;wake up...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;interrupt...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-44-1><a class=lnlinks href=#hl-44-1>1</a>
</span><span class=lnt id=hl-44-2><a class=lnlinks href=#hl-44-2>2</a>
</span><span class=lnt id=hl-44-3><a class=lnlinks href=#hl-44-3>3</a>
</span><span class=lnt id=hl-44-4><a class=lnlinks href=#hl-44-4>4</a>
</span><span class=lnt id=hl-44-5><a class=lnlinks href=#hl-44-5>5</a>
</span><span class=lnt id=hl-44-6><a class=lnlinks href=#hl-44-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>03:47:18.141 c.Test7 <span class=o>[</span>t1<span class=o>]</span> - enter sleep...
</span></span><span class=line><span class=cl>03:47:19.132 c.Test7 <span class=o>[</span>main<span class=o>]</span> - interrupt...
</span></span><span class=line><span class=cl>03:47:19.132 c.Test7 <span class=o>[</span>t1<span class=o>]</span> - wake up...
</span></span><span class=line><span class=cl>java.lang.InterruptedException: sleep interrupted
</span></span><span class=line><span class=cl>	at java.lang.Thread.sleep<span class=o>(</span>Native Method<span class=o>)</span>
</span></span><span class=line><span class=cl>	at cn.itcast.test.Test7<span class=nv>$1</span>.run<span class=o>(</span>Test7.java:14<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3><li><p>睡眠结束后的线程未必会立刻得到执行</p></li><li><p>建议用 TimeUnit 的 sleep 代替 Thread 的 sleep 来获得更好的可读性 。其底层还是sleep方法。</p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-45-1><a class=lnlinks href=#hl-45-1> 1</a>
</span><span class=lnt id=hl-45-2><a class=lnlinks href=#hl-45-2> 2</a>
</span><span class=lnt id=hl-45-3><a class=lnlinks href=#hl-45-3> 3</a>
</span><span class=lnt id=hl-45-4><a class=lnlinks href=#hl-45-4> 4</a>
</span><span class=lnt id=hl-45-5><a class=lnlinks href=#hl-45-5> 5</a>
</span><span class=lnt id=hl-45-6><a class=lnlinks href=#hl-45-6> 6</a>
</span><span class=lnt id=hl-45-7><a class=lnlinks href=#hl-45-7> 7</a>
</span><span class=lnt id=hl-45-8><a class=lnlinks href=#hl-45-8> 8</a>
</span><span class=lnt id=hl-45-9><a class=lnlinks href=#hl-45-9> 9</a>
</span><span class=lnt id=hl-45-10><a class=lnlinks href=#hl-45-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Test8&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test8</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;enter&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        Thread.sleep(1000);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol start=5><li>在循环访问锁的过程中，可以加入sleep让线程阻塞时间，防止大量占用cpu资源。</li></ol><h3 id=yield><a href=#yield class=header-anchor>#</a>
yield</h3><ol><li>调用 yield 会让当前线程从 Running 进入 Runnable 就绪状态，然后调度执行其它线程</li><li>具体的实现依赖于操作系统的任务调度器</li></ol><h3 id=线程优先级><a href=#%e7%ba%bf%e7%a8%8b%e4%bc%98%e5%85%88%e7%ba%a7 class=header-anchor>#</a>
线程优先级</h3><ul><li>线程优先级会提示（hint）调度器优先调度该线程，但它仅仅是一个提示，调度器可以忽略它</li><li>如果 cpu 比较忙，那么优先级高的线程会获得更多的时间片，但 cpu 闲时，优先级几乎没作用</li></ul><h3 id=测试优先级和yield><a href=#%e6%b5%8b%e8%af%95%e4%bc%98%e5%85%88%e7%ba%a7%e5%92%8cyield class=header-anchor>#</a>
测试优先级和yield</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-46-1><a class=lnlinks href=#hl-46-1> 1</a>
</span><span class=lnt id=hl-46-2><a class=lnlinks href=#hl-46-2> 2</a>
</span><span class=lnt id=hl-46-3><a class=lnlinks href=#hl-46-3> 3</a>
</span><span class=lnt id=hl-46-4><a class=lnlinks href=#hl-46-4> 4</a>
</span><span class=lnt id=hl-46-5><a class=lnlinks href=#hl-46-5> 5</a>
</span><span class=lnt id=hl-46-6><a class=lnlinks href=#hl-46-6> 6</a>
</span><span class=lnt id=hl-46-7><a class=lnlinks href=#hl-46-7> 7</a>
</span><span class=lnt id=hl-46-8><a class=lnlinks href=#hl-46-8> 8</a>
</span><span class=lnt id=hl-46-9><a class=lnlinks href=#hl-46-9> 9</a>
</span><span class=lnt id=hl-46-10><a class=lnlinks href=#hl-46-10>10</a>
</span><span class=lnt id=hl-46-11><a class=lnlinks href=#hl-46-11>11</a>
</span><span class=lnt id=hl-46-12><a class=lnlinks href=#hl-46-12>12</a>
</span><span class=lnt id=hl-46-13><a class=lnlinks href=#hl-46-13>13</a>
</span><span class=lnt id=hl-46-14><a class=lnlinks href=#hl-46-14>14</a>
</span><span class=lnt id=hl-46-15><a class=lnlinks href=#hl-46-15>15</a>
</span><span class=lnt id=hl-46-16><a class=lnlinks href=#hl-46-16>16</a>
</span><span class=lnt id=hl-46-17><a class=lnlinks href=#hl-46-17>17</a>
</span><span class=lnt id=hl-46-18><a class=lnlinks href=#hl-46-18>18</a>
</span><span class=lnt id=hl-46-19><a class=lnlinks href=#hl-46-19>19</a>
</span><span class=lnt id=hl-46-20><a class=lnlinks href=#hl-46-20>20</a>
</span><span class=lnt id=hl-46-21><a class=lnlinks href=#hl-46-21>21</a>
</span><span class=lnt id=hl-46-22><a class=lnlinks href=#hl-46-22>22</a>
</span><span class=lnt id=hl-46-23><a class=lnlinks href=#hl-46-23>23</a>
</span><span class=lnt id=hl-46-24><a class=lnlinks href=#hl-46-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.TestYield&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestYield</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Runnable</span><span class=w> </span><span class=n>task1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;----&gt;1 &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=o>++</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Runnable</span><span class=w> </span><span class=n>task2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                Thread.yield();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;              ----&gt;2 &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=o>++</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>task1</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>task2</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>setPriority</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>MIN_PRIORITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>setPriority</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>MAX_PRIORITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-47-1><a class=lnlinks href=#hl-47-1>1</a>
</span><span class=lnt id=hl-47-2><a class=lnlinks href=#hl-47-2>2</a>
</span><span class=lnt id=hl-47-3><a class=lnlinks href=#hl-47-3>3</a>
</span><span class=lnt id=hl-47-4><a class=lnlinks href=#hl-47-4>4</a>
</span><span class=lnt id=hl-47-5><a class=lnlinks href=#hl-47-5>5</a>
</span><span class=lnt id=hl-47-6><a class=lnlinks href=#hl-47-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1>#优先级</span>
</span></span><span class=line><span class=cl>----&gt;1 <span class=m>283500</span>
</span></span><span class=line><span class=cl>----&gt;2 <span class=m>374389</span>
</span></span><span class=line><span class=cl><span class=c1>#yield</span>
</span></span><span class=line><span class=cl>----&gt;1 <span class=m>119199</span>
</span></span><span class=line><span class=cl>----&gt;2 <span class=m>101074</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看出，线程优先级和yield会对线程获取cpu时间片产生一定影响，但不会影响太大。</p><h3 id=textcolorgreen-应用之限制案例1--><a href=#textcolorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e9%99%90%e5%88%b6%e6%a1%88%e4%be%8b1-- class=header-anchor>#</a>
$\textcolor{Green}{* 应用之限制（案例1） } $</h3><h4 id=sleep-实现><a href=#sleep-%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
sleep 实现</h4><p>在没有利用 cpu 来计算时，不要让 while(true) 空转浪费 cpu，这时可以使用 yield 或 sleep 来让出 cpu 的使用权 给其他程序</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-48-1><a class=lnlinks href=#hl-48-1>1</a>
</span><span class=lnt id=hl-48-2><a class=lnlinks href=#hl-48-2>2</a>
</span><span class=lnt id=hl-48-3><a class=lnlinks href=#hl-48-3>3</a>
</span><span class=lnt id=hl-48-4><a class=lnlinks href=#hl-48-4>4</a>
</span><span class=lnt id=hl-48-5><a class=lnlinks href=#hl-48-5>5</a>
</span><span class=lnt id=hl-48-6><a class=lnlinks href=#hl-48-6>6</a>
</span><span class=lnt id=hl-48-7><a class=lnlinks href=#hl-48-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>50</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>可以用 wait 或 条件变量达到类似的效果</li><li>不同的是，后两种都需要加锁，并且需要相应的唤醒操作，一般适用于要进行同步的场景</li><li>sleep 适用于无需锁同步的场景</li></ul><h4 id=wait-实现><a href=#wait-%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
wait 实现</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-49-1><a class=lnlinks href=#hl-49-1> 1</a>
</span><span class=lnt id=hl-49-2><a class=lnlinks href=#hl-49-2> 2</a>
</span><span class=lnt id=hl-49-3><a class=lnlinks href=#hl-49-3> 3</a>
</span><span class=lnt id=hl-49-4><a class=lnlinks href=#hl-49-4> 4</a>
</span><span class=lnt id=hl-49-5><a class=lnlinks href=#hl-49-5> 5</a>
</span><span class=lnt id=hl-49-6><a class=lnlinks href=#hl-49-6> 6</a>
</span><span class=lnt id=hl-49-7><a class=lnlinks href=#hl-49-7> 7</a>
</span><span class=lnt id=hl-49-8><a class=lnlinks href=#hl-49-8> 8</a>
</span><span class=lnt id=hl-49-9><a class=lnlinks href=#hl-49-9> 9</a>
</span><span class=lnt id=hl-49-10><a class=lnlinks href=#hl-49-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>synchronized</span><span class=p>(</span><span class=n>锁对象</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>条件不满足</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>锁对象</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// do sth...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=条件变量实现><a href=#%e6%9d%a1%e4%bb%b6%e5%8f%98%e9%87%8f%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
条件变量实现</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-50-1><a class=lnlinks href=#hl-50-1> 1</a>
</span><span class=lnt id=hl-50-2><a class=lnlinks href=#hl-50-2> 2</a>
</span><span class=lnt id=hl-50-3><a class=lnlinks href=#hl-50-3> 3</a>
</span><span class=lnt id=hl-50-4><a class=lnlinks href=#hl-50-4> 4</a>
</span><span class=lnt id=hl-50-5><a class=lnlinks href=#hl-50-5> 5</a>
</span><span class=lnt id=hl-50-6><a class=lnlinks href=#hl-50-6> 6</a>
</span><span class=lnt id=hl-50-7><a class=lnlinks href=#hl-50-7> 7</a>
</span><span class=lnt id=hl-50-8><a class=lnlinks href=#hl-50-8> 8</a>
</span><span class=lnt id=hl-50-9><a class=lnlinks href=#hl-50-9> 9</a>
</span><span class=lnt id=hl-50-10><a class=lnlinks href=#hl-50-10>10</a>
</span><span class=lnt id=hl-50-11><a class=lnlinks href=#hl-50-11>11</a>
</span><span class=lnt id=hl-50-12><a class=lnlinks href=#hl-50-12>12</a>
</span><span class=lnt id=hl-50-13><a class=lnlinks href=#hl-50-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>条件不满足</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>条件变量</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// do sth...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=38-join-方法详解><a href=#38-join-%e6%96%b9%e6%b3%95%e8%af%a6%e8%a7%a3 class=header-anchor>#</a>
3.8 join 方法详解</h2><h3 id=为什么需要-join><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81-join class=header-anchor>#</a>
为什么需要 join</h3><p>下面的代码执行，打印 r 是什么？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-51-1><a class=lnlinks href=#hl-51-1> 1</a>
</span><span class=lnt id=hl-51-2><a class=lnlinks href=#hl-51-2> 2</a>
</span><span class=lnt id=hl-51-3><a class=lnlinks href=#hl-51-3> 3</a>
</span><span class=lnt id=hl-51-4><a class=lnlinks href=#hl-51-4> 4</a>
</span><span class=lnt id=hl-51-5><a class=lnlinks href=#hl-51-5> 5</a>
</span><span class=lnt id=hl-51-6><a class=lnlinks href=#hl-51-6> 6</a>
</span><span class=lnt id=hl-51-7><a class=lnlinks href=#hl-51-7> 7</a>
</span><span class=lnt id=hl-51-8><a class=lnlinks href=#hl-51-8> 8</a>
</span><span class=lnt id=hl-51-9><a class=lnlinks href=#hl-51-9> 9</a>
</span><span class=lnt id=hl-51-10><a class=lnlinks href=#hl-51-10>10</a>
</span><span class=lnt id=hl-51-11><a class=lnlinks href=#hl-51-11>11</a>
</span><span class=lnt id=hl-51-12><a class=lnlinks href=#hl-51-12>12</a>
</span><span class=lnt id=hl-51-13><a class=lnlinks href=#hl-51-13>13</a>
</span><span class=lnt id=hl-51-14><a class=lnlinks href=#hl-51-14>14</a>
</span><span class=lnt id=hl-51-15><a class=lnlinks href=#hl-51-15>15</a>
</span><span class=lnt id=hl-51-16><a class=lnlinks href=#hl-51-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>test1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结束&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结果为:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;结束&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>分析</p><ul><li>因为主线程和线程 t1 是并行执行的，t1 线程需要 1 秒之后才能算出 r=10</li><li>而主线程一开始就要打印 r 的结果，所以只能打印出 r=0</li></ul><p>解决方法</p><ul><li>用 sleep 行不行？为什么？</li><li>用 join，加在 t1.start() 之后即可</li></ul><h3 id=textcolorgreen-应用之同步案例1><a href=#textcolorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e5%90%8c%e6%ad%a5%e6%a1%88%e4%be%8b1 class=header-anchor>#</a>
$\textcolor{green}{* 应用之同步（案例1）}$</h3><p>以调用方角度来讲，如果</p><ul><li>需要等待结果返回，才能继续运行就是同步</li><li>不需要等待结果返回，就能继续运行就是异步</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220224020718153.png width=900 height=600 loading=lazy decoding=async alt=image-20220224020718153 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>等待多个结果</strong></p><p>问，下面代码 cost 大约多少秒？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-52-1><a class=lnlinks href=#hl-52-1> 1</a>
</span><span class=lnt id=hl-52-2><a class=lnlinks href=#hl-52-2> 2</a>
</span><span class=lnt id=hl-52-3><a class=lnlinks href=#hl-52-3> 3</a>
</span><span class=lnt id=hl-52-4><a class=lnlinks href=#hl-52-4> 4</a>
</span><span class=lnt id=hl-52-5><a class=lnlinks href=#hl-52-5> 5</a>
</span><span class=lnt id=hl-52-6><a class=lnlinks href=#hl-52-6> 6</a>
</span><span class=lnt id=hl-52-7><a class=lnlinks href=#hl-52-7> 7</a>
</span><span class=lnt id=hl-52-8><a class=lnlinks href=#hl-52-8> 8</a>
</span><span class=lnt id=hl-52-9><a class=lnlinks href=#hl-52-9> 9</a>
</span><span class=lnt id=hl-52-10><a class=lnlinks href=#hl-52-10>10</a>
</span><span class=lnt id=hl-52-11><a class=lnlinks href=#hl-52-11>11</a>
</span><span class=lnt id=hl-52-12><a class=lnlinks href=#hl-52-12>12</a>
</span><span class=lnt id=hl-52-13><a class=lnlinks href=#hl-52-13>13</a>
</span><span class=lnt id=hl-52-14><a class=lnlinks href=#hl-52-14>14</a>
</span><span class=lnt id=hl-52-15><a class=lnlinks href=#hl-52-15>15</a>
</span><span class=lnt id=hl-52-16><a class=lnlinks href=#hl-52-16>16</a>
</span><span class=lnt id=hl-52-17><a class=lnlinks href=#hl-52-17>17</a>
</span><span class=lnt id=hl-52-18><a class=lnlinks href=#hl-52-18>18</a>
</span><span class=lnt id=hl-52-19><a class=lnlinks href=#hl-52-19>19</a>
</span><span class=lnt id=hl-52-20><a class=lnlinks href=#hl-52-20>20</a>
</span><span class=lnt id=hl-52-21><a class=lnlinks href=#hl-52-21>21</a>
</span><span class=lnt id=hl-52-22><a class=lnlinks href=#hl-52-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>test2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;r1: {} r2: {} cost: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>  
</span></span></span></code></pre></td></tr></table></div></div><p>分析如下</p><ul><li>第一个 join：等待 t1 时, t2 并没有停止, 而在运行</li><li>第二个 join：1s 后, 执行到此, t2 也运行了 1s, 因此也只需再等待 1s</li></ul><p>如果颠倒两个 join 呢？</p><p>最终都是输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-53-1><a class=lnlinks href=#hl-53-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:45:43.239 <span class=o>[</span>main<span class=o>]</span> c.TestJoin - r1: <span class=m>10</span> r2: <span class=m>20</span> cost: <span class=m>2005</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220224020847406.png width=900 height=600 loading=lazy decoding=async alt=image-20220224020847406 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h3 id=有时效的join><a href=#%e6%9c%89%e6%97%b6%e6%95%88%e7%9a%84join class=header-anchor>#</a>
有时效的join</h3><p>当线程执行时间没有超过join设定时间</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-54-1><a class=lnlinks href=#hl-54-1> 1</a>
</span><span class=lnt id=hl-54-2><a class=lnlinks href=#hl-54-2> 2</a>
</span><span class=lnt id=hl-54-3><a class=lnlinks href=#hl-54-3> 3</a>
</span><span class=lnt id=hl-54-4><a class=lnlinks href=#hl-54-4> 4</a>
</span><span class=lnt id=hl-54-5><a class=lnlinks href=#hl-54-5> 5</a>
</span><span class=lnt id=hl-54-6><a class=lnlinks href=#hl-54-6> 6</a>
</span><span class=lnt id=hl-54-7><a class=lnlinks href=#hl-54-7> 7</a>
</span><span class=lnt id=hl-54-8><a class=lnlinks href=#hl-54-8> 8</a>
</span><span class=lnt id=hl-54-9><a class=lnlinks href=#hl-54-9> 9</a>
</span><span class=lnt id=hl-54-10><a class=lnlinks href=#hl-54-10>10</a>
</span><span class=lnt id=hl-54-11><a class=lnlinks href=#hl-54-11>11</a>
</span><span class=lnt id=hl-54-12><a class=lnlinks href=#hl-54-12>12</a>
</span><span class=lnt id=hl-54-13><a class=lnlinks href=#hl-54-13>13</a>
</span><span class=lnt id=hl-54-14><a class=lnlinks href=#hl-54-14>14</a>
</span><span class=lnt id=hl-54-15><a class=lnlinks href=#hl-54-15>15</a>
</span><span class=lnt id=hl-54-16><a class=lnlinks href=#hl-54-16>16</a>
</span><span class=lnt id=hl-54-17><a class=lnlinks href=#hl-54-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>test3</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 线程执行结束会导致 join 结束</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>1500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;r1: {} r2: {} cost: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-55-1><a class=lnlinks href=#hl-55-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:48:01.320 <span class=o>[</span>main<span class=o>]</span> c.TestJoin - r1: <span class=m>10</span> r2: <span class=m>0</span> cost: <span class=m>1010</span>
</span></span></code></pre></td></tr></table></div></div><p>当执行时间超时</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-56-1><a class=lnlinks href=#hl-56-1> 1</a>
</span><span class=lnt id=hl-56-2><a class=lnlinks href=#hl-56-2> 2</a>
</span><span class=lnt id=hl-56-3><a class=lnlinks href=#hl-56-3> 3</a>
</span><span class=lnt id=hl-56-4><a class=lnlinks href=#hl-56-4> 4</a>
</span><span class=lnt id=hl-56-5><a class=lnlinks href=#hl-56-5> 5</a>
</span><span class=lnt id=hl-56-6><a class=lnlinks href=#hl-56-6> 6</a>
</span><span class=lnt id=hl-56-7><a class=lnlinks href=#hl-56-7> 7</a>
</span><span class=lnt id=hl-56-8><a class=lnlinks href=#hl-56-8> 8</a>
</span><span class=lnt id=hl-56-9><a class=lnlinks href=#hl-56-9> 9</a>
</span><span class=lnt id=hl-56-10><a class=lnlinks href=#hl-56-10>10</a>
</span><span class=lnt id=hl-56-11><a class=lnlinks href=#hl-56-11>11</a>
</span><span class=lnt id=hl-56-12><a class=lnlinks href=#hl-56-12>12</a>
</span><span class=lnt id=hl-56-13><a class=lnlinks href=#hl-56-13>13</a>
</span><span class=lnt id=hl-56-14><a class=lnlinks href=#hl-56-14>14</a>
</span><span class=lnt id=hl-56-15><a class=lnlinks href=#hl-56-15>15</a>
</span><span class=lnt id=hl-56-16><a class=lnlinks href=#hl-56-16>16</a>
</span><span class=lnt id=hl-56-17><a class=lnlinks href=#hl-56-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>test3</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 线程执行结束会导致 join 结束</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>1500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;r1: {} r2: {} cost: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-57-1><a class=lnlinks href=#hl-57-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:52:15.623 <span class=o>[</span>main<span class=o>]</span> c.TestJoin - r1: <span class=m>0</span> r2: <span class=m>0</span> cost: <span class=m>1502</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=39-interrupt方法详解><a href=#39-interrupt%e6%96%b9%e6%b3%95%e8%af%a6%e8%a7%a3 class=header-anchor>#</a>
3.9 interrupt方法详解</h2><h3 id=interrupt说明><a href=#interrupt%e8%af%b4%e6%98%8e class=header-anchor>#</a>
<code>Interrupt</code>说明</h3><p><code>interrupt</code>的本质是将线程的打断标记设为true，并调用线程的三个parker对象（C++实现级别）unpark该线程。</p><p>基于以上本质，有如下说明：</p><ul><li>打断线程不等于中断线程，有以下两种情况：<ul><li>打断正在运行中的线程并不会影响线程的运行，但如果线程监测到了打断标记为true，可以自行决定后续处理。</li><li>打断阻塞中的线程会让此线程产生一个<code>InterruptedException</code>异常，结束线程的运行。但如果该异常被线程捕获住，该线程依然可以自行决定后续处理（终止运行，继续运行，做一些善后工作等等）</li></ul></li></ul><h3 id=打断-sleepwaitjoin-的线程><a href=#%e6%89%93%e6%96%ad-sleepwaitjoin-%e7%9a%84%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
打断 sleep，wait，join 的线程</h3><p>这几个方法都会让线程进入阻塞状态</p><p>打断 sleep 的线程, 会清空打断状态，以 sleep 为例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-58-1><a class=lnlinks href=#hl-58-1>1</a>
</span><span class=lnt id=hl-58-2><a class=lnlinks href=#hl-58-2>2</a>
</span><span class=lnt id=hl-58-3><a class=lnlinks href=#hl-58-3>3</a>
</span><span class=lnt id=hl-58-4><a class=lnlinks href=#hl-58-4>4</a>
</span><span class=lnt id=hl-58-5><a class=lnlinks href=#hl-58-5>5</a>
</span><span class=lnt id=hl-58-6><a class=lnlinks href=#hl-58-6>6</a>
</span><span class=lnt id=hl-58-7><a class=lnlinks href=#hl-58-7>7</a>
</span><span class=lnt id=hl-58-8><a class=lnlinks href=#hl-58-8>8</a>
</span><span class=lnt id=hl-58-9><a class=lnlinks href=#hl-58-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34; 打断状态: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>.</span><span class=na>isInterrupted</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-59-1><a class=lnlinks href=#hl-59-1>1</a>
</span><span class=lnt id=hl-59-2><a class=lnlinks href=#hl-59-2>2</a>
</span><span class=lnt id=hl-59-3><a class=lnlinks href=#hl-59-3>3</a>
</span><span class=lnt id=hl-59-4><a class=lnlinks href=#hl-59-4>4</a>
</span><span class=lnt id=hl-59-5><a class=lnlinks href=#hl-59-5>5</a>
</span><span class=lnt id=hl-59-6><a class=lnlinks href=#hl-59-6>6</a>
</span><span class=lnt id=hl-59-7><a class=lnlinks href=#hl-59-7>7</a>
</span><span class=lnt id=hl-59-8><a class=lnlinks href=#hl-59-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>java.lang.InterruptedException: sleep interrupted
</span></span><span class=line><span class=cl> at java.lang.Thread.sleep<span class=o>(</span>Native Method<span class=o>)</span>
</span></span><span class=line><span class=cl> at java.lang.Thread.sleep<span class=o>(</span>Thread.java:340<span class=o>)</span>
</span></span><span class=line><span class=cl> at java.util.concurrent.TimeUnit.sleep<span class=o>(</span>TimeUnit.java:386<span class=o>)</span>
</span></span><span class=line><span class=cl> at cn.itcast.n2.util.Sleeper.sleep<span class=o>(</span>Sleeper.java:8<span class=o>)</span>
</span></span><span class=line><span class=cl> at cn.itcast.n4.TestInterrupt.lambda<span class=nv>$test1$3</span><span class=o>(</span>TestInterrupt.java:59<span class=o>)</span>
</span></span><span class=line><span class=cl> at java.lang.Thread.run<span class=o>(</span>Thread.java:745<span class=o>)</span>
</span></span><span class=line><span class=cl>21:18:10.374 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - 打断状态: <span class=nb>false</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=打断正常运行的线程><a href=#%e6%89%93%e6%96%ad%e6%ad%a3%e5%b8%b8%e8%bf%90%e8%a1%8c%e7%9a%84%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
打断正常运行的线程</h3><p>打断正常运行的线程, 不会清空打断状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-60-1><a class=lnlinks href=#hl-60-1> 1</a>
</span><span class=lnt id=hl-60-2><a class=lnlinks href=#hl-60-2> 2</a>
</span><span class=lnt id=hl-60-3><a class=lnlinks href=#hl-60-3> 3</a>
</span><span class=lnt id=hl-60-4><a class=lnlinks href=#hl-60-4> 4</a>
</span><span class=lnt id=hl-60-5><a class=lnlinks href=#hl-60-5> 5</a>
</span><span class=lnt id=hl-60-6><a class=lnlinks href=#hl-60-6> 6</a>
</span><span class=lnt id=hl-60-7><a class=lnlinks href=#hl-60-7> 7</a>
</span><span class=lnt id=hl-60-8><a class=lnlinks href=#hl-60-8> 8</a>
</span><span class=lnt id=hl-60-9><a class=lnlinks href=#hl-60-9> 9</a>
</span><span class=lnt id=hl-60-10><a class=lnlinks href=#hl-60-10>10</a>
</span><span class=lnt id=hl-60-11><a class=lnlinks href=#hl-60-11>11</a>
</span><span class=lnt id=hl-60-12><a class=lnlinks href=#hl-60-12>12</a>
</span><span class=lnt id=hl-60-13><a class=lnlinks href=#hl-60-13>13</a>
</span><span class=lnt id=hl-60-14><a class=lnlinks href=#hl-60-14>14</a>
</span><span class=lnt id=hl-60-15><a class=lnlinks href=#hl-60-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>current</span><span class=p>.</span><span class=na>isInterrupted</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>interrupted</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34; 打断状态: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>interrupted</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-61-1><a class=lnlinks href=#hl-61-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:57:37.964 <span class=o>[</span>t2<span class=o>]</span> c.TestInterrupt - 打断状态: <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=font-colororange-模式之两阶段终止font><a href=#font-colororange-%e6%a8%a1%e5%bc%8f%e4%b9%8b%e4%b8%a4%e9%98%b6%e6%ae%b5%e7%bb%88%e6%ad%a2font class=header-anchor>#</a>
<font color=orange>* 模式之两阶段终止</font></h3><p>Two Phase Termination 在一个线程 T1 中如何“优雅”终止线程 T2？这里的【优雅】指的是给 T2 一个料理后事的机会。</p><h4 id=错误思路><a href=#%e9%94%99%e8%af%af%e6%80%9d%e8%b7%af class=header-anchor>#</a>
错误思路</h4><ul><li>使用线程对象的 stop() 方法停止线程<ul><li>stop 方法会真正杀死线程，如果这时线程锁住了共享资源，那么当它被杀死后就再也没有机会释放锁， 其它线程将永远无法获取锁</li></ul></li><li>使用 System.exit(int) 方法停止线程<ul><li>目的仅是停止一个线程，但这种做法会让整个程序都停止</li></ul></li></ul><h4 id=两阶段终止模式><a href=#%e4%b8%a4%e9%98%b6%e6%ae%b5%e7%bb%88%e6%ad%a2%e6%a8%a1%e5%bc%8f class=header-anchor>#</a>
两阶段终止模式</h4><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317193331864.png width=900 height=600 loading=lazy decoding=async alt=image-20220317193331864 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=利用-isinterrupted><a href=#%e5%88%a9%e7%94%a8-isinterrupted class=header-anchor>#</a>
利用 isInterrupted</h5><p>interrupt 可以打断正在执行的线程，无论这个线程是在 sleep，wait，还是正常运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-62-1><a class=lnlinks href=#hl-62-1> 1</a>
</span><span class=lnt id=hl-62-2><a class=lnlinks href=#hl-62-2> 2</a>
</span><span class=lnt id=hl-62-3><a class=lnlinks href=#hl-62-3> 3</a>
</span><span class=lnt id=hl-62-4><a class=lnlinks href=#hl-62-4> 4</a>
</span><span class=lnt id=hl-62-5><a class=lnlinks href=#hl-62-5> 5</a>
</span><span class=lnt id=hl-62-6><a class=lnlinks href=#hl-62-6> 6</a>
</span><span class=lnt id=hl-62-7><a class=lnlinks href=#hl-62-7> 7</a>
</span><span class=lnt id=hl-62-8><a class=lnlinks href=#hl-62-8> 8</a>
</span><span class=lnt id=hl-62-9><a class=lnlinks href=#hl-62-9> 9</a>
</span><span class=lnt id=hl-62-10><a class=lnlinks href=#hl-62-10>10</a>
</span><span class=lnt id=hl-62-11><a class=lnlinks href=#hl-62-11>11</a>
</span><span class=lnt id=hl-62-12><a class=lnlinks href=#hl-62-12>12</a>
</span><span class=lnt id=hl-62-13><a class=lnlinks href=#hl-62-13>13</a>
</span><span class=lnt id=hl-62-14><a class=lnlinks href=#hl-62-14>14</a>
</span><span class=lnt id=hl-62-15><a class=lnlinks href=#hl-62-15>15</a>
</span><span class=lnt id=hl-62-16><a class=lnlinks href=#hl-62-16>16</a>
</span><span class=lnt id=hl-62-17><a class=lnlinks href=#hl-62-17>17</a>
</span><span class=lnt id=hl-62-18><a class=lnlinks href=#hl-62-18>18</a>
</span><span class=lnt id=hl-62-19><a class=lnlinks href=#hl-62-19>19</a>
</span><span class=lnt id=hl-62-20><a class=lnlinks href=#hl-62-20>20</a>
</span><span class=lnt id=hl-62-21><a class=lnlinks href=#hl-62-21>21</a>
</span><span class=lnt id=hl-62-22><a class=lnlinks href=#hl-62-22>22</a>
</span><span class=lnt id=hl-62-23><a class=lnlinks href=#hl-62-23>23</a>
</span><span class=lnt id=hl-62-24><a class=lnlinks href=#hl-62-24>24</a>
</span><span class=lnt id=hl-62-25><a class=lnlinks href=#hl-62-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>TPTInterrupt</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>current</span><span class=p>.</span><span class=na>isInterrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;料理后事&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;将结果保存&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>current</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 执行监控操作 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;监控线程&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>调用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-63-1><a class=lnlinks href=#hl-63-1>1</a>
</span><span class=lnt id=hl-63-2><a class=lnlinks href=#hl-63-2>2</a>
</span><span class=lnt id=hl-63-3><a class=lnlinks href=#hl-63-3>3</a>
</span><span class=lnt id=hl-63-4><a class=lnlinks href=#hl-63-4>4</a>
</span><span class=lnt id=hl-63-5><a class=lnlinks href=#hl-63-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TPTInterrupt</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TPTInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>3500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;stop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-64-1><a class=lnlinks href=#hl-64-1>1</a>
</span><span class=lnt id=hl-64-2><a class=lnlinks href=#hl-64-2>2</a>
</span><span class=lnt id=hl-64-3><a class=lnlinks href=#hl-64-3>3</a>
</span><span class=lnt id=hl-64-4><a class=lnlinks href=#hl-64-4>4</a>
</span><span class=lnt id=hl-64-5><a class=lnlinks href=#hl-64-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:49:42.915 c.TwoPhaseTermination <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:49:43.919 c.TwoPhaseTermination <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:49:44.919 c.TwoPhaseTermination <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:49:45.413 c.TestTwoPhaseTermination <span class=o>[</span>main<span class=o>]</span> - stop 
</span></span><span class=line><span class=cl>11:49:45.413 c.TwoPhaseTermination <span class=o>[</span>监控线程<span class=o>]</span> - 料理后事
</span></span></code></pre></td></tr></table></div></div><h5 id=利用停止标记><a href=#%e5%88%a9%e7%94%a8%e5%81%9c%e6%ad%a2%e6%a0%87%e8%ae%b0 class=header-anchor>#</a>
利用停止标记</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-65-1><a class=lnlinks href=#hl-65-1> 1</a>
</span><span class=lnt id=hl-65-2><a class=lnlinks href=#hl-65-2> 2</a>
</span><span class=lnt id=hl-65-3><a class=lnlinks href=#hl-65-3> 3</a>
</span><span class=lnt id=hl-65-4><a class=lnlinks href=#hl-65-4> 4</a>
</span><span class=lnt id=hl-65-5><a class=lnlinks href=#hl-65-5> 5</a>
</span><span class=lnt id=hl-65-6><a class=lnlinks href=#hl-65-6> 6</a>
</span><span class=lnt id=hl-65-7><a class=lnlinks href=#hl-65-7> 7</a>
</span><span class=lnt id=hl-65-8><a class=lnlinks href=#hl-65-8> 8</a>
</span><span class=lnt id=hl-65-9><a class=lnlinks href=#hl-65-9> 9</a>
</span><span class=lnt id=hl-65-10><a class=lnlinks href=#hl-65-10>10</a>
</span><span class=lnt id=hl-65-11><a class=lnlinks href=#hl-65-11>11</a>
</span><span class=lnt id=hl-65-12><a class=lnlinks href=#hl-65-12>12</a>
</span><span class=lnt id=hl-65-13><a class=lnlinks href=#hl-65-13>13</a>
</span><span class=lnt id=hl-65-14><a class=lnlinks href=#hl-65-14>14</a>
</span><span class=lnt id=hl-65-15><a class=lnlinks href=#hl-65-15>15</a>
</span><span class=lnt id=hl-65-16><a class=lnlinks href=#hl-65-16>16</a>
</span><span class=lnt id=hl-65-17><a class=lnlinks href=#hl-65-17>17</a>
</span><span class=lnt id=hl-65-18><a class=lnlinks href=#hl-65-18>18</a>
</span><span class=lnt id=hl-65-19><a class=lnlinks href=#hl-65-19>19</a>
</span><span class=lnt id=hl-65-20><a class=lnlinks href=#hl-65-20>20</a>
</span><span class=lnt id=hl-65-21><a class=lnlinks href=#hl-65-21>21</a>
</span><span class=lnt id=hl-65-22><a class=lnlinks href=#hl-65-22>22</a>
</span><span class=lnt id=hl-65-23><a class=lnlinks href=#hl-65-23>23</a>
</span><span class=lnt id=hl-65-24><a class=lnlinks href=#hl-65-24>24</a>
</span><span class=lnt id=hl-65-25><a class=lnlinks href=#hl-65-25>25</a>
</span><span class=lnt id=hl-65-26><a class=lnlinks href=#hl-65-26>26</a>
</span><span class=lnt id=hl-65-27><a class=lnlinks href=#hl-65-27>27</a>
</span><span class=lnt id=hl-65-28><a class=lnlinks href=#hl-65-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 停止标记用 volatile 是为了保证该变量在多个线程之间的可见性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 我们的例子中，即主线程把它修改为 true 对 t1 线程可见</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>TPTVolatile</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>stop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>stop</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;料理后事&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;将结果保存&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 执行监控操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;监控线程&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>调用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-66-1><a class=lnlinks href=#hl-66-1>1</a>
</span><span class=lnt id=hl-66-2><a class=lnlinks href=#hl-66-2>2</a>
</span><span class=lnt id=hl-66-3><a class=lnlinks href=#hl-66-3>3</a>
</span><span class=lnt id=hl-66-4><a class=lnlinks href=#hl-66-4>4</a>
</span><span class=lnt id=hl-66-5><a class=lnlinks href=#hl-66-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TPTVolatile</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TPTVolatile</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>3500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;stop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-67-1><a class=lnlinks href=#hl-67-1>1</a>
</span><span class=lnt id=hl-67-2><a class=lnlinks href=#hl-67-2>2</a>
</span><span class=lnt id=hl-67-3><a class=lnlinks href=#hl-67-3>3</a>
</span><span class=lnt id=hl-67-4><a class=lnlinks href=#hl-67-4>4</a>
</span><span class=lnt id=hl-67-5><a class=lnlinks href=#hl-67-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:54:52.003 c.TPTVolatile <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:54:53.006 c.TPTVolatile <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:54:54.007 c.TPTVolatile <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:54:54.502 c.TestTwoPhaseTermination <span class=o>[</span>main<span class=o>]</span> - stop 
</span></span><span class=line><span class=cl>11:54:54.502 c.TPTVolatile <span class=o>[</span>监控线程<span class=o>]</span> - 料理后事
</span></span></code></pre></td></tr></table></div></div><h3 id=打断-park-线程><a href=#%e6%89%93%e6%96%ad-park-%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
打断 park 线程</h3><p>打断 park 线程, 不会清空打断状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-68-1><a class=lnlinks href=#hl-68-1> 1</a>
</span><span class=lnt id=hl-68-2><a class=lnlinks href=#hl-68-2> 2</a>
</span><span class=lnt id=hl-68-3><a class=lnlinks href=#hl-68-3> 3</a>
</span><span class=lnt id=hl-68-4><a class=lnlinks href=#hl-68-4> 4</a>
</span><span class=lnt id=hl-68-5><a class=lnlinks href=#hl-68-5> 5</a>
</span><span class=lnt id=hl-68-6><a class=lnlinks href=#hl-68-6> 6</a>
</span><span class=lnt id=hl-68-7><a class=lnlinks href=#hl-68-7> 7</a>
</span><span class=lnt id=hl-68-8><a class=lnlinks href=#hl-68-8> 8</a>
</span><span class=lnt id=hl-68-9><a class=lnlinks href=#hl-68-9> 9</a>
</span><span class=lnt id=hl-68-10><a class=lnlinks href=#hl-68-10>10</a>
</span><span class=lnt id=hl-68-11><a class=lnlinks href=#hl-68-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;park...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unpark...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;打断状态：{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>isInterrupted</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-69-1><a class=lnlinks href=#hl-69-1>1</a>
</span><span class=lnt id=hl-69-2><a class=lnlinks href=#hl-69-2>2</a>
</span><span class=lnt id=hl-69-3><a class=lnlinks href=#hl-69-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:11:52.795 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:11:53.295 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - unpark... 
</span></span><span class=line><span class=cl>21:11:53.295 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - 打断状态：true 
</span></span></code></pre></td></tr></table></div></div><p>如果打断标记已经是 true, 则 park 会失效</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-70-1><a class=lnlinks href=#hl-70-1> 1</a>
</span><span class=lnt id=hl-70-2><a class=lnlinks href=#hl-70-2> 2</a>
</span><span class=lnt id=hl-70-3><a class=lnlinks href=#hl-70-3> 3</a>
</span><span class=lnt id=hl-70-4><a class=lnlinks href=#hl-70-4> 4</a>
</span><span class=lnt id=hl-70-5><a class=lnlinks href=#hl-70-5> 5</a>
</span><span class=lnt id=hl-70-6><a class=lnlinks href=#hl-70-6> 6</a>
</span><span class=lnt id=hl-70-7><a class=lnlinks href=#hl-70-7> 7</a>
</span><span class=lnt id=hl-70-8><a class=lnlinks href=#hl-70-8> 8</a>
</span><span class=lnt id=hl-70-9><a class=lnlinks href=#hl-70-9> 9</a>
</span><span class=lnt id=hl-70-10><a class=lnlinks href=#hl-70-10>10</a>
</span><span class=lnt id=hl-70-11><a class=lnlinks href=#hl-70-11>11</a>
</span><span class=lnt id=hl-70-12><a class=lnlinks href=#hl-70-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test4</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;park...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;打断状态：{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>isInterrupted</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-71-1><a class=lnlinks href=#hl-71-1> 1</a>
</span><span class=lnt id=hl-71-2><a class=lnlinks href=#hl-71-2> 2</a>
</span><span class=lnt id=hl-71-3><a class=lnlinks href=#hl-71-3> 3</a>
</span><span class=lnt id=hl-71-4><a class=lnlinks href=#hl-71-4> 4</a>
</span><span class=lnt id=hl-71-5><a class=lnlinks href=#hl-71-5> 5</a>
</span><span class=lnt id=hl-71-6><a class=lnlinks href=#hl-71-6> 6</a>
</span><span class=lnt id=hl-71-7><a class=lnlinks href=#hl-71-7> 7</a>
</span><span class=lnt id=hl-71-8><a class=lnlinks href=#hl-71-8> 8</a>
</span><span class=lnt id=hl-71-9><a class=lnlinks href=#hl-71-9> 9</a>
</span><span class=lnt id=hl-71-10><a class=lnlinks href=#hl-71-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:13:48.783 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:13:49.809 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - 打断状态：true 
</span></span><span class=line><span class=cl>21:13:49.812 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - 打断状态：true 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - 打断状态：true 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - 打断状态：true 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - 打断状态：true 
</span></span></code></pre></td></tr></table></div></div><blockquote><p>提示</p><p>可以使用 Thread.interrupted() 清除打断状态</p></blockquote><h2 id=310-不推荐的方法><a href=#310-%e4%b8%8d%e6%8e%a8%e8%8d%90%e7%9a%84%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
3.10 不推荐的方法</h2><p>还有一些不推荐使用的方法，这些方法已过时，容易破坏同步代码块，造成线程死锁</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>方法名</th><th style=text-align:center>static</th><th style=text-align:center>功能说明</th></tr></thead><tbody><tr><td style=text-align:center>stop()</td><td style=text-align:center></td><td style=text-align:center>停止线程运行</td></tr><tr><td style=text-align:center>suspend()</td><td style=text-align:center></td><td style=text-align:center>挂起（暂停）线程运行</td></tr><tr><td style=text-align:center>resume()</td><td style=text-align:center></td><td style=text-align:center>恢复线程运行</td></tr></tbody></table></div><h2 id=311-主线程与守护线程><a href=#311-%e4%b8%bb%e7%ba%bf%e7%a8%8b%e4%b8%8e%e5%ae%88%e6%8a%a4%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
3.11 主线程与守护线程</h2><p>默认情况下，Java 进程需要等待所有线程都运行结束，才会结束。有一种特殊的线程叫做守护线程，只要其它非守护线程运行结束了，即使守护线程的代码没有执行完，也会强制结束。</p><p>例:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-72-1><a class=lnlinks href=#hl-72-1> 1</a>
</span><span class=lnt id=hl-72-2><a class=lnlinks href=#hl-72-2> 2</a>
</span><span class=lnt id=hl-72-3><a class=lnlinks href=#hl-72-3> 3</a>
</span><span class=lnt id=hl-72-4><a class=lnlinks href=#hl-72-4> 4</a>
</span><span class=lnt id=hl-72-5><a class=lnlinks href=#hl-72-5> 5</a>
</span><span class=lnt id=hl-72-6><a class=lnlinks href=#hl-72-6> 6</a>
</span><span class=lnt id=hl-72-7><a class=lnlinks href=#hl-72-7> 7</a>
</span><span class=lnt id=hl-72-8><a class=lnlinks href=#hl-72-8> 8</a>
</span><span class=lnt id=hl-72-9><a class=lnlinks href=#hl-72-9> 9</a>
</span><span class=lnt id=hl-72-10><a class=lnlinks href=#hl-72-10>10</a>
</span><span class=lnt id=hl-72-11><a class=lnlinks href=#hl-72-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始运行...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始运行...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;运行结束...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;daemon&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 设置该线程为守护线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>setDaemon</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;运行结束...&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-73-1><a class=lnlinks href=#hl-73-1>1</a>
</span><span class=lnt id=hl-73-2><a class=lnlinks href=#hl-73-2>2</a>
</span><span class=lnt id=hl-73-3><a class=lnlinks href=#hl-73-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>08:26:38.123 <span class=o>[</span>main<span class=o>]</span> c.TestDaemon - 开始运行... 
</span></span><span class=line><span class=cl>08:26:38.213 <span class=o>[</span>daemon<span class=o>]</span> c.TestDaemon - 开始运行... 
</span></span><span class=line><span class=cl>08:26:39.215 <span class=o>[</span>main<span class=o>]</span> c.TestDaemon - 运行结束... 
</span></span></code></pre></td></tr></table></div></div><blockquote><p>注意</p><ul><li>垃圾回收器线程就是一种守护线程</li><li>Tomcat 中的 Acceptor 和 Poller 线程都是守护线程，所以 Tomcat 接收到 shutdown 命令后，不会等待它们处理完当前请求</li></ul></blockquote><h2 id=312-五种状态><a href=#312-%e4%ba%94%e7%a7%8d%e7%8a%b6%e6%80%81 class=header-anchor>#</a>
3.12 五种状态</h2><p>这是从 <strong>操作系统</strong> 层面来描述的</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220224174907408.png width=900 height=600 loading=lazy decoding=async alt=image-20220224174907408 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>【初始状态】仅是在语言层面创建了线程对象，还未与操作系统线程关联</li><li>【可运行状态】（就绪状态）指该线程已经被创建（与操作系统线程关联），可以由 CPU 调度执行</li><li>【运行状态】指获取了 CPU 时间片运行中的状态<ul><li>当 CPU 时间片用完，会从【运行状态】转换至【可运行状态】，会导致线程的上下文切换</li></ul></li><li>【阻塞状态】<ul><li>如果调用了阻塞 API，如 BIO 读写文件，这时该线程实际不会用到 CPU，会导致线程上下文切换，进入 【阻塞状态】</li><li>等 BIO 操作完毕，会由操作系统唤醒阻塞的线程，转换至【可运行状态】</li><li>与【可运行状态】的区别是，对【阻塞状态】的线程来说只要它们一直不唤醒，调度器就一直不会考虑 调度它们</li></ul></li><li>【终止状态】表示线程已经执行完毕，生命周期已经结束，不会再转换为其它状态</li></ul><h2 id=313-六种状态><a href=#313-%e5%85%ad%e7%a7%8d%e7%8a%b6%e6%80%81 class=header-anchor>#</a>
3.13 六种状态</h2><p>这是从 <strong>Java API</strong> 层面来描述的</p><p>根据 Thread.State 枚举，分为六种状态</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220224175139037.png width=900 height=600 loading=lazy decoding=async alt=image-20220224175139037 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>NEW 线程刚被创建，但是还没有调用 start() 方法</li><li>RUNNABLE 当调用了 start() 方法之后，注意，Java API 层面的 RUNNABLE 状态涵盖了 操作系统 层面的 【可运行状态】、【运行状态】和【阻塞状态】（由于 BIO 导致的线程阻塞，在 Java 里无法区分，仍然认为 是可运行）</li><li>BLOCKED ， WAITING ， TIMED_WAITING 都是 Java API 层面对【阻塞状态】的细分，后面会在状态转换一节 详述</li><li>TERMINATED 当线程代码运行结束</li></ul><h2 id=314-习题><a href=#314-%e4%b9%a0%e9%a2%98 class=header-anchor>#</a>
3.14 习题</h2><p>阅读华罗庚《统筹方法》，给出烧水泡茶的多线程解决方案，提示</p><ul><li>参考图二，用两个线程（两个人协作）模拟烧水泡茶过程<ul><li>文中办法乙、丙都相当于任务串行</li><li>而图一相当于启动了 4 个线程，有点浪费</li></ul></li><li>用 sleep(n) 模拟洗茶壶、洗水壶等耗费的时间</li></ul><h3 id=textcolorgreen-应用之统筹烧水泡茶><a href=#textcolorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e7%bb%9f%e7%ad%b9%e7%83%a7%e6%b0%b4%e6%b3%a1%e8%8c%b6 class=header-anchor>#</a>
$\textcolor{green}{* 应用之统筹（烧水泡茶）}$</h3><h4 id=解法1join><a href=#%e8%a7%a3%e6%b3%951join class=header-anchor>#</a>
解法1：join</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-74-1><a class=lnlinks href=#hl-74-1> 1</a>
</span><span class=lnt id=hl-74-2><a class=lnlinks href=#hl-74-2> 2</a>
</span><span class=lnt id=hl-74-3><a class=lnlinks href=#hl-74-3> 3</a>
</span><span class=lnt id=hl-74-4><a class=lnlinks href=#hl-74-4> 4</a>
</span><span class=lnt id=hl-74-5><a class=lnlinks href=#hl-74-5> 5</a>
</span><span class=lnt id=hl-74-6><a class=lnlinks href=#hl-74-6> 6</a>
</span><span class=lnt id=hl-74-7><a class=lnlinks href=#hl-74-7> 7</a>
</span><span class=lnt id=hl-74-8><a class=lnlinks href=#hl-74-8> 8</a>
</span><span class=lnt id=hl-74-9><a class=lnlinks href=#hl-74-9> 9</a>
</span><span class=lnt id=hl-74-10><a class=lnlinks href=#hl-74-10>10</a>
</span><span class=lnt id=hl-74-11><a class=lnlinks href=#hl-74-11>11</a>
</span><span class=lnt id=hl-74-12><a class=lnlinks href=#hl-74-12>12</a>
</span><span class=lnt id=hl-74-13><a class=lnlinks href=#hl-74-13>13</a>
</span><span class=lnt id=hl-74-14><a class=lnlinks href=#hl-74-14>14</a>
</span><span class=lnt id=hl-74-15><a class=lnlinks href=#hl-74-15>15</a>
</span><span class=lnt id=hl-74-16><a class=lnlinks href=#hl-74-16>16</a>
</span><span class=lnt id=hl-74-17><a class=lnlinks href=#hl-74-17>17</a>
</span><span class=lnt id=hl-74-18><a class=lnlinks href=#hl-74-18>18</a>
</span><span class=lnt id=hl-74-19><a class=lnlinks href=#hl-74-19>19</a>
</span><span class=lnt id=hl-74-20><a class=lnlinks href=#hl-74-20>20</a>
</span><span class=lnt id=hl-74-21><a class=lnlinks href=#hl-74-21>21</a>
</span><span class=lnt id=hl-74-22><a class=lnlinks href=#hl-74-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;洗水壶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;烧开水&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>15</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;老王&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;洗茶壶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;洗茶杯&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;拿茶叶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;泡茶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;小王&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-75-1><a class=lnlinks href=#hl-75-1>1</a>
</span><span class=lnt id=hl-75-2><a class=lnlinks href=#hl-75-2>2</a>
</span><span class=lnt id=hl-75-3><a class=lnlinks href=#hl-75-3>3</a>
</span><span class=lnt id=hl-75-4><a class=lnlinks href=#hl-75-4>4</a>
</span><span class=lnt id=hl-75-5><a class=lnlinks href=#hl-75-5>5</a>
</span><span class=lnt id=hl-75-6><a class=lnlinks href=#hl-75-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:19:37.547 <span class=o>[</span>小王<span class=o>]</span> c.TestMakeTea - 洗茶壶
</span></span><span class=line><span class=cl>19:19:37.547 <span class=o>[</span>老王<span class=o>]</span> c.TestMakeTea - 洗水壶
</span></span><span class=line><span class=cl>19:19:38.552 <span class=o>[</span>小王<span class=o>]</span> c.TestMakeTea - 洗茶杯
</span></span><span class=line><span class=cl>19:19:38.552 <span class=o>[</span>老王<span class=o>]</span> c.TestMakeTea - 烧开水
</span></span><span class=line><span class=cl>19:19:40.553 <span class=o>[</span>小王<span class=o>]</span> c.TestMakeTea - 拿茶叶
</span></span><span class=line><span class=cl>19:19:53.553 <span class=o>[</span>小王<span class=o>]</span> c.TestMakeTea - 泡茶
</span></span></code></pre></td></tr></table></div></div><p>解法1 的缺陷：</p><ul><li>上面模拟的是小王等老王的水烧开了，小王泡茶，如果反过来要实现老王等小王的茶叶拿来了，老王泡茶 呢？代码最好能适应两种情况</li><li>上面的两个线程其实是各执行各的，如果要模拟老王把水壶交给小王泡茶，或模拟小王把茶叶交给老王泡茶 呢</li></ul><h4 id=解法2waitnotify><a href=#%e8%a7%a3%e6%b3%952waitnotify class=header-anchor>#</a>
解法2：wait/notify</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-76-1><a class=lnlinks href=#hl-76-1> 1</a>
</span><span class=lnt id=hl-76-2><a class=lnlinks href=#hl-76-2> 2</a>
</span><span class=lnt id=hl-76-3><a class=lnlinks href=#hl-76-3> 3</a>
</span><span class=lnt id=hl-76-4><a class=lnlinks href=#hl-76-4> 4</a>
</span><span class=lnt id=hl-76-5><a class=lnlinks href=#hl-76-5> 5</a>
</span><span class=lnt id=hl-76-6><a class=lnlinks href=#hl-76-6> 6</a>
</span><span class=lnt id=hl-76-7><a class=lnlinks href=#hl-76-7> 7</a>
</span><span class=lnt id=hl-76-8><a class=lnlinks href=#hl-76-8> 8</a>
</span><span class=lnt id=hl-76-9><a class=lnlinks href=#hl-76-9> 9</a>
</span><span class=lnt id=hl-76-10><a class=lnlinks href=#hl-76-10>10</a>
</span><span class=lnt id=hl-76-11><a class=lnlinks href=#hl-76-11>11</a>
</span><span class=lnt id=hl-76-12><a class=lnlinks href=#hl-76-12>12</a>
</span><span class=lnt id=hl-76-13><a class=lnlinks href=#hl-76-13>13</a>
</span><span class=lnt id=hl-76-14><a class=lnlinks href=#hl-76-14>14</a>
</span><span class=lnt id=hl-76-15><a class=lnlinks href=#hl-76-15>15</a>
</span><span class=lnt id=hl-76-16><a class=lnlinks href=#hl-76-16>16</a>
</span><span class=lnt id=hl-76-17><a class=lnlinks href=#hl-76-17>17</a>
</span><span class=lnt id=hl-76-18><a class=lnlinks href=#hl-76-18>18</a>
</span><span class=lnt id=hl-76-19><a class=lnlinks href=#hl-76-19>19</a>
</span><span class=lnt id=hl-76-20><a class=lnlinks href=#hl-76-20>20</a>
</span><span class=lnt id=hl-76-21><a class=lnlinks href=#hl-76-21>21</a>
</span><span class=lnt id=hl-76-22><a class=lnlinks href=#hl-76-22>22</a>
</span><span class=lnt id=hl-76-23><a class=lnlinks href=#hl-76-23>23</a>
</span><span class=lnt id=hl-76-24><a class=lnlinks href=#hl-76-24>24</a>
</span><span class=lnt id=hl-76-25><a class=lnlinks href=#hl-76-25>25</a>
</span><span class=lnt id=hl-76-26><a class=lnlinks href=#hl-76-26>26</a>
</span><span class=lnt id=hl-76-27><a class=lnlinks href=#hl-76-27>27</a>
</span><span class=lnt id=hl-76-28><a class=lnlinks href=#hl-76-28>28</a>
</span><span class=lnt id=hl-76-29><a class=lnlinks href=#hl-76-29>29</a>
</span><span class=lnt id=hl-76-30><a class=lnlinks href=#hl-76-30>30</a>
</span><span class=lnt id=hl-76-31><a class=lnlinks href=#hl-76-31>31</a>
</span><span class=lnt id=hl-76-32><a class=lnlinks href=#hl-76-32>32</a>
</span><span class=lnt id=hl-76-33><a class=lnlinks href=#hl-76-33>33</a>
</span><span class=lnt id=hl-76-34><a class=lnlinks href=#hl-76-34>34</a>
</span><span class=lnt id=hl-76-35><a class=lnlinks href=#hl-76-35>35</a>
</span><span class=lnt id=hl-76-36><a class=lnlinks href=#hl-76-36>36</a>
</span><span class=lnt id=hl-76-37><a class=lnlinks href=#hl-76-37>37</a>
</span><span class=lnt id=hl-76-38><a class=lnlinks href=#hl-76-38>38</a>
</span><span class=lnt id=hl-76-39><a class=lnlinks href=#hl-76-39>39</a>
</span><span class=lnt id=hl-76-40><a class=lnlinks href=#hl-76-40>40</a>
</span><span class=lnt id=hl-76-41><a class=lnlinks href=#hl-76-41>41</a>
</span><span class=lnt id=hl-76-42><a class=lnlinks href=#hl-76-42>42</a>
</span><span class=lnt id=hl-76-43><a class=lnlinks href=#hl-76-43>43</a>
</span><span class=lnt id=hl-76-44><a class=lnlinks href=#hl-76-44>44</a>
</span><span class=lnt id=hl-76-45><a class=lnlinks href=#hl-76-45>45</a>
</span><span class=lnt id=hl-76-46><a class=lnlinks href=#hl-76-46>46</a>
</span><span class=lnt id=hl-76-47><a class=lnlinks href=#hl-76-47>47</a>
</span><span class=lnt id=hl-76-48><a class=lnlinks href=#hl-76-48>48</a>
</span><span class=lnt id=hl-76-49><a class=lnlinks href=#hl-76-49>49</a>
</span><span class=lnt id=hl-76-50><a class=lnlinks href=#hl-76-50>50</a>
</span><span class=lnt id=hl-76-51><a class=lnlinks href=#hl-76-51>51</a>
</span><span class=lnt id=hl-76-52><a class=lnlinks href=#hl-76-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>S2</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>kettle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;冷水&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>tea</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>maked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>makeTea</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;洗水壶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;烧开水&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>kettle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;开水&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>tea</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>maked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;拿({})泡({})&#34;</span><span class=p>,</span><span class=w> </span><span class=n>kettle</span><span class=p>,</span><span class=w> </span><span class=n>tea</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>maked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;老王&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;洗茶壶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;洗茶杯&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;拿茶叶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>tea</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;花茶&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>kettle</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;冷水&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>maked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;拿({})泡({})&#34;</span><span class=p>,</span><span class=w> </span><span class=n>kettle</span><span class=p>,</span><span class=w> </span><span class=n>tea</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>maked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;小王&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-77-1><a class=lnlinks href=#hl-77-1>1</a>
</span><span class=lnt id=hl-77-2><a class=lnlinks href=#hl-77-2>2</a>
</span><span class=lnt id=hl-77-3><a class=lnlinks href=#hl-77-3>3</a>
</span><span class=lnt id=hl-77-4><a class=lnlinks href=#hl-77-4>4</a>
</span><span class=lnt id=hl-77-5><a class=lnlinks href=#hl-77-5>5</a>
</span><span class=lnt id=hl-77-6><a class=lnlinks href=#hl-77-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>48</span><span class=p>.</span><span class=na>179</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>小王</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>洗茶壶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>48</span><span class=p>.</span><span class=na>179</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>老王</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>洗水壶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>49</span><span class=p>.</span><span class=na>185</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>老王</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>烧开水</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>49</span><span class=p>.</span><span class=na>185</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>小王</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>洗茶杯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>51</span><span class=p>.</span><span class=na>185</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>小王</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>拿茶叶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>54</span><span class=p>.</span><span class=na>185</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>老王</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>拿</span><span class=p>(</span><span class=n>开水</span><span class=p>)</span><span class=n>泡</span><span class=p>(</span><span class=n>花茶</span><span class=p>)</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>解法2 解决了解法1 的问题，不过老王和小王需要相互等待，不如他们只负责各自的任务，泡茶交给第三人来做</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-78-1><a class=lnlinks href=#hl-78-1> 1</a>
</span><span class=lnt id=hl-78-2><a class=lnlinks href=#hl-78-2> 2</a>
</span><span class=lnt id=hl-78-3><a class=lnlinks href=#hl-78-3> 3</a>
</span><span class=lnt id=hl-78-4><a class=lnlinks href=#hl-78-4> 4</a>
</span><span class=lnt id=hl-78-5><a class=lnlinks href=#hl-78-5> 5</a>
</span><span class=lnt id=hl-78-6><a class=lnlinks href=#hl-78-6> 6</a>
</span><span class=lnt id=hl-78-7><a class=lnlinks href=#hl-78-7> 7</a>
</span><span class=lnt id=hl-78-8><a class=lnlinks href=#hl-78-8> 8</a>
</span><span class=lnt id=hl-78-9><a class=lnlinks href=#hl-78-9> 9</a>
</span><span class=lnt id=hl-78-10><a class=lnlinks href=#hl-78-10>10</a>
</span><span class=lnt id=hl-78-11><a class=lnlinks href=#hl-78-11>11</a>
</span><span class=lnt id=hl-78-12><a class=lnlinks href=#hl-78-12>12</a>
</span><span class=lnt id=hl-78-13><a class=lnlinks href=#hl-78-13>13</a>
</span><span class=lnt id=hl-78-14><a class=lnlinks href=#hl-78-14>14</a>
</span><span class=lnt id=hl-78-15><a class=lnlinks href=#hl-78-15>15</a>
</span><span class=lnt id=hl-78-16><a class=lnlinks href=#hl-78-16>16</a>
</span><span class=lnt id=hl-78-17><a class=lnlinks href=#hl-78-17>17</a>
</span><span class=lnt id=hl-78-18><a class=lnlinks href=#hl-78-18>18</a>
</span><span class=lnt id=hl-78-19><a class=lnlinks href=#hl-78-19>19</a>
</span><span class=lnt id=hl-78-20><a class=lnlinks href=#hl-78-20>20</a>
</span><span class=lnt id=hl-78-21><a class=lnlinks href=#hl-78-21>21</a>
</span><span class=lnt id=hl-78-22><a class=lnlinks href=#hl-78-22>22</a>
</span><span class=lnt id=hl-78-23><a class=lnlinks href=#hl-78-23>23</a>
</span><span class=lnt id=hl-78-24><a class=lnlinks href=#hl-78-24>24</a>
</span><span class=lnt id=hl-78-25><a class=lnlinks href=#hl-78-25>25</a>
</span><span class=lnt id=hl-78-26><a class=lnlinks href=#hl-78-26>26</a>
</span><span class=lnt id=hl-78-27><a class=lnlinks href=#hl-78-27>27</a>
</span><span class=lnt id=hl-78-28><a class=lnlinks href=#hl-78-28>28</a>
</span><span class=lnt id=hl-78-29><a class=lnlinks href=#hl-78-29>29</a>
</span><span class=lnt id=hl-78-30><a class=lnlinks href=#hl-78-30>30</a>
</span><span class=lnt id=hl-78-31><a class=lnlinks href=#hl-78-31>31</a>
</span><span class=lnt id=hl-78-32><a class=lnlinks href=#hl-78-32>32</a>
</span><span class=lnt id=hl-78-33><a class=lnlinks href=#hl-78-33>33</a>
</span><span class=lnt id=hl-78-34><a class=lnlinks href=#hl-78-34>34</a>
</span><span class=lnt id=hl-78-35><a class=lnlinks href=#hl-78-35>35</a>
</span><span class=lnt id=hl-78-36><a class=lnlinks href=#hl-78-36>36</a>
</span><span class=lnt id=hl-78-37><a class=lnlinks href=#hl-78-37>37</a>
</span><span class=lnt id=hl-78-38><a class=lnlinks href=#hl-78-38>38</a>
</span><span class=lnt id=hl-78-39><a class=lnlinks href=#hl-78-39>39</a>
</span><span class=lnt id=hl-78-40><a class=lnlinks href=#hl-78-40>40</a>
</span><span class=lnt id=hl-78-41><a class=lnlinks href=#hl-78-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>S3</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>kettle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;冷水&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>tea</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>makeTea</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;洗水壶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;烧开水&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>kettle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;开水&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;老王&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;洗茶壶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;洗茶杯&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;拿茶叶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>tea</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;花茶&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;小王&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>kettle</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;冷水&#34;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>tea</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;拿({})泡({})&#34;</span><span class=p>,</span><span class=w> </span><span class=n>kettle</span><span class=p>,</span><span class=w> </span><span class=n>tea</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;王夫人&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-79-1><a class=lnlinks href=#hl-79-1>1</a>
</span><span class=lnt id=hl-79-2><a class=lnlinks href=#hl-79-2>2</a>
</span><span class=lnt id=hl-79-3><a class=lnlinks href=#hl-79-3>3</a>
</span><span class=lnt id=hl-79-4><a class=lnlinks href=#hl-79-4>4</a>
</span><span class=lnt id=hl-79-5><a class=lnlinks href=#hl-79-5>5</a>
</span><span class=lnt id=hl-79-6><a class=lnlinks href=#hl-79-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:13:18.202 c.S3 <span class=o>[</span>小王<span class=o>]</span> - 洗茶壶
</span></span><span class=line><span class=cl>20:13:18.202 c.S3 <span class=o>[</span>老王<span class=o>]</span> - 洗水壶
</span></span><span class=line><span class=cl>20:13:19.206 c.S3 <span class=o>[</span>小王<span class=o>]</span> - 洗茶杯
</span></span><span class=line><span class=cl>20:13:19.206 c.S3 <span class=o>[</span>老王<span class=o>]</span> - 烧开水
</span></span><span class=line><span class=cl>20:13:21.206 c.S3 <span class=o>[</span>小王<span class=o>]</span> - 拿茶叶
</span></span><span class=line><span class=cl>20:13:24.207 c.S3 <span class=o>[</span>王夫人<span class=o>]</span> - 拿<span class=o>(</span>开水<span class=o>)</span>泡<span class=o>(</span>花茶<span class=o>)</span> 
</span></span></code></pre></td></tr></table></div></div><h4 id=解法3第三者协调><a href=#%e8%a7%a3%e6%b3%953%e7%ac%ac%e4%b8%89%e8%80%85%e5%8d%8f%e8%b0%83 class=header-anchor>#</a>
解法3：第三者协调</h4><h2 id=本章小结><a href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93 class=header-anchor>#</a>
本章小结</h2><p>本章的重点在于掌握</p><ul><li>线程创建</li><li>线程重要 api，如 start，run，sleep，join，interrupt 等</li><li>线程状态</li><li>应用方面<ul><li>异步调用：主线程执行期间，其它线程异步执行耗时操作</li><li>提高效率：并行计算，缩短运算时间</li><li>同步等待：join</li><li>统筹规划：合理使用线程，得到最优效果</li></ul></li><li>原理方面<ul><li>线程运行流程：栈、栈帧、上下文切换、程序计数器</li><li>Thread 两种创建方式 的源码</li></ul></li><li>模式方面<ul><li>终止模式之两阶段终止</li></ul></li></ul><h1 id=4共享模型之管程><a href=#4%e5%85%b1%e4%ba%ab%e6%a8%a1%e5%9e%8b%e4%b9%8b%e7%ae%a1%e7%a8%8b class=header-anchor>#</a>
4.共享模型之管程</h1><h2 id=41共享带来的问题><a href=#41%e5%85%b1%e4%ba%ab%e5%b8%a6%e6%9d%a5%e7%9a%84%e9%97%ae%e9%a2%98 class=header-anchor>#</a>
4.1共享带来的问题</h2><h5 id=java代码示例><a href=#java%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b class=header-anchor>#</a>
<strong>Java代码示例</strong></h5><p>两个线程对初始值为 0 的静态变量一个做自增，一个做自减，各做 5000 次，结果是 0 吗？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-80-1><a class=lnlinks href=#hl-80-1> 1</a>
</span><span class=lnt id=hl-80-2><a class=lnlinks href=#hl-80-2> 2</a>
</span><span class=lnt id=hl-80-3><a class=lnlinks href=#hl-80-3> 3</a>
</span><span class=lnt id=hl-80-4><a class=lnlinks href=#hl-80-4> 4</a>
</span><span class=lnt id=hl-80-5><a class=lnlinks href=#hl-80-5> 5</a>
</span><span class=lnt id=hl-80-6><a class=lnlinks href=#hl-80-6> 6</a>
</span><span class=lnt id=hl-80-7><a class=lnlinks href=#hl-80-7> 7</a>
</span><span class=lnt id=hl-80-8><a class=lnlinks href=#hl-80-8> 8</a>
</span><span class=lnt id=hl-80-9><a class=lnlinks href=#hl-80-9> 9</a>
</span><span class=lnt id=hl-80-10><a class=lnlinks href=#hl-80-10>10</a>
</span><span class=lnt id=hl-80-11><a class=lnlinks href=#hl-80-11>11</a>
</span><span class=lnt id=hl-80-12><a class=lnlinks href=#hl-80-12>12</a>
</span><span class=lnt id=hl-80-13><a class=lnlinks href=#hl-80-13>13</a>
</span><span class=lnt id=hl-80-14><a class=lnlinks href=#hl-80-14>14</a>
</span><span class=lnt id=hl-80-15><a class=lnlinks href=#hl-80-15>15</a>
</span><span class=lnt id=hl-80-16><a class=lnlinks href=#hl-80-16>16</a>
</span><span class=lnt id=hl-80-17><a class=lnlinks href=#hl-80-17>17</a>
</span><span class=lnt id=hl-80-18><a class=lnlinks href=#hl-80-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>counter</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>counter</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=n>counter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=问题分析><a href=#%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90 class=header-anchor>#</a>
<strong>问题分析</strong></h5><p>以上的结果可能是正数、负数、零。为什么呢？因为 Java 中对静态变量的自增，自减并不是原子操作，要彻底理解，必须从字节码来进行分析</p><p>例如对于 i++ 而言（i 为静态变量），实际会产生如下的 JVM 字节码指令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-81-1><a class=lnlinks href=#hl-81-1>1</a>
</span><span class=lnt id=hl-81-2><a class=lnlinks href=#hl-81-2>2</a>
</span><span class=lnt id=hl-81-3><a class=lnlinks href=#hl-81-3>3</a>
</span><span class=lnt id=hl-81-4><a class=lnlinks href=#hl-81-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>getstatic</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=c1>// 获取静态变量i的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>iconst_1</span><span class=w> </span><span class=c1>// 准备常量1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>iadd</span><span class=w> </span><span class=c1>// 自增</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>putstatic</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=c1>// 将修改后的值存入静态变量i</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>而对应 i&ndash; 也是类似：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-82-1><a class=lnlinks href=#hl-82-1>1</a>
</span><span class=lnt id=hl-82-2><a class=lnlinks href=#hl-82-2>2</a>
</span><span class=lnt id=hl-82-3><a class=lnlinks href=#hl-82-3>3</a>
</span><span class=lnt id=hl-82-4><a class=lnlinks href=#hl-82-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>getstatic</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=c1>// 获取静态变量i的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>iconst_1</span><span class=w> </span><span class=c1>// 准备常量1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>isub</span><span class=w> </span><span class=c1>// 自减</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>putstatic</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=c1>// 将修改后的值存入静态变量i</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>而 Java 的内存模型如下，完成静态变量的自增，自减需要在主存和工作内存中进行数据交换：</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220302204023824.png width=900 height=600 loading=lazy decoding=async alt=image-20220302204023824 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>如果是单线程以上 8 行代码是顺序执行（不会交错）没有问题：</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220302204044489.png width=900 height=600 loading=lazy decoding=async alt=image-20220302204044489 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>但多线程下这 8 行代码可能交错运行： 出现负数的情况：</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220302204119062.png width=900 height=600 loading=lazy decoding=async alt=image-20220302204119062 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>出现正数的情况：</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220302204145687.png width=900 height=600 loading=lazy decoding=async alt=image-20220302204145687 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=临界区-critical-section><a href=#%e4%b8%b4%e7%95%8c%e5%8c%ba-critical-section class=header-anchor>#</a>
<strong>临界区 Critical Section</strong></h5><ul><li><p>一个程序运行多个线程本身是没有问题的</p></li><li><p>问题出在多个线程访问<strong>共享资源</strong></p><ul><li><p>多个线程读<strong>共享资源</strong>其实也没有问题</p></li><li><p>在多个线程对<strong>共享资源</strong>读写操作时发生指令交错，就会出现问题</p></li></ul></li><li><p>一段代码块内如果存在对共享资源的多线程读写操作，称这段代码块为<strong>临界区</strong></p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-83-1><a class=lnlinks href=#hl-83-1> 1</a>
</span><span class=lnt id=hl-83-2><a class=lnlinks href=#hl-83-2> 2</a>
</span><span class=lnt id=hl-83-3><a class=lnlinks href=#hl-83-3> 3</a>
</span><span class=lnt id=hl-83-4><a class=lnlinks href=#hl-83-4> 4</a>
</span><span class=lnt id=hl-83-5><a class=lnlinks href=#hl-83-5> 5</a>
</span><span class=lnt id=hl-83-6><a class=lnlinks href=#hl-83-6> 6</a>
</span><span class=lnt id=hl-83-7><a class=lnlinks href=#hl-83-7> 7</a>
</span><span class=lnt id=hl-83-8><a class=lnlinks href=#hl-83-8> 8</a>
</span><span class=lnt id=hl-83-9><a class=lnlinks href=#hl-83-9> 9</a>
</span><span class=lnt id=hl-83-10><a class=lnlinks href=#hl-83-10>10</a>
</span><span class=lnt id=hl-83-11><a class=lnlinks href=#hl-83-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>increment</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 临界区</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decrement</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 临界区</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=竞态条件-race-condition><a href=#%e7%ab%9e%e6%80%81%e6%9d%a1%e4%bb%b6-race-condition class=header-anchor>#</a>
<strong>竞态条件 Race Condition</strong></h5><p>多个线程在临界区内执行，由于代码的<strong>执行序列不同</strong>而导致结果无法预测，称之为发生了<strong>竞态条件</strong></p><h2 id=42-synchronized-解决方案><a href=#42-synchronized-%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 class=header-anchor>#</a>
4.2 synchronized 解决方案</h2><h5 id=textcolorgreen应用之互斥><a href=#textcolorgreen%e5%ba%94%e7%94%a8%e4%b9%8b%e4%ba%92%e6%96%a5 class=header-anchor>#</a>
*<em>$\textcolor{green}{<em>应用之互斥}$</em></em></h5><p>为了避免临界区的竞态条件发生，有多种手段可以达到目的。</p><ul><li>阻塞式的解决方案：synchronized，Lock</li><li>非阻塞式的解决方案：原子变量</li></ul><p>本次课使用阻塞式的解决方案：synchronized，来解决上述问题，即俗称的【对象锁】，它采用互斥的方式让同一 时刻至多只有一个线程能持有【对象锁】，其它线程再想获取这个【对象锁】时就会阻塞住。这样就能保证拥有锁 的线程可以安全的执行临界区内的代码，不用担心线程上下文切换</p><blockquote><p><strong>注意</strong></p><p>虽然 java 中互斥和同步都可以采用 synchronized 关键字来完成，但它们还是有区别的：</p><ul><li>互斥是保证临界区的竞态条件发生，同一时刻只能有一个线程执行临界区代码</li><li>同步是由于线程执行的先后、顺序不同、需要一个线程等待其它线程运行到某个点</li></ul></blockquote><h5 id=synchronized><a href=#synchronized class=header-anchor>#</a>
<strong>synchronized</strong></h5><p>语法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-84-1><a class=lnlinks href=#hl-84-1>1</a>
</span><span class=lnt id=hl-84-2><a class=lnlinks href=#hl-84-2>2</a>
</span><span class=lnt id=hl-84-3><a class=lnlinks href=#hl-84-3>3</a>
</span><span class=lnt id=hl-84-4><a class=lnlinks href=#hl-84-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>synchronized</span><span class=p>(</span><span class=n>对象</span><span class=p>)</span><span class=w> </span><span class=c1>// 线程1， 线程2(blocked)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>临界区</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>解决</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-85-1><a class=lnlinks href=#hl-85-1> 1</a>
</span><span class=lnt id=hl-85-2><a class=lnlinks href=#hl-85-2> 2</a>
</span><span class=lnt id=hl-85-3><a class=lnlinks href=#hl-85-3> 3</a>
</span><span class=lnt id=hl-85-4><a class=lnlinks href=#hl-85-4> 4</a>
</span><span class=lnt id=hl-85-5><a class=lnlinks href=#hl-85-5> 5</a>
</span><span class=lnt id=hl-85-6><a class=lnlinks href=#hl-85-6> 6</a>
</span><span class=lnt id=hl-85-7><a class=lnlinks href=#hl-85-7> 7</a>
</span><span class=lnt id=hl-85-8><a class=lnlinks href=#hl-85-8> 8</a>
</span><span class=lnt id=hl-85-9><a class=lnlinks href=#hl-85-9> 9</a>
</span><span class=lnt id=hl-85-10><a class=lnlinks href=#hl-85-10>10</a>
</span><span class=lnt id=hl-85-11><a class=lnlinks href=#hl-85-11>11</a>
</span><span class=lnt id=hl-85-12><a class=lnlinks href=#hl-85-12>12</a>
</span><span class=lnt id=hl-85-13><a class=lnlinks href=#hl-85-13>13</a>
</span><span class=lnt id=hl-85-14><a class=lnlinks href=#hl-85-14>14</a>
</span><span class=lnt id=hl-85-15><a class=lnlinks href=#hl-85-15>15</a>
</span><span class=lnt id=hl-85-16><a class=lnlinks href=#hl-85-16>16</a>
</span><span class=lnt id=hl-85-17><a class=lnlinks href=#hl-85-17>17</a>
</span><span class=lnt id=hl-85-18><a class=lnlinks href=#hl-85-18>18</a>
</span><span class=lnt id=hl-85-19><a class=lnlinks href=#hl-85-19>19</a>
</span><span class=lnt id=hl-85-20><a class=lnlinks href=#hl-85-20>20</a>
</span><span class=lnt id=hl-85-21><a class=lnlinks href=#hl-85-21>21</a>
</span><span class=lnt id=hl-85-22><a class=lnlinks href=#hl-85-22>22</a>
</span><span class=lnt id=hl-85-23><a class=lnlinks href=#hl-85-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>room</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>counter</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>counter</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=n>counter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>图示流程</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220303001048763.png width=900 height=600 loading=lazy decoding=async alt=image-20220303001048763 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>思考</strong></p><p>synchronized 实际是用对象锁保证了临界区内代码的原子性，临界区内的代码对外是不可分割的，不会被线程切 换所打断。</p><p>为了加深理解，请思考下面的问题</p><ul><li>如果把 synchronized(obj) 放在 for 循环的外面，如何理解？&ndash; 原子性</li><li>如果 t1 synchronized(obj1) 而 t2 synchronized(obj2) 会怎样运作？&ndash; 锁对象</li><li>如果 t1 synchronized(obj) 而 t2 没有加会怎么样？如何理解？&ndash; 锁对象</li></ul><h5 id=面向对象改进><a href=#%e9%9d%a2%e5%90%91%e5%af%b9%e8%b1%a1%e6%94%b9%e8%bf%9b class=header-anchor>#</a>
<strong>面向对象改进</strong></h5><p>把需要保护的共享变量放入一个类</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-86-1><a class=lnlinks href=#hl-86-1> 1</a>
</span><span class=lnt id=hl-86-2><a class=lnlinks href=#hl-86-2> 2</a>
</span><span class=lnt id=hl-86-3><a class=lnlinks href=#hl-86-3> 3</a>
</span><span class=lnt id=hl-86-4><a class=lnlinks href=#hl-86-4> 4</a>
</span><span class=lnt id=hl-86-5><a class=lnlinks href=#hl-86-5> 5</a>
</span><span class=lnt id=hl-86-6><a class=lnlinks href=#hl-86-6> 6</a>
</span><span class=lnt id=hl-86-7><a class=lnlinks href=#hl-86-7> 7</a>
</span><span class=lnt id=hl-86-8><a class=lnlinks href=#hl-86-8> 8</a>
</span><span class=lnt id=hl-86-9><a class=lnlinks href=#hl-86-9> 9</a>
</span><span class=lnt id=hl-86-10><a class=lnlinks href=#hl-86-10>10</a>
</span><span class=lnt id=hl-86-11><a class=lnlinks href=#hl-86-11>11</a>
</span><span class=lnt id=hl-86-12><a class=lnlinks href=#hl-86-12>12</a>
</span><span class=lnt id=hl-86-13><a class=lnlinks href=#hl-86-13>13</a>
</span><span class=lnt id=hl-86-14><a class=lnlinks href=#hl-86-14>14</a>
</span><span class=lnt id=hl-86-15><a class=lnlinks href=#hl-86-15>15</a>
</span><span class=lnt id=hl-86-16><a class=lnlinks href=#hl-86-16>16</a>
</span><span class=lnt id=hl-86-17><a class=lnlinks href=#hl-86-17>17</a>
</span><span class=lnt id=hl-86-18><a class=lnlinks href=#hl-86-18>18</a>
</span><span class=lnt id=hl-86-19><a class=lnlinks href=#hl-86-19>19</a>
</span><span class=lnt id=hl-86-20><a class=lnlinks href=#hl-86-20>20</a>
</span><span class=lnt id=hl-86-21><a class=lnlinks href=#hl-86-21>21</a>
</span><span class=lnt id=hl-86-22><a class=lnlinks href=#hl-86-22>22</a>
</span><span class=lnt id=hl-86-23><a class=lnlinks href=#hl-86-23>23</a>
</span><span class=lnt id=hl-86-24><a class=lnlinks href=#hl-86-24>24</a>
</span><span class=lnt id=hl-86-25><a class=lnlinks href=#hl-86-25>25</a>
</span><span class=lnt id=hl-86-26><a class=lnlinks href=#hl-86-26>26</a>
</span><span class=lnt id=hl-86-27><a class=lnlinks href=#hl-86-27>27</a>
</span><span class=lnt id=hl-86-28><a class=lnlinks href=#hl-86-28>28</a>
</span><span class=lnt id=hl-86-29><a class=lnlinks href=#hl-86-29>29</a>
</span><span class=lnt id=hl-86-30><a class=lnlinks href=#hl-86-30>30</a>
</span><span class=lnt id=hl-86-31><a class=lnlinks href=#hl-86-31>31</a>
</span><span class=lnt id=hl-86-32><a class=lnlinks href=#hl-86-32>32</a>
</span><span class=lnt id=hl-86-33><a class=lnlinks href=#hl-86-33>33</a>
</span><span class=lnt id=hl-86-34><a class=lnlinks href=#hl-86-34>34</a>
</span><span class=lnt id=hl-86-35><a class=lnlinks href=#hl-86-35>35</a>
</span><span class=lnt id=hl-86-36><a class=lnlinks href=#hl-86-36>36</a>
</span><span class=lnt id=hl-86-37><a class=lnlinks href=#hl-86-37>37</a>
</span><span class=lnt id=hl-86-38><a class=lnlinks href=#hl-86-38>38</a>
</span><span class=lnt id=hl-86-39><a class=lnlinks href=#hl-86-39>39</a>
</span><span class=lnt id=hl-86-40><a class=lnlinks href=#hl-86-40>40</a>
</span><span class=lnt id=hl-86-41><a class=lnlinks href=#hl-86-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Room</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>increment</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>value</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decrement</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>value</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Room</span><span class=w> </span><span class=n>room</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Room</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>room</span><span class=p>.</span><span class=na>increment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>room</span><span class=p>.</span><span class=na>decrement</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;count: {}&#34;</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=n>room</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=43-方法上的-synchronized><a href=#43-%e6%96%b9%e6%b3%95%e4%b8%8a%e7%9a%84-synchronized class=header-anchor>#</a>
4.3 方法上的 synchronized</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-87-1><a class=lnlinks href=#hl-87-1> 1</a>
</span><span class=lnt id=hl-87-2><a class=lnlinks href=#hl-87-2> 2</a>
</span><span class=lnt id=hl-87-3><a class=lnlinks href=#hl-87-3> 3</a>
</span><span class=lnt id=hl-87-4><a class=lnlinks href=#hl-87-4> 4</a>
</span><span class=lnt id=hl-87-5><a class=lnlinks href=#hl-87-5> 5</a>
</span><span class=lnt id=hl-87-6><a class=lnlinks href=#hl-87-6> 6</a>
</span><span class=lnt id=hl-87-7><a class=lnlinks href=#hl-87-7> 7</a>
</span><span class=lnt id=hl-87-8><a class=lnlinks href=#hl-87-8> 8</a>
</span><span class=lnt id=hl-87-9><a class=lnlinks href=#hl-87-9> 9</a>
</span><span class=lnt id=hl-87-10><a class=lnlinks href=#hl-87-10>10</a>
</span><span class=lnt id=hl-87-11><a class=lnlinks href=#hl-87-11>11</a>
</span><span class=lnt id=hl-87-12><a class=lnlinks href=#hl-87-12>12</a>
</span><span class=lnt id=hl-87-13><a class=lnlinks href=#hl-87-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Test</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//等价于</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Test</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-88-1><a class=lnlinks href=#hl-88-1> 1</a>
</span><span class=lnt id=hl-88-2><a class=lnlinks href=#hl-88-2> 2</a>
</span><span class=lnt id=hl-88-3><a class=lnlinks href=#hl-88-3> 3</a>
</span><span class=lnt id=hl-88-4><a class=lnlinks href=#hl-88-4> 4</a>
</span><span class=lnt id=hl-88-5><a class=lnlinks href=#hl-88-5> 5</a>
</span><span class=lnt id=hl-88-6><a class=lnlinks href=#hl-88-6> 6</a>
</span><span class=lnt id=hl-88-7><a class=lnlinks href=#hl-88-7> 7</a>
</span><span class=lnt id=hl-88-8><a class=lnlinks href=#hl-88-8> 8</a>
</span><span class=lnt id=hl-88-9><a class=lnlinks href=#hl-88-9> 9</a>
</span><span class=lnt id=hl-88-10><a class=lnlinks href=#hl-88-10>10</a>
</span><span class=lnt id=hl-88-11><a class=lnlinks href=#hl-88-11>11</a>
</span><span class=lnt id=hl-88-12><a class=lnlinks href=#hl-88-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Test</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>等价于</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Test</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>Test</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=不加-synchronized-的方法><a href=#%e4%b8%8d%e5%8a%a0-synchronized-%e7%9a%84%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
<strong>不加 synchronized 的方法</strong></h5><p>不加 synchronzied 的方法就好比不遵守规则的人，不去老实排队（好比翻窗户进去的）</p><h5 id=所谓的线程八锁><a href=#%e6%89%80%e8%b0%93%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%85%ab%e9%94%81 class=header-anchor>#</a>
<strong>所谓的“线程八锁”</strong></h5><p>其实就是考察 synchronized 锁住的是哪个对象</p><p>情况1：12 或 21</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-89-1><a class=lnlinks href=#hl-89-1> 1</a>
</span><span class=lnt id=hl-89-2><a class=lnlinks href=#hl-89-2> 2</a>
</span><span class=lnt id=hl-89-3><a class=lnlinks href=#hl-89-3> 3</a>
</span><span class=lnt id=hl-89-4><a class=lnlinks href=#hl-89-4> 4</a>
</span><span class=lnt id=hl-89-5><a class=lnlinks href=#hl-89-5> 5</a>
</span><span class=lnt id=hl-89-6><a class=lnlinks href=#hl-89-6> 6</a>
</span><span class=lnt id=hl-89-7><a class=lnlinks href=#hl-89-7> 7</a>
</span><span class=lnt id=hl-89-8><a class=lnlinks href=#hl-89-8> 8</a>
</span><span class=lnt id=hl-89-9><a class=lnlinks href=#hl-89-9> 9</a>
</span><span class=lnt id=hl-89-10><a class=lnlinks href=#hl-89-10>10</a>
</span><span class=lnt id=hl-89-11><a class=lnlinks href=#hl-89-11>11</a>
</span><span class=lnt id=hl-89-12><a class=lnlinks href=#hl-89-12>12</a>
</span><span class=lnt id=hl-89-13><a class=lnlinks href=#hl-89-13>13</a>
</span><span class=lnt id=hl-89-14><a class=lnlinks href=#hl-89-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>情况2：1s后12，或 2 1s后 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-90-1><a class=lnlinks href=#hl-90-1> 1</a>
</span><span class=lnt id=hl-90-2><a class=lnlinks href=#hl-90-2> 2</a>
</span><span class=lnt id=hl-90-3><a class=lnlinks href=#hl-90-3> 3</a>
</span><span class=lnt id=hl-90-4><a class=lnlinks href=#hl-90-4> 4</a>
</span><span class=lnt id=hl-90-5><a class=lnlinks href=#hl-90-5> 5</a>
</span><span class=lnt id=hl-90-6><a class=lnlinks href=#hl-90-6> 6</a>
</span><span class=lnt id=hl-90-7><a class=lnlinks href=#hl-90-7> 7</a>
</span><span class=lnt id=hl-90-8><a class=lnlinks href=#hl-90-8> 8</a>
</span><span class=lnt id=hl-90-9><a class=lnlinks href=#hl-90-9> 9</a>
</span><span class=lnt id=hl-90-10><a class=lnlinks href=#hl-90-10>10</a>
</span><span class=lnt id=hl-90-11><a class=lnlinks href=#hl-90-11>11</a>
</span><span class=lnt id=hl-90-12><a class=lnlinks href=#hl-90-12>12</a>
</span><span class=lnt id=hl-90-13><a class=lnlinks href=#hl-90-13>13</a>
</span><span class=lnt id=hl-90-14><a class=lnlinks href=#hl-90-14>14</a>
</span><span class=lnt id=hl-90-15><a class=lnlinks href=#hl-90-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>情况3：3 1s 12 或 23 1s 1 或 32 1s 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-91-1><a class=lnlinks href=#hl-91-1> 1</a>
</span><span class=lnt id=hl-91-2><a class=lnlinks href=#hl-91-2> 2</a>
</span><span class=lnt id=hl-91-3><a class=lnlinks href=#hl-91-3> 3</a>
</span><span class=lnt id=hl-91-4><a class=lnlinks href=#hl-91-4> 4</a>
</span><span class=lnt id=hl-91-5><a class=lnlinks href=#hl-91-5> 5</a>
</span><span class=lnt id=hl-91-6><a class=lnlinks href=#hl-91-6> 6</a>
</span><span class=lnt id=hl-91-7><a class=lnlinks href=#hl-91-7> 7</a>
</span><span class=lnt id=hl-91-8><a class=lnlinks href=#hl-91-8> 8</a>
</span><span class=lnt id=hl-91-9><a class=lnlinks href=#hl-91-9> 9</a>
</span><span class=lnt id=hl-91-10><a class=lnlinks href=#hl-91-10>10</a>
</span><span class=lnt id=hl-91-11><a class=lnlinks href=#hl-91-11>11</a>
</span><span class=lnt id=hl-91-12><a class=lnlinks href=#hl-91-12>12</a>
</span><span class=lnt id=hl-91-13><a class=lnlinks href=#hl-91-13>13</a>
</span><span class=lnt id=hl-91-14><a class=lnlinks href=#hl-91-14>14</a>
</span><span class=lnt id=hl-91-15><a class=lnlinks href=#hl-91-15>15</a>
</span><span class=lnt id=hl-91-16><a class=lnlinks href=#hl-91-16>16</a>
</span><span class=lnt id=hl-91-17><a class=lnlinks href=#hl-91-17>17</a>
</span><span class=lnt id=hl-91-18><a class=lnlinks href=#hl-91-18>18</a>
</span><span class=lnt id=hl-91-19><a class=lnlinks href=#hl-91-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>c</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>c</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>情况4：2 1s 后 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-92-1><a class=lnlinks href=#hl-92-1> 1</a>
</span><span class=lnt id=hl-92-2><a class=lnlinks href=#hl-92-2> 2</a>
</span><span class=lnt id=hl-92-3><a class=lnlinks href=#hl-92-3> 3</a>
</span><span class=lnt id=hl-92-4><a class=lnlinks href=#hl-92-4> 4</a>
</span><span class=lnt id=hl-92-5><a class=lnlinks href=#hl-92-5> 5</a>
</span><span class=lnt id=hl-92-6><a class=lnlinks href=#hl-92-6> 6</a>
</span><span class=lnt id=hl-92-7><a class=lnlinks href=#hl-92-7> 7</a>
</span><span class=lnt id=hl-92-8><a class=lnlinks href=#hl-92-8> 8</a>
</span><span class=lnt id=hl-92-9><a class=lnlinks href=#hl-92-9> 9</a>
</span><span class=lnt id=hl-92-10><a class=lnlinks href=#hl-92-10>10</a>
</span><span class=lnt id=hl-92-11><a class=lnlinks href=#hl-92-11>11</a>
</span><span class=lnt id=hl-92-12><a class=lnlinks href=#hl-92-12>12</a>
</span><span class=lnt id=hl-92-13><a class=lnlinks href=#hl-92-13>13</a>
</span><span class=lnt id=hl-92-14><a class=lnlinks href=#hl-92-14>14</a>
</span><span class=lnt id=hl-92-15><a class=lnlinks href=#hl-92-15>15</a>
</span><span class=lnt id=hl-92-16><a class=lnlinks href=#hl-92-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n2</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>情况5：2 1s 后 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-93-1><a class=lnlinks href=#hl-93-1> 1</a>
</span><span class=lnt id=hl-93-2><a class=lnlinks href=#hl-93-2> 2</a>
</span><span class=lnt id=hl-93-3><a class=lnlinks href=#hl-93-3> 3</a>
</span><span class=lnt id=hl-93-4><a class=lnlinks href=#hl-93-4> 4</a>
</span><span class=lnt id=hl-93-5><a class=lnlinks href=#hl-93-5> 5</a>
</span><span class=lnt id=hl-93-6><a class=lnlinks href=#hl-93-6> 6</a>
</span><span class=lnt id=hl-93-7><a class=lnlinks href=#hl-93-7> 7</a>
</span><span class=lnt id=hl-93-8><a class=lnlinks href=#hl-93-8> 8</a>
</span><span class=lnt id=hl-93-9><a class=lnlinks href=#hl-93-9> 9</a>
</span><span class=lnt id=hl-93-10><a class=lnlinks href=#hl-93-10>10</a>
</span><span class=lnt id=hl-93-11><a class=lnlinks href=#hl-93-11>11</a>
</span><span class=lnt id=hl-93-12><a class=lnlinks href=#hl-93-12>12</a>
</span><span class=lnt id=hl-93-13><a class=lnlinks href=#hl-93-13>13</a>
</span><span class=lnt id=hl-93-14><a class=lnlinks href=#hl-93-14>14</a>
</span><span class=lnt id=hl-93-15><a class=lnlinks href=#hl-93-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>情况6：1s 后12， 或 2 1s后 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-94-1><a class=lnlinks href=#hl-94-1> 1</a>
</span><span class=lnt id=hl-94-2><a class=lnlinks href=#hl-94-2> 2</a>
</span><span class=lnt id=hl-94-3><a class=lnlinks href=#hl-94-3> 3</a>
</span><span class=lnt id=hl-94-4><a class=lnlinks href=#hl-94-4> 4</a>
</span><span class=lnt id=hl-94-5><a class=lnlinks href=#hl-94-5> 5</a>
</span><span class=lnt id=hl-94-6><a class=lnlinks href=#hl-94-6> 6</a>
</span><span class=lnt id=hl-94-7><a class=lnlinks href=#hl-94-7> 7</a>
</span><span class=lnt id=hl-94-8><a class=lnlinks href=#hl-94-8> 8</a>
</span><span class=lnt id=hl-94-9><a class=lnlinks href=#hl-94-9> 9</a>
</span><span class=lnt id=hl-94-10><a class=lnlinks href=#hl-94-10>10</a>
</span><span class=lnt id=hl-94-11><a class=lnlinks href=#hl-94-11>11</a>
</span><span class=lnt id=hl-94-12><a class=lnlinks href=#hl-94-12>12</a>
</span><span class=lnt id=hl-94-13><a class=lnlinks href=#hl-94-13>13</a>
</span><span class=lnt id=hl-94-14><a class=lnlinks href=#hl-94-14>14</a>
</span><span class=lnt id=hl-94-15><a class=lnlinks href=#hl-94-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>情况7：2 1s 后 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-95-1><a class=lnlinks href=#hl-95-1> 1</a>
</span><span class=lnt id=hl-95-2><a class=lnlinks href=#hl-95-2> 2</a>
</span><span class=lnt id=hl-95-3><a class=lnlinks href=#hl-95-3> 3</a>
</span><span class=lnt id=hl-95-4><a class=lnlinks href=#hl-95-4> 4</a>
</span><span class=lnt id=hl-95-5><a class=lnlinks href=#hl-95-5> 5</a>
</span><span class=lnt id=hl-95-6><a class=lnlinks href=#hl-95-6> 6</a>
</span><span class=lnt id=hl-95-7><a class=lnlinks href=#hl-95-7> 7</a>
</span><span class=lnt id=hl-95-8><a class=lnlinks href=#hl-95-8> 8</a>
</span><span class=lnt id=hl-95-9><a class=lnlinks href=#hl-95-9> 9</a>
</span><span class=lnt id=hl-95-10><a class=lnlinks href=#hl-95-10>10</a>
</span><span class=lnt id=hl-95-11><a class=lnlinks href=#hl-95-11>11</a>
</span><span class=lnt id=hl-95-12><a class=lnlinks href=#hl-95-12>12</a>
</span><span class=lnt id=hl-95-13><a class=lnlinks href=#hl-95-13>13</a>
</span><span class=lnt id=hl-95-14><a class=lnlinks href=#hl-95-14>14</a>
</span><span class=lnt id=hl-95-15><a class=lnlinks href=#hl-95-15>15</a>
</span><span class=lnt id=hl-95-16><a class=lnlinks href=#hl-95-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n2</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>情况8：1s 后12， 或 2 1s后 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-96-1><a class=lnlinks href=#hl-96-1> 1</a>
</span><span class=lnt id=hl-96-2><a class=lnlinks href=#hl-96-2> 2</a>
</span><span class=lnt id=hl-96-3><a class=lnlinks href=#hl-96-3> 3</a>
</span><span class=lnt id=hl-96-4><a class=lnlinks href=#hl-96-4> 4</a>
</span><span class=lnt id=hl-96-5><a class=lnlinks href=#hl-96-5> 5</a>
</span><span class=lnt id=hl-96-6><a class=lnlinks href=#hl-96-6> 6</a>
</span><span class=lnt id=hl-96-7><a class=lnlinks href=#hl-96-7> 7</a>
</span><span class=lnt id=hl-96-8><a class=lnlinks href=#hl-96-8> 8</a>
</span><span class=lnt id=hl-96-9><a class=lnlinks href=#hl-96-9> 9</a>
</span><span class=lnt id=hl-96-10><a class=lnlinks href=#hl-96-10>10</a>
</span><span class=lnt id=hl-96-11><a class=lnlinks href=#hl-96-11>11</a>
</span><span class=lnt id=hl-96-12><a class=lnlinks href=#hl-96-12>12</a>
</span><span class=lnt id=hl-96-13><a class=lnlinks href=#hl-96-13>13</a>
</span><span class=lnt id=hl-96-14><a class=lnlinks href=#hl-96-14>14</a>
</span><span class=lnt id=hl-96-15><a class=lnlinks href=#hl-96-15>15</a>
</span><span class=lnt id=hl-96-16><a class=lnlinks href=#hl-96-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n2</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=44-变量的线程安全分析><a href=#44-%e5%8f%98%e9%87%8f%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e5%88%86%e6%9e%90 class=header-anchor>#</a>
4.4 变量的线程安全分析</h2><h5 id=成员变量和静态变量是否线程安全><a href=#%e6%88%90%e5%91%98%e5%8f%98%e9%87%8f%e5%92%8c%e9%9d%99%e6%80%81%e5%8f%98%e9%87%8f%e6%98%af%e5%90%a6%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8 class=header-anchor>#</a>
<strong>成员变量和静态变量是否线程安全？</strong></h5><ul><li>如果它们没有共享，则线程安全</li><li>如果它们被共享了，根据它们的状态是否能够改变，又分两种情况<ul><li>如果只有读操作，则线程安全</li><li>如果有读写操作，则这段代码是临界区，需要考虑线程安全</li></ul></li></ul><h5 id=局部变量是否线程安全><a href=#%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%e6%98%af%e5%90%a6%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8 class=header-anchor>#</a>
<strong>局部变量是否线程安全？</strong></h5><ul><li>局部变量是线程安全的</li><li>但局部变量引用的对象则未必<ul><li>如果该对象没有逃离方法的作用访问，它是线程安全的</li><li>如果该对象逃离方法的作用范围，需要考虑线程安全</li></ul></li></ul><h5 id=局部变量线程安全分析><a href=#%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e5%88%86%e6%9e%90 class=header-anchor>#</a>
<strong>局部变量线程安全分析</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-97-1><a class=lnlinks href=#hl-97-1>1</a>
</span><span class=lnt id=hl-97-2><a class=lnlinks href=#hl-97-2>2</a>
</span><span class=lnt id=hl-97-3><a class=lnlinks href=#hl-97-3>3</a>
</span><span class=lnt id=hl-97-4><a class=lnlinks href=#hl-97-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>i</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>每个线程调用 test1() 方法时局部变量 i，会在每个线程的栈帧内存中被创建多份，因此不存在共享</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-98-1><a class=lnlinks href=#hl-98-1> 1</a>
</span><span class=lnt id=hl-98-2><a class=lnlinks href=#hl-98-2> 2</a>
</span><span class=lnt id=hl-98-3><a class=lnlinks href=#hl-98-3> 3</a>
</span><span class=lnt id=hl-98-4><a class=lnlinks href=#hl-98-4> 4</a>
</span><span class=lnt id=hl-98-5><a class=lnlinks href=#hl-98-5> 5</a>
</span><span class=lnt id=hl-98-6><a class=lnlinks href=#hl-98-6> 6</a>
</span><span class=lnt id=hl-98-7><a class=lnlinks href=#hl-98-7> 7</a>
</span><span class=lnt id=hl-98-8><a class=lnlinks href=#hl-98-8> 8</a>
</span><span class=lnt id=hl-98-9><a class=lnlinks href=#hl-98-9> 9</a>
</span><span class=lnt id=hl-98-10><a class=lnlinks href=#hl-98-10>10</a>
</span><span class=lnt id=hl-98-11><a class=lnlinks href=#hl-98-11>11</a>
</span><span class=lnt id=hl-98-12><a class=lnlinks href=#hl-98-12>12</a>
</span><span class=lnt id=hl-98-13><a class=lnlinks href=#hl-98-13>13</a>
</span><span class=lnt id=hl-98-14><a class=lnlinks href=#hl-98-14>14</a>
</span><span class=lnt id=hl-98-15><a class=lnlinks href=#hl-98-15>15</a>
</span><span class=lnt id=hl-98-16><a class=lnlinks href=#hl-98-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>descriptor</span><span class=p>:</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>flags</span><span class=p>:</span><span class=w> </span><span class=n>ACC_PUBLIC</span><span class=p>,</span><span class=w> </span><span class=n>ACC_STATIC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>stack</span><span class=o>=</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>locals</span><span class=o>=</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>args_size</span><span class=o>=</span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>bipush</span><span class=w> </span><span class=n>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>2</span><span class=p>:</span><span class=w> </span><span class=n>istore_0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>3</span><span class=p>:</span><span class=w> </span><span class=n>iinc</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>6</span><span class=p>:</span><span class=w> </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>LineNumberTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>line</span><span class=w> </span><span class=n>10</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>line</span><span class=w> </span><span class=n>11</span><span class=p>:</span><span class=w> </span><span class=n>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>line</span><span class=w> </span><span class=n>12</span><span class=p>:</span><span class=w> </span><span class=n>6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>LocalVariableTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Start</span><span class=w> </span><span class=n>Length</span><span class=w> </span><span class=n>Slot</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=n>Signature</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>3</span><span class=w>        </span><span class=n>4</span><span class=w>     </span><span class=n>0</span><span class=w>   </span><span class=n>i</span><span class=w>      </span><span class=n>I</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>如图</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220303005909688.png width=900 height=600 loading=lazy decoding=async alt=image-20220303005909688 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>局部变量的引用稍有不同</p><p>先看一个成员变量的例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-99-1><a class=lnlinks href=#hl-99-1> 1</a>
</span><span class=lnt id=hl-99-2><a class=lnlinks href=#hl-99-2> 2</a>
</span><span class=lnt id=hl-99-3><a class=lnlinks href=#hl-99-3> 3</a>
</span><span class=lnt id=hl-99-4><a class=lnlinks href=#hl-99-4> 4</a>
</span><span class=lnt id=hl-99-5><a class=lnlinks href=#hl-99-5> 5</a>
</span><span class=lnt id=hl-99-6><a class=lnlinks href=#hl-99-6> 6</a>
</span><span class=lnt id=hl-99-7><a class=lnlinks href=#hl-99-7> 7</a>
</span><span class=lnt id=hl-99-8><a class=lnlinks href=#hl-99-8> 8</a>
</span><span class=lnt id=hl-99-9><a class=lnlinks href=#hl-99-9> 9</a>
</span><span class=lnt id=hl-99-10><a class=lnlinks href=#hl-99-10>10</a>
</span><span class=lnt id=hl-99-11><a class=lnlinks href=#hl-99-11>11</a>
</span><span class=lnt id=hl-99-12><a class=lnlinks href=#hl-99-12>12</a>
</span><span class=lnt id=hl-99-13><a class=lnlinks href=#hl-99-13>13</a>
</span><span class=lnt id=hl-99-14><a class=lnlinks href=#hl-99-14>14</a>
</span><span class=lnt id=hl-99-15><a class=lnlinks href=#hl-99-15>15</a>
</span><span class=lnt id=hl-99-16><a class=lnlinks href=#hl-99-16>16</a>
</span><span class=lnt id=hl-99-17><a class=lnlinks href=#hl-99-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ThreadUnsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// { 临界区, 会产生竞态条件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method3</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// } 临界区</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-100-1><a class=lnlinks href=#hl-100-1> 1</a>
</span><span class=lnt id=hl-100-2><a class=lnlinks href=#hl-100-2> 2</a>
</span><span class=lnt id=hl-100-3><a class=lnlinks href=#hl-100-3> 3</a>
</span><span class=lnt id=hl-100-4><a class=lnlinks href=#hl-100-4> 4</a>
</span><span class=lnt id=hl-100-5><a class=lnlinks href=#hl-100-5> 5</a>
</span><span class=lnt id=hl-100-6><a class=lnlinks href=#hl-100-6> 6</a>
</span><span class=lnt id=hl-100-7><a class=lnlinks href=#hl-100-7> 7</a>
</span><span class=lnt id=hl-100-8><a class=lnlinks href=#hl-100-8> 8</a>
</span><span class=lnt id=hl-100-9><a class=lnlinks href=#hl-100-9> 9</a>
</span><span class=lnt id=hl-100-10><a class=lnlinks href=#hl-100-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>THREAD_NUMBER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>LOOP_NUMBER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>200</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ThreadUnsafe</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadUnsafe</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>THREAD_NUMBER</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>test</span><span class=p>.</span><span class=na>method1</span><span class=p>(</span><span class=n>LOOP_NUMBER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;Thread&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>其中一种情况是，如果线程2 还未 add，线程1 remove 就会报错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-101-1><a class=lnlinks href=#hl-101-1>1</a>
</span><span class=lnt id=hl-101-2><a class=lnlinks href=#hl-101-2>2</a>
</span><span class=lnt id=hl-101-3><a class=lnlinks href=#hl-101-3>3</a>
</span><span class=lnt id=hl-101-4><a class=lnlinks href=#hl-101-4>4</a>
</span><span class=lnt id=hl-101-5><a class=lnlinks href=#hl-101-5>5</a>
</span><span class=lnt id=hl-101-6><a class=lnlinks href=#hl-101-6>6</a>
</span><span class=lnt id=hl-101-7><a class=lnlinks href=#hl-101-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Exception</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=s>&#34;Thread1&#34;</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>IndexOutOfBoundsException</span><span class=p>:</span><span class=w> </span><span class=n>Index</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>Size</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>ArrayList</span><span class=p>.</span><span class=na>rangeCheck</span><span class=p>(</span><span class=n>ArrayList</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>657</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>ArrayList</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>ArrayList</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>496</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>n6</span><span class=p>.</span><span class=na>ThreadUnsafe</span><span class=p>.</span><span class=na>method3</span><span class=p>(</span><span class=n>TestThreadSafe</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>35</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>n6</span><span class=p>.</span><span class=na>ThreadUnsafe</span><span class=p>.</span><span class=na>method1</span><span class=p>(</span><span class=n>TestThreadSafe</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>26</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>n6</span><span class=p>.</span><span class=na>TestThreadSafe</span><span class=p>.</span><span class=na>lambda$main$0</span><span class=p>(</span><span class=n>TestThreadSafe</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>14</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>748</span><span class=p>)</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>分析：</p><ul><li>无论哪个线程中的 method2 引用的都是同一个对象中的 list 成员变量</li><li>method3 与 method2 分析相同</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220303010311338.png width=900 height=600 loading=lazy decoding=async alt=image-20220303010311338 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>将 list 修改为局部变量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-102-1><a class=lnlinks href=#hl-102-1> 1</a>
</span><span class=lnt id=hl-102-2><a class=lnlinks href=#hl-102-2> 2</a>
</span><span class=lnt id=hl-102-3><a class=lnlinks href=#hl-102-3> 3</a>
</span><span class=lnt id=hl-102-4><a class=lnlinks href=#hl-102-4> 4</a>
</span><span class=lnt id=hl-102-5><a class=lnlinks href=#hl-102-5> 5</a>
</span><span class=lnt id=hl-102-6><a class=lnlinks href=#hl-102-6> 6</a>
</span><span class=lnt id=hl-102-7><a class=lnlinks href=#hl-102-7> 7</a>
</span><span class=lnt id=hl-102-8><a class=lnlinks href=#hl-102-8> 8</a>
</span><span class=lnt id=hl-102-9><a class=lnlinks href=#hl-102-9> 9</a>
</span><span class=lnt id=hl-102-10><a class=lnlinks href=#hl-102-10>10</a>
</span><span class=lnt id=hl-102-11><a class=lnlinks href=#hl-102-11>11</a>
</span><span class=lnt id=hl-102-12><a class=lnlinks href=#hl-102-12>12</a>
</span><span class=lnt id=hl-102-13><a class=lnlinks href=#hl-102-13>13</a>
</span><span class=lnt id=hl-102-14><a class=lnlinks href=#hl-102-14>14</a>
</span><span class=lnt id=hl-102-15><a class=lnlinks href=#hl-102-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ThreadSafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method2</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method3</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>那么就不会有上述问题了</p><p>分析：</p><ul><li>list 是局部变量，每个线程调用时会创建其不同实例，没有共享</li><li>而 method2 的参数是从 method1 中传递过来的，与 method1 中引用同一个对象</li><li>method3 的参数分析与 method2 相同</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220303010518661.png width=900 height=600 loading=lazy decoding=async alt=image-20220303010518661 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>方法访问修饰符带来的思考，如果把 method2 和 method3 的方法修改为 public 会不会代理线程安全问题？</p><ul><li>情况1：有其它线程调用 method2 和 method3</li><li>情况2：在 情况1 的基础上，为 ThreadSafe 类添加子类，子类覆盖 method2 或 method3 方法，</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-103-1><a class=lnlinks href=#hl-103-1> 1</a>
</span><span class=lnt id=hl-103-2><a class=lnlinks href=#hl-103-2> 2</a>
</span><span class=lnt id=hl-103-3><a class=lnlinks href=#hl-103-3> 3</a>
</span><span class=lnt id=hl-103-4><a class=lnlinks href=#hl-103-4> 4</a>
</span><span class=lnt id=hl-103-5><a class=lnlinks href=#hl-103-5> 5</a>
</span><span class=lnt id=hl-103-6><a class=lnlinks href=#hl-103-6> 6</a>
</span><span class=lnt id=hl-103-7><a class=lnlinks href=#hl-103-7> 7</a>
</span><span class=lnt id=hl-103-8><a class=lnlinks href=#hl-103-8> 8</a>
</span><span class=lnt id=hl-103-9><a class=lnlinks href=#hl-103-9> 9</a>
</span><span class=lnt id=hl-103-10><a class=lnlinks href=#hl-103-10>10</a>
</span><span class=lnt id=hl-103-11><a class=lnlinks href=#hl-103-11>11</a>
</span><span class=lnt id=hl-103-12><a class=lnlinks href=#hl-103-12>12</a>
</span><span class=lnt id=hl-103-13><a class=lnlinks href=#hl-103-13>13</a>
</span><span class=lnt id=hl-103-14><a class=lnlinks href=#hl-103-14>14</a>
</span><span class=lnt id=hl-103-15><a class=lnlinks href=#hl-103-15>15</a>
</span><span class=lnt id=hl-103-16><a class=lnlinks href=#hl-103-16>16</a>
</span><span class=lnt id=hl-103-17><a class=lnlinks href=#hl-103-17>17</a>
</span><span class=lnt id=hl-103-18><a class=lnlinks href=#hl-103-18>18</a>
</span><span class=lnt id=hl-103-19><a class=lnlinks href=#hl-103-19>19</a>
</span><span class=lnt id=hl-103-20><a class=lnlinks href=#hl-103-20>20</a>
</span><span class=lnt id=hl-103-21><a class=lnlinks href=#hl-103-21>21</a>
</span><span class=lnt id=hl-103-22><a class=lnlinks href=#hl-103-22>22</a>
</span><span class=lnt id=hl-103-23><a class=lnlinks href=#hl-103-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ThreadSafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method2</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method3</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>ThreadSafeSubClass</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ThreadSafe</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>从这个例子可以看出 private 或 final 提供【安全】的意义所在，请体会开闭原则中的【闭】</p></blockquote><h5 id=常见线程安全类><a href=#%e5%b8%b8%e8%a7%81%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e7%b1%bb class=header-anchor>#</a>
<strong>常见线程安全类</strong></h5><ul><li>String</li><li>Integer</li><li>StringBuffer</li><li>Random</li><li>Vector</li><li>Hashtable</li><li>java.util.concurrent 包下的类</li></ul><p>这里说它们是线程安全的是指，多个线程调用它们同一个实例的某个方法时，是线程安全的。也可以理解为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-104-1><a class=lnlinks href=#hl-104-1>1</a>
</span><span class=lnt id=hl-104-2><a class=lnlinks href=#hl-104-2>2</a>
</span><span class=lnt id=hl-104-3><a class=lnlinks href=#hl-104-3>3</a>
</span><span class=lnt id=hl-104-4><a class=lnlinks href=#hl-104-4>4</a>
</span><span class=lnt id=hl-104-5><a class=lnlinks href=#hl-104-5>5</a>
</span><span class=lnt id=hl-104-6><a class=lnlinks href=#hl-104-6>6</a>
</span><span class=lnt id=hl-104-7><a class=lnlinks href=#hl-104-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Hashtable</span><span class=w> </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hashtable</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>table</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>table</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>它们的每个方法是原子的</li><li>但注意它们多个方法的组合不是原子的，见后面分析</li></ul><p><strong>线程安全类方法的组合</strong></p><p>分析下面代码是否线程安全？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-105-1><a class=lnlinks href=#hl-105-1>1</a>
</span><span class=lnt id=hl-105-2><a class=lnlinks href=#hl-105-2>2</a>
</span><span class=lnt id=hl-105-3><a class=lnlinks href=#hl-105-3>3</a>
</span><span class=lnt id=hl-105-4><a class=lnlinks href=#hl-105-4>4</a>
</span><span class=lnt id=hl-105-5><a class=lnlinks href=#hl-105-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Hashtable</span><span class=w> </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hashtable</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 线程1，线程2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>table</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>table</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220303011322077.png width=900 height=600 loading=lazy decoding=async alt=image-20220303011322077 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>不可变类线程安全性</strong></p><p>String、Integer 等都是不可变类，因为其内部的状态不可以改变，因此它们的方法都是线程安全的 有同学或许有疑问，String 有 replace，substring 等方法【可以】改变值啊，那么这些方法又是如何保证线程安 全的呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-106-1><a class=lnlinks href=#hl-106-1>1</a>
</span><span class=lnt id=hl-106-2><a class=lnlinks href=#hl-106-2>2</a>
</span><span class=lnt id=hl-106-3><a class=lnlinks href=#hl-106-3>3</a>
</span><span class=lnt id=hl-106-4><a class=lnlinks href=#hl-106-4>4</a>
</span><span class=lnt id=hl-106-5><a class=lnlinks href=#hl-106-5>5</a>
</span><span class=lnt id=hl-106-6><a class=lnlinks href=#hl-106-6>6</a>
</span><span class=lnt id=hl-106-7><a class=lnlinks href=#hl-106-7>7</a>
</span><span class=lnt id=hl-106-8><a class=lnlinks href=#hl-106-8>8</a>
</span><span class=lnt id=hl-106-9><a class=lnlinks href=#hl-106-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Immutable</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Immutable</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getValue</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>如果想增加一个增加的方法呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-107-1><a class=lnlinks href=#hl-107-1> 1</a>
</span><span class=lnt id=hl-107-2><a class=lnlinks href=#hl-107-2> 2</a>
</span><span class=lnt id=hl-107-3><a class=lnlinks href=#hl-107-3> 3</a>
</span><span class=lnt id=hl-107-4><a class=lnlinks href=#hl-107-4> 4</a>
</span><span class=lnt id=hl-107-5><a class=lnlinks href=#hl-107-5> 5</a>
</span><span class=lnt id=hl-107-6><a class=lnlinks href=#hl-107-6> 6</a>
</span><span class=lnt id=hl-107-7><a class=lnlinks href=#hl-107-7> 7</a>
</span><span class=lnt id=hl-107-8><a class=lnlinks href=#hl-107-8> 8</a>
</span><span class=lnt id=hl-107-9><a class=lnlinks href=#hl-107-9> 9</a>
</span><span class=lnt id=hl-107-10><a class=lnlinks href=#hl-107-10>10</a>
</span><span class=lnt id=hl-107-11><a class=lnlinks href=#hl-107-11>11</a>
</span><span class=lnt id=hl-107-12><a class=lnlinks href=#hl-107-12>12</a>
</span><span class=lnt id=hl-107-13><a class=lnlinks href=#hl-107-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Immutable</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Immutable</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getValue</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Immutable</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>v</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Immutable</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>v</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=实例分析><a href=#%e5%ae%9e%e4%be%8b%e5%88%86%e6%9e%90 class=header-anchor>#</a>
实例分析</h5><p>例1：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-108-1><a class=lnlinks href=#hl-108-1> 1</a>
</span><span class=lnt id=hl-108-2><a class=lnlinks href=#hl-108-2> 2</a>
</span><span class=lnt id=hl-108-3><a class=lnlinks href=#hl-108-3> 3</a>
</span><span class=lnt id=hl-108-4><a class=lnlinks href=#hl-108-4> 4</a>
</span><span class=lnt id=hl-108-5><a class=lnlinks href=#hl-108-5> 5</a>
</span><span class=lnt id=hl-108-6><a class=lnlinks href=#hl-108-6> 6</a>
</span><span class=lnt id=hl-108-7><a class=lnlinks href=#hl-108-7> 7</a>
</span><span class=lnt id=hl-108-8><a class=lnlinks href=#hl-108-8> 8</a>
</span><span class=lnt id=hl-108-9><a class=lnlinks href=#hl-108-9> 9</a>
</span><span class=lnt id=hl-108-10><a class=lnlinks href=#hl-108-10>10</a>
</span><span class=lnt id=hl-108-11><a class=lnlinks href=#hl-108-11>11</a>
</span><span class=lnt id=hl-108-12><a class=lnlinks href=#hl-108-12>12</a>
</span><span class=lnt id=hl-108-13><a class=lnlinks href=#hl-108-13>13</a>
</span><span class=lnt id=hl-108-14><a class=lnlinks href=#hl-108-14>14</a>
</span><span class=lnt id=hl-108-15><a class=lnlinks href=#hl-108-15>15</a>
</span><span class=lnt id=hl-108-16><a class=lnlinks href=#hl-108-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyServlet</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>S1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;...&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>S2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;...&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Date</span><span class=w> </span><span class=n>D1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=n>D2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 使用上述变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>例2：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-109-1><a class=lnlinks href=#hl-109-1> 1</a>
</span><span class=lnt id=hl-109-2><a class=lnlinks href=#hl-109-2> 2</a>
</span><span class=lnt id=hl-109-3><a class=lnlinks href=#hl-109-3> 3</a>
</span><span class=lnt id=hl-109-4><a class=lnlinks href=#hl-109-4> 4</a>
</span><span class=lnt id=hl-109-5><a class=lnlinks href=#hl-109-5> 5</a>
</span><span class=lnt id=hl-109-6><a class=lnlinks href=#hl-109-6> 6</a>
</span><span class=lnt id=hl-109-7><a class=lnlinks href=#hl-109-7> 7</a>
</span><span class=lnt id=hl-109-8><a class=lnlinks href=#hl-109-8> 8</a>
</span><span class=lnt id=hl-109-9><a class=lnlinks href=#hl-109-9> 9</a>
</span><span class=lnt id=hl-109-10><a class=lnlinks href=#hl-109-10>10</a>
</span><span class=lnt id=hl-109-11><a class=lnlinks href=#hl-109-11>11</a>
</span><span class=lnt id=hl-109-12><a class=lnlinks href=#hl-109-12>12</a>
</span><span class=lnt id=hl-109-13><a class=lnlinks href=#hl-109-13>13</a>
</span><span class=lnt id=hl-109-14><a class=lnlinks href=#hl-109-14>14</a>
</span><span class=lnt id=hl-109-15><a class=lnlinks href=#hl-109-15>15</a>
</span><span class=lnt id=hl-109-16><a class=lnlinks href=#hl-109-16>16</a>
</span><span class=lnt id=hl-109-17><a class=lnlinks href=#hl-109-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyServlet</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=n>userService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserServiceImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userService</span><span class=p>.</span><span class=na>update</span><span class=p>(...);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 记录调用次数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>例3：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-110-1><a class=lnlinks href=#hl-110-1> 1</a>
</span><span class=lnt id=hl-110-2><a class=lnlinks href=#hl-110-2> 2</a>
</span><span class=lnt id=hl-110-3><a class=lnlinks href=#hl-110-3> 3</a>
</span><span class=lnt id=hl-110-4><a class=lnlinks href=#hl-110-4> 4</a>
</span><span class=lnt id=hl-110-5><a class=lnlinks href=#hl-110-5> 5</a>
</span><span class=lnt id=hl-110-6><a class=lnlinks href=#hl-110-6> 6</a>
</span><span class=lnt id=hl-110-7><a class=lnlinks href=#hl-110-7> 7</a>
</span><span class=lnt id=hl-110-8><a class=lnlinks href=#hl-110-8> 8</a>
</span><span class=lnt id=hl-110-9><a class=lnlinks href=#hl-110-9> 9</a>
</span><span class=lnt id=hl-110-10><a class=lnlinks href=#hl-110-10>10</a>
</span><span class=lnt id=hl-110-11><a class=lnlinks href=#hl-110-11>11</a>
</span><span class=lnt id=hl-110-12><a class=lnlinks href=#hl-110-12>12</a>
</span><span class=lnt id=hl-110-13><a class=lnlinks href=#hl-110-13>13</a>
</span><span class=lnt id=hl-110-14><a class=lnlinks href=#hl-110-14>14</a>
</span><span class=lnt id=hl-110-15><a class=lnlinks href=#hl-110-15>15</a>
</span><span class=lnt id=hl-110-16><a class=lnlinks href=#hl-110-16>16</a>
</span><span class=lnt id=hl-110-17><a class=lnlinks href=#hl-110-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Aspect</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyAspect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Before</span><span class=p>(</span><span class=s>&#34;execution(* *(..))&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>before</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@After</span><span class=p>(</span><span class=s>&#34;execution(* *(..))&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>after</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;cost time:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=o>-</span><span class=n>start</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>例4:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-111-1><a class=lnlinks href=#hl-111-1> 1</a>
</span><span class=lnt id=hl-111-2><a class=lnlinks href=#hl-111-2> 2</a>
</span><span class=lnt id=hl-111-3><a class=lnlinks href=#hl-111-3> 3</a>
</span><span class=lnt id=hl-111-4><a class=lnlinks href=#hl-111-4> 4</a>
</span><span class=lnt id=hl-111-5><a class=lnlinks href=#hl-111-5> 5</a>
</span><span class=lnt id=hl-111-6><a class=lnlinks href=#hl-111-6> 6</a>
</span><span class=lnt id=hl-111-7><a class=lnlinks href=#hl-111-7> 7</a>
</span><span class=lnt id=hl-111-8><a class=lnlinks href=#hl-111-8> 8</a>
</span><span class=lnt id=hl-111-9><a class=lnlinks href=#hl-111-9> 9</a>
</span><span class=lnt id=hl-111-10><a class=lnlinks href=#hl-111-10>10</a>
</span><span class=lnt id=hl-111-11><a class=lnlinks href=#hl-111-11>11</a>
</span><span class=lnt id=hl-111-12><a class=lnlinks href=#hl-111-12>12</a>
</span><span class=lnt id=hl-111-13><a class=lnlinks href=#hl-111-13>13</a>
</span><span class=lnt id=hl-111-14><a class=lnlinks href=#hl-111-14>14</a>
</span><span class=lnt id=hl-111-15><a class=lnlinks href=#hl-111-15>15</a>
</span><span class=lnt id=hl-111-16><a class=lnlinks href=#hl-111-16>16</a>
</span><span class=lnt id=hl-111-17><a class=lnlinks href=#hl-111-17>17</a>
</span><span class=lnt id=hl-111-18><a class=lnlinks href=#hl-111-18>18</a>
</span><span class=lnt id=hl-111-19><a class=lnlinks href=#hl-111-19>19</a>
</span><span class=lnt id=hl-111-20><a class=lnlinks href=#hl-111-20>20</a>
</span><span class=lnt id=hl-111-21><a class=lnlinks href=#hl-111-21>21</a>
</span><span class=lnt id=hl-111-22><a class=lnlinks href=#hl-111-22>22</a>
</span><span class=lnt id=hl-111-23><a class=lnlinks href=#hl-111-23>23</a>
</span><span class=lnt id=hl-111-24><a class=lnlinks href=#hl-111-24>24</a>
</span><span class=lnt id=hl-111-25><a class=lnlinks href=#hl-111-25>25</a>
</span><span class=lnt id=hl-111-26><a class=lnlinks href=#hl-111-26>26</a>
</span><span class=lnt id=hl-111-27><a class=lnlinks href=#hl-111-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyServlet</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=n>userService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserServiceImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userService</span><span class=p>.</span><span class=na>update</span><span class=p>(...);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=n>userDao</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserDaoImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userDao</span><span class=p>.</span><span class=na>update</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserDaoImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;update user set password = ? where username = ?&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 是否安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>Connection</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DriverManager</span><span class=p>.</span><span class=na>getConnection</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>例5:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-112-1><a class=lnlinks href=#hl-112-1> 1</a>
</span><span class=lnt id=hl-112-2><a class=lnlinks href=#hl-112-2> 2</a>
</span><span class=lnt id=hl-112-3><a class=lnlinks href=#hl-112-3> 3</a>
</span><span class=lnt id=hl-112-4><a class=lnlinks href=#hl-112-4> 4</a>
</span><span class=lnt id=hl-112-5><a class=lnlinks href=#hl-112-5> 5</a>
</span><span class=lnt id=hl-112-6><a class=lnlinks href=#hl-112-6> 6</a>
</span><span class=lnt id=hl-112-7><a class=lnlinks href=#hl-112-7> 7</a>
</span><span class=lnt id=hl-112-8><a class=lnlinks href=#hl-112-8> 8</a>
</span><span class=lnt id=hl-112-9><a class=lnlinks href=#hl-112-9> 9</a>
</span><span class=lnt id=hl-112-10><a class=lnlinks href=#hl-112-10>10</a>
</span><span class=lnt id=hl-112-11><a class=lnlinks href=#hl-112-11>11</a>
</span><span class=lnt id=hl-112-12><a class=lnlinks href=#hl-112-12>12</a>
</span><span class=lnt id=hl-112-13><a class=lnlinks href=#hl-112-13>13</a>
</span><span class=lnt id=hl-112-14><a class=lnlinks href=#hl-112-14>14</a>
</span><span class=lnt id=hl-112-15><a class=lnlinks href=#hl-112-15>15</a>
</span><span class=lnt id=hl-112-16><a class=lnlinks href=#hl-112-16>16</a>
</span><span class=lnt id=hl-112-17><a class=lnlinks href=#hl-112-17>17</a>
</span><span class=lnt id=hl-112-18><a class=lnlinks href=#hl-112-18>18</a>
</span><span class=lnt id=hl-112-19><a class=lnlinks href=#hl-112-19>19</a>
</span><span class=lnt id=hl-112-20><a class=lnlinks href=#hl-112-20>20</a>
</span><span class=lnt id=hl-112-21><a class=lnlinks href=#hl-112-21>21</a>
</span><span class=lnt id=hl-112-22><a class=lnlinks href=#hl-112-22>22</a>
</span><span class=lnt id=hl-112-23><a class=lnlinks href=#hl-112-23>23</a>
</span><span class=lnt id=hl-112-24><a class=lnlinks href=#hl-112-24>24</a>
</span><span class=lnt id=hl-112-25><a class=lnlinks href=#hl-112-25>25</a>
</span><span class=lnt id=hl-112-26><a class=lnlinks href=#hl-112-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyServlet</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=n>userService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserServiceImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userService</span><span class=p>.</span><span class=na>update</span><span class=p>(...);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=n>userDao</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserDaoImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userDao</span><span class=p>.</span><span class=na>update</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserDaoImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>SQLException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;update user set password = ? where username = ?&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DriverManager</span><span class=p>.</span><span class=na>getConnection</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>conn</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>例6：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-113-1><a class=lnlinks href=#hl-113-1> 1</a>
</span><span class=lnt id=hl-113-2><a class=lnlinks href=#hl-113-2> 2</a>
</span><span class=lnt id=hl-113-3><a class=lnlinks href=#hl-113-3> 3</a>
</span><span class=lnt id=hl-113-4><a class=lnlinks href=#hl-113-4> 4</a>
</span><span class=lnt id=hl-113-5><a class=lnlinks href=#hl-113-5> 5</a>
</span><span class=lnt id=hl-113-6><a class=lnlinks href=#hl-113-6> 6</a>
</span><span class=lnt id=hl-113-7><a class=lnlinks href=#hl-113-7> 7</a>
</span><span class=lnt id=hl-113-8><a class=lnlinks href=#hl-113-8> 8</a>
</span><span class=lnt id=hl-113-9><a class=lnlinks href=#hl-113-9> 9</a>
</span><span class=lnt id=hl-113-10><a class=lnlinks href=#hl-113-10>10</a>
</span><span class=lnt id=hl-113-11><a class=lnlinks href=#hl-113-11>11</a>
</span><span class=lnt id=hl-113-12><a class=lnlinks href=#hl-113-12>12</a>
</span><span class=lnt id=hl-113-13><a class=lnlinks href=#hl-113-13>13</a>
</span><span class=lnt id=hl-113-14><a class=lnlinks href=#hl-113-14>14</a>
</span><span class=lnt id=hl-113-15><a class=lnlinks href=#hl-113-15>15</a>
</span><span class=lnt id=hl-113-16><a class=lnlinks href=#hl-113-16>16</a>
</span><span class=lnt id=hl-113-17><a class=lnlinks href=#hl-113-17>17</a>
</span><span class=lnt id=hl-113-18><a class=lnlinks href=#hl-113-18>18</a>
</span><span class=lnt id=hl-113-19><a class=lnlinks href=#hl-113-19>19</a>
</span><span class=lnt id=hl-113-20><a class=lnlinks href=#hl-113-20>20</a>
</span><span class=lnt id=hl-113-21><a class=lnlinks href=#hl-113-21>21</a>
</span><span class=lnt id=hl-113-22><a class=lnlinks href=#hl-113-22>22</a>
</span><span class=lnt id=hl-113-23><a class=lnlinks href=#hl-113-23>23</a>
</span><span class=lnt id=hl-113-24><a class=lnlinks href=#hl-113-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyServlet</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=n>userService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserServiceImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userService</span><span class=p>.</span><span class=na>update</span><span class=p>(...);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>UserDao</span><span class=w> </span><span class=n>userDao</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserDaoImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userDao</span><span class=p>.</span><span class=na>update</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserDaoImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>SQLException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;update user set password = ? where username = ?&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DriverManager</span><span class=p>.</span><span class=na>getConnection</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>conn</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>例7:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-114-1><a class=lnlinks href=#hl-114-1> 1</a>
</span><span class=lnt id=hl-114-2><a class=lnlinks href=#hl-114-2> 2</a>
</span><span class=lnt id=hl-114-3><a class=lnlinks href=#hl-114-3> 3</a>
</span><span class=lnt id=hl-114-4><a class=lnlinks href=#hl-114-4> 4</a>
</span><span class=lnt id=hl-114-5><a class=lnlinks href=#hl-114-5> 5</a>
</span><span class=lnt id=hl-114-6><a class=lnlinks href=#hl-114-6> 6</a>
</span><span class=lnt id=hl-114-7><a class=lnlinks href=#hl-114-7> 7</a>
</span><span class=lnt id=hl-114-8><a class=lnlinks href=#hl-114-8> 8</a>
</span><span class=lnt id=hl-114-9><a class=lnlinks href=#hl-114-9> 9</a>
</span><span class=lnt id=hl-114-10><a class=lnlinks href=#hl-114-10>10</a>
</span><span class=lnt id=hl-114-11><a class=lnlinks href=#hl-114-11>11</a>
</span><span class=lnt id=hl-114-12><a class=lnlinks href=#hl-114-12>12</a>
</span><span class=lnt id=hl-114-13><a class=lnlinks href=#hl-114-13>13</a>
</span><span class=lnt id=hl-114-14><a class=lnlinks href=#hl-114-14>14</a>
</span><span class=lnt id=hl-114-15><a class=lnlinks href=#hl-114-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>bar</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 是否安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>foo</span><span class=p>(</span><span class=n>sdf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Test</span><span class=p>().</span><span class=na>bar</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>其中 foo 的行为是不确定的，可能导致不安全的发生，被称之为<strong>外星方法</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-115-1><a class=lnlinks href=#hl-115-1> 1</a>
</span><span class=lnt id=hl-115-2><a class=lnlinks href=#hl-115-2> 2</a>
</span><span class=lnt id=hl-115-3><a class=lnlinks href=#hl-115-3> 3</a>
</span><span class=lnt id=hl-115-4><a class=lnlinks href=#hl-115-4> 4</a>
</span><span class=lnt id=hl-115-5><a class=lnlinks href=#hl-115-5> 5</a>
</span><span class=lnt id=hl-115-6><a class=lnlinks href=#hl-115-6> 6</a>
</span><span class=lnt id=hl-115-7><a class=lnlinks href=#hl-115-7> 7</a>
</span><span class=lnt id=hl-115-8><a class=lnlinks href=#hl-115-8> 8</a>
</span><span class=lnt id=hl-115-9><a class=lnlinks href=#hl-115-9> 9</a>
</span><span class=lnt id=hl-115-10><a class=lnlinks href=#hl-115-10>10</a>
</span><span class=lnt id=hl-115-11><a class=lnlinks href=#hl-115-11>11</a>
</span><span class=lnt id=hl-115-12><a class=lnlinks href=#hl-115-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>dateStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;1999-10-11 00:00:00&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sdf</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=n>dateStr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ParseException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>请比较 JDK 中 String 类的实现</p><p>例8：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-116-1><a class=lnlinks href=#hl-116-1> 1</a>
</span><span class=lnt id=hl-116-2><a class=lnlinks href=#hl-116-2> 2</a>
</span><span class=lnt id=hl-116-3><a class=lnlinks href=#hl-116-3> 3</a>
</span><span class=lnt id=hl-116-4><a class=lnlinks href=#hl-116-4> 4</a>
</span><span class=lnt id=hl-116-5><a class=lnlinks href=#hl-116-5> 5</a>
</span><span class=lnt id=hl-116-6><a class=lnlinks href=#hl-116-6> 6</a>
</span><span class=lnt id=hl-116-7><a class=lnlinks href=#hl-116-7> 7</a>
</span><span class=lnt id=hl-116-8><a class=lnlinks href=#hl-116-8> 8</a>
</span><span class=lnt id=hl-116-9><a class=lnlinks href=#hl-116-9> 9</a>
</span><span class=lnt id=hl-116-10><a class=lnlinks href=#hl-116-10>10</a>
</span><span class=lnt id=hl-116-11><a class=lnlinks href=#hl-116-11>11</a>
</span><span class=lnt id=hl-116-12><a class=lnlinks href=#hl-116-12>12</a>
</span><span class=lnt id=hl-116-13><a class=lnlinks href=#hl-116-13>13</a>
</span><span class=lnt id=hl-116-14><a class=lnlinks href=#hl-116-14>14</a>
</span><span class=lnt id=hl-116-15><a class=lnlinks href=#hl-116-15>15</a>
</span><span class=lnt id=hl-116-16><a class=lnlinks href=#hl-116-16>16</a>
</span><span class=lnt id=hl-116-17><a class=lnlinks href=#hl-116-17>17</a>
</span><span class=lnt id=hl-116-18><a class=lnlinks href=#hl-116-18>18</a>
</span><span class=lnt id=hl-116-19><a class=lnlinks href=#hl-116-19>19</a>
</span><span class=lnt id=hl-116-20><a class=lnlinks href=#hl-116-20>20</a>
</span><span class=lnt id=hl-116-21><a class=lnlinks href=#hl-116-21>21</a>
</span><span class=lnt id=hl-116-22><a class=lnlinks href=#hl-116-22>22</a>
</span><span class=lnt id=hl-116-23><a class=lnlinks href=#hl-116-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>i</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>j</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>thread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>list</span><span class=p>.</span><span class=na>stream</span><span class=p>().</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>list</span><span class=p>.</span><span class=na>stream</span><span class=p>().</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=45-习题><a href=#45-%e4%b9%a0%e9%a2%98 class=header-anchor>#</a>
4.5 习题</h2><h5 id=卖票练习><a href=#%e5%8d%96%e7%a5%a8%e7%bb%83%e4%b9%a0 class=header-anchor>#</a>
卖票练习</h5><p>测试下面代码是否存在线程安全问题，并尝试改正</p><ul><li>将sell方法声明为synchronized即可</li><li>注意只将对count进行修改的一行代码用synchronized括起来也不行。对count大小的判断也必须是为原子操作的一部分，否则也会导致count值异常。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-117-1><a class=lnlinks href=#hl-117-1> 1</a>
</span><span class=lnt id=hl-117-2><a class=lnlinks href=#hl-117-2> 2</a>
</span><span class=lnt id=hl-117-3><a class=lnlinks href=#hl-117-3> 3</a>
</span><span class=lnt id=hl-117-4><a class=lnlinks href=#hl-117-4> 4</a>
</span><span class=lnt id=hl-117-5><a class=lnlinks href=#hl-117-5> 5</a>
</span><span class=lnt id=hl-117-6><a class=lnlinks href=#hl-117-6> 6</a>
</span><span class=lnt id=hl-117-7><a class=lnlinks href=#hl-117-7> 7</a>
</span><span class=lnt id=hl-117-8><a class=lnlinks href=#hl-117-8> 8</a>
</span><span class=lnt id=hl-117-9><a class=lnlinks href=#hl-117-9> 9</a>
</span><span class=lnt id=hl-117-10><a class=lnlinks href=#hl-117-10>10</a>
</span><span class=lnt id=hl-117-11><a class=lnlinks href=#hl-117-11>11</a>
</span><span class=lnt id=hl-117-12><a class=lnlinks href=#hl-117-12>12</a>
</span><span class=lnt id=hl-117-13><a class=lnlinks href=#hl-117-13>13</a>
</span><span class=lnt id=hl-117-14><a class=lnlinks href=#hl-117-14>14</a>
</span><span class=lnt id=hl-117-15><a class=lnlinks href=#hl-117-15>15</a>
</span><span class=lnt id=hl-117-16><a class=lnlinks href=#hl-117-16>16</a>
</span><span class=lnt id=hl-117-17><a class=lnlinks href=#hl-117-17>17</a>
</span><span class=lnt id=hl-117-18><a class=lnlinks href=#hl-117-18>18</a>
</span><span class=lnt id=hl-117-19><a class=lnlinks href=#hl-117-19>19</a>
</span><span class=lnt id=hl-117-20><a class=lnlinks href=#hl-117-20>20</a>
</span><span class=lnt id=hl-117-21><a class=lnlinks href=#hl-117-21>21</a>
</span><span class=lnt id=hl-117-22><a class=lnlinks href=#hl-117-22>22</a>
</span><span class=lnt id=hl-117-23><a class=lnlinks href=#hl-117-23>23</a>
</span><span class=lnt id=hl-117-24><a class=lnlinks href=#hl-117-24>24</a>
</span><span class=lnt id=hl-117-25><a class=lnlinks href=#hl-117-25>25</a>
</span><span class=lnt id=hl-117-26><a class=lnlinks href=#hl-117-26>26</a>
</span><span class=lnt id=hl-117-27><a class=lnlinks href=#hl-117-27>27</a>
</span><span class=lnt id=hl-117-28><a class=lnlinks href=#hl-117-28>28</a>
</span><span class=lnt id=hl-117-29><a class=lnlinks href=#hl-117-29>29</a>
</span><span class=lnt id=hl-117-30><a class=lnlinks href=#hl-117-30>30</a>
</span><span class=lnt id=hl-117-31><a class=lnlinks href=#hl-117-31>31</a>
</span><span class=lnt id=hl-117-32><a class=lnlinks href=#hl-117-32>32</a>
</span><span class=lnt id=hl-117-33><a class=lnlinks href=#hl-117-33>33</a>
</span><span class=lnt id=hl-117-34><a class=lnlinks href=#hl-117-34>34</a>
</span><span class=lnt id=hl-117-35><a class=lnlinks href=#hl-117-35>35</a>
</span><span class=lnt id=hl-117-36><a class=lnlinks href=#hl-117-36>36</a>
</span><span class=lnt id=hl-117-37><a class=lnlinks href=#hl-117-37>37</a>
</span><span class=lnt id=hl-117-38><a class=lnlinks href=#hl-117-38>38</a>
</span><span class=lnt id=hl-117-39><a class=lnlinks href=#hl-117-39>39</a>
</span><span class=lnt id=hl-117-40><a class=lnlinks href=#hl-117-40>40</a>
</span><span class=lnt id=hl-117-41><a class=lnlinks href=#hl-117-41>41</a>
</span><span class=lnt id=hl-117-42><a class=lnlinks href=#hl-117-42>42</a>
</span><span class=lnt id=hl-117-43><a class=lnlinks href=#hl-117-43>43</a>
</span><span class=lnt id=hl-117-44><a class=lnlinks href=#hl-117-44>44</a>
</span><span class=lnt id=hl-117-45><a class=lnlinks href=#hl-117-45>45</a>
</span><span class=lnt id=hl-117-46><a class=lnlinks href=#hl-117-46>46</a>
</span><span class=lnt id=hl-117-47><a class=lnlinks href=#hl-117-47>47</a>
</span><span class=lnt id=hl-117-48><a class=lnlinks href=#hl-117-48>48</a>
</span><span class=lnt id=hl-117-49><a class=lnlinks href=#hl-117-49>49</a>
</span><span class=lnt id=hl-117-50><a class=lnlinks href=#hl-117-50>50</a>
</span><span class=lnt id=hl-117-51><a class=lnlinks href=#hl-117-51>51</a>
</span><span class=lnt id=hl-117-52><a class=lnlinks href=#hl-117-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ExerciseSell</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TicketWindow</span><span class=w> </span><span class=n>ticketWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TicketWindow</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 用来存储买出去多少张票</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>sellCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Vector</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>2000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 分析这里的竞态条件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ticketWindow</span><span class=p>.</span><span class=na>sell</span><span class=p>(</span><span class=n>randomAmount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sellCount</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>forEach</span><span class=p>((</span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 买出去的票求和</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;selled count:{}&#34;</span><span class=p>,</span><span class=n>sellCount</span><span class=p>.</span><span class=na>stream</span><span class=p>().</span><span class=na>mapToInt</span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>c</span><span class=p>).</span><span class=na>sum</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 剩余票数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;remainder count:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ticketWindow</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Random 为线程安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Random</span><span class=w> </span><span class=n>random</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 随机 1~5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>randomAmount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>5</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>TicketWindow</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>TicketWindow</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//在方法上加一个synchronized即可</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>sell</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>    
</span></span></span></code></pre></td></tr></table></div></div><p>另外，用下面的代码行不行，为什么？</p><ul><li>不行，因为sellCount会被多个线程共享，必须使用线程安全的实现类。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-118-1><a class=lnlinks href=#hl-118-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>sellCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-119-1><a class=lnlinks href=#hl-119-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=k>for</span> /L %n in <span class=o>(</span>1,1,10<span class=o>)</span> <span class=k>do</span> java -cp <span class=s2>&#34;.;C:\Users\manyh\.m2\repository\ch\qos\logback\logbackclassic\1.2.3\logback-classic-1.2.3.jar;C:\Users\manyh\.m2\repository\ch\qos\logback\logbackcore\1.2.3\logback-core-1.2.3.jar;C:\Users\manyh\.m2\repository\org\slf4j\slf4japi\1.7.25\slf4j-api-1.7.25.jar&#34;</span> cn.itcast.n4.exercise.ExerciseSell
</span></span></code></pre></td></tr></table></div></div><p>说明：</p><ul><li>两段没有前后因果关系的临界区代码，只需要保证各自的原子性即可，不需要括起来。</li></ul><h5 id=转账练习><a href=#%e8%bd%ac%e8%b4%a6%e7%bb%83%e4%b9%a0 class=header-anchor>#</a>
转账练习</h5><p>测试下面代码是否存在线程安全问题，并尝试改正</p><ul><li>将transfer方法的方法体用同步代码块包裹，将当Account.class设为锁对象。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-120-1><a class=lnlinks href=#hl-120-1> 1</a>
</span><span class=lnt id=hl-120-2><a class=lnlinks href=#hl-120-2> 2</a>
</span><span class=lnt id=hl-120-3><a class=lnlinks href=#hl-120-3> 3</a>
</span><span class=lnt id=hl-120-4><a class=lnlinks href=#hl-120-4> 4</a>
</span><span class=lnt id=hl-120-5><a class=lnlinks href=#hl-120-5> 5</a>
</span><span class=lnt id=hl-120-6><a class=lnlinks href=#hl-120-6> 6</a>
</span><span class=lnt id=hl-120-7><a class=lnlinks href=#hl-120-7> 7</a>
</span><span class=lnt id=hl-120-8><a class=lnlinks href=#hl-120-8> 8</a>
</span><span class=lnt id=hl-120-9><a class=lnlinks href=#hl-120-9> 9</a>
</span><span class=lnt id=hl-120-10><a class=lnlinks href=#hl-120-10>10</a>
</span><span class=lnt id=hl-120-11><a class=lnlinks href=#hl-120-11>11</a>
</span><span class=lnt id=hl-120-12><a class=lnlinks href=#hl-120-12>12</a>
</span><span class=lnt id=hl-120-13><a class=lnlinks href=#hl-120-13>13</a>
</span><span class=lnt id=hl-120-14><a class=lnlinks href=#hl-120-14>14</a>
</span><span class=lnt id=hl-120-15><a class=lnlinks href=#hl-120-15>15</a>
</span><span class=lnt id=hl-120-16><a class=lnlinks href=#hl-120-16>16</a>
</span><span class=lnt id=hl-120-17><a class=lnlinks href=#hl-120-17>17</a>
</span><span class=lnt id=hl-120-18><a class=lnlinks href=#hl-120-18>18</a>
</span><span class=lnt id=hl-120-19><a class=lnlinks href=#hl-120-19>19</a>
</span><span class=lnt id=hl-120-20><a class=lnlinks href=#hl-120-20>20</a>
</span><span class=lnt id=hl-120-21><a class=lnlinks href=#hl-120-21>21</a>
</span><span class=lnt id=hl-120-22><a class=lnlinks href=#hl-120-22>22</a>
</span><span class=lnt id=hl-120-23><a class=lnlinks href=#hl-120-23>23</a>
</span><span class=lnt id=hl-120-24><a class=lnlinks href=#hl-120-24>24</a>
</span><span class=lnt id=hl-120-25><a class=lnlinks href=#hl-120-25>25</a>
</span><span class=lnt id=hl-120-26><a class=lnlinks href=#hl-120-26>26</a>
</span><span class=lnt id=hl-120-27><a class=lnlinks href=#hl-120-27>27</a>
</span><span class=lnt id=hl-120-28><a class=lnlinks href=#hl-120-28>28</a>
</span><span class=lnt id=hl-120-29><a class=lnlinks href=#hl-120-29>29</a>
</span><span class=lnt id=hl-120-30><a class=lnlinks href=#hl-120-30>30</a>
</span><span class=lnt id=hl-120-31><a class=lnlinks href=#hl-120-31>31</a>
</span><span class=lnt id=hl-120-32><a class=lnlinks href=#hl-120-32>32</a>
</span><span class=lnt id=hl-120-33><a class=lnlinks href=#hl-120-33>33</a>
</span><span class=lnt id=hl-120-34><a class=lnlinks href=#hl-120-34>34</a>
</span><span class=lnt id=hl-120-35><a class=lnlinks href=#hl-120-35>35</a>
</span><span class=lnt id=hl-120-36><a class=lnlinks href=#hl-120-36>36</a>
</span><span class=lnt id=hl-120-37><a class=lnlinks href=#hl-120-37>37</a>
</span><span class=lnt id=hl-120-38><a class=lnlinks href=#hl-120-38>38</a>
</span><span class=lnt id=hl-120-39><a class=lnlinks href=#hl-120-39>39</a>
</span><span class=lnt id=hl-120-40><a class=lnlinks href=#hl-120-40>40</a>
</span><span class=lnt id=hl-120-41><a class=lnlinks href=#hl-120-41>41</a>
</span><span class=lnt id=hl-120-42><a class=lnlinks href=#hl-120-42>42</a>
</span><span class=lnt id=hl-120-43><a class=lnlinks href=#hl-120-43>43</a>
</span><span class=lnt id=hl-120-44><a class=lnlinks href=#hl-120-44>44</a>
</span><span class=lnt id=hl-120-45><a class=lnlinks href=#hl-120-45>45</a>
</span><span class=lnt id=hl-120-46><a class=lnlinks href=#hl-120-46>46</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ExerciseTransfer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Account</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Account</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Account</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Account</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>a</span><span class=p>.</span><span class=na>transfer</span><span class=p>(</span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>randomAmount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>b</span><span class=p>.</span><span class=na>transfer</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>randomAmount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 查看转账2000次后的总金额</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;total:{}&#34;</span><span class=p>,(</span><span class=n>a</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Random 为线程安全</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Random</span><span class=w> </span><span class=n>random</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 随机 1~100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>randomAmount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>100</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Account</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Account</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>money</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>money</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getMoney</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setMoney</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>money</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>money</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>transfer</span><span class=p>(</span><span class=n>Account</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>money</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>setMoney</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>target</span><span class=p>.</span><span class=na>setMoney</span><span class=p>(</span><span class=n>target</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这样改正行不行，为什么？</p><ul><li>不行，因为不同线程调用此方法，将会锁住不同的对象</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-121-1><a class=lnlinks href=#hl-121-1>1</a>
</span><span class=lnt id=hl-121-2><a class=lnlinks href=#hl-121-2>2</a>
</span><span class=lnt id=hl-121-3><a class=lnlinks href=#hl-121-3>3</a>
</span><span class=lnt id=hl-121-4><a class=lnlinks href=#hl-121-4>4</a>
</span><span class=lnt id=hl-121-5><a class=lnlinks href=#hl-121-5>5</a>
</span><span class=lnt id=hl-121-6><a class=lnlinks href=#hl-121-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>transfer</span><span class=p>(</span><span class=n>Account</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>money</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>setMoney</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>target</span><span class=p>.</span><span class=na>setMoney</span><span class=p>(</span><span class=n>target</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=46-monitor-概念><a href=#46-monitor-%e6%a6%82%e5%bf%b5 class=header-anchor>#</a>
4.6 Monitor 概念</h2><h3 id=java-对象头><a href=#java-%e5%af%b9%e8%b1%a1%e5%a4%b4 class=header-anchor>#</a>
<strong>Java 对象头</strong></h3><p>以 32 位虚拟机为例</p><p>普通对象</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-122-1><a class=lnlinks href=#hl-122-1>1</a>
</span><span class=lnt id=hl-122-2><a class=lnlinks href=#hl-122-2>2</a>
</span><span class=lnt id=hl-122-3><a class=lnlinks href=#hl-122-3>3</a>
</span><span class=lnt id=hl-122-4><a class=lnlinks href=#hl-122-4>4</a>
</span><span class=lnt id=hl-122-5><a class=lnlinks href=#hl-122-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>|--------------------------------------------------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                    <span class=no>Object</span> <span class=no>Header</span> <span class=p>(</span><span class=mi>64</span> <span class=n>bits</span><span class=p>)</span>                   <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|------------------------------------|-------------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>       <span class=no>Mark</span> <span class=no>Word</span> <span class=p>(</span><span class=mi>32</span> <span class=n>bits</span><span class=p>)</span>          <span class=o>|</span>   <span class=no>Klass</span> <span class=no>Word</span> <span class=p>(</span><span class=mi>32</span> <span class=n>bits</span><span class=p>)</span>  <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|------------------------------------|-------------------------|</span>
</span></span></code></pre></td></tr></table></div></div><p>数组对象</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-123-1><a class=lnlinks href=#hl-123-1>1</a>
</span><span class=lnt id=hl-123-2><a class=lnlinks href=#hl-123-2>2</a>
</span><span class=lnt id=hl-123-3><a class=lnlinks href=#hl-123-3>3</a>
</span><span class=lnt id=hl-123-4><a class=lnlinks href=#hl-123-4>4</a>
</span><span class=lnt id=hl-123-5><a class=lnlinks href=#hl-123-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>|---------------------------------------------------------------------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                             <span class=no>Object</span> <span class=no>Header</span> <span class=p>(</span><span class=mi>96</span> <span class=n>bits</span><span class=p>)</span>                             <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------|-----------------------|------------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>        <span class=no>Mark</span> <span class=no>Word</span><span class=p>(</span><span class=mi>32</span><span class=n>bits</span><span class=p>)</span>       <span class=o>|</span>   <span class=no>Klass</span> <span class=no>Word</span><span class=p>(</span><span class=mi>32</span><span class=n>bits</span><span class=p>)</span>  <span class=o>|</span>  <span class=n>array</span> <span class=n>length</span><span class=p>(</span><span class=mi>32</span><span class=n>bits</span><span class=p>)</span>  <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------|-----------------------|------------------------|</span>
</span></span></code></pre></td></tr></table></div></div><p>其中 Mark Word 结构为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-124-1><a class=lnlinks href=#hl-124-1> 1</a>
</span><span class=lnt id=hl-124-2><a class=lnlinks href=#hl-124-2> 2</a>
</span><span class=lnt id=hl-124-3><a class=lnlinks href=#hl-124-3> 3</a>
</span><span class=lnt id=hl-124-4><a class=lnlinks href=#hl-124-4> 4</a>
</span><span class=lnt id=hl-124-5><a class=lnlinks href=#hl-124-5> 5</a>
</span><span class=lnt id=hl-124-6><a class=lnlinks href=#hl-124-6> 6</a>
</span><span class=lnt id=hl-124-7><a class=lnlinks href=#hl-124-7> 7</a>
</span><span class=lnt id=hl-124-8><a class=lnlinks href=#hl-124-8> 8</a>
</span><span class=lnt id=hl-124-9><a class=lnlinks href=#hl-124-9> 9</a>
</span><span class=lnt id=hl-124-10><a class=lnlinks href=#hl-124-10>10</a>
</span><span class=lnt id=hl-124-11><a class=lnlinks href=#hl-124-11>11</a>
</span><span class=lnt id=hl-124-12><a class=lnlinks href=#hl-124-12>12</a>
</span><span class=lnt id=hl-124-13><a class=lnlinks href=#hl-124-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                  <span class=no>Mark</span> <span class=no>Word</span> <span class=p>(</span><span class=mi>32</span> <span class=n>bits</span><span class=p>)</span>                  <span class=o>|</span>        <span class=no>State</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>    <span class=ss>hashcode</span><span class=p>:</span><span class=mi>25</span>  <span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span>   <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>0</span>   <span class=o>|</span>   <span class=mo>01</span>    <span class=o>|</span>       <span class=no>Normal</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span><span class=ss>thread</span><span class=p>:</span><span class=mi>23</span><span class=o>|</span><span class=ss>epoch</span><span class=p>:</span><span class=mi>2</span><span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span>   <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>1</span>   <span class=o>|</span>   <span class=mo>01</span>    <span class=o>|</span>       <span class=no>Biased</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>          <span class=ss>ptr_to_lock_record</span><span class=p>:</span><span class=mi>30</span>              <span class=o>|</span>   <span class=mo>00</span>    <span class=o>|</span> <span class=no>Lightweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>          <span class=ss>ptr_to_heavyweight_monitor</span><span class=p>:</span><span class=mi>30</span>      <span class=o>|</span>   <span class=mi>10</span>    <span class=o>|</span> <span class=no>Heavyweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                                             <span class=o>|</span>   <span class=mi>11</span>    <span class=o>|</span>    <span class=no>Marked</span> <span class=k>for</span> <span class=no>GC</span>   <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span></code></pre></td></tr></table></div></div><p>64 位虚拟机 Mark Word</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-125-1><a class=lnlinks href=#hl-125-1> 1</a>
</span><span class=lnt id=hl-125-2><a class=lnlinks href=#hl-125-2> 2</a>
</span><span class=lnt id=hl-125-3><a class=lnlinks href=#hl-125-3> 3</a>
</span><span class=lnt id=hl-125-4><a class=lnlinks href=#hl-125-4> 4</a>
</span><span class=lnt id=hl-125-5><a class=lnlinks href=#hl-125-5> 5</a>
</span><span class=lnt id=hl-125-6><a class=lnlinks href=#hl-125-6> 6</a>
</span><span class=lnt id=hl-125-7><a class=lnlinks href=#hl-125-7> 7</a>
</span><span class=lnt id=hl-125-8><a class=lnlinks href=#hl-125-8> 8</a>
</span><span class=lnt id=hl-125-9><a class=lnlinks href=#hl-125-9> 9</a>
</span><span class=lnt id=hl-125-10><a class=lnlinks href=#hl-125-10>10</a>
</span><span class=lnt id=hl-125-11><a class=lnlinks href=#hl-125-11>11</a>
</span><span class=lnt id=hl-125-12><a class=lnlinks href=#hl-125-12>12</a>
</span><span class=lnt id=hl-125-13><a class=lnlinks href=#hl-125-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                          <span class=no>Mark</span> <span class=no>Word</span> <span class=p>(</span><span class=mi>64</span> <span class=n>bits</span><span class=p>)</span>                       <span class=o>|</span>        <span class=no>State</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>25</span> <span class=o>|</span> <span class=ss>hashcode</span><span class=p>:</span><span class=mi>31</span> <span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span> <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>0</span> <span class=o>|</span>  <span class=mo>01</span>   <span class=o>|</span>        <span class=no>Normal</span>      <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=ss>thread</span><span class=p>:</span><span class=mi>54</span> <span class=o>|</span>   <span class=ss>epoch</span><span class=p>:</span><span class=mi>2</span>   <span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span> <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span>  <span class=mo>01</span>   <span class=o>|</span>        <span class=no>Biased</span>      <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                    <span class=ss>ptr_to_lock_record</span><span class=p>:</span><span class=mi>62</span>                   <span class=o>|</span>  <span class=mo>00</span>   <span class=o>|</span> <span class=no>Lightweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                 <span class=ss>ptr_to_heavyweight_monitor</span><span class=p>:</span><span class=mi>62</span>              <span class=o>|</span>  <span class=mi>10</span>   <span class=o>|</span> <span class=no>Heavyweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                                                            <span class=o>|</span>  <span class=mi>11</span>   <span class=o>|</span>    <span class=no>Marked</span> <span class=k>for</span> <span class=no>GC</span>   <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>参考资料</p><p><a class=link href=https://stackoverflow.com/questions/26357186/what-is-in-java-object-header target=_blank rel=noopener>https://stackoverflow.com/questions/26357186/what-is-in-java-object-header
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></blockquote><h3 id=font-colorblue-原理之monitor锁font><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8bmonitor%e9%94%81font class=header-anchor>#</a>
<font color=blue>* 原理之Monitor(锁)</font></h3><p>Monitor 被翻译为<strong>监视器</strong>或<strong>管程</strong></p><p>每个 Java 对象都可以关联一个 Monitor 对象，如果使用 synchronized 给对象上锁（重量级）之后，该对象头的 Mark Word 中就被设置指向 Monitor 对象的指针</p><p>Monitor 结构如下</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317181913745.png width=900 height=600 loading=lazy decoding=async alt=image-20220317181913745 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>刚开始 Monitor 中 Owner 为 null</li><li>当 Thread-2 执行 synchronized(obj) 就会将 Monitor 的所有者 Owner 置为 Thread-2，Monitor中只能有一 个 Owner</li><li>在 Thread-2 上锁的过程中，如果 Thread-3，Thread-4，Thread-5 也来执行 synchronized(obj)，就会进入 EntryList BLOCKED</li><li>Thread-2 执行完同步代码块的内容，然后唤醒 EntryList 中等待的线程来竞争锁，竞争的时是非公平的</li><li>图中 WaitSet 中的 Thread-0，Thread-1 是之前获得过锁，但条件不满足进入 WAITING 状态的线程，后面讲 wait-notify 时会分析</li></ul><blockquote><p><strong>注意</strong>：</p><ul><li>synchronized 必须是进入同一个对象的 monitor 才有上述的效果</li><li>不加 synchronized 的对象不会关联监视器，不遵从以上规则</li></ul></blockquote><h3 id=font-colorblue-原理之-synchronizedfont><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-synchronizedfont class=header-anchor>#</a>
<font color=blue>* 原理之 synchronized</font></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-126-1><a class=lnlinks href=#hl-126-1>1</a>
</span><span class=lnt id=hl-126-2><a class=lnlinks href=#hl-126-2>2</a>
</span><span class=lnt id=hl-126-3><a class=lnlinks href=#hl-126-3>3</a>
</span><span class=lnt id=hl-126-4><a class=lnlinks href=#hl-126-4>4</a>
</span><span class=lnt id=hl-126-5><a class=lnlinks href=#hl-126-5>5</a>
</span><span class=lnt id=hl-126-6><a class=lnlinks href=#hl-126-6>6</a>
</span><span class=lnt id=hl-126-7><a class=lnlinks href=#hl-126-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>counter</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>对应的字节码为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-127-1><a class=lnlinks href=#hl-127-1> 1</a>
</span><span class=lnt id=hl-127-2><a class=lnlinks href=#hl-127-2> 2</a>
</span><span class=lnt id=hl-127-3><a class=lnlinks href=#hl-127-3> 3</a>
</span><span class=lnt id=hl-127-4><a class=lnlinks href=#hl-127-4> 4</a>
</span><span class=lnt id=hl-127-5><a class=lnlinks href=#hl-127-5> 5</a>
</span><span class=lnt id=hl-127-6><a class=lnlinks href=#hl-127-6> 6</a>
</span><span class=lnt id=hl-127-7><a class=lnlinks href=#hl-127-7> 7</a>
</span><span class=lnt id=hl-127-8><a class=lnlinks href=#hl-127-8> 8</a>
</span><span class=lnt id=hl-127-9><a class=lnlinks href=#hl-127-9> 9</a>
</span><span class=lnt id=hl-127-10><a class=lnlinks href=#hl-127-10>10</a>
</span><span class=lnt id=hl-127-11><a class=lnlinks href=#hl-127-11>11</a>
</span><span class=lnt id=hl-127-12><a class=lnlinks href=#hl-127-12>12</a>
</span><span class=lnt id=hl-127-13><a class=lnlinks href=#hl-127-13>13</a>
</span><span class=lnt id=hl-127-14><a class=lnlinks href=#hl-127-14>14</a>
</span><span class=lnt id=hl-127-15><a class=lnlinks href=#hl-127-15>15</a>
</span><span class=lnt id=hl-127-16><a class=lnlinks href=#hl-127-16>16</a>
</span><span class=lnt id=hl-127-17><a class=lnlinks href=#hl-127-17>17</a>
</span><span class=lnt id=hl-127-18><a class=lnlinks href=#hl-127-18>18</a>
</span><span class=lnt id=hl-127-19><a class=lnlinks href=#hl-127-19>19</a>
</span><span class=lnt id=hl-127-20><a class=lnlinks href=#hl-127-20>20</a>
</span><span class=lnt id=hl-127-21><a class=lnlinks href=#hl-127-21>21</a>
</span><span class=lnt id=hl-127-22><a class=lnlinks href=#hl-127-22>22</a>
</span><span class=lnt id=hl-127-23><a class=lnlinks href=#hl-127-23>23</a>
</span><span class=lnt id=hl-127-24><a class=lnlinks href=#hl-127-24>24</a>
</span><span class=lnt id=hl-127-25><a class=lnlinks href=#hl-127-25>25</a>
</span><span class=lnt id=hl-127-26><a class=lnlinks href=#hl-127-26>26</a>
</span><span class=lnt id=hl-127-27><a class=lnlinks href=#hl-127-27>27</a>
</span><span class=lnt id=hl-127-28><a class=lnlinks href=#hl-127-28>28</a>
</span><span class=lnt id=hl-127-29><a class=lnlinks href=#hl-127-29>29</a>
</span><span class=lnt id=hl-127-30><a class=lnlinks href=#hl-127-30>30</a>
</span><span class=lnt id=hl-127-31><a class=lnlinks href=#hl-127-31>31</a>
</span><span class=lnt id=hl-127-32><a class=lnlinks href=#hl-127-32>32</a>
</span><span class=lnt id=hl-127-33><a class=lnlinks href=#hl-127-33>33</a>
</span><span class=lnt id=hl-127-34><a class=lnlinks href=#hl-127-34>34</a>
</span><span class=lnt id=hl-127-35><a class=lnlinks href=#hl-127-35>35</a>
</span><span class=lnt id=hl-127-36><a class=lnlinks href=#hl-127-36>36</a>
</span><span class=lnt id=hl-127-37><a class=lnlinks href=#hl-127-37>37</a>
</span><span class=lnt id=hl-127-38><a class=lnlinks href=#hl-127-38>38</a>
</span><span class=lnt id=hl-127-39><a class=lnlinks href=#hl-127-39>39</a>
</span><span class=lnt id=hl-127-40><a class=lnlinks href=#hl-127-40>40</a>
</span><span class=lnt id=hl-127-41><a class=lnlinks href=#hl-127-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=o>[]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>descriptor</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=o>[</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>String</span><span class=p>;)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>flags</span><span class=p>:</span><span class=w> </span><span class=n>ACC_PUBLIC</span><span class=p>,</span><span class=w> </span><span class=n>ACC_STATIC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>stack</span><span class=o>=</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>locals</span><span class=o>=</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>args_size</span><span class=o>=</span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>getstatic</span><span class=w> </span><span class=err>#</span><span class=n>2</span><span class=w> </span><span class=c1>// &lt;- lock引用 （synchronized开始）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>3</span><span class=p>:</span><span class=w> </span><span class=n>dup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>4</span><span class=p>:</span><span class=w> </span><span class=n>astore_1</span><span class=w> </span><span class=c1>// lock引用 -&gt; slot 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>5</span><span class=p>:</span><span class=w> </span><span class=n>monitorenter</span><span class=w> </span><span class=c1>// 将 lock对象 MarkWord 置为 Monitor 指针</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>6</span><span class=p>:</span><span class=w> </span><span class=n>getstatic</span><span class=w> </span><span class=err>#</span><span class=n>3</span><span class=w> </span><span class=c1>// &lt;- i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>9</span><span class=p>:</span><span class=w> </span><span class=n>iconst_1</span><span class=w> </span><span class=c1>// 准备常数 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>10</span><span class=p>:</span><span class=w> </span><span class=n>iadd</span><span class=w> </span><span class=c1>// +1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>11</span><span class=p>:</span><span class=w> </span><span class=n>putstatic</span><span class=w> </span><span class=err>#</span><span class=n>3</span><span class=w> </span><span class=c1>// -&gt; i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>14</span><span class=p>:</span><span class=w> </span><span class=n>aload_1</span><span class=w> </span><span class=c1>// &lt;- lock引用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>15</span><span class=p>:</span><span class=w> </span><span class=n>monitorexit</span><span class=w> </span><span class=c1>// 将 lock对象 MarkWord 重置, 唤醒 EntryList</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>16</span><span class=p>:</span><span class=w> </span><span class=k>goto</span><span class=w> </span><span class=n>24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>19</span><span class=p>:</span><span class=w> </span><span class=n>astore_2</span><span class=w> </span><span class=c1>// e -&gt; slot 2 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>20</span><span class=p>:</span><span class=w> </span><span class=n>aload_1</span><span class=w> </span><span class=c1>// &lt;- lock引用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>21</span><span class=p>:</span><span class=w> </span><span class=n>monitorexit</span><span class=w> </span><span class=c1>// 将 lock对象 MarkWord 重置, 唤醒 EntryList</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>22</span><span class=p>:</span><span class=w> </span><span class=n>aload_2</span><span class=w> </span><span class=c1>// &lt;- slot 2 (e)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>23</span><span class=p>:</span><span class=w> </span><span class=n>athrow</span><span class=w> </span><span class=c1>// throw e</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>24</span><span class=p>:</span><span class=w> </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>Exception</span><span class=w> </span><span class=n>table</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>from</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=n>type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>6</span><span class=w>    </span><span class=n>16</span><span class=w>  </span><span class=n>19</span><span class=w>    </span><span class=n>any</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>19</span><span class=w>   </span><span class=n>22</span><span class=w>  </span><span class=n>19</span><span class=w>    </span><span class=n>any</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>LineNumberTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>line</span><span class=w> </span><span class=n>8</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>line</span><span class=w> </span><span class=n>9</span><span class=p>:</span><span class=w> </span><span class=n>6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>line</span><span class=w> </span><span class=n>10</span><span class=p>:</span><span class=w> </span><span class=n>14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>line</span><span class=w> </span><span class=n>11</span><span class=p>:</span><span class=w> </span><span class=n>24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>LocalVariableTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>Start</span><span class=w> </span><span class=n>Length</span><span class=w> </span><span class=n>Slot</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=n>Signature</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>0</span><span class=w>     </span><span class=n>25</span><span class=w>     </span><span class=n>0</span><span class=w>    </span><span class=n>args</span><span class=w> </span><span class=o>[</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>String</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>StackMapTable</span><span class=p>:</span><span class=w> </span><span class=n>number_of_entries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>frame_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>255</span><span class=w> </span><span class=cm>/* full_frame */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>offset_delta</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>locals</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=w> </span><span class=kd>class</span> <span class=err>&#34;[</span><span class=nc>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>String</span><span class=p>;</span><span class=s>&#34;, class java/lang/Object ]
</span></span></span><span class=line><span class=cl><span class=s>              stack = [ class java/lang/Throwable ]
</span></span></span><span class=line><span class=cl><span class=s>              frame_type = 250 /* chop */
</span></span></span><span class=line><span class=cl><span class=s>              offset_delta = 4
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p><p>方法级别的 synchronized 不会在字节码指令中有所体现</p></blockquote><h3 id=font-colorblue-原理之-synchronized-进阶font><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-synchronized-%e8%bf%9b%e9%98%b6font class=header-anchor>#</a>
<font color=blue>* 原理之 synchronized 进阶</font></h3><h4 id=轻量级锁><a href=#%e8%bd%bb%e9%87%8f%e7%ba%a7%e9%94%81 class=header-anchor>#</a>
轻量级锁</h4><p>轻量级锁的使用场景：如果一个对象虽然有多线程要加锁，但加锁的时间是错开的（也就是没有竞争），那么可以使用轻量级锁来优化。</p><p>轻量级锁对使用者是透明的，即语法仍然是 synchronized</p><p>假设有两个方法同步块，利用同一个对象加锁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-128-1><a class=lnlinks href=#hl-128-1> 1</a>
</span><span class=lnt id=hl-128-2><a class=lnlinks href=#hl-128-2> 2</a>
</span><span class=lnt id=hl-128-3><a class=lnlinks href=#hl-128-3> 3</a>
</span><span class=lnt id=hl-128-4><a class=lnlinks href=#hl-128-4> 4</a>
</span><span class=lnt id=hl-128-5><a class=lnlinks href=#hl-128-5> 5</a>
</span><span class=lnt id=hl-128-6><a class=lnlinks href=#hl-128-6> 6</a>
</span><span class=lnt id=hl-128-7><a class=lnlinks href=#hl-128-7> 7</a>
</span><span class=lnt id=hl-128-8><a class=lnlinks href=#hl-128-8> 8</a>
</span><span class=lnt id=hl-128-9><a class=lnlinks href=#hl-128-9> 9</a>
</span><span class=lnt id=hl-128-10><a class=lnlinks href=#hl-128-10>10</a>
</span><span class=lnt id=hl-128-11><a class=lnlinks href=#hl-128-11>11</a>
</span><span class=lnt id=hl-128-12><a class=lnlinks href=#hl-128-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 同步块 A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>method2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 同步块 B</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p>创建锁记录（Lock Record）对象，每个线程都的栈帧都会包含一个锁记录的结构，内部可以存储锁定对象的 Mark Word</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183003930.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183003930 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li><li><p>让锁记录中 Object reference 指向锁对象，并尝试用 cas 替换 Object 的 Mark Word，将 Mark Word 的值存 入锁记录</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183043247.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183043247 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li><li><p>如果 cas 替换成功，对象头中存储了 锁记录地址和状态 00 ，表示由该线程给对象加锁，这时图示如下</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183112363.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183112363 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li><li><p>如果 cas 失败，有两种情况</p><ul><li>如果是其它线程已经持有了该 Object 的轻量级锁，这时表明有竞争，进入锁膨胀过程</li><li>如果是自己执行了 synchronized 锁重入，那么再添加一条 Lock Record 作为重入的计数</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183158959.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183158959 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li><li><p>当退出 synchronized 代码块（解锁时）如果有取值为 null 的锁记录，表示有重入，这时重置锁记录，表示重 入计数减一</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183219677.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183219677 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li><li><p>当退出 synchronized 代码块（解锁时）锁记录的值不为 null，这时使用cas将Mark Word的值恢复给对象头</p><ul><li>成功，则解锁成功</li><li>失败，说明轻量级锁进行了锁膨胀或已经升级为重量级锁，进入重量级锁解锁流程</li></ul></li></ul><h4 id=锁膨胀><a href=#%e9%94%81%e8%86%a8%e8%83%80 class=header-anchor>#</a>
锁膨胀</h4><p>如果在尝试加轻量级锁的过程中，CAS 操作无法成功，这时一种情况就是有其它线程为此对象加上了轻量级锁（有 竞争），这时需要进行锁膨胀，将轻量级锁变为重量级锁。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-129-1><a class=lnlinks href=#hl-129-1>1</a>
</span><span class=lnt id=hl-129-2><a class=lnlinks href=#hl-129-2>2</a>
</span><span class=lnt id=hl-129-3><a class=lnlinks href=#hl-129-3>3</a>
</span><span class=lnt id=hl-129-4><a class=lnlinks href=#hl-129-4>4</a>
</span><span class=lnt id=hl-129-5><a class=lnlinks href=#hl-129-5>5</a>
</span><span class=lnt id=hl-129-6><a class=lnlinks href=#hl-129-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 同步块</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>当 Thread-1 进行轻量级加锁时，Thread-0 已经对该对象加了轻量级锁</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183453057.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183453057 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>这时 Thread-1 加轻量级锁失败，进入锁膨胀流程<ul><li>即为 Object 对象申请 Monitor 锁，让 Object 指向重量级锁地址</li><li>然后自己进入 Monitor 的 EntryList BLOCKED</li></ul></li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183547387.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183547387 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>当 Thread-0 退出同步块解锁时，使用 cas 将 Mark Word 的值恢复给对象头，失败。这时会进入重量级解锁 流程，即按照 Monitor 地址找到 Monitor 对象，设置 Owner 为 null，唤醒 EntryList 中 BLOCKED 线程</li></ul><h4 id=自旋优化><a href=#%e8%87%aa%e6%97%8b%e4%bc%98%e5%8c%96 class=header-anchor>#</a>
自旋优化</h4><p>重量级锁竞争的时候，还可以使用自旋来进行优化，如果当前线程自旋成功（即这时候持锁线程已经退出了同步 块，释放了锁），这时当前线程就可以避免阻塞。</p><p>自旋重试成功的情况</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>线程1 ( core 1上)</th><th style=text-align:center>对象Mark</th><th style=text-align:center>线程2 ( core 2上)</th></tr></thead><tbody><tr><td style=text-align:center>-</td><td style=text-align:center>10（重量锁）</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>访问同步块，获取monitor</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>成功（加锁）</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>执行同步块</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>执行同步块</td><td style=text-align:center>10(重量锁）重量锁指针</td><td style=text-align:center>访问同步块，获取 monitor</td></tr><tr><td style=text-align:center>执行同步块</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>自旋重试</td></tr><tr><td style=text-align:center>执行完毕</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>自旋重试</td></tr><tr><td style=text-align:center>成功（解锁）</td><td style=text-align:center>01（无锁）</td><td style=text-align:center>自旋重试</td></tr><tr><td style=text-align:center>-</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>成功（加锁)</td></tr><tr><td style=text-align:center>-</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>执行同步块</td></tr><tr><td style=text-align:center>-</td><td style=text-align:center>&mldr;</td><td style=text-align:center>&mldr;</td></tr></tbody></table></div><p>自旋重试失败的情况</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>线程1 ( core 1上)</th><th style=text-align:center>对象Mark</th><th style=text-align:center>线程2( core 2上)</th></tr></thead><tbody><tr><td style=text-align:center>-</td><td style=text-align:center>10（重量锁）</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>访问同步块，获取monitor</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>成功（加锁)</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>执行同步块</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>执行同步块</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>访问同步块，获取monitor</td></tr><tr><td style=text-align:center>执行同步块</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>自旋重试</td></tr><tr><td style=text-align:center>执行同步块</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>自旋重试</td></tr><tr><td style=text-align:center>执行同步块</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>自旋重试</td></tr><tr><td style=text-align:center>执行同步块</td><td style=text-align:center>10（重量锁）重量锁指针</td><td style=text-align:center>阻塞</td></tr><tr><td style=text-align:center>-</td><td style=text-align:center>&mldr;</td><td style=text-align:center>&mldr;</td></tr></tbody></table></div><ul><li>自旋会占用 CPU 时间，单核 CPU 自旋就是浪费，多核 CPU 自旋才能发挥优势。</li><li>在 Java 6 之后自旋锁是自适应的，比如对象刚刚的一次自旋操作成功过，那么认为这次自旋成功的可能性会 高，就多自旋几次；反之，就少自旋甚至不自旋，总之，比较智能。</li><li>Java 7 之后不能控制是否开启自旋功能</li></ul><h4 id=偏向锁><a href=#%e5%81%8f%e5%90%91%e9%94%81 class=header-anchor>#</a>
偏向锁</h4><p>轻量级锁在没有竞争时（就自己这个线程），每次重入仍然需要执行 CAS 操作。</p><p>Java 6 中引入了偏向锁来做进一步优化：只有第一次使用 CAS 将线程 ID 设置到对象的 Mark Word 头，之后发现 这个线程 ID 是自己的就表示没有竞争，不用重新 CAS。以后只要不发生竞争，这个对象就归该线程所有</p><p>例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-130-1><a class=lnlinks href=#hl-130-1> 1</a>
</span><span class=lnt id=hl-130-2><a class=lnlinks href=#hl-130-2> 2</a>
</span><span class=lnt id=hl-130-3><a class=lnlinks href=#hl-130-3> 3</a>
</span><span class=lnt id=hl-130-4><a class=lnlinks href=#hl-130-4> 4</a>
</span><span class=lnt id=hl-130-5><a class=lnlinks href=#hl-130-5> 5</a>
</span><span class=lnt id=hl-130-6><a class=lnlinks href=#hl-130-6> 6</a>
</span><span class=lnt id=hl-130-7><a class=lnlinks href=#hl-130-7> 7</a>
</span><span class=lnt id=hl-130-8><a class=lnlinks href=#hl-130-8> 8</a>
</span><span class=lnt id=hl-130-9><a class=lnlinks href=#hl-130-9> 9</a>
</span><span class=lnt id=hl-130-10><a class=lnlinks href=#hl-130-10>10</a>
</span><span class=lnt id=hl-130-11><a class=lnlinks href=#hl-130-11>11</a>
</span><span class=lnt id=hl-130-12><a class=lnlinks href=#hl-130-12>12</a>
</span><span class=lnt id=hl-130-13><a class=lnlinks href=#hl-130-13>13</a>
</span><span class=lnt id=hl-130-14><a class=lnlinks href=#hl-130-14>14</a>
</span><span class=lnt id=hl-130-15><a class=lnlinks href=#hl-130-15>15</a>
</span><span class=lnt id=hl-130-16><a class=lnlinks href=#hl-130-16>16</a>
</span><span class=lnt id=hl-130-17><a class=lnlinks href=#hl-130-17>17</a>
</span><span class=lnt id=hl-130-18><a class=lnlinks href=#hl-130-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>m1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 同步块 A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>m2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>m2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 同步块 B</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>m3</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>m3</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 同步块 C</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-131-1><a class=lnlinks href=#hl-131-1> 1</a>
</span><span class=lnt id=hl-131-2><a class=lnlinks href=#hl-131-2> 2</a>
</span><span class=lnt id=hl-131-3><a class=lnlinks href=#hl-131-3> 3</a>
</span><span class=lnt id=hl-131-4><a class=lnlinks href=#hl-131-4> 4</a>
</span><span class=lnt id=hl-131-5><a class=lnlinks href=#hl-131-5> 5</a>
</span><span class=lnt id=hl-131-6><a class=lnlinks href=#hl-131-6> 6</a>
</span><span class=lnt id=hl-131-7><a class=lnlinks href=#hl-131-7> 7</a>
</span><span class=lnt id=hl-131-8><a class=lnlinks href=#hl-131-8> 8</a>
</span><span class=lnt id=hl-131-9><a class=lnlinks href=#hl-131-9> 9</a>
</span><span class=lnt id=hl-131-10><a class=lnlinks href=#hl-131-10>10</a>
</span><span class=lnt id=hl-131-11><a class=lnlinks href=#hl-131-11>11</a>
</span><span class=lnt id=hl-131-12><a class=lnlinks href=#hl-131-12>12</a>
</span><span class=lnt id=hl-131-13><a class=lnlinks href=#hl-131-13>13</a>
</span><span class=lnt id=hl-131-14><a class=lnlinks href=#hl-131-14>14</a>
</span><span class=lnt id=hl-131-15><a class=lnlinks href=#hl-131-15>15</a>
</span><span class=lnt id=hl-131-16><a class=lnlinks href=#hl-131-16>16</a>
</span><span class=lnt id=hl-131-17><a class=lnlinks href=#hl-131-17>17</a>
</span><span class=lnt id=hl-131-18><a class=lnlinks href=#hl-131-18>18</a>
</span><span class=lnt id=hl-131-19><a class=lnlinks href=#hl-131-19>19</a>
</span><span class=lnt id=hl-131-20><a class=lnlinks href=#hl-131-20>20</a>
</span><span class=lnt id=hl-131-21><a class=lnlinks href=#hl-131-21>21</a>
</span><span class=lnt id=hl-131-22><a class=lnlinks href=#hl-131-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph LR
</span></span><span class=line><span class=cl>subgraph 偏向锁
</span></span><span class=line><span class=cl>t5(&#34;m1内调用synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t6(&#34;m2内调用synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t7(&#34;m2内调用synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t8(对象)
</span></span><span class=line><span class=cl>t5 -.用ThreadID替换MarkWord.-&gt; t8
</span></span><span class=line><span class=cl>t6 -.检查ThreadID是否是自己.-&gt; t8
</span></span><span class=line><span class=cl>t7 -.检查ThreadID是否是自己.-&gt; t8
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>subgraph 轻量级锁
</span></span><span class=line><span class=cl>t1(&#34;m1内调用synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t2(&#34;m2内调用synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t3(&#34;m2内调用synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t1 -.生成锁记录.-&gt; t1
</span></span><span class=line><span class=cl>t2 -.生成锁记录.-&gt; t2
</span></span><span class=line><span class=cl>t3 -.生成锁记录.-&gt; t3
</span></span><span class=line><span class=cl>t4(对象)
</span></span><span class=line><span class=cl>t1 -.用锁记录替换markword.-&gt; t4
</span></span><span class=line><span class=cl>t2 -.用锁记录替换markword.-&gt; t4
</span></span><span class=line><span class=cl>t3 -.用锁记录替换markword.-&gt; t4
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><h5 id=偏向状态><a href=#%e5%81%8f%e5%90%91%e7%8a%b6%e6%80%81 class=header-anchor>#</a>
偏向状态</h5><p>回忆一下对象头格式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-132-1><a class=lnlinks href=#hl-132-1> 1</a>
</span><span class=lnt id=hl-132-2><a class=lnlinks href=#hl-132-2> 2</a>
</span><span class=lnt id=hl-132-3><a class=lnlinks href=#hl-132-3> 3</a>
</span><span class=lnt id=hl-132-4><a class=lnlinks href=#hl-132-4> 4</a>
</span><span class=lnt id=hl-132-5><a class=lnlinks href=#hl-132-5> 5</a>
</span><span class=lnt id=hl-132-6><a class=lnlinks href=#hl-132-6> 6</a>
</span><span class=lnt id=hl-132-7><a class=lnlinks href=#hl-132-7> 7</a>
</span><span class=lnt id=hl-132-8><a class=lnlinks href=#hl-132-8> 8</a>
</span><span class=lnt id=hl-132-9><a class=lnlinks href=#hl-132-9> 9</a>
</span><span class=lnt id=hl-132-10><a class=lnlinks href=#hl-132-10>10</a>
</span><span class=lnt id=hl-132-11><a class=lnlinks href=#hl-132-11>11</a>
</span><span class=lnt id=hl-132-12><a class=lnlinks href=#hl-132-12>12</a>
</span><span class=lnt id=hl-132-13><a class=lnlinks href=#hl-132-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                          <span class=no>Mark</span> <span class=no>Word</span> <span class=p>(</span><span class=mi>64</span> <span class=n>bits</span><span class=p>)</span>                       <span class=o>|</span>        <span class=no>State</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>25</span> <span class=o>|</span> <span class=ss>hashcode</span><span class=p>:</span><span class=mi>31</span> <span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span> <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>0</span> <span class=o>|</span>  <span class=mo>01</span>   <span class=o>|</span>        <span class=no>Normal</span>      <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=ss>thread</span><span class=p>:</span><span class=mi>54</span> <span class=o>|</span>   <span class=ss>epoch</span><span class=p>:</span><span class=mi>2</span>   <span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span> <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span>  <span class=mo>01</span>   <span class=o>|</span>        <span class=no>Biased</span>      <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                    <span class=ss>ptr_to_lock_record</span><span class=p>:</span><span class=mi>62</span>                   <span class=o>|</span>  <span class=mo>00</span>   <span class=o>|</span> <span class=no>Lightweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                 <span class=ss>ptr_to_heavyweight_monitor</span><span class=p>:</span><span class=mi>62</span>              <span class=o>|</span>  <span class=mi>10</span>   <span class=o>|</span> <span class=no>Heavyweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                                                            <span class=o>|</span>  <span class=mi>11</span>   <span class=o>|</span>    <span class=no>Marked</span> <span class=k>for</span> <span class=no>GC</span>   <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span></code></pre></td></tr></table></div></div><p>一个对象创建时：</p><ul><li>如果开启了偏向锁（默认开启），那么对象创建后，markword 值为 0x05 即最后 3 位为 101，这时它的 thread、epoch、age 都为 0</li><li>偏向锁是默认是延迟的，不会在程序启动时立即生效，如果想避免延迟，可以加 VM 参数<code>- XX:BiasedLockingStartupDelay=0</code>来禁用延迟</li><li>如果没有开启偏向锁，那么对象创建后，markword 值为 0x01 即最后 3 位为 001，这时它的 hashcode、 age 都为 0，第一次用到 hashcode 时才会赋值</li></ul><p>1） 测试延迟特性</p><p>2） 测试偏向锁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-133-1><a class=lnlinks href=#hl-133-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Dog</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>利用 jol 第三方工具来查看对象头信息（注意这里我扩展了 jol 让它输出更为简洁）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-134-1><a class=lnlinks href=#hl-134-1> 1</a>
</span><span class=lnt id=hl-134-2><a class=lnlinks href=#hl-134-2> 2</a>
</span><span class=lnt id=hl-134-3><a class=lnlinks href=#hl-134-3> 3</a>
</span><span class=lnt id=hl-134-4><a class=lnlinks href=#hl-134-4> 4</a>
</span><span class=lnt id=hl-134-5><a class=lnlinks href=#hl-134-5> 5</a>
</span><span class=lnt id=hl-134-6><a class=lnlinks href=#hl-134-6> 6</a>
</span><span class=lnt id=hl-134-7><a class=lnlinks href=#hl-134-7> 7</a>
</span><span class=lnt id=hl-134-8><a class=lnlinks href=#hl-134-8> 8</a>
</span><span class=lnt id=hl-134-9><a class=lnlinks href=#hl-134-9> 9</a>
</span><span class=lnt id=hl-134-10><a class=lnlinks href=#hl-134-10>10</a>
</span><span class=lnt id=hl-134-11><a class=lnlinks href=#hl-134-11>11</a>
</span><span class=lnt id=hl-134-12><a class=lnlinks href=#hl-134-12>12</a>
</span><span class=lnt id=hl-134-13><a class=lnlinks href=#hl-134-13>13</a>
</span><span class=lnt id=hl-134-14><a class=lnlinks href=#hl-134-14>14</a>
</span><span class=lnt id=hl-134-15><a class=lnlinks href=#hl-134-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 添加虚拟机参数 -XX:BiasedLockingStartupDelay=0 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClassLayout</span><span class=w> </span><span class=n>classLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;synchronized 前&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>classLayout</span><span class=p>.</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;synchronized 中&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>classLayout</span><span class=p>.</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;synchronized 后&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>classLayout</span><span class=p>.</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-135-1><a class=lnlinks href=#hl-135-1>1</a>
</span><span class=lnt id=hl-135-2><a class=lnlinks href=#hl-135-2>2</a>
</span><span class=lnt id=hl-135-3><a class=lnlinks href=#hl-135-3>3</a>
</span><span class=lnt id=hl-135-4><a class=lnlinks href=#hl-135-4>4</a>
</span><span class=lnt id=hl-135-5><a class=lnlinks href=#hl-135-5>5</a>
</span><span class=lnt id=hl-135-6><a class=lnlinks href=#hl-135-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:08:58.117 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized 前
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl>11:08:58.121 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized 中
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11101011</span> <span class=m>11010000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl>11:08:58.121 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized 后
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11101011</span> <span class=m>11010000</span> <span class=m>00000101</span> 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p><p>处于偏向锁的对象解锁后，线程 id 仍存储于对象头中</p></blockquote><p>3）测试禁用</p><p>在上面测试代码运行时在添加 VM 参数 -XX:-UseBiasedLocking 禁用偏向锁</p><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-136-1><a class=lnlinks href=#hl-136-1>1</a>
</span><span class=lnt id=hl-136-2><a class=lnlinks href=#hl-136-2>2</a>
</span><span class=lnt id=hl-136-3><a class=lnlinks href=#hl-136-3>3</a>
</span><span class=lnt id=hl-136-4><a class=lnlinks href=#hl-136-4>4</a>
</span><span class=lnt id=hl-136-5><a class=lnlinks href=#hl-136-5>5</a>
</span><span class=lnt id=hl-136-6><a class=lnlinks href=#hl-136-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:13:10.018 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized 前
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl>11:13:10.021 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized 中
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>00010100</span> <span class=m>11110011</span> <span class=m>10001000</span> 
</span></span><span class=line><span class=cl>11:13:10.021 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized 后
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span></code></pre></td></tr></table></div></div><p>4)测试 hashCode</p><ul><li>正常状态对象一开始是没有 hashCode 的，第一次调用才生成</li></ul><h5 id=撤销---调用对象-hashcode><a href=#%e6%92%a4%e9%94%80---%e8%b0%83%e7%94%a8%e5%af%b9%e8%b1%a1-hashcode class=header-anchor>#</a>
撤销 - 调用对象 hashCode</h5><p>调用了对象的 hashCode，但偏向锁的对象 MarkWord 中存储的是线程 id，如果调用 hashCode 会导致偏向锁被 撤销</p><ul><li>轻量级锁会在锁记录中记录 hashCode</li><li>重量级锁会在 Monitor 中记录 hashCode</li></ul><p>在调用 hashCode 后使用偏向锁，记得去掉<code>-XX:-UseBiasedLocking</code></p><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-137-1><a class=lnlinks href=#hl-137-1>1</a>
</span><span class=lnt id=hl-137-2><a class=lnlinks href=#hl-137-2>2</a>
</span><span class=lnt id=hl-137-3><a class=lnlinks href=#hl-137-3>3</a>
</span><span class=lnt id=hl-137-4><a class=lnlinks href=#hl-137-4>4</a>
</span><span class=lnt id=hl-137-5><a class=lnlinks href=#hl-137-5>5</a>
</span><span class=lnt id=hl-137-6><a class=lnlinks href=#hl-137-6>6</a>
</span><span class=lnt id=hl-137-7><a class=lnlinks href=#hl-137-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SH data-lang=SH><span class=line><span class=cl>11:22:10.386 c.TestBiased <span class=o>[</span>main<span class=o>]</span> - 调用 hashCode:1778535015 
</span></span><span class=line><span class=cl>11:22:10.391 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized 前
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>01101010</span> <span class=m>00000010</span> <span class=m>01001010</span> <span class=m>01100111</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl>11:22:10.393 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized 中
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>11000011</span> <span class=m>11110011</span> <span class=m>01101000</span> 
</span></span><span class=line><span class=cl>11:22:10.393 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized 后
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>01101010</span> <span class=m>00000010</span> <span class=m>01001010</span> <span class=m>01100111</span> <span class=m>00000001</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=撤销---其它线程使用对象><a href=#%e6%92%a4%e9%94%80---%e5%85%b6%e5%ae%83%e7%ba%bf%e7%a8%8b%e4%bd%bf%e7%94%a8%e5%af%b9%e8%b1%a1 class=header-anchor>#</a>
撤销 - 其它线程使用对象</h5><p>当有其它线程使用偏向锁对象时，会将偏向锁升级为轻量级锁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-138-1><a class=lnlinks href=#hl-138-1> 1</a>
</span><span class=lnt id=hl-138-2><a class=lnlinks href=#hl-138-2> 2</a>
</span><span class=lnt id=hl-138-3><a class=lnlinks href=#hl-138-3> 3</a>
</span><span class=lnt id=hl-138-4><a class=lnlinks href=#hl-138-4> 4</a>
</span><span class=lnt id=hl-138-5><a class=lnlinks href=#hl-138-5> 5</a>
</span><span class=lnt id=hl-138-6><a class=lnlinks href=#hl-138-6> 6</a>
</span><span class=lnt id=hl-138-7><a class=lnlinks href=#hl-138-7> 7</a>
</span><span class=lnt id=hl-138-8><a class=lnlinks href=#hl-138-8> 8</a>
</span><span class=lnt id=hl-138-9><a class=lnlinks href=#hl-138-9> 9</a>
</span><span class=lnt id=hl-138-10><a class=lnlinks href=#hl-138-10>10</a>
</span><span class=lnt id=hl-138-11><a class=lnlinks href=#hl-138-11>11</a>
</span><span class=lnt id=hl-138-12><a class=lnlinks href=#hl-138-12>12</a>
</span><span class=lnt id=hl-138-13><a class=lnlinks href=#hl-138-13>13</a>
</span><span class=lnt id=hl-138-14><a class=lnlinks href=#hl-138-14>14</a>
</span><span class=lnt id=hl-138-15><a class=lnlinks href=#hl-138-15>15</a>
</span><span class=lnt id=hl-138-16><a class=lnlinks href=#hl-138-16>16</a>
</span><span class=lnt id=hl-138-17><a class=lnlinks href=#hl-138-17>17</a>
</span><span class=lnt id=hl-138-18><a class=lnlinks href=#hl-138-18>18</a>
</span><span class=lnt id=hl-138-19><a class=lnlinks href=#hl-138-19>19</a>
</span><span class=lnt id=hl-138-20><a class=lnlinks href=#hl-138-20>20</a>
</span><span class=lnt id=hl-138-21><a class=lnlinks href=#hl-138-21>21</a>
</span><span class=lnt id=hl-138-22><a class=lnlinks href=#hl-138-22>22</a>
</span><span class=lnt id=hl-138-23><a class=lnlinks href=#hl-138-23>23</a>
</span><span class=lnt id=hl-138-24><a class=lnlinks href=#hl-138-24>24</a>
</span><span class=lnt id=hl-138-25><a class=lnlinks href=#hl-138-25>25</a>
</span><span class=lnt id=hl-138-26><a class=lnlinks href=#hl-138-26>26</a>
</span><span class=lnt id=hl-138-27><a class=lnlinks href=#hl-138-27>27</a>
</span><span class=lnt id=hl-138-28><a class=lnlinks href=#hl-138-28>28</a>
</span><span class=lnt id=hl-138-29><a class=lnlinks href=#hl-138-29>29</a>
</span><span class=lnt id=hl-138-30><a class=lnlinks href=#hl-138-30>30</a>
</span><span class=lnt id=hl-138-31><a class=lnlinks href=#hl-138-31>31</a>
</span><span class=lnt id=hl-138-32><a class=lnlinks href=#hl-138-32>32</a>
</span><span class=lnt id=hl-138-33><a class=lnlinks href=#hl-138-33>33</a>
</span><span class=lnt id=hl-138-34><a class=lnlinks href=#hl-138-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JAVA data-lang=JAVA><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>TestBiased</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TestBiased</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果不用 wait/notify 使用 join 必须打开下面的注释</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 因为：t1 线程不能结束，否则底层线程可能被 jvm 重用作为 t2 线程，底层线程 id 是一样的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*try {
</span></span></span><span class=line><span class=cl><span class=cm> System.in.read();
</span></span></span><span class=line><span class=cl><span class=cm> } catch (IOException e) {
</span></span></span><span class=line><span class=cl><span class=cm> e.printStackTrace();
</span></span></span><span class=line><span class=cl><span class=cm> }*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>TestBiased</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TestBiased</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-139-1><a class=lnlinks href=#hl-139-1>1</a>
</span><span class=lnt id=hl-139-2><a class=lnlinks href=#hl-139-2>2</a>
</span><span class=lnt id=hl-139-3><a class=lnlinks href=#hl-139-3>3</a>
</span><span class=lnt id=hl-139-4><a class=lnlinks href=#hl-139-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>01000001</span> <span class=m>00010000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>01000001</span> <span class=m>00010000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>10110101</span> <span class=m>11110000</span> <span class=m>01000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=撤销---调用-waitnotify><a href=#%e6%92%a4%e9%94%80---%e8%b0%83%e7%94%a8-waitnotify class=header-anchor>#</a>
撤销 - 调用 wait/notify</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-140-1><a class=lnlinks href=#hl-140-1> 1</a>
</span><span class=lnt id=hl-140-2><a class=lnlinks href=#hl-140-2> 2</a>
</span><span class=lnt id=hl-140-3><a class=lnlinks href=#hl-140-3> 3</a>
</span><span class=lnt id=hl-140-4><a class=lnlinks href=#hl-140-4> 4</a>
</span><span class=lnt id=hl-140-5><a class=lnlinks href=#hl-140-5> 5</a>
</span><span class=lnt id=hl-140-6><a class=lnlinks href=#hl-140-6> 6</a>
</span><span class=lnt id=hl-140-7><a class=lnlinks href=#hl-140-7> 7</a>
</span><span class=lnt id=hl-140-8><a class=lnlinks href=#hl-140-8> 8</a>
</span><span class=lnt id=hl-140-9><a class=lnlinks href=#hl-140-9> 9</a>
</span><span class=lnt id=hl-140-10><a class=lnlinks href=#hl-140-10>10</a>
</span><span class=lnt id=hl-140-11><a class=lnlinks href=#hl-140-11>11</a>
</span><span class=lnt id=hl-140-12><a class=lnlinks href=#hl-140-12>12</a>
</span><span class=lnt id=hl-140-13><a class=lnlinks href=#hl-140-13>13</a>
</span><span class=lnt id=hl-140-14><a class=lnlinks href=#hl-140-14>14</a>
</span><span class=lnt id=hl-140-15><a class=lnlinks href=#hl-140-15>15</a>
</span><span class=lnt id=hl-140-16><a class=lnlinks href=#hl-140-16>16</a>
</span><span class=lnt id=hl-140-17><a class=lnlinks href=#hl-140-17>17</a>
</span><span class=lnt id=hl-140-18><a class=lnlinks href=#hl-140-18>18</a>
</span><span class=lnt id=hl-140-19><a class=lnlinks href=#hl-140-19>19</a>
</span><span class=lnt id=hl-140-20><a class=lnlinks href=#hl-140-20>20</a>
</span><span class=lnt id=hl-140-21><a class=lnlinks href=#hl-140-21>21</a>
</span><span class=lnt id=hl-140-22><a class=lnlinks href=#hl-140-22>22</a>
</span><span class=lnt id=hl-140-23><a class=lnlinks href=#hl-140-23>23</a>
</span><span class=lnt id=hl-140-24><a class=lnlinks href=#hl-140-24>24</a>
</span><span class=lnt id=hl-140-25><a class=lnlinks href=#hl-140-25>25</a>
</span><span class=lnt id=hl-140-26><a class=lnlinks href=#hl-140-26>26</a>
</span><span class=lnt id=hl-140-27><a class=lnlinks href=#hl-140-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>d</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>6000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;notify&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>d</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-141-1><a class=lnlinks href=#hl-141-1>1</a>
</span><span class=lnt id=hl-141-2><a class=lnlinks href=#hl-141-2>2</a>
</span><span class=lnt id=hl-141-3><a class=lnlinks href=#hl-141-3>3</a>
</span><span class=lnt id=hl-141-4><a class=lnlinks href=#hl-141-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>10110011</span> <span class=m>11111000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - notify 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011100</span> <span class=m>11010100</span> <span class=m>00001101</span> <span class=m>11001010</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=批量重偏向><a href=#%e6%89%b9%e9%87%8f%e9%87%8d%e5%81%8f%e5%90%91 class=header-anchor>#</a>
<strong>批量重偏向</strong></h5><p>如果对象虽然被多个线程访问，但没有竞争，这时偏向了线程 T1 的对象仍有机会重新偏向 T2，重偏向会重置对象 的 Thread ID</p><p>当撤销偏向锁阈值超过 20 次后，jvm 会这样觉得，我是不是偏向错了呢，于是会在给这些对象加锁时重新偏向至 加锁线程</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-142-1><a class=lnlinks href=#hl-142-1> 1</a>
</span><span class=lnt id=hl-142-2><a class=lnlinks href=#hl-142-2> 2</a>
</span><span class=lnt id=hl-142-3><a class=lnlinks href=#hl-142-3> 3</a>
</span><span class=lnt id=hl-142-4><a class=lnlinks href=#hl-142-4> 4</a>
</span><span class=lnt id=hl-142-5><a class=lnlinks href=#hl-142-5> 5</a>
</span><span class=lnt id=hl-142-6><a class=lnlinks href=#hl-142-6> 6</a>
</span><span class=lnt id=hl-142-7><a class=lnlinks href=#hl-142-7> 7</a>
</span><span class=lnt id=hl-142-8><a class=lnlinks href=#hl-142-8> 8</a>
</span><span class=lnt id=hl-142-9><a class=lnlinks href=#hl-142-9> 9</a>
</span><span class=lnt id=hl-142-10><a class=lnlinks href=#hl-142-10>10</a>
</span><span class=lnt id=hl-142-11><a class=lnlinks href=#hl-142-11>11</a>
</span><span class=lnt id=hl-142-12><a class=lnlinks href=#hl-142-12>12</a>
</span><span class=lnt id=hl-142-13><a class=lnlinks href=#hl-142-13>13</a>
</span><span class=lnt id=hl-142-14><a class=lnlinks href=#hl-142-14>14</a>
</span><span class=lnt id=hl-142-15><a class=lnlinks href=#hl-142-15>15</a>
</span><span class=lnt id=hl-142-16><a class=lnlinks href=#hl-142-16>16</a>
</span><span class=lnt id=hl-142-17><a class=lnlinks href=#hl-142-17>17</a>
</span><span class=lnt id=hl-142-18><a class=lnlinks href=#hl-142-18>18</a>
</span><span class=lnt id=hl-142-19><a class=lnlinks href=#hl-142-19>19</a>
</span><span class=lnt id=hl-142-20><a class=lnlinks href=#hl-142-20>20</a>
</span><span class=lnt id=hl-142-21><a class=lnlinks href=#hl-142-21>21</a>
</span><span class=lnt id=hl-142-22><a class=lnlinks href=#hl-142-22>22</a>
</span><span class=lnt id=hl-142-23><a class=lnlinks href=#hl-142-23>23</a>
</span><span class=lnt id=hl-142-24><a class=lnlinks href=#hl-142-24>24</a>
</span><span class=lnt id=hl-142-25><a class=lnlinks href=#hl-142-25>25</a>
</span><span class=lnt id=hl-142-26><a class=lnlinks href=#hl-142-26>26</a>
</span><span class=lnt id=hl-142-27><a class=lnlinks href=#hl-142-27>27</a>
</span><span class=lnt id=hl-142-28><a class=lnlinks href=#hl-142-28>28</a>
</span><span class=lnt id=hl-142-29><a class=lnlinks href=#hl-142-29>29</a>
</span><span class=lnt id=hl-142-30><a class=lnlinks href=#hl-142-30>30</a>
</span><span class=lnt id=hl-142-31><a class=lnlinks href=#hl-142-31>31</a>
</span><span class=lnt id=hl-142-32><a class=lnlinks href=#hl-142-32>32</a>
</span><span class=lnt id=hl-142-33><a class=lnlinks href=#hl-142-33>33</a>
</span><span class=lnt id=hl-142-34><a class=lnlinks href=#hl-142-34>34</a>
</span><span class=lnt id=hl-142-35><a class=lnlinks href=#hl-142-35>35</a>
</span><span class=lnt id=hl-142-36><a class=lnlinks href=#hl-142-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Vector</span><span class=o>&lt;</span><span class=n>Dog</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Vector</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>30</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>d</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>list</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;===============&gt; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>30</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-143-1><a class=lnlinks href=#hl-143-1>  1</a>
</span><span class=lnt id=hl-143-2><a class=lnlinks href=#hl-143-2>  2</a>
</span><span class=lnt id=hl-143-3><a class=lnlinks href=#hl-143-3>  3</a>
</span><span class=lnt id=hl-143-4><a class=lnlinks href=#hl-143-4>  4</a>
</span><span class=lnt id=hl-143-5><a class=lnlinks href=#hl-143-5>  5</a>
</span><span class=lnt id=hl-143-6><a class=lnlinks href=#hl-143-6>  6</a>
</span><span class=lnt id=hl-143-7><a class=lnlinks href=#hl-143-7>  7</a>
</span><span class=lnt id=hl-143-8><a class=lnlinks href=#hl-143-8>  8</a>
</span><span class=lnt id=hl-143-9><a class=lnlinks href=#hl-143-9>  9</a>
</span><span class=lnt id=hl-143-10><a class=lnlinks href=#hl-143-10> 10</a>
</span><span class=lnt id=hl-143-11><a class=lnlinks href=#hl-143-11> 11</a>
</span><span class=lnt id=hl-143-12><a class=lnlinks href=#hl-143-12> 12</a>
</span><span class=lnt id=hl-143-13><a class=lnlinks href=#hl-143-13> 13</a>
</span><span class=lnt id=hl-143-14><a class=lnlinks href=#hl-143-14> 14</a>
</span><span class=lnt id=hl-143-15><a class=lnlinks href=#hl-143-15> 15</a>
</span><span class=lnt id=hl-143-16><a class=lnlinks href=#hl-143-16> 16</a>
</span><span class=lnt id=hl-143-17><a class=lnlinks href=#hl-143-17> 17</a>
</span><span class=lnt id=hl-143-18><a class=lnlinks href=#hl-143-18> 18</a>
</span><span class=lnt id=hl-143-19><a class=lnlinks href=#hl-143-19> 19</a>
</span><span class=lnt id=hl-143-20><a class=lnlinks href=#hl-143-20> 20</a>
</span><span class=lnt id=hl-143-21><a class=lnlinks href=#hl-143-21> 21</a>
</span><span class=lnt id=hl-143-22><a class=lnlinks href=#hl-143-22> 22</a>
</span><span class=lnt id=hl-143-23><a class=lnlinks href=#hl-143-23> 23</a>
</span><span class=lnt id=hl-143-24><a class=lnlinks href=#hl-143-24> 24</a>
</span><span class=lnt id=hl-143-25><a class=lnlinks href=#hl-143-25> 25</a>
</span><span class=lnt id=hl-143-26><a class=lnlinks href=#hl-143-26> 26</a>
</span><span class=lnt id=hl-143-27><a class=lnlinks href=#hl-143-27> 27</a>
</span><span class=lnt id=hl-143-28><a class=lnlinks href=#hl-143-28> 28</a>
</span><span class=lnt id=hl-143-29><a class=lnlinks href=#hl-143-29> 29</a>
</span><span class=lnt id=hl-143-30><a class=lnlinks href=#hl-143-30> 30</a>
</span><span class=lnt id=hl-143-31><a class=lnlinks href=#hl-143-31> 31</a>
</span><span class=lnt id=hl-143-32><a class=lnlinks href=#hl-143-32> 32</a>
</span><span class=lnt id=hl-143-33><a class=lnlinks href=#hl-143-33> 33</a>
</span><span class=lnt id=hl-143-34><a class=lnlinks href=#hl-143-34> 34</a>
</span><span class=lnt id=hl-143-35><a class=lnlinks href=#hl-143-35> 35</a>
</span><span class=lnt id=hl-143-36><a class=lnlinks href=#hl-143-36> 36</a>
</span><span class=lnt id=hl-143-37><a class=lnlinks href=#hl-143-37> 37</a>
</span><span class=lnt id=hl-143-38><a class=lnlinks href=#hl-143-38> 38</a>
</span><span class=lnt id=hl-143-39><a class=lnlinks href=#hl-143-39> 39</a>
</span><span class=lnt id=hl-143-40><a class=lnlinks href=#hl-143-40> 40</a>
</span><span class=lnt id=hl-143-41><a class=lnlinks href=#hl-143-41> 41</a>
</span><span class=lnt id=hl-143-42><a class=lnlinks href=#hl-143-42> 42</a>
</span><span class=lnt id=hl-143-43><a class=lnlinks href=#hl-143-43> 43</a>
</span><span class=lnt id=hl-143-44><a class=lnlinks href=#hl-143-44> 44</a>
</span><span class=lnt id=hl-143-45><a class=lnlinks href=#hl-143-45> 45</a>
</span><span class=lnt id=hl-143-46><a class=lnlinks href=#hl-143-46> 46</a>
</span><span class=lnt id=hl-143-47><a class=lnlinks href=#hl-143-47> 47</a>
</span><span class=lnt id=hl-143-48><a class=lnlinks href=#hl-143-48> 48</a>
</span><span class=lnt id=hl-143-49><a class=lnlinks href=#hl-143-49> 49</a>
</span><span class=lnt id=hl-143-50><a class=lnlinks href=#hl-143-50> 50</a>
</span><span class=lnt id=hl-143-51><a class=lnlinks href=#hl-143-51> 51</a>
</span><span class=lnt id=hl-143-52><a class=lnlinks href=#hl-143-52> 52</a>
</span><span class=lnt id=hl-143-53><a class=lnlinks href=#hl-143-53> 53</a>
</span><span class=lnt id=hl-143-54><a class=lnlinks href=#hl-143-54> 54</a>
</span><span class=lnt id=hl-143-55><a class=lnlinks href=#hl-143-55> 55</a>
</span><span class=lnt id=hl-143-56><a class=lnlinks href=#hl-143-56> 56</a>
</span><span class=lnt id=hl-143-57><a class=lnlinks href=#hl-143-57> 57</a>
</span><span class=lnt id=hl-143-58><a class=lnlinks href=#hl-143-58> 58</a>
</span><span class=lnt id=hl-143-59><a class=lnlinks href=#hl-143-59> 59</a>
</span><span class=lnt id=hl-143-60><a class=lnlinks href=#hl-143-60> 60</a>
</span><span class=lnt id=hl-143-61><a class=lnlinks href=#hl-143-61> 61</a>
</span><span class=lnt id=hl-143-62><a class=lnlinks href=#hl-143-62> 62</a>
</span><span class=lnt id=hl-143-63><a class=lnlinks href=#hl-143-63> 63</a>
</span><span class=lnt id=hl-143-64><a class=lnlinks href=#hl-143-64> 64</a>
</span><span class=lnt id=hl-143-65><a class=lnlinks href=#hl-143-65> 65</a>
</span><span class=lnt id=hl-143-66><a class=lnlinks href=#hl-143-66> 66</a>
</span><span class=lnt id=hl-143-67><a class=lnlinks href=#hl-143-67> 67</a>
</span><span class=lnt id=hl-143-68><a class=lnlinks href=#hl-143-68> 68</a>
</span><span class=lnt id=hl-143-69><a class=lnlinks href=#hl-143-69> 69</a>
</span><span class=lnt id=hl-143-70><a class=lnlinks href=#hl-143-70> 70</a>
</span><span class=lnt id=hl-143-71><a class=lnlinks href=#hl-143-71> 71</a>
</span><span class=lnt id=hl-143-72><a class=lnlinks href=#hl-143-72> 72</a>
</span><span class=lnt id=hl-143-73><a class=lnlinks href=#hl-143-73> 73</a>
</span><span class=lnt id=hl-143-74><a class=lnlinks href=#hl-143-74> 74</a>
</span><span class=lnt id=hl-143-75><a class=lnlinks href=#hl-143-75> 75</a>
</span><span class=lnt id=hl-143-76><a class=lnlinks href=#hl-143-76> 76</a>
</span><span class=lnt id=hl-143-77><a class=lnlinks href=#hl-143-77> 77</a>
</span><span class=lnt id=hl-143-78><a class=lnlinks href=#hl-143-78> 78</a>
</span><span class=lnt id=hl-143-79><a class=lnlinks href=#hl-143-79> 79</a>
</span><span class=lnt id=hl-143-80><a class=lnlinks href=#hl-143-80> 80</a>
</span><span class=lnt id=hl-143-81><a class=lnlinks href=#hl-143-81> 81</a>
</span><span class=lnt id=hl-143-82><a class=lnlinks href=#hl-143-82> 82</a>
</span><span class=lnt id=hl-143-83><a class=lnlinks href=#hl-143-83> 83</a>
</span><span class=lnt id=hl-143-84><a class=lnlinks href=#hl-143-84> 84</a>
</span><span class=lnt id=hl-143-85><a class=lnlinks href=#hl-143-85> 85</a>
</span><span class=lnt id=hl-143-86><a class=lnlinks href=#hl-143-86> 86</a>
</span><span class=lnt id=hl-143-87><a class=lnlinks href=#hl-143-87> 87</a>
</span><span class=lnt id=hl-143-88><a class=lnlinks href=#hl-143-88> 88</a>
</span><span class=lnt id=hl-143-89><a class=lnlinks href=#hl-143-89> 89</a>
</span><span class=lnt id=hl-143-90><a class=lnlinks href=#hl-143-90> 90</a>
</span><span class=lnt id=hl-143-91><a class=lnlinks href=#hl-143-91> 91</a>
</span><span class=lnt id=hl-143-92><a class=lnlinks href=#hl-143-92> 92</a>
</span><span class=lnt id=hl-143-93><a class=lnlinks href=#hl-143-93> 93</a>
</span><span class=lnt id=hl-143-94><a class=lnlinks href=#hl-143-94> 94</a>
</span><span class=lnt id=hl-143-95><a class=lnlinks href=#hl-143-95> 95</a>
</span><span class=lnt id=hl-143-96><a class=lnlinks href=#hl-143-96> 96</a>
</span><span class=lnt id=hl-143-97><a class=lnlinks href=#hl-143-97> 97</a>
</span><span class=lnt id=hl-143-98><a class=lnlinks href=#hl-143-98> 98</a>
</span><span class=lnt id=hl-143-99><a class=lnlinks href=#hl-143-99> 99</a>
</span><span class=lnt id=hl-143-100><a class=lnlinks href=#hl-143-100>100</a>
</span><span class=lnt id=hl-143-101><a class=lnlinks href=#hl-143-101>101</a>
</span><span class=lnt id=hl-143-102><a class=lnlinks href=#hl-143-102>102</a>
</span><span class=lnt id=hl-143-103><a class=lnlinks href=#hl-143-103>103</a>
</span><span class=lnt id=hl-143-104><a class=lnlinks href=#hl-143-104>104</a>
</span><span class=lnt id=hl-143-105><a class=lnlinks href=#hl-143-105>105</a>
</span><span class=lnt id=hl-143-106><a class=lnlinks href=#hl-143-106>106</a>
</span><span class=lnt id=hl-143-107><a class=lnlinks href=#hl-143-107>107</a>
</span><span class=lnt id=hl-143-108><a class=lnlinks href=#hl-143-108>108</a>
</span><span class=lnt id=hl-143-109><a class=lnlinks href=#hl-143-109>109</a>
</span><span class=lnt id=hl-143-110><a class=lnlinks href=#hl-143-110>110</a>
</span><span class=lnt id=hl-143-111><a class=lnlinks href=#hl-143-111>111</a>
</span><span class=lnt id=hl-143-112><a class=lnlinks href=#hl-143-112>112</a>
</span><span class=lnt id=hl-143-113><a class=lnlinks href=#hl-143-113>113</a>
</span><span class=lnt id=hl-143-114><a class=lnlinks href=#hl-143-114>114</a>
</span><span class=lnt id=hl-143-115><a class=lnlinks href=#hl-143-115>115</a>
</span><span class=lnt id=hl-143-116><a class=lnlinks href=#hl-143-116>116</a>
</span><span class=lnt id=hl-143-117><a class=lnlinks href=#hl-143-117>117</a>
</span><span class=lnt id=hl-143-118><a class=lnlinks href=#hl-143-118>118</a>
</span><span class=lnt id=hl-143-119><a class=lnlinks href=#hl-143-119>119</a>
</span><span class=lnt id=hl-143-120><a class=lnlinks href=#hl-143-120>120</a>
</span><span class=lnt id=hl-143-121><a class=lnlinks href=#hl-143-121>121</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>0</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>1</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>2</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>3</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>4</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>5</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>6</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>7</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>8</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>9</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>10</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>11</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>12</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>13</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>14</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>15</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>16</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>17</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>18</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>19</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>20</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>21</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>22</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>23</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>24</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>25</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>26</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>27</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>28</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>29</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=o>===============</span>&gt; 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>0</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>0</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>0</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>1</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>1</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>1</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>2</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>2</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>2</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>3</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>3</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>3</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>4</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>4</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>4</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>5</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>5</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>5</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>6</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>6</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>6</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>7</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span>
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>7</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>7</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>8</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>8</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>8</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>9</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>9</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>9</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>10</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>10</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>10</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>11</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>11</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>11</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>12</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>12</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>12</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>13</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>13</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>13</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>14</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>14</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>14</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>15</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>15</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>15</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>16</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>16</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>16</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>17</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>17</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>17</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>18</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>18</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>18</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>19</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>19</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>19</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>20</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>20</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>20</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>21</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>21</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>21</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>22</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>22</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>22</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>23</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>23</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>23</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>24</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>24</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>24</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>25</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>25</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>25</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>26</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>26</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>26</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>27</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>27</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>27</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>28</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>28</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>28</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>29</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>29</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>29</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=批量撤销><a href=#%e6%89%b9%e9%87%8f%e6%92%a4%e9%94%80 class=header-anchor>#</a>
批量撤销</h5><p>当撤销偏向锁阈值超过 40 次后，jvm 会这样觉得，自己确实偏向错了，根本就不该偏向。于是整个类的所有对象 都会变为不可偏向的，新建的对象也是不可偏向的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-144-1><a class=lnlinks href=#hl-144-1> 1</a>
</span><span class=lnt id=hl-144-2><a class=lnlinks href=#hl-144-2> 2</a>
</span><span class=lnt id=hl-144-3><a class=lnlinks href=#hl-144-3> 3</a>
</span><span class=lnt id=hl-144-4><a class=lnlinks href=#hl-144-4> 4</a>
</span><span class=lnt id=hl-144-5><a class=lnlinks href=#hl-144-5> 5</a>
</span><span class=lnt id=hl-144-6><a class=lnlinks href=#hl-144-6> 6</a>
</span><span class=lnt id=hl-144-7><a class=lnlinks href=#hl-144-7> 7</a>
</span><span class=lnt id=hl-144-8><a class=lnlinks href=#hl-144-8> 8</a>
</span><span class=lnt id=hl-144-9><a class=lnlinks href=#hl-144-9> 9</a>
</span><span class=lnt id=hl-144-10><a class=lnlinks href=#hl-144-10>10</a>
</span><span class=lnt id=hl-144-11><a class=lnlinks href=#hl-144-11>11</a>
</span><span class=lnt id=hl-144-12><a class=lnlinks href=#hl-144-12>12</a>
</span><span class=lnt id=hl-144-13><a class=lnlinks href=#hl-144-13>13</a>
</span><span class=lnt id=hl-144-14><a class=lnlinks href=#hl-144-14>14</a>
</span><span class=lnt id=hl-144-15><a class=lnlinks href=#hl-144-15>15</a>
</span><span class=lnt id=hl-144-16><a class=lnlinks href=#hl-144-16>16</a>
</span><span class=lnt id=hl-144-17><a class=lnlinks href=#hl-144-17>17</a>
</span><span class=lnt id=hl-144-18><a class=lnlinks href=#hl-144-18>18</a>
</span><span class=lnt id=hl-144-19><a class=lnlinks href=#hl-144-19>19</a>
</span><span class=lnt id=hl-144-20><a class=lnlinks href=#hl-144-20>20</a>
</span><span class=lnt id=hl-144-21><a class=lnlinks href=#hl-144-21>21</a>
</span><span class=lnt id=hl-144-22><a class=lnlinks href=#hl-144-22>22</a>
</span><span class=lnt id=hl-144-23><a class=lnlinks href=#hl-144-23>23</a>
</span><span class=lnt id=hl-144-24><a class=lnlinks href=#hl-144-24>24</a>
</span><span class=lnt id=hl-144-25><a class=lnlinks href=#hl-144-25>25</a>
</span><span class=lnt id=hl-144-26><a class=lnlinks href=#hl-144-26>26</a>
</span><span class=lnt id=hl-144-27><a class=lnlinks href=#hl-144-27>27</a>
</span><span class=lnt id=hl-144-28><a class=lnlinks href=#hl-144-28>28</a>
</span><span class=lnt id=hl-144-29><a class=lnlinks href=#hl-144-29>29</a>
</span><span class=lnt id=hl-144-30><a class=lnlinks href=#hl-144-30>30</a>
</span><span class=lnt id=hl-144-31><a class=lnlinks href=#hl-144-31>31</a>
</span><span class=lnt id=hl-144-32><a class=lnlinks href=#hl-144-32>32</a>
</span><span class=lnt id=hl-144-33><a class=lnlinks href=#hl-144-33>33</a>
</span><span class=lnt id=hl-144-34><a class=lnlinks href=#hl-144-34>34</a>
</span><span class=lnt id=hl-144-35><a class=lnlinks href=#hl-144-35>35</a>
</span><span class=lnt id=hl-144-36><a class=lnlinks href=#hl-144-36>36</a>
</span><span class=lnt id=hl-144-37><a class=lnlinks href=#hl-144-37>37</a>
</span><span class=lnt id=hl-144-38><a class=lnlinks href=#hl-144-38>38</a>
</span><span class=lnt id=hl-144-39><a class=lnlinks href=#hl-144-39>39</a>
</span><span class=lnt id=hl-144-40><a class=lnlinks href=#hl-144-40>40</a>
</span><span class=lnt id=hl-144-41><a class=lnlinks href=#hl-144-41>41</a>
</span><span class=lnt id=hl-144-42><a class=lnlinks href=#hl-144-42>42</a>
</span><span class=lnt id=hl-144-43><a class=lnlinks href=#hl-144-43>43</a>
</span><span class=lnt id=hl-144-44><a class=lnlinks href=#hl-144-44>44</a>
</span><span class=lnt id=hl-144-45><a class=lnlinks href=#hl-144-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=p>,</span><span class=n>t2</span><span class=p>,</span><span class=n>t3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test4</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Vector</span><span class=o>&lt;</span><span class=n>Dog</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Vector</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>39</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>d</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>t2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;===============&gt; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>t3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;===============&gt; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t3</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t3</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>()).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>参考资料</p><p><a class=link href=https://github.com/farmerjohngit/myblog/issues/12 target=_blank rel=noopener>https://github.com/farmerjohngit/myblog/issues/12
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><p><a class=link href=https://www.cnblogs.com/LemonFive/p/11246086.html target=_blank rel=noopener>https://www.cnblogs.com/LemonFive/p/11246086.html
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><p><a class=link href=https://www.cnblogs.com/LemonFive/p/11248248.html target=_blank rel=noopener>https://www.cnblogs.com/LemonFive/p/11248248.html
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><p>[偏向锁论文](<a class=link href=https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-149958.pdf target=_blank rel=noopener>Eliminating Synchronization-Related Atomic Operations with Biased Locking and Bulk Rebiasing (oracle.com)
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>)</p></blockquote><h5 id=锁消除><a href=#%e9%94%81%e6%b6%88%e9%99%a4 class=header-anchor>#</a>
锁消除</h5><p>锁消除</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-145-1><a class=lnlinks href=#hl-145-1> 1</a>
</span><span class=lnt id=hl-145-2><a class=lnlinks href=#hl-145-2> 2</a>
</span><span class=lnt id=hl-145-3><a class=lnlinks href=#hl-145-3> 3</a>
</span><span class=lnt id=hl-145-4><a class=lnlinks href=#hl-145-4> 4</a>
</span><span class=lnt id=hl-145-5><a class=lnlinks href=#hl-145-5> 5</a>
</span><span class=lnt id=hl-145-6><a class=lnlinks href=#hl-145-6> 6</a>
</span><span class=lnt id=hl-145-7><a class=lnlinks href=#hl-145-7> 7</a>
</span><span class=lnt id=hl-145-8><a class=lnlinks href=#hl-145-8> 8</a>
</span><span class=lnt id=hl-145-9><a class=lnlinks href=#hl-145-9> 9</a>
</span><span class=lnt id=hl-145-10><a class=lnlinks href=#hl-145-10>10</a>
</span><span class=lnt id=hl-145-11><a class=lnlinks href=#hl-145-11>11</a>
</span><span class=lnt id=hl-145-12><a class=lnlinks href=#hl-145-12>12</a>
</span><span class=lnt id=hl-145-13><a class=lnlinks href=#hl-145-13>13</a>
</span><span class=lnt id=hl-145-14><a class=lnlinks href=#hl-145-14>14</a>
</span><span class=lnt id=hl-145-15><a class=lnlinks href=#hl-145-15>15</a>
</span><span class=lnt id=hl-145-16><a class=lnlinks href=#hl-145-16>16</a>
</span><span class=lnt id=hl-145-17><a class=lnlinks href=#hl-145-17>17</a>
</span><span class=lnt id=hl-145-18><a class=lnlinks href=#hl-145-18>18</a>
</span><span class=lnt id=hl-145-19><a class=lnlinks href=#hl-145-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Fork</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@BenchmarkMode</span><span class=p>(</span><span class=n>Mode</span><span class=p>.</span><span class=na>AverageTime</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Warmup</span><span class=p>(</span><span class=n>iterations</span><span class=o>=</span><span class=n>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Measurement</span><span class=p>(</span><span class=n>iterations</span><span class=o>=</span><span class=n>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@OutputTimeUnit</span><span class=p>(</span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>NANOSECONDS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyBenchmark</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Benchmark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>x</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Benchmark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>x</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>java -jar benchmarks.jar</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-146-1><a class=lnlinks href=#hl-146-1>1</a>
</span><span class=lnt id=hl-146-2><a class=lnlinks href=#hl-146-2>2</a>
</span><span class=lnt id=hl-146-3><a class=lnlinks href=#hl-146-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Benchmark 			Mode 		Samples 	Score 		Score error 	Units 
</span></span><span class=line><span class=cl>c.i.MyBenchmark.a 	avgt 		<span class=m>5</span> 			1.542 			0.056 		ns/op 
</span></span><span class=line><span class=cl>c.i.MyBenchmark.b 	avgt 		<span class=m>5</span> 			1.518 			0.091 		ns/op 
</span></span></code></pre></td></tr></table></div></div><p><code>java -XX:-EliminateLocks -jar benchmarks.jar</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-147-1><a class=lnlinks href=#hl-147-1>1</a>
</span><span class=lnt id=hl-147-2><a class=lnlinks href=#hl-147-2>2</a>
</span><span class=lnt id=hl-147-3><a class=lnlinks href=#hl-147-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Benchmark 			Mode 		Samples 		Score 		Score error 	Units 
</span></span><span class=line><span class=cl>c.i.MyBenchmark.a 	avgt 		<span class=m>5</span> 				1.507 		0.108 			ns/op 
</span></span><span class=line><span class=cl>c.i.MyBenchmark.b 	avgt 		<span class=m>5</span> 				16.976 		1.572 			ns/op
</span></span></code></pre></td></tr></table></div></div><p>锁粗化</p><p>对相同对象多次加锁，导致线程发生多次重入，可以使用锁粗化方式来优化，这不同于之前讲的细分锁的粒度。</p><h2 id=47-wait-notify><a href=#47-wait-notify class=header-anchor>#</a>
4.7 wait notify</h2><h4 id=font-colorblue-原理之-wait--notifyfont><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-wait--notifyfont class=header-anchor>#</a>
<font color=blue>* 原理之 wait / notify</font></h4><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317191950175.png width=900 height=600 loading=lazy decoding=async alt=image-20220317191950175 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>Owner 线程发现条件不满足，调用 wait 方法，即可进入 WaitSet 变为 WAITING 状态</li><li>BLOCKED 和 WAITING 的线程都处于阻塞状态，不占用 CPU 时间片</li><li>BLOCKED 线程会在 Owner 线程释放锁时唤醒</li><li>WAITING 线程会在 Owner 线程调用 notify 或 notifyAll 时唤醒，但唤醒后并不意味者立刻获得锁，仍需进入 EntryList 重新竞争</li></ul><h4 id=api-介绍><a href=#api-%e4%bb%8b%e7%bb%8d class=header-anchor>#</a>
<strong>API 介绍</strong></h4><ul><li><code>obj.wait()</code> 让进入 object 监视器的线程到 waitSet 等待</li><li><code>obj.notify()</code> 在 object 上正在 waitSet 等待的线程中挑一个唤醒</li><li><code>obj.notifyAll()</code> 让 object 上正在 waitSet 等待的线程全部唤醒</li></ul><p>它们都是线程之间进行协作的手段，都属于 Object 对象的方法。必须获得此对象的锁，才能调用这几个方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-148-1><a class=lnlinks href=#hl-148-1> 1</a>
</span><span class=lnt id=hl-148-2><a class=lnlinks href=#hl-148-2> 2</a>
</span><span class=lnt id=hl-148-3><a class=lnlinks href=#hl-148-3> 3</a>
</span><span class=lnt id=hl-148-4><a class=lnlinks href=#hl-148-4> 4</a>
</span><span class=lnt id=hl-148-5><a class=lnlinks href=#hl-148-5> 5</a>
</span><span class=lnt id=hl-148-6><a class=lnlinks href=#hl-148-6> 6</a>
</span><span class=lnt id=hl-148-7><a class=lnlinks href=#hl-148-7> 7</a>
</span><span class=lnt id=hl-148-8><a class=lnlinks href=#hl-148-8> 8</a>
</span><span class=lnt id=hl-148-9><a class=lnlinks href=#hl-148-9> 9</a>
</span><span class=lnt id=hl-148-10><a class=lnlinks href=#hl-148-10>10</a>
</span><span class=lnt id=hl-148-11><a class=lnlinks href=#hl-148-11>11</a>
</span><span class=lnt id=hl-148-12><a class=lnlinks href=#hl-148-12>12</a>
</span><span class=lnt id=hl-148-13><a class=lnlinks href=#hl-148-13>13</a>
</span><span class=lnt id=hl-148-14><a class=lnlinks href=#hl-148-14>14</a>
</span><span class=lnt id=hl-148-15><a class=lnlinks href=#hl-148-15>15</a>
</span><span class=lnt id=hl-148-16><a class=lnlinks href=#hl-148-16>16</a>
</span><span class=lnt id=hl-148-17><a class=lnlinks href=#hl-148-17>17</a>
</span><span class=lnt id=hl-148-18><a class=lnlinks href=#hl-148-18>18</a>
</span><span class=lnt id=hl-148-19><a class=lnlinks href=#hl-148-19>19</a>
</span><span class=lnt id=hl-148-20><a class=lnlinks href=#hl-148-20>20</a>
</span><span class=lnt id=hl-148-21><a class=lnlinks href=#hl-148-21>21</a>
</span><span class=lnt id=hl-148-22><a class=lnlinks href=#hl-148-22>22</a>
</span><span class=lnt id=hl-148-23><a class=lnlinks href=#hl-148-23>23</a>
</span><span class=lnt id=hl-148-24><a class=lnlinks href=#hl-148-24>24</a>
</span><span class=lnt id=hl-148-25><a class=lnlinks href=#hl-148-25>25</a>
</span><span class=lnt id=hl-148-26><a class=lnlinks href=#hl-148-26>26</a>
</span><span class=lnt id=hl-148-27><a class=lnlinks href=#hl-148-27>27</a>
</span><span class=lnt id=hl-148-28><a class=lnlinks href=#hl-148-28>28</a>
</span><span class=lnt id=hl-148-29><a class=lnlinks href=#hl-148-29>29</a>
</span><span class=lnt id=hl-148-30><a class=lnlinks href=#hl-148-30>30</a>
</span><span class=lnt id=hl-148-31><a class=lnlinks href=#hl-148-31>31</a>
</span><span class=lnt id=hl-148-32><a class=lnlinks href=#hl-148-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;执行....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>obj</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w> </span><span class=c1>// 让线程在obj上一直等待下去</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;其它代码....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;执行....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>obj</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w> </span><span class=c1>// 让线程在obj上一直等待下去</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;其它代码....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 主线程两秒后执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;唤醒 obj 上其它线程&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>obj</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w> </span><span class=c1>// 唤醒obj上一个线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// obj.notifyAll(); // 唤醒obj上所有等待线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>notify 的一种结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-149-1><a class=lnlinks href=#hl-149-1>1</a>
</span><span class=lnt id=hl-149-2><a class=lnlinks href=#hl-149-2>2</a>
</span><span class=lnt id=hl-149-3><a class=lnlinks href=#hl-149-3>3</a>
</span><span class=lnt id=hl-149-4><a class=lnlinks href=#hl-149-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:00:53.096 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestWaitNotify - 执行.... 
</span></span><span class=line><span class=cl>20:00:53.099 <span class=o>[</span>Thread-1<span class=o>]</span> c.TestWaitNotify - 执行.... 
</span></span><span class=line><span class=cl>20:00:55.096 <span class=o>[</span>main<span class=o>]</span> c.TestWaitNotify - 唤醒 obj 上其它线程
</span></span><span class=line><span class=cl>20:00:55.096 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestWaitNotify - 其它代码.... 
</span></span></code></pre></td></tr></table></div></div><p>notifyAll 的结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-150-1><a class=lnlinks href=#hl-150-1>1</a>
</span><span class=lnt id=hl-150-2><a class=lnlinks href=#hl-150-2>2</a>
</span><span class=lnt id=hl-150-3><a class=lnlinks href=#hl-150-3>3</a>
</span><span class=lnt id=hl-150-4><a class=lnlinks href=#hl-150-4>4</a>
</span><span class=lnt id=hl-150-5><a class=lnlinks href=#hl-150-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:58:15.457 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestWaitNotify - 执行.... 
</span></span><span class=line><span class=cl>19:58:15.460 <span class=o>[</span>Thread-1<span class=o>]</span> c.TestWaitNotify - 执行.... 
</span></span><span class=line><span class=cl>19:58:17.456 <span class=o>[</span>main<span class=o>]</span> c.TestWaitNotify - 唤醒 obj 上其它线程
</span></span><span class=line><span class=cl>19:58:17.456 <span class=o>[</span>Thread-1<span class=o>]</span> c.TestWaitNotify - 其它代码.... 
</span></span><span class=line><span class=cl>19:58:17.456 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestWaitNotify - 其它代码.... 
</span></span></code></pre></td></tr></table></div></div><p><code>wait()</code> 方法会释放对象的锁，进入 WaitSet 等待区，从而让其他线程就机会获取对象的锁。无限制等待，直到 notify 为止</p><p><code>wait(long n)</code> 有时限的等待, 到 n 毫秒后结束等待，或是被 notify</p><h2 id=48-wait-notify-的正确姿势><a href=#48-wait-notify-%e7%9a%84%e6%ad%a3%e7%a1%ae%e5%a7%bf%e5%8a%bf class=header-anchor>#</a>
4.8 wait notify 的正确姿势</h2><p>开始之前先看看</p><h4 id=sleeplong-n-和-waitlong-n-的区别><a href=#sleeplong-n-%e5%92%8c-waitlong-n-%e7%9a%84%e5%8c%ba%e5%88%ab class=header-anchor>#</a>
<code>sleep(long n)</code> 和 <code>wait(long n)</code> 的区别</h4><ol><li>sleep 是 Thread 方法，而 wait 是 Object 的方法</li><li>sleep 不需要强制和 synchronized 配合使用，但 wait 需要 和 synchronized 一起用</li><li>sleep 在睡眠的同时，不会释放对象锁的，但 wait 在等待的时候会释放对象锁</li><li>它们 状态 TIMED_WAITING</li></ol><h4 id=step-1><a href=#step-1 class=header-anchor>#</a>
step 1</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-151-1><a class=lnlinks href=#hl-151-1>1</a>
</span><span class=lnt id=hl-151-2><a class=lnlinks href=#hl-151-2>2</a>
</span><span class=lnt id=hl-151-3><a class=lnlinks href=#hl-151-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>room</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasCigarette</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasTakeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>思考下面的解决方案好不好，为什么？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-152-1><a class=lnlinks href=#hl-152-1> 1</a>
</span><span class=lnt id=hl-152-2><a class=lnlinks href=#hl-152-2> 2</a>
</span><span class=lnt id=hl-152-3><a class=lnlinks href=#hl-152-3> 3</a>
</span><span class=lnt id=hl-152-4><a class=lnlinks href=#hl-152-4> 4</a>
</span><span class=lnt id=hl-152-5><a class=lnlinks href=#hl-152-5> 5</a>
</span><span class=lnt id=hl-152-6><a class=lnlinks href=#hl-152-6> 6</a>
</span><span class=lnt id=hl-152-7><a class=lnlinks href=#hl-152-7> 7</a>
</span><span class=lnt id=hl-152-8><a class=lnlinks href=#hl-152-8> 8</a>
</span><span class=lnt id=hl-152-9><a class=lnlinks href=#hl-152-9> 9</a>
</span><span class=lnt id=hl-152-10><a class=lnlinks href=#hl-152-10>10</a>
</span><span class=lnt id=hl-152-11><a class=lnlinks href=#hl-152-11>11</a>
</span><span class=lnt id=hl-152-12><a class=lnlinks href=#hl-152-12>12</a>
</span><span class=lnt id=hl-152-13><a class=lnlinks href=#hl-152-13>13</a>
</span><span class=lnt id=hl-152-14><a class=lnlinks href=#hl-152-14>14</a>
</span><span class=lnt id=hl-152-15><a class=lnlinks href=#hl-152-15>15</a>
</span><span class=lnt id=hl-152-16><a class=lnlinks href=#hl-152-16>16</a>
</span><span class=lnt id=hl-152-17><a class=lnlinks href=#hl-152-17>17</a>
</span><span class=lnt id=hl-152-18><a class=lnlinks href=#hl-152-18>18</a>
</span><span class=lnt id=hl-152-19><a class=lnlinks href=#hl-152-19>19</a>
</span><span class=lnt id=hl-152-20><a class=lnlinks href=#hl-152-20>20</a>
</span><span class=lnt id=hl-152-21><a class=lnlinks href=#hl-152-21>21</a>
</span><span class=lnt id=hl-152-22><a class=lnlinks href=#hl-152-22>22</a>
</span><span class=lnt id=hl-152-23><a class=lnlinks href=#hl-152-23>23</a>
</span><span class=lnt id=hl-152-24><a class=lnlinks href=#hl-152-24>24</a>
</span><span class=lnt id=hl-152-25><a class=lnlinks href=#hl-152-25>25</a>
</span><span class=lnt id=hl-152-26><a class=lnlinks href=#hl-152-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;有烟没？[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;没烟，先歇会！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;有烟没？[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;可以开始干活了&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;小南&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;可以开始干活了&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;其它人&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 这里能不能加 synchronized (room)？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hasCigarette</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;烟到了噢！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;送烟的&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-153-1><a class=lnlinks href=#hl-153-1> 1</a>
</span><span class=lnt id=hl-153-2><a class=lnlinks href=#hl-153-2> 2</a>
</span><span class=lnt id=hl-153-3><a class=lnlinks href=#hl-153-3> 3</a>
</span><span class=lnt id=hl-153-4><a class=lnlinks href=#hl-153-4> 4</a>
</span><span class=lnt id=hl-153-5><a class=lnlinks href=#hl-153-5> 5</a>
</span><span class=lnt id=hl-153-6><a class=lnlinks href=#hl-153-6> 6</a>
</span><span class=lnt id=hl-153-7><a class=lnlinks href=#hl-153-7> 7</a>
</span><span class=lnt id=hl-153-8><a class=lnlinks href=#hl-153-8> 8</a>
</span><span class=lnt id=hl-153-9><a class=lnlinks href=#hl-153-9> 9</a>
</span><span class=lnt id=hl-153-10><a class=lnlinks href=#hl-153-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:49:49.883 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 有烟没？<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:49:49.887 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 没烟，先歇会！
</span></span><span class=line><span class=cl>20:49:50.882 <span class=o>[</span>送烟的<span class=o>]</span> c.TestCorrectPosture - 烟到了噢！
</span></span><span class=line><span class=cl>20:49:51.887 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 有烟没？<span class=o>[</span>true<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:49:51.887 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 可以开始干活了
</span></span><span class=line><span class=cl>20:49:51.887 <span class=o>[</span>其它人<span class=o>]</span> c.TestCorrectPosture - 可以开始干活了
</span></span><span class=line><span class=cl>20:49:51.887 <span class=o>[</span>其它人<span class=o>]</span> c.TestCorrectPosture - 可以开始干活了
</span></span><span class=line><span class=cl>20:49:51.888 <span class=o>[</span>其它人<span class=o>]</span> c.TestCorrectPosture - 可以开始干活了
</span></span><span class=line><span class=cl>20:49:51.888 <span class=o>[</span>其它人<span class=o>]</span> c.TestCorrectPosture - 可以开始干活了
</span></span><span class=line><span class=cl>20:49:51.888 <span class=o>[</span>其它人<span class=o>]</span> c.TestCorrectPosture - 可以开始干活了
</span></span></code></pre></td></tr></table></div></div><ul><li>其它干活的线程，都要一直阻塞，效率太低</li><li>小南线程必须睡足 2s 后才能醒来，就算烟提前送到，也无法立刻醒来</li><li>加了 synchronized (room) 后，就好比小南在里面反锁了门睡觉，烟根本没法送进门，main 没加 synchronized 就好像 main 线程是翻窗户进来的</li><li>解决方法，使用 wait - notify 机制</li></ul><h4 id=step-2><a href=#step-2 class=header-anchor>#</a>
step 2</h4><p>思考下面的实现行吗，为什么？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-154-1><a class=lnlinks href=#hl-154-1> 1</a>
</span><span class=lnt id=hl-154-2><a class=lnlinks href=#hl-154-2> 2</a>
</span><span class=lnt id=hl-154-3><a class=lnlinks href=#hl-154-3> 3</a>
</span><span class=lnt id=hl-154-4><a class=lnlinks href=#hl-154-4> 4</a>
</span><span class=lnt id=hl-154-5><a class=lnlinks href=#hl-154-5> 5</a>
</span><span class=lnt id=hl-154-6><a class=lnlinks href=#hl-154-6> 6</a>
</span><span class=lnt id=hl-154-7><a class=lnlinks href=#hl-154-7> 7</a>
</span><span class=lnt id=hl-154-8><a class=lnlinks href=#hl-154-8> 8</a>
</span><span class=lnt id=hl-154-9><a class=lnlinks href=#hl-154-9> 9</a>
</span><span class=lnt id=hl-154-10><a class=lnlinks href=#hl-154-10>10</a>
</span><span class=lnt id=hl-154-11><a class=lnlinks href=#hl-154-11>11</a>
</span><span class=lnt id=hl-154-12><a class=lnlinks href=#hl-154-12>12</a>
</span><span class=lnt id=hl-154-13><a class=lnlinks href=#hl-154-13>13</a>
</span><span class=lnt id=hl-154-14><a class=lnlinks href=#hl-154-14>14</a>
</span><span class=lnt id=hl-154-15><a class=lnlinks href=#hl-154-15>15</a>
</span><span class=lnt id=hl-154-16><a class=lnlinks href=#hl-154-16>16</a>
</span><span class=lnt id=hl-154-17><a class=lnlinks href=#hl-154-17>17</a>
</span><span class=lnt id=hl-154-18><a class=lnlinks href=#hl-154-18>18</a>
</span><span class=lnt id=hl-154-19><a class=lnlinks href=#hl-154-19>19</a>
</span><span class=lnt id=hl-154-20><a class=lnlinks href=#hl-154-20>20</a>
</span><span class=lnt id=hl-154-21><a class=lnlinks href=#hl-154-21>21</a>
</span><span class=lnt id=hl-154-22><a class=lnlinks href=#hl-154-22>22</a>
</span><span class=lnt id=hl-154-23><a class=lnlinks href=#hl-154-23>23</a>
</span><span class=lnt id=hl-154-24><a class=lnlinks href=#hl-154-24>24</a>
</span><span class=lnt id=hl-154-25><a class=lnlinks href=#hl-154-25>25</a>
</span><span class=lnt id=hl-154-26><a class=lnlinks href=#hl-154-26>26</a>
</span><span class=lnt id=hl-154-27><a class=lnlinks href=#hl-154-27>27</a>
</span><span class=lnt id=hl-154-28><a class=lnlinks href=#hl-154-28>28</a>
</span><span class=lnt id=hl-154-29><a class=lnlinks href=#hl-154-29>29</a>
</span><span class=lnt id=hl-154-30><a class=lnlinks href=#hl-154-30>30</a>
</span><span class=lnt id=hl-154-31><a class=lnlinks href=#hl-154-31>31</a>
</span><span class=lnt id=hl-154-32><a class=lnlinks href=#hl-154-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;有烟没？[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;没烟，先歇会！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>room</span><span class=p>.</span><span class=na>wait</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;有烟没？[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;可以开始干活了&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;小南&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;可以开始干活了&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;其它人&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hasCigarette</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;烟到了噢！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>room</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;送烟的&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>解决了其它干活的线程阻塞的问题</li><li>但如果有其它线程也在等待条件呢？</li></ul><h4 id=step-3><a href=#step-3 class=header-anchor>#</a>
step 3</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-155-1><a class=lnlinks href=#hl-155-1> 1</a>
</span><span class=lnt id=hl-155-2><a class=lnlinks href=#hl-155-2> 2</a>
</span><span class=lnt id=hl-155-3><a class=lnlinks href=#hl-155-3> 3</a>
</span><span class=lnt id=hl-155-4><a class=lnlinks href=#hl-155-4> 4</a>
</span><span class=lnt id=hl-155-5><a class=lnlinks href=#hl-155-5> 5</a>
</span><span class=lnt id=hl-155-6><a class=lnlinks href=#hl-155-6> 6</a>
</span><span class=lnt id=hl-155-7><a class=lnlinks href=#hl-155-7> 7</a>
</span><span class=lnt id=hl-155-8><a class=lnlinks href=#hl-155-8> 8</a>
</span><span class=lnt id=hl-155-9><a class=lnlinks href=#hl-155-9> 9</a>
</span><span class=lnt id=hl-155-10><a class=lnlinks href=#hl-155-10>10</a>
</span><span class=lnt id=hl-155-11><a class=lnlinks href=#hl-155-11>11</a>
</span><span class=lnt id=hl-155-12><a class=lnlinks href=#hl-155-12>12</a>
</span><span class=lnt id=hl-155-13><a class=lnlinks href=#hl-155-13>13</a>
</span><span class=lnt id=hl-155-14><a class=lnlinks href=#hl-155-14>14</a>
</span><span class=lnt id=hl-155-15><a class=lnlinks href=#hl-155-15>15</a>
</span><span class=lnt id=hl-155-16><a class=lnlinks href=#hl-155-16>16</a>
</span><span class=lnt id=hl-155-17><a class=lnlinks href=#hl-155-17>17</a>
</span><span class=lnt id=hl-155-18><a class=lnlinks href=#hl-155-18>18</a>
</span><span class=lnt id=hl-155-19><a class=lnlinks href=#hl-155-19>19</a>
</span><span class=lnt id=hl-155-20><a class=lnlinks href=#hl-155-20>20</a>
</span><span class=lnt id=hl-155-21><a class=lnlinks href=#hl-155-21>21</a>
</span><span class=lnt id=hl-155-22><a class=lnlinks href=#hl-155-22>22</a>
</span><span class=lnt id=hl-155-23><a class=lnlinks href=#hl-155-23>23</a>
</span><span class=lnt id=hl-155-24><a class=lnlinks href=#hl-155-24>24</a>
</span><span class=lnt id=hl-155-25><a class=lnlinks href=#hl-155-25>25</a>
</span><span class=lnt id=hl-155-26><a class=lnlinks href=#hl-155-26>26</a>
</span><span class=lnt id=hl-155-27><a class=lnlinks href=#hl-155-27>27</a>
</span><span class=lnt id=hl-155-28><a class=lnlinks href=#hl-155-28>28</a>
</span><span class=lnt id=hl-155-29><a class=lnlinks href=#hl-155-29>29</a>
</span><span class=lnt id=hl-155-30><a class=lnlinks href=#hl-155-30>30</a>
</span><span class=lnt id=hl-155-31><a class=lnlinks href=#hl-155-31>31</a>
</span><span class=lnt id=hl-155-32><a class=lnlinks href=#hl-155-32>32</a>
</span><span class=lnt id=hl-155-33><a class=lnlinks href=#hl-155-33>33</a>
</span><span class=lnt id=hl-155-34><a class=lnlinks href=#hl-155-34>34</a>
</span><span class=lnt id=hl-155-35><a class=lnlinks href=#hl-155-35>35</a>
</span><span class=lnt id=hl-155-36><a class=lnlinks href=#hl-155-36>36</a>
</span><span class=lnt id=hl-155-37><a class=lnlinks href=#hl-155-37>37</a>
</span><span class=lnt id=hl-155-38><a class=lnlinks href=#hl-155-38>38</a>
</span><span class=lnt id=hl-155-39><a class=lnlinks href=#hl-155-39>39</a>
</span><span class=lnt id=hl-155-40><a class=lnlinks href=#hl-155-40>40</a>
</span><span class=lnt id=hl-155-41><a class=lnlinks href=#hl-155-41>41</a>
</span><span class=lnt id=hl-155-42><a class=lnlinks href=#hl-155-42>42</a>
</span><span class=lnt id=hl-155-43><a class=lnlinks href=#hl-155-43>43</a>
</span><span class=lnt id=hl-155-44><a class=lnlinks href=#hl-155-44>44</a>
</span><span class=lnt id=hl-155-45><a class=lnlinks href=#hl-155-45>45</a>
</span><span class=lnt id=hl-155-46><a class=lnlinks href=#hl-155-46>46</a>
</span><span class=lnt id=hl-155-47><a class=lnlinks href=#hl-155-47>47</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;有烟没？[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;没烟，先歇会！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>room</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;有烟没？[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;可以开始干活了&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;没干成活...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;小南&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;外卖送到没？[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasTakeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasTakeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;没外卖，先歇会！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>room</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;外卖送到没？[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasTakeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasTakeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;可以开始干活了&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;没干成活...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;小女&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hasTakeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;外卖到了噢！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>room</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;送外卖的&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-156-1><a class=lnlinks href=#hl-156-1>1</a>
</span><span class=lnt id=hl-156-2><a class=lnlinks href=#hl-156-2>2</a>
</span><span class=lnt id=hl-156-3><a class=lnlinks href=#hl-156-3>3</a>
</span><span class=lnt id=hl-156-4><a class=lnlinks href=#hl-156-4>4</a>
</span><span class=lnt id=hl-156-5><a class=lnlinks href=#hl-156-5>5</a>
</span><span class=lnt id=hl-156-6><a class=lnlinks href=#hl-156-6>6</a>
</span><span class=lnt id=hl-156-7><a class=lnlinks href=#hl-156-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:53:12.173 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 有烟没？<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:53:12.176 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 没烟，先歇会！
</span></span><span class=line><span class=cl>20:53:12.176 <span class=o>[</span>小女<span class=o>]</span> c.TestCorrectPosture - 外卖送到没？<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:53:12.176 <span class=o>[</span>小女<span class=o>]</span> c.TestCorrectPosture - 没外卖，先歇会！
</span></span><span class=line><span class=cl>20:53:13.174 <span class=o>[</span>送外卖的<span class=o>]</span> c.TestCorrectPosture - 外卖到了噢！
</span></span><span class=line><span class=cl>20:53:13.174 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 有烟没？<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:53:13.174 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 没干成活... 
</span></span></code></pre></td></tr></table></div></div><ul><li>notify 只能随机唤醒一个 WaitSet 中的线程，这时如果有其它线程也在等待，那么就可能唤醒不了正确的线 程，称之为【虚假唤醒】</li><li>解决方法，改为 notifyAll</li></ul><h4 id=step-4><a href=#step-4 class=header-anchor>#</a>
step 4</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-157-1><a class=lnlinks href=#hl-157-1>1</a>
</span><span class=lnt id=hl-157-2><a class=lnlinks href=#hl-157-2>2</a>
</span><span class=lnt id=hl-157-3><a class=lnlinks href=#hl-157-3>3</a>
</span><span class=lnt id=hl-157-4><a class=lnlinks href=#hl-157-4>4</a>
</span><span class=lnt id=hl-157-5><a class=lnlinks href=#hl-157-5>5</a>
</span><span class=lnt id=hl-157-6><a class=lnlinks href=#hl-157-6>6</a>
</span><span class=lnt id=hl-157-7><a class=lnlinks href=#hl-157-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hasTakeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;外卖到了噢！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>room</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;送外卖的&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-158-1><a class=lnlinks href=#hl-158-1>1</a>
</span><span class=lnt id=hl-158-2><a class=lnlinks href=#hl-158-2>2</a>
</span><span class=lnt id=hl-158-3><a class=lnlinks href=#hl-158-3>3</a>
</span><span class=lnt id=hl-158-4><a class=lnlinks href=#hl-158-4>4</a>
</span><span class=lnt id=hl-158-5><a class=lnlinks href=#hl-158-5>5</a>
</span><span class=lnt id=hl-158-6><a class=lnlinks href=#hl-158-6>6</a>
</span><span class=lnt id=hl-158-7><a class=lnlinks href=#hl-158-7>7</a>
</span><span class=lnt id=hl-158-8><a class=lnlinks href=#hl-158-8>8</a>
</span><span class=lnt id=hl-158-9><a class=lnlinks href=#hl-158-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:55:23.978 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 有烟没？<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:55:23.982 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 没烟，先歇会！
</span></span><span class=line><span class=cl>20:55:23.982 <span class=o>[</span>小女<span class=o>]</span> c.TestCorrectPosture - 外卖送到没？<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:55:23.982 <span class=o>[</span>小女<span class=o>]</span> c.TestCorrectPosture - 没外卖，先歇会！
</span></span><span class=line><span class=cl>20:55:24.979 <span class=o>[</span>送外卖的<span class=o>]</span> c.TestCorrectPosture - 外卖到了噢！
</span></span><span class=line><span class=cl>20:55:24.979 <span class=o>[</span>小女<span class=o>]</span> c.TestCorrectPosture - 外卖送到没？<span class=o>[</span>true<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:55:24.980 <span class=o>[</span>小女<span class=o>]</span> c.TestCorrectPosture - 可以开始干活了
</span></span><span class=line><span class=cl>20:55:24.980 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 有烟没？<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:55:24.980 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 没干成活... 
</span></span></code></pre></td></tr></table></div></div><ul><li>用 notifyAll 仅解决某个线程的唤醒问题，但使用 if + wait 判断仅有一次机会，一旦条件不成立，就没有重新判断的机会了</li><li>解决方法，用 while + wait，当条件不成立，再次 wait</li></ul><h4 id=step-5><a href=#step-5 class=header-anchor>#</a>
step 5</h4><p>将 if 改为 while</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-159-1><a class=lnlinks href=#hl-159-1>1</a>
</span><span class=lnt id=hl-159-2><a class=lnlinks href=#hl-159-2>2</a>
</span><span class=lnt id=hl-159-3><a class=lnlinks href=#hl-159-3>3</a>
</span><span class=lnt id=hl-159-4><a class=lnlinks href=#hl-159-4>4</a>
</span><span class=lnt id=hl-159-5><a class=lnlinks href=#hl-159-5>5</a>
</span><span class=lnt id=hl-159-6><a class=lnlinks href=#hl-159-6>6</a>
</span><span class=lnt id=hl-159-7><a class=lnlinks href=#hl-159-7>7</a>
</span><span class=lnt id=hl-159-8><a class=lnlinks href=#hl-159-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;没烟，先歇会！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>room</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>改动后</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-160-1><a class=lnlinks href=#hl-160-1>1</a>
</span><span class=lnt id=hl-160-2><a class=lnlinks href=#hl-160-2>2</a>
</span><span class=lnt id=hl-160-3><a class=lnlinks href=#hl-160-3>3</a>
</span><span class=lnt id=hl-160-4><a class=lnlinks href=#hl-160-4>4</a>
</span><span class=lnt id=hl-160-5><a class=lnlinks href=#hl-160-5>5</a>
</span><span class=lnt id=hl-160-6><a class=lnlinks href=#hl-160-6>6</a>
</span><span class=lnt id=hl-160-7><a class=lnlinks href=#hl-160-7>7</a>
</span><span class=lnt id=hl-160-8><a class=lnlinks href=#hl-160-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;没烟，先歇会！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>room</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-161-1><a class=lnlinks href=#hl-161-1>1</a>
</span><span class=lnt id=hl-161-2><a class=lnlinks href=#hl-161-2>2</a>
</span><span class=lnt id=hl-161-3><a class=lnlinks href=#hl-161-3>3</a>
</span><span class=lnt id=hl-161-4><a class=lnlinks href=#hl-161-4>4</a>
</span><span class=lnt id=hl-161-5><a class=lnlinks href=#hl-161-5>5</a>
</span><span class=lnt id=hl-161-6><a class=lnlinks href=#hl-161-6>6</a>
</span><span class=lnt id=hl-161-7><a class=lnlinks href=#hl-161-7>7</a>
</span><span class=lnt id=hl-161-8><a class=lnlinks href=#hl-161-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:58:34.322 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 有烟没？<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:58:34.326 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 没烟，先歇会！
</span></span><span class=line><span class=cl>20:58:34.326 <span class=o>[</span>小女<span class=o>]</span> c.TestCorrectPosture - 外卖送到没？<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:58:34.326 <span class=o>[</span>小女<span class=o>]</span> c.TestCorrectPosture - 没外卖，先歇会！
</span></span><span class=line><span class=cl>20:58:35.323 <span class=o>[</span>送外卖的<span class=o>]</span> c.TestCorrectPosture - 外卖到了噢！
</span></span><span class=line><span class=cl>20:58:35.324 <span class=o>[</span>小女<span class=o>]</span> c.TestCorrectPosture - 外卖送到没？<span class=o>[</span>true<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:58:35.324 <span class=o>[</span>小女<span class=o>]</span> c.TestCorrectPosture - 可以开始干活了
</span></span><span class=line><span class=cl>20:58:35.324 <span class=o>[</span>小南<span class=o>]</span> c.TestCorrectPosture - 没烟，先歇会！
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-162-1><a class=lnlinks href=#hl-162-1> 1</a>
</span><span class=lnt id=hl-162-2><a class=lnlinks href=#hl-162-2> 2</a>
</span><span class=lnt id=hl-162-3><a class=lnlinks href=#hl-162-3> 3</a>
</span><span class=lnt id=hl-162-4><a class=lnlinks href=#hl-162-4> 4</a>
</span><span class=lnt id=hl-162-5><a class=lnlinks href=#hl-162-5> 5</a>
</span><span class=lnt id=hl-162-6><a class=lnlinks href=#hl-162-6> 6</a>
</span><span class=lnt id=hl-162-7><a class=lnlinks href=#hl-162-7> 7</a>
</span><span class=lnt id=hl-162-8><a class=lnlinks href=#hl-162-8> 8</a>
</span><span class=lnt id=hl-162-9><a class=lnlinks href=#hl-162-9> 9</a>
</span><span class=lnt id=hl-162-10><a class=lnlinks href=#hl-162-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>synchronized</span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>条件不成立</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 干活</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//另一个线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>synchronized</span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=textcolororange模式之保护性暂停><a href=#textcolororange%e6%a8%a1%e5%bc%8f%e4%b9%8b%e4%bf%9d%e6%8a%a4%e6%80%a7%e6%9a%82%e5%81%9c class=header-anchor>#</a>
$\textcolor{orange}{*模式之保护性暂停}$</h4><h5 id=1定义><a href=#1%e5%ae%9a%e4%b9%89 class=header-anchor>#</a>
<strong>1.定义</strong></h5><p>即 Guarded Suspension，用在一个线程等待另一个线程的执行结果</p><p>要点</p><ul><li>有一个结果需要从一个线程传递到另一个线程，让他们关联同一个 GuardedObject</li><li>如果有结果不断从一个线程到另一个线程那么可以使用消息队列（见生产者/消费者）</li><li>JDK 中，join 的实现、Future 的实现，采用的就是此模式</li><li>因为要等待另一方的结果，因此归类到同步模式</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304134602353.png width=900 height=600 loading=lazy decoding=async alt=image-20220304134602353 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=2实现><a href=#2%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
<strong>2.实现</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-163-1><a class=lnlinks href=#hl-163-1> 1</a>
</span><span class=lnt id=hl-163-2><a class=lnlinks href=#hl-163-2> 2</a>
</span><span class=lnt id=hl-163-3><a class=lnlinks href=#hl-163-3> 3</a>
</span><span class=lnt id=hl-163-4><a class=lnlinks href=#hl-163-4> 4</a>
</span><span class=lnt id=hl-163-5><a class=lnlinks href=#hl-163-5> 5</a>
</span><span class=lnt id=hl-163-6><a class=lnlinks href=#hl-163-6> 6</a>
</span><span class=lnt id=hl-163-7><a class=lnlinks href=#hl-163-7> 7</a>
</span><span class=lnt id=hl-163-8><a class=lnlinks href=#hl-163-8> 8</a>
</span><span class=lnt id=hl-163-9><a class=lnlinks href=#hl-163-9> 9</a>
</span><span class=lnt id=hl-163-10><a class=lnlinks href=#hl-163-10>10</a>
</span><span class=lnt id=hl-163-11><a class=lnlinks href=#hl-163-11>11</a>
</span><span class=lnt id=hl-163-12><a class=lnlinks href=#hl-163-12>12</a>
</span><span class=lnt id=hl-163-13><a class=lnlinks href=#hl-163-13>13</a>
</span><span class=lnt id=hl-163-14><a class=lnlinks href=#hl-163-14>14</a>
</span><span class=lnt id=hl-163-15><a class=lnlinks href=#hl-163-15>15</a>
</span><span class=lnt id=hl-163-16><a class=lnlinks href=#hl-163-16>16</a>
</span><span class=lnt id=hl-163-17><a class=lnlinks href=#hl-163-17>17</a>
</span><span class=lnt id=hl-163-18><a class=lnlinks href=#hl-163-18>18</a>
</span><span class=lnt id=hl-163-19><a class=lnlinks href=#hl-163-19>19</a>
</span><span class=lnt id=hl-163-20><a class=lnlinks href=#hl-163-20>20</a>
</span><span class=lnt id=hl-163-21><a class=lnlinks href=#hl-163-21>21</a>
</span><span class=lnt id=hl-163-22><a class=lnlinks href=#hl-163-22>22</a>
</span><span class=lnt id=hl-163-23><a class=lnlinks href=#hl-163-23>23</a>
</span><span class=lnt id=hl-163-24><a class=lnlinks href=#hl-163-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>GuardedObject</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 条件不满足则等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>complete</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 条件满足，通知等待线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试</p><p>一个线程等待另一个线程的执行结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-164-1><a class=lnlinks href=#hl-164-1> 1</a>
</span><span class=lnt id=hl-164-2><a class=lnlinks href=#hl-164-2> 2</a>
</span><span class=lnt id=hl-164-3><a class=lnlinks href=#hl-164-3> 3</a>
</span><span class=lnt id=hl-164-4><a class=lnlinks href=#hl-164-4> 4</a>
</span><span class=lnt id=hl-164-5><a class=lnlinks href=#hl-164-5> 5</a>
</span><span class=lnt id=hl-164-6><a class=lnlinks href=#hl-164-6> 6</a>
</span><span class=lnt id=hl-164-7><a class=lnlinks href=#hl-164-7> 7</a>
</span><span class=lnt id=hl-164-8><a class=lnlinks href=#hl-164-8> 8</a>
</span><span class=lnt id=hl-164-9><a class=lnlinks href=#hl-164-9> 9</a>
</span><span class=lnt id=hl-164-10><a class=lnlinks href=#hl-164-10>10</a>
</span><span class=lnt id=hl-164-11><a class=lnlinks href=#hl-164-11>11</a>
</span><span class=lnt id=hl-164-12><a class=lnlinks href=#hl-164-12>12</a>
</span><span class=lnt id=hl-164-13><a class=lnlinks href=#hl-164-13>13</a>
</span><span class=lnt id=hl-164-14><a class=lnlinks href=#hl-164-14>14</a>
</span><span class=lnt id=hl-164-15><a class=lnlinks href=#hl-164-15>15</a>
</span><span class=lnt id=hl-164-16><a class=lnlinks href=#hl-164-16>16</a>
</span><span class=lnt id=hl-164-17><a class=lnlinks href=#hl-164-17>17</a>
</span><span class=lnt id=hl-164-18><a class=lnlinks href=#hl-164-18>18</a>
</span><span class=lnt id=hl-164-19><a class=lnlinks href=#hl-164-19>19</a>
</span><span class=lnt id=hl-164-20><a class=lnlinks href=#hl-164-20>20</a>
</span><span class=lnt id=hl-164-21><a class=lnlinks href=#hl-164-21>21</a>
</span><span class=lnt id=hl-164-22><a class=lnlinks href=#hl-164-22>22</a>
</span><span class=lnt id=hl-164-23><a class=lnlinks href=#hl-164-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GuardedObject</span><span class=w> </span><span class=n>guardedObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MailBoxes</span><span class=p>.</span><span class=na>getGuardedObject</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;送信成功,id={},内容：{}&#34;</span><span class=p>,</span><span class=n>id</span><span class=p>,</span><span class=n>mail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GuardedObject</span><span class=w> </span><span class=n>guardedObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GuardedObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 子线程执行下载</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>download</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;download complete...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>complete</span><span class=p>(</span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;waiting...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 主线程阻塞等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;get response: [{}] lines&#34;</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>response</span><span class=p>).</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>执行结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-165-1><a class=lnlinks href=#hl-165-1>1</a>
</span><span class=lnt id=hl-165-2><a class=lnlinks href=#hl-165-2>2</a>
</span><span class=lnt id=hl-165-3><a class=lnlinks href=#hl-165-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>08:42:18.568 <span class=o>[</span>main<span class=o>]</span> c.TestGuardedObject - waiting...
</span></span><span class=line><span class=cl>08:42:23.312 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestGuardedObject - download complete...
</span></span><span class=line><span class=cl>08:42:23.312 <span class=o>[</span>main<span class=o>]</span> c.TestGuardedObject - get response: <span class=o>[</span>3<span class=o>]</span> lines
</span></span></code></pre></td></tr></table></div></div><h5 id=3带超时版-guardedobject><a href=#3%e5%b8%a6%e8%b6%85%e6%97%b6%e7%89%88-guardedobject class=header-anchor>#</a>
<strong>3.带超时版 GuardedObject</strong></h5><p>如果要控制超时时间呢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-166-1><a class=lnlinks href=#hl-166-1> 1</a>
</span><span class=lnt id=hl-166-2><a class=lnlinks href=#hl-166-2> 2</a>
</span><span class=lnt id=hl-166-3><a class=lnlinks href=#hl-166-3> 3</a>
</span><span class=lnt id=hl-166-4><a class=lnlinks href=#hl-166-4> 4</a>
</span><span class=lnt id=hl-166-5><a class=lnlinks href=#hl-166-5> 5</a>
</span><span class=lnt id=hl-166-6><a class=lnlinks href=#hl-166-6> 6</a>
</span><span class=lnt id=hl-166-7><a class=lnlinks href=#hl-166-7> 7</a>
</span><span class=lnt id=hl-166-8><a class=lnlinks href=#hl-166-8> 8</a>
</span><span class=lnt id=hl-166-9><a class=lnlinks href=#hl-166-9> 9</a>
</span><span class=lnt id=hl-166-10><a class=lnlinks href=#hl-166-10>10</a>
</span><span class=lnt id=hl-166-11><a class=lnlinks href=#hl-166-11>11</a>
</span><span class=lnt id=hl-166-12><a class=lnlinks href=#hl-166-12>12</a>
</span><span class=lnt id=hl-166-13><a class=lnlinks href=#hl-166-13>13</a>
</span><span class=lnt id=hl-166-14><a class=lnlinks href=#hl-166-14>14</a>
</span><span class=lnt id=hl-166-15><a class=lnlinks href=#hl-166-15>15</a>
</span><span class=lnt id=hl-166-16><a class=lnlinks href=#hl-166-16>16</a>
</span><span class=lnt id=hl-166-17><a class=lnlinks href=#hl-166-17>17</a>
</span><span class=lnt id=hl-166-18><a class=lnlinks href=#hl-166-18>18</a>
</span><span class=lnt id=hl-166-19><a class=lnlinks href=#hl-166-19>19</a>
</span><span class=lnt id=hl-166-20><a class=lnlinks href=#hl-166-20>20</a>
</span><span class=lnt id=hl-166-21><a class=lnlinks href=#hl-166-21>21</a>
</span><span class=lnt id=hl-166-22><a class=lnlinks href=#hl-166-22>22</a>
</span><span class=lnt id=hl-166-23><a class=lnlinks href=#hl-166-23>23</a>
</span><span class=lnt id=hl-166-24><a class=lnlinks href=#hl-166-24>24</a>
</span><span class=lnt id=hl-166-25><a class=lnlinks href=#hl-166-25>25</a>
</span><span class=lnt id=hl-166-26><a class=lnlinks href=#hl-166-26>26</a>
</span><span class=lnt id=hl-166-27><a class=lnlinks href=#hl-166-27>27</a>
</span><span class=lnt id=hl-166-28><a class=lnlinks href=#hl-166-28>28</a>
</span><span class=lnt id=hl-166-29><a class=lnlinks href=#hl-166-29>29</a>
</span><span class=lnt id=hl-166-30><a class=lnlinks href=#hl-166-30>30</a>
</span><span class=lnt id=hl-166-31><a class=lnlinks href=#hl-166-31>31</a>
</span><span class=lnt id=hl-166-32><a class=lnlinks href=#hl-166-32>32</a>
</span><span class=lnt id=hl-166-33><a class=lnlinks href=#hl-166-33>33</a>
</span><span class=lnt id=hl-166-34><a class=lnlinks href=#hl-166-34>34</a>
</span><span class=lnt id=hl-166-35><a class=lnlinks href=#hl-166-35>35</a>
</span><span class=lnt id=hl-166-36><a class=lnlinks href=#hl-166-36>36</a>
</span><span class=lnt id=hl-166-37><a class=lnlinks href=#hl-166-37>37</a>
</span><span class=lnt id=hl-166-38><a class=lnlinks href=#hl-166-38>38</a>
</span><span class=lnt id=hl-166-39><a class=lnlinks href=#hl-166-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>GuardedObjectV2</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>millis</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 1) 记录最初时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>begin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// 2) 已经经历的时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>timePassed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// 4) 假设 millis 是 1000，结果在 400 时唤醒了，那么还有 600 要等</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>waitTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>millis</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>timePassed</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;waitTime: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>waitTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>waitTime</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;break...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>(</span><span class=n>waitTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// 3) 如果提前被唤醒，这时已经经历的时间假设为 400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>timePassed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;timePassed: {}, object is null {}&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>timePassed</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>complete</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// 条件满足，通知等待线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;notify...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试，没有超时</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-167-1><a class=lnlinks href=#hl-167-1> 1</a>
</span><span class=lnt id=hl-167-2><a class=lnlinks href=#hl-167-2> 2</a>
</span><span class=lnt id=hl-167-3><a class=lnlinks href=#hl-167-3> 3</a>
</span><span class=lnt id=hl-167-4><a class=lnlinks href=#hl-167-4> 4</a>
</span><span class=lnt id=hl-167-5><a class=lnlinks href=#hl-167-5> 5</a>
</span><span class=lnt id=hl-167-6><a class=lnlinks href=#hl-167-6> 6</a>
</span><span class=lnt id=hl-167-7><a class=lnlinks href=#hl-167-7> 7</a>
</span><span class=lnt id=hl-167-8><a class=lnlinks href=#hl-167-8> 8</a>
</span><span class=lnt id=hl-167-9><a class=lnlinks href=#hl-167-9> 9</a>
</span><span class=lnt id=hl-167-10><a class=lnlinks href=#hl-167-10>10</a>
</span><span class=lnt id=hl-167-11><a class=lnlinks href=#hl-167-11>11</a>
</span><span class=lnt id=hl-167-12><a class=lnlinks href=#hl-167-12>12</a>
</span><span class=lnt id=hl-167-13><a class=lnlinks href=#hl-167-13>13</a>
</span><span class=lnt id=hl-167-14><a class=lnlinks href=#hl-167-14>14</a>
</span><span class=lnt id=hl-167-15><a class=lnlinks href=#hl-167-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GuardedObjectV2</span><span class=w> </span><span class=n>v2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GuardedObjectV2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>v2</span><span class=p>.</span><span class=na>complete</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>v2</span><span class=p>.</span><span class=na>complete</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;b&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;c&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v2</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>2500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;get response: [{}] lines&#34;</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>response</span><span class=p>).</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;can&#39;t get response&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-168-1><a class=lnlinks href=#hl-168-1>1</a>
</span><span class=lnt id=hl-168-2><a class=lnlinks href=#hl-168-2>2</a>
</span><span class=lnt id=hl-168-3><a class=lnlinks href=#hl-168-3>3</a>
</span><span class=lnt id=hl-168-4><a class=lnlinks href=#hl-168-4>4</a>
</span><span class=lnt id=hl-168-5><a class=lnlinks href=#hl-168-5>5</a>
</span><span class=lnt id=hl-168-6><a class=lnlinks href=#hl-168-6>6</a>
</span><span class=lnt id=hl-168-7><a class=lnlinks href=#hl-168-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>08:49:39.917 <span class=o>[</span>main<span class=o>]</span> c.GuardedObjectV2 - waitTime: <span class=m>2500</span>
</span></span><span class=line><span class=cl>08:49:40.917 <span class=o>[</span>Thread-0<span class=o>]</span> c.GuardedObjectV2 - notify...
</span></span><span class=line><span class=cl>08:49:40.917 <span class=o>[</span>main<span class=o>]</span> c.GuardedObjectV2 - timePassed: 1003, object is null <span class=nb>true</span>
</span></span><span class=line><span class=cl>08:49:40.917 <span class=o>[</span>main<span class=o>]</span> c.GuardedObjectV2 - waitTime: <span class=m>1497</span>
</span></span><span class=line><span class=cl>08:49:41.918 <span class=o>[</span>Thread-0<span class=o>]</span> c.GuardedObjectV2 - notify...
</span></span><span class=line><span class=cl>08:49:41.918 <span class=o>[</span>main<span class=o>]</span> c.GuardedObjectV2 - timePassed: 2004, object is null <span class=nb>false</span>
</span></span><span class=line><span class=cl>08:49:41.918 <span class=o>[</span>main<span class=o>]</span> c.TestGuardedObjectV2 - get response: <span class=o>[</span>3<span class=o>]</span> lines
</span></span></code></pre></td></tr></table></div></div><p>测试超时</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-169-1><a class=lnlinks href=#hl-169-1>1</a>
</span><span class=lnt id=hl-169-2><a class=lnlinks href=#hl-169-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 等待时间不足</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>lines</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v2</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>1500</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-170-1><a class=lnlinks href=#hl-170-1>1</a>
</span><span class=lnt id=hl-170-2><a class=lnlinks href=#hl-170-2>2</a>
</span><span class=lnt id=hl-170-3><a class=lnlinks href=#hl-170-3>3</a>
</span><span class=lnt id=hl-170-4><a class=lnlinks href=#hl-170-4>4</a>
</span><span class=lnt id=hl-170-5><a class=lnlinks href=#hl-170-5>5</a>
</span><span class=lnt id=hl-170-6><a class=lnlinks href=#hl-170-6>6</a>
</span><span class=lnt id=hl-170-7><a class=lnlinks href=#hl-170-7>7</a>
</span><span class=lnt id=hl-170-8><a class=lnlinks href=#hl-170-8>8</a>
</span><span class=lnt id=hl-170-9><a class=lnlinks href=#hl-170-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>54</span><span class=p>.</span><span class=na>963</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>waitTime</span><span class=p>:</span><span class=w> </span><span class=n>1500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>55</span><span class=p>.</span><span class=na>963</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>notify</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>55</span><span class=p>.</span><span class=na>963</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>timePassed</span><span class=p>:</span><span class=w> </span><span class=n>1002</span><span class=p>,</span><span class=w> </span><span class=n>object</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>55</span><span class=p>.</span><span class=na>963</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>waitTime</span><span class=p>:</span><span class=w> </span><span class=n>498</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>56</span><span class=p>.</span><span class=na>461</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>timePassed</span><span class=p>:</span><span class=w> </span><span class=n>1500</span><span class=p>,</span><span class=w> </span><span class=n>object</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>56</span><span class=p>.</span><span class=na>461</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>waitTime</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>56</span><span class=p>.</span><span class=na>461</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>break</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>56</span><span class=p>.</span><span class=na>461</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestGuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>can</span><span class=err>&#39;</span><span class=n>t</span><span class=w> </span><span class=n>get</span><span class=w> </span><span class=n>response</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>56</span><span class=p>.</span><span class=na>963</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>notify</span><span class=p>...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=textcolorblue-原理之-join><a href=#textcolorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-join class=header-anchor>#</a>
$\textcolor{blue}{* 原理之 join}$</h5><p>是调用者轮询检查线程 alive 状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-171-1><a class=lnlinks href=#hl-171-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>等价于下面的代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-172-1><a class=lnlinks href=#hl-172-1>1</a>
</span><span class=lnt id=hl-172-2><a class=lnlinks href=#hl-172-2>2</a>
</span><span class=lnt id=hl-172-3><a class=lnlinks href=#hl-172-3>3</a>
</span><span class=lnt id=hl-172-4><a class=lnlinks href=#hl-172-4>4</a>
</span><span class=lnt id=hl-172-5><a class=lnlinks href=#hl-172-5>5</a>
</span><span class=lnt id=hl-172-6><a class=lnlinks href=#hl-172-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>t1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 调用者线程进入 t1 的 waitSet 等待, 直到 t1 运行结束</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>t1</span><span class=p>.</span><span class=na>isAlive</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>wait</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p><p>join 体现的是【保护性暂停】模式，请参考之</p></blockquote><p>源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-173-1><a class=lnlinks href=#hl-173-1> 1</a>
</span><span class=lnt id=hl-173-2><a class=lnlinks href=#hl-173-2> 2</a>
</span><span class=lnt id=hl-173-3><a class=lnlinks href=#hl-173-3> 3</a>
</span><span class=lnt id=hl-173-4><a class=lnlinks href=#hl-173-4> 4</a>
</span><span class=lnt id=hl-173-5><a class=lnlinks href=#hl-173-5> 5</a>
</span><span class=lnt id=hl-173-6><a class=lnlinks href=#hl-173-6> 6</a>
</span><span class=lnt id=hl-173-7><a class=lnlinks href=#hl-173-7> 7</a>
</span><span class=lnt id=hl-173-8><a class=lnlinks href=#hl-173-8> 8</a>
</span><span class=lnt id=hl-173-9><a class=lnlinks href=#hl-173-9> 9</a>
</span><span class=lnt id=hl-173-10><a class=lnlinks href=#hl-173-10>10</a>
</span><span class=lnt id=hl-173-11><a class=lnlinks href=#hl-173-11>11</a>
</span><span class=lnt id=hl-173-12><a class=lnlinks href=#hl-173-12>12</a>
</span><span class=lnt id=hl-173-13><a class=lnlinks href=#hl-173-13>13</a>
</span><span class=lnt id=hl-173-14><a class=lnlinks href=#hl-173-14>14</a>
</span><span class=lnt id=hl-173-15><a class=lnlinks href=#hl-173-15>15</a>
</span><span class=lnt id=hl-173-16><a class=lnlinks href=#hl-173-16>16</a>
</span><span class=lnt id=hl-173-17><a class=lnlinks href=#hl-173-17>17</a>
</span><span class=lnt id=hl-173-18><a class=lnlinks href=#hl-173-18>18</a>
</span><span class=lnt id=hl-173-19><a class=lnlinks href=#hl-173-19>19</a>
</span><span class=lnt id=hl-173-20><a class=lnlinks href=#hl-173-20>20</a>
</span><span class=lnt id=hl-173-21><a class=lnlinks href=#hl-173-21>21</a>
</span><span class=lnt id=hl-173-22><a class=lnlinks href=#hl-173-22>22</a>
</span><span class=lnt id=hl-173-23><a class=lnlinks href=#hl-173-23>23</a>
</span><span class=lnt id=hl-173-24><a class=lnlinks href=#hl-173-24>24</a>
</span><span class=lnt id=hl-173-25><a class=lnlinks href=#hl-173-25>25</a>
</span><span class=lnt id=hl-173-26><a class=lnlinks href=#hl-173-26>26</a>
</span><span class=lnt id=hl-173-27><a class=lnlinks href=#hl-173-27>27</a>
</span><span class=lnt id=hl-173-28><a class=lnlinks href=#hl-173-28>28</a>
</span><span class=lnt id=hl-173-29><a class=lnlinks href=#hl-173-29>29</a>
</span><span class=lnt id=hl-173-30><a class=lnlinks href=#hl-173-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//不带参</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>join</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>join</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//带参</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//等待时长的实现类似于之前的保护性暂停</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>join</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>millis</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>base</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>millis</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;timeout value is negative&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>millis</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isAlive</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>wait</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isAlive</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>millis</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>now</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>delay</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>wait</span><span class=p>(</span><span class=n>delay</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>base</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=4多任务版guardedobject><a href=#4%e5%a4%9a%e4%bb%bb%e5%8a%a1%e7%89%88guardedobject class=header-anchor>#</a>
<strong>4.多任务版</strong>GuardedObject</h5><p>图中 Futures 就好比居民楼一层的信箱（每个信箱有房间编号），左侧的 t0，t2，t4 就好比等待邮件的居民，右 侧的 t1，t3，t5 就好比邮递员 。</p><p>如果需要在多个类之间使用 GuardedObject 对象，作为参数传递不是很方便，因此设计一个用来解耦的中间类， 这样不仅能够解耦【结果等待者】和【结果生产者】，还能够同时支持多个任务的管理。</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304141821782.png width=900 height=600 loading=lazy decoding=async alt=image-20220304141821782 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>新增 id 用来标识 Guarded Object</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-174-1><a class=lnlinks href=#hl-174-1> 1</a>
</span><span class=lnt id=hl-174-2><a class=lnlinks href=#hl-174-2> 2</a>
</span><span class=lnt id=hl-174-3><a class=lnlinks href=#hl-174-3> 3</a>
</span><span class=lnt id=hl-174-4><a class=lnlinks href=#hl-174-4> 4</a>
</span><span class=lnt id=hl-174-5><a class=lnlinks href=#hl-174-5> 5</a>
</span><span class=lnt id=hl-174-6><a class=lnlinks href=#hl-174-6> 6</a>
</span><span class=lnt id=hl-174-7><a class=lnlinks href=#hl-174-7> 7</a>
</span><span class=lnt id=hl-174-8><a class=lnlinks href=#hl-174-8> 8</a>
</span><span class=lnt id=hl-174-9><a class=lnlinks href=#hl-174-9> 9</a>
</span><span class=lnt id=hl-174-10><a class=lnlinks href=#hl-174-10>10</a>
</span><span class=lnt id=hl-174-11><a class=lnlinks href=#hl-174-11>11</a>
</span><span class=lnt id=hl-174-12><a class=lnlinks href=#hl-174-12>12</a>
</span><span class=lnt id=hl-174-13><a class=lnlinks href=#hl-174-13>13</a>
</span><span class=lnt id=hl-174-14><a class=lnlinks href=#hl-174-14>14</a>
</span><span class=lnt id=hl-174-15><a class=lnlinks href=#hl-174-15>15</a>
</span><span class=lnt id=hl-174-16><a class=lnlinks href=#hl-174-16>16</a>
</span><span class=lnt id=hl-174-17><a class=lnlinks href=#hl-174-17>17</a>
</span><span class=lnt id=hl-174-18><a class=lnlinks href=#hl-174-18>18</a>
</span><span class=lnt id=hl-174-19><a class=lnlinks href=#hl-174-19>19</a>
</span><span class=lnt id=hl-174-20><a class=lnlinks href=#hl-174-20>20</a>
</span><span class=lnt id=hl-174-21><a class=lnlinks href=#hl-174-21>21</a>
</span><span class=lnt id=hl-174-22><a class=lnlinks href=#hl-174-22>22</a>
</span><span class=lnt id=hl-174-23><a class=lnlinks href=#hl-174-23>23</a>
</span><span class=lnt id=hl-174-24><a class=lnlinks href=#hl-174-24>24</a>
</span><span class=lnt id=hl-174-25><a class=lnlinks href=#hl-174-25>25</a>
</span><span class=lnt id=hl-174-26><a class=lnlinks href=#hl-174-26>26</a>
</span><span class=lnt id=hl-174-27><a class=lnlinks href=#hl-174-27>27</a>
</span><span class=lnt id=hl-174-28><a class=lnlinks href=#hl-174-28>28</a>
</span><span class=lnt id=hl-174-29><a class=lnlinks href=#hl-174-29>29</a>
</span><span class=lnt id=hl-174-30><a class=lnlinks href=#hl-174-30>30</a>
</span><span class=lnt id=hl-174-31><a class=lnlinks href=#hl-174-31>31</a>
</span><span class=lnt id=hl-174-32><a class=lnlinks href=#hl-174-32>32</a>
</span><span class=lnt id=hl-174-33><a class=lnlinks href=#hl-174-33>33</a>
</span><span class=lnt id=hl-174-34><a class=lnlinks href=#hl-174-34>34</a>
</span><span class=lnt id=hl-174-35><a class=lnlinks href=#hl-174-35>35</a>
</span><span class=lnt id=hl-174-36><a class=lnlinks href=#hl-174-36>36</a>
</span><span class=lnt id=hl-174-37><a class=lnlinks href=#hl-174-37>37</a>
</span><span class=lnt id=hl-174-38><a class=lnlinks href=#hl-174-38>38</a>
</span><span class=lnt id=hl-174-39><a class=lnlinks href=#hl-174-39>39</a>
</span><span class=lnt id=hl-174-40><a class=lnlinks href=#hl-174-40>40</a>
</span><span class=lnt id=hl-174-41><a class=lnlinks href=#hl-174-41>41</a>
</span><span class=lnt id=hl-174-42><a class=lnlinks href=#hl-174-42>42</a>
</span><span class=lnt id=hl-174-43><a class=lnlinks href=#hl-174-43>43</a>
</span><span class=lnt id=hl-174-44><a class=lnlinks href=#hl-174-44>44</a>
</span><span class=lnt id=hl-174-45><a class=lnlinks href=#hl-174-45>45</a>
</span><span class=lnt id=hl-174-46><a class=lnlinks href=#hl-174-46>46</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>GuardedObject</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 标识 Guarded Object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>GuardedObject</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// timeout 表示要等待多久 2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 开始时间 15:00:00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>begin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 经历的时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>passedTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 这一轮循环应该等待的时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>waitTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeout</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>passedTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 经历的时间超过了最大等待时间时，退出循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>timeout</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>passedTime</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>this</span><span class=p>.</span><span class=na>wait</span><span class=p>(</span><span class=n>waitTime</span><span class=p>);</span><span class=w> </span><span class=c1>// 虚假唤醒 15:00:01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 求得经历时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>passedTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w> </span><span class=c1>// 15:00:02 1s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 产生结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>complete</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 给结果成员变量赋值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>中间解耦类</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-175-1><a class=lnlinks href=#hl-175-1> 1</a>
</span><span class=lnt id=hl-175-2><a class=lnlinks href=#hl-175-2> 2</a>
</span><span class=lnt id=hl-175-3><a class=lnlinks href=#hl-175-3> 3</a>
</span><span class=lnt id=hl-175-4><a class=lnlinks href=#hl-175-4> 4</a>
</span><span class=lnt id=hl-175-5><a class=lnlinks href=#hl-175-5> 5</a>
</span><span class=lnt id=hl-175-6><a class=lnlinks href=#hl-175-6> 6</a>
</span><span class=lnt id=hl-175-7><a class=lnlinks href=#hl-175-7> 7</a>
</span><span class=lnt id=hl-175-8><a class=lnlinks href=#hl-175-8> 8</a>
</span><span class=lnt id=hl-175-9><a class=lnlinks href=#hl-175-9> 9</a>
</span><span class=lnt id=hl-175-10><a class=lnlinks href=#hl-175-10>10</a>
</span><span class=lnt id=hl-175-11><a class=lnlinks href=#hl-175-11>11</a>
</span><span class=lnt id=hl-175-12><a class=lnlinks href=#hl-175-12>12</a>
</span><span class=lnt id=hl-175-13><a class=lnlinks href=#hl-175-13>13</a>
</span><span class=lnt id=hl-175-14><a class=lnlinks href=#hl-175-14>14</a>
</span><span class=lnt id=hl-175-15><a class=lnlinks href=#hl-175-15>15</a>
</span><span class=lnt id=hl-175-16><a class=lnlinks href=#hl-175-16>16</a>
</span><span class=lnt id=hl-175-17><a class=lnlinks href=#hl-175-17>17</a>
</span><span class=lnt id=hl-175-18><a class=lnlinks href=#hl-175-18>18</a>
</span><span class=lnt id=hl-175-19><a class=lnlinks href=#hl-175-19>19</a>
</span><span class=lnt id=hl-175-20><a class=lnlinks href=#hl-175-20>20</a>
</span><span class=lnt id=hl-175-21><a class=lnlinks href=#hl-175-21>21</a>
</span><span class=lnt id=hl-175-22><a class=lnlinks href=#hl-175-22>22</a>
</span><span class=lnt id=hl-175-23><a class=lnlinks href=#hl-175-23>23</a>
</span><span class=lnt id=hl-175-24><a class=lnlinks href=#hl-175-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Mailboxes</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>GuardedObject</span><span class=o>&gt;</span><span class=w> </span><span class=n>boxes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hashtable</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 产生唯一 id，方法必须声明为synchronized</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>generateId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>id</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>GuardedObject</span><span class=w> </span><span class=nf>getGuardedObject</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>boxes</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>GuardedObject</span><span class=w> </span><span class=nf>createGuardedObject</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GuardedObject</span><span class=w> </span><span class=n>go</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GuardedObject</span><span class=p>(</span><span class=n>generateId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>boxes</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>go</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>go</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>go</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getIds</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>boxes</span><span class=p>.</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>业务相关类</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-176-1><a class=lnlinks href=#hl-176-1> 1</a>
</span><span class=lnt id=hl-176-2><a class=lnlinks href=#hl-176-2> 2</a>
</span><span class=lnt id=hl-176-3><a class=lnlinks href=#hl-176-3> 3</a>
</span><span class=lnt id=hl-176-4><a class=lnlinks href=#hl-176-4> 4</a>
</span><span class=lnt id=hl-176-5><a class=lnlinks href=#hl-176-5> 5</a>
</span><span class=lnt id=hl-176-6><a class=lnlinks href=#hl-176-6> 6</a>
</span><span class=lnt id=hl-176-7><a class=lnlinks href=#hl-176-7> 7</a>
</span><span class=lnt id=hl-176-8><a class=lnlinks href=#hl-176-8> 8</a>
</span><span class=lnt id=hl-176-9><a class=lnlinks href=#hl-176-9> 9</a>
</span><span class=lnt id=hl-176-10><a class=lnlinks href=#hl-176-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>People</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Thread</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 收信</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GuardedObject</span><span class=w> </span><span class=n>guardedObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mailboxes</span><span class=p>.</span><span class=na>createGuardedObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;开始收信 id:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>mail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>5000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;收到信 id:{}, 内容:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>mail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-177-1><a class=lnlinks href=#hl-177-1> 1</a>
</span><span class=lnt id=hl-177-2><a class=lnlinks href=#hl-177-2> 2</a>
</span><span class=lnt id=hl-177-3><a class=lnlinks href=#hl-177-3> 3</a>
</span><span class=lnt id=hl-177-4><a class=lnlinks href=#hl-177-4> 4</a>
</span><span class=lnt id=hl-177-5><a class=lnlinks href=#hl-177-5> 5</a>
</span><span class=lnt id=hl-177-6><a class=lnlinks href=#hl-177-6> 6</a>
</span><span class=lnt id=hl-177-7><a class=lnlinks href=#hl-177-7> 7</a>
</span><span class=lnt id=hl-177-8><a class=lnlinks href=#hl-177-8> 8</a>
</span><span class=lnt id=hl-177-9><a class=lnlinks href=#hl-177-9> 9</a>
</span><span class=lnt id=hl-177-10><a class=lnlinks href=#hl-177-10>10</a>
</span><span class=lnt id=hl-177-11><a class=lnlinks href=#hl-177-11>11</a>
</span><span class=lnt id=hl-177-12><a class=lnlinks href=#hl-177-12>12</a>
</span><span class=lnt id=hl-177-13><a class=lnlinks href=#hl-177-13>13</a>
</span><span class=lnt id=hl-177-14><a class=lnlinks href=#hl-177-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Postman</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>mail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Postman</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>mail</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>mail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GuardedObject</span><span class=w> </span><span class=n>guardedObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mailboxes</span><span class=p>.</span><span class=na>getGuardedObject</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;送信 id:{}, 内容:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>mail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>complete</span><span class=p>(</span><span class=n>mail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-178-1><a class=lnlinks href=#hl-178-1>1</a>
</span><span class=lnt id=hl-178-2><a class=lnlinks href=#hl-178-2>2</a>
</span><span class=lnt id=hl-178-3><a class=lnlinks href=#hl-178-3>3</a>
</span><span class=lnt id=hl-178-4><a class=lnlinks href=#hl-178-4>4</a>
</span><span class=lnt id=hl-178-5><a class=lnlinks href=#hl-178-5>5</a>
</span><span class=lnt id=hl-178-6><a class=lnlinks href=#hl-178-6>6</a>
</span><span class=lnt id=hl-178-7><a class=lnlinks href=#hl-178-7>7</a>
</span><span class=lnt id=hl-178-8><a class=lnlinks href=#hl-178-8>8</a>
</span><span class=lnt id=hl-178-9><a class=lnlinks href=#hl-178-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>People</span><span class=p>().</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Mailboxes</span><span class=p>.</span><span class=na>getIds</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Postman</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=s>&#34;内容&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>id</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>某次运行结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-179-1><a class=lnlinks href=#hl-179-1>1</a>
</span><span class=lnt id=hl-179-2><a class=lnlinks href=#hl-179-2>2</a>
</span><span class=lnt id=hl-179-3><a class=lnlinks href=#hl-179-3>3</a>
</span><span class=lnt id=hl-179-4><a class=lnlinks href=#hl-179-4>4</a>
</span><span class=lnt id=hl-179-5><a class=lnlinks href=#hl-179-5>5</a>
</span><span class=lnt id=hl-179-6><a class=lnlinks href=#hl-179-6>6</a>
</span><span class=lnt id=hl-179-7><a class=lnlinks href=#hl-179-7>7</a>
</span><span class=lnt id=hl-179-8><a class=lnlinks href=#hl-179-8>8</a>
</span><span class=lnt id=hl-179-9><a class=lnlinks href=#hl-179-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>05</span><span class=p>.</span><span class=na>689</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>开始收信</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>05</span><span class=p>.</span><span class=na>689</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>开始收信</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>05</span><span class=p>.</span><span class=na>689</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>开始收信</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>688</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>Postman</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>4</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>送信</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>内容</span><span class=p>:</span><span class=n>内容2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>688</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>Postman</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>5</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>送信</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>内容</span><span class=p>:</span><span class=n>内容1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>688</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>收到信</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>内容</span><span class=p>:</span><span class=n>内容2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>688</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>收到信</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>内容</span><span class=p>:</span><span class=n>内容1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>688</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>Postman</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>3</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>送信</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>内容</span><span class=p>:</span><span class=n>内容3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>689</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>收到信</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>内容</span><span class=p>:</span><span class=n>内容3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=textcolororange-模式之生产者消费者><a href=#textcolororange-%e6%a8%a1%e5%bc%8f%e4%b9%8b%e7%94%9f%e4%ba%a7%e8%80%85%e6%b6%88%e8%b4%b9%e8%80%85 class=header-anchor>#</a>
$\textcolor{orange}{* 模式之生产者消费者}$</h4><h5 id=1定义-1><a href=#1%e5%ae%9a%e4%b9%89-1 class=header-anchor>#</a>
1.定义</h5><p>要点</p><ul><li>与前面的保护性暂停中的 GuardObject 不同，不需要产生结果和消费结果的线程一一对应</li><li>消费队列可以用来平衡生产和消费的线程资源</li><li>生产者仅负责产生结果数据，不关心数据该如何处理，而消费者专心处理结果数据</li><li>消息队列是有容量限制的，满时不会再加入数据，空时不会再消耗数据</li><li>JDK 中各种阻塞队列，采用的就是这种模式</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304142831627.png width=900 height=600 loading=lazy decoding=async alt=image-20220304142831627 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=2实现-1><a href=#2%e5%ae%9e%e7%8e%b0-1 class=header-anchor>#</a>
2.实现</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-180-1><a class=lnlinks href=#hl-180-1> 1</a>
</span><span class=lnt id=hl-180-2><a class=lnlinks href=#hl-180-2> 2</a>
</span><span class=lnt id=hl-180-3><a class=lnlinks href=#hl-180-3> 3</a>
</span><span class=lnt id=hl-180-4><a class=lnlinks href=#hl-180-4> 4</a>
</span><span class=lnt id=hl-180-5><a class=lnlinks href=#hl-180-5> 5</a>
</span><span class=lnt id=hl-180-6><a class=lnlinks href=#hl-180-6> 6</a>
</span><span class=lnt id=hl-180-7><a class=lnlinks href=#hl-180-7> 7</a>
</span><span class=lnt id=hl-180-8><a class=lnlinks href=#hl-180-8> 8</a>
</span><span class=lnt id=hl-180-9><a class=lnlinks href=#hl-180-9> 9</a>
</span><span class=lnt id=hl-180-10><a class=lnlinks href=#hl-180-10>10</a>
</span><span class=lnt id=hl-180-11><a class=lnlinks href=#hl-180-11>11</a>
</span><span class=lnt id=hl-180-12><a class=lnlinks href=#hl-180-12>12</a>
</span><span class=lnt id=hl-180-13><a class=lnlinks href=#hl-180-13>13</a>
</span><span class=lnt id=hl-180-14><a class=lnlinks href=#hl-180-14>14</a>
</span><span class=lnt id=hl-180-15><a class=lnlinks href=#hl-180-15>15</a>
</span><span class=lnt id=hl-180-16><a class=lnlinks href=#hl-180-16>16</a>
</span><span class=lnt id=hl-180-17><a class=lnlinks href=#hl-180-17>17</a>
</span><span class=lnt id=hl-180-18><a class=lnlinks href=#hl-180-18>18</a>
</span><span class=lnt id=hl-180-19><a class=lnlinks href=#hl-180-19>19</a>
</span><span class=lnt id=hl-180-20><a class=lnlinks href=#hl-180-20>20</a>
</span><span class=lnt id=hl-180-21><a class=lnlinks href=#hl-180-21>21</a>
</span><span class=lnt id=hl-180-22><a class=lnlinks href=#hl-180-22>22</a>
</span><span class=lnt id=hl-180-23><a class=lnlinks href=#hl-180-23>23</a>
</span><span class=lnt id=hl-180-24><a class=lnlinks href=#hl-180-24>24</a>
</span><span class=lnt id=hl-180-25><a class=lnlinks href=#hl-180-25>25</a>
</span><span class=lnt id=hl-180-26><a class=lnlinks href=#hl-180-26>26</a>
</span><span class=lnt id=hl-180-27><a class=lnlinks href=#hl-180-27>27</a>
</span><span class=lnt id=hl-180-28><a class=lnlinks href=#hl-180-28>28</a>
</span><span class=lnt id=hl-180-29><a class=lnlinks href=#hl-180-29>29</a>
</span><span class=lnt id=hl-180-30><a class=lnlinks href=#hl-180-30>30</a>
</span><span class=lnt id=hl-180-31><a class=lnlinks href=#hl-180-31>31</a>
</span><span class=lnt id=hl-180-32><a class=lnlinks href=#hl-180-32>32</a>
</span><span class=lnt id=hl-180-33><a class=lnlinks href=#hl-180-33>33</a>
</span><span class=lnt id=hl-180-34><a class=lnlinks href=#hl-180-34>34</a>
</span><span class=lnt id=hl-180-35><a class=lnlinks href=#hl-180-35>35</a>
</span><span class=lnt id=hl-180-36><a class=lnlinks href=#hl-180-36>36</a>
</span><span class=lnt id=hl-180-37><a class=lnlinks href=#hl-180-37>37</a>
</span><span class=lnt id=hl-180-38><a class=lnlinks href=#hl-180-38>38</a>
</span><span class=lnt id=hl-180-39><a class=lnlinks href=#hl-180-39>39</a>
</span><span class=lnt id=hl-180-40><a class=lnlinks href=#hl-180-40>40</a>
</span><span class=lnt id=hl-180-41><a class=lnlinks href=#hl-180-41>41</a>
</span><span class=lnt id=hl-180-42><a class=lnlinks href=#hl-180-42>42</a>
</span><span class=lnt id=hl-180-43><a class=lnlinks href=#hl-180-43>43</a>
</span><span class=lnt id=hl-180-44><a class=lnlinks href=#hl-180-44>44</a>
</span><span class=lnt id=hl-180-45><a class=lnlinks href=#hl-180-45>45</a>
</span><span class=lnt id=hl-180-46><a class=lnlinks href=#hl-180-46>46</a>
</span><span class=lnt id=hl-180-47><a class=lnlinks href=#hl-180-47>47</a>
</span><span class=lnt id=hl-180-48><a class=lnlinks href=#hl-180-48>48</a>
</span><span class=lnt id=hl-180-49><a class=lnlinks href=#hl-180-49>49</a>
</span><span class=lnt id=hl-180-50><a class=lnlinks href=#hl-180-50>50</a>
</span><span class=lnt id=hl-180-51><a class=lnlinks href=#hl-180-51>51</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Message</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Message</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getMessage</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>MessageQueue</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>Message</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MessageQueue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>capacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Message</span><span class=w> </span><span class=nf>take</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;没货了, wait&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>queue</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Message</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>removeFirst</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>Message</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;库存已达上限, wait&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>queue</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-181-1><a class=lnlinks href=#hl-181-1> 1</a>
</span><span class=lnt id=hl-181-2><a class=lnlinks href=#hl-181-2> 2</a>
</span><span class=lnt id=hl-181-3><a class=lnlinks href=#hl-181-3> 3</a>
</span><span class=lnt id=hl-181-4><a class=lnlinks href=#hl-181-4> 4</a>
</span><span class=lnt id=hl-181-5><a class=lnlinks href=#hl-181-5> 5</a>
</span><span class=lnt id=hl-181-6><a class=lnlinks href=#hl-181-6> 6</a>
</span><span class=lnt id=hl-181-7><a class=lnlinks href=#hl-181-7> 7</a>
</span><span class=lnt id=hl-181-8><a class=lnlinks href=#hl-181-8> 8</a>
</span><span class=lnt id=hl-181-9><a class=lnlinks href=#hl-181-9> 9</a>
</span><span class=lnt id=hl-181-10><a class=lnlinks href=#hl-181-10>10</a>
</span><span class=lnt id=hl-181-11><a class=lnlinks href=#hl-181-11>11</a>
</span><span class=lnt id=hl-181-12><a class=lnlinks href=#hl-181-12>12</a>
</span><span class=lnt id=hl-181-13><a class=lnlinks href=#hl-181-13>13</a>
</span><span class=lnt id=hl-181-14><a class=lnlinks href=#hl-181-14>14</a>
</span><span class=lnt id=hl-181-15><a class=lnlinks href=#hl-181-15>15</a>
</span><span class=lnt id=hl-181-16><a class=lnlinks href=#hl-181-16>16</a>
</span><span class=lnt id=hl-181-17><a class=lnlinks href=#hl-181-17>17</a>
</span><span class=lnt id=hl-181-18><a class=lnlinks href=#hl-181-18>18</a>
</span><span class=lnt id=hl-181-19><a class=lnlinks href=#hl-181-19>19</a>
</span><span class=lnt id=hl-181-20><a class=lnlinks href=#hl-181-20>20</a>
</span><span class=lnt id=hl-181-21><a class=lnlinks href=#hl-181-21>21</a>
</span><span class=lnt id=hl-181-22><a class=lnlinks href=#hl-181-22>22</a>
</span><span class=lnt id=hl-181-23><a class=lnlinks href=#hl-181-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>MessageQueue</span><span class=w> </span><span class=n>messageQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MessageQueue</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 4 个生产者线程, 下载任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>4</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;download...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Downloader</span><span class=p>.</span><span class=na>download</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;try put message({})&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>messageQueue</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Message</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;生产者&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 1 个消费者线程, 处理结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Message</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>messageQueue</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getMessage</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;take message({}): [{}] lines&#34;</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;消费者&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>某次运行结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-182-1><a class=lnlinks href=#hl-182-1> 1</a>
</span><span class=lnt id=hl-182-2><a class=lnlinks href=#hl-182-2> 2</a>
</span><span class=lnt id=hl-182-3><a class=lnlinks href=#hl-182-3> 3</a>
</span><span class=lnt id=hl-182-4><a class=lnlinks href=#hl-182-4> 4</a>
</span><span class=lnt id=hl-182-5><a class=lnlinks href=#hl-182-5> 5</a>
</span><span class=lnt id=hl-182-6><a class=lnlinks href=#hl-182-6> 6</a>
</span><span class=lnt id=hl-182-7><a class=lnlinks href=#hl-182-7> 7</a>
</span><span class=lnt id=hl-182-8><a class=lnlinks href=#hl-182-8> 8</a>
</span><span class=lnt id=hl-182-9><a class=lnlinks href=#hl-182-9> 9</a>
</span><span class=lnt id=hl-182-10><a class=lnlinks href=#hl-182-10>10</a>
</span><span class=lnt id=hl-182-11><a class=lnlinks href=#hl-182-11>11</a>
</span><span class=lnt id=hl-182-12><a class=lnlinks href=#hl-182-12>12</a>
</span><span class=lnt id=hl-182-13><a class=lnlinks href=#hl-182-13>13</a>
</span><span class=lnt id=hl-182-14><a class=lnlinks href=#hl-182-14>14</a>
</span><span class=lnt id=hl-182-15><a class=lnlinks href=#hl-182-15>15</a>
</span><span class=lnt id=hl-182-16><a class=lnlinks href=#hl-182-16>16</a>
</span><span class=lnt id=hl-182-17><a class=lnlinks href=#hl-182-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>10:48:38.070 <span class=o>[</span>生产者3<span class=o>]</span> c.TestProducerConsumer - download...
</span></span><span class=line><span class=cl>10:48:38.070 <span class=o>[</span>生产者0<span class=o>]</span> c.TestProducerConsumer - download...
</span></span><span class=line><span class=cl>10:48:38.070 <span class=o>[</span>消费者<span class=o>]</span> c.MessageQueue - 没货了, <span class=nb>wait</span>
</span></span><span class=line><span class=cl>10:48:38.070 <span class=o>[</span>生产者1<span class=o>]</span> c.TestProducerConsumer - download...
</span></span><span class=line><span class=cl>10:48:38.070 <span class=o>[</span>生产者2<span class=o>]</span> c.TestProducerConsumer - download...
</span></span><span class=line><span class=cl>10:48:41.236 <span class=o>[</span>生产者1<span class=o>]</span> c.TestProducerConsumer - try put message<span class=o>(</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl>10:48:41.237 <span class=o>[</span>生产者2<span class=o>]</span> c.TestProducerConsumer - try put message<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>10:48:41.236 <span class=o>[</span>生产者0<span class=o>]</span> c.TestProducerConsumer - try put message<span class=o>(</span>0<span class=o>)</span>
</span></span><span class=line><span class=cl>10:48:41.237 <span class=o>[</span>生产者3<span class=o>]</span> c.TestProducerConsumer - try put message<span class=o>(</span>3<span class=o>)</span>
</span></span><span class=line><span class=cl>10:48:41.239 <span class=o>[</span>生产者2<span class=o>]</span> c.MessageQueue - 库存已达上限, <span class=nb>wait</span>
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>生产者1<span class=o>]</span> c.MessageQueue - 库存已达上限, <span class=nb>wait</span>
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>消费者<span class=o>]</span> c.TestProducerConsumer - take message<span class=o>(</span>0<span class=o>)</span>: <span class=o>[</span>3<span class=o>]</span> lines
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>生产者2<span class=o>]</span> c.MessageQueue - 库存已达上限, <span class=nb>wait</span>
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>消费者<span class=o>]</span> c.TestProducerConsumer - take message<span class=o>(</span>3<span class=o>)</span>: <span class=o>[</span>3<span class=o>]</span> lines
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>消费者<span class=o>]</span> c.TestProducerConsumer - take message<span class=o>(</span>1<span class=o>)</span>: <span class=o>[</span>3<span class=o>]</span> lines
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>消费者<span class=o>]</span> c.TestProducerConsumer - take message<span class=o>(</span>2<span class=o>)</span>: <span class=o>[</span>3<span class=o>]</span> lines
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>消费者<span class=o>]</span> c.MessageQueue - 没货了, <span class=nb>wait</span>
</span></span></code></pre></td></tr></table></div></div><p>结果解读</p><h2 id=49-park--unpark><a href=#49-park--unpark class=header-anchor>#</a>
4.9 Park & Unpark</h2><h5 id=基本使用><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
基本使用</h5><p>它们是 LockSupport 类中的方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-183-1><a class=lnlinks href=#hl-183-1>1</a>
</span><span class=lnt id=hl-183-2><a class=lnlinks href=#hl-183-2>2</a>
</span><span class=lnt id=hl-183-3><a class=lnlinks href=#hl-183-3>3</a>
</span><span class=lnt id=hl-183-4><a class=lnlinks href=#hl-183-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 暂停当前线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 恢复某个线程的运行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>暂停线程对象</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>先 park 再 unpark</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-184-1><a class=lnlinks href=#hl-184-1> 1</a>
</span><span class=lnt id=hl-184-2><a class=lnlinks href=#hl-184-2> 2</a>
</span><span class=lnt id=hl-184-3><a class=lnlinks href=#hl-184-3> 3</a>
</span><span class=lnt id=hl-184-4><a class=lnlinks href=#hl-184-4> 4</a>
</span><span class=lnt id=hl-184-5><a class=lnlinks href=#hl-184-5> 5</a>
</span><span class=lnt id=hl-184-6><a class=lnlinks href=#hl-184-6> 6</a>
</span><span class=lnt id=hl-184-7><a class=lnlinks href=#hl-184-7> 7</a>
</span><span class=lnt id=hl-184-8><a class=lnlinks href=#hl-184-8> 8</a>
</span><span class=lnt id=hl-184-9><a class=lnlinks href=#hl-184-9> 9</a>
</span><span class=lnt id=hl-184-10><a class=lnlinks href=#hl-184-10>10</a>
</span><span class=lnt id=hl-184-11><a class=lnlinks href=#hl-184-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;park...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;resume...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unpark...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>t1</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-185-1><a class=lnlinks href=#hl-185-1>1</a>
</span><span class=lnt id=hl-185-2><a class=lnlinks href=#hl-185-2>2</a>
</span><span class=lnt id=hl-185-3><a class=lnlinks href=#hl-185-3>3</a>
</span><span class=lnt id=hl-185-4><a class=lnlinks href=#hl-185-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:42:52.585 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>18:42:53.589 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - park... 
</span></span><span class=line><span class=cl>18:42:54.583 c.TestParkUnpark <span class=o>[</span>main<span class=o>]</span> - unpark... 
</span></span><span class=line><span class=cl>18:42:54.583 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - resume... 
</span></span></code></pre></td></tr></table></div></div><p>先 unpark 再 park</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-186-1><a class=lnlinks href=#hl-186-1> 1</a>
</span><span class=lnt id=hl-186-2><a class=lnlinks href=#hl-186-2> 2</a>
</span><span class=lnt id=hl-186-3><a class=lnlinks href=#hl-186-3> 3</a>
</span><span class=lnt id=hl-186-4><a class=lnlinks href=#hl-186-4> 4</a>
</span><span class=lnt id=hl-186-5><a class=lnlinks href=#hl-186-5> 5</a>
</span><span class=lnt id=hl-186-6><a class=lnlinks href=#hl-186-6> 6</a>
</span><span class=lnt id=hl-186-7><a class=lnlinks href=#hl-186-7> 7</a>
</span><span class=lnt id=hl-186-8><a class=lnlinks href=#hl-186-8> 8</a>
</span><span class=lnt id=hl-186-9><a class=lnlinks href=#hl-186-9> 9</a>
</span><span class=lnt id=hl-186-10><a class=lnlinks href=#hl-186-10>10</a>
</span><span class=lnt id=hl-186-11><a class=lnlinks href=#hl-186-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;park...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;resume...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unpark...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>t1</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-187-1><a class=lnlinks href=#hl-187-1>1</a>
</span><span class=lnt id=hl-187-2><a class=lnlinks href=#hl-187-2>2</a>
</span><span class=lnt id=hl-187-3><a class=lnlinks href=#hl-187-3>3</a>
</span><span class=lnt id=hl-187-4><a class=lnlinks href=#hl-187-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:43:50.765 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>18:43:51.764 c.TestParkUnpark <span class=o>[</span>main<span class=o>]</span> - unpark... 
</span></span><span class=line><span class=cl>18:43:52.769 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - park... 
</span></span><span class=line><span class=cl>18:43:52.769 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - resume... 
</span></span></code></pre></td></tr></table></div></div><h5 id=特点><a href=#%e7%89%b9%e7%82%b9 class=header-anchor>#</a>
特点</h5><p>与 Object 的 wait & notify 相比</p><ul><li>wait，notify 和 notifyAll 必须配合 Object Monitor 一起使用，而 park，unpark 不必</li><li>park & unpark 是以线程为单位来【阻塞】和【唤醒】线程，而 notify 只能随机唤醒一个等待线程，notifyAll 是唤醒所有等待线程，就不那么【精确】</li><li>park & unpark 可以先 unpark，而 wait & notify 不能先 notify</li></ul><h5 id=textcolorblue-原理之park和unpark><a href=#textcolorblue-%e5%8e%9f%e7%90%86%e4%b9%8bpark%e5%92%8cunpark class=header-anchor>#</a>
$\textcolor{blue}{* 原理之park和unpark}$</h5><p>每个线程都有自己的一个 Parker 对象(由C++编写，java中不可见)，由三部分组成 <code>_counter </code>， <code>_cond </code>和 <code>_mutex</code> 打个比喻</p><ul><li>线程就像一个旅人，Parker 就像他随身携带的背包，条件变量就好比背包中的帐篷。_counter 就好比背包中 的备用干粮（0 为耗尽，1 为充足）</li><li>调用 park 就是要看需不需要停下来歇息<ul><li>如果备用干粮耗尽，那么钻进帐篷歇息</li><li>如果备用干粮充足，那么不需停留，继续前进</li></ul></li><li>调用 unpark，就好比令干粮充足<ul><li>如果这时线程还在帐篷，就唤醒让他继续前进</li><li>如果这时线程还在运行，那么下次他调用 park 时，仅是消耗掉备用干粮，不需停留继续前进<ul><li>因为背包空间有限，多次调用 unpark 仅会补充一份备用干粮</li></ul></li></ul></li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304144415441.png width=900 height=600 loading=lazy decoding=async alt=image-20220304144415441 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ol><li>当前线程调用 Unsafe.park() 方法</li><li>检查 _counter ，本情况为 0，这时，获得 _mutex 互斥锁</li><li>线程进入 _cond 条件变量阻塞</li><li>设置 _counter = 0</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304144548871.png width=900 height=600 loading=lazy decoding=async alt=image-20220304144548871 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ol><li>调用 Unsafe.unpark(Thread_0) 方法，设置 _counter 为 1</li><li>唤醒 _cond 条件变量中的 Thread_0</li><li>Thread_0 恢复运行</li><li>设置 _counter 为 0</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304144626180.png width=900 height=600 loading=lazy decoding=async alt=image-20220304144626180 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ol><li>调用 Unsafe.unpark(Thread_0) 方法，设置 _counter 为 1</li><li>当前线程调用 Unsafe.park() 方法</li><li>检查 _counter ，本情况为 1，这时线程无需阻塞，继续运行</li><li>设置 _counter 为 0</li></ol><h2 id=410-重新理解线程状态转换><a href=#410-%e9%87%8d%e6%96%b0%e7%90%86%e8%a7%a3%e7%ba%bf%e7%a8%8b%e7%8a%b6%e6%80%81%e8%bd%ac%e6%8d%a2 class=header-anchor>#</a>
4.10 重新理解线程状态转换</h2><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304151245960.png width=900 height=600 loading=lazy decoding=async alt=image-20220304151245960 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>假设有线程 <code>Thread t</code></p><h5 id=情况-1-new----runnable><a href=#%e6%83%85%e5%86%b5-1-new----runnable class=header-anchor>#</a>
情况 1 <code>NEW --> RUNNABLE</code></h5><ul><li>当调用 <code>t.start()</code> 方法时，由 NEW &ndash;> RUNNABLE</li></ul><h5 id=情况-2-runnable----waiting><a href=#%e6%83%85%e5%86%b5-2-runnable----waiting class=header-anchor>#</a>
情况 2 <code>RUNNABLE &lt;--> WAITING</code></h5><p><strong>t 线程</strong>用 <code>synchronized(obj)</code> 获取了对象锁后</p><ul><li>调用 <code>obj.wait()</code> 方法时，<strong>t 线程</strong>从 <code>RUNNABLE --> WAITING</code></li><li>调用 <code>obj.notify()</code> ， <code>obj.notifyAll()</code> ， <code>t.interrupt()</code> 时<ul><li>竞争锁成功，<strong>t 线程</strong>从 <code>WAITING --> RUNNABLE</code></li><li>竞争锁失败，<strong>t 线程</strong>从 <code>WAITING --> BLOCKED</code></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-188-1><a class=lnlinks href=#hl-188-1> 1</a>
</span><span class=lnt id=hl-188-2><a class=lnlinks href=#hl-188-2> 2</a>
</span><span class=lnt id=hl-188-3><a class=lnlinks href=#hl-188-3> 3</a>
</span><span class=lnt id=hl-188-4><a class=lnlinks href=#hl-188-4> 4</a>
</span><span class=lnt id=hl-188-5><a class=lnlinks href=#hl-188-5> 5</a>
</span><span class=lnt id=hl-188-6><a class=lnlinks href=#hl-188-6> 6</a>
</span><span class=lnt id=hl-188-7><a class=lnlinks href=#hl-188-7> 7</a>
</span><span class=lnt id=hl-188-8><a class=lnlinks href=#hl-188-8> 8</a>
</span><span class=lnt id=hl-188-9><a class=lnlinks href=#hl-188-9> 9</a>
</span><span class=lnt id=hl-188-10><a class=lnlinks href=#hl-188-10>10</a>
</span><span class=lnt id=hl-188-11><a class=lnlinks href=#hl-188-11>11</a>
</span><span class=lnt id=hl-188-12><a class=lnlinks href=#hl-188-12>12</a>
</span><span class=lnt id=hl-188-13><a class=lnlinks href=#hl-188-13>13</a>
</span><span class=lnt id=hl-188-14><a class=lnlinks href=#hl-188-14>14</a>
</span><span class=lnt id=hl-188-15><a class=lnlinks href=#hl-188-15>15</a>
</span><span class=lnt id=hl-188-16><a class=lnlinks href=#hl-188-16>16</a>
</span><span class=lnt id=hl-188-17><a class=lnlinks href=#hl-188-17>17</a>
</span><span class=lnt id=hl-188-18><a class=lnlinks href=#hl-188-18>18</a>
</span><span class=lnt id=hl-188-19><a class=lnlinks href=#hl-188-19>19</a>
</span><span class=lnt id=hl-188-20><a class=lnlinks href=#hl-188-20>20</a>
</span><span class=lnt id=hl-188-21><a class=lnlinks href=#hl-188-21>21</a>
</span><span class=lnt id=hl-188-22><a class=lnlinks href=#hl-188-22>22</a>
</span><span class=lnt id=hl-188-23><a class=lnlinks href=#hl-188-23>23</a>
</span><span class=lnt id=hl-188-24><a class=lnlinks href=#hl-188-24>24</a>
</span><span class=lnt id=hl-188-25><a class=lnlinks href=#hl-188-25>25</a>
</span><span class=lnt id=hl-188-26><a class=lnlinks href=#hl-188-26>26</a>
</span><span class=lnt id=hl-188-27><a class=lnlinks href=#hl-188-27>27</a>
</span><span class=lnt id=hl-188-28><a class=lnlinks href=#hl-188-28>28</a>
</span><span class=lnt id=hl-188-29><a class=lnlinks href=#hl-188-29>29</a>
</span><span class=lnt id=hl-188-30><a class=lnlinks href=#hl-188-30>30</a>
</span><span class=lnt id=hl-188-31><a class=lnlinks href=#hl-188-31>31</a>
</span><span class=lnt id=hl-188-32><a class=lnlinks href=#hl-188-32>32</a>
</span><span class=lnt id=hl-188-33><a class=lnlinks href=#hl-188-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestWaitNotify</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;执行....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>obj</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;其它代码....&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 断点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;执行....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>obj</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;其它代码....&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 断点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;唤醒 obj 上其它线程&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>obj</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w> </span><span class=c1>// 唤醒obj上所有等待线程 断点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=情况-3-runnable----waiting><a href=#%e6%83%85%e5%86%b5-3-runnable----waiting class=header-anchor>#</a>
情况 3 <code>RUNNABLE &lt;--> WAITING</code></h5><ul><li><strong>当前线程</strong>调用 <code>t.join()</code> 方法时，<strong>当前线程</strong>从 <code>RUNNABLE --> WAITING</code> 注意是<strong>当前线程</strong>在<strong>t 线程对象</strong>的监视器上等待</li><li><strong>t 线程</strong>运行结束，或调用了<strong>当前线程</strong>的 interrupt() 时，当前线程从 <code>WAITING --> RUNNABLE</code></li></ul><h5 id=情况-4-runnable----waiting><a href=#%e6%83%85%e5%86%b5-4-runnable----waiting class=header-anchor>#</a>
情况 4 <code>RUNNABLE &lt;--> WAITING</code></h5><ul><li><strong>当前线程</strong>调用 <code>LockSupport.park()</code> 方法会让<strong>当前线程</strong>从 <code>RUNNABLE --> WAITING</code></li><li>调用 <code>LockSupport.unpark</code>(目标线程) 或调用了线程 的 <code>interrupt()</code> ，会让目标线程从 <code>WAITING --> RUNNABLE</code></li></ul><h5 id=情况-5-runnable----timed_waiting><a href=#%e6%83%85%e5%86%b5-5-runnable----timed_waiting class=header-anchor>#</a>
情况 5 <code>RUNNABLE &lt;--> TIMED_WAITING</code></h5><p><strong>t 线程</strong>用 <code>synchronized(obj)</code> 获取了对象锁后</p><ul><li>调用 <code>obj.wait(long n)</code> 方法时，<strong>t 线程</strong>从 <code>RUNNABLE --> TIMED_WAITING</code></li><li><strong>t 线程</strong>等待时间超过了 n 毫秒，或调用 <code>obj.notify()</code> ， <code>obj.notifyAll()</code> ，<code>t.interrupt()</code>时<ul><li>竞争锁成功，<strong>t 线程</strong>从 <code>TIMED_WAITING --> RUNNABLE</code></li><li>竞争锁失败，<strong>t 线程</strong>从 <code>TIMED_WAITING --> BLOCKED</code></li></ul></li></ul><h5 id=情况-6-runnable----timed_waiting><a href=#%e6%83%85%e5%86%b5-6-runnable----timed_waiting class=header-anchor>#</a>
情况 6 <code>RUNNABLE &lt;--> TIMED_WAITING</code></h5><ul><li><strong>当前线程</strong>调用 <code>t.join(long n)</code> 方法时，<strong>当前线程</strong>从 <code>RUNNABLE --> TIMED_WAITING</code> 注意是当前线程在<strong>t 线程</strong>对象的监视器上等待</li><li><strong>当前线程</strong>等待时间超过了 n 毫秒，或<strong>t 线程</strong>运行结束，或调用了<strong>当前线程</strong>的 <code>interrupt()</code> 时，当前线程从 <code>TIMED_WAITING --> RUNNABLE</code></li></ul><h5 id=情况-7-runnable----timed_waiting><a href=#%e6%83%85%e5%86%b5-7-runnable----timed_waiting class=header-anchor>#</a>
情况 7 <code>RUNNABLE &lt;--> TIMED_WAITING</code></h5><ul><li><strong>当前线程</strong>调用 <code>Thread.sleep(long n)</code> ，<strong>当前线程</strong>从 <code>RUNNABLE --> TIMED_WAITING</code></li><li><strong>当前线程</strong>等待时间超过了 n 毫秒，<strong>当前线程</strong>从 <code>TIMED_WAITING --> RUNNABLE</code></li></ul><h5 id=情况-8-runnable----timed_waiting><a href=#%e6%83%85%e5%86%b5-8-runnable----timed_waiting class=header-anchor>#</a>
情况 8 <code>RUNNABLE &lt;--> TIMED_WAITING</code></h5><ul><li><strong>当前线程</strong>调用 <code>LockSupport.parkNanos(long nanos)</code> 或 <code>LockSupport.parkUntil(long millis)</code> 时，<strong>当前线程</strong>从 <code>RUNNABLE --> TIMED_WAITING</code></li><li>调用 <code>LockSupport.unpark</code>(目标线程) 或调用了线程 的 <code>interrupt()</code> ，或是等待超时，会让目标线程从 <code>TIMED_WAITING--> RUNNABLE</code></li></ul><h5 id=情况-9-runnable----blocked><a href=#%e6%83%85%e5%86%b5-9-runnable----blocked class=header-anchor>#</a>
情况 9 <code>RUNNABLE &lt;--> BLOCKED</code></h5><ul><li><strong>t 线程</strong>用 <code>synchronized(obj)</code> 获取了对象锁时如果竞争失败，从 <code>RUNNABLE --> BLOCKED</code></li><li>持 obj 锁线程的同步代码块执行完毕，会唤醒该对象上所有 <code>BLOCKED</code> 的线程重新竞争，如果其中 <strong>t 线程</strong>竞争 成功，从 <code>BLOCKED --> RUNNABLE</code> ，其它失败的线程仍然 <code>BLOCKED</code></li></ul><h5 id=情况-10-runnable----terminated><a href=#%e6%83%85%e5%86%b5-10-runnable----terminated class=header-anchor>#</a>
情况 10 <code>RUNNABLE &lt;--> TERMINATED</code></h5><ul><li>当前线程所有代码运行完毕，进入 <code>TERMINATED</code></li></ul><h2 id=411-多把锁><a href=#411-%e5%a4%9a%e6%8a%8a%e9%94%81 class=header-anchor>#</a>
4.11 多把锁</h2><p><strong>多把不相干的锁</strong></p><p>一间大屋子有两个功能：睡觉、学习，互不相干。</p><p>现在小南要学习，小女要睡觉，但如果只用一间屋子（一个对象锁）的话，那么并发度很低</p><p>解决方法是准备多个房间（多个对象锁）</p><p>例如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-189-1><a class=lnlinks href=#hl-189-1> 1</a>
</span><span class=lnt id=hl-189-2><a class=lnlinks href=#hl-189-2> 2</a>
</span><span class=lnt id=hl-189-3><a class=lnlinks href=#hl-189-3> 3</a>
</span><span class=lnt id=hl-189-4><a class=lnlinks href=#hl-189-4> 4</a>
</span><span class=lnt id=hl-189-5><a class=lnlinks href=#hl-189-5> 5</a>
</span><span class=lnt id=hl-189-6><a class=lnlinks href=#hl-189-6> 6</a>
</span><span class=lnt id=hl-189-7><a class=lnlinks href=#hl-189-7> 7</a>
</span><span class=lnt id=hl-189-8><a class=lnlinks href=#hl-189-8> 8</a>
</span><span class=lnt id=hl-189-9><a class=lnlinks href=#hl-189-9> 9</a>
</span><span class=lnt id=hl-189-10><a class=lnlinks href=#hl-189-10>10</a>
</span><span class=lnt id=hl-189-11><a class=lnlinks href=#hl-189-11>11</a>
</span><span class=lnt id=hl-189-12><a class=lnlinks href=#hl-189-12>12</a>
</span><span class=lnt id=hl-189-13><a class=lnlinks href=#hl-189-13>13</a>
</span><span class=lnt id=hl-189-14><a class=lnlinks href=#hl-189-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>BigRoom</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sleep</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;sleeping 2 小时&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>study</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;study 1 小时&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-190-1><a class=lnlinks href=#hl-190-1>1</a>
</span><span class=lnt id=hl-190-2><a class=lnlinks href=#hl-190-2>2</a>
</span><span class=lnt id=hl-190-3><a class=lnlinks href=#hl-190-3>3</a>
</span><span class=lnt id=hl-190-4><a class=lnlinks href=#hl-190-4>4</a>
</span><span class=lnt id=hl-190-5><a class=lnlinks href=#hl-190-5>5</a>
</span><span class=lnt id=hl-190-6><a class=lnlinks href=#hl-190-6>6</a>
</span><span class=lnt id=hl-190-7><a class=lnlinks href=#hl-190-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BigRoom</span><span class=w> </span><span class=n>bigRoom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BigRoom</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>bigRoom</span><span class=p>.</span><span class=na>compute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;小南&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>bigRoom</span><span class=p>.</span><span class=na>sleep</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;小女&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-191-1><a class=lnlinks href=#hl-191-1>1</a>
</span><span class=lnt id=hl-191-2><a class=lnlinks href=#hl-191-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>12:13:54.471 <span class=o>[</span>小南<span class=o>]</span> c.BigRoom - study <span class=m>1</span> 小时
</span></span><span class=line><span class=cl>12:13:55.476 <span class=o>[</span>小女<span class=o>]</span> c.BigRoom - sleeping <span class=m>2</span> 小时
</span></span></code></pre></td></tr></table></div></div><p>改进</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-192-1><a class=lnlinks href=#hl-192-1> 1</a>
</span><span class=lnt id=hl-192-2><a class=lnlinks href=#hl-192-2> 2</a>
</span><span class=lnt id=hl-192-3><a class=lnlinks href=#hl-192-3> 3</a>
</span><span class=lnt id=hl-192-4><a class=lnlinks href=#hl-192-4> 4</a>
</span><span class=lnt id=hl-192-5><a class=lnlinks href=#hl-192-5> 5</a>
</span><span class=lnt id=hl-192-6><a class=lnlinks href=#hl-192-6> 6</a>
</span><span class=lnt id=hl-192-7><a class=lnlinks href=#hl-192-7> 7</a>
</span><span class=lnt id=hl-192-8><a class=lnlinks href=#hl-192-8> 8</a>
</span><span class=lnt id=hl-192-9><a class=lnlinks href=#hl-192-9> 9</a>
</span><span class=lnt id=hl-192-10><a class=lnlinks href=#hl-192-10>10</a>
</span><span class=lnt id=hl-192-11><a class=lnlinks href=#hl-192-11>11</a>
</span><span class=lnt id=hl-192-12><a class=lnlinks href=#hl-192-12>12</a>
</span><span class=lnt id=hl-192-13><a class=lnlinks href=#hl-192-13>13</a>
</span><span class=lnt id=hl-192-14><a class=lnlinks href=#hl-192-14>14</a>
</span><span class=lnt id=hl-192-15><a class=lnlinks href=#hl-192-15>15</a>
</span><span class=lnt id=hl-192-16><a class=lnlinks href=#hl-192-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>BigRoom</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>studyRoom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>bedRoom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sleep</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>bedRoom</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;sleeping 2 小时&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>study</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>studyRoom</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;study 1 小时&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>某次执行结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-193-1><a class=lnlinks href=#hl-193-1>1</a>
</span><span class=lnt id=hl-193-2><a class=lnlinks href=#hl-193-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>12:15:35.069 <span class=o>[</span>小南<span class=o>]</span> c.BigRoom - study <span class=m>1</span> 小时
</span></span><span class=line><span class=cl>12:15:35.069 <span class=o>[</span>小女<span class=o>]</span> c.BigRoom - sleeping <span class=m>2</span> 小时
</span></span></code></pre></td></tr></table></div></div><p>将锁的粒度细分</p><ul><li>好处，是可以增强并发度</li><li>坏处，如果一个线程需要同时获得多把锁，就容易发生死锁</li><li>前提：两把锁锁住的两段代码互不相关</li></ul><h2 id=412-活跃性><a href=#412-%e6%b4%bb%e8%b7%83%e6%80%a7 class=header-anchor>#</a>
4.12 活跃性</h2><h5 id=死锁><a href=#%e6%ad%bb%e9%94%81 class=header-anchor>#</a>
<strong>死锁</strong></h5><p>有这样的情况：一个线程需要同时获取多把锁，这时就容易发生死锁</p><p><code>t1 线程</code> 获得 <code>A对象</code> 锁，接下来想获取 <code>B对象</code> 的锁 <code>t2 线程</code> 获得 <code>B对象</code> 锁，接下来想获取 <code>A对象</code> 的锁 例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-194-1><a class=lnlinks href=#hl-194-1> 1</a>
</span><span class=lnt id=hl-194-2><a class=lnlinks href=#hl-194-2> 2</a>
</span><span class=lnt id=hl-194-3><a class=lnlinks href=#hl-194-3> 3</a>
</span><span class=lnt id=hl-194-4><a class=lnlinks href=#hl-194-4> 4</a>
</span><span class=lnt id=hl-194-5><a class=lnlinks href=#hl-194-5> 5</a>
</span><span class=lnt id=hl-194-6><a class=lnlinks href=#hl-194-6> 6</a>
</span><span class=lnt id=hl-194-7><a class=lnlinks href=#hl-194-7> 7</a>
</span><span class=lnt id=hl-194-8><a class=lnlinks href=#hl-194-8> 8</a>
</span><span class=lnt id=hl-194-9><a class=lnlinks href=#hl-194-9> 9</a>
</span><span class=lnt id=hl-194-10><a class=lnlinks href=#hl-194-10>10</a>
</span><span class=lnt id=hl-194-11><a class=lnlinks href=#hl-194-11>11</a>
</span><span class=lnt id=hl-194-12><a class=lnlinks href=#hl-194-12>12</a>
</span><span class=lnt id=hl-194-13><a class=lnlinks href=#hl-194-13>13</a>
</span><span class=lnt id=hl-194-14><a class=lnlinks href=#hl-194-14>14</a>
</span><span class=lnt id=hl-194-15><a class=lnlinks href=#hl-194-15>15</a>
</span><span class=lnt id=hl-194-16><a class=lnlinks href=#hl-194-16>16</a>
</span><span class=lnt id=hl-194-17><a class=lnlinks href=#hl-194-17>17</a>
</span><span class=lnt id=hl-194-18><a class=lnlinks href=#hl-194-18>18</a>
</span><span class=lnt id=hl-194-19><a class=lnlinks href=#hl-194-19>19</a>
</span><span class=lnt id=hl-194-20><a class=lnlinks href=#hl-194-20>20</a>
</span><span class=lnt id=hl-194-21><a class=lnlinks href=#hl-194-21>21</a>
</span><span class=lnt id=hl-194-22><a class=lnlinks href=#hl-194-22>22</a>
</span><span class=lnt id=hl-194-23><a class=lnlinks href=#hl-194-23>23</a>
</span><span class=lnt id=hl-194-24><a class=lnlinks href=#hl-194-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Object</span><span class=w> </span><span class=n>A</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Object</span><span class=w> </span><span class=n>B</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>A</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock A&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>B</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock B&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;操作...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>B</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock B&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>A</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock A&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;操作...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-195-1><a class=lnlinks href=#hl-195-1>1</a>
</span><span class=lnt id=hl-195-2><a class=lnlinks href=#hl-195-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>12:22:06.962 <span class=o>[</span>t2<span class=o>]</span> c.TestDeadLock - lock B 
</span></span><span class=line><span class=cl>12:22:06.962 <span class=o>[</span>t1<span class=o>]</span> c.TestDeadLock - lock A
</span></span></code></pre></td></tr></table></div></div><p>解决方式：</p><ul><li>ReentrantLock</li></ul><h5 id=定位死锁><a href=#%e5%ae%9a%e4%bd%8d%e6%ad%bb%e9%94%81 class=header-anchor>#</a>
<strong>定位死锁</strong></h5><p>检测死锁可以使用 jconsole工具，或者使用 jps 定位进程 id，再用 jstack 定位死锁：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-196-1><a class=lnlinks href=#hl-196-1>1</a>
</span><span class=lnt id=hl-196-2><a class=lnlinks href=#hl-196-2>2</a>
</span><span class=lnt id=hl-196-3><a class=lnlinks href=#hl-196-3>3</a>
</span><span class=lnt id=hl-196-4><a class=lnlinks href=#hl-196-4>4</a>
</span><span class=lnt id=hl-196-5><a class=lnlinks href=#hl-196-5>5</a>
</span><span class=lnt id=hl-196-6><a class=lnlinks href=#hl-196-6>6</a>
</span><span class=lnt id=hl-196-7><a class=lnlinks href=#hl-196-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cmd &gt; jps
</span></span><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS: -Dfile.encoding<span class=o>=</span>UTF-8
</span></span><span class=line><span class=cl><span class=m>12320</span> Jps
</span></span><span class=line><span class=cl><span class=m>22816</span> KotlinCompileDaemon
</span></span><span class=line><span class=cl><span class=m>33200</span> TestDeadLock // JVM 进程
</span></span><span class=line><span class=cl><span class=m>11508</span> Main
</span></span><span class=line><span class=cl><span class=m>28468</span> Launcher
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-197-1><a class=lnlinks href=#hl-197-1> 1</a>
</span><span class=lnt id=hl-197-2><a class=lnlinks href=#hl-197-2> 2</a>
</span><span class=lnt id=hl-197-3><a class=lnlinks href=#hl-197-3> 3</a>
</span><span class=lnt id=hl-197-4><a class=lnlinks href=#hl-197-4> 4</a>
</span><span class=lnt id=hl-197-5><a class=lnlinks href=#hl-197-5> 5</a>
</span><span class=lnt id=hl-197-6><a class=lnlinks href=#hl-197-6> 6</a>
</span><span class=lnt id=hl-197-7><a class=lnlinks href=#hl-197-7> 7</a>
</span><span class=lnt id=hl-197-8><a class=lnlinks href=#hl-197-8> 8</a>
</span><span class=lnt id=hl-197-9><a class=lnlinks href=#hl-197-9> 9</a>
</span><span class=lnt id=hl-197-10><a class=lnlinks href=#hl-197-10>10</a>
</span><span class=lnt id=hl-197-11><a class=lnlinks href=#hl-197-11>11</a>
</span><span class=lnt id=hl-197-12><a class=lnlinks href=#hl-197-12>12</a>
</span><span class=lnt id=hl-197-13><a class=lnlinks href=#hl-197-13>13</a>
</span><span class=lnt id=hl-197-14><a class=lnlinks href=#hl-197-14>14</a>
</span><span class=lnt id=hl-197-15><a class=lnlinks href=#hl-197-15>15</a>
</span><span class=lnt id=hl-197-16><a class=lnlinks href=#hl-197-16>16</a>
</span><span class=lnt id=hl-197-17><a class=lnlinks href=#hl-197-17>17</a>
</span><span class=lnt id=hl-197-18><a class=lnlinks href=#hl-197-18>18</a>
</span><span class=lnt id=hl-197-19><a class=lnlinks href=#hl-197-19>19</a>
</span><span class=lnt id=hl-197-20><a class=lnlinks href=#hl-197-20>20</a>
</span><span class=lnt id=hl-197-21><a class=lnlinks href=#hl-197-21>21</a>
</span><span class=lnt id=hl-197-22><a class=lnlinks href=#hl-197-22>22</a>
</span><span class=lnt id=hl-197-23><a class=lnlinks href=#hl-197-23>23</a>
</span><span class=lnt id=hl-197-24><a class=lnlinks href=#hl-197-24>24</a>
</span><span class=lnt id=hl-197-25><a class=lnlinks href=#hl-197-25>25</a>
</span><span class=lnt id=hl-197-26><a class=lnlinks href=#hl-197-26>26</a>
</span><span class=lnt id=hl-197-27><a class=lnlinks href=#hl-197-27>27</a>
</span><span class=lnt id=hl-197-28><a class=lnlinks href=#hl-197-28>28</a>
</span><span class=lnt id=hl-197-29><a class=lnlinks href=#hl-197-29>29</a>
</span><span class=lnt id=hl-197-30><a class=lnlinks href=#hl-197-30>30</a>
</span><span class=lnt id=hl-197-31><a class=lnlinks href=#hl-197-31>31</a>
</span><span class=lnt id=hl-197-32><a class=lnlinks href=#hl-197-32>32</a>
</span><span class=lnt id=hl-197-33><a class=lnlinks href=#hl-197-33>33</a>
</span><span class=lnt id=hl-197-34><a class=lnlinks href=#hl-197-34>34</a>
</span><span class=lnt id=hl-197-35><a class=lnlinks href=#hl-197-35>35</a>
</span><span class=lnt id=hl-197-36><a class=lnlinks href=#hl-197-36>36</a>
</span><span class=lnt id=hl-197-37><a class=lnlinks href=#hl-197-37>37</a>
</span><span class=lnt id=hl-197-38><a class=lnlinks href=#hl-197-38>38</a>
</span><span class=lnt id=hl-197-39><a class=lnlinks href=#hl-197-39>39</a>
</span><span class=lnt id=hl-197-40><a class=lnlinks href=#hl-197-40>40</a>
</span><span class=lnt id=hl-197-41><a class=lnlinks href=#hl-197-41>41</a>
</span><span class=lnt id=hl-197-42><a class=lnlinks href=#hl-197-42>42</a>
</span><span class=lnt id=hl-197-43><a class=lnlinks href=#hl-197-43>43</a>
</span><span class=lnt id=hl-197-44><a class=lnlinks href=#hl-197-44>44</a>
</span><span class=lnt id=hl-197-45><a class=lnlinks href=#hl-197-45>45</a>
</span><span class=lnt id=hl-197-46><a class=lnlinks href=#hl-197-46>46</a>
</span><span class=lnt id=hl-197-47><a class=lnlinks href=#hl-197-47>47</a>
</span><span class=lnt id=hl-197-48><a class=lnlinks href=#hl-197-48>48</a>
</span><span class=lnt id=hl-197-49><a class=lnlinks href=#hl-197-49>49</a>
</span><span class=lnt id=hl-197-50><a class=lnlinks href=#hl-197-50>50</a>
</span><span class=lnt id=hl-197-51><a class=lnlinks href=#hl-197-51>51</a>
</span><span class=lnt id=hl-197-52><a class=lnlinks href=#hl-197-52>52</a>
</span><span class=lnt id=hl-197-53><a class=lnlinks href=#hl-197-53>53</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cmd &gt; jstack <span class=m>33200</span>
</span></span><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS: -Dfile.encoding<span class=o>=</span>UTF-8
</span></span><span class=line><span class=cl>2018-12-29 05:51:40
</span></span><span class=line><span class=cl>Full thread dump Java HotSpot<span class=o>(</span>TM<span class=o>)</span> 64-Bit Server VM <span class=o>(</span>25.91-b14 mixed mode<span class=o>)</span>:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;DestroyJavaVM&#34;</span> <span class=c1>#13 prio=5 os_prio=0 tid=0x0000000003525000 nid=0x2f60 waiting on condition </span>
</span></span><span class=line><span class=cl><span class=o>[</span>0x0000000000000000<span class=o>]</span>
</span></span><span class=line><span class=cl>	java.lang.Thread.State: RUNNABLE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-1&#34;</span> <span class=c1>#12 prio=5 os_prio=0 tid=0x000000001eb69000 nid=0xd40 waiting for monitor entry </span>
</span></span><span class=line><span class=cl><span class=o>[</span>0x000000001f54f000<span class=o>]</span>
</span></span><span class=line><span class=cl>	java.lang.Thread.State: BLOCKED <span class=o>(</span>on object monitor<span class=o>)</span>
</span></span><span class=line><span class=cl>        at thread.TestDeadLock.lambda<span class=nv>$main$1</span><span class=o>(</span>TestDeadLock.java:28<span class=o>)</span>
</span></span><span class=line><span class=cl>        - waiting to lock &lt;0x000000076b5bf1c0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>        - locked &lt;0x000000076b5bf1d0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>        at thread.TestDeadLock<span class=nv>$$</span>Lambda<span class=nv>$2</span>/883049899.run<span class=o>(</span>Unknown Source<span class=o>)</span>
</span></span><span class=line><span class=cl>        at java.lang.Thread.run<span class=o>(</span>Thread.java:745<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-0&#34;</span> <span class=c1>#11 prio=5 os_prio=0 tid=0x000000001eb68800 nid=0x1b28 waiting for monitor entry </span>
</span></span><span class=line><span class=cl><span class=o>[</span>0x000000001f44f000<span class=o>]</span>
</span></span><span class=line><span class=cl>	java.lang.Thread.State: BLOCKED <span class=o>(</span>on object monitor<span class=o>)</span>
</span></span><span class=line><span class=cl>        at thread.TestDeadLock.lambda<span class=nv>$main$0</span><span class=o>(</span>TestDeadLock.java:15<span class=o>)</span>
</span></span><span class=line><span class=cl>        - waiting to lock &lt;0x000000076b5bf1d0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>         - locked &lt;0x000000076b5bf1c0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl> 		at thread.TestDeadLock<span class=nv>$$</span>Lambda<span class=nv>$1</span>/495053715.run<span class=o>(</span>Unknown Source<span class=o>)</span>
</span></span><span class=line><span class=cl> 		at java.lang.Thread.run<span class=o>(</span>Thread.java:745<span class=o>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>// 略去部分输出
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Found one Java-level deadlock:
</span></span><span class=line><span class=cl><span class=o>=============================</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-1&#34;</span>:
</span></span><span class=line><span class=cl> 	waiting to lock monitor 0x000000000361d378 <span class=o>(</span>object 0x000000076b5bf1c0, a java.lang.Object<span class=o>)</span>,
</span></span><span class=line><span class=cl> 	which is held by <span class=s2>&#34;Thread-0&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-0&#34;</span>:
</span></span><span class=line><span class=cl>	 waiting to lock monitor 0x000000000361e768 <span class=o>(</span>object 0x000000076b5bf1d0, a java.lang.Object<span class=o>)</span>,
</span></span><span class=line><span class=cl> 	which is held by <span class=s2>&#34;Thread-1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Java stack information <span class=k>for</span> the threads listed above:
</span></span><span class=line><span class=cl><span class=o>===================================================</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-1&#34;</span>:
</span></span><span class=line><span class=cl>         at thread.TestDeadLock.lambda<span class=nv>$main$1</span><span class=o>(</span>TestDeadLock.java:28<span class=o>)</span>
</span></span><span class=line><span class=cl>         - waiting to lock &lt;0x000000076b5bf1c0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>         - locked &lt;0x000000076b5bf1d0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>         at thread.TestDeadLock<span class=nv>$$</span>Lambda<span class=nv>$2</span>/883049899.run<span class=o>(</span>Unknown Source<span class=o>)</span>
</span></span><span class=line><span class=cl>         at java.lang.Thread.run<span class=o>(</span>Thread.java:745<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-0&#34;</span>:
</span></span><span class=line><span class=cl>         at thread.TestDeadLock.lambda<span class=nv>$main$0</span><span class=o>(</span>TestDeadLock.java:15<span class=o>)</span>
</span></span><span class=line><span class=cl>         - waiting to lock &lt;0x000000076b5bf1d0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>         - locked &lt;0x000000076b5bf1c0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>         at thread.TestDeadLock<span class=nv>$$</span>Lambda<span class=nv>$1</span>/495053715.run<span class=o>(</span>Unknown Source<span class=o>)</span>
</span></span><span class=line><span class=cl>         at java.lang.Thread.run<span class=o>(</span>Thread.java:745<span class=o>)</span>
</span></span><span class=line><span class=cl>Found <span class=m>1</span> deadlock.
</span></span></code></pre></td></tr></table></div></div><ul><li>避免死锁要注意加锁顺序</li><li>另外如果由于某个线程进入了死循环，导致其它线程一直等待，对于这种情况 linux 下可以通过 top 先定位到 CPU 占用高的 Java 进程，再利用 top -Hp 进程id 来定位是哪个线程，最后再用 jstack 排查</li></ul><h5 id=活锁><a href=#%e6%b4%bb%e9%94%81 class=header-anchor>#</a>
<strong>活锁</strong></h5><p>活锁出现在两个线程互相改变对方的结束条件，最后谁也无法结束，例如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-198-1><a class=lnlinks href=#hl-198-1> 1</a>
</span><span class=lnt id=hl-198-2><a class=lnlinks href=#hl-198-2> 2</a>
</span><span class=lnt id=hl-198-3><a class=lnlinks href=#hl-198-3> 3</a>
</span><span class=lnt id=hl-198-4><a class=lnlinks href=#hl-198-4> 4</a>
</span><span class=lnt id=hl-198-5><a class=lnlinks href=#hl-198-5> 5</a>
</span><span class=lnt id=hl-198-6><a class=lnlinks href=#hl-198-6> 6</a>
</span><span class=lnt id=hl-198-7><a class=lnlinks href=#hl-198-7> 7</a>
</span><span class=lnt id=hl-198-8><a class=lnlinks href=#hl-198-8> 8</a>
</span><span class=lnt id=hl-198-9><a class=lnlinks href=#hl-198-9> 9</a>
</span><span class=lnt id=hl-198-10><a class=lnlinks href=#hl-198-10>10</a>
</span><span class=lnt id=hl-198-11><a class=lnlinks href=#hl-198-11>11</a>
</span><span class=lnt id=hl-198-12><a class=lnlinks href=#hl-198-12>12</a>
</span><span class=lnt id=hl-198-13><a class=lnlinks href=#hl-198-13>13</a>
</span><span class=lnt id=hl-198-14><a class=lnlinks href=#hl-198-14>14</a>
</span><span class=lnt id=hl-198-15><a class=lnlinks href=#hl-198-15>15</a>
</span><span class=lnt id=hl-198-16><a class=lnlinks href=#hl-198-16>16</a>
</span><span class=lnt id=hl-198-17><a class=lnlinks href=#hl-198-17>17</a>
</span><span class=lnt id=hl-198-18><a class=lnlinks href=#hl-198-18>18</a>
</span><span class=lnt id=hl-198-19><a class=lnlinks href=#hl-198-19>19</a>
</span><span class=lnt id=hl-198-20><a class=lnlinks href=#hl-198-20>20</a>
</span><span class=lnt id=hl-198-21><a class=lnlinks href=#hl-198-21>21</a>
</span><span class=lnt id=hl-198-22><a class=lnlinks href=#hl-198-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestLiveLock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 期望减到 0 退出循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>count</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;count: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 期望超过 20 退出循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>20</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;count: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>解决方式：</p><ul><li>错开线程的运行时间，使得一方不能改变另一方的结束条件。</li><li>将睡眠时间调整为随机数。</li></ul><h5 id=饥饿><a href=#%e9%a5%a5%e9%a5%bf class=header-anchor>#</a>
<strong>饥饿</strong></h5><p>很多教程中把饥饿定义为，一个线程由于优先级太低，始终得不到 CPU 调度执行，也不能够结束，饥饿的情况不易演示，讲读写锁时会涉及饥饿问题</p><p>下面我讲一下我遇到的一个线程饥饿的例子，先来看看使用顺序加锁的方式解决之前的死锁问题</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304205818794.png width=900 height=600 loading=lazy decoding=async alt=image-20220304205818794 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>顺序加锁的解决方案</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304205837519.png width=900 height=600 loading=lazy decoding=async alt=image-20220304205837519 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>说明：</p><ul><li>顺序加锁可以解决死锁问题，但也会导致一些线程一直得不到锁，产生饥饿现象。</li><li>解决方式：ReentrantLock</li></ul><h2 id=413-reentrantlock><a href=#413-reentrantlock class=header-anchor>#</a>
4.13 ReentrantLock</h2><p>相对于 synchronized 它具备如下特点</p><ul><li>可中断</li><li>可以设置超时时间</li><li>可以设置为公平锁</li><li>支持多个条件变量</li></ul><p>与 synchronized 一样，都支持可重入</p><p>基本语法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-199-1><a class=lnlinks href=#hl-199-1>1</a>
</span><span class=lnt id=hl-199-2><a class=lnlinks href=#hl-199-2>2</a>
</span><span class=lnt id=hl-199-3><a class=lnlinks href=#hl-199-3>3</a>
</span><span class=lnt id=hl-199-4><a class=lnlinks href=#hl-199-4>4</a>
</span><span class=lnt id=hl-199-5><a class=lnlinks href=#hl-199-5>5</a>
</span><span class=lnt id=hl-199-6><a class=lnlinks href=#hl-199-6>6</a>
</span><span class=lnt id=hl-199-7><a class=lnlinks href=#hl-199-7>7</a>
</span><span class=lnt id=hl-199-8><a class=lnlinks href=#hl-199-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 获取锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>reentrantLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c1>// 临界区</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c1>// 释放锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>reentrantLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=可重入><a href=#%e5%8f%af%e9%87%8d%e5%85%a5 class=header-anchor>#</a>
可重入</h4><p>可重入是指同一个线程如果首次获得了这把锁，那么因为它是这把锁的拥有者，因此有权利再次获取这把锁 如果是不可重入锁，那么第二次获得锁时，自己也会被锁挡住。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-200-1><a class=lnlinks href=#hl-200-1> 1</a>
</span><span class=lnt id=hl-200-2><a class=lnlinks href=#hl-200-2> 2</a>
</span><span class=lnt id=hl-200-3><a class=lnlinks href=#hl-200-3> 3</a>
</span><span class=lnt id=hl-200-4><a class=lnlinks href=#hl-200-4> 4</a>
</span><span class=lnt id=hl-200-5><a class=lnlinks href=#hl-200-5> 5</a>
</span><span class=lnt id=hl-200-6><a class=lnlinks href=#hl-200-6> 6</a>
</span><span class=lnt id=hl-200-7><a class=lnlinks href=#hl-200-7> 7</a>
</span><span class=lnt id=hl-200-8><a class=lnlinks href=#hl-200-8> 8</a>
</span><span class=lnt id=hl-200-9><a class=lnlinks href=#hl-200-9> 9</a>
</span><span class=lnt id=hl-200-10><a class=lnlinks href=#hl-200-10>10</a>
</span><span class=lnt id=hl-200-11><a class=lnlinks href=#hl-200-11>11</a>
</span><span class=lnt id=hl-200-12><a class=lnlinks href=#hl-200-12>12</a>
</span><span class=lnt id=hl-200-13><a class=lnlinks href=#hl-200-13>13</a>
</span><span class=lnt id=hl-200-14><a class=lnlinks href=#hl-200-14>14</a>
</span><span class=lnt id=hl-200-15><a class=lnlinks href=#hl-200-15>15</a>
</span><span class=lnt id=hl-200-16><a class=lnlinks href=#hl-200-16>16</a>
</span><span class=lnt id=hl-200-17><a class=lnlinks href=#hl-200-17>17</a>
</span><span class=lnt id=hl-200-18><a class=lnlinks href=#hl-200-18>18</a>
</span><span class=lnt id=hl-200-19><a class=lnlinks href=#hl-200-19>19</a>
</span><span class=lnt id=hl-200-20><a class=lnlinks href=#hl-200-20>20</a>
</span><span class=lnt id=hl-200-21><a class=lnlinks href=#hl-200-21>21</a>
</span><span class=lnt id=hl-200-22><a class=lnlinks href=#hl-200-22>22</a>
</span><span class=lnt id=hl-200-23><a class=lnlinks href=#hl-200-23>23</a>
</span><span class=lnt id=hl-200-24><a class=lnlinks href=#hl-200-24>24</a>
</span><span class=lnt id=hl-200-25><a class=lnlinks href=#hl-200-25>25</a>
</span><span class=lnt id=hl-200-26><a class=lnlinks href=#hl-200-26>26</a>
</span><span class=lnt id=hl-200-27><a class=lnlinks href=#hl-200-27>27</a>
</span><span class=lnt id=hl-200-28><a class=lnlinks href=#hl-200-28>28</a>
</span><span class=lnt id=hl-200-29><a class=lnlinks href=#hl-200-29>29</a>
</span><span class=lnt id=hl-200-30><a class=lnlinks href=#hl-200-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>method1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;execute method1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>method2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;execute method2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>method3</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;execute method3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-201-1><a class=lnlinks href=#hl-201-1>1</a>
</span><span class=lnt id=hl-201-2><a class=lnlinks href=#hl-201-2>2</a>
</span><span class=lnt id=hl-201-3><a class=lnlinks href=#hl-201-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>17:59:11.862 <span class=o>[</span>main<span class=o>]</span> c.TestReentrant - execute method1 
</span></span><span class=line><span class=cl>17:59:11.865 <span class=o>[</span>main<span class=o>]</span> c.TestReentrant - execute method2 
</span></span><span class=line><span class=cl>17:59:11.865 <span class=o>[</span>main<span class=o>]</span> c.TestReentrant - execute method3
</span></span></code></pre></td></tr></table></div></div><h4 id=可打断><a href=#%e5%8f%af%e6%89%93%e6%96%ad class=header-anchor>#</a>
可打断</h4><p>可打断指的是处于阻塞状态等待锁的线程可以被打断等待。注意<code>lock.lockInterruptibly()</code>和<code>lock.trylock()</code>方法是可打断的,<code>lock.lock()</code>不是。可打断的意义在于避免得不到锁的线程无限制地等待下去，防止死锁的一种方式。</p><p>示例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-202-1><a class=lnlinks href=#hl-202-1> 1</a>
</span><span class=lnt id=hl-202-2><a class=lnlinks href=#hl-202-2> 2</a>
</span><span class=lnt id=hl-202-3><a class=lnlinks href=#hl-202-3> 3</a>
</span><span class=lnt id=hl-202-4><a class=lnlinks href=#hl-202-4> 4</a>
</span><span class=lnt id=hl-202-5><a class=lnlinks href=#hl-202-5> 5</a>
</span><span class=lnt id=hl-202-6><a class=lnlinks href=#hl-202-6> 6</a>
</span><span class=lnt id=hl-202-7><a class=lnlinks href=#hl-202-7> 7</a>
</span><span class=lnt id=hl-202-8><a class=lnlinks href=#hl-202-8> 8</a>
</span><span class=lnt id=hl-202-9><a class=lnlinks href=#hl-202-9> 9</a>
</span><span class=lnt id=hl-202-10><a class=lnlinks href=#hl-202-10>10</a>
</span><span class=lnt id=hl-202-11><a class=lnlinks href=#hl-202-11>11</a>
</span><span class=lnt id=hl-202-12><a class=lnlinks href=#hl-202-12>12</a>
</span><span class=lnt id=hl-202-13><a class=lnlinks href=#hl-202-13>13</a>
</span><span class=lnt id=hl-202-14><a class=lnlinks href=#hl-202-14>14</a>
</span><span class=lnt id=hl-202-15><a class=lnlinks href=#hl-202-15>15</a>
</span><span class=lnt id=hl-202-16><a class=lnlinks href=#hl-202-16>16</a>
</span><span class=lnt id=hl-202-17><a class=lnlinks href=#hl-202-17>17</a>
</span><span class=lnt id=hl-202-18><a class=lnlinks href=#hl-202-18>18</a>
</span><span class=lnt id=hl-202-19><a class=lnlinks href=#hl-202-19>19</a>
</span><span class=lnt id=hl-202-20><a class=lnlinks href=#hl-202-20>20</a>
</span><span class=lnt id=hl-202-21><a class=lnlinks href=#hl-202-21>21</a>
</span><span class=lnt id=hl-202-22><a class=lnlinks href=#hl-202-22>22</a>
</span><span class=lnt id=hl-202-23><a class=lnlinks href=#hl-202-23>23</a>
</span><span class=lnt id=hl-202-24><a class=lnlinks href=#hl-202-24>24</a>
</span><span class=lnt id=hl-202-25><a class=lnlinks href=#hl-202-25>25</a>
</span><span class=lnt id=hl-202-26><a class=lnlinks href=#hl-202-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;启动...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lockInterruptibly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;等锁的过程中被打断&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获得了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获得了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;执行打断&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-203-1><a class=lnlinks href=#hl-203-1> 1</a>
</span><span class=lnt id=hl-203-2><a class=lnlinks href=#hl-203-2> 2</a>
</span><span class=lnt id=hl-203-3><a class=lnlinks href=#hl-203-3> 3</a>
</span><span class=lnt id=hl-203-4><a class=lnlinks href=#hl-203-4> 4</a>
</span><span class=lnt id=hl-203-5><a class=lnlinks href=#hl-203-5> 5</a>
</span><span class=lnt id=hl-203-6><a class=lnlinks href=#hl-203-6> 6</a>
</span><span class=lnt id=hl-203-7><a class=lnlinks href=#hl-203-7> 7</a>
</span><span class=lnt id=hl-203-8><a class=lnlinks href=#hl-203-8> 8</a>
</span><span class=lnt id=hl-203-9><a class=lnlinks href=#hl-203-9> 9</a>
</span><span class=lnt id=hl-203-10><a class=lnlinks href=#hl-203-10>10</a>
</span><span class=lnt id=hl-203-11><a class=lnlinks href=#hl-203-11>11</a>
</span><span class=lnt id=hl-203-12><a class=lnlinks href=#hl-203-12>12</a>
</span><span class=lnt id=hl-203-13><a class=lnlinks href=#hl-203-13>13</a>
</span><span class=lnt id=hl-203-14><a class=lnlinks href=#hl-203-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:02:40.520 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - 获得了锁
</span></span><span class=line><span class=cl>18:02:40.524 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - 启动... 
</span></span><span class=line><span class=cl>18:02:41.530 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - 执行打断
</span></span><span class=line><span class=cl>java.lang.InterruptedException 
</span></span><span class=line><span class=cl> 		at 
</span></span><span class=line><span class=cl>java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly<span class=o>(</span>AbstractQueuedSynchr
</span></span><span class=line><span class=cl>onizer.java:898<span class=o>)</span> 
</span></span><span class=line><span class=cl> 		at 
</span></span><span class=line><span class=cl>java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly<span class=o>(</span>AbstractQueuedSynchron
</span></span><span class=line><span class=cl>izer.java:1222<span class=o>)</span> 
</span></span><span class=line><span class=cl> 		at java.util.concurrent.locks.ReentrantLock.lockInterruptibly<span class=o>(</span>ReentrantLock.java:335<span class=o>)</span> 
</span></span><span class=line><span class=cl> 		at cn.itcast.n4.reentrant.TestInterrupt.lambda<span class=nv>$main$0</span><span class=o>(</span>TestInterrupt.java:17<span class=o>)</span> 
</span></span><span class=line><span class=cl> 		at java.lang.Thread.run<span class=o>(</span>Thread.java:748<span class=o>)</span> 
</span></span><span class=line><span class=cl>18:02:41.532 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - 等锁的过程中被打断
</span></span></code></pre></td></tr></table></div></div><p>注意如果是不可中断模式，那么即使使用了 interrupt 也不会让等待中断</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-204-1><a class=lnlinks href=#hl-204-1> 1</a>
</span><span class=lnt id=hl-204-2><a class=lnlinks href=#hl-204-2> 2</a>
</span><span class=lnt id=hl-204-3><a class=lnlinks href=#hl-204-3> 3</a>
</span><span class=lnt id=hl-204-4><a class=lnlinks href=#hl-204-4> 4</a>
</span><span class=lnt id=hl-204-5><a class=lnlinks href=#hl-204-5> 5</a>
</span><span class=lnt id=hl-204-6><a class=lnlinks href=#hl-204-6> 6</a>
</span><span class=lnt id=hl-204-7><a class=lnlinks href=#hl-204-7> 7</a>
</span><span class=lnt id=hl-204-8><a class=lnlinks href=#hl-204-8> 8</a>
</span><span class=lnt id=hl-204-9><a class=lnlinks href=#hl-204-9> 9</a>
</span><span class=lnt id=hl-204-10><a class=lnlinks href=#hl-204-10>10</a>
</span><span class=lnt id=hl-204-11><a class=lnlinks href=#hl-204-11>11</a>
</span><span class=lnt id=hl-204-12><a class=lnlinks href=#hl-204-12>12</a>
</span><span class=lnt id=hl-204-13><a class=lnlinks href=#hl-204-13>13</a>
</span><span class=lnt id=hl-204-14><a class=lnlinks href=#hl-204-14>14</a>
</span><span class=lnt id=hl-204-15><a class=lnlinks href=#hl-204-15>15</a>
</span><span class=lnt id=hl-204-16><a class=lnlinks href=#hl-204-16>16</a>
</span><span class=lnt id=hl-204-17><a class=lnlinks href=#hl-204-17>17</a>
</span><span class=lnt id=hl-204-18><a class=lnlinks href=#hl-204-18>18</a>
</span><span class=lnt id=hl-204-19><a class=lnlinks href=#hl-204-19>19</a>
</span><span class=lnt id=hl-204-20><a class=lnlinks href=#hl-204-20>20</a>
</span><span class=lnt id=hl-204-21><a class=lnlinks href=#hl-204-21>21</a>
</span><span class=lnt id=hl-204-22><a class=lnlinks href=#hl-204-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;启动...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获得了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获得了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;执行打断&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;释放了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-205-1><a class=lnlinks href=#hl-205-1>1</a>
</span><span class=lnt id=hl-205-2><a class=lnlinks href=#hl-205-2>2</a>
</span><span class=lnt id=hl-205-3><a class=lnlinks href=#hl-205-3>3</a>
</span><span class=lnt id=hl-205-4><a class=lnlinks href=#hl-205-4>4</a>
</span><span class=lnt id=hl-205-5><a class=lnlinks href=#hl-205-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:06:56.261 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - 获得了锁
</span></span><span class=line><span class=cl>18:06:56.265 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - 启动... 
</span></span><span class=line><span class=cl>18:06:57.266 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - 执行打断 // 这时 t1 并没有被真正打断, 而是仍继续等待锁
</span></span><span class=line><span class=cl>18:06:58.267 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - 释放了锁
</span></span><span class=line><span class=cl>18:06:58.267 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - 获得了锁
</span></span></code></pre></td></tr></table></div></div><h4 id=锁超时><a href=#%e9%94%81%e8%b6%85%e6%97%b6 class=header-anchor>#</a>
锁超时</h4><p>立刻失败</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-206-1><a class=lnlinks href=#hl-206-1> 1</a>
</span><span class=lnt id=hl-206-2><a class=lnlinks href=#hl-206-2> 2</a>
</span><span class=lnt id=hl-206-3><a class=lnlinks href=#hl-206-3> 3</a>
</span><span class=lnt id=hl-206-4><a class=lnlinks href=#hl-206-4> 4</a>
</span><span class=lnt id=hl-206-5><a class=lnlinks href=#hl-206-5> 5</a>
</span><span class=lnt id=hl-206-6><a class=lnlinks href=#hl-206-6> 6</a>
</span><span class=lnt id=hl-206-7><a class=lnlinks href=#hl-206-7> 7</a>
</span><span class=lnt id=hl-206-8><a class=lnlinks href=#hl-206-8> 8</a>
</span><span class=lnt id=hl-206-9><a class=lnlinks href=#hl-206-9> 9</a>
</span><span class=lnt id=hl-206-10><a class=lnlinks href=#hl-206-10>10</a>
</span><span class=lnt id=hl-206-11><a class=lnlinks href=#hl-206-11>11</a>
</span><span class=lnt id=hl-206-12><a class=lnlinks href=#hl-206-12>12</a>
</span><span class=lnt id=hl-206-13><a class=lnlinks href=#hl-206-13>13</a>
</span><span class=lnt id=hl-206-14><a class=lnlinks href=#hl-206-14>14</a>
</span><span class=lnt id=hl-206-15><a class=lnlinks href=#hl-206-15>15</a>
</span><span class=lnt id=hl-206-16><a class=lnlinks href=#hl-206-16>16</a>
</span><span class=lnt id=hl-206-17><a class=lnlinks href=#hl-206-17>17</a>
</span><span class=lnt id=hl-206-18><a class=lnlinks href=#hl-206-18>18</a>
</span><span class=lnt id=hl-206-19><a class=lnlinks href=#hl-206-19>19</a>
</span><span class=lnt id=hl-206-20><a class=lnlinks href=#hl-206-20>20</a>
</span><span class=lnt id=hl-206-21><a class=lnlinks href=#hl-206-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;启动...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>lock</span><span class=p>.</span><span class=na>tryLock</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获取立刻失败，返回&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获得了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获得了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-207-1><a class=lnlinks href=#hl-207-1>1</a>
</span><span class=lnt id=hl-207-2><a class=lnlinks href=#hl-207-2>2</a>
</span><span class=lnt id=hl-207-3><a class=lnlinks href=#hl-207-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:15:02.918 <span class=o>[</span>main<span class=o>]</span> c.TestTimeout - 获得了锁
</span></span><span class=line><span class=cl>18:15:02.921 <span class=o>[</span>t1<span class=o>]</span> c.TestTimeout - 启动... 
</span></span><span class=line><span class=cl>18:15:02.921 <span class=o>[</span>t1<span class=o>]</span> c.TestTimeout - 获取立刻失败，返回
</span></span></code></pre></td></tr></table></div></div><p>超时失败</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-208-1><a class=lnlinks href=#hl-208-1> 1</a>
</span><span class=lnt id=hl-208-2><a class=lnlinks href=#hl-208-2> 2</a>
</span><span class=lnt id=hl-208-3><a class=lnlinks href=#hl-208-3> 3</a>
</span><span class=lnt id=hl-208-4><a class=lnlinks href=#hl-208-4> 4</a>
</span><span class=lnt id=hl-208-5><a class=lnlinks href=#hl-208-5> 5</a>
</span><span class=lnt id=hl-208-6><a class=lnlinks href=#hl-208-6> 6</a>
</span><span class=lnt id=hl-208-7><a class=lnlinks href=#hl-208-7> 7</a>
</span><span class=lnt id=hl-208-8><a class=lnlinks href=#hl-208-8> 8</a>
</span><span class=lnt id=hl-208-9><a class=lnlinks href=#hl-208-9> 9</a>
</span><span class=lnt id=hl-208-10><a class=lnlinks href=#hl-208-10>10</a>
</span><span class=lnt id=hl-208-11><a class=lnlinks href=#hl-208-11>11</a>
</span><span class=lnt id=hl-208-12><a class=lnlinks href=#hl-208-12>12</a>
</span><span class=lnt id=hl-208-13><a class=lnlinks href=#hl-208-13>13</a>
</span><span class=lnt id=hl-208-14><a class=lnlinks href=#hl-208-14>14</a>
</span><span class=lnt id=hl-208-15><a class=lnlinks href=#hl-208-15>15</a>
</span><span class=lnt id=hl-208-16><a class=lnlinks href=#hl-208-16>16</a>
</span><span class=lnt id=hl-208-17><a class=lnlinks href=#hl-208-17>17</a>
</span><span class=lnt id=hl-208-18><a class=lnlinks href=#hl-208-18>18</a>
</span><span class=lnt id=hl-208-19><a class=lnlinks href=#hl-208-19>19</a>
</span><span class=lnt id=hl-208-20><a class=lnlinks href=#hl-208-20>20</a>
</span><span class=lnt id=hl-208-21><a class=lnlinks href=#hl-208-21>21</a>
</span><span class=lnt id=hl-208-22><a class=lnlinks href=#hl-208-22>22</a>
</span><span class=lnt id=hl-208-23><a class=lnlinks href=#hl-208-23>23</a>
</span><span class=lnt id=hl-208-24><a class=lnlinks href=#hl-208-24>24</a>
</span><span class=lnt id=hl-208-25><a class=lnlinks href=#hl-208-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;启动...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>lock</span><span class=p>.</span><span class=na>tryLock</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获取等待 1s 后失败，返回&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获得了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获得了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-209-1><a class=lnlinks href=#hl-209-1>1</a>
</span><span class=lnt id=hl-209-2><a class=lnlinks href=#hl-209-2>2</a>
</span><span class=lnt id=hl-209-3><a class=lnlinks href=#hl-209-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:19:40.537 <span class=o>[</span>main<span class=o>]</span> c.TestTimeout - 获得了锁
</span></span><span class=line><span class=cl>18:19:40.544 <span class=o>[</span>t1<span class=o>]</span> c.TestTimeout - 启动... 
</span></span><span class=line><span class=cl>18:19:41.547 <span class=o>[</span>t1<span class=o>]</span> c.TestTimeout - 获取等待 1s 后失败，返回
</span></span></code></pre></td></tr></table></div></div><p>使用 tryLock 解决哲学家就餐问题</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-210-1><a class=lnlinks href=#hl-210-1> 1</a>
</span><span class=lnt id=hl-210-2><a class=lnlinks href=#hl-210-2> 2</a>
</span><span class=lnt id=hl-210-3><a class=lnlinks href=#hl-210-3> 3</a>
</span><span class=lnt id=hl-210-4><a class=lnlinks href=#hl-210-4> 4</a>
</span><span class=lnt id=hl-210-5><a class=lnlinks href=#hl-210-5> 5</a>
</span><span class=lnt id=hl-210-6><a class=lnlinks href=#hl-210-6> 6</a>
</span><span class=lnt id=hl-210-7><a class=lnlinks href=#hl-210-7> 7</a>
</span><span class=lnt id=hl-210-8><a class=lnlinks href=#hl-210-8> 8</a>
</span><span class=lnt id=hl-210-9><a class=lnlinks href=#hl-210-9> 9</a>
</span><span class=lnt id=hl-210-10><a class=lnlinks href=#hl-210-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Chopstick</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Chopstick</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;筷子{&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=sc>&#39;}&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-211-1><a class=lnlinks href=#hl-211-1> 1</a>
</span><span class=lnt id=hl-211-2><a class=lnlinks href=#hl-211-2> 2</a>
</span><span class=lnt id=hl-211-3><a class=lnlinks href=#hl-211-3> 3</a>
</span><span class=lnt id=hl-211-4><a class=lnlinks href=#hl-211-4> 4</a>
</span><span class=lnt id=hl-211-5><a class=lnlinks href=#hl-211-5> 5</a>
</span><span class=lnt id=hl-211-6><a class=lnlinks href=#hl-211-6> 6</a>
</span><span class=lnt id=hl-211-7><a class=lnlinks href=#hl-211-7> 7</a>
</span><span class=lnt id=hl-211-8><a class=lnlinks href=#hl-211-8> 8</a>
</span><span class=lnt id=hl-211-9><a class=lnlinks href=#hl-211-9> 9</a>
</span><span class=lnt id=hl-211-10><a class=lnlinks href=#hl-211-10>10</a>
</span><span class=lnt id=hl-211-11><a class=lnlinks href=#hl-211-11>11</a>
</span><span class=lnt id=hl-211-12><a class=lnlinks href=#hl-211-12>12</a>
</span><span class=lnt id=hl-211-13><a class=lnlinks href=#hl-211-13>13</a>
</span><span class=lnt id=hl-211-14><a class=lnlinks href=#hl-211-14>14</a>
</span><span class=lnt id=hl-211-15><a class=lnlinks href=#hl-211-15>15</a>
</span><span class=lnt id=hl-211-16><a class=lnlinks href=#hl-211-16>16</a>
</span><span class=lnt id=hl-211-17><a class=lnlinks href=#hl-211-17>17</a>
</span><span class=lnt id=hl-211-18><a class=lnlinks href=#hl-211-18>18</a>
</span><span class=lnt id=hl-211-19><a class=lnlinks href=#hl-211-19>19</a>
</span><span class=lnt id=hl-211-20><a class=lnlinks href=#hl-211-20>20</a>
</span><span class=lnt id=hl-211-21><a class=lnlinks href=#hl-211-21>21</a>
</span><span class=lnt id=hl-211-22><a class=lnlinks href=#hl-211-22>22</a>
</span><span class=lnt id=hl-211-23><a class=lnlinks href=#hl-211-23>23</a>
</span><span class=lnt id=hl-211-24><a class=lnlinks href=#hl-211-24>24</a>
</span><span class=lnt id=hl-211-25><a class=lnlinks href=#hl-211-25>25</a>
</span><span class=lnt id=hl-211-26><a class=lnlinks href=#hl-211-26>26</a>
</span><span class=lnt id=hl-211-27><a class=lnlinks href=#hl-211-27>27</a>
</span><span class=lnt id=hl-211-28><a class=lnlinks href=#hl-211-28>28</a>
</span><span class=lnt id=hl-211-29><a class=lnlinks href=#hl-211-29>29</a>
</span><span class=lnt id=hl-211-30><a class=lnlinks href=#hl-211-30>30</a>
</span><span class=lnt id=hl-211-31><a class=lnlinks href=#hl-211-31>31</a>
</span><span class=lnt id=hl-211-32><a class=lnlinks href=#hl-211-32>32</a>
</span><span class=lnt id=hl-211-33><a class=lnlinks href=#hl-211-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Philosopher</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Chopstick</span><span class=w> </span><span class=n>left</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Chopstick</span><span class=w> </span><span class=n>right</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Philosopher</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>Chopstick</span><span class=w> </span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>Chopstick</span><span class=w> </span><span class=n>right</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>left</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>left</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>right</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>right</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 尝试获得左手筷子</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>left</span><span class=p>.</span><span class=na>tryLock</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 尝试获得右手筷子</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>right</span><span class=p>.</span><span class=na>tryLock</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>eat</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>right</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>left</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>eat</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;eating...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=公平锁><a href=#%e5%85%ac%e5%b9%b3%e9%94%81 class=header-anchor>#</a>
公平锁</h4><p>ReentrantLock 默认是不公平的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-212-1><a class=lnlinks href=#hl-212-1> 1</a>
</span><span class=lnt id=hl-212-2><a class=lnlinks href=#hl-212-2> 2</a>
</span><span class=lnt id=hl-212-3><a class=lnlinks href=#hl-212-3> 3</a>
</span><span class=lnt id=hl-212-4><a class=lnlinks href=#hl-212-4> 4</a>
</span><span class=lnt id=hl-212-5><a class=lnlinks href=#hl-212-5> 5</a>
</span><span class=lnt id=hl-212-6><a class=lnlinks href=#hl-212-6> 6</a>
</span><span class=lnt id=hl-212-7><a class=lnlinks href=#hl-212-7> 7</a>
</span><span class=lnt id=hl-212-8><a class=lnlinks href=#hl-212-8> 8</a>
</span><span class=lnt id=hl-212-9><a class=lnlinks href=#hl-212-9> 9</a>
</span><span class=lnt id=hl-212-10><a class=lnlinks href=#hl-212-10>10</a>
</span><span class=lnt id=hl-212-11><a class=lnlinks href=#hl-212-11>11</a>
</span><span class=lnt id=hl-212-12><a class=lnlinks href=#hl-212-12>12</a>
</span><span class=lnt id=hl-212-13><a class=lnlinks href=#hl-212-13>13</a>
</span><span class=lnt id=hl-212-14><a class=lnlinks href=#hl-212-14>14</a>
</span><span class=lnt id=hl-212-15><a class=lnlinks href=#hl-212-15>15</a>
</span><span class=lnt id=hl-212-16><a class=lnlinks href=#hl-212-16>16</a>
</span><span class=lnt id=hl-212-17><a class=lnlinks href=#hl-212-17>17</a>
</span><span class=lnt id=hl-212-18><a class=lnlinks href=#hl-212-18>18</a>
</span><span class=lnt id=hl-212-19><a class=lnlinks href=#hl-212-19>19</a>
</span><span class=lnt id=hl-212-20><a class=lnlinks href=#hl-212-20>20</a>
</span><span class=lnt id=hl-212-21><a class=lnlinks href=#hl-212-21>21</a>
</span><span class=lnt id=hl-212-22><a class=lnlinks href=#hl-212-22>22</a>
</span><span class=lnt id=hl-212-23><a class=lnlinks href=#hl-212-23>23</a>
</span><span class=lnt id=hl-212-24><a class=lnlinks href=#hl-212-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>500</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 1s 之后去争抢锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;强行插入&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>强行插入，有机会在中间输出</p><blockquote><p><strong>注意</strong>：该实验不一定总能复现</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-213-1><a class=lnlinks href=#hl-213-1> 1</a>
</span><span class=lnt id=hl-213-2><a class=lnlinks href=#hl-213-2> 2</a>
</span><span class=lnt id=hl-213-3><a class=lnlinks href=#hl-213-3> 3</a>
</span><span class=lnt id=hl-213-4><a class=lnlinks href=#hl-213-4> 4</a>
</span><span class=lnt id=hl-213-5><a class=lnlinks href=#hl-213-5> 5</a>
</span><span class=lnt id=hl-213-6><a class=lnlinks href=#hl-213-6> 6</a>
</span><span class=lnt id=hl-213-7><a class=lnlinks href=#hl-213-7> 7</a>
</span><span class=lnt id=hl-213-8><a class=lnlinks href=#hl-213-8> 8</a>
</span><span class=lnt id=hl-213-9><a class=lnlinks href=#hl-213-9> 9</a>
</span><span class=lnt id=hl-213-10><a class=lnlinks href=#hl-213-10>10</a>
</span><span class=lnt id=hl-213-11><a class=lnlinks href=#hl-213-11>11</a>
</span><span class=lnt id=hl-213-12><a class=lnlinks href=#hl-213-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>t39 running... 
</span></span><span class=line><span class=cl>t40 running... 
</span></span><span class=line><span class=cl>t41 running... 
</span></span><span class=line><span class=cl>t42 running... 
</span></span><span class=line><span class=cl>t43 running... 
</span></span><span class=line><span class=cl>强行插入 start... 
</span></span><span class=line><span class=cl>强行插入 running... 
</span></span><span class=line><span class=cl>t44 running... 
</span></span><span class=line><span class=cl>t45 running... 
</span></span><span class=line><span class=cl>t46 running... 
</span></span><span class=line><span class=cl>t47 running... 
</span></span><span class=line><span class=cl>t49 running... 
</span></span></code></pre></td></tr></table></div></div><p>改为公平锁后</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-214-1><a class=lnlinks href=#hl-214-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>强行插入，总是在最后输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-215-1><a class=lnlinks href=#hl-215-1> 1</a>
</span><span class=lnt id=hl-215-2><a class=lnlinks href=#hl-215-2> 2</a>
</span><span class=lnt id=hl-215-3><a class=lnlinks href=#hl-215-3> 3</a>
</span><span class=lnt id=hl-215-4><a class=lnlinks href=#hl-215-4> 4</a>
</span><span class=lnt id=hl-215-5><a class=lnlinks href=#hl-215-5> 5</a>
</span><span class=lnt id=hl-215-6><a class=lnlinks href=#hl-215-6> 6</a>
</span><span class=lnt id=hl-215-7><a class=lnlinks href=#hl-215-7> 7</a>
</span><span class=lnt id=hl-215-8><a class=lnlinks href=#hl-215-8> 8</a>
</span><span class=lnt id=hl-215-9><a class=lnlinks href=#hl-215-9> 9</a>
</span><span class=lnt id=hl-215-10><a class=lnlinks href=#hl-215-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>t465 running... 
</span></span><span class=line><span class=cl>t464 running... 
</span></span><span class=line><span class=cl>t477 running... 
</span></span><span class=line><span class=cl>t442 running... 
</span></span><span class=line><span class=cl>t468 running... 
</span></span><span class=line><span class=cl>t493 running... 
</span></span><span class=line><span class=cl>t482 running... 
</span></span><span class=line><span class=cl>t485 running... 
</span></span><span class=line><span class=cl>t481 running... 
</span></span><span class=line><span class=cl>强行插入 running... 
</span></span></code></pre></td></tr></table></div></div><p>公平锁一般没有必要，会降低并发度，后面分析原理时会讲解</p><h4 id=条件变量><a href=#%e6%9d%a1%e4%bb%b6%e5%8f%98%e9%87%8f class=header-anchor>#</a>
条件变量</h4><p>synchronized 中也有条件变量，就是我们讲原理时那个 waitSet 休息室，当条件不满足时进入 waitSet 等待</p><p>ReentrantLock 的条件变量比 synchronized 强大之处在于，它是支持多个条件变量的，这就好比</p><ul><li>synchronized 是那些不满足条件的线程都在一间休息室等消息</li><li>而 ReentrantLock 支持多间休息室，有专门等烟的休息室、专门等早餐的休息室、唤醒时也是按休息室来唤 醒</li></ul><h5 id=使用要点><a href=#%e4%bd%bf%e7%94%a8%e8%a6%81%e7%82%b9 class=header-anchor>#</a>
使用要点</h5><ul><li>await 前需要获得锁</li><li>await 执行后，会释放锁，进入 conditionObject 等待</li><li>await 的线程被唤醒（或打断、或超时）取重新竞争 lock 锁</li><li>竞争 lock 锁成功后，从 await 后继续执行</li></ul><h5 id=详细api><a href=#%e8%af%a6%e7%bb%86api class=header-anchor>#</a>
详细API</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-216-1><a class=lnlinks href=#hl-216-1> 1</a>
</span><span class=lnt id=hl-216-2><a class=lnlinks href=#hl-216-2> 2</a>
</span><span class=lnt id=hl-216-3><a class=lnlinks href=#hl-216-3> 3</a>
</span><span class=lnt id=hl-216-4><a class=lnlinks href=#hl-216-4> 4</a>
</span><span class=lnt id=hl-216-5><a class=lnlinks href=#hl-216-5> 5</a>
</span><span class=lnt id=hl-216-6><a class=lnlinks href=#hl-216-6> 6</a>
</span><span class=lnt id=hl-216-7><a class=lnlinks href=#hl-216-7> 7</a>
</span><span class=lnt id=hl-216-8><a class=lnlinks href=#hl-216-8> 8</a>
</span><span class=lnt id=hl-216-9><a class=lnlinks href=#hl-216-9> 9</a>
</span><span class=lnt id=hl-216-10><a class=lnlinks href=#hl-216-10>10</a>
</span><span class=lnt id=hl-216-11><a class=lnlinks href=#hl-216-11>11</a>
</span><span class=lnt id=hl-216-12><a class=lnlinks href=#hl-216-12>12</a>
</span><span class=lnt id=hl-216-13><a class=lnlinks href=#hl-216-13>13</a>
</span><span class=lnt id=hl-216-14><a class=lnlinks href=#hl-216-14>14</a>
</span><span class=lnt id=hl-216-15><a class=lnlinks href=#hl-216-15>15</a>
</span><span class=lnt id=hl-216-16><a class=lnlinks href=#hl-216-16>16</a>
</span><span class=lnt id=hl-216-17><a class=lnlinks href=#hl-216-17>17</a>
</span><span class=lnt id=hl-216-18><a class=lnlinks href=#hl-216-18>18</a>
</span><span class=lnt id=hl-216-19><a class=lnlinks href=#hl-216-19>19</a>
</span><span class=lnt id=hl-216-20><a class=lnlinks href=#hl-216-20>20</a>
</span><span class=lnt id=hl-216-21><a class=lnlinks href=#hl-216-21>21</a>
</span><span class=lnt id=hl-216-22><a class=lnlinks href=#hl-216-22>22</a>
</span><span class=lnt id=hl-216-23><a class=lnlinks href=#hl-216-23>23</a>
</span><span class=lnt id=hl-216-24><a class=lnlinks href=#hl-216-24>24</a>
</span><span class=lnt id=hl-216-25><a class=lnlinks href=#hl-216-25>25</a>
</span><span class=lnt id=hl-216-26><a class=lnlinks href=#hl-216-26>26</a>
</span><span class=lnt id=hl-216-27><a class=lnlinks href=#hl-216-27>27</a>
</span><span class=lnt id=hl-216-28><a class=lnlinks href=#hl-216-28>28</a>
</span><span class=lnt id=hl-216-29><a class=lnlinks href=#hl-216-29>29</a>
</span><span class=lnt id=hl-216-30><a class=lnlinks href=#hl-216-30>30</a>
</span><span class=lnt id=hl-216-31><a class=lnlinks href=#hl-216-31>31</a>
</span><span class=lnt id=hl-216-32><a class=lnlinks href=#hl-216-32>32</a>
</span><span class=lnt id=hl-216-33><a class=lnlinks href=#hl-216-33>33</a>
</span><span class=lnt id=hl-216-34><a class=lnlinks href=#hl-216-34>34</a>
</span><span class=lnt id=hl-216-35><a class=lnlinks href=#hl-216-35>35</a>
</span><span class=lnt id=hl-216-36><a class=lnlinks href=#hl-216-36>36</a>
</span><span class=lnt id=hl-216-37><a class=lnlinks href=#hl-216-37>37</a>
</span><span class=lnt id=hl-216-38><a class=lnlinks href=#hl-216-38>38</a>
</span><span class=lnt id=hl-216-39><a class=lnlinks href=#hl-216-39>39</a>
</span><span class=lnt id=hl-216-40><a class=lnlinks href=#hl-216-40>40</a>
</span><span class=lnt id=hl-216-41><a class=lnlinks href=#hl-216-41>41</a>
</span><span class=lnt id=hl-216-42><a class=lnlinks href=#hl-216-42>42</a>
</span><span class=lnt id=hl-216-43><a class=lnlinks href=#hl-216-43>43</a>
</span><span class=lnt id=hl-216-44><a class=lnlinks href=#hl-216-44>44</a>
</span><span class=lnt id=hl-216-45><a class=lnlinks href=#hl-216-45>45</a>
</span><span class=lnt id=hl-216-46><a class=lnlinks href=#hl-216-46>46</a>
</span><span class=lnt id=hl-216-47><a class=lnlinks href=#hl-216-47>47</a>
</span><span class=lnt id=hl-216-48><a class=lnlinks href=#hl-216-48>48</a>
</span><span class=lnt id=hl-216-49><a class=lnlinks href=#hl-216-49>49</a>
</span><span class=lnt id=hl-216-50><a class=lnlinks href=#hl-216-50>50</a>
</span><span class=lnt id=hl-216-51><a class=lnlinks href=#hl-216-51>51</a>
</span><span class=lnt id=hl-216-52><a class=lnlinks href=#hl-216-52>52</a>
</span><span class=lnt id=hl-216-53><a class=lnlinks href=#hl-216-53>53</a>
</span><span class=lnt id=hl-216-54><a class=lnlinks href=#hl-216-54>54</a>
</span><span class=lnt id=hl-216-55><a class=lnlinks href=#hl-216-55>55</a>
</span><span class=lnt id=hl-216-56><a class=lnlinks href=#hl-216-56>56</a>
</span><span class=lnt id=hl-216-57><a class=lnlinks href=#hl-216-57>57</a>
</span><span class=lnt id=hl-216-58><a class=lnlinks href=#hl-216-58>58</a>
</span><span class=lnt id=hl-216-59><a class=lnlinks href=#hl-216-59>59</a>
</span><span class=lnt id=hl-216-60><a class=lnlinks href=#hl-216-60>60</a>
</span><span class=lnt id=hl-216-61><a class=lnlinks href=#hl-216-61>61</a>
</span><span class=lnt id=hl-216-62><a class=lnlinks href=#hl-216-62>62</a>
</span><span class=lnt id=hl-216-63><a class=lnlinks href=#hl-216-63>63</a>
</span><span class=lnt id=hl-216-64><a class=lnlinks href=#hl-216-64>64</a>
</span><span class=lnt id=hl-216-65><a class=lnlinks href=#hl-216-65>65</a>
</span><span class=lnt id=hl-216-66><a class=lnlinks href=#hl-216-66>66</a>
</span><span class=lnt id=hl-216-67><a class=lnlinks href=#hl-216-67>67</a>
</span><span class=lnt id=hl-216-68><a class=lnlinks href=#hl-216-68>68</a>
</span><span class=lnt id=hl-216-69><a class=lnlinks href=#hl-216-69>69</a>
</span><span class=lnt id=hl-216-70><a class=lnlinks href=#hl-216-70>70</a>
</span><span class=lnt id=hl-216-71><a class=lnlinks href=#hl-216-71>71</a>
</span><span class=lnt id=hl-216-72><a class=lnlinks href=#hl-216-72>72</a>
</span><span class=lnt id=hl-216-73><a class=lnlinks href=#hl-216-73>73</a>
</span><span class=lnt id=hl-216-74><a class=lnlinks href=#hl-216-74>74</a>
</span><span class=lnt id=hl-216-75><a class=lnlinks href=#hl-216-75>75</a>
</span><span class=lnt id=hl-216-76><a class=lnlinks href=#hl-216-76>76</a>
</span><span class=lnt id=hl-216-77><a class=lnlinks href=#hl-216-77>77</a>
</span><span class=lnt id=hl-216-78><a class=lnlinks href=#hl-216-78>78</a>
</span><span class=lnt id=hl-216-79><a class=lnlinks href=#hl-216-79>79</a>
</span><span class=lnt id=hl-216-80><a class=lnlinks href=#hl-216-80>80</a>
</span><span class=lnt id=hl-216-81><a class=lnlinks href=#hl-216-81>81</a>
</span><span class=lnt id=hl-216-82><a class=lnlinks href=#hl-216-82>82</a>
</span><span class=lnt id=hl-216-83><a class=lnlinks href=#hl-216-83>83</a>
</span><span class=lnt id=hl-216-84><a class=lnlinks href=#hl-216-84>84</a>
</span><span class=lnt id=hl-216-85><a class=lnlinks href=#hl-216-85>85</a>
</span><span class=lnt id=hl-216-86><a class=lnlinks href=#hl-216-86>86</a>
</span><span class=lnt id=hl-216-87><a class=lnlinks href=#hl-216-87>87</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Condition</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>await</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>awaitUninterruptibly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     *  &lt;pre&gt; {@code
</span></span></span><span class=line><span class=cl><span class=cm>     * boolean aMethod(long timeout, TimeUnit unit) {
</span></span></span><span class=line><span class=cl><span class=cm>     *   long nanos = unit.toNanos(timeout);
</span></span></span><span class=line><span class=cl><span class=cm>     *   lock.lock();
</span></span></span><span class=line><span class=cl><span class=cm>     *   try {
</span></span></span><span class=line><span class=cl><span class=cm>     *     while (!conditionBeingWaitedFor()) {
</span></span></span><span class=line><span class=cl><span class=cm>     *       if (nanos &lt;= 0L)
</span></span></span><span class=line><span class=cl><span class=cm>     *         return false;
</span></span></span><span class=line><span class=cl><span class=cm>     *       nanos = theCondition.awaitNanos(nanos);
</span></span></span><span class=line><span class=cl><span class=cm>     *     }
</span></span></span><span class=line><span class=cl><span class=cm>     *     // ...
</span></span></span><span class=line><span class=cl><span class=cm>     *   } finally {
</span></span></span><span class=line><span class=cl><span class=cm>     *     lock.unlock();
</span></span></span><span class=line><span class=cl><span class=cm>     *   }
</span></span></span><span class=line><span class=cl><span class=cm>     * }}&lt;/pre&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param nanosTimeout the maximum time to wait, in nanoseconds
</span></span></span><span class=line><span class=cl><span class=cm>     * @return an estimate of the {@code nanosTimeout} value minus
</span></span></span><span class=line><span class=cl><span class=cm>     *         the time spent waiting upon return from this method.
</span></span></span><span class=line><span class=cl><span class=cm>     *         A positive value may be used as the argument to a
</span></span></span><span class=line><span class=cl><span class=cm>     *         subsequent call to this method to finish waiting out
</span></span></span><span class=line><span class=cl><span class=cm>     *         the desired time.  A value less than or equal to zero
</span></span></span><span class=line><span class=cl><span class=cm>     *         indicates that no time remains.
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws InterruptedException if the current thread is interrupted
</span></span></span><span class=line><span class=cl><span class=cm>     *         (and interruption of thread suspension is supported)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=nf>awaitNanos</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>nanosTimeout</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Causes the current thread to wait until it is signalled or interrupted,
</span></span></span><span class=line><span class=cl><span class=cm>     * or the specified waiting time elapses. This method is behaviorally
</span></span></span><span class=line><span class=cl><span class=cm>     * equivalent to:
</span></span></span><span class=line><span class=cl><span class=cm>     *  &lt;pre&gt; {@code awaitNanos(unit.toNanos(time)) &gt; 0}&lt;/pre&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param time the maximum time to wait
</span></span></span><span class=line><span class=cl><span class=cm>     * @param unit the time unit of the {@code time} argument
</span></span></span><span class=line><span class=cl><span class=cm>     * @return {@code false} if the waiting time detectably elapsed
</span></span></span><span class=line><span class=cl><span class=cm>     *         before return from the method, else {@code true}
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws InterruptedException if the current thread is interrupted
</span></span></span><span class=line><span class=cl><span class=cm>     *         (and interruption of thread suspension is supported)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>await</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Causes the current thread to wait until it is signalled or interrupted,
</span></span></span><span class=line><span class=cl><span class=cm>     * or the specified deadline elapses.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     *  &lt;pre&gt; {@code
</span></span></span><span class=line><span class=cl><span class=cm>     * boolean aMethod(Date deadline) {
</span></span></span><span class=line><span class=cl><span class=cm>     *   boolean stillWaiting = true;
</span></span></span><span class=line><span class=cl><span class=cm>     *   lock.lock();
</span></span></span><span class=line><span class=cl><span class=cm>     *   try {
</span></span></span><span class=line><span class=cl><span class=cm>     *     while (!conditionBeingWaitedFor()) {
</span></span></span><span class=line><span class=cl><span class=cm>     *       if (!stillWaiting)
</span></span></span><span class=line><span class=cl><span class=cm>     *         return false;
</span></span></span><span class=line><span class=cl><span class=cm>     *       stillWaiting = theCondition.awaitUntil(deadline);
</span></span></span><span class=line><span class=cl><span class=cm>     *     }
</span></span></span><span class=line><span class=cl><span class=cm>     *     // ...
</span></span></span><span class=line><span class=cl><span class=cm>     *   } finally {
</span></span></span><span class=line><span class=cl><span class=cm>     *     lock.unlock();
</span></span></span><span class=line><span class=cl><span class=cm>     *   }
</span></span></span><span class=line><span class=cl><span class=cm>     * }}&lt;/pre&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * @param deadline the absolute time to wait until
</span></span></span><span class=line><span class=cl><span class=cm>     * @return {@code false} if the deadline has elapsed upon return, else
</span></span></span><span class=line><span class=cl><span class=cm>     *         {@code true}
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws InterruptedException if the current thread is interrupted
</span></span></span><span class=line><span class=cl><span class=cm>     *         (and interruption of thread suspension is supported)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>awaitUntil</span><span class=p>(</span><span class=n>Date</span><span class=w> </span><span class=n>deadline</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Wakes up one waiting thread.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Wakes up all waiting threads.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>signalAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-217-1><a class=lnlinks href=#hl-217-1> 1</a>
</span><span class=lnt id=hl-217-2><a class=lnlinks href=#hl-217-2> 2</a>
</span><span class=lnt id=hl-217-3><a class=lnlinks href=#hl-217-3> 3</a>
</span><span class=lnt id=hl-217-4><a class=lnlinks href=#hl-217-4> 4</a>
</span><span class=lnt id=hl-217-5><a class=lnlinks href=#hl-217-5> 5</a>
</span><span class=lnt id=hl-217-6><a class=lnlinks href=#hl-217-6> 6</a>
</span><span class=lnt id=hl-217-7><a class=lnlinks href=#hl-217-7> 7</a>
</span><span class=lnt id=hl-217-8><a class=lnlinks href=#hl-217-8> 8</a>
</span><span class=lnt id=hl-217-9><a class=lnlinks href=#hl-217-9> 9</a>
</span><span class=lnt id=hl-217-10><a class=lnlinks href=#hl-217-10>10</a>
</span><span class=lnt id=hl-217-11><a class=lnlinks href=#hl-217-11>11</a>
</span><span class=lnt id=hl-217-12><a class=lnlinks href=#hl-217-12>12</a>
</span><span class=lnt id=hl-217-13><a class=lnlinks href=#hl-217-13>13</a>
</span><span class=lnt id=hl-217-14><a class=lnlinks href=#hl-217-14>14</a>
</span><span class=lnt id=hl-217-15><a class=lnlinks href=#hl-217-15>15</a>
</span><span class=lnt id=hl-217-16><a class=lnlinks href=#hl-217-16>16</a>
</span><span class=lnt id=hl-217-17><a class=lnlinks href=#hl-217-17>17</a>
</span><span class=lnt id=hl-217-18><a class=lnlinks href=#hl-217-18>18</a>
</span><span class=lnt id=hl-217-19><a class=lnlinks href=#hl-217-19>19</a>
</span><span class=lnt id=hl-217-20><a class=lnlinks href=#hl-217-20>20</a>
</span><span class=lnt id=hl-217-21><a class=lnlinks href=#hl-217-21>21</a>
</span><span class=lnt id=hl-217-22><a class=lnlinks href=#hl-217-22>22</a>
</span><span class=lnt id=hl-217-23><a class=lnlinks href=#hl-217-23>23</a>
</span><span class=lnt id=hl-217-24><a class=lnlinks href=#hl-217-24>24</a>
</span><span class=lnt id=hl-217-25><a class=lnlinks href=#hl-217-25>25</a>
</span><span class=lnt id=hl-217-26><a class=lnlinks href=#hl-217-26>26</a>
</span><span class=lnt id=hl-217-27><a class=lnlinks href=#hl-217-27>27</a>
</span><span class=lnt id=hl-217-28><a class=lnlinks href=#hl-217-28>28</a>
</span><span class=lnt id=hl-217-29><a class=lnlinks href=#hl-217-29>29</a>
</span><span class=lnt id=hl-217-30><a class=lnlinks href=#hl-217-30>30</a>
</span><span class=lnt id=hl-217-31><a class=lnlinks href=#hl-217-31>31</a>
</span><span class=lnt id=hl-217-32><a class=lnlinks href=#hl-217-32>32</a>
</span><span class=lnt id=hl-217-33><a class=lnlinks href=#hl-217-33>33</a>
</span><span class=lnt id=hl-217-34><a class=lnlinks href=#hl-217-34>34</a>
</span><span class=lnt id=hl-217-35><a class=lnlinks href=#hl-217-35>35</a>
</span><span class=lnt id=hl-217-36><a class=lnlinks href=#hl-217-36>36</a>
</span><span class=lnt id=hl-217-37><a class=lnlinks href=#hl-217-37>37</a>
</span><span class=lnt id=hl-217-38><a class=lnlinks href=#hl-217-38>38</a>
</span><span class=lnt id=hl-217-39><a class=lnlinks href=#hl-217-39>39</a>
</span><span class=lnt id=hl-217-40><a class=lnlinks href=#hl-217-40>40</a>
</span><span class=lnt id=hl-217-41><a class=lnlinks href=#hl-217-41>41</a>
</span><span class=lnt id=hl-217-42><a class=lnlinks href=#hl-217-42>42</a>
</span><span class=lnt id=hl-217-43><a class=lnlinks href=#hl-217-43>43</a>
</span><span class=lnt id=hl-217-44><a class=lnlinks href=#hl-217-44>44</a>
</span><span class=lnt id=hl-217-45><a class=lnlinks href=#hl-217-45>45</a>
</span><span class=lnt id=hl-217-46><a class=lnlinks href=#hl-217-46>46</a>
</span><span class=lnt id=hl-217-47><a class=lnlinks href=#hl-217-47>47</a>
</span><span class=lnt id=hl-217-48><a class=lnlinks href=#hl-217-48>48</a>
</span><span class=lnt id=hl-217-49><a class=lnlinks href=#hl-217-49>49</a>
</span><span class=lnt id=hl-217-50><a class=lnlinks href=#hl-217-50>50</a>
</span><span class=lnt id=hl-217-51><a class=lnlinks href=#hl-217-51>51</a>
</span><span class=lnt id=hl-217-52><a class=lnlinks href=#hl-217-52>52</a>
</span><span class=lnt id=hl-217-53><a class=lnlinks href=#hl-217-53>53</a>
</span><span class=lnt id=hl-217-54><a class=lnlinks href=#hl-217-54>54</a>
</span><span class=lnt id=hl-217-55><a class=lnlinks href=#hl-217-55>55</a>
</span><span class=lnt id=hl-217-56><a class=lnlinks href=#hl-217-56>56</a>
</span><span class=lnt id=hl-217-57><a class=lnlinks href=#hl-217-57>57</a>
</span><span class=lnt id=hl-217-58><a class=lnlinks href=#hl-217-58>58</a>
</span><span class=lnt id=hl-217-59><a class=lnlinks href=#hl-217-59>59</a>
</span><span class=lnt id=hl-217-60><a class=lnlinks href=#hl-217-60>60</a>
</span><span class=lnt id=hl-217-61><a class=lnlinks href=#hl-217-61>61</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>waitCigaretteQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>waitbreakfastQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasCigrette</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasBreakfast</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigrette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>waitCigaretteQueue</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;等到了它的烟&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasBreakfast</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>waitbreakfastQueue</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;等到了它的早餐&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sendBreakfast</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sendCigarette</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendCigarette</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;送烟来了&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hasCigrette</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>waitCigaretteQueue</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendBreakfast</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;送早餐来了&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hasBreakfast</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>waitbreakfastQueue</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-218-1><a class=lnlinks href=#hl-218-1>1</a>
</span><span class=lnt id=hl-218-2><a class=lnlinks href=#hl-218-2>2</a>
</span><span class=lnt id=hl-218-3><a class=lnlinks href=#hl-218-3>3</a>
</span><span class=lnt id=hl-218-4><a class=lnlinks href=#hl-218-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:52:27.680 <span class=o>[</span>main<span class=o>]</span> c.TestCondition - 送早餐来了
</span></span><span class=line><span class=cl>18:52:27.682 <span class=o>[</span>Thread-1<span class=o>]</span> c.TestCondition - 等到了它的早餐
</span></span><span class=line><span class=cl>18:52:28.683 <span class=o>[</span>main<span class=o>]</span> c.TestCondition - 送烟来了
</span></span><span class=line><span class=cl>18:52:28.683 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestCondition - 等到了它的烟
</span></span></code></pre></td></tr></table></div></div><h4 id=font-colororange-同步模式之顺序控制font><a href=#font-colororange-%e5%90%8c%e6%ad%a5%e6%a8%a1%e5%bc%8f%e4%b9%8b%e9%a1%ba%e5%ba%8f%e6%8e%a7%e5%88%b6font class=header-anchor>#</a>
<font color=orange>* 同步模式之顺序控制</font></h4><h5 id=固定运行顺序><a href=#%e5%9b%ba%e5%ae%9a%e8%bf%90%e8%a1%8c%e9%a1%ba%e5%ba%8f class=header-anchor>#</a>
固定运行顺序</h5><p>比如，必须先 2 后 1 打印</p><p><strong>wait notify 版</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-219-1><a class=lnlinks href=#hl-219-1> 1</a>
</span><span class=lnt id=hl-219-2><a class=lnlinks href=#hl-219-2> 2</a>
</span><span class=lnt id=hl-219-3><a class=lnlinks href=#hl-219-3> 3</a>
</span><span class=lnt id=hl-219-4><a class=lnlinks href=#hl-219-4> 4</a>
</span><span class=lnt id=hl-219-5><a class=lnlinks href=#hl-219-5> 5</a>
</span><span class=lnt id=hl-219-6><a class=lnlinks href=#hl-219-6> 6</a>
</span><span class=lnt id=hl-219-7><a class=lnlinks href=#hl-219-7> 7</a>
</span><span class=lnt id=hl-219-8><a class=lnlinks href=#hl-219-8> 8</a>
</span><span class=lnt id=hl-219-9><a class=lnlinks href=#hl-219-9> 9</a>
</span><span class=lnt id=hl-219-10><a class=lnlinks href=#hl-219-10>10</a>
</span><span class=lnt id=hl-219-11><a class=lnlinks href=#hl-219-11>11</a>
</span><span class=lnt id=hl-219-12><a class=lnlinks href=#hl-219-12>12</a>
</span><span class=lnt id=hl-219-13><a class=lnlinks href=#hl-219-13>13</a>
</span><span class=lnt id=hl-219-14><a class=lnlinks href=#hl-219-14>14</a>
</span><span class=lnt id=hl-219-15><a class=lnlinks href=#hl-219-15>15</a>
</span><span class=lnt id=hl-219-16><a class=lnlinks href=#hl-219-16>16</a>
</span><span class=lnt id=hl-219-17><a class=lnlinks href=#hl-219-17>17</a>
</span><span class=lnt id=hl-219-18><a class=lnlinks href=#hl-219-18>18</a>
</span><span class=lnt id=hl-219-19><a class=lnlinks href=#hl-219-19>19</a>
</span><span class=lnt id=hl-219-20><a class=lnlinks href=#hl-219-20>20</a>
</span><span class=lnt id=hl-219-21><a class=lnlinks href=#hl-219-21>21</a>
</span><span class=lnt id=hl-219-22><a class=lnlinks href=#hl-219-22>22</a>
</span><span class=lnt id=hl-219-23><a class=lnlinks href=#hl-219-23>23</a>
</span><span class=lnt id=hl-219-24><a class=lnlinks href=#hl-219-24>24</a>
</span><span class=lnt id=hl-219-25><a class=lnlinks href=#hl-219-25>25</a>
</span><span class=lnt id=hl-219-26><a class=lnlinks href=#hl-219-26>26</a>
</span><span class=lnt id=hl-219-27><a class=lnlinks href=#hl-219-27>27</a>
</span><span class=lnt id=hl-219-28><a class=lnlinks href=#hl-219-28>28</a>
</span><span class=lnt id=hl-219-29><a class=lnlinks href=#hl-219-29>29</a>
</span><span class=lnt id=hl-219-30><a class=lnlinks href=#hl-219-30>30</a>
</span><span class=lnt id=hl-219-31><a class=lnlinks href=#hl-219-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 用来同步的对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// t2 运行标记， 代表 t2 是否执行过</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>t2runed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果 t2 没有执行过</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>t2runed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// t1 先等一会</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>obj</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 修改运行标记</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t2runed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 通知 obj 上等待的线程（可能有多个，因此需要用 notifyAll）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>obj</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Park Unpark 版</strong></p><p>可以看到，实现上很麻烦：</p><ul><li>首先，需要保证先 wait 再 notify，否则 wait 线程永远得不到唤醒。因此使用了『运行标记』来判断该不该 wait</li><li>第二，如果有些干扰线程错误地 notify 了 wait 线程，条件不满足时还要重新等待，使用了 while 循环来解决 此问题</li><li>最后，唤醒对象上的 wait 线程需要使用 notifyAll，因为『同步对象』上的等待线程可能不止一个</li></ul><p>可以使用 LockSupport 类的 park 和 unpark 来简化上面的题目：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-220-1><a class=lnlinks href=#hl-220-1> 1</a>
</span><span class=lnt id=hl-220-2><a class=lnlinks href=#hl-220-2> 2</a>
</span><span class=lnt id=hl-220-3><a class=lnlinks href=#hl-220-3> 3</a>
</span><span class=lnt id=hl-220-4><a class=lnlinks href=#hl-220-4> 4</a>
</span><span class=lnt id=hl-220-5><a class=lnlinks href=#hl-220-5> 5</a>
</span><span class=lnt id=hl-220-6><a class=lnlinks href=#hl-220-6> 6</a>
</span><span class=lnt id=hl-220-7><a class=lnlinks href=#hl-220-7> 7</a>
</span><span class=lnt id=hl-220-8><a class=lnlinks href=#hl-220-8> 8</a>
</span><span class=lnt id=hl-220-9><a class=lnlinks href=#hl-220-9> 9</a>
</span><span class=lnt id=hl-220-10><a class=lnlinks href=#hl-220-10>10</a>
</span><span class=lnt id=hl-220-11><a class=lnlinks href=#hl-220-11>11</a>
</span><span class=lnt id=hl-220-12><a class=lnlinks href=#hl-220-12>12</a>
</span><span class=lnt id=hl-220-13><a class=lnlinks href=#hl-220-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 当没有『许可』时，当前线程暂停运行；有『许可』时，用掉这个『许可』，当前线程恢复运行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 给线程 t1 发放『许可』（多次连续调用 unpark 只会发放一个『许可』）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>t1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>park 和 unpark 方法比较灵活，他俩谁先调用，谁后调用无所谓。并且是以线程为单位进行『暂停』和『恢复』， 不需要『同步对象』和『运行标记』</p><h5 id=交替输出><a href=#%e4%ba%a4%e6%9b%bf%e8%be%93%e5%87%ba class=header-anchor>#</a>
交替输出</h5><p>线程 1 输出 a 5 次，线程 2 输出 b 5 次，线程 3 输出 c 5 次。现在要求输出 abcabcabcabcabc 怎么实现</p><p><strong>wait notify 版</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-221-1><a class=lnlinks href=#hl-221-1> 1</a>
</span><span class=lnt id=hl-221-2><a class=lnlinks href=#hl-221-2> 2</a>
</span><span class=lnt id=hl-221-3><a class=lnlinks href=#hl-221-3> 3</a>
</span><span class=lnt id=hl-221-4><a class=lnlinks href=#hl-221-4> 4</a>
</span><span class=lnt id=hl-221-5><a class=lnlinks href=#hl-221-5> 5</a>
</span><span class=lnt id=hl-221-6><a class=lnlinks href=#hl-221-6> 6</a>
</span><span class=lnt id=hl-221-7><a class=lnlinks href=#hl-221-7> 7</a>
</span><span class=lnt id=hl-221-8><a class=lnlinks href=#hl-221-8> 8</a>
</span><span class=lnt id=hl-221-9><a class=lnlinks href=#hl-221-9> 9</a>
</span><span class=lnt id=hl-221-10><a class=lnlinks href=#hl-221-10>10</a>
</span><span class=lnt id=hl-221-11><a class=lnlinks href=#hl-221-11>11</a>
</span><span class=lnt id=hl-221-12><a class=lnlinks href=#hl-221-12>12</a>
</span><span class=lnt id=hl-221-13><a class=lnlinks href=#hl-221-13>13</a>
</span><span class=lnt id=hl-221-14><a class=lnlinks href=#hl-221-14>14</a>
</span><span class=lnt id=hl-221-15><a class=lnlinks href=#hl-221-15>15</a>
</span><span class=lnt id=hl-221-16><a class=lnlinks href=#hl-221-16>16</a>
</span><span class=lnt id=hl-221-17><a class=lnlinks href=#hl-221-17>17</a>
</span><span class=lnt id=hl-221-18><a class=lnlinks href=#hl-221-18>18</a>
</span><span class=lnt id=hl-221-19><a class=lnlinks href=#hl-221-19>19</a>
</span><span class=lnt id=hl-221-20><a class=lnlinks href=#hl-221-20>20</a>
</span><span class=lnt id=hl-221-21><a class=lnlinks href=#hl-221-21>21</a>
</span><span class=lnt id=hl-221-22><a class=lnlinks href=#hl-221-22>22</a>
</span><span class=lnt id=hl-221-23><a class=lnlinks href=#hl-221-23>23</a>
</span><span class=lnt id=hl-221-24><a class=lnlinks href=#hl-221-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SyncWaitNotify</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SyncWaitNotify</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>flag</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>loopNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>print</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>waitFlag</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>nextFlag</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>flag</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>waitFlag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>this</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>str</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextFlag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-222-1><a class=lnlinks href=#hl-222-1> 1</a>
</span><span class=lnt id=hl-222-2><a class=lnlinks href=#hl-222-2> 2</a>
</span><span class=lnt id=hl-222-3><a class=lnlinks href=#hl-222-3> 3</a>
</span><span class=lnt id=hl-222-4><a class=lnlinks href=#hl-222-4> 4</a>
</span><span class=lnt id=hl-222-5><a class=lnlinks href=#hl-222-5> 5</a>
</span><span class=lnt id=hl-222-6><a class=lnlinks href=#hl-222-6> 6</a>
</span><span class=lnt id=hl-222-7><a class=lnlinks href=#hl-222-7> 7</a>
</span><span class=lnt id=hl-222-8><a class=lnlinks href=#hl-222-8> 8</a>
</span><span class=lnt id=hl-222-9><a class=lnlinks href=#hl-222-9> 9</a>
</span><span class=lnt id=hl-222-10><a class=lnlinks href=#hl-222-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SyncWaitNotify</span><span class=w> </span><span class=n>syncWaitNotify</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SyncWaitNotify</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncWaitNotify</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=s>&#34;a&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncWaitNotify</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=s>&#34;b&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncWaitNotify</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=s>&#34;c&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Lock 条件变量版</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-223-1><a class=lnlinks href=#hl-223-1> 1</a>
</span><span class=lnt id=hl-223-2><a class=lnlinks href=#hl-223-2> 2</a>
</span><span class=lnt id=hl-223-3><a class=lnlinks href=#hl-223-3> 3</a>
</span><span class=lnt id=hl-223-4><a class=lnlinks href=#hl-223-4> 4</a>
</span><span class=lnt id=hl-223-5><a class=lnlinks href=#hl-223-5> 5</a>
</span><span class=lnt id=hl-223-6><a class=lnlinks href=#hl-223-6> 6</a>
</span><span class=lnt id=hl-223-7><a class=lnlinks href=#hl-223-7> 7</a>
</span><span class=lnt id=hl-223-8><a class=lnlinks href=#hl-223-8> 8</a>
</span><span class=lnt id=hl-223-9><a class=lnlinks href=#hl-223-9> 9</a>
</span><span class=lnt id=hl-223-10><a class=lnlinks href=#hl-223-10>10</a>
</span><span class=lnt id=hl-223-11><a class=lnlinks href=#hl-223-11>11</a>
</span><span class=lnt id=hl-223-12><a class=lnlinks href=#hl-223-12>12</a>
</span><span class=lnt id=hl-223-13><a class=lnlinks href=#hl-223-13>13</a>
</span><span class=lnt id=hl-223-14><a class=lnlinks href=#hl-223-14>14</a>
</span><span class=lnt id=hl-223-15><a class=lnlinks href=#hl-223-15>15</a>
</span><span class=lnt id=hl-223-16><a class=lnlinks href=#hl-223-16>16</a>
</span><span class=lnt id=hl-223-17><a class=lnlinks href=#hl-223-17>17</a>
</span><span class=lnt id=hl-223-18><a class=lnlinks href=#hl-223-18>18</a>
</span><span class=lnt id=hl-223-19><a class=lnlinks href=#hl-223-19>19</a>
</span><span class=lnt id=hl-223-20><a class=lnlinks href=#hl-223-20>20</a>
</span><span class=lnt id=hl-223-21><a class=lnlinks href=#hl-223-21>21</a>
</span><span class=lnt id=hl-223-22><a class=lnlinks href=#hl-223-22>22</a>
</span><span class=lnt id=hl-223-23><a class=lnlinks href=#hl-223-23>23</a>
</span><span class=lnt id=hl-223-24><a class=lnlinks href=#hl-223-24>24</a>
</span><span class=lnt id=hl-223-25><a class=lnlinks href=#hl-223-25>25</a>
</span><span class=lnt id=hl-223-26><a class=lnlinks href=#hl-223-26>26</a>
</span><span class=lnt id=hl-223-27><a class=lnlinks href=#hl-223-27>27</a>
</span><span class=lnt id=hl-223-28><a class=lnlinks href=#hl-223-28>28</a>
</span><span class=lnt id=hl-223-29><a class=lnlinks href=#hl-223-29>29</a>
</span><span class=lnt id=hl-223-30><a class=lnlinks href=#hl-223-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AwaitSignal</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(</span><span class=n>Condition</span><span class=w> </span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>print</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>current</span><span class=p>,</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>current</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>str</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>next</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 循环次数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AwaitSignal</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>loopNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-224-1><a class=lnlinks href=#hl-224-1> 1</a>
</span><span class=lnt id=hl-224-2><a class=lnlinks href=#hl-224-2> 2</a>
</span><span class=lnt id=hl-224-3><a class=lnlinks href=#hl-224-3> 3</a>
</span><span class=lnt id=hl-224-4><a class=lnlinks href=#hl-224-4> 4</a>
</span><span class=lnt id=hl-224-5><a class=lnlinks href=#hl-224-5> 5</a>
</span><span class=lnt id=hl-224-6><a class=lnlinks href=#hl-224-6> 6</a>
</span><span class=lnt id=hl-224-7><a class=lnlinks href=#hl-224-7> 7</a>
</span><span class=lnt id=hl-224-8><a class=lnlinks href=#hl-224-8> 8</a>
</span><span class=lnt id=hl-224-9><a class=lnlinks href=#hl-224-9> 9</a>
</span><span class=lnt id=hl-224-10><a class=lnlinks href=#hl-224-10>10</a>
</span><span class=lnt id=hl-224-11><a class=lnlinks href=#hl-224-11>11</a>
</span><span class=lnt id=hl-224-12><a class=lnlinks href=#hl-224-12>12</a>
</span><span class=lnt id=hl-224-13><a class=lnlinks href=#hl-224-13>13</a>
</span><span class=lnt id=hl-224-14><a class=lnlinks href=#hl-224-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>AwaitSignal</span><span class=w> </span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AwaitSignal</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Condition</span><span class=w> </span><span class=n>aWaitSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Condition</span><span class=w> </span><span class=n>bWaitSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Condition</span><span class=w> </span><span class=n>cWaitSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>as</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>,</span><span class=w> </span><span class=n>aWaitSet</span><span class=p>,</span><span class=w> </span><span class=n>bWaitSet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>as</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>,</span><span class=w> </span><span class=n>bWaitSet</span><span class=p>,</span><span class=w> </span><span class=n>cWaitSet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>as</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;c&#34;</span><span class=p>,</span><span class=w> </span><span class=n>cWaitSet</span><span class=p>,</span><span class=w> </span><span class=n>aWaitSet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>as</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>aWaitSet</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p><p>该实现没有考虑 a，b，c 线程都就绪再开始</p></blockquote><p><strong>Park Unpark 版</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-225-1><a class=lnlinks href=#hl-225-1> 1</a>
</span><span class=lnt id=hl-225-2><a class=lnlinks href=#hl-225-2> 2</a>
</span><span class=lnt id=hl-225-3><a class=lnlinks href=#hl-225-3> 3</a>
</span><span class=lnt id=hl-225-4><a class=lnlinks href=#hl-225-4> 4</a>
</span><span class=lnt id=hl-225-5><a class=lnlinks href=#hl-225-5> 5</a>
</span><span class=lnt id=hl-225-6><a class=lnlinks href=#hl-225-6> 6</a>
</span><span class=lnt id=hl-225-7><a class=lnlinks href=#hl-225-7> 7</a>
</span><span class=lnt id=hl-225-8><a class=lnlinks href=#hl-225-8> 8</a>
</span><span class=lnt id=hl-225-9><a class=lnlinks href=#hl-225-9> 9</a>
</span><span class=lnt id=hl-225-10><a class=lnlinks href=#hl-225-10>10</a>
</span><span class=lnt id=hl-225-11><a class=lnlinks href=#hl-225-11>11</a>
</span><span class=lnt id=hl-225-12><a class=lnlinks href=#hl-225-12>12</a>
</span><span class=lnt id=hl-225-13><a class=lnlinks href=#hl-225-13>13</a>
</span><span class=lnt id=hl-225-14><a class=lnlinks href=#hl-225-14>14</a>
</span><span class=lnt id=hl-225-15><a class=lnlinks href=#hl-225-15>15</a>
</span><span class=lnt id=hl-225-16><a class=lnlinks href=#hl-225-16>16</a>
</span><span class=lnt id=hl-225-17><a class=lnlinks href=#hl-225-17>17</a>
</span><span class=lnt id=hl-225-18><a class=lnlinks href=#hl-225-18>18</a>
</span><span class=lnt id=hl-225-19><a class=lnlinks href=#hl-225-19>19</a>
</span><span class=lnt id=hl-225-20><a class=lnlinks href=#hl-225-20>20</a>
</span><span class=lnt id=hl-225-21><a class=lnlinks href=#hl-225-21>21</a>
</span><span class=lnt id=hl-225-22><a class=lnlinks href=#hl-225-22>22</a>
</span><span class=lnt id=hl-225-23><a class=lnlinks href=#hl-225-23>23</a>
</span><span class=lnt id=hl-225-24><a class=lnlinks href=#hl-225-24>24</a>
</span><span class=lnt id=hl-225-25><a class=lnlinks href=#hl-225-25>25</a>
</span><span class=lnt id=hl-225-26><a class=lnlinks href=#hl-225-26>26</a>
</span><span class=lnt id=hl-225-27><a class=lnlinks href=#hl-225-27>27</a>
</span><span class=lnt id=hl-225-28><a class=lnlinks href=#hl-225-28>28</a>
</span><span class=lnt id=hl-225-29><a class=lnlinks href=#hl-225-29>29</a>
</span><span class=lnt id=hl-225-30><a class=lnlinks href=#hl-225-30>30</a>
</span><span class=lnt id=hl-225-31><a class=lnlinks href=#hl-225-31>31</a>
</span><span class=lnt id=hl-225-32><a class=lnlinks href=#hl-225-32>32</a>
</span><span class=lnt id=hl-225-33><a class=lnlinks href=#hl-225-33>33</a>
</span><span class=lnt id=hl-225-34><a class=lnlinks href=#hl-225-34>34</a>
</span><span class=lnt id=hl-225-35><a class=lnlinks href=#hl-225-35>35</a>
</span><span class=lnt id=hl-225-36><a class=lnlinks href=#hl-225-36>36</a>
</span><span class=lnt id=hl-225-37><a class=lnlinks href=#hl-225-37>37</a>
</span><span class=lnt id=hl-225-38><a class=lnlinks href=#hl-225-38>38</a>
</span><span class=lnt id=hl-225-39><a class=lnlinks href=#hl-225-39>39</a>
</span><span class=lnt id=hl-225-40><a class=lnlinks href=#hl-225-40>40</a>
</span><span class=lnt id=hl-225-41><a class=lnlinks href=#hl-225-41>41</a>
</span><span class=lnt id=hl-225-42><a class=lnlinks href=#hl-225-42>42</a>
</span><span class=lnt id=hl-225-43><a class=lnlinks href=#hl-225-43>43</a>
</span><span class=lnt id=hl-225-44><a class=lnlinks href=#hl-225-44>44</a>
</span><span class=lnt id=hl-225-45><a class=lnlinks href=#hl-225-45>45</a>
</span><span class=lnt id=hl-225-46><a class=lnlinks href=#hl-225-46>46</a>
</span><span class=lnt id=hl-225-47><a class=lnlinks href=#hl-225-47>47</a>
</span><span class=lnt id=hl-225-48><a class=lnlinks href=#hl-225-48>48</a>
</span><span class=lnt id=hl-225-49><a class=lnlinks href=#hl-225-49>49</a>
</span><span class=lnt id=hl-225-50><a class=lnlinks href=#hl-225-50>50</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SyncPark</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=o>[]</span><span class=w> </span><span class=n>threads</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SyncPark</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>loopNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setThreads</span><span class=p>(</span><span class=n>Thread</span><span class=p>...</span><span class=w> </span><span class=n>threads</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>threads</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>threads</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>print</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>str</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>nextThread</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=nf>nextThread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>threads</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>threads</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>current</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>index</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>threads</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>threads</span><span class=o>[</span><span class=n>index</span><span class=o>+</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>threads</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>threads</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>threads</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>SyncPark</span><span class=w> </span><span class=n>syncPark</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SyncPark</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncPark</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncPark</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncPark</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;c\n&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>syncPark</span><span class=p>.</span><span class=na>setThreads</span><span class=p>(</span><span class=n>t1</span><span class=p>,</span><span class=w> </span><span class=n>t2</span><span class=p>,</span><span class=w> </span><span class=n>t3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>syncPark</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=本章小结-1><a href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-1 class=header-anchor>#</a>
本章小结</h2><p>本章我们需要重点掌握的是</p><ul><li>分析多线程访问共享资源时，哪些代码片段属于临界区</li><li>使用 synchronized 互斥解决临界区的线程安全问题<ul><li>掌握 synchronized 锁对象语法</li><li>掌握 synchronzied 加载成员方法和静态方法语法</li><li>掌握 wait/notify 同步方法</li></ul></li><li>使用 lock 互斥解决临界区的线程安全问题<ul><li>掌握 lock 的使用细节：可打断、锁超时、公平锁、条件变量</li></ul></li><li>学会分析变量的线程安全性、掌握常见线程安全类的使用<ul><li>线程安全类的方法是原子性的，但方法之间的组合要具体分析。</li></ul></li><li>了解线程活跃性问题：死锁、活锁、饥饿。<ul><li>解决死锁、饥饿的方式：ReentranLock</li></ul></li><li><font color=green>应用方面</font><ul><li>互斥：使用 synchronized 或 Lock 达到共享资源互斥效果</li><li>同步：使用 wait/notify 或 Lock 的条件变量来达到线程间通信效果</li></ul></li><li><font color=blue>原理方面</font><ul><li>monitor、synchronized 、wait/notify 原理</li><li>synchronized 进阶原理</li><li>park & unpark 原理</li></ul></li><li><font color=orange>模式方面</font><ul><li>同步模式之保护性暂停</li><li>异步模式之生产者消费者</li><li>同步模式之顺序控制</li></ul></li></ul><h1 id=5共享模型之内存><a href=#5%e5%85%b1%e4%ba%ab%e6%a8%a1%e5%9e%8b%e4%b9%8b%e5%86%85%e5%ad%98 class=header-anchor>#</a>
5.共享模型之内存</h1><h2 id=51-java-内存模型><a href=#51-java-%e5%86%85%e5%ad%98%e6%a8%a1%e5%9e%8b class=header-anchor>#</a>
5.1 Java 内存模型</h2><p>JMM 即 Java Memory Model，它定义了主存、工作内存抽象概念，底层对应着 CPU 寄存器、缓存、硬件内存、 CPU 指令优化等。</p><p>JMM的意义</p><ul><li>计算机硬件底层的内存结构过于复杂，JMM的意义在于避免程序员直接管理计算机底层内存，用一些关键字synchronized、volatile等可以方便的管理内存。</li></ul><p>JMM 体现在以下几个方面</p><ul><li>原子性 - 保证指令不会受到线程上下文切换的影响</li><li>可见性 - 保证指令不会受 cpu 缓存的影响</li><li>有序性 - 保证指令不会受 cpu 指令并行优化的影响</li></ul><h2 id=52-可见性><a href=#52-%e5%8f%af%e8%a7%81%e6%80%a7 class=header-anchor>#</a>
5.2 可见性</h2><h4 id=退不出的循环><a href=#%e9%80%80%e4%b8%8d%e5%87%ba%e7%9a%84%e5%be%aa%e7%8e%af class=header-anchor>#</a>
退不出的循环</h4><p>先来看一个现象，main 线程对 run 变量的修改对于 t 线程不可见，导致了 t 线程无法停止：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-226-1><a class=lnlinks href=#hl-226-1> 1</a>
</span><span class=lnt id=hl-226-2><a class=lnlinks href=#hl-226-2> 2</a>
</span><span class=lnt id=hl-226-3><a class=lnlinks href=#hl-226-3> 3</a>
</span><span class=lnt id=hl-226-4><a class=lnlinks href=#hl-226-4> 4</a>
</span><span class=lnt id=hl-226-5><a class=lnlinks href=#hl-226-5> 5</a>
</span><span class=lnt id=hl-226-6><a class=lnlinks href=#hl-226-6> 6</a>
</span><span class=lnt id=hl-226-7><a class=lnlinks href=#hl-226-7> 7</a>
</span><span class=lnt id=hl-226-8><a class=lnlinks href=#hl-226-8> 8</a>
</span><span class=lnt id=hl-226-9><a class=lnlinks href=#hl-226-9> 9</a>
</span><span class=lnt id=hl-226-10><a class=lnlinks href=#hl-226-10>10</a>
</span><span class=lnt id=hl-226-11><a class=lnlinks href=#hl-226-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>run</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=n>run</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>run</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=c1>// 线程t不会如预想的停下来</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>为什么呢？分析一下：</p><ol><li>初始状态， t 线程刚开始从主内存读取了 run 的值到工作内存。</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220305192346249.png width=900 height=600 loading=lazy decoding=async alt=image-20220305192346249 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ol start=2><li>因为 t 线程要频繁从主内存中读取 run 的值，JIT 编译器会将 run 的值缓存至自己工作内存中的高速缓存中， 减少对主存中 run 的访问，提高效率</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220305192416102.png width=900 height=600 loading=lazy decoding=async alt=image-20220305192416102 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ol start=3><li>1 秒之后，main 线程修改了 run 的值，并同步至主存，而 t 是从自己工作内存中的高速缓存中读取这个变量 的值，结果永远是旧值</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220305192512523.png width=900 height=600 loading=lazy decoding=async alt=image-20220305192512523 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=解决方法><a href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
解决方法</h4><p>volatile（易变关键字）</p><p>它可以用来修饰成员变量和静态成员变量，他可以避免线程从自己的工作缓存中查找变量的值，必须到主存中获取 它的值，线程操作 volatile 变量都是直接操作主存</p><h4 id=可见性-vs-原子性><a href=#%e5%8f%af%e8%a7%81%e6%80%a7-vs-%e5%8e%9f%e5%ad%90%e6%80%a7 class=header-anchor>#</a>
可见性 vs 原子性</h4><p>前面例子体现的实际就是可见性，它保证的是在多个线程之间，一个线程对 volatile 变量的修改对另一个线程可 见， 不能保证原子性，仅用在一个写线程，多个读线程的情况： 上例从字节码理解是这样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-227-1><a class=lnlinks href=#hl-227-1>1</a>
</span><span class=lnt id=hl-227-2><a class=lnlinks href=#hl-227-2>2</a>
</span><span class=lnt id=hl-227-3><a class=lnlinks href=#hl-227-3>3</a>
</span><span class=lnt id=hl-227-4><a class=lnlinks href=#hl-227-4>4</a>
</span><span class=lnt id=hl-227-5><a class=lnlinks href=#hl-227-5>5</a>
</span><span class=lnt id=hl-227-6><a class=lnlinks href=#hl-227-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>getstatic run // 线程 t 获取 run <span class=nb>true</span> 
</span></span><span class=line><span class=cl>getstatic run // 线程 t 获取 run <span class=nb>true</span> 
</span></span><span class=line><span class=cl>getstatic run // 线程 t 获取 run <span class=nb>true</span> 
</span></span><span class=line><span class=cl>getstatic run // 线程 t 获取 run <span class=nb>true</span> 
</span></span><span class=line><span class=cl>putstatic run // 线程 main 修改 run 为 false， 仅此一次
</span></span><span class=line><span class=cl>getstatic run // 线程 t 获取 run <span class=nb>false</span> 
</span></span></code></pre></td></tr></table></div></div><p>比较一下之前我们将线程安全时举的例子：两个线程一个 i++ 一个 i&ndash; ，只能保证看到最新值，不能解决指令交错</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-228-1><a class=lnlinks href=#hl-228-1>1</a>
</span><span class=lnt id=hl-228-2><a class=lnlinks href=#hl-228-2>2</a>
</span><span class=lnt id=hl-228-3><a class=lnlinks href=#hl-228-3>3</a>
</span><span class=lnt id=hl-228-4><a class=lnlinks href=#hl-228-4>4</a>
</span><span class=lnt id=hl-228-5><a class=lnlinks href=#hl-228-5>5</a>
</span><span class=lnt id=hl-228-6><a class=lnlinks href=#hl-228-6>6</a>
</span><span class=lnt id=hl-228-7><a class=lnlinks href=#hl-228-7>7</a>
</span><span class=lnt id=hl-228-8><a class=lnlinks href=#hl-228-8>8</a>
</span><span class=lnt id=hl-228-9><a class=lnlinks href=#hl-228-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>// 假设i的初始值为0 
</span></span><span class=line><span class=cl>getstatic i // 线程2-获取静态变量i的值 <span class=nv>线程内i</span><span class=o>=</span><span class=m>0</span> 
</span></span><span class=line><span class=cl>getstatic i // 线程1-获取静态变量i的值 <span class=nv>线程内i</span><span class=o>=</span><span class=m>0</span> 
</span></span><span class=line><span class=cl>iconst_1 // 线程1-准备常量1 
</span></span><span class=line><span class=cl>iadd // 线程1-自增 <span class=nv>线程内i</span><span class=o>=</span><span class=m>1</span> 
</span></span><span class=line><span class=cl>putstatic i // 线程1-将修改后的值存入静态变量i <span class=nv>静态变量i</span><span class=o>=</span><span class=m>1</span> 
</span></span><span class=line><span class=cl>iconst_1 // 线程2-准备常量1 
</span></span><span class=line><span class=cl>isub // 线程2-自减 <span class=nv>线程内i</span><span class=o>=</span>-1 
</span></span><span class=line><span class=cl>putstatic i // 线程2-将修改后的值存入静态变量i <span class=nv>静态变量i</span><span class=o>=</span>-1 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p><p>synchronized 语句块既可以保证代码块的原子性，也同时保证代码块内变量的可见性。但缺点是 synchronized 是属于重量级操作，性能相对更低 。</p><p>JMM关于synchronized的两条规定：</p><p>　　1）线程解锁前，必须把共享变量的最新值刷新到主内存中</p><p>　　2）线程加锁时，将清空工作内存中共享变量的值，从而使用共享变量时需要从主内存中重新获取最新的值</p><p>　　　（注意：加锁与解锁需要是同一把锁）</p><p>通过以上两点，可以看到synchronized能够实现可见性。同时，由于synchronized具有同步锁，所以它也具有原子性</p><p>如果在前面示例的死循环中加入 System.out.println() 会发现即使不加 volatile 修饰符，线程 t 也能正确看到 对 run 变量的修改了，想一想为什么？(println方法中有synchronized代码块保证了可见性)</p><p>synchronized关键字不能阻止指令重排，但在一定程度上能保证有序性（如果共享变量没有逃逸出同步代码块的话）。因为在单线程的情况下指令重排不影响结果，相当于保障了有序性。</p></blockquote><h4 id=font-colororange-模式之两阶段终止font-1><a href=#font-colororange-%e6%a8%a1%e5%bc%8f%e4%b9%8b%e4%b8%a4%e9%98%b6%e6%ae%b5%e7%bb%88%e6%ad%a2font-1 class=header-anchor>#</a>
<font color=orange>* 模式之两阶段终止</font></h4><p>Two Phase Termination</p><p>在一个线程 T1 中如何“优雅”终止线程 T2？这里的【优雅】指的是给 T2 一个料理后事的机会。</p><h5 id=1错误思路><a href=#1%e9%94%99%e8%af%af%e6%80%9d%e8%b7%af class=header-anchor>#</a>
1.错误思路</h5><ul><li>使用线程对象的 stop() 方法停止线程<ul><li>stop 方法会真正杀死线程，如果这时线程锁住了共享资源，那么当它被杀死后就再也没有机会释放锁， 其它线程将永远无法获取锁</li></ul></li><li>使用 System.exit(int) 方法停止线程<ul><li>目的仅是停止一个线程，但这种做法会让整个程序都停止</li></ul></li></ul><h5 id=2两阶段终止模式><a href=#2%e4%b8%a4%e9%98%b6%e6%ae%b5%e7%bb%88%e6%ad%a2%e6%a8%a1%e5%bc%8f class=header-anchor>#</a>
2.两阶段终止模式</h5><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220305211507893.png width=900 height=600 loading=lazy decoding=async alt=image-20220305211507893 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>利用 isInterrupted</strong></p><p>interrupt 可以打断正在执行的线程，无论这个线程是在 sleep，wait，还是正常运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-229-1><a class=lnlinks href=#hl-229-1> 1</a>
</span><span class=lnt id=hl-229-2><a class=lnlinks href=#hl-229-2> 2</a>
</span><span class=lnt id=hl-229-3><a class=lnlinks href=#hl-229-3> 3</a>
</span><span class=lnt id=hl-229-4><a class=lnlinks href=#hl-229-4> 4</a>
</span><span class=lnt id=hl-229-5><a class=lnlinks href=#hl-229-5> 5</a>
</span><span class=lnt id=hl-229-6><a class=lnlinks href=#hl-229-6> 6</a>
</span><span class=lnt id=hl-229-7><a class=lnlinks href=#hl-229-7> 7</a>
</span><span class=lnt id=hl-229-8><a class=lnlinks href=#hl-229-8> 8</a>
</span><span class=lnt id=hl-229-9><a class=lnlinks href=#hl-229-9> 9</a>
</span><span class=lnt id=hl-229-10><a class=lnlinks href=#hl-229-10>10</a>
</span><span class=lnt id=hl-229-11><a class=lnlinks href=#hl-229-11>11</a>
</span><span class=lnt id=hl-229-12><a class=lnlinks href=#hl-229-12>12</a>
</span><span class=lnt id=hl-229-13><a class=lnlinks href=#hl-229-13>13</a>
</span><span class=lnt id=hl-229-14><a class=lnlinks href=#hl-229-14>14</a>
</span><span class=lnt id=hl-229-15><a class=lnlinks href=#hl-229-15>15</a>
</span><span class=lnt id=hl-229-16><a class=lnlinks href=#hl-229-16>16</a>
</span><span class=lnt id=hl-229-17><a class=lnlinks href=#hl-229-17>17</a>
</span><span class=lnt id=hl-229-18><a class=lnlinks href=#hl-229-18>18</a>
</span><span class=lnt id=hl-229-19><a class=lnlinks href=#hl-229-19>19</a>
</span><span class=lnt id=hl-229-20><a class=lnlinks href=#hl-229-20>20</a>
</span><span class=lnt id=hl-229-21><a class=lnlinks href=#hl-229-21>21</a>
</span><span class=lnt id=hl-229-22><a class=lnlinks href=#hl-229-22>22</a>
</span><span class=lnt id=hl-229-23><a class=lnlinks href=#hl-229-23>23</a>
</span><span class=lnt id=hl-229-24><a class=lnlinks href=#hl-229-24>24</a>
</span><span class=lnt id=hl-229-25><a class=lnlinks href=#hl-229-25>25</a>
</span><span class=lnt id=hl-229-26><a class=lnlinks href=#hl-229-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>TPTInterrupt</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>current</span><span class=p>.</span><span class=na>isInterrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;料理后事&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;将结果保存&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//打断sleep线程会清除打断标记，所以要添加标记</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>current</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 执行监控操作 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;监控线程&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>调用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-230-1><a class=lnlinks href=#hl-230-1>1</a>
</span><span class=lnt id=hl-230-2><a class=lnlinks href=#hl-230-2>2</a>
</span><span class=lnt id=hl-230-3><a class=lnlinks href=#hl-230-3>3</a>
</span><span class=lnt id=hl-230-4><a class=lnlinks href=#hl-230-4>4</a>
</span><span class=lnt id=hl-230-5><a class=lnlinks href=#hl-230-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TPTInterrupt</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TPTInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>3500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;stop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-231-1><a class=lnlinks href=#hl-231-1>1</a>
</span><span class=lnt id=hl-231-2><a class=lnlinks href=#hl-231-2>2</a>
</span><span class=lnt id=hl-231-3><a class=lnlinks href=#hl-231-3>3</a>
</span><span class=lnt id=hl-231-4><a class=lnlinks href=#hl-231-4>4</a>
</span><span class=lnt id=hl-231-5><a class=lnlinks href=#hl-231-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:49:42.915 c.TwoPhaseTermination <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:49:43.919 c.TwoPhaseTermination <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:49:44.919 c.TwoPhaseTermination <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:49:45.413 c.TestTwoPhaseTermination <span class=o>[</span>main<span class=o>]</span> - stop 
</span></span><span class=line><span class=cl>11:49:45.413 c.TwoPhaseTermination <span class=o>[</span>监控线程<span class=o>]</span> - 料理后事
</span></span></code></pre></td></tr></table></div></div><h5 id=利用volatile修饰的停止标记><a href=#%e5%88%a9%e7%94%a8volatile%e4%bf%ae%e9%a5%b0%e7%9a%84%e5%81%9c%e6%ad%a2%e6%a0%87%e8%ae%b0 class=header-anchor>#</a>
利用volatile修饰的停止标记</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-232-1><a class=lnlinks href=#hl-232-1> 1</a>
</span><span class=lnt id=hl-232-2><a class=lnlinks href=#hl-232-2> 2</a>
</span><span class=lnt id=hl-232-3><a class=lnlinks href=#hl-232-3> 3</a>
</span><span class=lnt id=hl-232-4><a class=lnlinks href=#hl-232-4> 4</a>
</span><span class=lnt id=hl-232-5><a class=lnlinks href=#hl-232-5> 5</a>
</span><span class=lnt id=hl-232-6><a class=lnlinks href=#hl-232-6> 6</a>
</span><span class=lnt id=hl-232-7><a class=lnlinks href=#hl-232-7> 7</a>
</span><span class=lnt id=hl-232-8><a class=lnlinks href=#hl-232-8> 8</a>
</span><span class=lnt id=hl-232-9><a class=lnlinks href=#hl-232-9> 9</a>
</span><span class=lnt id=hl-232-10><a class=lnlinks href=#hl-232-10>10</a>
</span><span class=lnt id=hl-232-11><a class=lnlinks href=#hl-232-11>11</a>
</span><span class=lnt id=hl-232-12><a class=lnlinks href=#hl-232-12>12</a>
</span><span class=lnt id=hl-232-13><a class=lnlinks href=#hl-232-13>13</a>
</span><span class=lnt id=hl-232-14><a class=lnlinks href=#hl-232-14>14</a>
</span><span class=lnt id=hl-232-15><a class=lnlinks href=#hl-232-15>15</a>
</span><span class=lnt id=hl-232-16><a class=lnlinks href=#hl-232-16>16</a>
</span><span class=lnt id=hl-232-17><a class=lnlinks href=#hl-232-17>17</a>
</span><span class=lnt id=hl-232-18><a class=lnlinks href=#hl-232-18>18</a>
</span><span class=lnt id=hl-232-19><a class=lnlinks href=#hl-232-19>19</a>
</span><span class=lnt id=hl-232-20><a class=lnlinks href=#hl-232-20>20</a>
</span><span class=lnt id=hl-232-21><a class=lnlinks href=#hl-232-21>21</a>
</span><span class=lnt id=hl-232-22><a class=lnlinks href=#hl-232-22>22</a>
</span><span class=lnt id=hl-232-23><a class=lnlinks href=#hl-232-23>23</a>
</span><span class=lnt id=hl-232-24><a class=lnlinks href=#hl-232-24>24</a>
</span><span class=lnt id=hl-232-25><a class=lnlinks href=#hl-232-25>25</a>
</span><span class=lnt id=hl-232-26><a class=lnlinks href=#hl-232-26>26</a>
</span><span class=lnt id=hl-232-27><a class=lnlinks href=#hl-232-27>27</a>
</span><span class=lnt id=hl-232-28><a class=lnlinks href=#hl-232-28>28</a>
</span><span class=lnt id=hl-232-29><a class=lnlinks href=#hl-232-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 停止标记用 volatile 是为了保证该变量在多个线程之间的可见性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 我们的例子中，即主线程把它修改为 true 对 t1 线程可见</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>TPTVolatile</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>stop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>stop</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;料理后事&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;将结果保存&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 执行监控操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;监控线程&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//让线程立即停止而不是等待sleep结束</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>调用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-233-1><a class=lnlinks href=#hl-233-1>1</a>
</span><span class=lnt id=hl-233-2><a class=lnlinks href=#hl-233-2>2</a>
</span><span class=lnt id=hl-233-3><a class=lnlinks href=#hl-233-3>3</a>
</span><span class=lnt id=hl-233-4><a class=lnlinks href=#hl-233-4>4</a>
</span><span class=lnt id=hl-233-5><a class=lnlinks href=#hl-233-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TPTVolatile</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TPTVolatile</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>3500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;stop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-234-1><a class=lnlinks href=#hl-234-1>1</a>
</span><span class=lnt id=hl-234-2><a class=lnlinks href=#hl-234-2>2</a>
</span><span class=lnt id=hl-234-3><a class=lnlinks href=#hl-234-3>3</a>
</span><span class=lnt id=hl-234-4><a class=lnlinks href=#hl-234-4>4</a>
</span><span class=lnt id=hl-234-5><a class=lnlinks href=#hl-234-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:54:52.003 c.TPTVolatile <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:54:53.006 c.TPTVolatile <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:54:54.007 c.TPTVolatile <span class=o>[</span>监控线程<span class=o>]</span> - 将结果保存
</span></span><span class=line><span class=cl>11:54:54.502 c.TestTwoPhaseTermination <span class=o>[</span>main<span class=o>]</span> - stop 
</span></span><span class=line><span class=cl>11:54:54.502 c.TPTVolatile <span class=o>[</span>监控线程<span class=o>]</span> - 料理后事
</span></span></code></pre></td></tr></table></div></div><h4 id=font-colororange-模式之-balkingfont><a href=#font-colororange-%e6%a8%a1%e5%bc%8f%e4%b9%8b-balkingfont class=header-anchor>#</a>
<font color=orange>* 模式之 Balking</font></h4><h5 id=1定义-2><a href=#1%e5%ae%9a%e4%b9%89-2 class=header-anchor>#</a>
1.定义</h5><p>Balking （犹豫）模式用在一个线程发现另一个线程或本线程已经做了某一件相同的事，那么本线程就无需再做 了，直接结束返回</p><h5 id=2实现-2><a href=#2%e5%ae%9e%e7%8e%b0-2 class=header-anchor>#</a>
2.实现</h5><p>例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-235-1><a class=lnlinks href=#hl-235-1> 1</a>
</span><span class=lnt id=hl-235-2><a class=lnlinks href=#hl-235-2> 2</a>
</span><span class=lnt id=hl-235-3><a class=lnlinks href=#hl-235-3> 3</a>
</span><span class=lnt id=hl-235-4><a class=lnlinks href=#hl-235-4> 4</a>
</span><span class=lnt id=hl-235-5><a class=lnlinks href=#hl-235-5> 5</a>
</span><span class=lnt id=hl-235-6><a class=lnlinks href=#hl-235-6> 6</a>
</span><span class=lnt id=hl-235-7><a class=lnlinks href=#hl-235-7> 7</a>
</span><span class=lnt id=hl-235-8><a class=lnlinks href=#hl-235-8> 8</a>
</span><span class=lnt id=hl-235-9><a class=lnlinks href=#hl-235-9> 9</a>
</span><span class=lnt id=hl-235-10><a class=lnlinks href=#hl-235-10>10</a>
</span><span class=lnt id=hl-235-11><a class=lnlinks href=#hl-235-11>11</a>
</span><span class=lnt id=hl-235-12><a class=lnlinks href=#hl-235-12>12</a>
</span><span class=lnt id=hl-235-13><a class=lnlinks href=#hl-235-13>13</a>
</span><span class=lnt id=hl-235-14><a class=lnlinks href=#hl-235-14>14</a>
</span><span class=lnt id=hl-235-15><a class=lnlinks href=#hl-235-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MonitorService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 用来表示是否已经有线程已经在执行启动了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>starting</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;尝试启动监控线程...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>starting</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>starting</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//其实synchronized外面还可以再套一层if，或者改为if(!starting)，if框后直接return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 真正启动监控线程...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>当前端页面多次点击按钮调用 start 时</p><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-236-1><a class=lnlinks href=#hl-236-1>1</a>
</span><span class=lnt id=hl-236-2><a class=lnlinks href=#hl-236-2>2</a>
</span><span class=lnt id=hl-236-3><a class=lnlinks href=#hl-236-3>3</a>
</span><span class=lnt id=hl-236-4><a class=lnlinks href=#hl-236-4>4</a>
</span><span class=lnt id=hl-236-5><a class=lnlinks href=#hl-236-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>[</span><span class=n>http</span><span class=o>-</span><span class=n>nio</span><span class=o>-</span><span class=n>8080</span><span class=o>-</span><span class=n>exec</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>monitor</span><span class=p>.</span><span class=na>service</span><span class=p>.</span><span class=na>MonitorService</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>该监控线程已启动</span><span class=o>?</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>http</span><span class=o>-</span><span class=n>nio</span><span class=o>-</span><span class=n>8080</span><span class=o>-</span><span class=n>exec</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>monitor</span><span class=p>.</span><span class=na>service</span><span class=p>.</span><span class=na>MonitorService</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>监控线程已启动</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>http</span><span class=o>-</span><span class=n>nio</span><span class=o>-</span><span class=n>8080</span><span class=o>-</span><span class=n>exec</span><span class=o>-</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>monitor</span><span class=p>.</span><span class=na>service</span><span class=p>.</span><span class=na>MonitorService</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>该监控线程已启动</span><span class=o>?</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>http</span><span class=o>-</span><span class=n>nio</span><span class=o>-</span><span class=n>8080</span><span class=o>-</span><span class=n>exec</span><span class=o>-</span><span class=n>3</span><span class=o>]</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>monitor</span><span class=p>.</span><span class=na>service</span><span class=p>.</span><span class=na>MonitorService</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>该监控线程已启动</span><span class=o>?</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>http</span><span class=o>-</span><span class=n>nio</span><span class=o>-</span><span class=n>8080</span><span class=o>-</span><span class=n>exec</span><span class=o>-</span><span class=n>4</span><span class=o>]</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>monitor</span><span class=p>.</span><span class=na>service</span><span class=p>.</span><span class=na>MonitorService</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>该监控线程已启动</span><span class=o>?</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>它还经常用来实现线程安全的单例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-237-1><a class=lnlinks href=#hl-237-1> 1</a>
</span><span class=lnt id=hl-237-2><a class=lnlinks href=#hl-237-2> 2</a>
</span><span class=lnt id=hl-237-3><a class=lnlinks href=#hl-237-3> 3</a>
</span><span class=lnt id=hl-237-4><a class=lnlinks href=#hl-237-4> 4</a>
</span><span class=lnt id=hl-237-5><a class=lnlinks href=#hl-237-5> 5</a>
</span><span class=lnt id=hl-237-6><a class=lnlinks href=#hl-237-6> 6</a>
</span><span class=lnt id=hl-237-7><a class=lnlinks href=#hl-237-7> 7</a>
</span><span class=lnt id=hl-237-8><a class=lnlinks href=#hl-237-8> 8</a>
</span><span class=lnt id=hl-237-9><a class=lnlinks href=#hl-237-9> 9</a>
</span><span class=lnt id=hl-237-10><a class=lnlinks href=#hl-237-10>10</a>
</span><span class=lnt id=hl-237-11><a class=lnlinks href=#hl-237-11>11</a>
</span><span class=lnt id=hl-237-12><a class=lnlinks href=#hl-237-12>12</a>
</span><span class=lnt id=hl-237-13><a class=lnlinks href=#hl-237-13>13</a>
</span><span class=lnt id=hl-237-14><a class=lnlinks href=#hl-237-14>14</a>
</span><span class=lnt id=hl-237-15><a class=lnlinks href=#hl-237-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>对比一下保护性暂停模式：保护性暂停模式用在一个线程等待另一个线程的执行结果，当条件不满足时线程等待。</p><h2 id=53-有序性><a href=#53-%e6%9c%89%e5%ba%8f%e6%80%a7 class=header-anchor>#</a>
5.3 有序性</h2><p>JVM 会在不影响正确性的前提下，可以调整语句的执行顺序，思考下面一段代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-238-1><a class=lnlinks href=#hl-238-1>1</a>
</span><span class=lnt id=hl-238-2><a class=lnlinks href=#hl-238-2>2</a>
</span><span class=lnt id=hl-238-3><a class=lnlinks href=#hl-238-3>3</a>
</span><span class=lnt id=hl-238-4><a class=lnlinks href=#hl-238-4>4</a>
</span><span class=lnt id=hl-238-5><a class=lnlinks href=#hl-238-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 在某个线程内执行如下赋值操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，至于是先执行 i 还是 先执行 j ，对最终的结果不会产生影响。所以，上面代码真正执行时，既可以是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-239-1><a class=lnlinks href=#hl-239-1>1</a>
</span><span class=lnt id=hl-239-2><a class=lnlinks href=#hl-239-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>也可以是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-240-1><a class=lnlinks href=#hl-240-1>1</a>
</span><span class=lnt id=hl-240-2><a class=lnlinks href=#hl-240-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>这种特性称之为『指令重排』，多线程下『指令重排』会影响正确性。为什么要有重排指令这项优化呢？从 CPU 执行指令的原理来理解一下吧</p><h4 id=font-colorblue-原理之指令级并行font><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b%e6%8c%87%e4%bb%a4%e7%ba%a7%e5%b9%b6%e8%a1%8cfont class=header-anchor>#</a>
<font color=blue>* 原理之指令级并行</font></h4><h5 id=名词><a href=#%e5%90%8d%e8%af%8d class=header-anchor>#</a>
名词</h5><p><strong>Clock Cycle Time</strong></p><p>主频的概念大家接触的比较多，而 CPU 的 Clock Cycle Time（时钟周期时间），等于主频的倒数，意思是 CPU 能 够识别的最小时间单位，比如说 4G 主频的 CPU 的 Clock Cycle Time 就是 0.25 ns，作为对比，我们墙上挂钟的 Cycle Time 是 1s</p><p>例如，运行一条加法指令一般需要一个时钟周期时间</p><p><strong>CPI</strong></p><p>有的指令需要更多的时钟周期时间，所以引出了 CPI （Cycles Per Instruction）指令平均时钟周期数</p><p><strong>IPC</strong></p><p>IPC（Instruction Per Clock Cycle） 即 CPI 的倒数，表示每个时钟周期能够运行的指令数</p><p><strong>CPU 执行时间</strong></p><p>程序的 CPU 执行时间，即我们前面提到的 user + system 时间，可以用下面的公式来表示</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-241-1><a class=lnlinks href=#hl-241-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>程序</span><span class=w> </span><span class=n>CPU</span><span class=w> </span><span class=n>执行时间</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>指令数</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>CPI</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>Clock</span><span class=w> </span><span class=n>Cycle</span><span class=w> </span><span class=n>Time</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=指令重排序优化><a href=#%e6%8c%87%e4%bb%a4%e9%87%8d%e6%8e%92%e5%ba%8f%e4%bc%98%e5%8c%96 class=header-anchor>#</a>
指令重排序优化</h5><p>事实上，现代处理器会设计为一个时钟周期完成一条执行时间最长的 CPU 指令。为什么这么做呢？可以想到指令 还可以再划分成一个个更小的阶段，例如，每条指令都可以分为： <code>取指令 - 指令译码 - 执行指令 - 内存访问 - 数据写回</code> 这 5 个阶段</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306122605032.png width=900 height=600 loading=lazy decoding=async alt=image-20220306122605032 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><blockquote><p><strong>术语参考</strong>：</p><ul><li>instruction fetch (IF)</li><li>instruction decode (ID)</li><li>execute (EX)</li><li>memory access (MEM)</li><li>register write back (WB)</li></ul></blockquote><p>在不改变程序结果的前提下，这些指令的各个阶段可以通过<strong>重排序</strong>和<strong>组合</strong>来实现指令级并行，这一技术在 80&rsquo;s 中 叶到 90&rsquo;s 中叶占据了计算架构的重要地位。</p><blockquote><p><strong>提示</strong>：</p><p>分阶段，分工是提升效率的关键！</p></blockquote><p>指令重排的前提是，重排指令不能影响结果，例如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-242-1><a class=lnlinks href=#hl-242-1>1</a>
</span><span class=lnt id=hl-242-2><a class=lnlinks href=#hl-242-2>2</a>
</span><span class=lnt id=hl-242-3><a class=lnlinks href=#hl-242-3>3</a>
</span><span class=lnt id=hl-242-4><a class=lnlinks href=#hl-242-4>4</a>
</span><span class=lnt id=hl-242-5><a class=lnlinks href=#hl-242-5>5</a>
</span><span class=lnt id=hl-242-6><a class=lnlinks href=#hl-242-6>6</a>
</span><span class=lnt id=hl-242-7><a class=lnlinks href=#hl-242-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 可以重排的例子</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=c1>// 指令1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w> </span><span class=c1>// 指令2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 不能重排的例子</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=c1>// 指令1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=c1>// 指令2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>参考</strong>：</p><p><a class=link href=https://en.wikipedia.org/wiki/Scoreboarding target=_blank rel=noopener>Scoreboarding
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>and the <a class=link href=https://en.wikipedia.org/wiki/Tomasulo_algorithm target=_blank rel=noopener>Tomasulo algorithm
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>(which is similar to scoreboarding but makes use of <a class=link href=https://en.wikipedia.org/wiki/Register_renaming target=_blank rel=noopener>register renaming
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>)are two of the most common techniques for implementing out-of-order execution and instruction-level parallelism.</p></blockquote><h5 id=支持流水线的处理器><a href=#%e6%94%af%e6%8c%81%e6%b5%81%e6%b0%b4%e7%ba%bf%e7%9a%84%e5%a4%84%e7%90%86%e5%99%a8 class=header-anchor>#</a>
支持流水线的处理器</h5><p>现代 CPU 支持<strong>多级指令流水线</strong>，例如支持同时执行 <code>取指令 - 指令译码 - 执行指令 - 内存访问 - 数据写回</code> 的处理 器，就可以称之为<strong>五级指令流水线</strong>。这时 CPU 可以在一个时钟周期内，同时运行五条指令的不同阶段（相当于一 条执行时间最长的复杂指令），IPC = 1，本质上，流水线技术并不能缩短单条指令的执行时间，但它变相地提高了 指令地吞吐率。</p><blockquote><p><strong>提示</strong>：</p><p>奔腾四（Pentium 4）支持高达 35 级流水线，但由于功耗太高被废弃</p></blockquote><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306123819512.png width=900 height=600 loading=lazy decoding=async alt=image-20220306123819512 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=superscalar-处理器><a href=#superscalar-%e5%a4%84%e7%90%86%e5%99%a8 class=header-anchor>#</a>
SuperScalar 处理器</h5><p>大多数处理器包含多个执行单元，并不是所有计算功能都集中在一起，可以再细分为整数运算单元、浮点数运算单 元等，这样可以把多条指令也可以做到并行获取、译码等，CPU 可以在一个时钟周期内，执行多于一条指令，IPC > 1</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306123933327.png width=900 height=600 loading=lazy decoding=async alt=image-20220306123933327 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=诡异的结果><a href=#%e8%af%a1%e5%bc%82%e7%9a%84%e7%bb%93%e6%9e%9c class=header-anchor>#</a>
诡异的结果</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-243-1><a class=lnlinks href=#hl-243-1> 1</a>
</span><span class=lnt id=hl-243-2><a class=lnlinks href=#hl-243-2> 2</a>
</span><span class=lnt id=hl-243-3><a class=lnlinks href=#hl-243-3> 3</a>
</span><span class=lnt id=hl-243-4><a class=lnlinks href=#hl-243-4> 4</a>
</span><span class=lnt id=hl-243-5><a class=lnlinks href=#hl-243-5> 5</a>
</span><span class=lnt id=hl-243-6><a class=lnlinks href=#hl-243-6> 6</a>
</span><span class=lnt id=hl-243-7><a class=lnlinks href=#hl-243-7> 7</a>
</span><span class=lnt id=hl-243-8><a class=lnlinks href=#hl-243-8> 8</a>
</span><span class=lnt id=hl-243-9><a class=lnlinks href=#hl-243-9> 9</a>
</span><span class=lnt id=hl-243-10><a class=lnlinks href=#hl-243-10>10</a>
</span><span class=lnt id=hl-243-11><a class=lnlinks href=#hl-243-11>11</a>
</span><span class=lnt id=hl-243-12><a class=lnlinks href=#hl-243-12>12</a>
</span><span class=lnt id=hl-243-13><a class=lnlinks href=#hl-243-13>13</a>
</span><span class=lnt id=hl-243-14><a class=lnlinks href=#hl-243-14>14</a>
</span><span class=lnt id=hl-243-15><a class=lnlinks href=#hl-243-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 线程1 执行此方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor1</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ready</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 线程2 执行此方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor2</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>I_Result 是一个对象，有一个属性 r1 用来保存结果，问，可能的结果有几种？</p><p>有同学这么分析</p><p>情况1：线程1 先执行，这时 ready = false，所以进入 else 分支结果为 1</p><p>情况2：线程2 先执行 num = 2，但没来得及执行 ready = true，线程1 执行，还是进入 else 分支，结果为1</p><p>情况3：线程2 执行到 ready = true，线程1 执行，这回进入 if 分支，结果为 4（因为 num 已经执行过了）</p><p>但我告诉你，结果还有可能是 0 😁😁😁，信不信吧！</p><p>这种情况下是：线程2 执行 ready = true，切换到线程1，进入 if 分支，相加为 0，再切回线程2 执行 num = 2</p><p>相信很多人已经晕了 😵😵😵</p><p>这种现象叫做指令重排，是 JIT 编译器在运行时的一些优化，这个现象需要通过大量测试才能复现：</p><p>借助 java 并发压测工具 jcstress <a class=link href=https://wiki.openjdk.java.net/display/CodeTools/jcstress target=_blank rel=noopener>https://wiki.openjdk.java.net/display/CodeTools/jcstress
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-244-1><a class=lnlinks href=#hl-244-1>1</a>
</span><span class=lnt id=hl-244-2><a class=lnlinks href=#hl-244-2>2</a>
</span><span class=lnt id=hl-244-3><a class=lnlinks href=#hl-244-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mvn archetype:generate -DinteractiveMode<span class=o>=</span><span class=nb>false</span> -DarchetypeGroupId<span class=o>=</span>org.openjdk.jcstress -
</span></span><span class=line><span class=cl><span class=nv>DarchetypeArtifactId</span><span class=o>=</span>jcstress-java-test-archetype -DarchetypeVersion<span class=o>=</span>0.5 -DgroupId<span class=o>=</span>cn.itcast -
</span></span><span class=line><span class=cl><span class=nv>DartifactId</span><span class=o>=</span>ordering -Dversion<span class=o>=</span>1.0 
</span></span></code></pre></td></tr></table></div></div><p>创建 maven 项目，提供如下测试类</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-245-1><a class=lnlinks href=#hl-245-1> 1</a>
</span><span class=lnt id=hl-245-2><a class=lnlinks href=#hl-245-2> 2</a>
</span><span class=lnt id=hl-245-3><a class=lnlinks href=#hl-245-3> 3</a>
</span><span class=lnt id=hl-245-4><a class=lnlinks href=#hl-245-4> 4</a>
</span><span class=lnt id=hl-245-5><a class=lnlinks href=#hl-245-5> 5</a>
</span><span class=lnt id=hl-245-6><a class=lnlinks href=#hl-245-6> 6</a>
</span><span class=lnt id=hl-245-7><a class=lnlinks href=#hl-245-7> 7</a>
</span><span class=lnt id=hl-245-8><a class=lnlinks href=#hl-245-8> 8</a>
</span><span class=lnt id=hl-245-9><a class=lnlinks href=#hl-245-9> 9</a>
</span><span class=lnt id=hl-245-10><a class=lnlinks href=#hl-245-10>10</a>
</span><span class=lnt id=hl-245-11><a class=lnlinks href=#hl-245-11>11</a>
</span><span class=lnt id=hl-245-12><a class=lnlinks href=#hl-245-12>12</a>
</span><span class=lnt id=hl-245-13><a class=lnlinks href=#hl-245-13>13</a>
</span><span class=lnt id=hl-245-14><a class=lnlinks href=#hl-245-14>14</a>
</span><span class=lnt id=hl-245-15><a class=lnlinks href=#hl-245-15>15</a>
</span><span class=lnt id=hl-245-16><a class=lnlinks href=#hl-245-16>16</a>
</span><span class=lnt id=hl-245-17><a class=lnlinks href=#hl-245-17>17</a>
</span><span class=lnt id=hl-245-18><a class=lnlinks href=#hl-245-18>18</a>
</span><span class=lnt id=hl-245-19><a class=lnlinks href=#hl-245-19>19</a>
</span><span class=lnt id=hl-245-20><a class=lnlinks href=#hl-245-20>20</a>
</span><span class=lnt id=hl-245-21><a class=lnlinks href=#hl-245-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@JCStressTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Outcome</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;4&#34;</span><span class=p>},</span><span class=w> </span><span class=n>expect</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Expect</span><span class=p>.</span><span class=na>ACCEPTABLE</span><span class=p>,</span><span class=w> </span><span class=n>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ok&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Outcome</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;0&#34;</span><span class=p>,</span><span class=w> </span><span class=n>expect</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Expect</span><span class=p>.</span><span class=na>ACCEPTABLE_INTERESTING</span><span class=p>,</span><span class=w> </span><span class=n>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;!!!!&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@State</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ConcurrencyTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Actor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor1</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>ready</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Actor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor2</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-246-1><a class=lnlinks href=#hl-246-1>1</a>
</span><span class=lnt id=hl-246-2><a class=lnlinks href=#hl-246-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mvn clean install 
</span></span><span class=line><span class=cl>java -jar target/jcstress.jar 
</span></span></code></pre></td></tr></table></div></div><p>会输出我们感兴趣的结果，摘录其中一次结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-247-1><a class=lnlinks href=#hl-247-1> 1</a>
</span><span class=lnt id=hl-247-2><a class=lnlinks href=#hl-247-2> 2</a>
</span><span class=lnt id=hl-247-3><a class=lnlinks href=#hl-247-3> 3</a>
</span><span class=lnt id=hl-247-4><a class=lnlinks href=#hl-247-4> 4</a>
</span><span class=lnt id=hl-247-5><a class=lnlinks href=#hl-247-5> 5</a>
</span><span class=lnt id=hl-247-6><a class=lnlinks href=#hl-247-6> 6</a>
</span><span class=lnt id=hl-247-7><a class=lnlinks href=#hl-247-7> 7</a>
</span><span class=lnt id=hl-247-8><a class=lnlinks href=#hl-247-8> 8</a>
</span><span class=lnt id=hl-247-9><a class=lnlinks href=#hl-247-9> 9</a>
</span><span class=lnt id=hl-247-10><a class=lnlinks href=#hl-247-10>10</a>
</span><span class=lnt id=hl-247-11><a class=lnlinks href=#hl-247-11>11</a>
</span><span class=lnt id=hl-247-12><a class=lnlinks href=#hl-247-12>12</a>
</span><span class=lnt id=hl-247-13><a class=lnlinks href=#hl-247-13>13</a>
</span><span class=lnt id=hl-247-14><a class=lnlinks href=#hl-247-14>14</a>
</span><span class=lnt id=hl-247-15><a class=lnlinks href=#hl-247-15>15</a>
</span><span class=lnt id=hl-247-16><a class=lnlinks href=#hl-247-16>16</a>
</span><span class=lnt id=hl-247-17><a class=lnlinks href=#hl-247-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>*** INTERESTING tests 
</span></span><span class=line><span class=cl> Some interesting behaviors observed. This is <span class=k>for</span> the plain curiosity. 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=m>2</span> matching <span class=nb>test</span> results. 
</span></span><span class=line><span class=cl> 	<span class=o>[</span>OK<span class=o>]</span> test.ConcurrencyTest 
</span></span><span class=line><span class=cl> 	<span class=o>(</span>JVM args: <span class=o>[</span>-XX:-TieredCompilation<span class=o>])</span> 
</span></span><span class=line><span class=cl>    Observed state 	Occurrences 	Expectation Interpretation 
</span></span><span class=line><span class=cl>    <span class=m>0</span> 				1,729 			ACCEPTABLE_INTERESTING !!!! 
</span></span><span class=line><span class=cl> 	<span class=m>1</span> 				42,617,915 		ACCEPTABLE ok 
</span></span><span class=line><span class=cl> 	<span class=m>4</span> 				5,146,627 		ACCEPTABLE ok 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 	<span class=o>[</span>OK<span class=o>]</span> test.ConcurrencyTest 
</span></span><span class=line><span class=cl> 	<span class=o>(</span>JVM args: <span class=o>[])</span> 
</span></span><span class=line><span class=cl> 	Observed state 	Occurrences 	Expectation Interpretation 
</span></span><span class=line><span class=cl> 	<span class=m>0</span> 				1,652 			ACCEPTABLE_INTERESTING !!!! 
</span></span><span class=line><span class=cl> 	<span class=m>1</span> 				46,460,657 		ACCEPTABLE ok 
</span></span><span class=line><span class=cl> 	<span class=m>4</span> 				4,571,072 		ACCEPTABLE ok 
</span></span></code></pre></td></tr></table></div></div><p>可以看到，出现结果为 0 的情况有 638 次，虽然次数相对很少，但毕竟是出现了。</p><h4 id=解决方法-1><a href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-1 class=header-anchor>#</a>
解决方法</h4><p>volatile 修饰的变量，可以禁用指令重排</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-248-1><a class=lnlinks href=#hl-248-1> 1</a>
</span><span class=lnt id=hl-248-2><a class=lnlinks href=#hl-248-2> 2</a>
</span><span class=lnt id=hl-248-3><a class=lnlinks href=#hl-248-3> 3</a>
</span><span class=lnt id=hl-248-4><a class=lnlinks href=#hl-248-4> 4</a>
</span><span class=lnt id=hl-248-5><a class=lnlinks href=#hl-248-5> 5</a>
</span><span class=lnt id=hl-248-6><a class=lnlinks href=#hl-248-6> 6</a>
</span><span class=lnt id=hl-248-7><a class=lnlinks href=#hl-248-7> 7</a>
</span><span class=lnt id=hl-248-8><a class=lnlinks href=#hl-248-8> 8</a>
</span><span class=lnt id=hl-248-9><a class=lnlinks href=#hl-248-9> 9</a>
</span><span class=lnt id=hl-248-10><a class=lnlinks href=#hl-248-10>10</a>
</span><span class=lnt id=hl-248-11><a class=lnlinks href=#hl-248-11>11</a>
</span><span class=lnt id=hl-248-12><a class=lnlinks href=#hl-248-12>12</a>
</span><span class=lnt id=hl-248-13><a class=lnlinks href=#hl-248-13>13</a>
</span><span class=lnt id=hl-248-14><a class=lnlinks href=#hl-248-14>14</a>
</span><span class=lnt id=hl-248-15><a class=lnlinks href=#hl-248-15>15</a>
</span><span class=lnt id=hl-248-16><a class=lnlinks href=#hl-248-16>16</a>
</span><span class=lnt id=hl-248-17><a class=lnlinks href=#hl-248-17>17</a>
</span><span class=lnt id=hl-248-18><a class=lnlinks href=#hl-248-18>18</a>
</span><span class=lnt id=hl-248-19><a class=lnlinks href=#hl-248-19>19</a>
</span><span class=lnt id=hl-248-20><a class=lnlinks href=#hl-248-20>20</a>
</span><span class=lnt id=hl-248-21><a class=lnlinks href=#hl-248-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@JCStressTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Outcome</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;4&#34;</span><span class=p>},</span><span class=w> </span><span class=n>expect</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Expect</span><span class=p>.</span><span class=na>ACCEPTABLE</span><span class=p>,</span><span class=w> </span><span class=n>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ok&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Outcome</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;0&#34;</span><span class=p>,</span><span class=w> </span><span class=n>expect</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Expect</span><span class=p>.</span><span class=na>ACCEPTABLE_INTERESTING</span><span class=p>,</span><span class=w> </span><span class=n>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;!!!!&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@State</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ConcurrencyTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Actor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor1</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>ready</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Actor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor2</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-249-1><a class=lnlinks href=#hl-249-1>1</a>
</span><span class=lnt id=hl-249-2><a class=lnlinks href=#hl-249-2>2</a>
</span><span class=lnt id=hl-249-3><a class=lnlinks href=#hl-249-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>*** INTERESTING tests 
</span></span><span class=line><span class=cl> Some interesting behaviors observed. This is <span class=k>for</span> the plain curiosity. 
</span></span><span class=line><span class=cl> <span class=m>0</span> matching <span class=nb>test</span> results. 
</span></span></code></pre></td></tr></table></div></div><h4 id=font-colorblue-原理之-volatilefont><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-volatilefont class=header-anchor>#</a>
<font color=blue>* 原理之 volatile</font></h4><p>volatile 的底层实现原理是内存屏障，Memory Barrier（Memory Fence）</p><ul><li>对 volatile 变量的写指令后会加入写屏障</li><li>对 volatile 变量的读指令前会加入读屏障</li></ul><h5 id=如何保证可见性><a href=#%e5%a6%82%e4%bd%95%e4%bf%9d%e8%af%81%e5%8f%af%e8%a7%81%e6%80%a7 class=header-anchor>#</a>
如何保证可见性</h5><ul><li><p>写屏障（sfence）保证在该屏障之前的，对共享变量的改动，都同步到主存当中</p></li><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-250-1><a class=lnlinks href=#hl-250-1>1</a>
</span><span class=lnt id=hl-250-2><a class=lnlinks href=#hl-250-2>2</a>
</span><span class=lnt id=hl-250-3><a class=lnlinks href=#hl-250-3>3</a>
</span><span class=lnt id=hl-250-4><a class=lnlinks href=#hl-250-4>4</a>
</span><span class=lnt id=hl-250-5><a class=lnlinks href=#hl-250-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor2</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=c1>// ready 是 volatile 赋值带写屏障</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 写屏障</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>而读屏障（lfence）保证在该屏障之后，对共享变量的读取，加载的是主存中最新数据</p></li><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-251-1><a class=lnlinks href=#hl-251-1>1</a>
</span><span class=lnt id=hl-251-2><a class=lnlinks href=#hl-251-2>2</a>
</span><span class=lnt id=hl-251-3><a class=lnlinks href=#hl-251-3>3</a>
</span><span class=lnt id=hl-251-4><a class=lnlinks href=#hl-251-4>4</a>
</span><span class=lnt id=hl-251-5><a class=lnlinks href=#hl-251-5>5</a>
</span><span class=lnt id=hl-251-6><a class=lnlinks href=#hl-251-6>6</a>
</span><span class=lnt id=hl-251-7><a class=lnlinks href=#hl-251-7>7</a>
</span><span class=lnt id=hl-251-8><a class=lnlinks href=#hl-251-8>8</a>
</span><span class=lnt id=hl-251-9><a class=lnlinks href=#hl-251-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor1</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 读屏障</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ready 是 volatile 读取值带读屏障</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ready</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306125622336.png width=900 height=600 loading=lazy decoding=async alt=image-20220306125622336 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li></ul><h5 id=如何保证有序性><a href=#%e5%a6%82%e4%bd%95%e4%bf%9d%e8%af%81%e6%9c%89%e5%ba%8f%e6%80%a7 class=header-anchor>#</a>
如何保证有序性</h5><ul><li><p>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</p></li><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-252-1><a class=lnlinks href=#hl-252-1>1</a>
</span><span class=lnt id=hl-252-2><a class=lnlinks href=#hl-252-2>2</a>
</span><span class=lnt id=hl-252-3><a class=lnlinks href=#hl-252-3>3</a>
</span><span class=lnt id=hl-252-4><a class=lnlinks href=#hl-252-4>4</a>
</span><span class=lnt id=hl-252-5><a class=lnlinks href=#hl-252-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor2</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=c1>// ready 是 volatile 赋值带写屏障</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 写屏障</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</p></li><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-253-1><a class=lnlinks href=#hl-253-1>1</a>
</span><span class=lnt id=hl-253-2><a class=lnlinks href=#hl-253-2>2</a>
</span><span class=lnt id=hl-253-3><a class=lnlinks href=#hl-253-3>3</a>
</span><span class=lnt id=hl-253-4><a class=lnlinks href=#hl-253-4>4</a>
</span><span class=lnt id=hl-253-5><a class=lnlinks href=#hl-253-5>5</a>
</span><span class=lnt id=hl-253-6><a class=lnlinks href=#hl-253-6>6</a>
</span><span class=lnt id=hl-253-7><a class=lnlinks href=#hl-253-7>7</a>
</span><span class=lnt id=hl-253-8><a class=lnlinks href=#hl-253-8>8</a>
</span><span class=lnt id=hl-253-9><a class=lnlinks href=#hl-253-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor1</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 读屏障</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ready 是 volatile 读取值带读屏障</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ready</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306130348150.png width=900 height=600 loading=lazy decoding=async alt=image-20220306130348150 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li></ul><p>还是那句话，不能解决指令交错：</p><ul><li>写屏障仅仅是保证之后的读能够读到最新的结果，但不能保证读跑到它前面去</li><li>而有序性的保证也只是保证了本线程内相关代码不被重排序</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306130731767.png width=900 height=600 loading=lazy decoding=async alt=image-20220306130731767 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=double-checked-locking-问题><a href=#double-checked-locking-%e9%97%ae%e9%a2%98 class=header-anchor>#</a>
double-checked locking 问题</h5><p>以著名的 double-checked locking 单例模式为例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-254-1><a class=lnlinks href=#hl-254-1> 1</a>
</span><span class=lnt id=hl-254-2><a class=lnlinks href=#hl-254-2> 2</a>
</span><span class=lnt id=hl-254-3><a class=lnlinks href=#hl-254-3> 3</a>
</span><span class=lnt id=hl-254-4><a class=lnlinks href=#hl-254-4> 4</a>
</span><span class=lnt id=hl-254-5><a class=lnlinks href=#hl-254-5> 5</a>
</span><span class=lnt id=hl-254-6><a class=lnlinks href=#hl-254-6> 6</a>
</span><span class=lnt id=hl-254-7><a class=lnlinks href=#hl-254-7> 7</a>
</span><span class=lnt id=hl-254-8><a class=lnlinks href=#hl-254-8> 8</a>
</span><span class=lnt id=hl-254-9><a class=lnlinks href=#hl-254-9> 9</a>
</span><span class=lnt id=hl-254-10><a class=lnlinks href=#hl-254-10>10</a>
</span><span class=lnt id=hl-254-11><a class=lnlinks href=#hl-254-11>11</a>
</span><span class=lnt id=hl-254-12><a class=lnlinks href=#hl-254-12>12</a>
</span><span class=lnt id=hl-254-13><a class=lnlinks href=#hl-254-13>13</a>
</span><span class=lnt id=hl-254-14><a class=lnlinks href=#hl-254-14>14</a>
</span><span class=lnt id=hl-254-15><a class=lnlinks href=#hl-254-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// t2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 首次访问会同步，而之后的使用没有 synchronized</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>Singleton</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>以上的实现特点是：</p><ul><li>懒惰实例化</li><li>首次使用 getInstance() 才使用 synchronized 加锁，后续使用时无需加锁</li><li>有隐含的，但很关键的一点：第一个 if 使用了 INSTANCE 变量，是在同步块之外</li></ul><p>但在多线程环境下，上面的代码是有问题的，getInstance 方法对应的字节码为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-255-1><a class=lnlinks href=#hl-255-1> 1</a>
</span><span class=lnt id=hl-255-2><a class=lnlinks href=#hl-255-2> 2</a>
</span><span class=lnt id=hl-255-3><a class=lnlinks href=#hl-255-3> 3</a>
</span><span class=lnt id=hl-255-4><a class=lnlinks href=#hl-255-4> 4</a>
</span><span class=lnt id=hl-255-5><a class=lnlinks href=#hl-255-5> 5</a>
</span><span class=lnt id=hl-255-6><a class=lnlinks href=#hl-255-6> 6</a>
</span><span class=lnt id=hl-255-7><a class=lnlinks href=#hl-255-7> 7</a>
</span><span class=lnt id=hl-255-8><a class=lnlinks href=#hl-255-8> 8</a>
</span><span class=lnt id=hl-255-9><a class=lnlinks href=#hl-255-9> 9</a>
</span><span class=lnt id=hl-255-10><a class=lnlinks href=#hl-255-10>10</a>
</span><span class=lnt id=hl-255-11><a class=lnlinks href=#hl-255-11>11</a>
</span><span class=lnt id=hl-255-12><a class=lnlinks href=#hl-255-12>12</a>
</span><span class=lnt id=hl-255-13><a class=lnlinks href=#hl-255-13>13</a>
</span><span class=lnt id=hl-255-14><a class=lnlinks href=#hl-255-14>14</a>
</span><span class=lnt id=hl-255-15><a class=lnlinks href=#hl-255-15>15</a>
</span><span class=lnt id=hl-255-16><a class=lnlinks href=#hl-255-16>16</a>
</span><span class=lnt id=hl-255-17><a class=lnlinks href=#hl-255-17>17</a>
</span><span class=lnt id=hl-255-18><a class=lnlinks href=#hl-255-18>18</a>
</span><span class=lnt id=hl-255-19><a class=lnlinks href=#hl-255-19>19</a>
</span><span class=lnt id=hl-255-20><a class=lnlinks href=#hl-255-20>20</a>
</span><span class=lnt id=hl-255-21><a class=lnlinks href=#hl-255-21>21</a>
</span><span class=lnt id=hl-255-22><a class=lnlinks href=#hl-255-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>0: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>3: ifnonnull <span class=m>37</span>
</span></span><span class=line><span class=cl>6: ldc <span class=c1>#3 // class cn/itcast/n5/Singleton</span>
</span></span><span class=line><span class=cl>8: dup
</span></span><span class=line><span class=cl>9: astore_0
</span></span><span class=line><span class=cl>10: monitorenter
</span></span><span class=line><span class=cl>11: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>14: ifnonnull <span class=m>27</span>
</span></span><span class=line><span class=cl>17: new <span class=c1>#3 // class cn/itcast/n5/Singleton</span>
</span></span><span class=line><span class=cl>20: dup
</span></span><span class=line><span class=cl>21: invokespecial <span class=c1>#4 // Method &#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class=line><span class=cl>24: putstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>27: aload_0
</span></span><span class=line><span class=cl>28: monitorexit
</span></span><span class=line><span class=cl>29: goto <span class=m>37</span>
</span></span><span class=line><span class=cl>32: astore_1
</span></span><span class=line><span class=cl>33: aload_0
</span></span><span class=line><span class=cl>34: monitorexit
</span></span><span class=line><span class=cl>35: aload_1
</span></span><span class=line><span class=cl>36: athrow
</span></span><span class=line><span class=cl>37: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>40: areturn
</span></span></code></pre></td></tr></table></div></div><p>其中</p><ul><li>17 表示创建对象，将对象引用入栈 // new Singleton</li><li>20 表示复制一份对象引用 // 引用地址</li><li>21 表示利用一个对象引用，调用构造方法</li><li>24 表示利用一个对象引用，赋值给 static INSTANCE</li></ul><p>也许 jvm 会优化为：先执行 24，再执行 21。如果两个线程 t1，t2 按如下时间序列执行：</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220307202619811.png width=900 height=600 loading=lazy decoding=async alt=image-20220307202619811 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>关键在于 0: getstatic 这行代码在 monitor 控制之外，它就像之前举例中不守规则的人，可以越过 monitor 读取 INSTANCE 变量的值</p><p>这时 t1 还未完全将构造方法执行完毕，如果在构造方法中要执行很多初始化操作，那么 t2 拿到的是将是一个未初 始化完毕的单例</p><p>对 INSTANCE 使用 volatile 修饰即可，可以禁用指令重排，但要注意在 JDK 5 以上的版本的 volatile 才会真正有效</p><h5 id=double-checked-locking-解决><a href=#double-checked-locking-%e8%a7%a3%e5%86%b3 class=header-anchor>#</a>
double-checked locking 解决</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-256-1><a class=lnlinks href=#hl-256-1> 1</a>
</span><span class=lnt id=hl-256-2><a class=lnlinks href=#hl-256-2> 2</a>
</span><span class=lnt id=hl-256-3><a class=lnlinks href=#hl-256-3> 3</a>
</span><span class=lnt id=hl-256-4><a class=lnlinks href=#hl-256-4> 4</a>
</span><span class=lnt id=hl-256-5><a class=lnlinks href=#hl-256-5> 5</a>
</span><span class=lnt id=hl-256-6><a class=lnlinks href=#hl-256-6> 6</a>
</span><span class=lnt id=hl-256-7><a class=lnlinks href=#hl-256-7> 7</a>
</span><span class=lnt id=hl-256-8><a class=lnlinks href=#hl-256-8> 8</a>
</span><span class=lnt id=hl-256-9><a class=lnlinks href=#hl-256-9> 9</a>
</span><span class=lnt id=hl-256-10><a class=lnlinks href=#hl-256-10>10</a>
</span><span class=lnt id=hl-256-11><a class=lnlinks href=#hl-256-11>11</a>
</span><span class=lnt id=hl-256-12><a class=lnlinks href=#hl-256-12>12</a>
</span><span class=lnt id=hl-256-13><a class=lnlinks href=#hl-256-13>13</a>
</span><span class=lnt id=hl-256-14><a class=lnlinks href=#hl-256-14>14</a>
</span><span class=lnt id=hl-256-15><a class=lnlinks href=#hl-256-15>15</a>
</span><span class=lnt id=hl-256-16><a class=lnlinks href=#hl-256-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 实例没创建，才会进入内部的 synchronized代码块</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>Singleton</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// t2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 也许有其它线程已经创建实例，所以再判断一次</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>字节码上看不出来 volatile 指令的效果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-257-1><a class=lnlinks href=#hl-257-1> 1</a>
</span><span class=lnt id=hl-257-2><a class=lnlinks href=#hl-257-2> 2</a>
</span><span class=lnt id=hl-257-3><a class=lnlinks href=#hl-257-3> 3</a>
</span><span class=lnt id=hl-257-4><a class=lnlinks href=#hl-257-4> 4</a>
</span><span class=lnt id=hl-257-5><a class=lnlinks href=#hl-257-5> 5</a>
</span><span class=lnt id=hl-257-6><a class=lnlinks href=#hl-257-6> 6</a>
</span><span class=lnt id=hl-257-7><a class=lnlinks href=#hl-257-7> 7</a>
</span><span class=lnt id=hl-257-8><a class=lnlinks href=#hl-257-8> 8</a>
</span><span class=lnt id=hl-257-9><a class=lnlinks href=#hl-257-9> 9</a>
</span><span class=lnt id=hl-257-10><a class=lnlinks href=#hl-257-10>10</a>
</span><span class=lnt id=hl-257-11><a class=lnlinks href=#hl-257-11>11</a>
</span><span class=lnt id=hl-257-12><a class=lnlinks href=#hl-257-12>12</a>
</span><span class=lnt id=hl-257-13><a class=lnlinks href=#hl-257-13>13</a>
</span><span class=lnt id=hl-257-14><a class=lnlinks href=#hl-257-14>14</a>
</span><span class=lnt id=hl-257-15><a class=lnlinks href=#hl-257-15>15</a>
</span><span class=lnt id=hl-257-16><a class=lnlinks href=#hl-257-16>16</a>
</span><span class=lnt id=hl-257-17><a class=lnlinks href=#hl-257-17>17</a>
</span><span class=lnt id=hl-257-18><a class=lnlinks href=#hl-257-18>18</a>
</span><span class=lnt id=hl-257-19><a class=lnlinks href=#hl-257-19>19</a>
</span><span class=lnt id=hl-257-20><a class=lnlinks href=#hl-257-20>20</a>
</span><span class=lnt id=hl-257-21><a class=lnlinks href=#hl-257-21>21</a>
</span><span class=lnt id=hl-257-22><a class=lnlinks href=#hl-257-22>22</a>
</span><span class=lnt id=hl-257-23><a class=lnlinks href=#hl-257-23>23</a>
</span><span class=lnt id=hl-257-24><a class=lnlinks href=#hl-257-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>// -------------------------------------&gt; 加入对 INSTANCE 变量的读屏障
</span></span><span class=line><span class=cl>0: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>3: ifnonnull <span class=m>37</span>
</span></span><span class=line><span class=cl>6: ldc <span class=c1>#3 // class cn/itcast/n5/Singleton</span>
</span></span><span class=line><span class=cl>8: dup
</span></span><span class=line><span class=cl>9: astore_0
</span></span><span class=line><span class=cl>10: monitorenter -----------------------&gt; 保证原子性、可见性
</span></span><span class=line><span class=cl>11: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>14: ifnonnull <span class=m>27</span>
</span></span><span class=line><span class=cl>17: new <span class=c1>#3 // class cn/itcast/n5/Singleton</span>
</span></span><span class=line><span class=cl>20: dup
</span></span><span class=line><span class=cl>21: invokespecial <span class=c1>#4 // Method &#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class=line><span class=cl>24: putstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>// -------------------------------------&gt; 加入对 INSTANCE 变量的写屏障
</span></span><span class=line><span class=cl>27: aload_0
</span></span><span class=line><span class=cl>28: monitorexit ------------------------&gt; 保证原子性、可见性
</span></span><span class=line><span class=cl>29: goto <span class=m>37</span>
</span></span><span class=line><span class=cl>32: astore_1
</span></span><span class=line><span class=cl>33: aload_0
</span></span><span class=line><span class=cl>34: monitorexit
</span></span><span class=line><span class=cl>35: aload_1
</span></span><span class=line><span class=cl>36: athrow
</span></span><span class=line><span class=cl>37: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>40: areturn
</span></span></code></pre></td></tr></table></div></div><p>如上面的注释内容所示，读写 volatile 变量时会加入内存屏障（Memory Barrier（Memory Fence）），保证下面 两点：</p><ul><li>可见性<ul><li>写屏障（sfence）保证在该屏障之前的 t1 对共享变量的改动，都同步到主存当中</li><li>而读屏障（lfence）保证在该屏障之后 t2 对共享变量的读取，加载的是主存中最新数据</li></ul></li><li>有序性<ul><li>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</li><li>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</li></ul></li><li>更底层是读写变量时使用 lock 指令来多核 CPU 之间的可见性与有序性</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220307204740517.png width=900 height=600 loading=lazy decoding=async alt=image-20220307204740517 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=happens-before><a href=#happens-before class=header-anchor>#</a>
happens-before</h4><p>happens-before 规定了对共享变量的写操作对其它线程的读操作可见，它是可见性与有序性的一套规则总结，抛 开以下 happens-before 规则，JMM 并不能保证一个线程对共享变量的写，对于其它线程对该共享变量的读可见</p><ul><li><p>线程解锁 m 之前对变量的写，对于接下来对 m 加锁的其它线程对该变量的读可见(synchronized关键字的可见性、监视器规则)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-258-1><a class=lnlinks href=#hl-258-1> 1</a>
</span><span class=lnt id=hl-258-2><a class=lnlinks href=#hl-258-2> 2</a>
</span><span class=lnt id=hl-258-3><a class=lnlinks href=#hl-258-3> 3</a>
</span><span class=lnt id=hl-258-4><a class=lnlinks href=#hl-258-4> 4</a>
</span><span class=lnt id=hl-258-5><a class=lnlinks href=#hl-258-5> 5</a>
</span><span class=lnt id=hl-258-6><a class=lnlinks href=#hl-258-6> 6</a>
</span><span class=lnt id=hl-258-7><a class=lnlinks href=#hl-258-7> 7</a>
</span><span class=lnt id=hl-258-8><a class=lnlinks href=#hl-258-8> 8</a>
</span><span class=lnt id=hl-258-9><a class=lnlinks href=#hl-258-9> 9</a>
</span><span class=lnt id=hl-258-10><a class=lnlinks href=#hl-258-10>10</a>
</span><span class=lnt id=hl-258-11><a class=lnlinks href=#hl-258-11>11</a>
</span><span class=lnt id=hl-258-12><a class=lnlinks href=#hl-258-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>线程对 volatile 变量的写，对接下来其它线程对该变量的读可见(volatile关键字的可见性、volatile规则)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-259-1><a class=lnlinks href=#hl-259-1>1</a>
</span><span class=lnt id=hl-259-2><a class=lnlinks href=#hl-259-2>2</a>
</span><span class=lnt id=hl-259-3><a class=lnlinks href=#hl-259-3>3</a>
</span><span class=lnt id=hl-259-4><a class=lnlinks href=#hl-259-4>4</a>
</span><span class=lnt id=hl-259-5><a class=lnlinks href=#hl-259-5>5</a>
</span><span class=lnt id=hl-259-6><a class=lnlinks href=#hl-259-6>6</a>
</span><span class=lnt id=hl-259-7><a class=lnlinks href=#hl-259-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>volatile</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>线程 start 前对变量的写，对该线程开始后对该变量的读可见(程序顺序规则+线程启动规则)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-260-1><a class=lnlinks href=#hl-260-1>1</a>
</span><span class=lnt id=hl-260-2><a class=lnlinks href=#hl-260-2>2</a>
</span><span class=lnt id=hl-260-3><a class=lnlinks href=#hl-260-3>3</a>
</span><span class=lnt id=hl-260-4><a class=lnlinks href=#hl-260-4>4</a>
</span><span class=lnt id=hl-260-5><a class=lnlinks href=#hl-260-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>线程结束前对变量的写，对其它线程得知它结束后的读可见（比如其它线程调用 t1.isAlive() 或 t1.join()等待 它结束）(线程终止规则)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-261-1><a class=lnlinks href=#hl-261-1>1</a>
</span><span class=lnt id=hl-261-2><a class=lnlinks href=#hl-261-2>2</a>
</span><span class=lnt id=hl-261-3><a class=lnlinks href=#hl-261-3>3</a>
</span><span class=lnt id=hl-261-4><a class=lnlinks href=#hl-261-4>4</a>
</span><span class=lnt id=hl-261-5><a class=lnlinks href=#hl-261-5>5</a>
</span><span class=lnt id=hl-261-6><a class=lnlinks href=#hl-261-6>6</a>
</span><span class=lnt id=hl-261-7><a class=lnlinks href=#hl-261-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>线程 t1 打断 t2（interrupt）前对变量的写，对于其他线程得知 t2 被打断后对变量的读可见（通过 t2.interrupted 或 t2.isInterrupted）（线程中断机制）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-262-1><a class=lnlinks href=#hl-262-1> 1</a>
</span><span class=lnt id=hl-262-2><a class=lnlinks href=#hl-262-2> 2</a>
</span><span class=lnt id=hl-262-3><a class=lnlinks href=#hl-262-3> 3</a>
</span><span class=lnt id=hl-262-4><a class=lnlinks href=#hl-262-4> 4</a>
</span><span class=lnt id=hl-262-5><a class=lnlinks href=#hl-262-5> 5</a>
</span><span class=lnt id=hl-262-6><a class=lnlinks href=#hl-262-6> 6</a>
</span><span class=lnt id=hl-262-7><a class=lnlinks href=#hl-262-7> 7</a>
</span><span class=lnt id=hl-262-8><a class=lnlinks href=#hl-262-8> 8</a>
</span><span class=lnt id=hl-262-9><a class=lnlinks href=#hl-262-9> 9</a>
</span><span class=lnt id=hl-262-10><a class=lnlinks href=#hl-262-10>10</a>
</span><span class=lnt id=hl-262-11><a class=lnlinks href=#hl-262-11>11</a>
</span><span class=lnt id=hl-262-12><a class=lnlinks href=#hl-262-12>12</a>
</span><span class=lnt id=hl-262-13><a class=lnlinks href=#hl-262-13>13</a>
</span><span class=lnt id=hl-262-14><a class=lnlinks href=#hl-262-14>14</a>
</span><span class=lnt id=hl-262-15><a class=lnlinks href=#hl-262-15>15</a>
</span><span class=lnt id=hl-262-16><a class=lnlinks href=#hl-262-16>16</a>
</span><span class=lnt id=hl-262-17><a class=lnlinks href=#hl-262-17>17</a>
</span><span class=lnt id=hl-262-18><a class=lnlinks href=#hl-262-18>18</a>
</span><span class=lnt id=hl-262-19><a class=lnlinks href=#hl-262-19>19</a>
</span><span class=lnt id=hl-262-20><a class=lnlinks href=#hl-262-20>20</a>
</span><span class=lnt id=hl-262-21><a class=lnlinks href=#hl-262-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>isInterrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=n>t2</span><span class=p>.</span><span class=na>isInterrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>yield</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>对变量默认值（0，false，null）的写，对其它线程对该变量的读可见</p></li><li><p>具有传递性，如果 <code>x hb-> y</code> 并且 <code>y hb-> z</code> 那么有 <code>x hb-> z</code> ，配合 volatile 的防指令重排，有下面的例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-263-1><a class=lnlinks href=#hl-263-1> 1</a>
</span><span class=lnt id=hl-263-2><a class=lnlinks href=#hl-263-2> 2</a>
</span><span class=lnt id=hl-263-3><a class=lnlinks href=#hl-263-3> 3</a>
</span><span class=lnt id=hl-263-4><a class=lnlinks href=#hl-263-4> 4</a>
</span><span class=lnt id=hl-263-5><a class=lnlinks href=#hl-263-5> 5</a>
</span><span class=lnt id=hl-263-6><a class=lnlinks href=#hl-263-6> 6</a>
</span><span class=lnt id=hl-263-7><a class=lnlinks href=#hl-263-7> 7</a>
</span><span class=lnt id=hl-263-8><a class=lnlinks href=#hl-263-8> 8</a>
</span><span class=lnt id=hl-263-9><a class=lnlinks href=#hl-263-9> 9</a>
</span><span class=lnt id=hl-263-10><a class=lnlinks href=#hl-263-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>volatile</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// x=20 对 t2 可见, 同时 y=10 也对 t2 可见</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>变量都是指成员变量或静态成员变量</p><p>参考： 第17页</p><p>在JMM中有一个很重要的概念对于我们了解JMM有很大的帮助，那就是happens-before规则。happens-before规则非常重要，它是判断数据是否存在竞争、线程是否安全的主要依据。JSR-133S使用happens-before概念阐述了两个操作之间的内存可见性。在JMM中，如果一个操作的结果需要对另一个操作可见，那么这两个操作则存在happens-before关系。</p><p>那什么是happens-before呢？在JSR-133中，happens-before关系定义如下：</p><ol><li>如果一个操作happens-before另一个操作，那么意味着第一个操作的结果对第二个操作可见，而且第一个操作的执行顺序将排在第二个操作的前面。</li><li>两个操作之间存在happens-before关系，并不意味着Java平台的具体实现必须按照happens-before关系指定的顺序来执行。如果重排序之后的结果，与按照happens-before关系来执行的结果一致，那么这种重排序并不非法（也就是说，JMM允许这种重排序）</li></ol><p>happens-before规则如下：</p><ol><li>程序顺序规则：一个线程中的每一个操作，happens-before于该线程中的任意后续操作。</li><li>监视器规则：对一个锁的解锁，happens-before于随后对这个锁的加锁。</li><li>volatile规则：对一个volatile变量的写，happens-before于任意后续对一个volatile变量的读。</li><li>传递性：若果A happens-before B，B happens-before C，那么A happens-before C。</li><li>线程启动规则：Thread对象的start()方法，happens-before于这个线程的任意后续操作。</li><li>线程终止规则：线程中的任意操作，happens-before于该线程的终止监测。我们可以通过Thread.join()方法结束、Thread.isAlive()的返回值等手段检测到线程已经终止执行。</li><li>线程中断操作：对线程interrupt()方法的调用，happens-before于被中断线程的代码检测到中断事件的发生，可以通过Thread.interrupted()方法检测到线程是否有中断发生。</li><li>对象终结规则：一个对象的初始化完成，happens-before于这个对象的finalize()方法的开始。</li></ol><p>参考链接：<a class=link href=https://zhuanlan.zhihu.com/p/77157725 target=_blank rel=noopener>happens-before规则解析 - 知乎 (zhihu.com)
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></blockquote></li></ul><h4 id=习题><a href=#%e4%b9%a0%e9%a2%98 class=header-anchor>#</a>
习题</h4><h5 id=balking-模式习题><a href=#balking-%e6%a8%a1%e5%bc%8f%e4%b9%a0%e9%a2%98 class=header-anchor>#</a>
balking 模式习题</h5><p>希望 doInit() 方法仅被调用一次，下面的实现是否有问题，为什么？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-264-1><a class=lnlinks href=#hl-264-1> 1</a>
</span><span class=lnt id=hl-264-2><a class=lnlinks href=#hl-264-2> 2</a>
</span><span class=lnt id=hl-264-3><a class=lnlinks href=#hl-264-3> 3</a>
</span><span class=lnt id=hl-264-4><a class=lnlinks href=#hl-264-4> 4</a>
</span><span class=lnt id=hl-264-5><a class=lnlinks href=#hl-264-5> 5</a>
</span><span class=lnt id=hl-264-6><a class=lnlinks href=#hl-264-6> 6</a>
</span><span class=lnt id=hl-264-7><a class=lnlinks href=#hl-264-7> 7</a>
</span><span class=lnt id=hl-264-8><a class=lnlinks href=#hl-264-8> 8</a>
</span><span class=lnt id=hl-264-9><a class=lnlinks href=#hl-264-9> 9</a>
</span><span class=lnt id=hl-264-10><a class=lnlinks href=#hl-264-10>10</a>
</span><span class=lnt id=hl-264-11><a class=lnlinks href=#hl-264-11>11</a>
</span><span class=lnt id=hl-264-12><a class=lnlinks href=#hl-264-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestVolatile</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>initialized</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>initialized</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>doInit</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>initialized</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doInit</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><h5 id=线程安全单例习题><a href=#%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e5%8d%95%e4%be%8b%e4%b9%a0%e9%a2%98 class=header-anchor>#</a>
线程安全单例习题</h5><p>单例模式有很多实现方法，饿汉、懒汉、静态内部类、枚举类，试分析每种实现下获取单例对象（即调用 getInstance）时的线程安全，并思考注释中的问题</p><blockquote><p>饿汉式：类加载就会导致该单实例对象被创建</p><p>懒汉式：类加载不会导致该单实例对象被创建，而是首次使用该对象时才会创建</p></blockquote><p><strong>实现1(饿汉式)：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-265-1><a class=lnlinks href=#hl-265-1> 1</a>
</span><span class=lnt id=hl-265-2><a class=lnlinks href=#hl-265-2> 2</a>
</span><span class=lnt id=hl-265-3><a class=lnlinks href=#hl-265-3> 3</a>
</span><span class=lnt id=hl-265-4><a class=lnlinks href=#hl-265-4> 4</a>
</span><span class=lnt id=hl-265-5><a class=lnlinks href=#hl-265-5> 5</a>
</span><span class=lnt id=hl-265-6><a class=lnlinks href=#hl-265-6> 6</a>
</span><span class=lnt id=hl-265-7><a class=lnlinks href=#hl-265-7> 7</a>
</span><span class=lnt id=hl-265-8><a class=lnlinks href=#hl-265-8> 8</a>
</span><span class=lnt id=hl-265-9><a class=lnlinks href=#hl-265-9> 9</a>
</span><span class=lnt id=hl-265-10><a class=lnlinks href=#hl-265-10>10</a>
</span><span class=lnt id=hl-265-11><a class=lnlinks href=#hl-265-11>11</a>
</span><span class=lnt id=hl-265-12><a class=lnlinks href=#hl-265-12>12</a>
</span><span class=lnt id=hl-265-13><a class=lnlinks href=#hl-265-13>13</a>
</span><span class=lnt id=hl-265-14><a class=lnlinks href=#hl-265-14>14</a>
</span><span class=lnt id=hl-265-15><a class=lnlinks href=#hl-265-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 问题1：为什么加 final(防止被子类继承从而重写方法改写单例)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 问题2：如果实现了序列化接口, 还要做什么来防止反序列化破坏单例(重写readResolve方法)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 问题3：为什么设置为私有? 是否能防止反射创建新的实例?(防止外部调用构造方法创建多个实例；不能)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 问题4：这样初始化是否能保证单例对象创建时的线程安全?(能，线程安全性由类加载器保障)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 问题5：为什么提供静态方法而不是直接将 INSTANCE 设置为 public, 说出你知道的理由(可以保证instance的安全性，也能方便实现一些附加逻辑)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>readResolve</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>实现2(枚举类)：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-266-1><a class=lnlinks href=#hl-266-1>1</a>
</span><span class=lnt id=hl-266-2><a class=lnlinks href=#hl-266-2>2</a>
</span><span class=lnt id=hl-266-3><a class=lnlinks href=#hl-266-3>3</a>
</span><span class=lnt id=hl-266-4><a class=lnlinks href=#hl-266-4>4</a>
</span><span class=lnt id=hl-266-5><a class=lnlinks href=#hl-266-5>5</a>
</span><span class=lnt id=hl-266-6><a class=lnlinks href=#hl-266-6>6</a>
</span><span class=lnt id=hl-266-7><a class=lnlinks href=#hl-266-7>7</a>
</span><span class=lnt id=hl-266-8><a class=lnlinks href=#hl-266-8>8</a>
</span><span class=lnt id=hl-266-9><a class=lnlinks href=#hl-266-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 问题1：枚举单例是如何限制实例个数的 (枚举类会按照声明的个数在类加载时实例化对象)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 问题2：枚举单例在创建时是否有并发问题(没有，由类加载器保障安全性)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 问题3：枚举单例能否被反射破坏单例(不能)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 问题4：枚举单例能否被反序列化破坏单例(不能)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 问题5：枚举单例属于懒汉式还是饿汉式(饿汉)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 问题6：枚举单例如果希望加入一些单例创建时的初始化逻辑该如何做(写构造方法)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>enum</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>实现3(synchronized方法)：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-267-1><a class=lnlinks href=#hl-267-1> 1</a>
</span><span class=lnt id=hl-267-2><a class=lnlinks href=#hl-267-2> 2</a>
</span><span class=lnt id=hl-267-3><a class=lnlinks href=#hl-267-3> 3</a>
</span><span class=lnt id=hl-267-4><a class=lnlinks href=#hl-267-4> 4</a>
</span><span class=lnt id=hl-267-5><a class=lnlinks href=#hl-267-5> 5</a>
</span><span class=lnt id=hl-267-6><a class=lnlinks href=#hl-267-6> 6</a>
</span><span class=lnt id=hl-267-7><a class=lnlinks href=#hl-267-7> 7</a>
</span><span class=lnt id=hl-267-8><a class=lnlinks href=#hl-267-8> 8</a>
</span><span class=lnt id=hl-267-9><a class=lnlinks href=#hl-267-9> 9</a>
</span><span class=lnt id=hl-267-10><a class=lnlinks href=#hl-267-10>10</a>
</span><span class=lnt id=hl-267-11><a class=lnlinks href=#hl-267-11>11</a>
</span><span class=lnt id=hl-267-12><a class=lnlinks href=#hl-267-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 分析这里的线程安全, 并说明有什么缺点(没有线程安全问题，同步代码块粒度太大，性能差)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>实现4：DCL+volatile</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-268-1><a class=lnlinks href=#hl-268-1> 1</a>
</span><span class=lnt id=hl-268-2><a class=lnlinks href=#hl-268-2> 2</a>
</span><span class=lnt id=hl-268-3><a class=lnlinks href=#hl-268-3> 3</a>
</span><span class=lnt id=hl-268-4><a class=lnlinks href=#hl-268-4> 4</a>
</span><span class=lnt id=hl-268-5><a class=lnlinks href=#hl-268-5> 5</a>
</span><span class=lnt id=hl-268-6><a class=lnlinks href=#hl-268-6> 6</a>
</span><span class=lnt id=hl-268-7><a class=lnlinks href=#hl-268-7> 7</a>
</span><span class=lnt id=hl-268-8><a class=lnlinks href=#hl-268-8> 8</a>
</span><span class=lnt id=hl-268-9><a class=lnlinks href=#hl-268-9> 9</a>
</span><span class=lnt id=hl-268-10><a class=lnlinks href=#hl-268-10>10</a>
</span><span class=lnt id=hl-268-11><a class=lnlinks href=#hl-268-11>11</a>
</span><span class=lnt id=hl-268-12><a class=lnlinks href=#hl-268-12>12</a>
</span><span class=lnt id=hl-268-13><a class=lnlinks href=#hl-268-13>13</a>
</span><span class=lnt id=hl-268-14><a class=lnlinks href=#hl-268-14>14</a>
</span><span class=lnt id=hl-268-15><a class=lnlinks href=#hl-268-15>15</a>
</span><span class=lnt id=hl-268-16><a class=lnlinks href=#hl-268-16>16</a>
</span><span class=lnt id=hl-268-17><a class=lnlinks href=#hl-268-17>17</a>
</span><span class=lnt id=hl-268-18><a class=lnlinks href=#hl-268-18>18</a>
</span><span class=lnt id=hl-268-19><a class=lnlinks href=#hl-268-19>19</a>
</span><span class=lnt id=hl-268-20><a class=lnlinks href=#hl-268-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 问题1：解释为什么要加 volatile ?(防止putstatic和invokespecial重排导致的异常)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 问题2：对比实现3, 说出这样做的意义 (缩小了锁的粒度，提高了性能)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>Singleton</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 问题3：为什么还要在这里加为空判断, 之前不是判断过了吗</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// t2 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>实现5(内部类初始化)：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-269-1><a class=lnlinks href=#hl-269-1> 1</a>
</span><span class=lnt id=hl-269-2><a class=lnlinks href=#hl-269-2> 2</a>
</span><span class=lnt id=hl-269-3><a class=lnlinks href=#hl-269-3> 3</a>
</span><span class=lnt id=hl-269-4><a class=lnlinks href=#hl-269-4> 4</a>
</span><span class=lnt id=hl-269-5><a class=lnlinks href=#hl-269-5> 5</a>
</span><span class=lnt id=hl-269-6><a class=lnlinks href=#hl-269-6> 6</a>
</span><span class=lnt id=hl-269-7><a class=lnlinks href=#hl-269-7> 7</a>
</span><span class=lnt id=hl-269-8><a class=lnlinks href=#hl-269-8> 8</a>
</span><span class=lnt id=hl-269-9><a class=lnlinks href=#hl-269-9> 9</a>
</span><span class=lnt id=hl-269-10><a class=lnlinks href=#hl-269-10>10</a>
</span><span class=lnt id=hl-269-11><a class=lnlinks href=#hl-269-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 问题1：属于懒汉式还是饿汉式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>LazyHolder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 问题2：在创建时是否有并发问题</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>LazyHolder</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=本章小结-2><a href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-2 class=header-anchor>#</a>
本章小结</h2><p>本章重点讲解了 JMM 中的</p><ul><li>可见性 - 由 JVM 缓存优化引起</li><li>有序性 - 由 JVM 指令重排序优化引起</li><li>happens-before 规则</li><li><font color=blue>原理方面</font><ul><li>CPU 指令并行</li><li>volatile</li></ul></li><li><font color=orange>模式方面</font><ul><li>两阶段终止模式的 volatile 改进</li><li>同步模式之 balking</li></ul></li></ul><h1 id=6共享模型之无锁><a href=#6%e5%85%b1%e4%ba%ab%e6%a8%a1%e5%9e%8b%e4%b9%8b%e6%97%a0%e9%94%81 class=header-anchor>#</a>
6.共享模型之无锁</h1><h2 id=61-问题提出-应用之互斥><a href=#61-%e9%97%ae%e9%a2%98%e6%8f%90%e5%87%ba-%e5%ba%94%e7%94%a8%e4%b9%8b%e4%ba%92%e6%96%a5 class=header-anchor>#</a>
6.1 问题提出 (应用之互斥)</h2><p>有如下需求，保证 account.withdraw 取款方法的线程安全</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-270-1><a class=lnlinks href=#hl-270-1> 1</a>
</span><span class=lnt id=hl-270-2><a class=lnlinks href=#hl-270-2> 2</a>
</span><span class=lnt id=hl-270-3><a class=lnlinks href=#hl-270-3> 3</a>
</span><span class=lnt id=hl-270-4><a class=lnlinks href=#hl-270-4> 4</a>
</span><span class=lnt id=hl-270-5><a class=lnlinks href=#hl-270-5> 5</a>
</span><span class=lnt id=hl-270-6><a class=lnlinks href=#hl-270-6> 6</a>
</span><span class=lnt id=hl-270-7><a class=lnlinks href=#hl-270-7> 7</a>
</span><span class=lnt id=hl-270-8><a class=lnlinks href=#hl-270-8> 8</a>
</span><span class=lnt id=hl-270-9><a class=lnlinks href=#hl-270-9> 9</a>
</span><span class=lnt id=hl-270-10><a class=lnlinks href=#hl-270-10>10</a>
</span><span class=lnt id=hl-270-11><a class=lnlinks href=#hl-270-11>11</a>
</span><span class=lnt id=hl-270-12><a class=lnlinks href=#hl-270-12>12</a>
</span><span class=lnt id=hl-270-13><a class=lnlinks href=#hl-270-13>13</a>
</span><span class=lnt id=hl-270-14><a class=lnlinks href=#hl-270-14>14</a>
</span><span class=lnt id=hl-270-15><a class=lnlinks href=#hl-270-15>15</a>
</span><span class=lnt id=hl-270-16><a class=lnlinks href=#hl-270-16>16</a>
</span><span class=lnt id=hl-270-17><a class=lnlinks href=#hl-270-17>17</a>
</span><span class=lnt id=hl-270-18><a class=lnlinks href=#hl-270-18>18</a>
</span><span class=lnt id=hl-270-19><a class=lnlinks href=#hl-270-19>19</a>
</span><span class=lnt id=hl-270-20><a class=lnlinks href=#hl-270-20>20</a>
</span><span class=lnt id=hl-270-21><a class=lnlinks href=#hl-270-21>21</a>
</span><span class=lnt id=hl-270-22><a class=lnlinks href=#hl-270-22>22</a>
</span><span class=lnt id=hl-270-23><a class=lnlinks href=#hl-270-23>23</a>
</span><span class=lnt id=hl-270-24><a class=lnlinks href=#hl-270-24>24</a>
</span><span class=lnt id=hl-270-25><a class=lnlinks href=#hl-270-25>25</a>
</span><span class=lnt id=hl-270-26><a class=lnlinks href=#hl-270-26>26</a>
</span><span class=lnt id=hl-270-27><a class=lnlinks href=#hl-270-27>27</a>
</span><span class=lnt id=hl-270-28><a class=lnlinks href=#hl-270-28>28</a>
</span><span class=lnt id=hl-270-29><a class=lnlinks href=#hl-270-29>29</a>
</span><span class=lnt id=hl-270-30><a class=lnlinks href=#hl-270-30>30</a>
</span><span class=lnt id=hl-270-31><a class=lnlinks href=#hl-270-31>31</a>
</span><span class=lnt id=hl-270-32><a class=lnlinks href=#hl-270-32>32</a>
</span><span class=lnt id=hl-270-33><a class=lnlinks href=#hl-270-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>cn.itcast</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.ArrayList</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>interface</span> <span class=nc>Account</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取余额</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Integer</span><span class=w> </span><span class=nf>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 取款</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作
</span></span></span><span class=line><span class=cl><span class=cm> * 如果初始余额为 10000 那么正确的结果应当是 0
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo</span><span class=p>(</span><span class=n>Account</span><span class=w> </span><span class=n>account</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ts</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>account</span><span class=p>.</span><span class=na>withdraw</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>Thread</span><span class=p>::</span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>()</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=o>+</span><span class=w> </span><span class=s>&#34; cost: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=o>-</span><span class=n>start</span><span class=p>)</span><span class=o>/</span><span class=n>1000_000</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; ms&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>原有实现并不是线程安全的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-271-1><a class=lnlinks href=#hl-271-1> 1</a>
</span><span class=lnt id=hl-271-2><a class=lnlinks href=#hl-271-2> 2</a>
</span><span class=lnt id=hl-271-3><a class=lnlinks href=#hl-271-3> 3</a>
</span><span class=lnt id=hl-271-4><a class=lnlinks href=#hl-271-4> 4</a>
</span><span class=lnt id=hl-271-5><a class=lnlinks href=#hl-271-5> 5</a>
</span><span class=lnt id=hl-271-6><a class=lnlinks href=#hl-271-6> 6</a>
</span><span class=lnt id=hl-271-7><a class=lnlinks href=#hl-271-7> 7</a>
</span><span class=lnt id=hl-271-8><a class=lnlinks href=#hl-271-8> 8</a>
</span><span class=lnt id=hl-271-9><a class=lnlinks href=#hl-271-9> 9</a>
</span><span class=lnt id=hl-271-10><a class=lnlinks href=#hl-271-10>10</a>
</span><span class=lnt id=hl-271-11><a class=lnlinks href=#hl-271-11>11</a>
</span><span class=lnt id=hl-271-12><a class=lnlinks href=#hl-271-12>12</a>
</span><span class=lnt id=hl-271-13><a class=lnlinks href=#hl-271-13>13</a>
</span><span class=lnt id=hl-271-14><a class=lnlinks href=#hl-271-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AccountUnsafe</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Account</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AccountUnsafe</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>balance</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>执行测试代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-272-1><a class=lnlinks href=#hl-272-1>1</a>
</span><span class=lnt id=hl-272-2><a class=lnlinks href=#hl-272-2>2</a>
</span><span class=lnt id=hl-272-3><a class=lnlinks href=#hl-272-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Account</span><span class=p>.</span><span class=na>demo</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AccountUnsafe</span><span class=p>(</span><span class=n>10000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>某次的执行结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-273-1><a class=lnlinks href=#hl-273-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>330</span> cost: <span class=m>306</span> ms
</span></span></code></pre></td></tr></table></div></div><h5 id=为什么不安全><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e5%ae%89%e5%85%a8 class=header-anchor>#</a>
<strong>为什么不安全</strong></h5><p><code>withdraw</code> 方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-274-1><a class=lnlinks href=#hl-274-1>1</a>
</span><span class=lnt id=hl-274-2><a class=lnlinks href=#hl-274-2>2</a>
</span><span class=lnt id=hl-274-3><a class=lnlinks href=#hl-274-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>balance</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>对应的字节码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-275-1><a class=lnlinks href=#hl-275-1>1</a>
</span><span class=lnt id=hl-275-2><a class=lnlinks href=#hl-275-2>2</a>
</span><span class=lnt id=hl-275-3><a class=lnlinks href=#hl-275-3>3</a>
</span><span class=lnt id=hl-275-4><a class=lnlinks href=#hl-275-4>4</a>
</span><span class=lnt id=hl-275-5><a class=lnlinks href=#hl-275-5>5</a>
</span><span class=lnt id=hl-275-6><a class=lnlinks href=#hl-275-6>6</a>
</span><span class=lnt id=hl-275-7><a class=lnlinks href=#hl-275-7>7</a>
</span><span class=lnt id=hl-275-8><a class=lnlinks href=#hl-275-8>8</a>
</span><span class=lnt id=hl-275-9><a class=lnlinks href=#hl-275-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=c1>// &lt;- this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>GETFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>;</span><span class=w> </span><span class=c1>// &lt;- this.balance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=p>()</span><span class=n>I</span><span class=w> </span><span class=c1>// 拆箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=c1>// &lt;- amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=p>()</span><span class=n>I</span><span class=w> </span><span class=c1>// 拆箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ISUB</span><span class=w> </span><span class=c1>// 减法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKESTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>valueOf</span><span class=w> </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>;</span><span class=w> </span><span class=c1>// 结果装箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PUTFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>;</span><span class=w> </span><span class=c1>// -&gt; this.balance</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>多线程执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-276-1><a class=lnlinks href=#hl-276-1> 1</a>
</span><span class=lnt id=hl-276-2><a class=lnlinks href=#hl-276-2> 2</a>
</span><span class=lnt id=hl-276-3><a class=lnlinks href=#hl-276-3> 3</a>
</span><span class=lnt id=hl-276-4><a class=lnlinks href=#hl-276-4> 4</a>
</span><span class=lnt id=hl-276-5><a class=lnlinks href=#hl-276-5> 5</a>
</span><span class=lnt id=hl-276-6><a class=lnlinks href=#hl-276-6> 6</a>
</span><span class=lnt id=hl-276-7><a class=lnlinks href=#hl-276-7> 7</a>
</span><span class=lnt id=hl-276-8><a class=lnlinks href=#hl-276-8> 8</a>
</span><span class=lnt id=hl-276-9><a class=lnlinks href=#hl-276-9> 9</a>
</span><span class=lnt id=hl-276-10><a class=lnlinks href=#hl-276-10>10</a>
</span><span class=lnt id=hl-276-11><a class=lnlinks href=#hl-276-11>11</a>
</span><span class=lnt id=hl-276-12><a class=lnlinks href=#hl-276-12>12</a>
</span><span class=lnt id=hl-276-13><a class=lnlinks href=#hl-276-13>13</a>
</span><span class=lnt id=hl-276-14><a class=lnlinks href=#hl-276-14>14</a>
</span><span class=lnt id=hl-276-15><a class=lnlinks href=#hl-276-15>15</a>
</span><span class=lnt id=hl-276-16><a class=lnlinks href=#hl-276-16>16</a>
</span><span class=lnt id=hl-276-17><a class=lnlinks href=#hl-276-17>17</a>
</span><span class=lnt id=hl-276-18><a class=lnlinks href=#hl-276-18>18</a>
</span><span class=lnt id=hl-276-19><a class=lnlinks href=#hl-276-19>19</a>
</span><span class=lnt id=hl-276-20><a class=lnlinks href=#hl-276-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=c1>// thread-0 &lt;- this </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>GETFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=c1>// thread-0 &lt;- this.balance </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=c1>// thread-0 拆箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=c1>// thread-0 &lt;- amount </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=c1>// thread-0 拆箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ISUB</span><span class=w> </span><span class=c1>// thread-0 减法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKESTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>valueOf</span><span class=w> </span><span class=c1>// thread-0 结果装箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PUTFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=c1>// thread-0 -&gt; this.balance </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=c1>// thread-1 &lt;- this </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>GETFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=c1>// thread-1 &lt;- this.balance </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=c1>// thread-1 拆箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=c1>// thread-1 &lt;- amount </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=c1>// thread-1 拆箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ISUB</span><span class=w> </span><span class=c1>// thread-1 减法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKESTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>valueOf</span><span class=w> </span><span class=c1>// thread-1 结果装箱</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PUTFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=c1>// thread-1 -&gt; this.balance</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>原因：Integer虽然是不可变类，其方法是线程安全的，但是以上操作涉及到了多个方法的组合，等价于以下代码：</p><p>balance = new Integer(Integer.valueOf(balance) - amount);</p><p>前一个方法(valueOf)的结果决定后一个方法(构造方法)，这种组合在多线程环境下线程不安全。</p><h5 id=解决思路-锁悲观互斥><a href=#%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-%e9%94%81%e6%82%b2%e8%a7%82%e4%ba%92%e6%96%a5 class=header-anchor>#</a>
<strong>解决思路-锁</strong>（悲观互斥）</h5><p>首先想到的是给 Account 对象加锁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-277-1><a class=lnlinks href=#hl-277-1> 1</a>
</span><span class=lnt id=hl-277-2><a class=lnlinks href=#hl-277-2> 2</a>
</span><span class=lnt id=hl-277-3><a class=lnlinks href=#hl-277-3> 3</a>
</span><span class=lnt id=hl-277-4><a class=lnlinks href=#hl-277-4> 4</a>
</span><span class=lnt id=hl-277-5><a class=lnlinks href=#hl-277-5> 5</a>
</span><span class=lnt id=hl-277-6><a class=lnlinks href=#hl-277-6> 6</a>
</span><span class=lnt id=hl-277-7><a class=lnlinks href=#hl-277-7> 7</a>
</span><span class=lnt id=hl-277-8><a class=lnlinks href=#hl-277-8> 8</a>
</span><span class=lnt id=hl-277-9><a class=lnlinks href=#hl-277-9> 9</a>
</span><span class=lnt id=hl-277-10><a class=lnlinks href=#hl-277-10>10</a>
</span><span class=lnt id=hl-277-11><a class=lnlinks href=#hl-277-11>11</a>
</span><span class=lnt id=hl-277-12><a class=lnlinks href=#hl-277-12>12</a>
</span><span class=lnt id=hl-277-13><a class=lnlinks href=#hl-277-13>13</a>
</span><span class=lnt id=hl-277-14><a class=lnlinks href=#hl-277-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AccountUnsafe</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Account</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AccountUnsafe</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>balance</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-278-1><a class=lnlinks href=#hl-278-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>0</span> cost: <span class=m>399</span> ms 
</span></span></code></pre></td></tr></table></div></div><h5 id=解决思路-无锁乐观重试><a href=#%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-%e6%97%a0%e9%94%81%e4%b9%90%e8%a7%82%e9%87%8d%e8%af%95 class=header-anchor>#</a>
<strong>解决思路-无锁</strong>（乐观重试）</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-279-1><a class=lnlinks href=#hl-279-1> 1</a>
</span><span class=lnt id=hl-279-2><a class=lnlinks href=#hl-279-2> 2</a>
</span><span class=lnt id=hl-279-3><a class=lnlinks href=#hl-279-3> 3</a>
</span><span class=lnt id=hl-279-4><a class=lnlinks href=#hl-279-4> 4</a>
</span><span class=lnt id=hl-279-5><a class=lnlinks href=#hl-279-5> 5</a>
</span><span class=lnt id=hl-279-6><a class=lnlinks href=#hl-279-6> 6</a>
</span><span class=lnt id=hl-279-7><a class=lnlinks href=#hl-279-7> 7</a>
</span><span class=lnt id=hl-279-8><a class=lnlinks href=#hl-279-8> 8</a>
</span><span class=lnt id=hl-279-9><a class=lnlinks href=#hl-279-9> 9</a>
</span><span class=lnt id=hl-279-10><a class=lnlinks href=#hl-279-10>10</a>
</span><span class=lnt id=hl-279-11><a class=lnlinks href=#hl-279-11>11</a>
</span><span class=lnt id=hl-279-12><a class=lnlinks href=#hl-279-12>12</a>
</span><span class=lnt id=hl-279-13><a class=lnlinks href=#hl-279-13>13</a>
</span><span class=lnt id=hl-279-14><a class=lnlinks href=#hl-279-14>14</a>
</span><span class=lnt id=hl-279-15><a class=lnlinks href=#hl-279-15>15</a>
</span><span class=lnt id=hl-279-16><a class=lnlinks href=#hl-279-16>16</a>
</span><span class=lnt id=hl-279-17><a class=lnlinks href=#hl-279-17>17</a>
</span><span class=lnt id=hl-279-18><a class=lnlinks href=#hl-279-18>18</a>
</span><span class=lnt id=hl-279-19><a class=lnlinks href=#hl-279-19>19</a>
</span><span class=lnt id=hl-279-20><a class=lnlinks href=#hl-279-20>20</a>
</span><span class=lnt id=hl-279-21><a class=lnlinks href=#hl-279-21>21</a>
</span><span class=lnt id=hl-279-22><a class=lnlinks href=#hl-279-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AccountSafe</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Account</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AccountSafe</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>balance</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 可以简化为下面的方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// balance.addAndGet(-1 * amount);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>执行测试代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-280-1><a class=lnlinks href=#hl-280-1>1</a>
</span><span class=lnt id=hl-280-2><a class=lnlinks href=#hl-280-2>2</a>
</span><span class=lnt id=hl-280-3><a class=lnlinks href=#hl-280-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Account</span><span class=p>.</span><span class=na>demo</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AccountSafe</span><span class=p>(</span><span class=n>10000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>某次的执行结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-281-1><a class=lnlinks href=#hl-281-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>0</span> cost: <span class=m>302</span> ms
</span></span></code></pre></td></tr></table></div></div><h2 id=62-cas-与-volatile><a href=#62-cas-%e4%b8%8e-volatile class=header-anchor>#</a>
6.2 CAS 与 volatile</h2><p>前面看到的 AtomicInteger 的解决方法，内部并没有用锁来保护共享变量的线程安全。那么它是如何实现的呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-282-1><a class=lnlinks href=#hl-282-1> 1</a>
</span><span class=lnt id=hl-282-2><a class=lnlinks href=#hl-282-2> 2</a>
</span><span class=lnt id=hl-282-3><a class=lnlinks href=#hl-282-3> 3</a>
</span><span class=lnt id=hl-282-4><a class=lnlinks href=#hl-282-4> 4</a>
</span><span class=lnt id=hl-282-5><a class=lnlinks href=#hl-282-5> 5</a>
</span><span class=lnt id=hl-282-6><a class=lnlinks href=#hl-282-6> 6</a>
</span><span class=lnt id=hl-282-7><a class=lnlinks href=#hl-282-7> 7</a>
</span><span class=lnt id=hl-282-8><a class=lnlinks href=#hl-282-8> 8</a>
</span><span class=lnt id=hl-282-9><a class=lnlinks href=#hl-282-9> 9</a>
</span><span class=lnt id=hl-282-10><a class=lnlinks href=#hl-282-10>10</a>
</span><span class=lnt id=hl-282-11><a class=lnlinks href=#hl-282-11>11</a>
</span><span class=lnt id=hl-282-12><a class=lnlinks href=#hl-282-12>12</a>
</span><span class=lnt id=hl-282-13><a class=lnlinks href=#hl-282-13>13</a>
</span><span class=lnt id=hl-282-14><a class=lnlinks href=#hl-282-14>14</a>
</span><span class=lnt id=hl-282-15><a class=lnlinks href=#hl-282-15>15</a>
</span><span class=lnt id=hl-282-16><a class=lnlinks href=#hl-282-16>16</a>
</span><span class=lnt id=hl-282-17><a class=lnlinks href=#hl-282-17>17</a>
</span><span class=lnt id=hl-282-18><a class=lnlinks href=#hl-282-18>18</a>
</span><span class=lnt id=hl-282-19><a class=lnlinks href=#hl-282-19>19</a>
</span><span class=lnt id=hl-282-20><a class=lnlinks href=#hl-282-20>20</a>
</span><span class=lnt id=hl-282-21><a class=lnlinks href=#hl-282-21>21</a>
</span><span class=lnt id=hl-282-22><a class=lnlinks href=#hl-282-22>22</a>
</span><span class=lnt id=hl-282-23><a class=lnlinks href=#hl-282-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 需要不断尝试，直到成功为止</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 比如拿到了旧值 1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 在这个基础上 1000-10 = 990</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>             compareAndSet 正是做这个检查，在 set 前，先比较 prev 与当前值
</span></span></span><span class=line><span class=cl><span class=cm>             - 不一致了，next 作废，返回 false 表示失败
</span></span></span><span class=line><span class=cl><span class=cm>             比如，别的线程已经做了减法，当前值已经被减成了 990
</span></span></span><span class=line><span class=cl><span class=cm>             那么本线程的这次 990 就作废了，进入 while 下次循环重试
</span></span></span><span class=line><span class=cl><span class=cm>             - 一致，以 next 设置为新值，返回 true 表示成功
</span></span></span><span class=line><span class=cl><span class=cm>             */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>balance</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//或者简洁一点：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//balance.getAndAdd(-1 * amount);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>其中的关键是 compareAndSet，它的简称就是 CAS （也有 Compare And Swap 的说法），它必须是原子操作。</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220308180039801.png width=900 height=600 loading=lazy decoding=async alt=image-20220308180039801 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><blockquote><p><strong>注意</strong></p><p>其实 CAS 的底层是 lock cmpxchg 指令（X86 架构），在单核 CPU 和多核 CPU 下都能够保证【比较-交 换】的原子性。</p><p>在多核状态下，某个核执行到带 lock 的指令时，CPU 会让总线锁住，当这个核把此指令执行完毕，再 开启总线。这个过程中不会被线程的调度机制所打断，保证了多个线程对内存操作的准确性，是原子 的。</p></blockquote><h5 id=慢动作分析><a href=#%e6%85%a2%e5%8a%a8%e4%bd%9c%e5%88%86%e6%9e%90 class=header-anchor>#</a>
慢动作分析</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-283-1><a class=lnlinks href=#hl-283-1> 1</a>
</span><span class=lnt id=hl-283-2><a class=lnlinks href=#hl-283-2> 2</a>
</span><span class=lnt id=hl-283-3><a class=lnlinks href=#hl-283-3> 3</a>
</span><span class=lnt id=hl-283-4><a class=lnlinks href=#hl-283-4> 4</a>
</span><span class=lnt id=hl-283-5><a class=lnlinks href=#hl-283-5> 5</a>
</span><span class=lnt id=hl-283-6><a class=lnlinks href=#hl-283-6> 6</a>
</span><span class=lnt id=hl-283-7><a class=lnlinks href=#hl-283-7> 7</a>
</span><span class=lnt id=hl-283-8><a class=lnlinks href=#hl-283-8> 8</a>
</span><span class=lnt id=hl-283-9><a class=lnlinks href=#hl-283-9> 9</a>
</span><span class=lnt id=hl-283-10><a class=lnlinks href=#hl-283-10>10</a>
</span><span class=lnt id=hl-283-11><a class=lnlinks href=#hl-283-11>11</a>
</span><span class=lnt id=hl-283-12><a class=lnlinks href=#hl-283-12>12</a>
</span><span class=lnt id=hl-283-13><a class=lnlinks href=#hl-283-13>13</a>
</span><span class=lnt id=hl-283-14><a class=lnlinks href=#hl-283-14>14</a>
</span><span class=lnt id=hl-283-15><a class=lnlinks href=#hl-283-15>15</a>
</span><span class=lnt id=hl-283-16><a class=lnlinks href=#hl-283-16>16</a>
</span><span class=lnt id=hl-283-17><a class=lnlinks href=#hl-283-17>17</a>
</span><span class=lnt id=hl-283-18><a class=lnlinks href=#hl-283-18>18</a>
</span><span class=lnt id=hl-283-19><a class=lnlinks href=#hl-283-19>19</a>
</span><span class=lnt id=hl-283-20><a class=lnlinks href=#hl-283-20>20</a>
</span><span class=lnt id=hl-283-21><a class=lnlinks href=#hl-283-21>21</a>
</span><span class=lnt id=hl-283-22><a class=lnlinks href=#hl-283-22>22</a>
</span><span class=lnt id=hl-283-23><a class=lnlinks href=#hl-283-23>23</a>
</span><span class=lnt id=hl-283-24><a class=lnlinks href=#hl-283-24>24</a>
</span><span class=lnt id=hl-283-25><a class=lnlinks href=#hl-283-25>25</a>
</span><span class=lnt id=hl-283-26><a class=lnlinks href=#hl-283-26>26</a>
</span><span class=lnt id=hl-283-27><a class=lnlinks href=#hl-283-27>27</a>
</span><span class=lnt id=hl-283-28><a class=lnlinks href=#hl-283-28>28</a>
</span><span class=lnt id=hl-283-29><a class=lnlinks href=#hl-283-29>29</a>
</span><span class=lnt id=hl-283-30><a class=lnlinks href=#hl-283-30>30</a>
</span><span class=lnt id=hl-283-31><a class=lnlinks href=#hl-283-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SlowMotion</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>10000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>mainPrev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;try get {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>mainPrev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>balance</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>9000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>balance</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;try set 8000...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>isSuccess</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>mainPrev</span><span class=p>,</span><span class=w> </span><span class=n>8000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;is success ? {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>isSuccess</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>isSuccess</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mainPrev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;try set 8000...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>isSuccess</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>mainPrev</span><span class=p>,</span><span class=w> </span><span class=n>8000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;is success ? {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>isSuccess</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sleep</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>millis</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>millis</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-284-1><a class=lnlinks href=#hl-284-1>1</a>
</span><span class=lnt id=hl-284-2><a class=lnlinks href=#hl-284-2>2</a>
</span><span class=lnt id=hl-284-3><a class=lnlinks href=#hl-284-3>3</a>
</span><span class=lnt id=hl-284-4><a class=lnlinks href=#hl-284-4>4</a>
</span><span class=lnt id=hl-284-5><a class=lnlinks href=#hl-284-5>5</a>
</span><span class=lnt id=hl-284-6><a class=lnlinks href=#hl-284-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>2019-10-13 11:28:37.134 <span class=o>[</span>main<span class=o>]</span> try get <span class=m>10000</span> 
</span></span><span class=line><span class=cl>2019-10-13 11:28:38.154 <span class=o>[</span>t1<span class=o>]</span> <span class=m>9000</span> 
</span></span><span class=line><span class=cl>2019-10-13 11:28:39.154 <span class=o>[</span>main<span class=o>]</span> try <span class=nb>set</span> 8000... 
</span></span><span class=line><span class=cl>2019-10-13 11:28:39.154 <span class=o>[</span>main<span class=o>]</span> is success ? <span class=nb>false</span> 
</span></span><span class=line><span class=cl>2019-10-13 11:28:39.154 <span class=o>[</span>main<span class=o>]</span> try <span class=nb>set</span> 8000... 
</span></span><span class=line><span class=cl>2019-10-13 11:28:39.154 <span class=o>[</span>main<span class=o>]</span> is success ? <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=volatile><a href=#volatile class=header-anchor>#</a>
volatile</h5><p>获取共享变量时，为了保证该变量的可见性，需要使用 volatile 修饰。</p><p>它可以用来修饰成员变量和静态成员变量，他可以避免线程从自己的工作缓存中查找变量的值，必须到主存中获取 它的值，线程操作 volatile 变量都是直接操作主存。即一个线程对 volatile 变量的修改，对另一个线程可见。</p><blockquote><p><strong>注意</strong></p><p>volatile 仅仅保证了共享变量的可见性，让其它线程能够看到最新值，但不能解决指令交错问题（不能保证原 子性）</p></blockquote><p>CAS 必须借助 volatile 才能读取到共享变量的最新值来实现【比较并交换】的效果。</p><p><strong>为什么无锁效率高</strong></p><ul><li>无锁情况下，即使重试失败，线程始终在高速运行，没有停歇，类似于自旋。而 synchronized 会让线程在没有获得锁的时候，发生上下文切换，进入阻塞。线程的上下文切换是费时的，在重试次数不是太多时，无锁的效率高于有锁。</li><li>线程就好像高速跑道上的赛车，高速运行时，速度超快，一旦发生上下文切换，就好比赛车要减速、熄火， 等被唤醒又得重新打火、启动、加速&mldr; 恢复到高速运行，代价比较大</li><li>但无锁情况下，因为线程要保持运行，需要额外 CPU 的支持，CPU 在这里就好比高速跑道，没有额外的跑 道，线程想高速运行也无从谈起，虽然不会进入阻塞，但由于没有分到时间片，仍然会进入可运行状态，还 是会导致上下文切换。所以总的来说，当线程数小于等于cpu核心数时，使用无锁方案是很合适的，因为有足够多的cpu让线程运行。当线程数远多于cpu核心数时，无锁效率相比于有锁就没有太大优势，因为依旧会发生上下文切换。</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220308200536875.png width=900 height=600 loading=lazy decoding=async alt=image-20220308200536875 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=cas-的特点><a href=#cas-%e7%9a%84%e7%89%b9%e7%82%b9 class=header-anchor>#</a>
CAS 的特点</h5><p>结合 CAS 和 volatile 可以实现无锁并发，适用于线程数少、多核 CPU 的场景下。</p><ul><li>CAS 是基于乐观锁的思想：最乐观的估计，不怕别的线程来修改共享变量，就算改了也没关系，我吃亏点再 重试呗。</li><li>synchronized 是基于悲观锁的思想：最悲观的估计，得防着其它线程来修改共享变量，我上了锁你们都别想 改，我改完了解开锁，你们才有机会。</li><li>CAS 体现的是无锁并发、无阻塞并发，请仔细体会这两句话的意思<ul><li>因为没有使用 synchronized，所以线程不会陷入阻塞，这是效率提升的因素之一</li><li>但如果竞争激烈，可以想到重试必然频繁发生，反而效率会受影响</li></ul></li></ul><h2 id=63-原子整数><a href=#63-%e5%8e%9f%e5%ad%90%e6%95%b4%e6%95%b0 class=header-anchor>#</a>
6.3 原子整数</h2><p>J.U.C 并发包提供了：</p><ul><li>AtomicBoolean</li><li>AtomicInteger</li><li>AtomicLong</li></ul><p>以 AtomicInteger 为例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-285-1><a class=lnlinks href=#hl-285-1> 1</a>
</span><span class=lnt id=hl-285-2><a class=lnlinks href=#hl-285-2> 2</a>
</span><span class=lnt id=hl-285-3><a class=lnlinks href=#hl-285-3> 3</a>
</span><span class=lnt id=hl-285-4><a class=lnlinks href=#hl-285-4> 4</a>
</span><span class=lnt id=hl-285-5><a class=lnlinks href=#hl-285-5> 5</a>
</span><span class=lnt id=hl-285-6><a class=lnlinks href=#hl-285-6> 6</a>
</span><span class=lnt id=hl-285-7><a class=lnlinks href=#hl-285-7> 7</a>
</span><span class=lnt id=hl-285-8><a class=lnlinks href=#hl-285-8> 8</a>
</span><span class=lnt id=hl-285-9><a class=lnlinks href=#hl-285-9> 9</a>
</span><span class=lnt id=hl-285-10><a class=lnlinks href=#hl-285-10>10</a>
</span><span class=lnt id=hl-285-11><a class=lnlinks href=#hl-285-11>11</a>
</span><span class=lnt id=hl-285-12><a class=lnlinks href=#hl-285-12>12</a>
</span><span class=lnt id=hl-285-13><a class=lnlinks href=#hl-285-13>13</a>
</span><span class=lnt id=hl-285-14><a class=lnlinks href=#hl-285-14>14</a>
</span><span class=lnt id=hl-285-15><a class=lnlinks href=#hl-285-15>15</a>
</span><span class=lnt id=hl-285-16><a class=lnlinks href=#hl-285-16>16</a>
</span><span class=lnt id=hl-285-17><a class=lnlinks href=#hl-285-17>17</a>
</span><span class=lnt id=hl-285-18><a class=lnlinks href=#hl-285-18>18</a>
</span><span class=lnt id=hl-285-19><a class=lnlinks href=#hl-285-19>19</a>
</span><span class=lnt id=hl-285-20><a class=lnlinks href=#hl-285-20>20</a>
</span><span class=lnt id=hl-285-21><a class=lnlinks href=#hl-285-21>21</a>
</span><span class=lnt id=hl-285-22><a class=lnlinks href=#hl-285-22>22</a>
</span><span class=lnt id=hl-285-23><a class=lnlinks href=#hl-285-23>23</a>
</span><span class=lnt id=hl-285-24><a class=lnlinks href=#hl-285-24>24</a>
</span><span class=lnt id=hl-285-25><a class=lnlinks href=#hl-285-25>25</a>
</span><span class=lnt id=hl-285-26><a class=lnlinks href=#hl-285-26>26</a>
</span><span class=lnt id=hl-285-27><a class=lnlinks href=#hl-285-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>AtomicInteger</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获取并自增（i = 0, 结果 i = 1, 返回 0），类似于 i++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 自增并获取（i = 1, 结果 i = 2, 返回 2），类似于 ++i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 自减并获取（i = 2, 结果 i = 1, 返回 1），类似于 --i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获取并自减（i = 1, 结果 i = 0, 返回 1），类似于 i--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>getAndDecrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获取并加值（i = 0, 结果 i = 5, 返回 0）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>getAndAdd</span><span class=p>(</span><span class=n>5</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 加值并获取（i = 5, 结果 i = 0, 返回 0）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>addAndGet</span><span class=p>(</span><span class=o>-</span><span class=n>5</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获取并更新（i = 0, p 为 i 的当前值, 结果 i = -2, 返回 0）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 其中函数中的操作能保证原子，但函数需要无副作用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>getAndUpdate</span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>2</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 更新并获取（i = -2, p 为 i 的当前值, 结果 i = 0, 返回 0）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 其中函数中的操作能保证原子，但函数需要无副作用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>updateAndGet</span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>2</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获取并计算（i = 0, p 为 i 的当前值, x 为参数1, 结果 i = 10, 返回 0）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 其中函数中的操作能保证原子，但函数需要无副作用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// getAndUpdate 如果在 lambda 中引用了外部的局部变量，要保证该局部变量是 final 的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// getAndAccumulate 可以通过 参数1 来引用外部的局部变量，但因为其不在 lambda 中因此不必是 final</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>getAndAccumulate</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 计算并获取（i = 10, p 为 i 的当前值, x 为参数1, 结果 i = 0, 返回 0）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 其中函数中的操作能保证原子，但函数需要无副作用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>accumulateAndGet</span><span class=p>(</span><span class=o>-</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>说明：</p><ul><li><p>以上方法都是以CAS为基础进行了封装，保证了方法的原子性和变量的可见性。</p></li><li><p>updateAndGet方法的手动实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-286-1><a class=lnlinks href=#hl-286-1>1</a>
</span><span class=lnt id=hl-286-2><a class=lnlinks href=#hl-286-2>2</a>
</span><span class=lnt id=hl-286-3><a class=lnlinks href=#hl-286-3>3</a>
</span><span class=lnt id=hl-286-4><a class=lnlinks href=#hl-286-4>4</a>
</span><span class=lnt id=hl-286-5><a class=lnlinks href=#hl-286-5>5</a>
</span><span class=lnt id=hl-286-6><a class=lnlinks href=#hl-286-6>6</a>
</span><span class=lnt id=hl-286-7><a class=lnlinks href=#hl-286-7>7</a>
</span><span class=lnt id=hl-286-8><a class=lnlinks href=#hl-286-8>8</a>
</span><span class=lnt id=hl-286-9><a class=lnlinks href=#hl-286-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>updateAndGet</span><span class=p>(</span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>IntUnaryOperator</span><span class=w> </span><span class=n>operator</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operator</span><span class=p>.</span><span class=na>applyAsInt</span><span class=p>(</span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=n>next</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=64-原子引用><a href=#64-%e5%8e%9f%e5%ad%90%e5%bc%95%e7%94%a8 class=header-anchor>#</a>
6.4 原子引用</h2><p>为什么需要原子引用类型？</p><ul><li>AtomicReference</li><li>AtomicMarkableReference</li><li>AtomicStampedReference</li></ul><p>实际开发的过程中我们使用的不一定是int、long等基本数据类型，也有可能时BigDecimal这样的类型，这时就需要用到原子引用作为容器。原子引用设置值使用的是<code>unsafe.compareAndSwapObject()</code>方法。原子引用中表示数据的类型需要重写<code>equals()</code>方法。</p><p>有如下方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-287-1><a class=lnlinks href=#hl-287-1> 1</a>
</span><span class=lnt id=hl-287-2><a class=lnlinks href=#hl-287-2> 2</a>
</span><span class=lnt id=hl-287-3><a class=lnlinks href=#hl-287-3> 3</a>
</span><span class=lnt id=hl-287-4><a class=lnlinks href=#hl-287-4> 4</a>
</span><span class=lnt id=hl-287-5><a class=lnlinks href=#hl-287-5> 5</a>
</span><span class=lnt id=hl-287-6><a class=lnlinks href=#hl-287-6> 6</a>
</span><span class=lnt id=hl-287-7><a class=lnlinks href=#hl-287-7> 7</a>
</span><span class=lnt id=hl-287-8><a class=lnlinks href=#hl-287-8> 8</a>
</span><span class=lnt id=hl-287-9><a class=lnlinks href=#hl-287-9> 9</a>
</span><span class=lnt id=hl-287-10><a class=lnlinks href=#hl-287-10>10</a>
</span><span class=lnt id=hl-287-11><a class=lnlinks href=#hl-287-11>11</a>
</span><span class=lnt id=hl-287-12><a class=lnlinks href=#hl-287-12>12</a>
</span><span class=lnt id=hl-287-13><a class=lnlinks href=#hl-287-13>13</a>
</span><span class=lnt id=hl-287-14><a class=lnlinks href=#hl-287-14>14</a>
</span><span class=lnt id=hl-287-15><a class=lnlinks href=#hl-287-15>15</a>
</span><span class=lnt id=hl-287-16><a class=lnlinks href=#hl-287-16>16</a>
</span><span class=lnt id=hl-287-17><a class=lnlinks href=#hl-287-17>17</a>
</span><span class=lnt id=hl-287-18><a class=lnlinks href=#hl-287-18>18</a>
</span><span class=lnt id=hl-287-19><a class=lnlinks href=#hl-287-19>19</a>
</span><span class=lnt id=hl-287-20><a class=lnlinks href=#hl-287-20>20</a>
</span><span class=lnt id=hl-287-21><a class=lnlinks href=#hl-287-21>21</a>
</span><span class=lnt id=hl-287-22><a class=lnlinks href=#hl-287-22>22</a>
</span><span class=lnt id=hl-287-23><a class=lnlinks href=#hl-287-23>23</a>
</span><span class=lnt id=hl-287-24><a class=lnlinks href=#hl-287-24>24</a>
</span><span class=lnt id=hl-287-25><a class=lnlinks href=#hl-287-25>25</a>
</span><span class=lnt id=hl-287-26><a class=lnlinks href=#hl-287-26>26</a>
</span><span class=lnt id=hl-287-27><a class=lnlinks href=#hl-287-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>DecimalAccount</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取余额</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BigDecimal</span><span class=w> </span><span class=nf>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 取款</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作
</span></span></span><span class=line><span class=cl><span class=cm> * 如果初始余额为 10000 那么正确的结果应当是 0
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo</span><span class=p>(</span><span class=n>DecimalAccount</span><span class=w> </span><span class=n>account</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ts</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>account</span><span class=p>.</span><span class=na>withdraw</span><span class=p>(</span><span class=n>BigDecimal</span><span class=p>.</span><span class=na>TEN</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>Thread</span><span class=p>::</span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>试着提供不同的 DecimalAccount 实现，实现安全的取款操作</p><h5 id=不安全实现><a href=#%e4%b8%8d%e5%ae%89%e5%85%a8%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
<strong>不安全实现</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-288-1><a class=lnlinks href=#hl-288-1> 1</a>
</span><span class=lnt id=hl-288-2><a class=lnlinks href=#hl-288-2> 2</a>
</span><span class=lnt id=hl-288-3><a class=lnlinks href=#hl-288-3> 3</a>
</span><span class=lnt id=hl-288-4><a class=lnlinks href=#hl-288-4> 4</a>
</span><span class=lnt id=hl-288-5><a class=lnlinks href=#hl-288-5> 5</a>
</span><span class=lnt id=hl-288-6><a class=lnlinks href=#hl-288-6> 6</a>
</span><span class=lnt id=hl-288-7><a class=lnlinks href=#hl-288-7> 7</a>
</span><span class=lnt id=hl-288-8><a class=lnlinks href=#hl-288-8> 8</a>
</span><span class=lnt id=hl-288-9><a class=lnlinks href=#hl-288-9> 9</a>
</span><span class=lnt id=hl-288-10><a class=lnlinks href=#hl-288-10>10</a>
</span><span class=lnt id=hl-288-11><a class=lnlinks href=#hl-288-11>11</a>
</span><span class=lnt id=hl-288-12><a class=lnlinks href=#hl-288-12>12</a>
</span><span class=lnt id=hl-288-13><a class=lnlinks href=#hl-288-13>13</a>
</span><span class=lnt id=hl-288-14><a class=lnlinks href=#hl-288-14>14</a>
</span><span class=lnt id=hl-288-15><a class=lnlinks href=#hl-288-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DecimalAccountUnsafe</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DecimalAccount</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DecimalAccountUnsafe</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>subtract</span><span class=p>(</span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=安全实现-使用锁><a href=#%e5%ae%89%e5%85%a8%e5%ae%9e%e7%8e%b0-%e4%bd%bf%e7%94%a8%e9%94%81 class=header-anchor>#</a>
<strong>安全实现-使用锁</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-289-1><a class=lnlinks href=#hl-289-1> 1</a>
</span><span class=lnt id=hl-289-2><a class=lnlinks href=#hl-289-2> 2</a>
</span><span class=lnt id=hl-289-3><a class=lnlinks href=#hl-289-3> 3</a>
</span><span class=lnt id=hl-289-4><a class=lnlinks href=#hl-289-4> 4</a>
</span><span class=lnt id=hl-289-5><a class=lnlinks href=#hl-289-5> 5</a>
</span><span class=lnt id=hl-289-6><a class=lnlinks href=#hl-289-6> 6</a>
</span><span class=lnt id=hl-289-7><a class=lnlinks href=#hl-289-7> 7</a>
</span><span class=lnt id=hl-289-8><a class=lnlinks href=#hl-289-8> 8</a>
</span><span class=lnt id=hl-289-9><a class=lnlinks href=#hl-289-9> 9</a>
</span><span class=lnt id=hl-289-10><a class=lnlinks href=#hl-289-10>10</a>
</span><span class=lnt id=hl-289-11><a class=lnlinks href=#hl-289-11>11</a>
</span><span class=lnt id=hl-289-12><a class=lnlinks href=#hl-289-12>12</a>
</span><span class=lnt id=hl-289-13><a class=lnlinks href=#hl-289-13>13</a>
</span><span class=lnt id=hl-289-14><a class=lnlinks href=#hl-289-14>14</a>
</span><span class=lnt id=hl-289-15><a class=lnlinks href=#hl-289-15>15</a>
</span><span class=lnt id=hl-289-16><a class=lnlinks href=#hl-289-16>16</a>
</span><span class=lnt id=hl-289-17><a class=lnlinks href=#hl-289-17>17</a>
</span><span class=lnt id=hl-289-18><a class=lnlinks href=#hl-289-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DecimalAccountSafeLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DecimalAccount</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DecimalAccountSafeLock</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>subtract</span><span class=p>(</span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=安全实现-使用-cas><a href=#%e5%ae%89%e5%85%a8%e5%ae%9e%e7%8e%b0-%e4%bd%bf%e7%94%a8-cas class=header-anchor>#</a>
<strong>安全实现-使用 CAS</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-290-1><a class=lnlinks href=#hl-290-1> 1</a>
</span><span class=lnt id=hl-290-2><a class=lnlinks href=#hl-290-2> 2</a>
</span><span class=lnt id=hl-290-3><a class=lnlinks href=#hl-290-3> 3</a>
</span><span class=lnt id=hl-290-4><a class=lnlinks href=#hl-290-4> 4</a>
</span><span class=lnt id=hl-290-5><a class=lnlinks href=#hl-290-5> 5</a>
</span><span class=lnt id=hl-290-6><a class=lnlinks href=#hl-290-6> 6</a>
</span><span class=lnt id=hl-290-7><a class=lnlinks href=#hl-290-7> 7</a>
</span><span class=lnt id=hl-290-8><a class=lnlinks href=#hl-290-8> 8</a>
</span><span class=lnt id=hl-290-9><a class=lnlinks href=#hl-290-9> 9</a>
</span><span class=lnt id=hl-290-10><a class=lnlinks href=#hl-290-10>10</a>
</span><span class=lnt id=hl-290-11><a class=lnlinks href=#hl-290-11>11</a>
</span><span class=lnt id=hl-290-12><a class=lnlinks href=#hl-290-12>12</a>
</span><span class=lnt id=hl-290-13><a class=lnlinks href=#hl-290-13>13</a>
</span><span class=lnt id=hl-290-14><a class=lnlinks href=#hl-290-14>14</a>
</span><span class=lnt id=hl-290-15><a class=lnlinks href=#hl-290-15>15</a>
</span><span class=lnt id=hl-290-16><a class=lnlinks href=#hl-290-16>16</a>
</span><span class=lnt id=hl-290-17><a class=lnlinks href=#hl-290-17>17</a>
</span><span class=lnt id=hl-290-18><a class=lnlinks href=#hl-290-18>18</a>
</span><span class=lnt id=hl-290-19><a class=lnlinks href=#hl-290-19>19</a>
</span><span class=lnt id=hl-290-20><a class=lnlinks href=#hl-290-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DecimalAccountSafeCas</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DecimalAccount</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>BigDecimal</span><span class=o>&gt;</span><span class=w> </span><span class=n>ref</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DecimalAccountSafeCas</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prev</span><span class=p>.</span><span class=na>subtract</span><span class=p>(</span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-291-1><a class=lnlinks href=#hl-291-1>1</a>
</span><span class=lnt id=hl-291-2><a class=lnlinks href=#hl-291-2>2</a>
</span><span class=lnt id=hl-291-3><a class=lnlinks href=#hl-291-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>DecimalAccount.demo<span class=o>(</span>new DecimalAccountUnsafe<span class=o>(</span>new BigDecimal<span class=o>(</span><span class=s2>&#34;10000&#34;</span><span class=o>)))</span><span class=p>;</span>
</span></span><span class=line><span class=cl>DecimalAccount.demo<span class=o>(</span>new DecimalAccountSafeLock<span class=o>(</span>new BigDecimal<span class=o>(</span><span class=s2>&#34;10000&#34;</span><span class=o>)))</span><span class=p>;</span>
</span></span><span class=line><span class=cl>DecimalAccount.demo<span class=o>(</span>new DecimalAccountSafeCas<span class=o>(</span>new BigDecimal<span class=o>(</span><span class=s2>&#34;10000&#34;</span><span class=o>)))</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>运行结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-292-1><a class=lnlinks href=#hl-292-1>1</a>
</span><span class=lnt id=hl-292-2><a class=lnlinks href=#hl-292-2>2</a>
</span><span class=lnt id=hl-292-3><a class=lnlinks href=#hl-292-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>4310</span> cost: <span class=m>425</span> ms 
</span></span><span class=line><span class=cl><span class=m>0</span> cost: <span class=m>285</span> ms 
</span></span><span class=line><span class=cl><span class=m>0</span> cost: <span class=m>274</span> ms
</span></span></code></pre></td></tr></table></div></div><h5 id=aba-问题及解决><a href=#aba-%e9%97%ae%e9%a2%98%e5%8f%8a%e8%a7%a3%e5%86%b3 class=header-anchor>#</a>
ABA 问题及解决</h5><p><strong>ABA 问题</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-293-1><a class=lnlinks href=#hl-293-1> 1</a>
</span><span class=lnt id=hl-293-2><a class=lnlinks href=#hl-293-2> 2</a>
</span><span class=lnt id=hl-293-3><a class=lnlinks href=#hl-293-3> 3</a>
</span><span class=lnt id=hl-293-4><a class=lnlinks href=#hl-293-4> 4</a>
</span><span class=lnt id=hl-293-5><a class=lnlinks href=#hl-293-5> 5</a>
</span><span class=lnt id=hl-293-6><a class=lnlinks href=#hl-293-6> 6</a>
</span><span class=lnt id=hl-293-7><a class=lnlinks href=#hl-293-7> 7</a>
</span><span class=lnt id=hl-293-8><a class=lnlinks href=#hl-293-8> 8</a>
</span><span class=lnt id=hl-293-9><a class=lnlinks href=#hl-293-9> 9</a>
</span><span class=lnt id=hl-293-10><a class=lnlinks href=#hl-293-10>10</a>
</span><span class=lnt id=hl-293-11><a class=lnlinks href=#hl-293-11>11</a>
</span><span class=lnt id=hl-293-12><a class=lnlinks href=#hl-293-12>12</a>
</span><span class=lnt id=hl-293-13><a class=lnlinks href=#hl-293-13>13</a>
</span><span class=lnt id=hl-293-14><a class=lnlinks href=#hl-293-14>14</a>
</span><span class=lnt id=hl-293-15><a class=lnlinks href=#hl-293-15>15</a>
</span><span class=lnt id=hl-293-16><a class=lnlinks href=#hl-293-16>16</a>
</span><span class=lnt id=hl-293-17><a class=lnlinks href=#hl-293-17>17</a>
</span><span class=lnt id=hl-293-18><a class=lnlinks href=#hl-293-18>18</a>
</span><span class=lnt id=hl-293-19><a class=lnlinks href=#hl-293-19>19</a>
</span><span class=lnt id=hl-293-20><a class=lnlinks href=#hl-293-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=s>&#34;A&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;main start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取值 A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 这个共享变量被它线程修改过？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>other</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试改为 C</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change A-&gt;C {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>other</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change A-&gt;B {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;B&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change B-&gt;A {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;A&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-294-1><a class=lnlinks href=#hl-294-1>1</a>
</span><span class=lnt id=hl-294-2><a class=lnlinks href=#hl-294-2>2</a>
</span><span class=lnt id=hl-294-3><a class=lnlinks href=#hl-294-3>3</a>
</span><span class=lnt id=hl-294-4><a class=lnlinks href=#hl-294-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:29:52.325 c.Test36 <span class=o>[</span>main<span class=o>]</span> - main start... 
</span></span><span class=line><span class=cl>11:29:52.379 c.Test36 <span class=o>[</span>t1<span class=o>]</span> - change A-&gt;B <span class=nb>true</span> 
</span></span><span class=line><span class=cl>11:29:52.879 c.Test36 <span class=o>[</span>t2<span class=o>]</span> - change B-&gt;A <span class=nb>true</span> 
</span></span><span class=line><span class=cl>11:29:53.880 c.Test36 <span class=o>[</span>main<span class=o>]</span> - change A-&gt;C <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><p>主线程仅能判断出共享变量的值与最初值 A 是否相同，不能感知到这种从 A 改为 B 又 改回 A 的情况，如果主线程 希望：</p><p>只要有其它线程【动过了】共享变量，那么自己的 cas 就算失败，这时，仅比较值是不够的，需要再加一个版本号</p><p><strong>AtomicStampedReference</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-295-1><a class=lnlinks href=#hl-295-1> 1</a>
</span><span class=lnt id=hl-295-2><a class=lnlinks href=#hl-295-2> 2</a>
</span><span class=lnt id=hl-295-3><a class=lnlinks href=#hl-295-3> 3</a>
</span><span class=lnt id=hl-295-4><a class=lnlinks href=#hl-295-4> 4</a>
</span><span class=lnt id=hl-295-5><a class=lnlinks href=#hl-295-5> 5</a>
</span><span class=lnt id=hl-295-6><a class=lnlinks href=#hl-295-6> 6</a>
</span><span class=lnt id=hl-295-7><a class=lnlinks href=#hl-295-7> 7</a>
</span><span class=lnt id=hl-295-8><a class=lnlinks href=#hl-295-8> 8</a>
</span><span class=lnt id=hl-295-9><a class=lnlinks href=#hl-295-9> 9</a>
</span><span class=lnt id=hl-295-10><a class=lnlinks href=#hl-295-10>10</a>
</span><span class=lnt id=hl-295-11><a class=lnlinks href=#hl-295-11>11</a>
</span><span class=lnt id=hl-295-12><a class=lnlinks href=#hl-295-12>12</a>
</span><span class=lnt id=hl-295-13><a class=lnlinks href=#hl-295-13>13</a>
</span><span class=lnt id=hl-295-14><a class=lnlinks href=#hl-295-14>14</a>
</span><span class=lnt id=hl-295-15><a class=lnlinks href=#hl-295-15>15</a>
</span><span class=lnt id=hl-295-16><a class=lnlinks href=#hl-295-16>16</a>
</span><span class=lnt id=hl-295-17><a class=lnlinks href=#hl-295-17>17</a>
</span><span class=lnt id=hl-295-18><a class=lnlinks href=#hl-295-18>18</a>
</span><span class=lnt id=hl-295-19><a class=lnlinks href=#hl-295-19>19</a>
</span><span class=lnt id=hl-295-20><a class=lnlinks href=#hl-295-20>20</a>
</span><span class=lnt id=hl-295-21><a class=lnlinks href=#hl-295-21>21</a>
</span><span class=lnt id=hl-295-22><a class=lnlinks href=#hl-295-22>22</a>
</span><span class=lnt id=hl-295-23><a class=lnlinks href=#hl-295-23>23</a>
</span><span class=lnt id=hl-295-24><a class=lnlinks href=#hl-295-24>24</a>
</span><span class=lnt id=hl-295-25><a class=lnlinks href=#hl-295-25>25</a>
</span><span class=lnt id=hl-295-26><a class=lnlinks href=#hl-295-26>26</a>
</span><span class=lnt id=hl-295-27><a class=lnlinks href=#hl-295-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>AtomicStampedReference</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicStampedReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=s>&#34;A&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;main start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取值 A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getReference</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获取版本号</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;版本 {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果中间有其它线程干扰，发生了 ABA 现象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>other</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试改为 C</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change A-&gt;C {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>other</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change A-&gt;B {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>getReference</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;B&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                                      </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>(),</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;更新版本为 {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change B-&gt;A {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>getReference</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;A&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                                      </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>(),</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;更新版本为 {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-296-1><a class=lnlinks href=#hl-296-1>1</a>
</span><span class=lnt id=hl-296-2><a class=lnlinks href=#hl-296-2>2</a>
</span><span class=lnt id=hl-296-3><a class=lnlinks href=#hl-296-3>3</a>
</span><span class=lnt id=hl-296-4><a class=lnlinks href=#hl-296-4>4</a>
</span><span class=lnt id=hl-296-5><a class=lnlinks href=#hl-296-5>5</a>
</span><span class=lnt id=hl-296-6><a class=lnlinks href=#hl-296-6>6</a>
</span><span class=lnt id=hl-296-7><a class=lnlinks href=#hl-296-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>15:41:34.891 c.Test36 <span class=o>[</span>main<span class=o>]</span> - main start... 
</span></span><span class=line><span class=cl>15:41:34.894 c.Test36 <span class=o>[</span>main<span class=o>]</span> - 版本 <span class=m>0</span> 
</span></span><span class=line><span class=cl>15:41:34.956 c.Test36 <span class=o>[</span>t1<span class=o>]</span> - change A-&gt;B <span class=nb>true</span> 
</span></span><span class=line><span class=cl>15:41:34.956 c.Test36 <span class=o>[</span>t1<span class=o>]</span> - 更新版本为 <span class=m>1</span> 
</span></span><span class=line><span class=cl>15:41:35.457 c.Test36 <span class=o>[</span>t2<span class=o>]</span> - change B-&gt;A <span class=nb>true</span> 
</span></span><span class=line><span class=cl>15:41:35.457 c.Test36 <span class=o>[</span>t2<span class=o>]</span> - 更新版本为 <span class=m>2</span> 
</span></span><span class=line><span class=cl>15:41:36.457 c.Test36 <span class=o>[</span>main<span class=o>]</span> - change A-&gt;C <span class=nb>false</span> 
</span></span></code></pre></td></tr></table></div></div><p>AtomicStampedReference 可以给原子引用加上版本号，追踪原子引用整个的变化过程，如： <code>A -> B -> A -> C</code> ，通过AtomicStampedReference，我们可以知道，引用变量中途被更改了几次。</p><p>但是有时候，并不关心引用变量更改了几次，只是单纯的关心是否更改过，所以就有了 AtomicMarkableReference</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-297-1><a class=lnlinks href=#hl-297-1> 1</a>
</span><span class=lnt id=hl-297-2><a class=lnlinks href=#hl-297-2> 2</a>
</span><span class=lnt id=hl-297-3><a class=lnlinks href=#hl-297-3> 3</a>
</span><span class=lnt id=hl-297-4><a class=lnlinks href=#hl-297-4> 4</a>
</span><span class=lnt id=hl-297-5><a class=lnlinks href=#hl-297-5> 5</a>
</span><span class=lnt id=hl-297-6><a class=lnlinks href=#hl-297-6> 6</a>
</span><span class=lnt id=hl-297-7><a class=lnlinks href=#hl-297-7> 7</a>
</span><span class=lnt id=hl-297-8><a class=lnlinks href=#hl-297-8> 8</a>
</span><span class=lnt id=hl-297-9><a class=lnlinks href=#hl-297-9> 9</a>
</span><span class=lnt id=hl-297-10><a class=lnlinks href=#hl-297-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph TD
</span></span><span class=line><span class=cl>s(保洁阿姨)
</span></span><span class=line><span class=cl>m(主人)
</span></span><span class=line><span class=cl>g1(垃圾袋)
</span></span><span class=line><span class=cl>g2(新垃圾袋)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>s -. 倒空 .-&gt; g1
</span></span><span class=line><span class=cl>m -- 检查 --&gt; g1
</span></span><span class=line><span class=cl>g1 -- 已满 --&gt; g2
</span></span><span class=line><span class=cl>g1 -- 还空 --&gt; g1
</span></span></code></pre></td></tr></table></div></div><p><strong>AtomicMarkableReference</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-298-1><a class=lnlinks href=#hl-298-1> 1</a>
</span><span class=lnt id=hl-298-2><a class=lnlinks href=#hl-298-2> 2</a>
</span><span class=lnt id=hl-298-3><a class=lnlinks href=#hl-298-3> 3</a>
</span><span class=lnt id=hl-298-4><a class=lnlinks href=#hl-298-4> 4</a>
</span><span class=lnt id=hl-298-5><a class=lnlinks href=#hl-298-5> 5</a>
</span><span class=lnt id=hl-298-6><a class=lnlinks href=#hl-298-6> 6</a>
</span><span class=lnt id=hl-298-7><a class=lnlinks href=#hl-298-7> 7</a>
</span><span class=lnt id=hl-298-8><a class=lnlinks href=#hl-298-8> 8</a>
</span><span class=lnt id=hl-298-9><a class=lnlinks href=#hl-298-9> 9</a>
</span><span class=lnt id=hl-298-10><a class=lnlinks href=#hl-298-10>10</a>
</span><span class=lnt id=hl-298-11><a class=lnlinks href=#hl-298-11>11</a>
</span><span class=lnt id=hl-298-12><a class=lnlinks href=#hl-298-12>12</a>
</span><span class=lnt id=hl-298-13><a class=lnlinks href=#hl-298-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>GarbageBag</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>desc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>GarbageBag</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>desc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>desc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setDesc</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>desc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>desc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>desc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-299-1><a class=lnlinks href=#hl-299-1> 1</a>
</span><span class=lnt id=hl-299-2><a class=lnlinks href=#hl-299-2> 2</a>
</span><span class=lnt id=hl-299-3><a class=lnlinks href=#hl-299-3> 3</a>
</span><span class=lnt id=hl-299-4><a class=lnlinks href=#hl-299-4> 4</a>
</span><span class=lnt id=hl-299-5><a class=lnlinks href=#hl-299-5> 5</a>
</span><span class=lnt id=hl-299-6><a class=lnlinks href=#hl-299-6> 6</a>
</span><span class=lnt id=hl-299-7><a class=lnlinks href=#hl-299-7> 7</a>
</span><span class=lnt id=hl-299-8><a class=lnlinks href=#hl-299-8> 8</a>
</span><span class=lnt id=hl-299-9><a class=lnlinks href=#hl-299-9> 9</a>
</span><span class=lnt id=hl-299-10><a class=lnlinks href=#hl-299-10>10</a>
</span><span class=lnt id=hl-299-11><a class=lnlinks href=#hl-299-11>11</a>
</span><span class=lnt id=hl-299-12><a class=lnlinks href=#hl-299-12>12</a>
</span><span class=lnt id=hl-299-13><a class=lnlinks href=#hl-299-13>13</a>
</span><span class=lnt id=hl-299-14><a class=lnlinks href=#hl-299-14>14</a>
</span><span class=lnt id=hl-299-15><a class=lnlinks href=#hl-299-15>15</a>
</span><span class=lnt id=hl-299-16><a class=lnlinks href=#hl-299-16>16</a>
</span><span class=lnt id=hl-299-17><a class=lnlinks href=#hl-299-17>17</a>
</span><span class=lnt id=hl-299-18><a class=lnlinks href=#hl-299-18>18</a>
</span><span class=lnt id=hl-299-19><a class=lnlinks href=#hl-299-19>19</a>
</span><span class=lnt id=hl-299-20><a class=lnlinks href=#hl-299-20>20</a>
</span><span class=lnt id=hl-299-21><a class=lnlinks href=#hl-299-21>21</a>
</span><span class=lnt id=hl-299-22><a class=lnlinks href=#hl-299-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestABAAtomicMarkableReference</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GarbageBag</span><span class=w> </span><span class=n>bag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GarbageBag</span><span class=p>(</span><span class=s>&#34;装满了垃圾&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 参数2 mark 可以看作一个标记，表示垃圾袋满了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AtomicMarkableReference</span><span class=o>&lt;</span><span class=n>GarbageBag</span><span class=o>&gt;</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicMarkableReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>bag</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;主线程 start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GarbageBag</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getReference</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>prev</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;打扫卫生的线程 start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bag</span><span class=p>.</span><span class=na>setDesc</span><span class=p>(</span><span class=s>&#34;空垃圾袋&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>bag</span><span class=p>,</span><span class=w> </span><span class=n>bag</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>))</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>bag</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;主线程想换一只新垃圾袋？&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>success</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GarbageBag</span><span class=p>(</span><span class=s>&#34;空垃圾袋&#34;</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;换了么？&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>success</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>getReference</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-300-1><a class=lnlinks href=#hl-300-1>1</a>
</span><span class=lnt id=hl-300-2><a class=lnlinks href=#hl-300-2>2</a>
</span><span class=lnt id=hl-300-3><a class=lnlinks href=#hl-300-3>3</a>
</span><span class=lnt id=hl-300-4><a class=lnlinks href=#hl-300-4>4</a>
</span><span class=lnt id=hl-300-5><a class=lnlinks href=#hl-300-5>5</a>
</span><span class=lnt id=hl-300-6><a class=lnlinks href=#hl-300-6>6</a>
</span><span class=lnt id=hl-300-7><a class=lnlinks href=#hl-300-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>2019-10-13 15:30:09.264 <span class=o>[</span>main<span class=o>]</span> 主线程 start... 
</span></span><span class=line><span class=cl>2019-10-13 15:30:09.270 <span class=o>[</span>main<span class=o>]</span> cn.itcast.GarbageBag@5f0fd5a0 装满了垃圾
</span></span><span class=line><span class=cl>2019-10-13 15:30:09.293 <span class=o>[</span>Thread-1<span class=o>]</span> 打扫卫生的线程 start... 
</span></span><span class=line><span class=cl>2019-10-13 15:30:09.294 <span class=o>[</span>Thread-1<span class=o>]</span> cn.itcast.GarbageBag@5f0fd5a0 空垃圾袋
</span></span><span class=line><span class=cl>2019-10-13 15:30:10.294 <span class=o>[</span>main<span class=o>]</span> 主线程想换一只新垃圾袋？
</span></span><span class=line><span class=cl>2019-10-13 15:30:10.294 <span class=o>[</span>main<span class=o>]</span> 换了么？false 
</span></span><span class=line><span class=cl>2019-10-13 15:30:10.294 <span class=o>[</span>main<span class=o>]</span> cn.itcast.GarbageBag@5f0fd5a0 空垃圾袋
</span></span></code></pre></td></tr></table></div></div><p>可以注释掉打扫卫生线程代码，再观察输出</p><h2 id=65-原子数组><a href=#65-%e5%8e%9f%e5%ad%90%e6%95%b0%e7%bb%84 class=header-anchor>#</a>
6.5 原子数组</h2><ul><li>AtomicIntegerArray</li><li>AtomicLongArray</li><li>AtomicReferenceArray</li></ul><p>有如下方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-301-1><a class=lnlinks href=#hl-301-1> 1</a>
</span><span class=lnt id=hl-301-2><a class=lnlinks href=#hl-301-2> 2</a>
</span><span class=lnt id=hl-301-3><a class=lnlinks href=#hl-301-3> 3</a>
</span><span class=lnt id=hl-301-4><a class=lnlinks href=#hl-301-4> 4</a>
</span><span class=lnt id=hl-301-5><a class=lnlinks href=#hl-301-5> 5</a>
</span><span class=lnt id=hl-301-6><a class=lnlinks href=#hl-301-6> 6</a>
</span><span class=lnt id=hl-301-7><a class=lnlinks href=#hl-301-7> 7</a>
</span><span class=lnt id=hl-301-8><a class=lnlinks href=#hl-301-8> 8</a>
</span><span class=lnt id=hl-301-9><a class=lnlinks href=#hl-301-9> 9</a>
</span><span class=lnt id=hl-301-10><a class=lnlinks href=#hl-301-10>10</a>
</span><span class=lnt id=hl-301-11><a class=lnlinks href=#hl-301-11>11</a>
</span><span class=lnt id=hl-301-12><a class=lnlinks href=#hl-301-12>12</a>
</span><span class=lnt id=hl-301-13><a class=lnlinks href=#hl-301-13>13</a>
</span><span class=lnt id=hl-301-14><a class=lnlinks href=#hl-301-14>14</a>
</span><span class=lnt id=hl-301-15><a class=lnlinks href=#hl-301-15>15</a>
</span><span class=lnt id=hl-301-16><a class=lnlinks href=#hl-301-16>16</a>
</span><span class=lnt id=hl-301-17><a class=lnlinks href=#hl-301-17>17</a>
</span><span class=lnt id=hl-301-18><a class=lnlinks href=#hl-301-18>18</a>
</span><span class=lnt id=hl-301-19><a class=lnlinks href=#hl-301-19>19</a>
</span><span class=lnt id=hl-301-20><a class=lnlinks href=#hl-301-20>20</a>
</span><span class=lnt id=hl-301-21><a class=lnlinks href=#hl-301-21>21</a>
</span><span class=lnt id=hl-301-22><a class=lnlinks href=#hl-301-22>22</a>
</span><span class=lnt id=hl-301-23><a class=lnlinks href=#hl-301-23>23</a>
</span><span class=lnt id=hl-301-24><a class=lnlinks href=#hl-301-24>24</a>
</span><span class=lnt id=hl-301-25><a class=lnlinks href=#hl-301-25>25</a>
</span><span class=lnt id=hl-301-26><a class=lnlinks href=#hl-301-26>26</a>
</span><span class=lnt id=hl-301-27><a class=lnlinks href=#hl-301-27>27</a>
</span><span class=lnt id=hl-301-28><a class=lnlinks href=#hl-301-28>28</a>
</span><span class=lnt id=hl-301-29><a class=lnlinks href=#hl-301-29>29</a>
</span><span class=lnt id=hl-301-30><a class=lnlinks href=#hl-301-30>30</a>
</span><span class=lnt id=hl-301-31><a class=lnlinks href=#hl-301-31>31</a>
</span><span class=lnt id=hl-301-32><a class=lnlinks href=#hl-301-32>32</a>
</span><span class=lnt id=hl-301-33><a class=lnlinks href=#hl-301-33>33</a>
</span><span class=lnt id=hl-301-34><a class=lnlinks href=#hl-301-34>34</a>
</span><span class=lnt id=hl-301-35><a class=lnlinks href=#hl-301-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> 参数1，提供数组、可以是线程不安全数组或线程安全数组
</span></span></span><span class=line><span class=cl><span class=cm> 参数2，获取数组长度的方法
</span></span></span><span class=line><span class=cl><span class=cm> 参数3，自增方法，回传 array, index
</span></span></span><span class=line><span class=cl><span class=cm> 参数4，打印数组的方法
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// supplier 提供者 无中生有 ()-&gt;结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// function 函数 一个参数一个结果 (参数)-&gt;结果 , BiFunction (参数1,参数2)-&gt;结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// consumer 消费者 一个参数没结果 (参数)-&gt;void, BiConsumer (参数1,参数2)-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>arraySupplier</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Function</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>lengthFun</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BiConsumer</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>putConsumer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Consumer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>printConsumer</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>T</span><span class=w> </span><span class=n>array</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arraySupplier</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lengthFun</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>array</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 每个线程对数组作 10000 次操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10000</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>putConsumer</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>array</span><span class=p>,</span><span class=w> </span><span class=n>j</span><span class=o>%</span><span class=n>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>());</span><span class=w> </span><span class=c1>// 启动所有线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w> </span><span class=c1>// 等所有线程结束</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>printConsumer</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>array</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>不安全的数组</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-302-1><a class=lnlinks href=#hl-302-1>1</a>
</span><span class=lnt id=hl-302-2><a class=lnlinks href=#hl-302-2>2</a>
</span><span class=lnt id=hl-302-3><a class=lnlinks href=#hl-302-3>3</a>
</span><span class=lnt id=hl-302-4><a class=lnlinks href=#hl-302-4>4</a>
</span><span class=lnt id=hl-302-5><a class=lnlinks href=#hl-302-5>5</a>
</span><span class=lnt id=hl-302-6><a class=lnlinks href=#hl-302-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>()</span><span class=o>-&gt;</span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>10</span><span class=o>]</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>array</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>array</span><span class=p>.</span><span class=na>length</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>array</span><span class=p>,</span><span class=w> </span><span class=n>index</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>array</span><span class=o>[</span><span class=n>index</span><span class=o>]++</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>array</span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>array</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-303-1><a class=lnlinks href=#hl-303-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>9870, 9862, 9774, 9697, 9683, 9678, 9679, 9668, 9680, 9698<span class=o>]</span> 
</span></span></code></pre></td></tr></table></div></div><p><strong>安全的数组</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-304-1><a class=lnlinks href=#hl-304-1>1</a>
</span><span class=lnt id=hl-304-2><a class=lnlinks href=#hl-304-2>2</a>
</span><span class=lnt id=hl-304-3><a class=lnlinks href=#hl-304-3>3</a>
</span><span class=lnt id=hl-304-4><a class=lnlinks href=#hl-304-4>4</a>
</span><span class=lnt id=hl-304-5><a class=lnlinks href=#hl-304-5>5</a>
</span><span class=lnt id=hl-304-6><a class=lnlinks href=#hl-304-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>()</span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicIntegerArray</span><span class=p>(</span><span class=n>10</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>array</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>array</span><span class=p>.</span><span class=na>length</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>array</span><span class=p>,</span><span class=w> </span><span class=n>index</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>array</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>(</span><span class=n>index</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>array</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>array</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-305-1><a class=lnlinks href=#hl-305-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000<span class=o>]</span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=66-字段更新器><a href=#66-%e5%ad%97%e6%ae%b5%e6%9b%b4%e6%96%b0%e5%99%a8 class=header-anchor>#</a>
6.6 字段更新器</h2><ul><li>AtomicReferenceFieldUpdater // 域 字段</li><li>AtomicIntegerFieldUpdater</li><li>AtomicLongFieldUpdater 利用字段更新器，可以针对对象的某个域（Field）进行原子操作，只能配合 volatile 修饰的字段使用，否则会出现 异常</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-306-1><a class=lnlinks href=#hl-306-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Exception in thread <span class=s2>&#34;main&#34;</span> java.lang.IllegalArgumentException: Must be volatile <span class=nb>type</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-307-1><a class=lnlinks href=#hl-307-1> 1</a>
</span><span class=lnt id=hl-307-2><a class=lnlinks href=#hl-307-2> 2</a>
</span><span class=lnt id=hl-307-3><a class=lnlinks href=#hl-307-3> 3</a>
</span><span class=lnt id=hl-307-4><a class=lnlinks href=#hl-307-4> 4</a>
</span><span class=lnt id=hl-307-5><a class=lnlinks href=#hl-307-5> 5</a>
</span><span class=lnt id=hl-307-6><a class=lnlinks href=#hl-307-6> 6</a>
</span><span class=lnt id=hl-307-7><a class=lnlinks href=#hl-307-7> 7</a>
</span><span class=lnt id=hl-307-8><a class=lnlinks href=#hl-307-8> 8</a>
</span><span class=lnt id=hl-307-9><a class=lnlinks href=#hl-307-9> 9</a>
</span><span class=lnt id=hl-307-10><a class=lnlinks href=#hl-307-10>10</a>
</span><span class=lnt id=hl-307-11><a class=lnlinks href=#hl-307-11>11</a>
</span><span class=lnt id=hl-307-12><a class=lnlinks href=#hl-307-12>12</a>
</span><span class=lnt id=hl-307-13><a class=lnlinks href=#hl-307-13>13</a>
</span><span class=lnt id=hl-307-14><a class=lnlinks href=#hl-307-14>14</a>
</span><span class=lnt id=hl-307-15><a class=lnlinks href=#hl-307-15>15</a>
</span><span class=lnt id=hl-307-16><a class=lnlinks href=#hl-307-16>16</a>
</span><span class=lnt id=hl-307-17><a class=lnlinks href=#hl-307-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test5</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AtomicIntegerFieldUpdater</span><span class=w> </span><span class=n>fieldUpdater</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AtomicIntegerFieldUpdater</span><span class=p>.</span><span class=na>newUpdater</span><span class=p>(</span><span class=n>Test5</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=s>&#34;field&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Test5</span><span class=w> </span><span class=n>test5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Test5</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fieldUpdater</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>test5</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 修改成功 field = 10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>test5</span><span class=p>.</span><span class=na>field</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 修改成功 field = 20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fieldUpdater</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>test5</span><span class=p>,</span><span class=w> </span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>20</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>test5</span><span class=p>.</span><span class=na>field</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 修改失败 field = 20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fieldUpdater</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>test5</span><span class=p>,</span><span class=w> </span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>30</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>test5</span><span class=p>.</span><span class=na>field</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-308-1><a class=lnlinks href=#hl-308-1>1</a>
</span><span class=lnt id=hl-308-2><a class=lnlinks href=#hl-308-2>2</a>
</span><span class=lnt id=hl-308-3><a class=lnlinks href=#hl-308-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>10</span> 
</span></span><span class=line><span class=cl><span class=m>20</span> 
</span></span><span class=line><span class=cl><span class=m>20</span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=67-原子累加器><a href=#67-%e5%8e%9f%e5%ad%90%e7%b4%af%e5%8a%a0%e5%99%a8 class=header-anchor>#</a>
6.7 原子累加器</h2><h4 id=累加器性能比较><a href=#%e7%b4%af%e5%8a%a0%e5%99%a8%e6%80%a7%e8%83%bd%e6%af%94%e8%be%83 class=header-anchor>#</a>
累加器性能比较</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-309-1><a class=lnlinks href=#hl-309-1> 1</a>
</span><span class=lnt id=hl-309-2><a class=lnlinks href=#hl-309-2> 2</a>
</span><span class=lnt id=hl-309-3><a class=lnlinks href=#hl-309-3> 3</a>
</span><span class=lnt id=hl-309-4><a class=lnlinks href=#hl-309-4> 4</a>
</span><span class=lnt id=hl-309-5><a class=lnlinks href=#hl-309-5> 5</a>
</span><span class=lnt id=hl-309-6><a class=lnlinks href=#hl-309-6> 6</a>
</span><span class=lnt id=hl-309-7><a class=lnlinks href=#hl-309-7> 7</a>
</span><span class=lnt id=hl-309-8><a class=lnlinks href=#hl-309-8> 8</a>
</span><span class=lnt id=hl-309-9><a class=lnlinks href=#hl-309-9> 9</a>
</span><span class=lnt id=hl-309-10><a class=lnlinks href=#hl-309-10>10</a>
</span><span class=lnt id=hl-309-11><a class=lnlinks href=#hl-309-11>11</a>
</span><span class=lnt id=hl-309-12><a class=lnlinks href=#hl-309-12>12</a>
</span><span class=lnt id=hl-309-13><a class=lnlinks href=#hl-309-13>13</a>
</span><span class=lnt id=hl-309-14><a class=lnlinks href=#hl-309-14>14</a>
</span><span class=lnt id=hl-309-15><a class=lnlinks href=#hl-309-15>15</a>
</span><span class=lnt id=hl-309-16><a class=lnlinks href=#hl-309-16>16</a>
</span><span class=lnt id=hl-309-17><a class=lnlinks href=#hl-309-17>17</a>
</span><span class=lnt id=hl-309-18><a class=lnlinks href=#hl-309-18>18</a>
</span><span class=lnt id=hl-309-19><a class=lnlinks href=#hl-309-19>19</a>
</span><span class=lnt id=hl-309-20><a class=lnlinks href=#hl-309-20>20</a>
</span><span class=lnt id=hl-309-21><a class=lnlinks href=#hl-309-21>21</a>
</span><span class=lnt id=hl-309-22><a class=lnlinks href=#hl-309-22>22</a>
</span><span class=lnt id=hl-309-23><a class=lnlinks href=#hl-309-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo</span><span class=p>(</span><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>adderSupplier</span><span class=p>,</span><span class=w> </span><span class=n>Consumer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>action</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>T</span><span class=w> </span><span class=n>adder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adderSupplier</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 4 个线程，每人累加 50 万</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>40</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>500000</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>action</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>adder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>adder</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; cost:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>)</span><span class=o>/</span><span class=n>1000_000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>比较 AtomicLong 与 LongAdder</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-310-1><a class=lnlinks href=#hl-310-1>1</a>
</span><span class=lnt id=hl-310-2><a class=lnlinks href=#hl-310-2>2</a>
</span><span class=lnt id=hl-310-3><a class=lnlinks href=#hl-310-3>3</a>
</span><span class=lnt id=hl-310-4><a class=lnlinks href=#hl-310-4>4</a>
</span><span class=lnt id=hl-310-5><a class=lnlinks href=#hl-310-5>5</a>
</span><span class=lnt id=hl-310-6><a class=lnlinks href=#hl-310-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>demo</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LongAdder</span><span class=p>(),</span><span class=w> </span><span class=n>adder</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>adder</span><span class=p>.</span><span class=na>increment</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>demo</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicLong</span><span class=p>(),</span><span class=w> </span><span class=n>adder</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>adder</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-311-1><a class=lnlinks href=#hl-311-1> 1</a>
</span><span class=lnt id=hl-311-2><a class=lnlinks href=#hl-311-2> 2</a>
</span><span class=lnt id=hl-311-3><a class=lnlinks href=#hl-311-3> 3</a>
</span><span class=lnt id=hl-311-4><a class=lnlinks href=#hl-311-4> 4</a>
</span><span class=lnt id=hl-311-5><a class=lnlinks href=#hl-311-5> 5</a>
</span><span class=lnt id=hl-311-6><a class=lnlinks href=#hl-311-6> 6</a>
</span><span class=lnt id=hl-311-7><a class=lnlinks href=#hl-311-7> 7</a>
</span><span class=lnt id=hl-311-8><a class=lnlinks href=#hl-311-8> 8</a>
</span><span class=lnt id=hl-311-9><a class=lnlinks href=#hl-311-9> 9</a>
</span><span class=lnt id=hl-311-10><a class=lnlinks href=#hl-311-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>1000000</span> cost:43 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:9 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:7 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:7 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:7 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:31 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:27 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:28 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:24 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:22 
</span></span></code></pre></td></tr></table></div></div><p>性能提升的原因很简单，就是在有竞争时，设置多个累加单元，Therad-0 累加 Cell[0]，而 Thread-1 累加 Cell[1]&mldr; 最后将结果汇总。这样它们在累加时操作的不同的 Cell 变量，因此减少了 CAS 重试失败，从而提高性 能。</p><h4 id=font-colorblue-原理之伪共享cpu-缓存结构font><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b%e4%bc%aa%e5%85%b1%e4%ba%abcpu-%e7%bc%93%e5%ad%98%e7%bb%93%e6%9e%84font class=header-anchor>#</a>
<font color=blue>* 原理之伪共享(CPU 缓存结构)</font></h4><h5 id=cpu-缓存结构><a href=#cpu-%e7%bc%93%e5%ad%98%e7%bb%93%e6%9e%84 class=header-anchor>#</a>
<strong>CPU 缓存结构</strong></h5><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317203911517.png width=900 height=600 loading=lazy decoding=async alt=image-20220317203911517 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>查看 cpu 缓存</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-312-1><a class=lnlinks href=#hl-312-1> 1</a>
</span><span class=lnt id=hl-312-2><a class=lnlinks href=#hl-312-2> 2</a>
</span><span class=lnt id=hl-312-3><a class=lnlinks href=#hl-312-3> 3</a>
</span><span class=lnt id=hl-312-4><a class=lnlinks href=#hl-312-4> 4</a>
</span><span class=lnt id=hl-312-5><a class=lnlinks href=#hl-312-5> 5</a>
</span><span class=lnt id=hl-312-6><a class=lnlinks href=#hl-312-6> 6</a>
</span><span class=lnt id=hl-312-7><a class=lnlinks href=#hl-312-7> 7</a>
</span><span class=lnt id=hl-312-8><a class=lnlinks href=#hl-312-8> 8</a>
</span><span class=lnt id=hl-312-9><a class=lnlinks href=#hl-312-9> 9</a>
</span><span class=lnt id=hl-312-10><a class=lnlinks href=#hl-312-10>10</a>
</span><span class=lnt id=hl-312-11><a class=lnlinks href=#hl-312-11>11</a>
</span><span class=lnt id=hl-312-12><a class=lnlinks href=#hl-312-12>12</a>
</span><span class=lnt id=hl-312-13><a class=lnlinks href=#hl-312-13>13</a>
</span><span class=lnt id=hl-312-14><a class=lnlinks href=#hl-312-14>14</a>
</span><span class=lnt id=hl-312-15><a class=lnlinks href=#hl-312-15>15</a>
</span><span class=lnt id=hl-312-16><a class=lnlinks href=#hl-312-16>16</a>
</span><span class=lnt id=hl-312-17><a class=lnlinks href=#hl-312-17>17</a>
</span><span class=lnt id=hl-312-18><a class=lnlinks href=#hl-312-18>18</a>
</span><span class=lnt id=hl-312-19><a class=lnlinks href=#hl-312-19>19</a>
</span><span class=lnt id=hl-312-20><a class=lnlinks href=#hl-312-20>20</a>
</span><span class=lnt id=hl-312-21><a class=lnlinks href=#hl-312-21>21</a>
</span><span class=lnt id=hl-312-22><a class=lnlinks href=#hl-312-22>22</a>
</span><span class=lnt id=hl-312-23><a class=lnlinks href=#hl-312-23>23</a>
</span><span class=lnt id=hl-312-24><a class=lnlinks href=#hl-312-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>⚡ root@yihang01 ~ lscpu
</span></span><span class=line><span class=cl>Architecture: x86_64
</span></span><span class=line><span class=cl>CPU op-mode<span class=o>(</span>s<span class=o>)</span>: 32-bit, 64-bit
</span></span><span class=line><span class=cl>Byte Order: Little Endian
</span></span><span class=line><span class=cl>CPU<span class=o>(</span>s<span class=o>)</span>: <span class=m>1</span>
</span></span><span class=line><span class=cl>On-line CPU<span class=o>(</span>s<span class=o>)</span> list: <span class=m>0</span>
</span></span><span class=line><span class=cl>Thread<span class=o>(</span>s<span class=o>)</span> per core: <span class=m>1</span>
</span></span><span class=line><span class=cl>Core<span class=o>(</span>s<span class=o>)</span> per socket: <span class=m>1</span>
</span></span><span class=line><span class=cl>Socket<span class=o>(</span>s<span class=o>)</span>: <span class=m>1</span>
</span></span><span class=line><span class=cl>NUMA node<span class=o>(</span>s<span class=o>)</span>: <span class=m>1</span>
</span></span><span class=line><span class=cl>Vendor ID: GenuineIntel
</span></span><span class=line><span class=cl>CPU family: <span class=m>6</span>
</span></span><span class=line><span class=cl>Model: <span class=m>142</span>
</span></span><span class=line><span class=cl>Model name: Intel<span class=o>(</span>R<span class=o>)</span> Core<span class=o>(</span>TM<span class=o>)</span> i7-8565U CPU @ 1.80GHz
</span></span><span class=line><span class=cl>Stepping: <span class=m>11</span>
</span></span><span class=line><span class=cl>CPU MHz: 1992.002
</span></span><span class=line><span class=cl>BogoMIPS: 3984.00
</span></span><span class=line><span class=cl>Hypervisor vendor: VMware
</span></span><span class=line><span class=cl>Virtualization type: full
</span></span><span class=line><span class=cl>L1d cache: 32K
</span></span><span class=line><span class=cl>L1i cache: 32K
</span></span><span class=line><span class=cl>L2 cache: 256K
</span></span><span class=line><span class=cl>L3 cache: 8192K
</span></span><span class=line><span class=cl>NUMA node0 CPU<span class=o>(</span>s<span class=o>)</span>: <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>速度比较</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>从cpu到</th><th style=text-align:center>大约需要的时钟周期</th></tr></thead><tbody><tr><td style=text-align:center>寄存器</td><td style=text-align:center>1 cycle</td></tr><tr><td style=text-align:center>L1</td><td style=text-align:center>3~4 cycle</td></tr><tr><td style=text-align:center>L2</td><td style=text-align:center>10~20 cycle</td></tr><tr><td style=text-align:center>L3</td><td style=text-align:center>40~45 cycle</td></tr><tr><td style=text-align:center>内存</td><td style=text-align:center>120~240 cycle</td></tr></tbody></table></div><p>查看 cpu 缓存行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-313-1><a class=lnlinks href=#hl-313-1>1</a>
</span><span class=lnt id=hl-313-2><a class=lnlinks href=#hl-313-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>⚡ root@yihang01 ~ cat /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size
</span></span><span class=line><span class=cl><span class=m>64</span>
</span></span></code></pre></td></tr></table></div></div><p>cpu 拿到的内存地址格式是这样的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-314-1><a class=lnlinks href=#hl-314-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>高位组标记<span class=o>][</span>低位索引<span class=o>][</span>偏移量<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317204208269.png width=900 height=600 loading=lazy decoding=async alt=image-20220317204208269 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=cpu-缓存读><a href=#cpu-%e7%bc%93%e5%ad%98%e8%af%bb class=header-anchor>#</a>
<strong>CPU 缓存读</strong></h5><p>读取数据流程如下</p><ul><li>根据低位，计算在缓存中的索引</li><li>判断是否有效<ul><li>0 去内存读取新数据更新缓存行</li><li>1 再对比高位组标记是否一致<ul><li>一致，根据偏移量返回缓存数据</li><li>不一致，去内存读取新数据更新缓存行</li></ul></li></ul></li></ul><h5 id=cpu-缓存一致性><a href=#cpu-%e7%bc%93%e5%ad%98%e4%b8%80%e8%87%b4%e6%80%a7 class=header-anchor>#</a>
<strong>CPU 缓存一致性</strong></h5><p>MESI 协议</p><ol><li>E、S、M 状态的缓存行都可以满足 CPU 的读请求</li><li>E 状态的缓存行，有写请求，会将状态改为 M，这时并不触发向主存的写</li><li>E 状态的缓存行，必须监听该缓存行的读操作，如果有，要变为 S 状态</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317204411550.png width=900 height=600 loading=lazy decoding=async alt=image-20220317204411550 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><pre><code>4. M 状态的缓存行，必须监听该缓存行的读操作，如果有，先将其它缓存（S 状态）中该缓存行变成 I 状态（即 6. 的流程），写入主存，自己变为 S 状态 
5. S 状态的缓存行，有写请求，走 4. 的流程 
6. S 状态的缓存行，必须监听该缓存行的失效操作，如果有，自己变为 I 状态 
7. I 状态的缓存行，有读请求，必须从主存读取
</code></pre><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317204507325.png width=900 height=600 loading=lazy decoding=async alt=image-20220317204507325 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=内存屏障><a href=#%e5%86%85%e5%ad%98%e5%b1%8f%e9%9a%9c class=header-anchor>#</a>
<strong>内存屏障</strong></h5><p>Memory Barrier（Memory Fence）</p><p>可见性</p><ul><li>写屏障（sfence）保证在该屏障之前的，对共享变量的改动，都同步到主存当中</li><li>而读屏障（lfence）保证在该屏障之后，对共享变量的读取，加载的是主存中最新数据</li></ul><p>有序性</p><ul><li>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</li><li>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317204610541.png width=900 height=600 loading=lazy decoding=async alt=image-20220317204610541 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=font-colorblue-源码之-longadderfont><a href=#font-colorblue-%e6%ba%90%e7%a0%81%e4%b9%8b-longadderfont class=header-anchor>#</a>
<font color=blue>* 源码之 LongAdder</font></h4><p>LongAdder 是并发大师 @author Doug Lea （大哥李）的作品，设计的非常精巧</p><p>LongAdder 类有几个关键域</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-315-1><a class=lnlinks href=#hl-315-1>1</a>
</span><span class=lnt id=hl-315-2><a class=lnlinks href=#hl-315-2>2</a>
</span><span class=lnt id=hl-315-3><a class=lnlinks href=#hl-315-3>3</a>
</span><span class=lnt id=hl-315-4><a class=lnlinks href=#hl-315-4>4</a>
</span><span class=lnt id=hl-315-5><a class=lnlinks href=#hl-315-5>5</a>
</span><span class=lnt id=hl-315-6><a class=lnlinks href=#hl-315-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 累加单元数组, 懒惰初始化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>cells</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 基础值, 如果没有竞争, 则用 cas 累加这个域</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>base</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 在 cells 创建或扩容时, 置为 1, 表示加锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>cellsBusy</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>其中 Cell 即为累加单元</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-316-1><a class=lnlinks href=#hl-316-1> 1</a>
</span><span class=lnt id=hl-316-2><a class=lnlinks href=#hl-316-2> 2</a>
</span><span class=lnt id=hl-316-3><a class=lnlinks href=#hl-316-3> 3</a>
</span><span class=lnt id=hl-316-4><a class=lnlinks href=#hl-316-4> 4</a>
</span><span class=lnt id=hl-316-5><a class=lnlinks href=#hl-316-5> 5</a>
</span><span class=lnt id=hl-316-6><a class=lnlinks href=#hl-316-6> 6</a>
</span><span class=lnt id=hl-316-7><a class=lnlinks href=#hl-316-7> 7</a>
</span><span class=lnt id=hl-316-8><a class=lnlinks href=#hl-316-8> 8</a>
</span><span class=lnt id=hl-316-9><a class=lnlinks href=#hl-316-9> 9</a>
</span><span class=lnt id=hl-316-10><a class=lnlinks href=#hl-316-10>10</a>
</span><span class=lnt id=hl-316-11><a class=lnlinks href=#hl-316-11>11</a>
</span><span class=lnt id=hl-316-12><a class=lnlinks href=#hl-316-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 防止缓存行伪共享</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@sun.misc.Contended</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Cell</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Cell</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 最重要的方法, 用来 cas 方式进行累加, prev 表示旧值, next 表示新值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>cas</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>compareAndSwapLong</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>valueOffset</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 省略不重要代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>得从缓存说起</p><p>缓存与内存的速度比较</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205054803.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205054803 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>因为 CPU 与 内存的速度差异很大，需要靠预读数据至缓存来提升效率。</p><p>而缓存以缓存行为单位，每个缓存行对应着一块内存，一般是 64 byte（8 个 long）</p><p>缓存的加入会造成数据副本的产生，即同一份数据会缓存在不同核心的缓存行中</p><p>CPU 要保证数据的一致性，如果某个 CPU 核心更改了数据，其它 CPU 核心对应的整个缓存行必须失效</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205206297.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205206297 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>因为 Cell 是数组形式，在内存中是连续存储的，一个 Cell 为 24 字节（16 字节的对象头和 8 字节的 value），因 此缓存行可以存下 2 个的 Cell 对象。这样问题来了：</p><ul><li>Core-0 要修改 Cell[0]</li><li>Core-1 要修改 Cell[1]</li></ul><p>无论谁修改成功，都会导致对方 Core 的缓存行失效，比如Core-0 中<code>Cell[0]=6000, Cell[1]=8000</code>要累加<code>Cell[0]=6001, Cell[1]=8000</code> ，这时会让 Core-1 的缓存行失效</p><p>@sun.misc.Contended 用来解决这个问题，它的原理是在使用此注解的对象或字段的前后各增加 128 字节大小的 padding，从而让 CPU 将对象预读至缓存时占用不同的缓存行，这样，不会造成对方缓存行的失效</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205321951.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205321951 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>累加主要调用下面的方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-317-1><a class=lnlinks href=#hl-317-1> 1</a>
</span><span class=lnt id=hl-317-2><a class=lnlinks href=#hl-317-2> 2</a>
</span><span class=lnt id=hl-317-3><a class=lnlinks href=#hl-317-3> 3</a>
</span><span class=lnt id=hl-317-4><a class=lnlinks href=#hl-317-4> 4</a>
</span><span class=lnt id=hl-317-5><a class=lnlinks href=#hl-317-5> 5</a>
</span><span class=lnt id=hl-317-6><a class=lnlinks href=#hl-317-6> 6</a>
</span><span class=lnt id=hl-317-7><a class=lnlinks href=#hl-317-7> 7</a>
</span><span class=lnt id=hl-317-8><a class=lnlinks href=#hl-317-8> 8</a>
</span><span class=lnt id=hl-317-9><a class=lnlinks href=#hl-317-9> 9</a>
</span><span class=lnt id=hl-317-10><a class=lnlinks href=#hl-317-10>10</a>
</span><span class=lnt id=hl-317-11><a class=lnlinks href=#hl-317-11>11</a>
</span><span class=lnt id=hl-317-12><a class=lnlinks href=#hl-317-12>12</a>
</span><span class=lnt id=hl-317-13><a class=lnlinks href=#hl-317-13>13</a>
</span><span class=lnt id=hl-317-14><a class=lnlinks href=#hl-317-14>14</a>
</span><span class=lnt id=hl-317-15><a class=lnlinks href=#hl-317-15>15</a>
</span><span class=lnt id=hl-317-16><a class=lnlinks href=#hl-317-16>16</a>
</span><span class=lnt id=hl-317-17><a class=lnlinks href=#hl-317-17>17</a>
</span><span class=lnt id=hl-317-18><a class=lnlinks href=#hl-317-18>18</a>
</span><span class=lnt id=hl-317-19><a class=lnlinks href=#hl-317-19>19</a>
</span><span class=lnt id=hl-317-20><a class=lnlinks href=#hl-317-20>20</a>
</span><span class=lnt id=hl-317-21><a class=lnlinks href=#hl-317-21>21</a>
</span><span class=lnt id=hl-317-22><a class=lnlinks href=#hl-317-22>22</a>
</span><span class=lnt id=hl-317-23><a class=lnlinks href=#hl-317-23>23</a>
</span><span class=lnt id=hl-317-24><a class=lnlinks href=#hl-317-24>24</a>
</span><span class=lnt id=hl-317-25><a class=lnlinks href=#hl-317-25>25</a>
</span><span class=lnt id=hl-317-26><a class=lnlinks href=#hl-317-26>26</a>
</span><span class=lnt id=hl-317-27><a class=lnlinks href=#hl-317-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// as 为累加单元数组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// b 为基础值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// x 为累加值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>as</span><span class=p>;</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>m</span><span class=p>;</span><span class=w> </span><span class=n>Cell</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 进入 if 的两个条件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1. as 有值, 表示已经发生过竞争, 进入 if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2. cas 给 base 累加时失败了, 表示 base 发生了竞争, 进入 if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cells</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>casBase</span><span class=p>(</span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>base</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// uncontended 表示 cell 没有竞争</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>uncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// as 还没有创建</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>as</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 当前线程对应的 cell 还没有</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// getProbe()方法返回的是线程中的threadLocalRandomProbe字段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 它是通过随机数生成的一个值，对于一个确定的线程这个值是固定的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 除非刻意修改它</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=o>[</span><span class=n>getProbe</span><span class=p>()</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>m</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// cas 给当前线程的 cell 累加失败 uncontended=false ( a 为当前线程的 cell )</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=p>(</span><span class=n>uncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>cas</span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>value</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 进入 cell 数组创建、cell 创建的流程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>longAccumulate</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>uncontended</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>总结 ：</p><ul><li>如果已经<code>有了累加数组</code>或<code>给base累加发生了竞争导致失败</code><ul><li>如果<code>累加数组没有创建</code>或者<code>累加数组长度为1</code>或者<code>当前线程还没有对应的cell</code>或者<code>累加cell失败</code><ul><li>进入累加数组的创建流程</li></ul></li><li>否者说明累加成功，退出。</li></ul></li><li>否则累加成功</li></ul><p>add 流程图</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205409166.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205409166 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-318-1><a class=lnlinks href=#hl-318-1> 1</a>
</span><span class=lnt id=hl-318-2><a class=lnlinks href=#hl-318-2> 2</a>
</span><span class=lnt id=hl-318-3><a class=lnlinks href=#hl-318-3> 3</a>
</span><span class=lnt id=hl-318-4><a class=lnlinks href=#hl-318-4> 4</a>
</span><span class=lnt id=hl-318-5><a class=lnlinks href=#hl-318-5> 5</a>
</span><span class=lnt id=hl-318-6><a class=lnlinks href=#hl-318-6> 6</a>
</span><span class=lnt id=hl-318-7><a class=lnlinks href=#hl-318-7> 7</a>
</span><span class=lnt id=hl-318-8><a class=lnlinks href=#hl-318-8> 8</a>
</span><span class=lnt id=hl-318-9><a class=lnlinks href=#hl-318-9> 9</a>
</span><span class=lnt id=hl-318-10><a class=lnlinks href=#hl-318-10>10</a>
</span><span class=lnt id=hl-318-11><a class=lnlinks href=#hl-318-11>11</a>
</span><span class=lnt id=hl-318-12><a class=lnlinks href=#hl-318-12>12</a>
</span><span class=lnt id=hl-318-13><a class=lnlinks href=#hl-318-13>13</a>
</span><span class=lnt id=hl-318-14><a class=lnlinks href=#hl-318-14>14</a>
</span><span class=lnt id=hl-318-15><a class=lnlinks href=#hl-318-15>15</a>
</span><span class=lnt id=hl-318-16><a class=lnlinks href=#hl-318-16>16</a>
</span><span class=lnt id=hl-318-17><a class=lnlinks href=#hl-318-17>17</a>
</span><span class=lnt id=hl-318-18><a class=lnlinks href=#hl-318-18>18</a>
</span><span class=lnt id=hl-318-19><a class=lnlinks href=#hl-318-19>19</a>
</span><span class=lnt id=hl-318-20><a class=lnlinks href=#hl-318-20>20</a>
</span><span class=lnt id=hl-318-21><a class=lnlinks href=#hl-318-21>21</a>
</span><span class=lnt id=hl-318-22><a class=lnlinks href=#hl-318-22>22</a>
</span><span class=lnt id=hl-318-23><a class=lnlinks href=#hl-318-23>23</a>
</span><span class=lnt id=hl-318-24><a class=lnlinks href=#hl-318-24>24</a>
</span><span class=lnt id=hl-318-25><a class=lnlinks href=#hl-318-25>25</a>
</span><span class=lnt id=hl-318-26><a class=lnlinks href=#hl-318-26>26</a>
</span><span class=lnt id=hl-318-27><a class=lnlinks href=#hl-318-27>27</a>
</span><span class=lnt id=hl-318-28><a class=lnlinks href=#hl-318-28>28</a>
</span><span class=lnt id=hl-318-29><a class=lnlinks href=#hl-318-29>29</a>
</span><span class=lnt id=hl-318-30><a class=lnlinks href=#hl-318-30>30</a>
</span><span class=lnt id=hl-318-31><a class=lnlinks href=#hl-318-31>31</a>
</span><span class=lnt id=hl-318-32><a class=lnlinks href=#hl-318-32>32</a>
</span><span class=lnt id=hl-318-33><a class=lnlinks href=#hl-318-33>33</a>
</span><span class=lnt id=hl-318-34><a class=lnlinks href=#hl-318-34>34</a>
</span><span class=lnt id=hl-318-35><a class=lnlinks href=#hl-318-35>35</a>
</span><span class=lnt id=hl-318-36><a class=lnlinks href=#hl-318-36>36</a>
</span><span class=lnt id=hl-318-37><a class=lnlinks href=#hl-318-37>37</a>
</span><span class=lnt id=hl-318-38><a class=lnlinks href=#hl-318-38>38</a>
</span><span class=lnt id=hl-318-39><a class=lnlinks href=#hl-318-39>39</a>
</span><span class=lnt id=hl-318-40><a class=lnlinks href=#hl-318-40>40</a>
</span><span class=lnt id=hl-318-41><a class=lnlinks href=#hl-318-41>41</a>
</span><span class=lnt id=hl-318-42><a class=lnlinks href=#hl-318-42>42</a>
</span><span class=lnt id=hl-318-43><a class=lnlinks href=#hl-318-43>43</a>
</span><span class=lnt id=hl-318-44><a class=lnlinks href=#hl-318-44>44</a>
</span><span class=lnt id=hl-318-45><a class=lnlinks href=#hl-318-45>45</a>
</span><span class=lnt id=hl-318-46><a class=lnlinks href=#hl-318-46>46</a>
</span><span class=lnt id=hl-318-47><a class=lnlinks href=#hl-318-47>47</a>
</span><span class=lnt id=hl-318-48><a class=lnlinks href=#hl-318-48>48</a>
</span><span class=lnt id=hl-318-49><a class=lnlinks href=#hl-318-49>49</a>
</span><span class=lnt id=hl-318-50><a class=lnlinks href=#hl-318-50>50</a>
</span><span class=lnt id=hl-318-51><a class=lnlinks href=#hl-318-51>51</a>
</span><span class=lnt id=hl-318-52><a class=lnlinks href=#hl-318-52>52</a>
</span><span class=lnt id=hl-318-53><a class=lnlinks href=#hl-318-53>53</a>
</span><span class=lnt id=hl-318-54><a class=lnlinks href=#hl-318-54>54</a>
</span><span class=lnt id=hl-318-55><a class=lnlinks href=#hl-318-55>55</a>
</span><span class=lnt id=hl-318-56><a class=lnlinks href=#hl-318-56>56</a>
</span><span class=lnt id=hl-318-57><a class=lnlinks href=#hl-318-57>57</a>
</span><span class=lnt id=hl-318-58><a class=lnlinks href=#hl-318-58>58</a>
</span><span class=lnt id=hl-318-59><a class=lnlinks href=#hl-318-59>59</a>
</span><span class=lnt id=hl-318-60><a class=lnlinks href=#hl-318-60>60</a>
</span><span class=lnt id=hl-318-61><a class=lnlinks href=#hl-318-61>61</a>
</span><span class=lnt id=hl-318-62><a class=lnlinks href=#hl-318-62>62</a>
</span><span class=lnt id=hl-318-63><a class=lnlinks href=#hl-318-63>63</a>
</span><span class=lnt id=hl-318-64><a class=lnlinks href=#hl-318-64>64</a>
</span><span class=lnt id=hl-318-65><a class=lnlinks href=#hl-318-65>65</a>
</span><span class=lnt id=hl-318-66><a class=lnlinks href=#hl-318-66>66</a>
</span><span class=lnt id=hl-318-67><a class=lnlinks href=#hl-318-67>67</a>
</span><span class=lnt id=hl-318-68><a class=lnlinks href=#hl-318-68>68</a>
</span><span class=lnt id=hl-318-69><a class=lnlinks href=#hl-318-69>69</a>
</span><span class=lnt id=hl-318-70><a class=lnlinks href=#hl-318-70>70</a>
</span><span class=lnt id=hl-318-71><a class=lnlinks href=#hl-318-71>71</a>
</span><span class=lnt id=hl-318-72><a class=lnlinks href=#hl-318-72>72</a>
</span><span class=lnt id=hl-318-73><a class=lnlinks href=#hl-318-73>73</a>
</span><span class=lnt id=hl-318-74><a class=lnlinks href=#hl-318-74>74</a>
</span><span class=lnt id=hl-318-75><a class=lnlinks href=#hl-318-75>75</a>
</span><span class=lnt id=hl-318-76><a class=lnlinks href=#hl-318-76>76</a>
</span><span class=lnt id=hl-318-77><a class=lnlinks href=#hl-318-77>77</a>
</span><span class=lnt id=hl-318-78><a class=lnlinks href=#hl-318-78>78</a>
</span><span class=lnt id=hl-318-79><a class=lnlinks href=#hl-318-79>79</a>
</span><span class=lnt id=hl-318-80><a class=lnlinks href=#hl-318-80>80</a>
</span><span class=lnt id=hl-318-81><a class=lnlinks href=#hl-318-81>81</a>
</span><span class=lnt id=hl-318-82><a class=lnlinks href=#hl-318-82>82</a>
</span><span class=lnt id=hl-318-83><a class=lnlinks href=#hl-318-83>83</a>
</span><span class=lnt id=hl-318-84><a class=lnlinks href=#hl-318-84>84</a>
</span><span class=lnt id=hl-318-85><a class=lnlinks href=#hl-318-85>85</a>
</span><span class=lnt id=hl-318-86><a class=lnlinks href=#hl-318-86>86</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>longAccumulate</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>LongBinaryOperator</span><span class=w> </span><span class=n>fn</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=kt>boolean</span><span class=w> </span><span class=n>wasUncontended</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 当前线程还没有对应的 cell, 需要随机生成一个 h 值用来将当前线程绑定到 cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getProbe</span><span class=p>())</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 初始化 probe</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ThreadLocalRandom</span><span class=p>.</span><span class=na>current</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// h 对应新的 probe 值, 用来对应 cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getProbe</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>wasUncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// collide 为 true 表示最后一个槽非空，需要扩容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>collide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>as</span><span class=p>;</span><span class=w> </span><span class=n>Cell</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 已经有了 cells</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cells</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 还没有 cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=o>[</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>h</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 为 cellsBusy 加锁, 创建 cell, cell 的初始累加值为 x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 成功则 break, 否则继续 continue 循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cellsBusy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>       </span><span class=c1>// Try to attach new Cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Cell</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cell</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>   </span><span class=c1>// Optimistically create</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cellsBusy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>casCellsBusy</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kt>boolean</span><span class=w> </span><span class=n>created</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>               </span><span class=c1>// Recheck under lock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>rs</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>rs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cells</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>rs</span><span class=o>[</span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>h</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>rs</span><span class=o>[</span><span class=n>j</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>created</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>cellsBusy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>created</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w>           </span><span class=c1>// Slot is now non-empty</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>collide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 有竞争, 改变线程对应的 cell 来重试 cas</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>wasUncontended</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>wasUncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// cas 尝试累加, fn 配合 LongAccumulator 不为 null, 配合 LongAdder 为 null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=na>cas</span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>value</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=n>fn</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>fn</span><span class=p>.</span><span class=na>applyAsLong</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>))))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果 cells 长度已经超过了最大长度, 或者已经扩容, 改变线程对应的 cell 来重试 cas</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>NCPU</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>cells</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>as</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>collide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 确保 collide 为 false 进入此分支, 就不会进入下面的 else if 进行扩容了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>collide</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>collide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 加锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cellsBusy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>casCellsBusy</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 加锁成功, 扩容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 改变线程对应的 cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>advanceProbe</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 还没有 cells, 尝试给 cellsBusy 加锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cellsBusy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>cells</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>as</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>casCellsBusy</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 加锁成功, 初始化 cells, 最开始长度为 2, 并填充一个 cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 成功则 break;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>init</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>                           </span><span class=c1>// Initialize table</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cells</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>as</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cell</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>rs</span><span class=o>[</span><span class=n>h</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cell</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>cells</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>init</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cellsBusy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>init</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 上两种情况失败, 尝试给 base 累加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>casBase</span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>base</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=n>fn</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>fn</span><span class=p>.</span><span class=na>applyAsLong</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>))))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>总结：</p><ul><li><p>先判断当前线程有没有对应的Cell</p><ul><li>如果没有，随机生成一个值，这个值与当前线程绑定，通过这个值的取模运算定位当前线程Cell的位置。</li></ul></li><li><p>进入for循环</p><ul><li><p>if 有Cells累加数组且长度大于0</p><ul><li><p>if 如果当前线程没有cell</p><ul><li>准备扩容，如果前累加数组不繁忙（正在扩容之类）<ul><li>将新建的cell放入对应的槽位中，新建Cell成功，进入下一次循环，尝试cas累加。</li></ul></li><li>将collide置为false，表示无需扩容。</li></ul></li><li><p>else if 有竞争</p><ul><li>将wasUncontended置为tue，进入分支底部，改变线程对应的cell来cas重试</li></ul></li><li><p>else if cas重试累加成功</p><ul><li>退出循环。</li></ul></li><li><p>else if cells 长度已经超过了最大长度, 或者已经扩容,</p><ul><li>collide置为false，进入分支底部，改变线程对应的 cell 来重试 cas</li></ul></li><li><p>else if collide为false</p><ul><li>将collide置为true（确保 collide 为 false 进入此分支, 就不会进入下面的 else if 进行扩容了）</li></ul></li><li><p>else if 累加数组不繁忙且加锁成功</p><ul><li>退出本次循环，进入下一次循环（扩容）</li></ul></li><li><p>改变线程对应的 cell 来重试 cas</p></li></ul></li><li><p>else if 数组不繁忙且数组为null且加锁成功</p><ul><li>新建数组，在槽位处新建cell，释放锁，退出循环。</li></ul></li><li><p>else if 尝试给base累加成功</p><ul><li>退出循环</li></ul></li></ul></li></ul><p>longAccumulate 流程图</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205457078.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205457078 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205515695.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205515695 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>每个线程刚进入 longAccumulate 时，会尝试对应一个 cell 对象（找到一个坑位）</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205530752.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205530752 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>获取最终结果通过 sum 方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-319-1><a class=lnlinks href=#hl-319-1> 1</a>
</span><span class=lnt id=hl-319-2><a class=lnlinks href=#hl-319-2> 2</a>
</span><span class=lnt id=hl-319-3><a class=lnlinks href=#hl-319-3> 3</a>
</span><span class=lnt id=hl-319-4><a class=lnlinks href=#hl-319-4> 4</a>
</span><span class=lnt id=hl-319-5><a class=lnlinks href=#hl-319-5> 5</a>
</span><span class=lnt id=hl-319-6><a class=lnlinks href=#hl-319-6> 6</a>
</span><span class=lnt id=hl-319-7><a class=lnlinks href=#hl-319-7> 7</a>
</span><span class=lnt id=hl-319-8><a class=lnlinks href=#hl-319-8> 8</a>
</span><span class=lnt id=hl-319-9><a class=lnlinks href=#hl-319-9> 9</a>
</span><span class=lnt id=hl-319-10><a class=lnlinks href=#hl-319-10>10</a>
</span><span class=lnt id=hl-319-11><a class=lnlinks href=#hl-319-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>sum</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cells</span><span class=p>;</span><span class=w> </span><span class=n>Cell</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>base</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>as</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=与运算和取模的关系><a href=#%e4%b8%8e%e8%bf%90%e7%ae%97%e5%92%8c%e5%8f%96%e6%a8%a1%e7%9a%84%e5%85%b3%e7%b3%bb class=header-anchor>#</a>
与运算和取模的关系</h4><blockquote><p><strong>参考链接</strong>：https://www.cnblogs.com/thrillerz/p/4530108.html</p></blockquote><h2 id=68-unsafe><a href=#68-unsafe class=header-anchor>#</a>
6.8 Unsafe</h2><h4 id=概述><a href=#%e6%a6%82%e8%bf%b0 class=header-anchor>#</a>
概述</h4><p>Unsafe 对象提供了非常底层的，操作内存、线程的方法，Unsafe 对象不能直接调用，只能通过反射获得。jdk8直接调用<code>Unsafe.getUnsafe()</code>获得的unsafe不能用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-320-1><a class=lnlinks href=#hl-320-1> 1</a>
</span><span class=lnt id=hl-320-2><a class=lnlinks href=#hl-320-2> 2</a>
</span><span class=lnt id=hl-320-3><a class=lnlinks href=#hl-320-3> 3</a>
</span><span class=lnt id=hl-320-4><a class=lnlinks href=#hl-320-4> 4</a>
</span><span class=lnt id=hl-320-5><a class=lnlinks href=#hl-320-5> 5</a>
</span><span class=lnt id=hl-320-6><a class=lnlinks href=#hl-320-6> 6</a>
</span><span class=lnt id=hl-320-7><a class=lnlinks href=#hl-320-7> 7</a>
</span><span class=lnt id=hl-320-8><a class=lnlinks href=#hl-320-8> 8</a>
</span><span class=lnt id=hl-320-9><a class=lnlinks href=#hl-320-9> 9</a>
</span><span class=lnt id=hl-320-10><a class=lnlinks href=#hl-320-10>10</a>
</span><span class=lnt id=hl-320-11><a class=lnlinks href=#hl-320-11>11</a>
</span><span class=lnt id=hl-320-12><a class=lnlinks href=#hl-320-12>12</a>
</span><span class=lnt id=hl-320-13><a class=lnlinks href=#hl-320-13>13</a>
</span><span class=lnt id=hl-320-14><a class=lnlinks href=#hl-320-14>14</a>
</span><span class=lnt id=hl-320-15><a class=lnlinks href=#hl-320-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UnsafeAccessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Unsafe</span><span class=w> </span><span class=n>unsafe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Field</span><span class=w> </span><span class=n>theUnsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Unsafe</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;theUnsafe&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>theUnsafe</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Unsafe</span><span class=p>)</span><span class=w> </span><span class=n>theUnsafe</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchFieldException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>IllegalAccessException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Unsafe</span><span class=w> </span><span class=nf>getUnsafe</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unsafe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-321-1><a class=lnlinks href=#hl-321-1> 1</a>
</span><span class=lnt id=hl-321-2><a class=lnlinks href=#hl-321-2> 2</a>
</span><span class=lnt id=hl-321-3><a class=lnlinks href=#hl-321-3> 3</a>
</span><span class=lnt id=hl-321-4><a class=lnlinks href=#hl-321-4> 4</a>
</span><span class=lnt id=hl-321-5><a class=lnlinks href=#hl-321-5> 5</a>
</span><span class=lnt id=hl-321-6><a class=lnlinks href=#hl-321-6> 6</a>
</span><span class=lnt id=hl-321-7><a class=lnlinks href=#hl-321-7> 7</a>
</span><span class=lnt id=hl-321-8><a class=lnlinks href=#hl-321-8> 8</a>
</span><span class=lnt id=hl-321-9><a class=lnlinks href=#hl-321-9> 9</a>
</span><span class=lnt id=hl-321-10><a class=lnlinks href=#hl-321-10>10</a>
</span><span class=lnt id=hl-321-11><a class=lnlinks href=#hl-321-11>11</a>
</span><span class=lnt id=hl-321-12><a class=lnlinks href=#hl-321-12>12</a>
</span><span class=lnt id=hl-321-13><a class=lnlinks href=#hl-321-13>13</a>
</span><span class=lnt id=hl-321-14><a class=lnlinks href=#hl-321-14>14</a>
</span><span class=lnt id=hl-321-15><a class=lnlinks href=#hl-321-15>15</a>
</span><span class=lnt id=hl-321-16><a class=lnlinks href=#hl-321-16>16</a>
</span><span class=lnt id=hl-321-17><a class=lnlinks href=#hl-321-17>17</a>
</span><span class=lnt id=hl-321-18><a class=lnlinks href=#hl-321-18>18</a>
</span><span class=lnt id=hl-321-19><a class=lnlinks href=#hl-321-19>19</a>
</span><span class=lnt id=hl-321-20><a class=lnlinks href=#hl-321-20>20</a>
</span><span class=lnt id=hl-321-21><a class=lnlinks href=#hl-321-21>21</a>
</span><span class=lnt id=hl-321-22><a class=lnlinks href=#hl-321-22>22</a>
</span><span class=lnt id=hl-321-23><a class=lnlinks href=#hl-321-23>23</a>
</span><span class=lnt id=hl-321-24><a class=lnlinks href=#hl-321-24>24</a>
</span><span class=lnt id=hl-321-25><a class=lnlinks href=#hl-321-25>25</a>
</span><span class=lnt id=hl-321-26><a class=lnlinks href=#hl-321-26>26</a>
</span><span class=lnt id=hl-321-27><a class=lnlinks href=#hl-321-27>27</a>
</span><span class=lnt id=hl-321-28><a class=lnlinks href=#hl-321-28>28</a>
</span><span class=lnt id=hl-321-29><a class=lnlinks href=#hl-321-29>29</a>
</span><span class=lnt id=hl-321-30><a class=lnlinks href=#hl-321-30>30</a>
</span><span class=lnt id=hl-321-31><a class=lnlinks href=#hl-321-31>31</a>
</span><span class=lnt id=hl-321-32><a class=lnlinks href=#hl-321-32>32</a>
</span><span class=lnt id=hl-321-33><a class=lnlinks href=#hl-321-33>33</a>
</span><span class=lnt id=hl-321-34><a class=lnlinks href=#hl-321-34>34</a>
</span><span class=lnt id=hl-321-35><a class=lnlinks href=#hl-321-35>35</a>
</span><span class=lnt id=hl-321-36><a class=lnlinks href=#hl-321-36>36</a>
</span><span class=lnt id=hl-321-37><a class=lnlinks href=#hl-321-37>37</a>
</span><span class=lnt id=hl-321-38><a class=lnlinks href=#hl-321-38>38</a>
</span><span class=lnt id=hl-321-39><a class=lnlinks href=#hl-321-39>39</a>
</span><span class=lnt id=hl-321-40><a class=lnlinks href=#hl-321-40>40</a>
</span><span class=lnt id=hl-321-41><a class=lnlinks href=#hl-321-41>41</a>
</span><span class=lnt id=hl-321-42><a class=lnlinks href=#hl-321-42>42</a>
</span><span class=lnt id=hl-321-43><a class=lnlinks href=#hl-321-43>43</a>
</span><span class=lnt id=hl-321-44><a class=lnlinks href=#hl-321-44>44</a>
</span><span class=lnt id=hl-321-45><a class=lnlinks href=#hl-321-45>45</a>
</span><span class=lnt id=hl-321-46><a class=lnlinks href=#hl-321-46>46</a>
</span><span class=lnt id=hl-321-47><a class=lnlinks href=#hl-321-47>47</a>
</span><span class=lnt id=hl-321-48><a class=lnlinks href=#hl-321-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//以下三个方法只执行一次，成功返回true，不成功返回false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>native</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>compareAndSwapObject</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>var4</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>var5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>native</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>compareAndSwapInt</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var4</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>native</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>compareAndSwapLong</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var4</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var6</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//以下方法都是在以上三个方法的基础上进行封装，会循环直到成功为止。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndAddInt</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>var5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getIntVolatile</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>var5</span><span class=p>,</span><span class=w> </span><span class=n>var5</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>var4</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>var5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>getAndAddLong</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>var6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getLongVolatile</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSwapLong</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>var6</span><span class=p>,</span><span class=w> </span><span class=n>var6</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>var4</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>var6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndSetInt</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>var5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getIntVolatile</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>var5</span><span class=p>,</span><span class=w> </span><span class=n>var4</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>var5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>getAndSetLong</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>var6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getLongVolatile</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSwapLong</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>var6</span><span class=p>,</span><span class=w> </span><span class=n>var4</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>var6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getAndSetObject</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>var5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getObjectVolatile</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSwapObject</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>var5</span><span class=p>,</span><span class=w> </span><span class=n>var4</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=unsafe-cas-操作><a href=#unsafe-cas-%e6%93%8d%e4%bd%9c class=header-anchor>#</a>
Unsafe CAS 操作</h4><h5 id=unsafe实现字段更新><a href=#unsafe%e5%ae%9e%e7%8e%b0%e5%ad%97%e6%ae%b5%e6%9b%b4%e6%96%b0 class=header-anchor>#</a>
unsafe实现字段更新</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-322-1><a class=lnlinks href=#hl-322-1>1</a>
</span><span class=lnt id=hl-322-2><a class=lnlinks href=#hl-322-2>2</a>
</span><span class=lnt id=hl-322-3><a class=lnlinks href=#hl-322-3>3</a>
</span><span class=lnt id=hl-322-4><a class=lnlinks href=#hl-322-4>4</a>
</span><span class=lnt id=hl-322-5><a class=lnlinks href=#hl-322-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Student</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-323-1><a class=lnlinks href=#hl-323-1> 1</a>
</span><span class=lnt id=hl-323-2><a class=lnlinks href=#hl-323-2> 2</a>
</span><span class=lnt id=hl-323-3><a class=lnlinks href=#hl-323-3> 3</a>
</span><span class=lnt id=hl-323-4><a class=lnlinks href=#hl-323-4> 4</a>
</span><span class=lnt id=hl-323-5><a class=lnlinks href=#hl-323-5> 5</a>
</span><span class=lnt id=hl-323-6><a class=lnlinks href=#hl-323-6> 6</a>
</span><span class=lnt id=hl-323-7><a class=lnlinks href=#hl-323-7> 7</a>
</span><span class=lnt id=hl-323-8><a class=lnlinks href=#hl-323-8> 8</a>
</span><span class=lnt id=hl-323-9><a class=lnlinks href=#hl-323-9> 9</a>
</span><span class=lnt id=hl-323-10><a class=lnlinks href=#hl-323-10>10</a>
</span><span class=lnt id=hl-323-11><a class=lnlinks href=#hl-323-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Unsafe</span><span class=w> </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>getUnsafe</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Field</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Student</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Field</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Student</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获得成员变量的偏移量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>long</span><span class=w> </span><span class=n>idOffset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>unsafe</span><span class=p>.</span><span class=na>objectFieldOffset</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>long</span><span class=w> </span><span class=n>nameOffset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>unsafe</span><span class=p>.</span><span class=na>objectFieldOffset</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Student</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Student</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 使用 cas 方法替换成员变量的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=n>student</span><span class=p>,</span><span class=w> </span><span class=n>idOffset</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>20</span><span class=p>);</span><span class=w> </span><span class=c1>// 返回 true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>unsafe</span><span class=p>.</span><span class=na>compareAndSwapObject</span><span class=p>(</span><span class=n>student</span><span class=p>,</span><span class=w> </span><span class=n>nameOffset</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=s>&#34;张三&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 返回 true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>student</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-324-1><a class=lnlinks href=#hl-324-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Student<span class=o>(</span><span class=nv>id</span><span class=o>=</span>20, <span class=nv>name</span><span class=o>=</span>张三<span class=o>)</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=unsafe实现原子整数><a href=#unsafe%e5%ae%9e%e7%8e%b0%e5%8e%9f%e5%ad%90%e6%95%b4%e6%95%b0 class=header-anchor>#</a>
unsafe实现原子整数</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-325-1><a class=lnlinks href=#hl-325-1> 1</a>
</span><span class=lnt id=hl-325-2><a class=lnlinks href=#hl-325-2> 2</a>
</span><span class=lnt id=hl-325-3><a class=lnlinks href=#hl-325-3> 3</a>
</span><span class=lnt id=hl-325-4><a class=lnlinks href=#hl-325-4> 4</a>
</span><span class=lnt id=hl-325-5><a class=lnlinks href=#hl-325-5> 5</a>
</span><span class=lnt id=hl-325-6><a class=lnlinks href=#hl-325-6> 6</a>
</span><span class=lnt id=hl-325-7><a class=lnlinks href=#hl-325-7> 7</a>
</span><span class=lnt id=hl-325-8><a class=lnlinks href=#hl-325-8> 8</a>
</span><span class=lnt id=hl-325-9><a class=lnlinks href=#hl-325-9> 9</a>
</span><span class=lnt id=hl-325-10><a class=lnlinks href=#hl-325-10>10</a>
</span><span class=lnt id=hl-325-11><a class=lnlinks href=#hl-325-11>11</a>
</span><span class=lnt id=hl-325-12><a class=lnlinks href=#hl-325-12>12</a>
</span><span class=lnt id=hl-325-13><a class=lnlinks href=#hl-325-13>13</a>
</span><span class=lnt id=hl-325-14><a class=lnlinks href=#hl-325-14>14</a>
</span><span class=lnt id=hl-325-15><a class=lnlinks href=#hl-325-15>15</a>
</span><span class=lnt id=hl-325-16><a class=lnlinks href=#hl-325-16>16</a>
</span><span class=lnt id=hl-325-17><a class=lnlinks href=#hl-325-17>17</a>
</span><span class=lnt id=hl-325-18><a class=lnlinks href=#hl-325-18>18</a>
</span><span class=lnt id=hl-325-19><a class=lnlinks href=#hl-325-19>19</a>
</span><span class=lnt id=hl-325-20><a class=lnlinks href=#hl-325-20>20</a>
</span><span class=lnt id=hl-325-21><a class=lnlinks href=#hl-325-21>21</a>
</span><span class=lnt id=hl-325-22><a class=lnlinks href=#hl-325-22>22</a>
</span><span class=lnt id=hl-325-23><a class=lnlinks href=#hl-325-23>23</a>
</span><span class=lnt id=hl-325-24><a class=lnlinks href=#hl-325-24>24</a>
</span><span class=lnt id=hl-325-25><a class=lnlinks href=#hl-325-25>25</a>
</span><span class=lnt id=hl-325-26><a class=lnlinks href=#hl-325-26>26</a>
</span><span class=lnt id=hl-325-27><a class=lnlinks href=#hl-325-27>27</a>
</span><span class=lnt id=hl-325-28><a class=lnlinks href=#hl-325-28>28</a>
</span><span class=lnt id=hl-325-29><a class=lnlinks href=#hl-325-29>29</a>
</span><span class=lnt id=hl-325-30><a class=lnlinks href=#hl-325-30>30</a>
</span><span class=lnt id=hl-325-31><a class=lnlinks href=#hl-325-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AtomicData</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Unsafe</span><span class=w> </span><span class=n>unsafe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>DATA_OFFSET</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>getUnsafe</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// data 属性在 DataContainer 对象中的偏移量，用于 Unsafe 直接访问该属性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DATA_OFFSET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unsafe</span><span class=p>.</span><span class=na>objectFieldOffset</span><span class=p>(</span><span class=n>AtomicData</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;data&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchFieldException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AtomicData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decrease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获取共享变量旧值，可以在这一行加入断点，修改 data 调试来加深理解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// cas 尝试修改 data 为 旧值 + amount，如果期间旧值被别的线程改了，返回 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>DATA_OFFSET</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Account 实现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-326-1><a class=lnlinks href=#hl-326-1> 1</a>
</span><span class=lnt id=hl-326-2><a class=lnlinks href=#hl-326-2> 2</a>
</span><span class=lnt id=hl-326-3><a class=lnlinks href=#hl-326-3> 3</a>
</span><span class=lnt id=hl-326-4><a class=lnlinks href=#hl-326-4> 4</a>
</span><span class=lnt id=hl-326-5><a class=lnlinks href=#hl-326-5> 5</a>
</span><span class=lnt id=hl-326-6><a class=lnlinks href=#hl-326-6> 6</a>
</span><span class=lnt id=hl-326-7><a class=lnlinks href=#hl-326-7> 7</a>
</span><span class=lnt id=hl-326-8><a class=lnlinks href=#hl-326-8> 8</a>
</span><span class=lnt id=hl-326-9><a class=lnlinks href=#hl-326-9> 9</a>
</span><span class=lnt id=hl-326-10><a class=lnlinks href=#hl-326-10>10</a>
</span><span class=lnt id=hl-326-11><a class=lnlinks href=#hl-326-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Account</span><span class=p>.</span><span class=na>demo</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Account</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AtomicData</span><span class=w> </span><span class=n>atomicData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicData</span><span class=p>(</span><span class=n>10000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>atomicData</span><span class=p>.</span><span class=na>getData</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>atomicData</span><span class=p>.</span><span class=na>decrease</span><span class=p>(</span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=手动实现原子整数完整版测试><a href=#%e6%89%8b%e5%8a%a8%e5%ae%9e%e7%8e%b0%e5%8e%9f%e5%ad%90%e6%95%b4%e6%95%b0%e5%ae%8c%e6%95%b4%e7%89%88%e6%b5%8b%e8%af%95 class=header-anchor>#</a>
手动实现原子整数完整版+测试</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-327-1><a class=lnlinks href=#hl-327-1>  1</a>
</span><span class=lnt id=hl-327-2><a class=lnlinks href=#hl-327-2>  2</a>
</span><span class=lnt id=hl-327-3><a class=lnlinks href=#hl-327-3>  3</a>
</span><span class=lnt id=hl-327-4><a class=lnlinks href=#hl-327-4>  4</a>
</span><span class=lnt id=hl-327-5><a class=lnlinks href=#hl-327-5>  5</a>
</span><span class=lnt id=hl-327-6><a class=lnlinks href=#hl-327-6>  6</a>
</span><span class=lnt id=hl-327-7><a class=lnlinks href=#hl-327-7>  7</a>
</span><span class=lnt id=hl-327-8><a class=lnlinks href=#hl-327-8>  8</a>
</span><span class=lnt id=hl-327-9><a class=lnlinks href=#hl-327-9>  9</a>
</span><span class=lnt id=hl-327-10><a class=lnlinks href=#hl-327-10> 10</a>
</span><span class=lnt id=hl-327-11><a class=lnlinks href=#hl-327-11> 11</a>
</span><span class=lnt id=hl-327-12><a class=lnlinks href=#hl-327-12> 12</a>
</span><span class=lnt id=hl-327-13><a class=lnlinks href=#hl-327-13> 13</a>
</span><span class=lnt id=hl-327-14><a class=lnlinks href=#hl-327-14> 14</a>
</span><span class=lnt id=hl-327-15><a class=lnlinks href=#hl-327-15> 15</a>
</span><span class=lnt id=hl-327-16><a class=lnlinks href=#hl-327-16> 16</a>
</span><span class=lnt id=hl-327-17><a class=lnlinks href=#hl-327-17> 17</a>
</span><span class=lnt id=hl-327-18><a class=lnlinks href=#hl-327-18> 18</a>
</span><span class=lnt id=hl-327-19><a class=lnlinks href=#hl-327-19> 19</a>
</span><span class=lnt id=hl-327-20><a class=lnlinks href=#hl-327-20> 20</a>
</span><span class=lnt id=hl-327-21><a class=lnlinks href=#hl-327-21> 21</a>
</span><span class=lnt id=hl-327-22><a class=lnlinks href=#hl-327-22> 22</a>
</span><span class=lnt id=hl-327-23><a class=lnlinks href=#hl-327-23> 23</a>
</span><span class=lnt id=hl-327-24><a class=lnlinks href=#hl-327-24> 24</a>
</span><span class=lnt id=hl-327-25><a class=lnlinks href=#hl-327-25> 25</a>
</span><span class=lnt id=hl-327-26><a class=lnlinks href=#hl-327-26> 26</a>
</span><span class=lnt id=hl-327-27><a class=lnlinks href=#hl-327-27> 27</a>
</span><span class=lnt id=hl-327-28><a class=lnlinks href=#hl-327-28> 28</a>
</span><span class=lnt id=hl-327-29><a class=lnlinks href=#hl-327-29> 29</a>
</span><span class=lnt id=hl-327-30><a class=lnlinks href=#hl-327-30> 30</a>
</span><span class=lnt id=hl-327-31><a class=lnlinks href=#hl-327-31> 31</a>
</span><span class=lnt id=hl-327-32><a class=lnlinks href=#hl-327-32> 32</a>
</span><span class=lnt id=hl-327-33><a class=lnlinks href=#hl-327-33> 33</a>
</span><span class=lnt id=hl-327-34><a class=lnlinks href=#hl-327-34> 34</a>
</span><span class=lnt id=hl-327-35><a class=lnlinks href=#hl-327-35> 35</a>
</span><span class=lnt id=hl-327-36><a class=lnlinks href=#hl-327-36> 36</a>
</span><span class=lnt id=hl-327-37><a class=lnlinks href=#hl-327-37> 37</a>
</span><span class=lnt id=hl-327-38><a class=lnlinks href=#hl-327-38> 38</a>
</span><span class=lnt id=hl-327-39><a class=lnlinks href=#hl-327-39> 39</a>
</span><span class=lnt id=hl-327-40><a class=lnlinks href=#hl-327-40> 40</a>
</span><span class=lnt id=hl-327-41><a class=lnlinks href=#hl-327-41> 41</a>
</span><span class=lnt id=hl-327-42><a class=lnlinks href=#hl-327-42> 42</a>
</span><span class=lnt id=hl-327-43><a class=lnlinks href=#hl-327-43> 43</a>
</span><span class=lnt id=hl-327-44><a class=lnlinks href=#hl-327-44> 44</a>
</span><span class=lnt id=hl-327-45><a class=lnlinks href=#hl-327-45> 45</a>
</span><span class=lnt id=hl-327-46><a class=lnlinks href=#hl-327-46> 46</a>
</span><span class=lnt id=hl-327-47><a class=lnlinks href=#hl-327-47> 47</a>
</span><span class=lnt id=hl-327-48><a class=lnlinks href=#hl-327-48> 48</a>
</span><span class=lnt id=hl-327-49><a class=lnlinks href=#hl-327-49> 49</a>
</span><span class=lnt id=hl-327-50><a class=lnlinks href=#hl-327-50> 50</a>
</span><span class=lnt id=hl-327-51><a class=lnlinks href=#hl-327-51> 51</a>
</span><span class=lnt id=hl-327-52><a class=lnlinks href=#hl-327-52> 52</a>
</span><span class=lnt id=hl-327-53><a class=lnlinks href=#hl-327-53> 53</a>
</span><span class=lnt id=hl-327-54><a class=lnlinks href=#hl-327-54> 54</a>
</span><span class=lnt id=hl-327-55><a class=lnlinks href=#hl-327-55> 55</a>
</span><span class=lnt id=hl-327-56><a class=lnlinks href=#hl-327-56> 56</a>
</span><span class=lnt id=hl-327-57><a class=lnlinks href=#hl-327-57> 57</a>
</span><span class=lnt id=hl-327-58><a class=lnlinks href=#hl-327-58> 58</a>
</span><span class=lnt id=hl-327-59><a class=lnlinks href=#hl-327-59> 59</a>
</span><span class=lnt id=hl-327-60><a class=lnlinks href=#hl-327-60> 60</a>
</span><span class=lnt id=hl-327-61><a class=lnlinks href=#hl-327-61> 61</a>
</span><span class=lnt id=hl-327-62><a class=lnlinks href=#hl-327-62> 62</a>
</span><span class=lnt id=hl-327-63><a class=lnlinks href=#hl-327-63> 63</a>
</span><span class=lnt id=hl-327-64><a class=lnlinks href=#hl-327-64> 64</a>
</span><span class=lnt id=hl-327-65><a class=lnlinks href=#hl-327-65> 65</a>
</span><span class=lnt id=hl-327-66><a class=lnlinks href=#hl-327-66> 66</a>
</span><span class=lnt id=hl-327-67><a class=lnlinks href=#hl-327-67> 67</a>
</span><span class=lnt id=hl-327-68><a class=lnlinks href=#hl-327-68> 68</a>
</span><span class=lnt id=hl-327-69><a class=lnlinks href=#hl-327-69> 69</a>
</span><span class=lnt id=hl-327-70><a class=lnlinks href=#hl-327-70> 70</a>
</span><span class=lnt id=hl-327-71><a class=lnlinks href=#hl-327-71> 71</a>
</span><span class=lnt id=hl-327-72><a class=lnlinks href=#hl-327-72> 72</a>
</span><span class=lnt id=hl-327-73><a class=lnlinks href=#hl-327-73> 73</a>
</span><span class=lnt id=hl-327-74><a class=lnlinks href=#hl-327-74> 74</a>
</span><span class=lnt id=hl-327-75><a class=lnlinks href=#hl-327-75> 75</a>
</span><span class=lnt id=hl-327-76><a class=lnlinks href=#hl-327-76> 76</a>
</span><span class=lnt id=hl-327-77><a class=lnlinks href=#hl-327-77> 77</a>
</span><span class=lnt id=hl-327-78><a class=lnlinks href=#hl-327-78> 78</a>
</span><span class=lnt id=hl-327-79><a class=lnlinks href=#hl-327-79> 79</a>
</span><span class=lnt id=hl-327-80><a class=lnlinks href=#hl-327-80> 80</a>
</span><span class=lnt id=hl-327-81><a class=lnlinks href=#hl-327-81> 81</a>
</span><span class=lnt id=hl-327-82><a class=lnlinks href=#hl-327-82> 82</a>
</span><span class=lnt id=hl-327-83><a class=lnlinks href=#hl-327-83> 83</a>
</span><span class=lnt id=hl-327-84><a class=lnlinks href=#hl-327-84> 84</a>
</span><span class=lnt id=hl-327-85><a class=lnlinks href=#hl-327-85> 85</a>
</span><span class=lnt id=hl-327-86><a class=lnlinks href=#hl-327-86> 86</a>
</span><span class=lnt id=hl-327-87><a class=lnlinks href=#hl-327-87> 87</a>
</span><span class=lnt id=hl-327-88><a class=lnlinks href=#hl-327-88> 88</a>
</span><span class=lnt id=hl-327-89><a class=lnlinks href=#hl-327-89> 89</a>
</span><span class=lnt id=hl-327-90><a class=lnlinks href=#hl-327-90> 90</a>
</span><span class=lnt id=hl-327-91><a class=lnlinks href=#hl-327-91> 91</a>
</span><span class=lnt id=hl-327-92><a class=lnlinks href=#hl-327-92> 92</a>
</span><span class=lnt id=hl-327-93><a class=lnlinks href=#hl-327-93> 93</a>
</span><span class=lnt id=hl-327-94><a class=lnlinks href=#hl-327-94> 94</a>
</span><span class=lnt id=hl-327-95><a class=lnlinks href=#hl-327-95> 95</a>
</span><span class=lnt id=hl-327-96><a class=lnlinks href=#hl-327-96> 96</a>
</span><span class=lnt id=hl-327-97><a class=lnlinks href=#hl-327-97> 97</a>
</span><span class=lnt id=hl-327-98><a class=lnlinks href=#hl-327-98> 98</a>
</span><span class=lnt id=hl-327-99><a class=lnlinks href=#hl-327-99> 99</a>
</span><span class=lnt id=hl-327-100><a class=lnlinks href=#hl-327-100>100</a>
</span><span class=lnt id=hl-327-101><a class=lnlinks href=#hl-327-101>101</a>
</span><span class=lnt id=hl-327-102><a class=lnlinks href=#hl-327-102>102</a>
</span><span class=lnt id=hl-327-103><a class=lnlinks href=#hl-327-103>103</a>
</span><span class=lnt id=hl-327-104><a class=lnlinks href=#hl-327-104>104</a>
</span><span class=lnt id=hl-327-105><a class=lnlinks href=#hl-327-105>105</a>
</span><span class=lnt id=hl-327-106><a class=lnlinks href=#hl-327-106>106</a>
</span><span class=lnt id=hl-327-107><a class=lnlinks href=#hl-327-107>107</a>
</span><span class=lnt id=hl-327-108><a class=lnlinks href=#hl-327-108>108</a>
</span><span class=lnt id=hl-327-109><a class=lnlinks href=#hl-327-109>109</a>
</span><span class=lnt id=hl-327-110><a class=lnlinks href=#hl-327-110>110</a>
</span><span class=lnt id=hl-327-111><a class=lnlinks href=#hl-327-111>111</a>
</span><span class=lnt id=hl-327-112><a class=lnlinks href=#hl-327-112>112</a>
</span><span class=lnt id=hl-327-113><a class=lnlinks href=#hl-327-113>113</a>
</span><span class=lnt id=hl-327-114><a class=lnlinks href=#hl-327-114>114</a>
</span><span class=lnt id=hl-327-115><a class=lnlinks href=#hl-327-115>115</a>
</span><span class=lnt id=hl-327-116><a class=lnlinks href=#hl-327-116>116</a>
</span><span class=lnt id=hl-327-117><a class=lnlinks href=#hl-327-117>117</a>
</span><span class=lnt id=hl-327-118><a class=lnlinks href=#hl-327-118>118</a>
</span><span class=lnt id=hl-327-119><a class=lnlinks href=#hl-327-119>119</a>
</span><span class=lnt id=hl-327-120><a class=lnlinks href=#hl-327-120>120</a>
</span><span class=lnt id=hl-327-121><a class=lnlinks href=#hl-327-121>121</a>
</span><span class=lnt id=hl-327-122><a class=lnlinks href=#hl-327-122>122</a>
</span><span class=lnt id=hl-327-123><a class=lnlinks href=#hl-327-123>123</a>
</span><span class=lnt id=hl-327-124><a class=lnlinks href=#hl-327-124>124</a>
</span><span class=lnt id=hl-327-125><a class=lnlinks href=#hl-327-125>125</a>
</span><span class=lnt id=hl-327-126><a class=lnlinks href=#hl-327-126>126</a>
</span><span class=lnt id=hl-327-127><a class=lnlinks href=#hl-327-127>127</a>
</span><span class=lnt id=hl-327-128><a class=lnlinks href=#hl-327-128>128</a>
</span><span class=lnt id=hl-327-129><a class=lnlinks href=#hl-327-129>129</a>
</span><span class=lnt id=hl-327-130><a class=lnlinks href=#hl-327-130>130</a>
</span><span class=lnt id=hl-327-131><a class=lnlinks href=#hl-327-131>131</a>
</span><span class=lnt id=hl-327-132><a class=lnlinks href=#hl-327-132>132</a>
</span><span class=lnt id=hl-327-133><a class=lnlinks href=#hl-327-133>133</a>
</span><span class=lnt id=hl-327-134><a class=lnlinks href=#hl-327-134>134</a>
</span><span class=lnt id=hl-327-135><a class=lnlinks href=#hl-327-135>135</a>
</span><span class=lnt id=hl-327-136><a class=lnlinks href=#hl-327-136>136</a>
</span><span class=lnt id=hl-327-137><a class=lnlinks href=#hl-327-137>137</a>
</span><span class=lnt id=hl-327-138><a class=lnlinks href=#hl-327-138>138</a>
</span><span class=lnt id=hl-327-139><a class=lnlinks href=#hl-327-139>139</a>
</span><span class=lnt id=hl-327-140><a class=lnlinks href=#hl-327-140>140</a>
</span><span class=lnt id=hl-327-141><a class=lnlinks href=#hl-327-141>141</a>
</span><span class=lnt id=hl-327-142><a class=lnlinks href=#hl-327-142>142</a>
</span><span class=lnt id=hl-327-143><a class=lnlinks href=#hl-327-143>143</a>
</span><span class=lnt id=hl-327-144><a class=lnlinks href=#hl-327-144>144</a>
</span><span class=lnt id=hl-327-145><a class=lnlinks href=#hl-327-145>145</a>
</span><span class=lnt id=hl-327-146><a class=lnlinks href=#hl-327-146>146</a>
</span><span class=lnt id=hl-327-147><a class=lnlinks href=#hl-327-147>147</a>
</span><span class=lnt id=hl-327-148><a class=lnlinks href=#hl-327-148>148</a>
</span><span class=lnt id=hl-327-149><a class=lnlinks href=#hl-327-149>149</a>
</span><span class=lnt id=hl-327-150><a class=lnlinks href=#hl-327-150>150</a>
</span><span class=lnt id=hl-327-151><a class=lnlinks href=#hl-327-151>151</a>
</span><span class=lnt id=hl-327-152><a class=lnlinks href=#hl-327-152>152</a>
</span><span class=lnt id=hl-327-153><a class=lnlinks href=#hl-327-153>153</a>
</span><span class=lnt id=hl-327-154><a class=lnlinks href=#hl-327-154>154</a>
</span><span class=lnt id=hl-327-155><a class=lnlinks href=#hl-327-155>155</a>
</span><span class=lnt id=hl-327-156><a class=lnlinks href=#hl-327-156>156</a>
</span><span class=lnt id=hl-327-157><a class=lnlinks href=#hl-327-157>157</a>
</span><span class=lnt id=hl-327-158><a class=lnlinks href=#hl-327-158>158</a>
</span><span class=lnt id=hl-327-159><a class=lnlinks href=#hl-327-159>159</a>
</span><span class=lnt id=hl-327-160><a class=lnlinks href=#hl-327-160>160</a>
</span><span class=lnt id=hl-327-161><a class=lnlinks href=#hl-327-161>161</a>
</span><span class=lnt id=hl-327-162><a class=lnlinks href=#hl-327-162>162</a>
</span><span class=lnt id=hl-327-163><a class=lnlinks href=#hl-327-163>163</a>
</span><span class=lnt id=hl-327-164><a class=lnlinks href=#hl-327-164>164</a>
</span><span class=lnt id=hl-327-165><a class=lnlinks href=#hl-327-165>165</a>
</span><span class=lnt id=hl-327-166><a class=lnlinks href=#hl-327-166>166</a>
</span><span class=lnt id=hl-327-167><a class=lnlinks href=#hl-327-167>167</a>
</span><span class=lnt id=hl-327-168><a class=lnlinks href=#hl-327-168>168</a>
</span><span class=lnt id=hl-327-169><a class=lnlinks href=#hl-327-169>169</a>
</span><span class=lnt id=hl-327-170><a class=lnlinks href=#hl-327-170>170</a>
</span><span class=lnt id=hl-327-171><a class=lnlinks href=#hl-327-171>171</a>
</span><span class=lnt id=hl-327-172><a class=lnlinks href=#hl-327-172>172</a>
</span><span class=lnt id=hl-327-173><a class=lnlinks href=#hl-327-173>173</a>
</span><span class=lnt id=hl-327-174><a class=lnlinks href=#hl-327-174>174</a>
</span><span class=lnt id=hl-327-175><a class=lnlinks href=#hl-327-175>175</a>
</span><span class=lnt id=hl-327-176><a class=lnlinks href=#hl-327-176>176</a>
</span><span class=lnt id=hl-327-177><a class=lnlinks href=#hl-327-177>177</a>
</span><span class=lnt id=hl-327-178><a class=lnlinks href=#hl-327-178>178</a>
</span><span class=lnt id=hl-327-179><a class=lnlinks href=#hl-327-179>179</a>
</span><span class=lnt id=hl-327-180><a class=lnlinks href=#hl-327-180>180</a>
</span><span class=lnt id=hl-327-181><a class=lnlinks href=#hl-327-181>181</a>
</span><span class=lnt id=hl-327-182><a class=lnlinks href=#hl-327-182>182</a>
</span><span class=lnt id=hl-327-183><a class=lnlinks href=#hl-327-183>183</a>
</span><span class=lnt id=hl-327-184><a class=lnlinks href=#hl-327-184>184</a>
</span><span class=lnt id=hl-327-185><a class=lnlinks href=#hl-327-185>185</a>
</span><span class=lnt id=hl-327-186><a class=lnlinks href=#hl-327-186>186</a>
</span><span class=lnt id=hl-327-187><a class=lnlinks href=#hl-327-187>187</a>
</span><span class=lnt id=hl-327-188><a class=lnlinks href=#hl-327-188>188</a>
</span><span class=lnt id=hl-327-189><a class=lnlinks href=#hl-327-189>189</a>
</span><span class=lnt id=hl-327-190><a class=lnlinks href=#hl-327-190>190</a>
</span><span class=lnt id=hl-327-191><a class=lnlinks href=#hl-327-191>191</a>
</span><span class=lnt id=hl-327-192><a class=lnlinks href=#hl-327-192>192</a>
</span><span class=lnt id=hl-327-193><a class=lnlinks href=#hl-327-193>193</a>
</span><span class=lnt id=hl-327-194><a class=lnlinks href=#hl-327-194>194</a>
</span><span class=lnt id=hl-327-195><a class=lnlinks href=#hl-327-195>195</a>
</span><span class=lnt id=hl-327-196><a class=lnlinks href=#hl-327-196>196</a>
</span><span class=lnt id=hl-327-197><a class=lnlinks href=#hl-327-197>197</a>
</span><span class=lnt id=hl-327-198><a class=lnlinks href=#hl-327-198>198</a>
</span><span class=lnt id=hl-327-199><a class=lnlinks href=#hl-327-199>199</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UnsafeAtomicTest</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//赋初始值10000，调用demo后正确的输出结果为0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AccountImpl</span><span class=w> </span><span class=n>account</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AccountImpl</span><span class=p>(</span><span class=n>10000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//结果正确地输出0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>account</span><span class=p>.</span><span class=na>demo</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>interface</span> <span class=nc>Account</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//获取balance的方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//取款的方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>decrease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//演示多线程取款，检查安全性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>default</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ts</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>decrease</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=p>:</span><span class=n>ts</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=p>:</span><span class=n>ts</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>getBalance</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//实现账户类，使用手动实现的原子整数作为余额类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>AccountImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Account</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>UnsafeAtomicInteger</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AccountImpl</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>balance</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnsafeAtomicInteger</span><span class=p>(</span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decrease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>balance</span><span class=p>.</span><span class=na>getAndAccumulate</span><span class=p>(</span><span class=n>amount</span><span class=p>,(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//手动实现原子整数类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UnsafeAtomicInteger</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//将value声明为volatile，因为乐观锁需要可见性。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//需要Unsafe的cas本地方法实现操作。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Unsafe</span><span class=w> </span><span class=n>unsafe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//偏移量，这两个变量很重要且通用、不可变，所以均声明为private static final</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>offset</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//静态代码块初始化unsafe</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>getUnsafe</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//获取value在当前类中的偏移量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unsafe</span><span class=p>.</span><span class=na>objectFieldOffset</span><span class=p>(</span><span class=n>UnsafeAtomicInteger</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchFieldException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//待研究</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>UnsafeAtomicInteger</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>UnsafeAtomicInteger</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>get</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>compareAndSet</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>expext</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>update</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>expext</span><span class=p>,</span><span class=w> </span><span class=n>update</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndIncrement</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//局部变量是必须的，因为多次从主存中读取value的值不可靠。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=n>offset</span><span class=p>,</span><span class=n>oldValue</span><span class=p>,</span><span class=n>oldValue</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>incrementAndGet</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndDecrement</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>decrementAndGet</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndUpdate</span><span class=p>(</span><span class=n>IntUnaryOperator</span><span class=w> </span><span class=n>operator</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operator</span><span class=p>.</span><span class=na>applyAsInt</span><span class=p>(</span><span class=n>oldValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>newValue</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>updateAndGet</span><span class=p>(</span><span class=n>IntUnaryOperator</span><span class=w> </span><span class=n>operator</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operator</span><span class=p>.</span><span class=na>applyAsInt</span><span class=p>(</span><span class=n>oldValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>newValue</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndAccumulate</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>IntBinaryOperator</span><span class=w> </span><span class=n>operator</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operator</span><span class=p>.</span><span class=na>applyAsInt</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>oldValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>newValue</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>accumulateAndGet</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>IntBinaryOperator</span><span class=w> </span><span class=n>operator</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operator</span><span class=p>.</span><span class=na>applyAsInt</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>oldValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>newValue</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UnsafeAccessor</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Unsafe</span><span class=w> </span><span class=nf>getUnsafe</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Unsafe</span><span class=w> </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>field</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>Unsafe</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;theUnsafe&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Unsafe</span><span class=p>)</span><span class=n>field</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unsafe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=69-自定义cas锁><a href=#69-%e8%87%aa%e5%ae%9a%e4%b9%89cas%e9%94%81 class=header-anchor>#</a>
<strong>6.9 自定义cas锁</strong></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-328-1><a class=lnlinks href=#hl-328-1> 1</a>
</span><span class=lnt id=hl-328-2><a class=lnlinks href=#hl-328-2> 2</a>
</span><span class=lnt id=hl-328-3><a class=lnlinks href=#hl-328-3> 3</a>
</span><span class=lnt id=hl-328-4><a class=lnlinks href=#hl-328-4> 4</a>
</span><span class=lnt id=hl-328-5><a class=lnlinks href=#hl-328-5> 5</a>
</span><span class=lnt id=hl-328-6><a class=lnlinks href=#hl-328-6> 6</a>
</span><span class=lnt id=hl-328-7><a class=lnlinks href=#hl-328-7> 7</a>
</span><span class=lnt id=hl-328-8><a class=lnlinks href=#hl-328-8> 8</a>
</span><span class=lnt id=hl-328-9><a class=lnlinks href=#hl-328-9> 9</a>
</span><span class=lnt id=hl-328-10><a class=lnlinks href=#hl-328-10>10</a>
</span><span class=lnt id=hl-328-11><a class=lnlinks href=#hl-328-11>11</a>
</span><span class=lnt id=hl-328-12><a class=lnlinks href=#hl-328-12>12</a>
</span><span class=lnt id=hl-328-13><a class=lnlinks href=#hl-328-13>13</a>
</span><span class=lnt id=hl-328-14><a class=lnlinks href=#hl-328-14>14</a>
</span><span class=lnt id=hl-328-15><a class=lnlinks href=#hl-328-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 不要用于实践！！！</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LockCas</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unlock...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-329-1><a class=lnlinks href=#hl-329-1> 1</a>
</span><span class=lnt id=hl-329-2><a class=lnlinks href=#hl-329-2> 2</a>
</span><span class=lnt id=hl-329-3><a class=lnlinks href=#hl-329-3> 3</a>
</span><span class=lnt id=hl-329-4><a class=lnlinks href=#hl-329-4> 4</a>
</span><span class=lnt id=hl-329-5><a class=lnlinks href=#hl-329-5> 5</a>
</span><span class=lnt id=hl-329-6><a class=lnlinks href=#hl-329-6> 6</a>
</span><span class=lnt id=hl-329-7><a class=lnlinks href=#hl-329-7> 7</a>
</span><span class=lnt id=hl-329-8><a class=lnlinks href=#hl-329-8> 8</a>
</span><span class=lnt id=hl-329-9><a class=lnlinks href=#hl-329-9> 9</a>
</span><span class=lnt id=hl-329-10><a class=lnlinks href=#hl-329-10>10</a>
</span><span class=lnt id=hl-329-11><a class=lnlinks href=#hl-329-11>11</a>
</span><span class=lnt id=hl-329-12><a class=lnlinks href=#hl-329-12>12</a>
</span><span class=lnt id=hl-329-13><a class=lnlinks href=#hl-329-13>13</a>
</span><span class=lnt id=hl-329-14><a class=lnlinks href=#hl-329-14>14</a>
</span><span class=lnt id=hl-329-15><a class=lnlinks href=#hl-329-15>15</a>
</span><span class=lnt id=hl-329-16><a class=lnlinks href=#hl-329-16>16</a>
</span><span class=lnt id=hl-329-17><a class=lnlinks href=#hl-329-17>17</a>
</span><span class=lnt id=hl-329-18><a class=lnlinks href=#hl-329-18>18</a>
</span><span class=lnt id=hl-329-19><a class=lnlinks href=#hl-329-19>19</a>
</span><span class=lnt id=hl-329-20><a class=lnlinks href=#hl-329-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LockCas</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LockCas</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-330-1><a class=lnlinks href=#hl-330-1>1</a>
</span><span class=lnt id=hl-330-2><a class=lnlinks href=#hl-330-2>2</a>
</span><span class=lnt id=hl-330-3><a class=lnlinks href=#hl-330-3>3</a>
</span><span class=lnt id=hl-330-4><a class=lnlinks href=#hl-330-4>4</a>
</span><span class=lnt id=hl-330-5><a class=lnlinks href=#hl-330-5>5</a>
</span><span class=lnt id=hl-330-6><a class=lnlinks href=#hl-330-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:27:07.198 c.Test42 <span class=o>[</span>Thread-0<span class=o>]</span> - begin... 
</span></span><span class=line><span class=cl>18:27:07.202 c.Test42 <span class=o>[</span>Thread-0<span class=o>]</span> - lock... 
</span></span><span class=line><span class=cl>18:27:07.198 c.Test42 <span class=o>[</span>Thread-1<span class=o>]</span> - begin... 
</span></span><span class=line><span class=cl>18:27:08.204 c.Test42 <span class=o>[</span>Thread-0<span class=o>]</span> - unlock... 
</span></span><span class=line><span class=cl>18:27:08.204 c.Test42 <span class=o>[</span>Thread-1<span class=o>]</span> - lock... 
</span></span><span class=line><span class=cl>18:27:08.204 c.Test42 <span class=o>[</span>Thread-1<span class=o>]</span> - unlock... 
</span></span></code></pre></td></tr></table></div></div><h2 id=本章小结-3><a href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-3 class=header-anchor>#</a>
本章小结</h2><ul><li>CAS 与 volatile</li><li>API<ul><li>原子整数</li><li>原子引用</li><li>原子数组</li><li>字段更新器</li><li>原子累加器</li></ul></li><li>Unsafe</li><li><font color=blue>*原理方面</font><ul><li>LongAdder 源码</li><li>伪共享</li></ul></li></ul><h1 id=7共享模型之不可变><a href=#7%e5%85%b1%e4%ba%ab%e6%a8%a1%e5%9e%8b%e4%b9%8b%e4%b8%8d%e5%8f%af%e5%8f%98 class=header-anchor>#</a>
7.共享模型之不可变</h1><h2 id=71-日期转换的问题><a href=#71-%e6%97%a5%e6%9c%9f%e8%bd%ac%e6%8d%a2%e7%9a%84%e9%97%ae%e9%a2%98 class=header-anchor>#</a>
7.1 日期转换的问题</h2><h5 id=问题提出><a href=#%e9%97%ae%e9%a2%98%e6%8f%90%e5%87%ba class=header-anchor>#</a>
问题提出</h5><p>下面的代码在运行时，由于 SimpleDateFormat 不是线程安全的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-331-1><a class=lnlinks href=#hl-331-1> 1</a>
</span><span class=lnt id=hl-331-2><a class=lnlinks href=#hl-331-2> 2</a>
</span><span class=lnt id=hl-331-3><a class=lnlinks href=#hl-331-3> 3</a>
</span><span class=lnt id=hl-331-4><a class=lnlinks href=#hl-331-4> 4</a>
</span><span class=lnt id=hl-331-5><a class=lnlinks href=#hl-331-5> 5</a>
</span><span class=lnt id=hl-331-6><a class=lnlinks href=#hl-331-6> 6</a>
</span><span class=lnt id=hl-331-7><a class=lnlinks href=#hl-331-7> 7</a>
</span><span class=lnt id=hl-331-8><a class=lnlinks href=#hl-331-8> 8</a>
</span><span class=lnt id=hl-331-9><a class=lnlinks href=#hl-331-9> 9</a>
</span><span class=lnt id=hl-331-10><a class=lnlinks href=#hl-331-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>sdf</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=s>&#34;1951-04-21&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>有很大几率出现 java.lang.NumberFormatException 或者出现不正确的日期解析结果，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-332-1><a class=lnlinks href=#hl-332-1> 1</a>
</span><span class=lnt id=hl-332-2><a class=lnlinks href=#hl-332-2> 2</a>
</span><span class=lnt id=hl-332-3><a class=lnlinks href=#hl-332-3> 3</a>
</span><span class=lnt id=hl-332-4><a class=lnlinks href=#hl-332-4> 4</a>
</span><span class=lnt id=hl-332-5><a class=lnlinks href=#hl-332-5> 5</a>
</span><span class=lnt id=hl-332-6><a class=lnlinks href=#hl-332-6> 6</a>
</span><span class=lnt id=hl-332-7><a class=lnlinks href=#hl-332-7> 7</a>
</span><span class=lnt id=hl-332-8><a class=lnlinks href=#hl-332-8> 8</a>
</span><span class=lnt id=hl-332-9><a class=lnlinks href=#hl-332-9> 9</a>
</span><span class=lnt id=hl-332-10><a class=lnlinks href=#hl-332-10>10</a>
</span><span class=lnt id=hl-332-11><a class=lnlinks href=#hl-332-11>11</a>
</span><span class=lnt id=hl-332-12><a class=lnlinks href=#hl-332-12>12</a>
</span><span class=lnt id=hl-332-13><a class=lnlinks href=#hl-332-13>13</a>
</span><span class=lnt id=hl-332-14><a class=lnlinks href=#hl-332-14>14</a>
</span><span class=lnt id=hl-332-15><a class=lnlinks href=#hl-332-15>15</a>
</span><span class=lnt id=hl-332-16><a class=lnlinks href=#hl-332-16>16</a>
</span><span class=lnt id=hl-332-17><a class=lnlinks href=#hl-332-17>17</a>
</span><span class=lnt id=hl-332-18><a class=lnlinks href=#hl-332-18>18</a>
</span><span class=lnt id=hl-332-19><a class=lnlinks href=#hl-332-19>19</a>
</span><span class=lnt id=hl-332-20><a class=lnlinks href=#hl-332-20>20</a>
</span><span class=lnt id=hl-332-21><a class=lnlinks href=#hl-332-21>21</a>
</span><span class=lnt id=hl-332-22><a class=lnlinks href=#hl-332-22>22</a>
</span><span class=lnt id=hl-332-23><a class=lnlinks href=#hl-332-23>23</a>
</span><span class=lnt id=hl-332-24><a class=lnlinks href=#hl-332-24>24</a>
</span><span class=lnt id=hl-332-25><a class=lnlinks href=#hl-332-25>25</a>
</span><span class=lnt id=hl-332-26><a class=lnlinks href=#hl-332-26>26</a>
</span><span class=lnt id=hl-332-27><a class=lnlinks href=#hl-332-27>27</a>
</span><span class=lnt id=hl-332-28><a class=lnlinks href=#hl-332-28>28</a>
</span><span class=lnt id=hl-332-29><a class=lnlinks href=#hl-332-29>29</a>
</span><span class=lnt id=hl-332-30><a class=lnlinks href=#hl-332-30>30</a>
</span><span class=lnt id=hl-332-31><a class=lnlinks href=#hl-332-31>31</a>
</span><span class=lnt id=hl-332-32><a class=lnlinks href=#hl-332-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:10:40.859 <span class=o>[</span>Thread-2<span class=o>]</span> c.TestDateParse - <span class=o>{}</span> 
</span></span><span class=line><span class=cl>java.lang.NumberFormatException: For input string: <span class=s2>&#34;&#34;</span> 
</span></span><span class=line><span class=cl> at java.lang.NumberFormatException.forInputString<span class=o>(</span>NumberFormatException.java:65<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Long.parseLong<span class=o>(</span>Long.java:601<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Long.parseLong<span class=o>(</span>Long.java:631<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DigitList.getLong<span class=o>(</span>DigitList.java:195<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DecimalFormat.parse<span class=o>(</span>DecimalFormat.java:2084<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.SimpleDateFormat.subParse<span class=o>(</span>SimpleDateFormat.java:2162<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.SimpleDateFormat.parse<span class=o>(</span>SimpleDateFormat.java:1514<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DateFormat.parse<span class=o>(</span>DateFormat.java:364<span class=o>)</span> 
</span></span><span class=line><span class=cl> at cn.itcast.n7.TestDateParse.lambda<span class=nv>$test1$0</span><span class=o>(</span>TestDateParse.java:18<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Thread.run<span class=o>(</span>Thread.java:748<span class=o>)</span> 
</span></span><span class=line><span class=cl>19:10:40.859 <span class=o>[</span>Thread-1<span class=o>]</span> c.TestDateParse - <span class=o>{}</span> 
</span></span><span class=line><span class=cl>java.lang.NumberFormatException: empty String 
</span></span><span class=line><span class=cl> at sun.misc.FloatingDecimal.readJavaFormatString<span class=o>(</span>FloatingDecimal.java:1842<span class=o>)</span> 
</span></span><span class=line><span class=cl> at sun.misc.FloatingDecimal.parseDouble<span class=o>(</span>FloatingDecimal.java:110<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Double.parseDouble<span class=o>(</span>Double.java:538<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DigitList.getDouble<span class=o>(</span>DigitList.java:169<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DecimalFormat.parse<span class=o>(</span>DecimalFormat.java:2089<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.SimpleDateFormat.subParse<span class=o>(</span>SimpleDateFormat.java:2162<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.SimpleDateFormat.parse<span class=o>(</span>SimpleDateFormat.java:1514<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DateFormat.parse<span class=o>(</span>DateFormat.java:364<span class=o>)</span> 
</span></span><span class=line><span class=cl> at cn.itcast.n7.TestDateParse.lambda<span class=nv>$test1$0</span><span class=o>(</span>TestDateParse.java:18<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Thread.run<span class=o>(</span>Thread.java:748<span class=o>)</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-8<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-9<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-6<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-4<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-5<span class=o>]</span> c.TestDateParse - Mon Apr <span class=m>21</span> 00:00:00 CST <span class=m>178960645</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-7<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-3<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=思路---同步锁><a href=#%e6%80%9d%e8%b7%af---%e5%90%8c%e6%ad%a5%e9%94%81 class=header-anchor>#</a>
思路 - 同步锁</h5><p>这样虽能解决问题，但带来的是性能上的损失，并不算很好：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-333-1><a class=lnlinks href=#hl-333-1> 1</a>
</span><span class=lnt id=hl-333-2><a class=lnlinks href=#hl-333-2> 2</a>
</span><span class=lnt id=hl-333-3><a class=lnlinks href=#hl-333-3> 3</a>
</span><span class=lnt id=hl-333-4><a class=lnlinks href=#hl-333-4> 4</a>
</span><span class=lnt id=hl-333-5><a class=lnlinks href=#hl-333-5> 5</a>
</span><span class=lnt id=hl-333-6><a class=lnlinks href=#hl-333-6> 6</a>
</span><span class=lnt id=hl-333-7><a class=lnlinks href=#hl-333-7> 7</a>
</span><span class=lnt id=hl-333-8><a class=lnlinks href=#hl-333-8> 8</a>
</span><span class=lnt id=hl-333-9><a class=lnlinks href=#hl-333-9> 9</a>
</span><span class=lnt id=hl-333-10><a class=lnlinks href=#hl-333-10>10</a>
</span><span class=lnt id=hl-333-11><a class=lnlinks href=#hl-333-11>11</a>
</span><span class=lnt id=hl-333-12><a class=lnlinks href=#hl-333-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>50</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>sdf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>sdf</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=s>&#34;1951-04-21&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=思路---不可变><a href=#%e6%80%9d%e8%b7%af---%e4%b8%8d%e5%8f%af%e5%8f%98 class=header-anchor>#</a>
思路 - 不可变</h5><p>如果一个对象在不能够修改其内部状态（属性），那么它就是线程安全的，因为不存在并发修改啊！这样的对象在 Java 中有很多，例如在 Java 8 后，提供了一个新的日期格式化类：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-334-1><a class=lnlinks href=#hl-334-1>1</a>
</span><span class=lnt id=hl-334-2><a class=lnlinks href=#hl-334-2>2</a>
</span><span class=lnt id=hl-334-3><a class=lnlinks href=#hl-334-3>3</a>
</span><span class=lnt id=hl-334-4><a class=lnlinks href=#hl-334-4>4</a>
</span><span class=lnt id=hl-334-5><a class=lnlinks href=#hl-334-5>5</a>
</span><span class=lnt id=hl-334-6><a class=lnlinks href=#hl-334-6>6</a>
</span><span class=lnt id=hl-334-7><a class=lnlinks href=#hl-334-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DateTimeFormatter</span><span class=w> </span><span class=n>dtf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DateTimeFormatter</span><span class=p>.</span><span class=na>ofPattern</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LocalDate</span><span class=w> </span><span class=n>date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dtf</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=s>&#34;2018-10-01&#34;</span><span class=p>,</span><span class=w> </span><span class=n>LocalDate</span><span class=p>::</span><span class=n>from</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>date</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以看 DateTimeFormatter 的文档：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-335-1><a class=lnlinks href=#hl-335-1>1</a>
</span><span class=lnt id=hl-335-2><a class=lnlinks href=#hl-335-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@implSpec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//This class is immutable and thread-safe.</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>不可变对象，实际是另一种避免竞争的方式。</p><h2 id=72-不可变设计><a href=#72-%e4%b8%8d%e5%8f%af%e5%8f%98%e8%ae%be%e8%ae%a1 class=header-anchor>#</a>
7.2 不可变设计</h2><h4 id=string类的设计><a href=#string%e7%b1%bb%e7%9a%84%e8%ae%be%e8%ae%a1 class=header-anchor>#</a>
String类的设计</h4><p>另一个大家更为熟悉的 String 类也是不可变的，以它为例，说明一下不可变设计的要素</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-336-1><a class=lnlinks href=#hl-336-1> 1</a>
</span><span class=lnt id=hl-336-2><a class=lnlinks href=#hl-336-2> 2</a>
</span><span class=lnt id=hl-336-3><a class=lnlinks href=#hl-336-3> 3</a>
</span><span class=lnt id=hl-336-4><a class=lnlinks href=#hl-336-4> 4</a>
</span><span class=lnt id=hl-336-5><a class=lnlinks href=#hl-336-5> 5</a>
</span><span class=lnt id=hl-336-6><a class=lnlinks href=#hl-336-6> 6</a>
</span><span class=lnt id=hl-336-7><a class=lnlinks href=#hl-336-7> 7</a>
</span><span class=lnt id=hl-336-8><a class=lnlinks href=#hl-336-8> 8</a>
</span><span class=lnt id=hl-336-9><a class=lnlinks href=#hl-336-9> 9</a>
</span><span class=lnt id=hl-336-10><a class=lnlinks href=#hl-336-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>String</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>implements</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>Serializable</span><span class=p>,</span><span class=w> </span><span class=n>Comparable</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>CharSequence</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** The value is used for character storage. */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>value</span><span class=o>[]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** Cache the hash code for the string */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=p>;</span><span class=w> </span><span class=c1>// Default to 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>说明：</p><ul><li>将类声明为final，避免被带外星方法的子类继承，从而破坏了不可变性。</li><li>将字符数组声明为final，避免被修改</li><li>hash虽然不是final的，但是其只有在调用<code>hash()</code>方法的时候才被赋值，除此之外再无别的方法修改。</li></ul><h4 id=final-的使用><a href=#final-%e7%9a%84%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
final 的使用</h4><p>发现该类、类中所有属性都是 final 的</p><ul><li>属性用 final 修饰保证了该属性是只读的，不能修改</li><li>类用 final 修饰保证了该类中的方法不能被覆盖，防止子类无意间破坏不可变性</li></ul><h4 id=保护性拷贝><a href=#%e4%bf%9d%e6%8a%a4%e6%80%a7%e6%8b%b7%e8%b4%9d class=header-anchor>#</a>
保护性拷贝</h4><p>但有同学会说，使用字符串时，也有一些跟修改相关的方法啊，比如 substring 等，那么下面就看一看这些方法是 如何实现的，就以 substring 为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-337-1><a class=lnlinks href=#hl-337-1> 1</a>
</span><span class=lnt id=hl-337-2><a class=lnlinks href=#hl-337-2> 2</a>
</span><span class=lnt id=hl-337-3><a class=lnlinks href=#hl-337-3> 3</a>
</span><span class=lnt id=hl-337-4><a class=lnlinks href=#hl-337-4> 4</a>
</span><span class=lnt id=hl-337-5><a class=lnlinks href=#hl-337-5> 5</a>
</span><span class=lnt id=hl-337-6><a class=lnlinks href=#hl-337-6> 6</a>
</span><span class=lnt id=hl-337-7><a class=lnlinks href=#hl-337-7> 7</a>
</span><span class=lnt id=hl-337-8><a class=lnlinks href=#hl-337-8> 8</a>
</span><span class=lnt id=hl-337-9><a class=lnlinks href=#hl-337-9> 9</a>
</span><span class=lnt id=hl-337-10><a class=lnlinks href=#hl-337-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>substring</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>beginIndex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>beginIndex</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringIndexOutOfBoundsException</span><span class=p>(</span><span class=n>beginIndex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>subLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>beginIndex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>subLen</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringIndexOutOfBoundsException</span><span class=p>(</span><span class=n>subLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>beginIndex</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=k>this</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>beginIndex</span><span class=p>,</span><span class=w> </span><span class=n>subLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>发现其内部是调用 String 的构造方法创建了一个新字符串，再进入这个构造看看，是否对 final char[] value 做出 了修改：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-338-1><a class=lnlinks href=#hl-338-1> 1</a>
</span><span class=lnt id=hl-338-2><a class=lnlinks href=#hl-338-2> 2</a>
</span><span class=lnt id=hl-338-3><a class=lnlinks href=#hl-338-3> 3</a>
</span><span class=lnt id=hl-338-4><a class=lnlinks href=#hl-338-4> 4</a>
</span><span class=lnt id=hl-338-5><a class=lnlinks href=#hl-338-5> 5</a>
</span><span class=lnt id=hl-338-6><a class=lnlinks href=#hl-338-6> 6</a>
</span><span class=lnt id=hl-338-7><a class=lnlinks href=#hl-338-7> 7</a>
</span><span class=lnt id=hl-338-8><a class=lnlinks href=#hl-338-8> 8</a>
</span><span class=lnt id=hl-338-9><a class=lnlinks href=#hl-338-9> 9</a>
</span><span class=lnt id=hl-338-10><a class=lnlinks href=#hl-338-10>10</a>
</span><span class=lnt id=hl-338-11><a class=lnlinks href=#hl-338-11>11</a>
</span><span class=lnt id=hl-338-12><a class=lnlinks href=#hl-338-12>12</a>
</span><span class=lnt id=hl-338-13><a class=lnlinks href=#hl-338-13>13</a>
</span><span class=lnt id=hl-338-14><a class=lnlinks href=#hl-338-14>14</a>
</span><span class=lnt id=hl-338-15><a class=lnlinks href=#hl-338-15>15</a>
</span><span class=lnt id=hl-338-16><a class=lnlinks href=#hl-338-16>16</a>
</span><span class=lnt id=hl-338-17><a class=lnlinks href=#hl-338-17>17</a>
</span><span class=lnt id=hl-338-18><a class=lnlinks href=#hl-338-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>String</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=n>value</span><span class=o>[]</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>offset</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringIndexOutOfBoundsException</span><span class=p>(</span><span class=n>offset</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringIndexOutOfBoundsException</span><span class=p>(</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>offset</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>offset</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringIndexOutOfBoundsException</span><span class=p>(</span><span class=n>offset</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>copyOfRange</span><span class=p>(</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=o>+</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果发现也没有，构造新字符串对象时，会生成新的 char[] value，对内容进行复制 。这种通过创建副本对象来避 免共享的手段称之为【保护性拷贝（defensive copy）】</p><h4 id=font-colororange模式之享元font><a href=#font-colororange%e6%a8%a1%e5%bc%8f%e4%b9%8b%e4%ba%ab%e5%85%83font class=header-anchor>#</a>
<font color=orange>*模式之享元</font></h4><h5 id=简介><a href=#%e7%ae%80%e4%bb%8b class=header-anchor>#</a>
简介</h5><p><strong>定义</strong> 英文名称：Flyweight pattern. 当需要重用数量有限的同一类对象时</p><blockquote><p>wikipedia： A flyweight is an object that minimizes memory usage by sharing as much data as possible with other similar objects</p></blockquote><p><strong>出自</strong> &ldquo;Gang of Four&rdquo; design patterns</p><p><strong>归类</strong> Structual patterns</p><h5 id=体现><a href=#%e4%bd%93%e7%8e%b0 class=header-anchor>#</a>
体现</h5><p><strong>包装类</strong></p><p>在JDK中 Boolean，Byte，Short，Integer，Long，Character 等包装类提供了 valueOf 方法，例如 Long 的 valueOf 会缓存 -128~127 之间的 Long 对象，在这个范围之间会重用对象，大于这个范围，才会新建 Long 对 象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-339-1><a class=lnlinks href=#hl-339-1>1</a>
</span><span class=lnt id=hl-339-2><a class=lnlinks href=#hl-339-2>2</a>
</span><span class=lnt id=hl-339-3><a class=lnlinks href=#hl-339-3>3</a>
</span><span class=lnt id=hl-339-4><a class=lnlinks href=#hl-339-4>4</a>
</span><span class=lnt id=hl-339-5><a class=lnlinks href=#hl-339-5>5</a>
</span><span class=lnt id=hl-339-6><a class=lnlinks href=#hl-339-6>6</a>
</span><span class=lnt id=hl-339-7><a class=lnlinks href=#hl-339-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>valueOf</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>l</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>128</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>l</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=o>-</span><span class=n>128</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>127</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// will cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>LongCache</span><span class=p>.</span><span class=na>cache</span><span class=o>[</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>l</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>offset</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Long</span><span class=p>(</span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong>：</p><ul><li>Byte, Short, Long 缓存的范围都是 -128~127</li><li>Character 缓存的范围是 0~127</li><li>Integer的默认范围是 -128~127<ul><li>最小值不能变</li><li>但最大值可以通过调整虚拟机参数 <code>-Djava.lang.Integer.IntegerCache.high</code> 来改变</li></ul></li><li>Boolean 缓存了 TRUE 和 FALSE</li></ul></blockquote><p><strong>String 串池</strong>（不可变、线程安全）</p><p>详见jvm</p><p><strong>BigDecimal BigInteger</strong>(不可变、线程安全)</p><p>一部分数字使用了享元模式进行了缓存。</p><h5 id=手动实现一个连接池><a href=#%e6%89%8b%e5%8a%a8%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e8%bf%9e%e6%8e%a5%e6%b1%a0 class=header-anchor>#</a>
手动实现一个连接池</h5><p>例如：一个线上商城应用，QPS 达到数千，如果每次都重新创建和关闭数据库连接，性能会受到极大影响。 这时 预先创建好一批连接，放入连接池。一次请求到达后，从连接池获取连接，使用完毕后再还回连接池，这样既节约 了连接的创建和关闭时间，也实现了连接的重用，不至于让庞大的连接数压垮数据库。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-340-1><a class=lnlinks href=#hl-340-1> 1</a>
</span><span class=lnt id=hl-340-2><a class=lnlinks href=#hl-340-2> 2</a>
</span><span class=lnt id=hl-340-3><a class=lnlinks href=#hl-340-3> 3</a>
</span><span class=lnt id=hl-340-4><a class=lnlinks href=#hl-340-4> 4</a>
</span><span class=lnt id=hl-340-5><a class=lnlinks href=#hl-340-5> 5</a>
</span><span class=lnt id=hl-340-6><a class=lnlinks href=#hl-340-6> 6</a>
</span><span class=lnt id=hl-340-7><a class=lnlinks href=#hl-340-7> 7</a>
</span><span class=lnt id=hl-340-8><a class=lnlinks href=#hl-340-8> 8</a>
</span><span class=lnt id=hl-340-9><a class=lnlinks href=#hl-340-9> 9</a>
</span><span class=lnt id=hl-340-10><a class=lnlinks href=#hl-340-10>10</a>
</span><span class=lnt id=hl-340-11><a class=lnlinks href=#hl-340-11>11</a>
</span><span class=lnt id=hl-340-12><a class=lnlinks href=#hl-340-12>12</a>
</span><span class=lnt id=hl-340-13><a class=lnlinks href=#hl-340-13>13</a>
</span><span class=lnt id=hl-340-14><a class=lnlinks href=#hl-340-14>14</a>
</span><span class=lnt id=hl-340-15><a class=lnlinks href=#hl-340-15>15</a>
</span><span class=lnt id=hl-340-16><a class=lnlinks href=#hl-340-16>16</a>
</span><span class=lnt id=hl-340-17><a class=lnlinks href=#hl-340-17>17</a>
</span><span class=lnt id=hl-340-18><a class=lnlinks href=#hl-340-18>18</a>
</span><span class=lnt id=hl-340-19><a class=lnlinks href=#hl-340-19>19</a>
</span><span class=lnt id=hl-340-20><a class=lnlinks href=#hl-340-20>20</a>
</span><span class=lnt id=hl-340-21><a class=lnlinks href=#hl-340-21>21</a>
</span><span class=lnt id=hl-340-22><a class=lnlinks href=#hl-340-22>22</a>
</span><span class=lnt id=hl-340-23><a class=lnlinks href=#hl-340-23>23</a>
</span><span class=lnt id=hl-340-24><a class=lnlinks href=#hl-340-24>24</a>
</span><span class=lnt id=hl-340-25><a class=lnlinks href=#hl-340-25>25</a>
</span><span class=lnt id=hl-340-26><a class=lnlinks href=#hl-340-26>26</a>
</span><span class=lnt id=hl-340-27><a class=lnlinks href=#hl-340-27>27</a>
</span><span class=lnt id=hl-340-28><a class=lnlinks href=#hl-340-28>28</a>
</span><span class=lnt id=hl-340-29><a class=lnlinks href=#hl-340-29>29</a>
</span><span class=lnt id=hl-340-30><a class=lnlinks href=#hl-340-30>30</a>
</span><span class=lnt id=hl-340-31><a class=lnlinks href=#hl-340-31>31</a>
</span><span class=lnt id=hl-340-32><a class=lnlinks href=#hl-340-32>32</a>
</span><span class=lnt id=hl-340-33><a class=lnlinks href=#hl-340-33>33</a>
</span><span class=lnt id=hl-340-34><a class=lnlinks href=#hl-340-34>34</a>
</span><span class=lnt id=hl-340-35><a class=lnlinks href=#hl-340-35>35</a>
</span><span class=lnt id=hl-340-36><a class=lnlinks href=#hl-340-36>36</a>
</span><span class=lnt id=hl-340-37><a class=lnlinks href=#hl-340-37>37</a>
</span><span class=lnt id=hl-340-38><a class=lnlinks href=#hl-340-38>38</a>
</span><span class=lnt id=hl-340-39><a class=lnlinks href=#hl-340-39>39</a>
</span><span class=lnt id=hl-340-40><a class=lnlinks href=#hl-340-40>40</a>
</span><span class=lnt id=hl-340-41><a class=lnlinks href=#hl-340-41>41</a>
</span><span class=lnt id=hl-340-42><a class=lnlinks href=#hl-340-42>42</a>
</span><span class=lnt id=hl-340-43><a class=lnlinks href=#hl-340-43>43</a>
</span><span class=lnt id=hl-340-44><a class=lnlinks href=#hl-340-44>44</a>
</span><span class=lnt id=hl-340-45><a class=lnlinks href=#hl-340-45>45</a>
</span><span class=lnt id=hl-340-46><a class=lnlinks href=#hl-340-46>46</a>
</span><span class=lnt id=hl-340-47><a class=lnlinks href=#hl-340-47>47</a>
</span><span class=lnt id=hl-340-48><a class=lnlinks href=#hl-340-48>48</a>
</span><span class=lnt id=hl-340-49><a class=lnlinks href=#hl-340-49>49</a>
</span><span class=lnt id=hl-340-50><a class=lnlinks href=#hl-340-50>50</a>
</span><span class=lnt id=hl-340-51><a class=lnlinks href=#hl-340-51>51</a>
</span><span class=lnt id=hl-340-52><a class=lnlinks href=#hl-340-52>52</a>
</span><span class=lnt id=hl-340-53><a class=lnlinks href=#hl-340-53>53</a>
</span><span class=lnt id=hl-340-54><a class=lnlinks href=#hl-340-54>54</a>
</span><span class=lnt id=hl-340-55><a class=lnlinks href=#hl-340-55>55</a>
</span><span class=lnt id=hl-340-56><a class=lnlinks href=#hl-340-56>56</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Pool</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1. 连接池大小</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2. 连接对象数组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Connection</span><span class=o>[]</span><span class=w> </span><span class=n>connections</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 3. 连接状态数组 0 表示空闲， 1 表示繁忙</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AtomicIntegerArray</span><span class=w> </span><span class=n>states</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 4. 构造方法初始化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Pool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>poolSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>poolSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>connections</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Connection</span><span class=o>[</span><span class=n>poolSize</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>states</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicIntegerArray</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>poolSize</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MockConnection</span><span class=p>(</span><span class=s>&#34;连接&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 5. 借连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=nf>borrow</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 获取空闲连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>states</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>states</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;borrow {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果没有空闲连接，当前线程进入等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;wait...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>this</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 6. 归还连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>free</span><span class=p>(</span><span class=n>Connection</span><span class=w> </span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>states</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;free {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>this</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>MockConnection</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 实现略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>使用连接池：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-341-1><a class=lnlinks href=#hl-341-1> 1</a>
</span><span class=lnt id=hl-341-2><a class=lnlinks href=#hl-341-2> 2</a>
</span><span class=lnt id=hl-341-3><a class=lnlinks href=#hl-341-3> 3</a>
</span><span class=lnt id=hl-341-4><a class=lnlinks href=#hl-341-4> 4</a>
</span><span class=lnt id=hl-341-5><a class=lnlinks href=#hl-341-5> 5</a>
</span><span class=lnt id=hl-341-6><a class=lnlinks href=#hl-341-6> 6</a>
</span><span class=lnt id=hl-341-7><a class=lnlinks href=#hl-341-7> 7</a>
</span><span class=lnt id=hl-341-8><a class=lnlinks href=#hl-341-8> 8</a>
</span><span class=lnt id=hl-341-9><a class=lnlinks href=#hl-341-9> 9</a>
</span><span class=lnt id=hl-341-10><a class=lnlinks href=#hl-341-10>10</a>
</span><span class=lnt id=hl-341-11><a class=lnlinks href=#hl-341-11>11</a>
</span><span class=lnt id=hl-341-12><a class=lnlinks href=#hl-341-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Pool</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Pool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Connection</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>borrow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>1000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pool</span><span class=p>.</span><span class=na>free</span><span class=p>(</span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>以上实现没有考虑：</p><ul><li>连接的动态增长与收缩</li><li>连接保活（可用性检测）</li><li>等待超时处理</li><li>分布式 hash</li></ul><p>对于关系型数据库，有比较成熟的连接池实现，例如c3p0, druid等 对于更通用的对象池，可以考虑使用apache commons pool，例如redis连接池可以参考jedis中关于连接池的实现</p><h4 id=font-colorblue-原理之-finalfont><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-finalfont class=header-anchor>#</a>
<font color=blue>* 原理之 final</font></h4><h5 id=设置-final-变量的原理><a href=#%e8%ae%be%e7%bd%ae-final-%e5%8f%98%e9%87%8f%e7%9a%84%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
设置 final 变量的原理</h5><p>理解了 volatile 原理，再对比 final 的实现就比较简单了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-342-1><a class=lnlinks href=#hl-342-1>1</a>
</span><span class=lnt id=hl-342-2><a class=lnlinks href=#hl-342-2>2</a>
</span><span class=lnt id=hl-342-3><a class=lnlinks href=#hl-342-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestFinal</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>字节码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-343-1><a class=lnlinks href=#hl-343-1>1</a>
</span><span class=lnt id=hl-343-2><a class=lnlinks href=#hl-343-2>2</a>
</span><span class=lnt id=hl-343-3><a class=lnlinks href=#hl-343-3>3</a>
</span><span class=lnt id=hl-343-4><a class=lnlinks href=#hl-343-4>4</a>
</span><span class=lnt id=hl-343-5><a class=lnlinks href=#hl-343-5>5</a>
</span><span class=lnt id=hl-343-6><a class=lnlinks href=#hl-343-6>6</a>
</span><span class=lnt id=hl-343-7><a class=lnlinks href=#hl-343-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>0: aload_0
</span></span><span class=line><span class=cl>1: invokespecial <span class=c1>#1 // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class=line><span class=cl>4: aload_0
</span></span><span class=line><span class=cl>5: bipush <span class=m>20</span>
</span></span><span class=line><span class=cl>7: putfield <span class=c1>#2 // Field a:I</span>
</span></span><span class=line><span class=cl> &lt;-- 写屏障
</span></span><span class=line><span class=cl>10: <span class=k>return</span>
</span></span></code></pre></td></tr></table></div></div><p>发现 final 变量的赋值也会通过 putfield 指令来完成，同样在这条指令之后也会加入写屏障，这样对final变量的写入不会重排序到构造方法之外，保证在其它线程读到 它的值时不会出现为 0 的情况。普通变量不能保证这一点了。</p><h5 id=读取final变量原理><a href=#%e8%af%bb%e5%8f%96final%e5%8f%98%e9%87%8f%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
读取final变量原理</h5><p>有以下代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-344-1><a class=lnlinks href=#hl-344-1> 1</a>
</span><span class=lnt id=hl-344-2><a class=lnlinks href=#hl-344-2> 2</a>
</span><span class=lnt id=hl-344-3><a class=lnlinks href=#hl-344-3> 3</a>
</span><span class=lnt id=hl-344-4><a class=lnlinks href=#hl-344-4> 4</a>
</span><span class=lnt id=hl-344-5><a class=lnlinks href=#hl-344-5> 5</a>
</span><span class=lnt id=hl-344-6><a class=lnlinks href=#hl-344-6> 6</a>
</span><span class=lnt id=hl-344-7><a class=lnlinks href=#hl-344-7> 7</a>
</span><span class=lnt id=hl-344-8><a class=lnlinks href=#hl-344-8> 8</a>
</span><span class=lnt id=hl-344-9><a class=lnlinks href=#hl-344-9> 9</a>
</span><span class=lnt id=hl-344-10><a class=lnlinks href=#hl-344-10>10</a>
</span><span class=lnt id=hl-344-11><a class=lnlinks href=#hl-344-11>11</a>
</span><span class=lnt id=hl-344-12><a class=lnlinks href=#hl-344-12>12</a>
</span><span class=lnt id=hl-344-13><a class=lnlinks href=#hl-344-13>13</a>
</span><span class=lnt id=hl-344-14><a class=lnlinks href=#hl-344-14>14</a>
</span><span class=lnt id=hl-344-15><a class=lnlinks href=#hl-344-15>15</a>
</span><span class=lnt id=hl-344-16><a class=lnlinks href=#hl-344-16>16</a>
</span><span class=lnt id=hl-344-17><a class=lnlinks href=#hl-344-17>17</a>
</span><span class=lnt id=hl-344-18><a class=lnlinks href=#hl-344-18>18</a>
</span><span class=lnt id=hl-344-19><a class=lnlinks href=#hl-344-19>19</a>
</span><span class=lnt id=hl-344-20><a class=lnlinks href=#hl-344-20>20</a>
</span><span class=lnt id=hl-344-21><a class=lnlinks href=#hl-344-21>21</a>
</span><span class=lnt id=hl-344-22><a class=lnlinks href=#hl-344-22>22</a>
</span><span class=lnt id=hl-344-23><a class=lnlinks href=#hl-344-23>23</a>
</span><span class=lnt id=hl-344-24><a class=lnlinks href=#hl-344-24>24</a>
</span><span class=lnt id=hl-344-25><a class=lnlinks href=#hl-344-25>25</a>
</span><span class=lnt id=hl-344-26><a class=lnlinks href=#hl-344-26>26</a>
</span><span class=lnt id=hl-344-27><a class=lnlinks href=#hl-344-27>27</a>
</span><span class=lnt id=hl-344-28><a class=lnlinks href=#hl-344-28>28</a>
</span><span class=lnt id=hl-344-29><a class=lnlinks href=#hl-344-29>29</a>
</span><span class=lnt id=hl-344-30><a class=lnlinks href=#hl-344-30>30</a>
</span><span class=lnt id=hl-344-31><a class=lnlinks href=#hl-344-31>31</a>
</span><span class=lnt id=hl-344-32><a class=lnlinks href=#hl-344-32>32</a>
</span><span class=lnt id=hl-344-33><a class=lnlinks href=#hl-344-33>33</a>
</span><span class=lnt id=hl-344-34><a class=lnlinks href=#hl-344-34>34</a>
</span><span class=lnt id=hl-344-35><a class=lnlinks href=#hl-344-35>35</a>
</span><span class=lnt id=hl-344-36><a class=lnlinks href=#hl-344-36>36</a>
</span><span class=lnt id=hl-344-37><a class=lnlinks href=#hl-344-37>37</a>
</span><span class=lnt id=hl-344-38><a class=lnlinks href=#hl-344-38>38</a>
</span><span class=lnt id=hl-344-39><a class=lnlinks href=#hl-344-39>39</a>
</span><span class=lnt id=hl-344-40><a class=lnlinks href=#hl-344-40>40</a>
</span><span class=lnt id=hl-344-41><a class=lnlinks href=#hl-344-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestFinal</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>A</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>B</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Short</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=o>+</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>30</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>30</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>class</span> <span class=nc>Task</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>d</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Task</span><span class=p>()).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UseFinal1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>TestFinal</span><span class=p>.</span><span class=na>A</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>TestFinal</span><span class=p>.</span><span class=na>B</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TestFinal</span><span class=p>().</span><span class=na>a</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TestFinal</span><span class=p>().</span><span class=na>b</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>TestFinal</span><span class=p>().</span><span class=na>test1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UseFinal2</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>TestFinal</span><span class=p>.</span><span class=na>A</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>反编译UseFinal1中的test方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-345-1><a class=lnlinks href=#hl-345-1> 1</a>
</span><span class=lnt id=hl-345-2><a class=lnlinks href=#hl-345-2> 2</a>
</span><span class=lnt id=hl-345-3><a class=lnlinks href=#hl-345-3> 3</a>
</span><span class=lnt id=hl-345-4><a class=lnlinks href=#hl-345-4> 4</a>
</span><span class=lnt id=hl-345-5><a class=lnlinks href=#hl-345-5> 5</a>
</span><span class=lnt id=hl-345-6><a class=lnlinks href=#hl-345-6> 6</a>
</span><span class=lnt id=hl-345-7><a class=lnlinks href=#hl-345-7> 7</a>
</span><span class=lnt id=hl-345-8><a class=lnlinks href=#hl-345-8> 8</a>
</span><span class=lnt id=hl-345-9><a class=lnlinks href=#hl-345-9> 9</a>
</span><span class=lnt id=hl-345-10><a class=lnlinks href=#hl-345-10>10</a>
</span><span class=lnt id=hl-345-11><a class=lnlinks href=#hl-345-11>11</a>
</span><span class=lnt id=hl-345-12><a class=lnlinks href=#hl-345-12>12</a>
</span><span class=lnt id=hl-345-13><a class=lnlinks href=#hl-345-13>13</a>
</span><span class=lnt id=hl-345-14><a class=lnlinks href=#hl-345-14>14</a>
</span><span class=lnt id=hl-345-15><a class=lnlinks href=#hl-345-15>15</a>
</span><span class=lnt id=hl-345-16><a class=lnlinks href=#hl-345-16>16</a>
</span><span class=lnt id=hl-345-17><a class=lnlinks href=#hl-345-17>17</a>
</span><span class=lnt id=hl-345-18><a class=lnlinks href=#hl-345-18>18</a>
</span><span class=lnt id=hl-345-19><a class=lnlinks href=#hl-345-19>19</a>
</span><span class=lnt id=hl-345-20><a class=lnlinks href=#hl-345-20>20</a>
</span><span class=lnt id=hl-345-21><a class=lnlinks href=#hl-345-21>21</a>
</span><span class=lnt id=hl-345-22><a class=lnlinks href=#hl-345-22>22</a>
</span><span class=lnt id=hl-345-23><a class=lnlinks href=#hl-345-23>23</a>
</span><span class=lnt id=hl-345-24><a class=lnlinks href=#hl-345-24>24</a>
</span><span class=lnt id=hl-345-25><a class=lnlinks href=#hl-345-25>25</a>
</span><span class=lnt id=hl-345-26><a class=lnlinks href=#hl-345-26>26</a>
</span><span class=lnt id=hl-345-27><a class=lnlinks href=#hl-345-27>27</a>
</span><span class=lnt id=hl-345-28><a class=lnlinks href=#hl-345-28>28</a>
</span><span class=lnt id=hl-345-29><a class=lnlinks href=#hl-345-29>29</a>
</span><span class=lnt id=hl-345-30><a class=lnlinks href=#hl-345-30>30</a>
</span><span class=lnt id=hl-345-31><a class=lnlinks href=#hl-345-31>31</a>
</span><span class=lnt id=hl-345-32><a class=lnlinks href=#hl-345-32>32</a>
</span><span class=lnt id=hl-345-33><a class=lnlinks href=#hl-345-33>33</a>
</span><span class=lnt id=hl-345-34><a class=lnlinks href=#hl-345-34>34</a>
</span><span class=lnt id=hl-345-35><a class=lnlinks href=#hl-345-35>35</a>
</span><span class=lnt id=hl-345-36><a class=lnlinks href=#hl-345-36>36</a>
</span><span class=lnt id=hl-345-37><a class=lnlinks href=#hl-345-37>37</a>
</span><span class=lnt id=hl-345-38><a class=lnlinks href=#hl-345-38>38</a>
</span><span class=lnt id=hl-345-39><a class=lnlinks href=#hl-345-39>39</a>
</span><span class=lnt id=hl-345-40><a class=lnlinks href=#hl-345-40>40</a>
</span><span class=lnt id=hl-345-41><a class=lnlinks href=#hl-345-41>41</a>
</span><span class=lnt id=hl-345-42><a class=lnlinks href=#hl-345-42>42</a>
</span><span class=lnt id=hl-345-43><a class=lnlinks href=#hl-345-43>43</a>
</span><span class=lnt id=hl-345-44><a class=lnlinks href=#hl-345-44>44</a>
</span><span class=lnt id=hl-345-45><a class=lnlinks href=#hl-345-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>31</span><span class=w> </span><span class=n>L0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GETSTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BIPUSH</span><span class=w> </span><span class=n>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>.</span><span class=na>println</span><span class=w> </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>32</span><span class=w> </span><span class=n>L1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GETSTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LDC</span><span class=w> </span><span class=n>32768</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>.</span><span class=na>println</span><span class=w> </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>33</span><span class=w> </span><span class=n>L2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GETSTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NEW</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DUP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKESPECIAL</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=p>.</span><span class=o>&lt;</span><span class=n>init</span><span class=o>&gt;</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Object</span><span class=p>.</span><span class=na>getClass</span><span class=w> </span><span class=p>()</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Class</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>POP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BIPUSH</span><span class=w> </span><span class=n>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>.</span><span class=na>println</span><span class=w> </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>34</span><span class=w> </span><span class=n>L3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GETSTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NEW</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DUP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKESPECIAL</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=p>.</span><span class=o>&lt;</span><span class=n>init</span><span class=o>&gt;</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Object</span><span class=p>.</span><span class=na>getClass</span><span class=w> </span><span class=p>()</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Class</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>POP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LDC</span><span class=w> </span><span class=n>2147483647</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>.</span><span class=na>println</span><span class=w> </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>35</span><span class=w> </span><span class=n>L4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NEW</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DUP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKESPECIAL</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=p>.</span><span class=o>&lt;</span><span class=n>init</span><span class=o>&gt;</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=p>.</span><span class=na>test1</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>36</span><span class=w> </span><span class=n>L5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RETURN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LOCALVARIABLE</span><span class=w> </span><span class=k>this</span><span class=w> </span><span class=n>Lcn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>UseFinal1</span><span class=p>;</span><span class=w> </span><span class=n>L0</span><span class=w> </span><span class=n>L6</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MAXSTACK</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MAXLOCALS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以看见，jvm对final变量的访问做出了优化：另一个类中的方法调用final变量是，不是从final变量所在类中获取（共享内存），而是直接复制一份到方法栈栈帧中的操作数栈中（工作内存），这样可以提升效率，是一种优化。</p><p>总结：</p><ul><li>对于较小的static final变量：复制一份到操作数栈中</li><li>对于较大的static final变量：复制一份到当前类的常量池中</li><li>对于非静态final变量，优化同上。</li></ul><h5 id=final总结><a href=#final%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
final总结</h5><p><strong>final关键字的好处：</strong></p><p>（1）final关键字提高了性能。JVM和Java应用都会缓存final变量。</p><p>（2）final变量可以安全的在多线程环境下进行共享，而不需要额外的同步开销。</p><p>（3）使用final关键字，JVM会对方法、变量及类进行优化。</p><p><strong>关于final的重要知识点</strong></p><p>1、final关键字可以用于成员变量、本地变量、方法以及类。</p><p>2、final成员变量必须在声明的时候初始化或者在构造器中初始化，否则就会报编译错误。</p><p>3、你不能够对final变量再次赋值。</p><p>4、本地变量必须在声明时赋值。</p><p>5、在匿名类中所有变量都必须是final变量。</p><p>6、final方法不能被重写。</p><p>7、final类不能被继承。</p><p>8、final关键字不同于finally关键字，后者用于异常处理。</p><p>9、final关键字容易与finalize()方法搞混，后者是在Object类中定义的方法，是在垃圾回收之前被JVM调用的方法。</p><p>10、接口中声明的所有变量本身是final的。</p><p>11、final和abstract这两个关键字是反相关的，final类就不可能是abstract的。</p><p>12、final方法在编译阶段绑定，称为静态绑定(static binding)。</p><p>13、没有在声明时初始化final变量的称为空白final变量(blank final variable)，它们必须在构造器中初始化，或者调用this()初始化。不这么做的话，编译器会报错“final变量(变量名)需要进行初始化”。</p><p>14、将类、方法、变量声明为final能够提高性能，这样JVM就有机会进行估计，然后优化。</p><p>15、按照Java代码惯例，final变量就是常量，而且通常常量名要大写。</p><p>16、对于集合对象声明为final指的是引用不能被更改，但是你可以向其中增加，删除或者改变内容。</p><blockquote><p>参考链接：<a class=link href=https://www.php.cn/java-article-413390.html target=_blank rel=noopener>Java中final实现原理的深入分析（附示例）-java教程-PHP中文网
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></blockquote><h2 id=73-无状态><a href=#73-%e6%97%a0%e7%8a%b6%e6%80%81 class=header-anchor>#</a>
7.3 无状态</h2><p>在 web 阶段学习时，设计 Servlet 时为了保证其线程安全，都会有这样的建议，不要为 Servlet 设置成员变量，这 种没有任何成员变量的类是线程安全的 。</p><blockquote><p>因为成员变量保存的数据也可以称为状态信息，因此没有成员变量就称之为【无状态】</p></blockquote><h1 id=8共享模型之工具><a href=#8%e5%85%b1%e4%ba%ab%e6%a8%a1%e5%9e%8b%e4%b9%8b%e5%b7%a5%e5%85%b7 class=header-anchor>#</a>
8.共享模型之工具</h1><h2 id=线程池><a href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0 class=header-anchor>#</a>
线程池</h2><h4 id=自定义线程池><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e7%ba%bf%e7%a8%8b%e6%b1%a0 class=header-anchor>#</a>
自定义线程池</h4><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220311170716250.png width=900 height=600 loading=lazy decoding=async alt=image-20220311170716250 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>步骤1：自定义拒绝策略接口</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-346-1><a class=lnlinks href=#hl-346-1>1</a>
</span><span class=lnt id=hl-346-2><a class=lnlinks href=#hl-346-2>2</a>
</span><span class=lnt id=hl-346-3><a class=lnlinks href=#hl-346-3>3</a>
</span><span class=lnt id=hl-346-4><a class=lnlinks href=#hl-346-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@FunctionalInterface</span><span class=w> </span><span class=c1>//拒绝策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>interface</span> <span class=nc>RejectPolicy</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>reject</span><span class=p>(</span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=p>,</span><span class=n>T</span><span class=w> </span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>步骤2：自定义任务队列</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-347-1><a class=lnlinks href=#hl-347-1>  1</a>
</span><span class=lnt id=hl-347-2><a class=lnlinks href=#hl-347-2>  2</a>
</span><span class=lnt id=hl-347-3><a class=lnlinks href=#hl-347-3>  3</a>
</span><span class=lnt id=hl-347-4><a class=lnlinks href=#hl-347-4>  4</a>
</span><span class=lnt id=hl-347-5><a class=lnlinks href=#hl-347-5>  5</a>
</span><span class=lnt id=hl-347-6><a class=lnlinks href=#hl-347-6>  6</a>
</span><span class=lnt id=hl-347-7><a class=lnlinks href=#hl-347-7>  7</a>
</span><span class=lnt id=hl-347-8><a class=lnlinks href=#hl-347-8>  8</a>
</span><span class=lnt id=hl-347-9><a class=lnlinks href=#hl-347-9>  9</a>
</span><span class=lnt id=hl-347-10><a class=lnlinks href=#hl-347-10> 10</a>
</span><span class=lnt id=hl-347-11><a class=lnlinks href=#hl-347-11> 11</a>
</span><span class=lnt id=hl-347-12><a class=lnlinks href=#hl-347-12> 12</a>
</span><span class=lnt id=hl-347-13><a class=lnlinks href=#hl-347-13> 13</a>
</span><span class=lnt id=hl-347-14><a class=lnlinks href=#hl-347-14> 14</a>
</span><span class=lnt id=hl-347-15><a class=lnlinks href=#hl-347-15> 15</a>
</span><span class=lnt id=hl-347-16><a class=lnlinks href=#hl-347-16> 16</a>
</span><span class=lnt id=hl-347-17><a class=lnlinks href=#hl-347-17> 17</a>
</span><span class=lnt id=hl-347-18><a class=lnlinks href=#hl-347-18> 18</a>
</span><span class=lnt id=hl-347-19><a class=lnlinks href=#hl-347-19> 19</a>
</span><span class=lnt id=hl-347-20><a class=lnlinks href=#hl-347-20> 20</a>
</span><span class=lnt id=hl-347-21><a class=lnlinks href=#hl-347-21> 21</a>
</span><span class=lnt id=hl-347-22><a class=lnlinks href=#hl-347-22> 22</a>
</span><span class=lnt id=hl-347-23><a class=lnlinks href=#hl-347-23> 23</a>
</span><span class=lnt id=hl-347-24><a class=lnlinks href=#hl-347-24> 24</a>
</span><span class=lnt id=hl-347-25><a class=lnlinks href=#hl-347-25> 25</a>
</span><span class=lnt id=hl-347-26><a class=lnlinks href=#hl-347-26> 26</a>
</span><span class=lnt id=hl-347-27><a class=lnlinks href=#hl-347-27> 27</a>
</span><span class=lnt id=hl-347-28><a class=lnlinks href=#hl-347-28> 28</a>
</span><span class=lnt id=hl-347-29><a class=lnlinks href=#hl-347-29> 29</a>
</span><span class=lnt id=hl-347-30><a class=lnlinks href=#hl-347-30> 30</a>
</span><span class=lnt id=hl-347-31><a class=lnlinks href=#hl-347-31> 31</a>
</span><span class=lnt id=hl-347-32><a class=lnlinks href=#hl-347-32> 32</a>
</span><span class=lnt id=hl-347-33><a class=lnlinks href=#hl-347-33> 33</a>
</span><span class=lnt id=hl-347-34><a class=lnlinks href=#hl-347-34> 34</a>
</span><span class=lnt id=hl-347-35><a class=lnlinks href=#hl-347-35> 35</a>
</span><span class=lnt id=hl-347-36><a class=lnlinks href=#hl-347-36> 36</a>
</span><span class=lnt id=hl-347-37><a class=lnlinks href=#hl-347-37> 37</a>
</span><span class=lnt id=hl-347-38><a class=lnlinks href=#hl-347-38> 38</a>
</span><span class=lnt id=hl-347-39><a class=lnlinks href=#hl-347-39> 39</a>
</span><span class=lnt id=hl-347-40><a class=lnlinks href=#hl-347-40> 40</a>
</span><span class=lnt id=hl-347-41><a class=lnlinks href=#hl-347-41> 41</a>
</span><span class=lnt id=hl-347-42><a class=lnlinks href=#hl-347-42> 42</a>
</span><span class=lnt id=hl-347-43><a class=lnlinks href=#hl-347-43> 43</a>
</span><span class=lnt id=hl-347-44><a class=lnlinks href=#hl-347-44> 44</a>
</span><span class=lnt id=hl-347-45><a class=lnlinks href=#hl-347-45> 45</a>
</span><span class=lnt id=hl-347-46><a class=lnlinks href=#hl-347-46> 46</a>
</span><span class=lnt id=hl-347-47><a class=lnlinks href=#hl-347-47> 47</a>
</span><span class=lnt id=hl-347-48><a class=lnlinks href=#hl-347-48> 48</a>
</span><span class=lnt id=hl-347-49><a class=lnlinks href=#hl-347-49> 49</a>
</span><span class=lnt id=hl-347-50><a class=lnlinks href=#hl-347-50> 50</a>
</span><span class=lnt id=hl-347-51><a class=lnlinks href=#hl-347-51> 51</a>
</span><span class=lnt id=hl-347-52><a class=lnlinks href=#hl-347-52> 52</a>
</span><span class=lnt id=hl-347-53><a class=lnlinks href=#hl-347-53> 53</a>
</span><span class=lnt id=hl-347-54><a class=lnlinks href=#hl-347-54> 54</a>
</span><span class=lnt id=hl-347-55><a class=lnlinks href=#hl-347-55> 55</a>
</span><span class=lnt id=hl-347-56><a class=lnlinks href=#hl-347-56> 56</a>
</span><span class=lnt id=hl-347-57><a class=lnlinks href=#hl-347-57> 57</a>
</span><span class=lnt id=hl-347-58><a class=lnlinks href=#hl-347-58> 58</a>
</span><span class=lnt id=hl-347-59><a class=lnlinks href=#hl-347-59> 59</a>
</span><span class=lnt id=hl-347-60><a class=lnlinks href=#hl-347-60> 60</a>
</span><span class=lnt id=hl-347-61><a class=lnlinks href=#hl-347-61> 61</a>
</span><span class=lnt id=hl-347-62><a class=lnlinks href=#hl-347-62> 62</a>
</span><span class=lnt id=hl-347-63><a class=lnlinks href=#hl-347-63> 63</a>
</span><span class=lnt id=hl-347-64><a class=lnlinks href=#hl-347-64> 64</a>
</span><span class=lnt id=hl-347-65><a class=lnlinks href=#hl-347-65> 65</a>
</span><span class=lnt id=hl-347-66><a class=lnlinks href=#hl-347-66> 66</a>
</span><span class=lnt id=hl-347-67><a class=lnlinks href=#hl-347-67> 67</a>
</span><span class=lnt id=hl-347-68><a class=lnlinks href=#hl-347-68> 68</a>
</span><span class=lnt id=hl-347-69><a class=lnlinks href=#hl-347-69> 69</a>
</span><span class=lnt id=hl-347-70><a class=lnlinks href=#hl-347-70> 70</a>
</span><span class=lnt id=hl-347-71><a class=lnlinks href=#hl-347-71> 71</a>
</span><span class=lnt id=hl-347-72><a class=lnlinks href=#hl-347-72> 72</a>
</span><span class=lnt id=hl-347-73><a class=lnlinks href=#hl-347-73> 73</a>
</span><span class=lnt id=hl-347-74><a class=lnlinks href=#hl-347-74> 74</a>
</span><span class=lnt id=hl-347-75><a class=lnlinks href=#hl-347-75> 75</a>
</span><span class=lnt id=hl-347-76><a class=lnlinks href=#hl-347-76> 76</a>
</span><span class=lnt id=hl-347-77><a class=lnlinks href=#hl-347-77> 77</a>
</span><span class=lnt id=hl-347-78><a class=lnlinks href=#hl-347-78> 78</a>
</span><span class=lnt id=hl-347-79><a class=lnlinks href=#hl-347-79> 79</a>
</span><span class=lnt id=hl-347-80><a class=lnlinks href=#hl-347-80> 80</a>
</span><span class=lnt id=hl-347-81><a class=lnlinks href=#hl-347-81> 81</a>
</span><span class=lnt id=hl-347-82><a class=lnlinks href=#hl-347-82> 82</a>
</span><span class=lnt id=hl-347-83><a class=lnlinks href=#hl-347-83> 83</a>
</span><span class=lnt id=hl-347-84><a class=lnlinks href=#hl-347-84> 84</a>
</span><span class=lnt id=hl-347-85><a class=lnlinks href=#hl-347-85> 85</a>
</span><span class=lnt id=hl-347-86><a class=lnlinks href=#hl-347-86> 86</a>
</span><span class=lnt id=hl-347-87><a class=lnlinks href=#hl-347-87> 87</a>
</span><span class=lnt id=hl-347-88><a class=lnlinks href=#hl-347-88> 88</a>
</span><span class=lnt id=hl-347-89><a class=lnlinks href=#hl-347-89> 89</a>
</span><span class=lnt id=hl-347-90><a class=lnlinks href=#hl-347-90> 90</a>
</span><span class=lnt id=hl-347-91><a class=lnlinks href=#hl-347-91> 91</a>
</span><span class=lnt id=hl-347-92><a class=lnlinks href=#hl-347-92> 92</a>
</span><span class=lnt id=hl-347-93><a class=lnlinks href=#hl-347-93> 93</a>
</span><span class=lnt id=hl-347-94><a class=lnlinks href=#hl-347-94> 94</a>
</span><span class=lnt id=hl-347-95><a class=lnlinks href=#hl-347-95> 95</a>
</span><span class=lnt id=hl-347-96><a class=lnlinks href=#hl-347-96> 96</a>
</span><span class=lnt id=hl-347-97><a class=lnlinks href=#hl-347-97> 97</a>
</span><span class=lnt id=hl-347-98><a class=lnlinks href=#hl-347-98> 98</a>
</span><span class=lnt id=hl-347-99><a class=lnlinks href=#hl-347-99> 99</a>
</span><span class=lnt id=hl-347-100><a class=lnlinks href=#hl-347-100>100</a>
</span><span class=lnt id=hl-347-101><a class=lnlinks href=#hl-347-101>101</a>
</span><span class=lnt id=hl-347-102><a class=lnlinks href=#hl-347-102>102</a>
</span><span class=lnt id=hl-347-103><a class=lnlinks href=#hl-347-103>103</a>
</span><span class=lnt id=hl-347-104><a class=lnlinks href=#hl-347-104>104</a>
</span><span class=lnt id=hl-347-105><a class=lnlinks href=#hl-347-105>105</a>
</span><span class=lnt id=hl-347-106><a class=lnlinks href=#hl-347-106>106</a>
</span><span class=lnt id=hl-347-107><a class=lnlinks href=#hl-347-107>107</a>
</span><span class=lnt id=hl-347-108><a class=lnlinks href=#hl-347-108>108</a>
</span><span class=lnt id=hl-347-109><a class=lnlinks href=#hl-347-109>109</a>
</span><span class=lnt id=hl-347-110><a class=lnlinks href=#hl-347-110>110</a>
</span><span class=lnt id=hl-347-111><a class=lnlinks href=#hl-347-111>111</a>
</span><span class=lnt id=hl-347-112><a class=lnlinks href=#hl-347-112>112</a>
</span><span class=lnt id=hl-347-113><a class=lnlinks href=#hl-347-113>113</a>
</span><span class=lnt id=hl-347-114><a class=lnlinks href=#hl-347-114>114</a>
</span><span class=lnt id=hl-347-115><a class=lnlinks href=#hl-347-115>115</a>
</span><span class=lnt id=hl-347-116><a class=lnlinks href=#hl-347-116>116</a>
</span><span class=lnt id=hl-347-117><a class=lnlinks href=#hl-347-117>117</a>
</span><span class=lnt id=hl-347-118><a class=lnlinks href=#hl-347-118>118</a>
</span><span class=lnt id=hl-347-119><a class=lnlinks href=#hl-347-119>119</a>
</span><span class=lnt id=hl-347-120><a class=lnlinks href=#hl-347-120>120</a>
</span><span class=lnt id=hl-347-121><a class=lnlinks href=#hl-347-121>121</a>
</span><span class=lnt id=hl-347-122><a class=lnlinks href=#hl-347-122>122</a>
</span><span class=lnt id=hl-347-123><a class=lnlinks href=#hl-347-123>123</a>
</span><span class=lnt id=hl-347-124><a class=lnlinks href=#hl-347-124>124</a>
</span><span class=lnt id=hl-347-125><a class=lnlinks href=#hl-347-125>125</a>
</span><span class=lnt id=hl-347-126><a class=lnlinks href=#hl-347-126>126</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>BlockingQueue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//阻塞队列，存放任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Deque</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayDeque</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//队列的最大容量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//生产者条件变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>fullWaitSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//消费者条件变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>emptyWaitSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//构造方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>BlockingQueue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>capacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//超时阻塞获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>poll</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//将时间转换为纳秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>nanoTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unit</span><span class=p>.</span><span class=na>toNanos</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//等待超时依旧没有获取，返回null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>nanoTime</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//该方法返回的是剩余时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>nanoTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>emptyWaitSet</span><span class=p>.</span><span class=na>awaitNanos</span><span class=p>(</span><span class=n>nanoTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>T</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>pollFirst</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fullWaitSet</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//阻塞获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>take</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>emptyWaitSet</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>T</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>pollFirst</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fullWaitSet</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//阻塞添加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>t</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;等待加入任务队列:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>fullWaitSet</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;加入任务队列:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>emptyWaitSet</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//超时阻塞添加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>offer</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=n>TimeUnit</span><span class=w> </span><span class=n>timeUnit</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>nanoTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeUnit</span><span class=p>.</span><span class=na>toNanos</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>nanoTime</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;等待超时，加入失败：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;等待加入任务队列:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>nanoTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullWaitSet</span><span class=p>.</span><span class=na>awaitNanos</span><span class=p>(</span><span class=n>nanoTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;加入任务队列:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>emptyWaitSet</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>size</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//从形参接收拒绝策略的put方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>tryPut</span><span class=p>(</span><span class=n>RejectPolicy</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>rejectPolicy</span><span class=p>,</span><span class=n>T</span><span class=w> </span><span class=n>task</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>rejectPolicy</span><span class=p>.</span><span class=na>reject</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=k>else</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;加入任务队列：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>queue</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>emptyWaitSet</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>步骤3：自定义线程池</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-348-1><a class=lnlinks href=#hl-348-1> 1</a>
</span><span class=lnt id=hl-348-2><a class=lnlinks href=#hl-348-2> 2</a>
</span><span class=lnt id=hl-348-3><a class=lnlinks href=#hl-348-3> 3</a>
</span><span class=lnt id=hl-348-4><a class=lnlinks href=#hl-348-4> 4</a>
</span><span class=lnt id=hl-348-5><a class=lnlinks href=#hl-348-5> 5</a>
</span><span class=lnt id=hl-348-6><a class=lnlinks href=#hl-348-6> 6</a>
</span><span class=lnt id=hl-348-7><a class=lnlinks href=#hl-348-7> 7</a>
</span><span class=lnt id=hl-348-8><a class=lnlinks href=#hl-348-8> 8</a>
</span><span class=lnt id=hl-348-9><a class=lnlinks href=#hl-348-9> 9</a>
</span><span class=lnt id=hl-348-10><a class=lnlinks href=#hl-348-10>10</a>
</span><span class=lnt id=hl-348-11><a class=lnlinks href=#hl-348-11>11</a>
</span><span class=lnt id=hl-348-12><a class=lnlinks href=#hl-348-12>12</a>
</span><span class=lnt id=hl-348-13><a class=lnlinks href=#hl-348-13>13</a>
</span><span class=lnt id=hl-348-14><a class=lnlinks href=#hl-348-14>14</a>
</span><span class=lnt id=hl-348-15><a class=lnlinks href=#hl-348-15>15</a>
</span><span class=lnt id=hl-348-16><a class=lnlinks href=#hl-348-16>16</a>
</span><span class=lnt id=hl-348-17><a class=lnlinks href=#hl-348-17>17</a>
</span><span class=lnt id=hl-348-18><a class=lnlinks href=#hl-348-18>18</a>
</span><span class=lnt id=hl-348-19><a class=lnlinks href=#hl-348-19>19</a>
</span><span class=lnt id=hl-348-20><a class=lnlinks href=#hl-348-20>20</a>
</span><span class=lnt id=hl-348-21><a class=lnlinks href=#hl-348-21>21</a>
</span><span class=lnt id=hl-348-22><a class=lnlinks href=#hl-348-22>22</a>
</span><span class=lnt id=hl-348-23><a class=lnlinks href=#hl-348-23>23</a>
</span><span class=lnt id=hl-348-24><a class=lnlinks href=#hl-348-24>24</a>
</span><span class=lnt id=hl-348-25><a class=lnlinks href=#hl-348-25>25</a>
</span><span class=lnt id=hl-348-26><a class=lnlinks href=#hl-348-26>26</a>
</span><span class=lnt id=hl-348-27><a class=lnlinks href=#hl-348-27>27</a>
</span><span class=lnt id=hl-348-28><a class=lnlinks href=#hl-348-28>28</a>
</span><span class=lnt id=hl-348-29><a class=lnlinks href=#hl-348-29>29</a>
</span><span class=lnt id=hl-348-30><a class=lnlinks href=#hl-348-30>30</a>
</span><span class=lnt id=hl-348-31><a class=lnlinks href=#hl-348-31>31</a>
</span><span class=lnt id=hl-348-32><a class=lnlinks href=#hl-348-32>32</a>
</span><span class=lnt id=hl-348-33><a class=lnlinks href=#hl-348-33>33</a>
</span><span class=lnt id=hl-348-34><a class=lnlinks href=#hl-348-34>34</a>
</span><span class=lnt id=hl-348-35><a class=lnlinks href=#hl-348-35>35</a>
</span><span class=lnt id=hl-348-36><a class=lnlinks href=#hl-348-36>36</a>
</span><span class=lnt id=hl-348-37><a class=lnlinks href=#hl-348-37>37</a>
</span><span class=lnt id=hl-348-38><a class=lnlinks href=#hl-348-38>38</a>
</span><span class=lnt id=hl-348-39><a class=lnlinks href=#hl-348-39>39</a>
</span><span class=lnt id=hl-348-40><a class=lnlinks href=#hl-348-40>40</a>
</span><span class=lnt id=hl-348-41><a class=lnlinks href=#hl-348-41>41</a>
</span><span class=lnt id=hl-348-42><a class=lnlinks href=#hl-348-42>42</a>
</span><span class=lnt id=hl-348-43><a class=lnlinks href=#hl-348-43>43</a>
</span><span class=lnt id=hl-348-44><a class=lnlinks href=#hl-348-44>44</a>
</span><span class=lnt id=hl-348-45><a class=lnlinks href=#hl-348-45>45</a>
</span><span class=lnt id=hl-348-46><a class=lnlinks href=#hl-348-46>46</a>
</span><span class=lnt id=hl-348-47><a class=lnlinks href=#hl-348-47>47</a>
</span><span class=lnt id=hl-348-48><a class=lnlinks href=#hl-348-48>48</a>
</span><span class=lnt id=hl-348-49><a class=lnlinks href=#hl-348-49>49</a>
</span><span class=lnt id=hl-348-50><a class=lnlinks href=#hl-348-50>50</a>
</span><span class=lnt id=hl-348-51><a class=lnlinks href=#hl-348-51>51</a>
</span><span class=lnt id=hl-348-52><a class=lnlinks href=#hl-348-52>52</a>
</span><span class=lnt id=hl-348-53><a class=lnlinks href=#hl-348-53>53</a>
</span><span class=lnt id=hl-348-54><a class=lnlinks href=#hl-348-54>54</a>
</span><span class=lnt id=hl-348-55><a class=lnlinks href=#hl-348-55>55</a>
</span><span class=lnt id=hl-348-56><a class=lnlinks href=#hl-348-56>56</a>
</span><span class=lnt id=hl-348-57><a class=lnlinks href=#hl-348-57>57</a>
</span><span class=lnt id=hl-348-58><a class=lnlinks href=#hl-348-58>58</a>
</span><span class=lnt id=hl-348-59><a class=lnlinks href=#hl-348-59>59</a>
</span><span class=lnt id=hl-348-60><a class=lnlinks href=#hl-348-60>60</a>
</span><span class=lnt id=hl-348-61><a class=lnlinks href=#hl-348-61>61</a>
</span><span class=lnt id=hl-348-62><a class=lnlinks href=#hl-348-62>62</a>
</span><span class=lnt id=hl-348-63><a class=lnlinks href=#hl-348-63>63</a>
</span><span class=lnt id=hl-348-64><a class=lnlinks href=#hl-348-64>64</a>
</span><span class=lnt id=hl-348-65><a class=lnlinks href=#hl-348-65>65</a>
</span><span class=lnt id=hl-348-66><a class=lnlinks href=#hl-348-66>66</a>
</span><span class=lnt id=hl-348-67><a class=lnlinks href=#hl-348-67>67</a>
</span><span class=lnt id=hl-348-68><a class=lnlinks href=#hl-348-68>68</a>
</span><span class=lnt id=hl-348-69><a class=lnlinks href=#hl-348-69>69</a>
</span><span class=lnt id=hl-348-70><a class=lnlinks href=#hl-348-70>70</a>
</span><span class=lnt id=hl-348-71><a class=lnlinks href=#hl-348-71>71</a>
</span><span class=lnt id=hl-348-72><a class=lnlinks href=#hl-348-72>72</a>
</span><span class=lnt id=hl-348-73><a class=lnlinks href=#hl-348-73>73</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ThreadPool</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//阻塞队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>taskQue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//线程集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashSet</span><span class=o>&lt;</span><span class=n>Worker</span><span class=o>&gt;</span><span class=w> </span><span class=n>workers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//拒绝策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RejectPolicy</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>rejectPolicy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//构造方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ThreadPool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>coreSize</span><span class=p>,</span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=n>TimeUnit</span><span class=w> </span><span class=n>timeUnit</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>queueCapacity</span><span class=p>,</span><span class=n>RejectPolicy</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>rejectPolicy</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>coreSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coreSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeout</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>timeUnit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>rejectPolicy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rejectPolicy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>taskQue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>(</span><span class=n>queueCapacity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//线程数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>coreSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//任务超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//时间单元</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>timeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//线程池的执行方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>task</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//当线程数大于等于coreSize的时候，将任务放入阻塞队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//当线程数小于coreSize的时候，新建一个Worker放入workers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//注意workers类不是线程安全的， 需要加锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>workers</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>workers</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>coreSize</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                taskQue.put(task);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//死等</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//带超时等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//让调用者放弃执行任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//让调用者抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//让调用者自己执行任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>taskQue</span><span class=p>.</span><span class=na>tryPut</span><span class=p>(</span><span class=n>rejectPolicy</span><span class=p>,</span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Worker</span><span class=w> </span><span class=n>worker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Worker</span><span class=p>(</span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;新增worker:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>worker</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;,task:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>workers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>worker</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>worker</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//工作类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>class</span> <span class=nc>Worker</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Thread</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>Worker</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>task</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//巧妙的判断</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=n>task</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>taskQue</span><span class=p>.</span><span class=na>poll</span><span class=p>(</span><span class=n>timeout</span><span class=p>,</span><span class=n>timeUnit</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;正在执行:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>task</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>workers</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;worker被移除:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>workers</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>步骤4：编写测试类</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-349-1><a class=lnlinks href=#hl-349-1> 1</a>
</span><span class=lnt id=hl-349-2><a class=lnlinks href=#hl-349-2> 2</a>
</span><span class=lnt id=hl-349-3><a class=lnlinks href=#hl-349-3> 3</a>
</span><span class=lnt id=hl-349-4><a class=lnlinks href=#hl-349-4> 4</a>
</span><span class=lnt id=hl-349-5><a class=lnlinks href=#hl-349-5> 5</a>
</span><span class=lnt id=hl-349-6><a class=lnlinks href=#hl-349-6> 6</a>
</span><span class=lnt id=hl-349-7><a class=lnlinks href=#hl-349-7> 7</a>
</span><span class=lnt id=hl-349-8><a class=lnlinks href=#hl-349-8> 8</a>
</span><span class=lnt id=hl-349-9><a class=lnlinks href=#hl-349-9> 9</a>
</span><span class=lnt id=hl-349-10><a class=lnlinks href=#hl-349-10>10</a>
</span><span class=lnt id=hl-349-11><a class=lnlinks href=#hl-349-11>11</a>
</span><span class=lnt id=hl-349-12><a class=lnlinks href=#hl-349-12>12</a>
</span><span class=lnt id=hl-349-13><a class=lnlinks href=#hl-349-13>13</a>
</span><span class=lnt id=hl-349-14><a class=lnlinks href=#hl-349-14>14</a>
</span><span class=lnt id=hl-349-15><a class=lnlinks href=#hl-349-15>15</a>
</span><span class=lnt id=hl-349-16><a class=lnlinks href=#hl-349-16>16</a>
</span><span class=lnt id=hl-349-17><a class=lnlinks href=#hl-349-17>17</a>
</span><span class=lnt id=hl-349-18><a class=lnlinks href=#hl-349-18>18</a>
</span><span class=lnt id=hl-349-19><a class=lnlinks href=#hl-349-19>19</a>
</span><span class=lnt id=hl-349-20><a class=lnlinks href=#hl-349-20>20</a>
</span><span class=lnt id=hl-349-21><a class=lnlinks href=#hl-349-21>21</a>
</span><span class=lnt id=hl-349-22><a class=lnlinks href=#hl-349-22>22</a>
</span><span class=lnt id=hl-349-23><a class=lnlinks href=#hl-349-23>23</a>
</span><span class=lnt id=hl-349-24><a class=lnlinks href=#hl-349-24>24</a>
</span><span class=lnt id=hl-349-25><a class=lnlinks href=#hl-349-25>25</a>
</span><span class=lnt id=hl-349-26><a class=lnlinks href=#hl-349-26>26</a>
</span><span class=lnt id=hl-349-27><a class=lnlinks href=#hl-349-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ThreadPoolTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ThreadPool</span><span class=w> </span><span class=n>threadPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1000</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=n>task</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//死等</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                    queue.put(task);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//带超时等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            queue.offer(task, 1500, TimeUnit.MILLISECONDS);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//让调用者放弃任务执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            System.out.println(&#34;放弃：&#34; + task);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//让调用者抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            throw new RuntimeException(&#34;任务执行失败&#34; + task);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//让调用者自己执行任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>task</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=n>3</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>threadPool</span><span class=p>.</span><span class=na>execute</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;执行任务：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>j</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=threadpoolexecutor><a href=#threadpoolexecutor class=header-anchor>#</a>
ThreadPoolExecutor</h4><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220311171237519.png width=900 height=600 loading=lazy decoding=async alt=image-20220311171237519 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>说明：</p><ul><li>ScheduledThreadPoolExecutor是带调度的线程池</li><li>ThreadPoolExecutor是不带调度的线程池</li></ul><h5 id=线程池状态><a href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0%e7%8a%b6%e6%80%81 class=header-anchor>#</a>
线程池状态</h5><p>ThreadPoolExecutor 使用 int 的高 3 位来表示线程池状态，低 29 位表示线程数量</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>状态名</th><th style=text-align:center>高3位</th><th style=text-align:center>接收新任务</th><th style=text-align:center>处理阻塞队列任务</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center>RUNNING</td><td style=text-align:center>111</td><td style=text-align:center>Y</td><td style=text-align:center>Y</td><td style=text-align:center></td></tr><tr><td style=text-align:center>SHUTDOWN</td><td style=text-align:center>000</td><td style=text-align:center>N</td><td style=text-align:center>Y</td><td style=text-align:center>不会接收新任务，但会处理阻塞队列剩余 任务</td></tr><tr><td style=text-align:center>STOP</td><td style=text-align:center>001</td><td style=text-align:center>N</td><td style=text-align:center>N</td><td style=text-align:center>会中断正在执行的任务，并抛弃阻塞队列 任务</td></tr><tr><td style=text-align:center>TIDYING</td><td style=text-align:center>010</td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center>任务全执行完毕，活动线程为 0 即将进入 终结</td></tr><tr><td style=text-align:center>TERMINATED</td><td style=text-align:center>011</td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center>终结状态</td></tr></tbody></table></div><p>从数字上比较，TERMINATED > TIDYING > STOP > SHUTDOWN > RUNNING</p><p>这些信息存储在一个原子变量 ctl 中，目的是将线程池状态与线程个数合二为一，这样就可以用一次 cas 原子操作 进行赋值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-350-1><a class=lnlinks href=#hl-350-1>1</a>
</span><span class=lnt id=hl-350-2><a class=lnlinks href=#hl-350-2>2</a>
</span><span class=lnt id=hl-350-3><a class=lnlinks href=#hl-350-3>3</a>
</span><span class=lnt id=hl-350-4><a class=lnlinks href=#hl-350-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// c 为旧值， ctlOf 返回结果为新值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ctl</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>ctlOf</span><span class=p>(</span><span class=n>targetState</span><span class=p>,</span><span class=w> </span><span class=n>workerCountOf</span><span class=p>(</span><span class=n>c</span><span class=p>))));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// rs 为高 3 位代表线程池状态， wc 为低 29 位代表线程个数，ctl 是合并它们</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>ctlOf</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>rs</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>wc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>wc</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=构造方法><a href=#%e6%9e%84%e9%80%a0%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
构造方法</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-351-1><a class=lnlinks href=#hl-351-1>1</a>
</span><span class=lnt id=hl-351-2><a class=lnlinks href=#hl-351-2>2</a>
</span><span class=lnt id=hl-351-3><a class=lnlinks href=#hl-351-3>3</a>
</span><span class=lnt id=hl-351-4><a class=lnlinks href=#hl-351-4>4</a>
</span><span class=lnt id=hl-351-5><a class=lnlinks href=#hl-351-5>5</a>
</span><span class=lnt id=hl-351-6><a class=lnlinks href=#hl-351-6>6</a>
</span><span class=lnt id=hl-351-7><a class=lnlinks href=#hl-351-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ThreadPoolExecutor</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>corePoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=kt>int</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=kt>long</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>workQueue</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>ThreadFactory</span><span class=w> </span><span class=n>threadFactory</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>RejectedExecutionHandler</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>corePoolSize 核心线程数目 (最多保留的线程数)</li><li>maximumPoolSize 最大线程数目</li><li>keepAliveTime 生存时间 - 针对救急线程</li><li>unit 时间单位 - 针对救急线程</li><li>workQueue 阻塞队列</li><li>threadFactory 线程工厂 - 可以为线程创建时起个好名字</li><li>handler 拒绝策略</li></ul><h5 id=工作方式><a href=#%e5%b7%a5%e4%bd%9c%e6%96%b9%e5%bc%8f class=header-anchor>#</a>
工作方式</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-352-1><a class=lnlinks href=#hl-352-1> 1</a>
</span><span class=lnt id=hl-352-2><a class=lnlinks href=#hl-352-2> 2</a>
</span><span class=lnt id=hl-352-3><a class=lnlinks href=#hl-352-3> 3</a>
</span><span class=lnt id=hl-352-4><a class=lnlinks href=#hl-352-4> 4</a>
</span><span class=lnt id=hl-352-5><a class=lnlinks href=#hl-352-5> 5</a>
</span><span class=lnt id=hl-352-6><a class=lnlinks href=#hl-352-6> 6</a>
</span><span class=lnt id=hl-352-7><a class=lnlinks href=#hl-352-7> 7</a>
</span><span class=lnt id=hl-352-8><a class=lnlinks href=#hl-352-8> 8</a>
</span><span class=lnt id=hl-352-9><a class=lnlinks href=#hl-352-9> 9</a>
</span><span class=lnt id=hl-352-10><a class=lnlinks href=#hl-352-10>10</a>
</span><span class=lnt id=hl-352-11><a class=lnlinks href=#hl-352-11>11</a>
</span><span class=lnt id=hl-352-12><a class=lnlinks href=#hl-352-12>12</a>
</span><span class=lnt id=hl-352-13><a class=lnlinks href=#hl-352-13>13</a>
</span><span class=lnt id=hl-352-14><a class=lnlinks href=#hl-352-14>14</a>
</span><span class=lnt id=hl-352-15><a class=lnlinks href=#hl-352-15>15</a>
</span><span class=lnt id=hl-352-16><a class=lnlinks href=#hl-352-16>16</a>
</span><span class=lnt id=hl-352-17><a class=lnlinks href=#hl-352-17>17</a>
</span><span class=lnt id=hl-352-18><a class=lnlinks href=#hl-352-18>18</a>
</span><span class=lnt id=hl-352-19><a class=lnlinks href=#hl-352-19>19</a>
</span><span class=lnt id=hl-352-20><a class=lnlinks href=#hl-352-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph LR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>subgraph 阻塞队列
</span></span><span class=line><span class=cl>size=2
</span></span><span class=line><span class=cl>t3(任务3)
</span></span><span class=line><span class=cl>t4(任务4)
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>subgraph 线程池c-2,m=3
</span></span><span class=line><span class=cl>ct1(核心线程1)
</span></span><span class=line><span class=cl>ct2(核心线程2)
</span></span><span class=line><span class=cl>mt1(救急线程1)
</span></span><span class=line><span class=cl>ct1 --&gt; t1(任务1)
</span></span><span class=line><span class=cl>ct2 --&gt; t2(任务2)
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>t1(任务1)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>style ct1 fill:#ccf,stroke:#f66,stroke-width:2px
</span></span><span class=line><span class=cl>style ct2 fill:#ccf,stroke:#f66,stroke-width:2px
</span></span><span class=line><span class=cl>style mt1 fill:#ccf,stroke:#f66,stroke-width:2px,stroke-dasharray:5,5
</span></span></code></pre></td></tr></table></div></div><ul><li><p>线程池中刚开始没有线程，当一个任务提交给线程池后，线程池会创建一个新线程来执行任务。</p></li><li><p>当线程数达到 corePoolSize 并没有线程空闲，这时再加入任务，新加的任务会被加入workQueue 队列排 队，直到有空闲的线程。</p></li><li><p>如果队列选择了有界队列，那么任务超过了队列大小时，会创建 maximumPoolSize - corePoolSize 数目的线程来救急。</p></li><li><p>如果线程到达 maximumPoolSize 仍然有新任务这时会执行拒绝策略。拒绝策略 jdk 提供了 4 种实现，其它 著名框架也提供了实现</p><ul><li>AbortPolicy 让调用者抛出 RejectedExecutionException 异常，这是默认策略</li><li>CallerRunsPolicy 让调用者运行任务</li><li>DiscardPolicy 放弃本次任务</li><li>DiscardOldestPolicy 放弃队列中最早的任务，本任务取而代之</li><li>Dubbo 的实现，在抛出 RejectedExecutionException 异常之前会记录日志，并 dump 线程栈信息，方 便定位问题</li><li>Netty 的实现，是创建一个新线程来执行任务</li><li>ActiveMQ 的实现，带超时等待（60s）尝试放入队列，类似我们之前自定义的拒绝策略</li><li>PinPoint 的实现，它使用了一个拒绝策略链，会逐一尝试策略链中每种拒绝策略</li></ul></li><li><p>当高峰过去后，超过corePoolSize 的救急线程如果一段时间没有任务做，需要结束节省资源，这个时间由 keepAliveTime 和 unit 来控制。</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220311174119508.png width=900 height=600 loading=lazy decoding=async alt=image-20220311174119508 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li></ul><p>根据这个构造方法，JDK Executors 类中提供了众多工厂方法来创建各种用途的线程池。</p><h5 id=newfixedthreadpool><a href=#newfixedthreadpool class=header-anchor>#</a>
newFixedThreadPool</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-353-1><a class=lnlinks href=#hl-353-1>1</a>
</span><span class=lnt id=hl-353-2><a class=lnlinks href=#hl-353-2>2</a>
</span><span class=lnt id=hl-353-3><a class=lnlinks href=#hl-353-3>3</a>
</span><span class=lnt id=hl-353-4><a class=lnlinks href=#hl-353-4>4</a>
</span><span class=lnt id=hl-353-5><a class=lnlinks href=#hl-353-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ExecutorService</span><span class=w> </span><span class=nf>newFixedThreadPool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>nThreads</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>nThreads</span><span class=p>,</span><span class=w> </span><span class=n>nThreads</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=n>0L</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=k>new</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>内部调用了：ThreadPoolExecutor的一个构造方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-354-1><a class=lnlinks href=#hl-354-1>1</a>
</span><span class=lnt id=hl-354-2><a class=lnlinks href=#hl-354-2>2</a>
</span><span class=lnt id=hl-354-3><a class=lnlinks href=#hl-354-3>3</a>
</span><span class=lnt id=hl-354-4><a class=lnlinks href=#hl-354-4>4</a>
</span><span class=lnt id=hl-354-5><a class=lnlinks href=#hl-354-5>5</a>
</span><span class=lnt id=hl-354-6><a class=lnlinks href=#hl-354-6>6</a>
</span><span class=lnt id=hl-354-7><a class=lnlinks href=#hl-354-7>7</a>
</span><span class=lnt id=hl-354-8><a class=lnlinks href=#hl-354-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ThreadPoolExecutor</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>corePoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=kt>int</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=kt>long</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>workQueue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>(</span><span class=n>corePoolSize</span><span class=p>,</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>,</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>,</span><span class=w> </span><span class=n>workQueue</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>Executors</span><span class=p>.</span><span class=na>defaultThreadFactory</span><span class=p>(),</span><span class=w> </span><span class=n>defaultHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>默认工厂以及默认构造线程的方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-355-1><a class=lnlinks href=#hl-355-1> 1</a>
</span><span class=lnt id=hl-355-2><a class=lnlinks href=#hl-355-2> 2</a>
</span><span class=lnt id=hl-355-3><a class=lnlinks href=#hl-355-3> 3</a>
</span><span class=lnt id=hl-355-4><a class=lnlinks href=#hl-355-4> 4</a>
</span><span class=lnt id=hl-355-5><a class=lnlinks href=#hl-355-5> 5</a>
</span><span class=lnt id=hl-355-6><a class=lnlinks href=#hl-355-6> 6</a>
</span><span class=lnt id=hl-355-7><a class=lnlinks href=#hl-355-7> 7</a>
</span><span class=lnt id=hl-355-8><a class=lnlinks href=#hl-355-8> 8</a>
</span><span class=lnt id=hl-355-9><a class=lnlinks href=#hl-355-9> 9</a>
</span><span class=lnt id=hl-355-10><a class=lnlinks href=#hl-355-10>10</a>
</span><span class=lnt id=hl-355-11><a class=lnlinks href=#hl-355-11>11</a>
</span><span class=lnt id=hl-355-12><a class=lnlinks href=#hl-355-12>12</a>
</span><span class=lnt id=hl-355-13><a class=lnlinks href=#hl-355-13>13</a>
</span><span class=lnt id=hl-355-14><a class=lnlinks href=#hl-355-14>14</a>
</span><span class=lnt id=hl-355-15><a class=lnlinks href=#hl-355-15>15</a>
</span><span class=lnt id=hl-355-16><a class=lnlinks href=#hl-355-16>16</a>
</span><span class=lnt id=hl-355-17><a class=lnlinks href=#hl-355-17>17</a>
</span><span class=lnt id=hl-355-18><a class=lnlinks href=#hl-355-18>18</a>
</span><span class=lnt id=hl-355-19><a class=lnlinks href=#hl-355-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DefaultThreadFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SecurityManager</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>getSecurityManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>group</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>getThreadGroup</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getThreadGroup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>namePrefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;pool-&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>poolNumber</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;-thread-&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=nf>newThread</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>group</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>namePrefix</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>threadNumber</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=na>isDaemon</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=p>.</span><span class=na>setDaemon</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=na>getPriority</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>NORM_PRIORITY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=p>.</span><span class=na>setPriority</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>NORM_PRIORITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>默认拒绝策略：抛出异常</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-356-1><a class=lnlinks href=#hl-356-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>RejectedExecutionHandler</span><span class=w> </span><span class=n>defaultHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AbortPolicy</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>特点</p><ul><li>核心线程数 == 最大线程数（没有救急线程被创建），因此也无需超时时间</li><li>阻塞队列是无界的，可以放任意数量的任务</li></ul><blockquote><p><strong>评价</strong> 适用于任务量已知，相对耗时的任务</p></blockquote><h5 id=newcachedthreadpool><a href=#newcachedthreadpool class=header-anchor>#</a>
newCachedThreadPool</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-357-1><a class=lnlinks href=#hl-357-1>1</a>
</span><span class=lnt id=hl-357-2><a class=lnlinks href=#hl-357-2>2</a>
</span><span class=lnt id=hl-357-3><a class=lnlinks href=#hl-357-3>3</a>
</span><span class=lnt id=hl-357-4><a class=lnlinks href=#hl-357-4>4</a>
</span><span class=lnt id=hl-357-5><a class=lnlinks href=#hl-357-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ExecutorService</span><span class=w> </span><span class=nf>newCachedThreadPool</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=n>60L</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=k>new</span><span class=w> </span><span class=n>SynchronousQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>特点</p><ul><li>核心线程数是 0， 最大线程数是 Integer.MAX_VALUE，救急线程的空闲生存时间是 60s，<ul><li>意味着全部都是救急线程（60s 后可以回收）</li><li>救急线程可以无限创建</li></ul></li><li>队列采用了 SynchronousQueue 实现特点是，它没有容量，没有线程来取是放不进去的（一手交钱、一手交货）</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-358-1><a class=lnlinks href=#hl-358-1> 1</a>
</span><span class=lnt id=hl-358-2><a class=lnlinks href=#hl-358-2> 2</a>
</span><span class=lnt id=hl-358-3><a class=lnlinks href=#hl-358-3> 3</a>
</span><span class=lnt id=hl-358-4><a class=lnlinks href=#hl-358-4> 4</a>
</span><span class=lnt id=hl-358-5><a class=lnlinks href=#hl-358-5> 5</a>
</span><span class=lnt id=hl-358-6><a class=lnlinks href=#hl-358-6> 6</a>
</span><span class=lnt id=hl-358-7><a class=lnlinks href=#hl-358-7> 7</a>
</span><span class=lnt id=hl-358-8><a class=lnlinks href=#hl-358-8> 8</a>
</span><span class=lnt id=hl-358-9><a class=lnlinks href=#hl-358-9> 9</a>
</span><span class=lnt id=hl-358-10><a class=lnlinks href=#hl-358-10>10</a>
</span><span class=lnt id=hl-358-11><a class=lnlinks href=#hl-358-11>11</a>
</span><span class=lnt id=hl-358-12><a class=lnlinks href=#hl-358-12>12</a>
</span><span class=lnt id=hl-358-13><a class=lnlinks href=#hl-358-13>13</a>
</span><span class=lnt id=hl-358-14><a class=lnlinks href=#hl-358-14>14</a>
</span><span class=lnt id=hl-358-15><a class=lnlinks href=#hl-358-15>15</a>
</span><span class=lnt id=hl-358-16><a class=lnlinks href=#hl-358-16>16</a>
</span><span class=lnt id=hl-358-17><a class=lnlinks href=#hl-358-17>17</a>
</span><span class=lnt id=hl-358-18><a class=lnlinks href=#hl-358-18>18</a>
</span><span class=lnt id=hl-358-19><a class=lnlinks href=#hl-358-19>19</a>
</span><span class=lnt id=hl-358-20><a class=lnlinks href=#hl-358-20>20</a>
</span><span class=lnt id=hl-358-21><a class=lnlinks href=#hl-358-21>21</a>
</span><span class=lnt id=hl-358-22><a class=lnlinks href=#hl-358-22>22</a>
</span><span class=lnt id=hl-358-23><a class=lnlinks href=#hl-358-23>23</a>
</span><span class=lnt id=hl-358-24><a class=lnlinks href=#hl-358-24>24</a>
</span><span class=lnt id=hl-358-25><a class=lnlinks href=#hl-358-25>25</a>
</span><span class=lnt id=hl-358-26><a class=lnlinks href=#hl-358-26>26</a>
</span><span class=lnt id=hl-358-27><a class=lnlinks href=#hl-358-27>27</a>
</span><span class=lnt id=hl-358-28><a class=lnlinks href=#hl-358-28>28</a>
</span><span class=lnt id=hl-358-29><a class=lnlinks href=#hl-358-29>29</a>
</span><span class=lnt id=hl-358-30><a class=lnlinks href=#hl-358-30>30</a>
</span><span class=lnt id=hl-358-31><a class=lnlinks href=#hl-358-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SynchronousQueue</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>integers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SynchronousQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;putting {} &#34;</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>integers</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{} putted...&#34;</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;putting...{} &#34;</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>integers</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{} putted...&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;taking {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>integers</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;taking {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>integers</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t3&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-359-1><a class=lnlinks href=#hl-359-1>1</a>
</span><span class=lnt id=hl-359-2><a class=lnlinks href=#hl-359-2>2</a>
</span><span class=lnt id=hl-359-3><a class=lnlinks href=#hl-359-3>3</a>
</span><span class=lnt id=hl-359-4><a class=lnlinks href=#hl-359-4>4</a>
</span><span class=lnt id=hl-359-5><a class=lnlinks href=#hl-359-5>5</a>
</span><span class=lnt id=hl-359-6><a class=lnlinks href=#hl-359-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:48:15.500 c.TestSynchronousQueue <span class=o>[</span>t1<span class=o>]</span> - putting <span class=m>1</span> 
</span></span><span class=line><span class=cl>11:48:16.500 c.TestSynchronousQueue <span class=o>[</span>t2<span class=o>]</span> - taking <span class=m>1</span> 
</span></span><span class=line><span class=cl>11:48:16.500 c.TestSynchronousQueue <span class=o>[</span>t1<span class=o>]</span> - <span class=m>1</span> putted... 
</span></span><span class=line><span class=cl>11:48:16.500 c.TestSynchronousQueue <span class=o>[</span>t1<span class=o>]</span> - putting...2 
</span></span><span class=line><span class=cl>11:48:17.502 c.TestSynchronousQueue <span class=o>[</span>t3<span class=o>]</span> - taking <span class=m>2</span> 
</span></span><span class=line><span class=cl>11:48:17.503 c.TestSynchronousQueue <span class=o>[</span>t1<span class=o>]</span> - <span class=m>2</span> putted... 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>评价</strong> 整个线程池表现为线程数会根据任务量不断增长，没有上限，当任务执行完毕，空闲 1分钟后释放线 程。 适合任务数比较密集，但每个任务执行时间较短的情况</p></blockquote><h5 id=newsinglethreadexecutor><a href=#newsinglethreadexecutor class=header-anchor>#</a>
newSingleThreadExecutor</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-360-1><a class=lnlinks href=#hl-360-1>1</a>
</span><span class=lnt id=hl-360-2><a class=lnlinks href=#hl-360-2>2</a>
</span><span class=lnt id=hl-360-3><a class=lnlinks href=#hl-360-3>3</a>
</span><span class=lnt id=hl-360-4><a class=lnlinks href=#hl-360-4>4</a>
</span><span class=lnt id=hl-360-5><a class=lnlinks href=#hl-360-5>5</a>
</span><span class=lnt id=hl-360-6><a class=lnlinks href=#hl-360-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ExecutorService</span><span class=w> </span><span class=nf>newSingleThreadExecutor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FinalizableDelegatedExecutorService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>0L</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>new</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>使用场景：</p><p>希望多个任务排队执行。线程数固定为 1，任务数多于 1 时，会放入无界队列排队。任务执行完毕，这唯一的线程 也不会被释放。</p><p>区别：</p><ul><li>自己创建一个单线程串行执行任务，如果任务执行失败而终止那么没有任何补救措施，而线程池还会新建一 个线程，保证池的正常工作</li><li>Executors.newSingleThreadExecutor() 线程个数始终为1，不能修改<ul><li>FinalizableDelegatedExecutorService 应用的是装饰器模式，在调用构造方法时将ThreadPoolExecutor对象传给了内部的ExecutorService接口。只对外暴露了 ExecutorService 接口，因此不能调用 ThreadPoolExecutor 中特有的方法，也不能重新设置线程池的大小。</li></ul></li><li>Executors.newFixedThreadPool(1) 初始时为1，以后还可以修改<ul><li>对外暴露的是 ThreadPoolExecutor 对象，可以强转后调用 setCorePoolSize 等方法进行修改</li></ul></li></ul><h5 id=提交任务><a href=#%e6%8f%90%e4%ba%a4%e4%bb%bb%e5%8a%a1 class=header-anchor>#</a>
提交任务</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-361-1><a class=lnlinks href=#hl-361-1> 1</a>
</span><span class=lnt id=hl-361-2><a class=lnlinks href=#hl-361-2> 2</a>
</span><span class=lnt id=hl-361-3><a class=lnlinks href=#hl-361-3> 3</a>
</span><span class=lnt id=hl-361-4><a class=lnlinks href=#hl-361-4> 4</a>
</span><span class=lnt id=hl-361-5><a class=lnlinks href=#hl-361-5> 5</a>
</span><span class=lnt id=hl-361-6><a class=lnlinks href=#hl-361-6> 6</a>
</span><span class=lnt id=hl-361-7><a class=lnlinks href=#hl-361-7> 7</a>
</span><span class=lnt id=hl-361-8><a class=lnlinks href=#hl-361-8> 8</a>
</span><span class=lnt id=hl-361-9><a class=lnlinks href=#hl-361-9> 9</a>
</span><span class=lnt id=hl-361-10><a class=lnlinks href=#hl-361-10>10</a>
</span><span class=lnt id=hl-361-11><a class=lnlinks href=#hl-361-11>11</a>
</span><span class=lnt id=hl-361-12><a class=lnlinks href=#hl-361-12>12</a>
</span><span class=lnt id=hl-361-13><a class=lnlinks href=#hl-361-13>13</a>
</span><span class=lnt id=hl-361-14><a class=lnlinks href=#hl-361-14>14</a>
</span><span class=lnt id=hl-361-15><a class=lnlinks href=#hl-361-15>15</a>
</span><span class=lnt id=hl-361-16><a class=lnlinks href=#hl-361-16>16</a>
</span><span class=lnt id=hl-361-17><a class=lnlinks href=#hl-361-17>17</a>
</span><span class=lnt id=hl-361-18><a class=lnlinks href=#hl-361-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 执行任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>command</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 提交任务 task，用返回值 Future 获得任务执行结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>submit</span><span class=p>(</span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 提交 tasks 中所有任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>invokeAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 提交 tasks 中所有任务，带超时时间，时间超时后，会放弃执行后面的任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>invokeAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                              </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 提交 tasks 中所有任务，哪个任务先成功执行完毕，返回此任务执行结果，其它任务取消</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>invokeAny</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 提交 tasks 中所有任务，哪个任务先成功执行完毕，返回此任务执行结果，其它任务取消，带超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>invokeAny</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>,</span><span class=w> </span><span class=n>TimeoutException</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试submit</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-362-1><a class=lnlinks href=#hl-362-1> 1</a>
</span><span class=lnt id=hl-362-2><a class=lnlinks href=#hl-362-2> 2</a>
</span><span class=lnt id=hl-362-3><a class=lnlinks href=#hl-362-3> 3</a>
</span><span class=lnt id=hl-362-4><a class=lnlinks href=#hl-362-4> 4</a>
</span><span class=lnt id=hl-362-5><a class=lnlinks href=#hl-362-5> 5</a>
</span><span class=lnt id=hl-362-6><a class=lnlinks href=#hl-362-6> 6</a>
</span><span class=lnt id=hl-362-7><a class=lnlinks href=#hl-362-7> 7</a>
</span><span class=lnt id=hl-362-8><a class=lnlinks href=#hl-362-8> 8</a>
</span><span class=lnt id=hl-362-9><a class=lnlinks href=#hl-362-9> 9</a>
</span><span class=lnt id=hl-362-10><a class=lnlinks href=#hl-362-10>10</a>
</span><span class=lnt id=hl-362-11><a class=lnlinks href=#hl-362-11>11</a>
</span><span class=lnt id=hl-362-12><a class=lnlinks href=#hl-362-12>12</a>
</span><span class=lnt id=hl-362-13><a class=lnlinks href=#hl-362-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>(</span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;ok&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>future</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>method1</span><span class=p>(</span><span class=n>pool</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-363-1><a class=lnlinks href=#hl-363-1>1</a>
</span><span class=lnt id=hl-363-2><a class=lnlinks href=#hl-363-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:36:58.033 c.TestSubmit <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>18:36:59.034 c.TestSubmit <span class=o>[</span>main<span class=o>]</span> - ok
</span></span></code></pre></td></tr></table></div></div><p>测试invokeAll</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-364-1><a class=lnlinks href=#hl-364-1> 1</a>
</span><span class=lnt id=hl-364-2><a class=lnlinks href=#hl-364-2> 2</a>
</span><span class=lnt id=hl-364-3><a class=lnlinks href=#hl-364-3> 3</a>
</span><span class=lnt id=hl-364-4><a class=lnlinks href=#hl-364-4> 4</a>
</span><span class=lnt id=hl-364-5><a class=lnlinks href=#hl-364-5> 5</a>
</span><span class=lnt id=hl-364-6><a class=lnlinks href=#hl-364-6> 6</a>
</span><span class=lnt id=hl-364-7><a class=lnlinks href=#hl-364-7> 7</a>
</span><span class=lnt id=hl-364-8><a class=lnlinks href=#hl-364-8> 8</a>
</span><span class=lnt id=hl-364-9><a class=lnlinks href=#hl-364-9> 9</a>
</span><span class=lnt id=hl-364-10><a class=lnlinks href=#hl-364-10>10</a>
</span><span class=lnt id=hl-364-11><a class=lnlinks href=#hl-364-11>11</a>
</span><span class=lnt id=hl-364-12><a class=lnlinks href=#hl-364-12>12</a>
</span><span class=lnt id=hl-364-13><a class=lnlinks href=#hl-364-13>13</a>
</span><span class=lnt id=hl-364-14><a class=lnlinks href=#hl-364-14>14</a>
</span><span class=lnt id=hl-364-15><a class=lnlinks href=#hl-364-15>15</a>
</span><span class=lnt id=hl-364-16><a class=lnlinks href=#hl-364-16>16</a>
</span><span class=lnt id=hl-364-17><a class=lnlinks href=#hl-364-17>17</a>
</span><span class=lnt id=hl-364-18><a class=lnlinks href=#hl-364-18>18</a>
</span><span class=lnt id=hl-364-19><a class=lnlinks href=#hl-364-19>19</a>
</span><span class=lnt id=hl-364-20><a class=lnlinks href=#hl-364-20>20</a>
</span><span class=lnt id=hl-364-21><a class=lnlinks href=#hl-364-21>21</a>
</span><span class=lnt id=hl-364-22><a class=lnlinks href=#hl-364-22>22</a>
</span><span class=lnt id=hl-364-23><a class=lnlinks href=#hl-364-23>23</a>
</span><span class=lnt id=hl-364-24><a class=lnlinks href=#hl-364-24>24</a>
</span><span class=lnt id=hl-364-25><a class=lnlinks href=#hl-364-25>25</a>
</span><span class=lnt id=hl-364-26><a class=lnlinks href=#hl-364-26>26</a>
</span><span class=lnt id=hl-364-27><a class=lnlinks href=#hl-364-27>27</a>
</span><span class=lnt id=hl-364-28><a class=lnlinks href=#hl-364-28>28</a>
</span><span class=lnt id=hl-364-29><a class=lnlinks href=#hl-364-29>29</a>
</span><span class=lnt id=hl-364-30><a class=lnlinks href=#hl-364-30>30</a>
</span><span class=lnt id=hl-364-31><a class=lnlinks href=#hl-364-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>(</span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>futures</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>invokeAll</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;1&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;2&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;3&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>futures</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>-&gt;</span><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>method2</span><span class=p>(</span><span class=n>pool</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-365-1><a class=lnlinks href=#hl-365-1>1</a>
</span><span class=lnt id=hl-365-2><a class=lnlinks href=#hl-365-2>2</a>
</span><span class=lnt id=hl-365-3><a class=lnlinks href=#hl-365-3>3</a>
</span><span class=lnt id=hl-365-4><a class=lnlinks href=#hl-365-4>4</a>
</span><span class=lnt id=hl-365-5><a class=lnlinks href=#hl-365-5>5</a>
</span><span class=lnt id=hl-365-6><a class=lnlinks href=#hl-365-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>16</span><span class=p>.</span><span class=na>530</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>pool</span><span class=o>-</span><span class=n>1</span><span class=o>-</span><span class=n>thread</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>17</span><span class=p>.</span><span class=na>530</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>pool</span><span class=o>-</span><span class=n>1</span><span class=o>-</span><span class=n>thread</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>18</span><span class=p>.</span><span class=na>040</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>pool</span><span class=o>-</span><span class=n>1</span><span class=o>-</span><span class=n>thread</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>20</span><span class=p>.</span><span class=na>051</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>20</span><span class=p>.</span><span class=na>051</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>20</span><span class=p>.</span><span class=na>051</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试invokeAny</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-366-1><a class=lnlinks href=#hl-366-1> 1</a>
</span><span class=lnt id=hl-366-2><a class=lnlinks href=#hl-366-2> 2</a>
</span><span class=lnt id=hl-366-3><a class=lnlinks href=#hl-366-3> 3</a>
</span><span class=lnt id=hl-366-4><a class=lnlinks href=#hl-366-4> 4</a>
</span><span class=lnt id=hl-366-5><a class=lnlinks href=#hl-366-5> 5</a>
</span><span class=lnt id=hl-366-6><a class=lnlinks href=#hl-366-6> 6</a>
</span><span class=lnt id=hl-366-7><a class=lnlinks href=#hl-366-7> 7</a>
</span><span class=lnt id=hl-366-8><a class=lnlinks href=#hl-366-8> 8</a>
</span><span class=lnt id=hl-366-9><a class=lnlinks href=#hl-366-9> 9</a>
</span><span class=lnt id=hl-366-10><a class=lnlinks href=#hl-366-10>10</a>
</span><span class=lnt id=hl-366-11><a class=lnlinks href=#hl-366-11>11</a>
</span><span class=lnt id=hl-366-12><a class=lnlinks href=#hl-366-12>12</a>
</span><span class=lnt id=hl-366-13><a class=lnlinks href=#hl-366-13>13</a>
</span><span class=lnt id=hl-366-14><a class=lnlinks href=#hl-366-14>14</a>
</span><span class=lnt id=hl-366-15><a class=lnlinks href=#hl-366-15>15</a>
</span><span class=lnt id=hl-366-16><a class=lnlinks href=#hl-366-16>16</a>
</span><span class=lnt id=hl-366-17><a class=lnlinks href=#hl-366-17>17</a>
</span><span class=lnt id=hl-366-18><a class=lnlinks href=#hl-366-18>18</a>
</span><span class=lnt id=hl-366-19><a class=lnlinks href=#hl-366-19>19</a>
</span><span class=lnt id=hl-366-20><a class=lnlinks href=#hl-366-20>20</a>
</span><span class=lnt id=hl-366-21><a class=lnlinks href=#hl-366-21>21</a>
</span><span class=lnt id=hl-366-22><a class=lnlinks href=#hl-366-22>22</a>
</span><span class=lnt id=hl-366-23><a class=lnlinks href=#hl-366-23>23</a>
</span><span class=lnt id=hl-366-24><a class=lnlinks href=#hl-366-24>24</a>
</span><span class=lnt id=hl-366-25><a class=lnlinks href=#hl-366-25>25</a>
</span><span class=lnt id=hl-366-26><a class=lnlinks href=#hl-366-26>26</a>
</span><span class=lnt id=hl-366-27><a class=lnlinks href=#hl-366-27>27</a>
</span><span class=lnt id=hl-366-28><a class=lnlinks href=#hl-366-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>(</span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>invokeAny</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin 1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end 1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;1&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin 2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end 2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;2&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin 3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end 3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;3&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//ExecutorService pool = Executors.newFixedThreadPool(1);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>method3</span><span class=p>(</span><span class=n>pool</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-367-1><a class=lnlinks href=#hl-367-1> 1</a>
</span><span class=lnt id=hl-367-2><a class=lnlinks href=#hl-367-2> 2</a>
</span><span class=lnt id=hl-367-3><a class=lnlinks href=#hl-367-3> 3</a>
</span><span class=lnt id=hl-367-4><a class=lnlinks href=#hl-367-4> 4</a>
</span><span class=lnt id=hl-367-5><a class=lnlinks href=#hl-367-5> 5</a>
</span><span class=lnt id=hl-367-6><a class=lnlinks href=#hl-367-6> 6</a>
</span><span class=lnt id=hl-367-7><a class=lnlinks href=#hl-367-7> 7</a>
</span><span class=lnt id=hl-367-8><a class=lnlinks href=#hl-367-8> 8</a>
</span><span class=lnt id=hl-367-9><a class=lnlinks href=#hl-367-9> 9</a>
</span><span class=lnt id=hl-367-10><a class=lnlinks href=#hl-367-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:44:46.314 c.TestSubmit <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - begin <span class=m>1</span>
</span></span><span class=line><span class=cl>19:44:46.314 c.TestSubmit <span class=o>[</span>pool-1-thread-3<span class=o>]</span> - begin <span class=m>3</span>
</span></span><span class=line><span class=cl>19:44:46.314 c.TestSubmit <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - begin <span class=m>2</span>
</span></span><span class=line><span class=cl>19:44:46.817 c.TestSubmit <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - end <span class=m>2</span>
</span></span><span class=line><span class=cl>19:44:46.817 c.TestSubmit <span class=o>[</span>main<span class=o>]</span> - <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>19:47:16.063 c.TestSubmit <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - begin <span class=m>1</span>
</span></span><span class=line><span class=cl>19:47:17.063 c.TestSubmit <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - end <span class=m>1</span>
</span></span><span class=line><span class=cl>19:47:17.063 c.TestSubmit <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - begin <span class=m>2</span>
</span></span><span class=line><span class=cl>19:47:17.063 c.TestSubmit <span class=o>[</span>main<span class=o>]</span> - <span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=关闭线程池><a href=#%e5%85%b3%e9%97%ad%e7%ba%bf%e7%a8%8b%e6%b1%a0 class=header-anchor>#</a>
关闭线程池</h5><p><strong>shutdown</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-368-1><a class=lnlinks href=#hl-368-1>1</a>
</span><span class=lnt id=hl-368-2><a class=lnlinks href=#hl-368-2>2</a>
</span><span class=lnt id=hl-368-3><a class=lnlinks href=#hl-368-3>3</a>
</span><span class=lnt id=hl-368-4><a class=lnlinks href=#hl-368-4>4</a>
</span><span class=lnt id=hl-368-5><a class=lnlinks href=#hl-368-5>5</a>
</span><span class=lnt id=hl-368-6><a class=lnlinks href=#hl-368-6>6</a>
</span><span class=lnt id=hl-368-7><a class=lnlinks href=#hl-368-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>线程池状态变为 SHUTDOWN
</span></span></span><span class=line><span class=cl><span class=cm>- 不会接收新任务
</span></span></span><span class=line><span class=cl><span class=cm>- 但已提交任务会执行完
</span></span></span><span class=line><span class=cl><span class=cm>- 此方法不会阻塞调用线程的执行
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>shutdown</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-369-1><a class=lnlinks href=#hl-369-1> 1</a>
</span><span class=lnt id=hl-369-2><a class=lnlinks href=#hl-369-2> 2</a>
</span><span class=lnt id=hl-369-3><a class=lnlinks href=#hl-369-3> 3</a>
</span><span class=lnt id=hl-369-4><a class=lnlinks href=#hl-369-4> 4</a>
</span><span class=lnt id=hl-369-5><a class=lnlinks href=#hl-369-5> 5</a>
</span><span class=lnt id=hl-369-6><a class=lnlinks href=#hl-369-6> 6</a>
</span><span class=lnt id=hl-369-7><a class=lnlinks href=#hl-369-7> 7</a>
</span><span class=lnt id=hl-369-8><a class=lnlinks href=#hl-369-8> 8</a>
</span><span class=lnt id=hl-369-9><a class=lnlinks href=#hl-369-9> 9</a>
</span><span class=lnt id=hl-369-10><a class=lnlinks href=#hl-369-10>10</a>
</span><span class=lnt id=hl-369-11><a class=lnlinks href=#hl-369-11>11</a>
</span><span class=lnt id=hl-369-12><a class=lnlinks href=#hl-369-12>12</a>
</span><span class=lnt id=hl-369-13><a class=lnlinks href=#hl-369-13>13</a>
</span><span class=lnt id=hl-369-14><a class=lnlinks href=#hl-369-14>14</a>
</span><span class=lnt id=hl-369-15><a class=lnlinks href=#hl-369-15>15</a>
</span><span class=lnt id=hl-369-16><a class=lnlinks href=#hl-369-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>shutdown</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>mainLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>mainLock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mainLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkShutdownAccess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 修改线程池状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>advanceRunState</span><span class=p>(</span><span class=n>SHUTDOWN</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 仅会打断空闲线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>interruptIdleWorkers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>onShutdown</span><span class=p>();</span><span class=w> </span><span class=c1>// 扩展点 ScheduledThreadPoolExecutor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mainLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试终结(没有运行的线程可以立刻终结，如果还有运行的线程也不会等)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tryTerminate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>shutdownNow</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-370-1><a class=lnlinks href=#hl-370-1>1</a>
</span><span class=lnt id=hl-370-2><a class=lnlinks href=#hl-370-2>2</a>
</span><span class=lnt id=hl-370-3><a class=lnlinks href=#hl-370-3>3</a>
</span><span class=lnt id=hl-370-4><a class=lnlinks href=#hl-370-4>4</a>
</span><span class=lnt id=hl-370-5><a class=lnlinks href=#hl-370-5>5</a>
</span><span class=lnt id=hl-370-6><a class=lnlinks href=#hl-370-6>6</a>
</span><span class=lnt id=hl-370-7><a class=lnlinks href=#hl-370-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>线程池状态变为 STOP
</span></span></span><span class=line><span class=cl><span class=cm>- 不会接收新任务
</span></span></span><span class=line><span class=cl><span class=cm>- 会将队列中的任务返回
</span></span></span><span class=line><span class=cl><span class=cm>- 并用 interrupt 的方式中断正在执行的任务
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>shutdownNow</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-371-1><a class=lnlinks href=#hl-371-1> 1</a>
</span><span class=lnt id=hl-371-2><a class=lnlinks href=#hl-371-2> 2</a>
</span><span class=lnt id=hl-371-3><a class=lnlinks href=#hl-371-3> 3</a>
</span><span class=lnt id=hl-371-4><a class=lnlinks href=#hl-371-4> 4</a>
</span><span class=lnt id=hl-371-5><a class=lnlinks href=#hl-371-5> 5</a>
</span><span class=lnt id=hl-371-6><a class=lnlinks href=#hl-371-6> 6</a>
</span><span class=lnt id=hl-371-7><a class=lnlinks href=#hl-371-7> 7</a>
</span><span class=lnt id=hl-371-8><a class=lnlinks href=#hl-371-8> 8</a>
</span><span class=lnt id=hl-371-9><a class=lnlinks href=#hl-371-9> 9</a>
</span><span class=lnt id=hl-371-10><a class=lnlinks href=#hl-371-10>10</a>
</span><span class=lnt id=hl-371-11><a class=lnlinks href=#hl-371-11>11</a>
</span><span class=lnt id=hl-371-12><a class=lnlinks href=#hl-371-12>12</a>
</span><span class=lnt id=hl-371-13><a class=lnlinks href=#hl-371-13>13</a>
</span><span class=lnt id=hl-371-14><a class=lnlinks href=#hl-371-14>14</a>
</span><span class=lnt id=hl-371-15><a class=lnlinks href=#hl-371-15>15</a>
</span><span class=lnt id=hl-371-16><a class=lnlinks href=#hl-371-16>16</a>
</span><span class=lnt id=hl-371-17><a class=lnlinks href=#hl-371-17>17</a>
</span><span class=lnt id=hl-371-18><a class=lnlinks href=#hl-371-18>18</a>
</span><span class=lnt id=hl-371-19><a class=lnlinks href=#hl-371-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>shutdownNow</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>mainLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>mainLock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mainLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkShutdownAccess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 修改线程池状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>advanceRunState</span><span class=p>(</span><span class=n>STOP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 打断所有线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>interruptWorkers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取队列中剩余任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tasks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>drainQueue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mainLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试终结</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tryTerminate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>tasks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>其他方法</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-372-1><a class=lnlinks href=#hl-372-1>1</a>
</span><span class=lnt id=hl-372-2><a class=lnlinks href=#hl-372-2>2</a>
</span><span class=lnt id=hl-372-3><a class=lnlinks href=#hl-372-3>3</a>
</span><span class=lnt id=hl-372-4><a class=lnlinks href=#hl-372-4>4</a>
</span><span class=lnt id=hl-372-5><a class=lnlinks href=#hl-372-5>5</a>
</span><span class=lnt id=hl-372-6><a class=lnlinks href=#hl-372-6>6</a>
</span><span class=lnt id=hl-372-7><a class=lnlinks href=#hl-372-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 不在 RUNNING 状态的线程池，此方法就返回 true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=nf>isShutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 线程池状态是否是 TERMINATED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=nf>isTerminated</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 调用 shutdown 后，由于调用线程并不会等待所有任务运行结束，因此如果它想在线程池 TERMINATED 后做些事情，可以利用此方法等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 一般task是Callable类型的时候不用此方法，因为futureTask.get方法自带等待功能。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=nf>awaitTermination</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>测试shutdown、shutdownNow、awaitTermination</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-373-1><a class=lnlinks href=#hl-373-1> 1</a>
</span><span class=lnt id=hl-373-2><a class=lnlinks href=#hl-373-2> 2</a>
</span><span class=lnt id=hl-373-3><a class=lnlinks href=#hl-373-3> 3</a>
</span><span class=lnt id=hl-373-4><a class=lnlinks href=#hl-373-4> 4</a>
</span><span class=lnt id=hl-373-5><a class=lnlinks href=#hl-373-5> 5</a>
</span><span class=lnt id=hl-373-6><a class=lnlinks href=#hl-373-6> 6</a>
</span><span class=lnt id=hl-373-7><a class=lnlinks href=#hl-373-7> 7</a>
</span><span class=lnt id=hl-373-8><a class=lnlinks href=#hl-373-8> 8</a>
</span><span class=lnt id=hl-373-9><a class=lnlinks href=#hl-373-9> 9</a>
</span><span class=lnt id=hl-373-10><a class=lnlinks href=#hl-373-10>10</a>
</span><span class=lnt id=hl-373-11><a class=lnlinks href=#hl-373-11>11</a>
</span><span class=lnt id=hl-373-12><a class=lnlinks href=#hl-373-12>12</a>
</span><span class=lnt id=hl-373-13><a class=lnlinks href=#hl-373-13>13</a>
</span><span class=lnt id=hl-373-14><a class=lnlinks href=#hl-373-14>14</a>
</span><span class=lnt id=hl-373-15><a class=lnlinks href=#hl-373-15>15</a>
</span><span class=lnt id=hl-373-16><a class=lnlinks href=#hl-373-16>16</a>
</span><span class=lnt id=hl-373-17><a class=lnlinks href=#hl-373-17>17</a>
</span><span class=lnt id=hl-373-18><a class=lnlinks href=#hl-373-18>18</a>
</span><span class=lnt id=hl-373-19><a class=lnlinks href=#hl-373-19>19</a>
</span><span class=lnt id=hl-373-20><a class=lnlinks href=#hl-373-20>20</a>
</span><span class=lnt id=hl-373-21><a class=lnlinks href=#hl-373-21>21</a>
</span><span class=lnt id=hl-373-22><a class=lnlinks href=#hl-373-22>22</a>
</span><span class=lnt id=hl-373-23><a class=lnlinks href=#hl-373-23>23</a>
</span><span class=lnt id=hl-373-24><a class=lnlinks href=#hl-373-24>24</a>
</span><span class=lnt id=hl-373-25><a class=lnlinks href=#hl-373-25>25</a>
</span><span class=lnt id=hl-373-26><a class=lnlinks href=#hl-373-26>26</a>
</span><span class=lnt id=hl-373-27><a class=lnlinks href=#hl-373-27>27</a>
</span><span class=lnt id=hl-373-28><a class=lnlinks href=#hl-373-28>28</a>
</span><span class=lnt id=hl-373-29><a class=lnlinks href=#hl-373-29>29</a>
</span><span class=lnt id=hl-373-30><a class=lnlinks href=#hl-373-30>30</a>
</span><span class=lnt id=hl-373-31><a class=lnlinks href=#hl-373-31>31</a>
</span><span class=lnt id=hl-373-32><a class=lnlinks href=#hl-373-32>32</a>
</span><span class=lnt id=hl-373-33><a class=lnlinks href=#hl-373-33>33</a>
</span><span class=lnt id=hl-373-34><a class=lnlinks href=#hl-373-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.TestShutDown&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestShutDown</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>result1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 1 running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 1 finish...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>result2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 2 running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 2 finish...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>result3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 3 running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 3 finish...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;shutdown&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pool</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//        pool.awaitTermination(3, TimeUnit.SECONDS);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//        List&lt;Runnable&gt; runnables = pool.shutdownNow();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//        log.debug(&#34;other.... {}&#34; , runnables);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-374-1><a class=lnlinks href=#hl-374-1> 1</a>
</span><span class=lnt id=hl-374-2><a class=lnlinks href=#hl-374-2> 2</a>
</span><span class=lnt id=hl-374-3><a class=lnlinks href=#hl-374-3> 3</a>
</span><span class=lnt id=hl-374-4><a class=lnlinks href=#hl-374-4> 4</a>
</span><span class=lnt id=hl-374-5><a class=lnlinks href=#hl-374-5> 5</a>
</span><span class=lnt id=hl-374-6><a class=lnlinks href=#hl-374-6> 6</a>
</span><span class=lnt id=hl-374-7><a class=lnlinks href=#hl-374-7> 7</a>
</span><span class=lnt id=hl-374-8><a class=lnlinks href=#hl-374-8> 8</a>
</span><span class=lnt id=hl-374-9><a class=lnlinks href=#hl-374-9> 9</a>
</span><span class=lnt id=hl-374-10><a class=lnlinks href=#hl-374-10>10</a>
</span><span class=lnt id=hl-374-11><a class=lnlinks href=#hl-374-11>11</a>
</span><span class=lnt id=hl-374-12><a class=lnlinks href=#hl-374-12>12</a>
</span><span class=lnt id=hl-374-13><a class=lnlinks href=#hl-374-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1>#shutdown依旧会执行剩下的任务</span>
</span></span><span class=line><span class=cl>20:09:13.285 c.TestShutDown <span class=o>[</span>main<span class=o>]</span> - shutdown
</span></span><span class=line><span class=cl>20:09:13.285 c.TestShutDown <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - task <span class=m>1</span> running...
</span></span><span class=line><span class=cl>20:09:13.285 c.TestShutDown <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - task <span class=m>2</span> running...
</span></span><span class=line><span class=cl>20:09:14.293 c.TestShutDown <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - task <span class=m>2</span> finish...
</span></span><span class=line><span class=cl>20:09:14.293 c.TestShutDown <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - task <span class=m>1</span> finish...
</span></span><span class=line><span class=cl>20:09:14.293 c.TestShutDown <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - task <span class=m>3</span> running...
</span></span><span class=line><span class=cl>20:09:15.303 c.TestShutDown <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - task <span class=m>3</span> finish...
</span></span><span class=line><span class=cl><span class=c1>#shutdownNow立刻停止所有任务</span>
</span></span><span class=line><span class=cl>20:11:11.750 c.TestShutDown <span class=o>[</span>main<span class=o>]</span> - shutdown
</span></span><span class=line><span class=cl>20:11:11.750 c.TestShutDown <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - task <span class=m>1</span> running...
</span></span><span class=line><span class=cl>20:11:11.750 c.TestShutDown <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - task <span class=m>2</span> running...
</span></span><span class=line><span class=cl>20:11:11.750 c.TestShutDown <span class=o>[</span>main<span class=o>]</span> - other.... <span class=o>[</span>java.util.concurrent.FutureTask@66d33a<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=font-colororange模式之-worker-threadfont><a href=#font-colororange%e6%a8%a1%e5%bc%8f%e4%b9%8b-worker-threadfont class=header-anchor>#</a>
<font color=orange>*模式之 Worker Thread</font></h5><p><strong>定义</strong></p><p>让有限的工作线程（Worker Thread）来轮流异步处理无限多的任务。也可以将其归类为分工模式，它的典型实现 就是线程池，也体现了经典设计模式中的享元模式。</p><p>例如，海底捞的服务员（线程），轮流处理每位客人的点餐（任务），如果为每位客人都配一名专属的服务员，那 么成本就太高了（对比另一种多线程设计模式：Thread-Per-Message）</p><p>注意，不同任务类型应该使用不同的线程池，这样能够避免饥饿，并能提升效率</p><p>例如，如果一个餐馆的工人既要招呼客人（任务类型A），又要到后厨做菜（任务类型B）显然效率不咋地，分成 服务员（线程池A）与厨师（线程池B）更为合理，当然你能想到更细致的分工</p><p><strong>饥饿</strong></p><p>固定大小线程池会有饥饿现象</p><ul><li><p>两个工人是同一个线程池中的两个线程</p></li><li><p>他们要做的事情是：为客人点餐和到后厨做菜，这是两个阶段的工作</p><ul><li>客人点餐：必须先点完餐，等菜做好，上菜，在此期间处理点餐的工人必须等待</li><li>后厨做菜：没啥说的，做就是了</li></ul></li><li><p>比如工人A 处理了点餐任务，接下来它要等着 工人B 把菜做好，然后上菜，他俩也配合的蛮好</p></li><li><p>但现在同时来了两个客人，这个时候工人A 和工人B 都去处理点餐了，这时没人做饭了，饥饿</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-375-1><a class=lnlinks href=#hl-375-1> 1</a>
</span><span class=lnt id=hl-375-2><a class=lnlinks href=#hl-375-2> 2</a>
</span><span class=lnt id=hl-375-3><a class=lnlinks href=#hl-375-3> 3</a>
</span><span class=lnt id=hl-375-4><a class=lnlinks href=#hl-375-4> 4</a>
</span><span class=lnt id=hl-375-5><a class=lnlinks href=#hl-375-5> 5</a>
</span><span class=lnt id=hl-375-6><a class=lnlinks href=#hl-375-6> 6</a>
</span><span class=lnt id=hl-375-7><a class=lnlinks href=#hl-375-7> 7</a>
</span><span class=lnt id=hl-375-8><a class=lnlinks href=#hl-375-8> 8</a>
</span><span class=lnt id=hl-375-9><a class=lnlinks href=#hl-375-9> 9</a>
</span><span class=lnt id=hl-375-10><a class=lnlinks href=#hl-375-10>10</a>
</span><span class=lnt id=hl-375-11><a class=lnlinks href=#hl-375-11>11</a>
</span><span class=lnt id=hl-375-12><a class=lnlinks href=#hl-375-12>12</a>
</span><span class=lnt id=hl-375-13><a class=lnlinks href=#hl-375-13>13</a>
</span><span class=lnt id=hl-375-14><a class=lnlinks href=#hl-375-14>14</a>
</span><span class=lnt id=hl-375-15><a class=lnlinks href=#hl-375-15>15</a>
</span><span class=lnt id=hl-375-16><a class=lnlinks href=#hl-375-16>16</a>
</span><span class=lnt id=hl-375-17><a class=lnlinks href=#hl-375-17>17</a>
</span><span class=lnt id=hl-375-18><a class=lnlinks href=#hl-375-18>18</a>
</span><span class=lnt id=hl-375-19><a class=lnlinks href=#hl-375-19>19</a>
</span><span class=lnt id=hl-375-20><a class=lnlinks href=#hl-375-20>20</a>
</span><span class=lnt id=hl-375-21><a class=lnlinks href=#hl-375-21>21</a>
</span><span class=lnt id=hl-375-22><a class=lnlinks href=#hl-375-22>22</a>
</span><span class=lnt id=hl-375-23><a class=lnlinks href=#hl-375-23>23</a>
</span><span class=lnt id=hl-375-24><a class=lnlinks href=#hl-375-24>24</a>
</span><span class=lnt id=hl-375-25><a class=lnlinks href=#hl-375-25>25</a>
</span><span class=lnt id=hl-375-26><a class=lnlinks href=#hl-375-26>26</a>
</span><span class=lnt id=hl-375-27><a class=lnlinks href=#hl-375-27>27</a>
</span><span class=lnt id=hl-375-28><a class=lnlinks href=#hl-375-28>28</a>
</span><span class=lnt id=hl-375-29><a class=lnlinks href=#hl-375-29>29</a>
</span><span class=lnt id=hl-375-30><a class=lnlinks href=#hl-375-30>30</a>
</span><span class=lnt id=hl-375-31><a class=lnlinks href=#hl-375-31>31</a>
</span><span class=lnt id=hl-375-32><a class=lnlinks href=#hl-375-32>32</a>
</span><span class=lnt id=hl-375-33><a class=lnlinks href=#hl-375-33>33</a>
</span><span class=lnt id=hl-375-34><a class=lnlinks href=#hl-375-34>34</a>
</span><span class=lnt id=hl-375-35><a class=lnlinks href=#hl-375-35>35</a>
</span><span class=lnt id=hl-375-36><a class=lnlinks href=#hl-375-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestDeadLock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>MENU</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=s>&#34;地三鲜&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;宫保鸡丁&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;辣子鸡丁&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;烤鸡翅&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Random</span><span class=w> </span><span class=n>RANDOM</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>cooking</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>MENU</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>RANDOM</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>MENU</span><span class=p>.</span><span class=na>size</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>executorService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>executorService</span><span class=p>.</span><span class=na>execute</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;处理点餐...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>executorService</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;做菜&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>cooking</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;上菜: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>        executorService.execute(() -&gt; {
</span></span></span><span class=line><span class=cl><span class=cm>            log.debug(&#34;处理点餐...&#34;);
</span></span></span><span class=line><span class=cl><span class=cm>            Future&lt;String&gt; f = executorService.submit(() -&gt; {
</span></span></span><span class=line><span class=cl><span class=cm>                log.debug(&#34;做菜&#34;);
</span></span></span><span class=line><span class=cl><span class=cm>                return cooking();
</span></span></span><span class=line><span class=cl><span class=cm>            });
</span></span></span><span class=line><span class=cl><span class=cm>            try {
</span></span></span><span class=line><span class=cl><span class=cm>                log.debug(&#34;上菜: {}&#34;, f.get());
</span></span></span><span class=line><span class=cl><span class=cm>            } catch (InterruptedException | ExecutionException e) {
</span></span></span><span class=line><span class=cl><span class=cm>                e.printStackTrace();
</span></span></span><span class=line><span class=cl><span class=cm>            }
</span></span></span><span class=line><span class=cl><span class=cm>        });
</span></span></span><span class=line><span class=cl><span class=cm>        */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-376-1><a class=lnlinks href=#hl-376-1>1</a>
</span><span class=lnt id=hl-376-2><a class=lnlinks href=#hl-376-2>2</a>
</span><span class=lnt id=hl-376-3><a class=lnlinks href=#hl-376-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>17:21:27.883 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 处理点餐...
</span></span><span class=line><span class=cl>17:21:27.891 c.TestDeadLock <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - 做菜
</span></span><span class=line><span class=cl>17:21:27.891 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 上菜: 烤鸡翅
</span></span></code></pre></td></tr></table></div></div><p>当注释取消后，可能的输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-377-1><a class=lnlinks href=#hl-377-1>1</a>
</span><span class=lnt id=hl-377-2><a class=lnlinks href=#hl-377-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>17:08:41.339 c.TestDeadLock <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - 处理点餐...  
</span></span><span class=line><span class=cl>17:08:41.339 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 处理点餐... 
</span></span></code></pre></td></tr></table></div></div><p>解决方法可以增加线程池的大小，不过不是根本解决方案，还是前面提到的，不同的任务类型，采用不同的线程 池，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-378-1><a class=lnlinks href=#hl-378-1> 1</a>
</span><span class=lnt id=hl-378-2><a class=lnlinks href=#hl-378-2> 2</a>
</span><span class=lnt id=hl-378-3><a class=lnlinks href=#hl-378-3> 3</a>
</span><span class=lnt id=hl-378-4><a class=lnlinks href=#hl-378-4> 4</a>
</span><span class=lnt id=hl-378-5><a class=lnlinks href=#hl-378-5> 5</a>
</span><span class=lnt id=hl-378-6><a class=lnlinks href=#hl-378-6> 6</a>
</span><span class=lnt id=hl-378-7><a class=lnlinks href=#hl-378-7> 7</a>
</span><span class=lnt id=hl-378-8><a class=lnlinks href=#hl-378-8> 8</a>
</span><span class=lnt id=hl-378-9><a class=lnlinks href=#hl-378-9> 9</a>
</span><span class=lnt id=hl-378-10><a class=lnlinks href=#hl-378-10>10</a>
</span><span class=lnt id=hl-378-11><a class=lnlinks href=#hl-378-11>11</a>
</span><span class=lnt id=hl-378-12><a class=lnlinks href=#hl-378-12>12</a>
</span><span class=lnt id=hl-378-13><a class=lnlinks href=#hl-378-13>13</a>
</span><span class=lnt id=hl-378-14><a class=lnlinks href=#hl-378-14>14</a>
</span><span class=lnt id=hl-378-15><a class=lnlinks href=#hl-378-15>15</a>
</span><span class=lnt id=hl-378-16><a class=lnlinks href=#hl-378-16>16</a>
</span><span class=lnt id=hl-378-17><a class=lnlinks href=#hl-378-17>17</a>
</span><span class=lnt id=hl-378-18><a class=lnlinks href=#hl-378-18>18</a>
</span><span class=lnt id=hl-378-19><a class=lnlinks href=#hl-378-19>19</a>
</span><span class=lnt id=hl-378-20><a class=lnlinks href=#hl-378-20>20</a>
</span><span class=lnt id=hl-378-21><a class=lnlinks href=#hl-378-21>21</a>
</span><span class=lnt id=hl-378-22><a class=lnlinks href=#hl-378-22>22</a>
</span><span class=lnt id=hl-378-23><a class=lnlinks href=#hl-378-23>23</a>
</span><span class=lnt id=hl-378-24><a class=lnlinks href=#hl-378-24>24</a>
</span><span class=lnt id=hl-378-25><a class=lnlinks href=#hl-378-25>25</a>
</span><span class=lnt id=hl-378-26><a class=lnlinks href=#hl-378-26>26</a>
</span><span class=lnt id=hl-378-27><a class=lnlinks href=#hl-378-27>27</a>
</span><span class=lnt id=hl-378-28><a class=lnlinks href=#hl-378-28>28</a>
</span><span class=lnt id=hl-378-29><a class=lnlinks href=#hl-378-29>29</a>
</span><span class=lnt id=hl-378-30><a class=lnlinks href=#hl-378-30>30</a>
</span><span class=lnt id=hl-378-31><a class=lnlinks href=#hl-378-31>31</a>
</span><span class=lnt id=hl-378-32><a class=lnlinks href=#hl-378-32>32</a>
</span><span class=lnt id=hl-378-33><a class=lnlinks href=#hl-378-33>33</a>
</span><span class=lnt id=hl-378-34><a class=lnlinks href=#hl-378-34>34</a>
</span><span class=lnt id=hl-378-35><a class=lnlinks href=#hl-378-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestDeadLock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>MENU</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=s>&#34;地三鲜&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;宫保鸡丁&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;辣子鸡丁&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;烤鸡翅&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Random</span><span class=w> </span><span class=n>RANDOM</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>cooking</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>MENU</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>RANDOM</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>MENU</span><span class=p>.</span><span class=na>size</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>waiterPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>cookPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>waiterPool</span><span class=p>.</span><span class=na>execute</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;处理点餐...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cookPool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;做菜&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>cooking</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;上菜: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>waiterPool</span><span class=p>.</span><span class=na>execute</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;处理点餐...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cookPool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;做菜&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>cooking</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;上菜: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-379-1><a class=lnlinks href=#hl-379-1>1</a>
</span><span class=lnt id=hl-379-2><a class=lnlinks href=#hl-379-2>2</a>
</span><span class=lnt id=hl-379-3><a class=lnlinks href=#hl-379-3>3</a>
</span><span class=lnt id=hl-379-4><a class=lnlinks href=#hl-379-4>4</a>
</span><span class=lnt id=hl-379-5><a class=lnlinks href=#hl-379-5>5</a>
</span><span class=lnt id=hl-379-6><a class=lnlinks href=#hl-379-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>17:25:14.626 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 处理点餐... 
</span></span><span class=line><span class=cl>17:25:14.630 c.TestDeadLock <span class=o>[</span>pool-2-thread-1<span class=o>]</span> - 做菜
</span></span><span class=line><span class=cl>17:25:14.631 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 上菜: 地三鲜
</span></span><span class=line><span class=cl>17:25:14.632 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 处理点餐... 
</span></span><span class=line><span class=cl>17:25:14.632 c.TestDeadLock <span class=o>[</span>pool-2-thread-1<span class=o>]</span> - 做菜
</span></span><span class=line><span class=cl>17:25:14.632 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - 上菜: 辣子鸡丁
</span></span></code></pre></td></tr></table></div></div><p><strong>创建多少线程池合适</strong></p><ul><li>过小会导致程序不能充分地利用系统资源、容易导致饥饿</li><li>过大会导致更多的线程上下文切换，占用更多内存</li></ul><p><strong>CPU 密集型运算</strong></p><p>通常采用 <code>cpu 核数 + 1</code> 能够实现最优的 CPU 利用率，+1 是保证当线程由于页缺失故障（操作系统）或其它原因 导致暂停时，额外的这个线程就能顶上去，保证 CPU 时钟周期不被浪费</p><p><strong>I/O 密集型运算</strong></p><p>CPU 不总是处于繁忙状态，例如，当你执行业务计算时，这时候会使用 CPU 资源，但当你执行 I/O 操作时、远程 RPC 调用时，包括进行数据库操作时，这时候 CPU 就闲下来了，你可以利用多线程提高它的利用率。</p><p>经验公式如下</p><p><code>线程数 = 核数 * 期望 CPU 利用率 * 总时间(CPU计算时间+等待时间) / CPU 计算时间</code></p><p>例如 4 核 CPU 计算时间是 50% ，其它等待时间是 50%，期望 cpu 被 100% 利用，套用公式</p><p><code>4 * 100% * 100% / 50% = 8</code></p><p>例如 4 核 CPU 计算时间是 10% ，其它等待时间是 90%，期望 cpu 被 100% 利用，套用公式</p><p><code>4 * 100% * 100% / 10% = 40</code></p><h5 id=任务调度线程池><a href=#%e4%bb%bb%e5%8a%a1%e8%b0%83%e5%ba%a6%e7%ba%bf%e7%a8%8b%e6%b1%a0 class=header-anchor>#</a>
任务调度线程池</h5><p>在『任务调度线程池』功能加入之前(JDK1.3)，可以使用 java.util.Timer 来实现定时功能，Timer 的优点在于简单易用，但 由于所有任务都是由同一个线程来调度，因此所有任务都是串行执行的，同一时间只能有一个任务在执行，前一个 任务的延迟或异常都将会影响到之后的任务。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-380-1><a class=lnlinks href=#hl-380-1> 1</a>
</span><span class=lnt id=hl-380-2><a class=lnlinks href=#hl-380-2> 2</a>
</span><span class=lnt id=hl-380-3><a class=lnlinks href=#hl-380-3> 3</a>
</span><span class=lnt id=hl-380-4><a class=lnlinks href=#hl-380-4> 4</a>
</span><span class=lnt id=hl-380-5><a class=lnlinks href=#hl-380-5> 5</a>
</span><span class=lnt id=hl-380-6><a class=lnlinks href=#hl-380-6> 6</a>
</span><span class=lnt id=hl-380-7><a class=lnlinks href=#hl-380-7> 7</a>
</span><span class=lnt id=hl-380-8><a class=lnlinks href=#hl-380-8> 8</a>
</span><span class=lnt id=hl-380-9><a class=lnlinks href=#hl-380-9> 9</a>
</span><span class=lnt id=hl-380-10><a class=lnlinks href=#hl-380-10>10</a>
</span><span class=lnt id=hl-380-11><a class=lnlinks href=#hl-380-11>11</a>
</span><span class=lnt id=hl-380-12><a class=lnlinks href=#hl-380-12>12</a>
</span><span class=lnt id=hl-380-13><a class=lnlinks href=#hl-380-13>13</a>
</span><span class=lnt id=hl-380-14><a class=lnlinks href=#hl-380-14>14</a>
</span><span class=lnt id=hl-380-15><a class=lnlinks href=#hl-380-15>15</a>
</span><span class=lnt id=hl-380-16><a class=lnlinks href=#hl-380-16>16</a>
</span><span class=lnt id=hl-380-17><a class=lnlinks href=#hl-380-17>17</a>
</span><span class=lnt id=hl-380-18><a class=lnlinks href=#hl-380-18>18</a>
</span><span class=lnt id=hl-380-19><a class=lnlinks href=#hl-380-19>19</a>
</span><span class=lnt id=hl-380-20><a class=lnlinks href=#hl-380-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Timer</span><span class=w> </span><span class=n>timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Timer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TimerTask</span><span class=w> </span><span class=n>task1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TimerTask</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TimerTask</span><span class=w> </span><span class=n>task2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TimerTask</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 使用 timer 添加两个任务，希望它们都在 1s 后执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 但由于 timer 内只有一个线程来顺序执行队列中的任务，因此『任务1』的延时，影响了『任务2』的执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timer</span><span class=p>.</span><span class=na>schedule</span><span class=p>(</span><span class=n>task1</span><span class=p>,</span><span class=w> </span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timer</span><span class=p>.</span><span class=na>schedule</span><span class=p>(</span><span class=n>task2</span><span class=p>,</span><span class=w> </span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-381-1><a class=lnlinks href=#hl-381-1>1</a>
</span><span class=lnt id=hl-381-2><a class=lnlinks href=#hl-381-2>2</a>
</span><span class=lnt id=hl-381-3><a class=lnlinks href=#hl-381-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:46:09.444 c.TestTimer <span class=o>[</span>main<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>20:46:10.447 c.TestTimer <span class=o>[</span>Timer-0<span class=o>]</span> - task <span class=m>1</span> 
</span></span><span class=line><span class=cl>20:46:12.448 c.TestTimer <span class=o>[</span>Timer-0<span class=o>]</span> - task <span class=m>2</span> 
</span></span></code></pre></td></tr></table></div></div><p>使用 ScheduledExecutorService 改写：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-382-1><a class=lnlinks href=#hl-382-1>1</a>
</span><span class=lnt id=hl-382-2><a class=lnlinks href=#hl-382-2>2</a>
</span><span class=lnt id=hl-382-3><a class=lnlinks href=#hl-382-3>3</a>
</span><span class=lnt id=hl-382-4><a class=lnlinks href=#hl-382-4>4</a>
</span><span class=lnt id=hl-382-5><a class=lnlinks href=#hl-382-5>5</a>
</span><span class=lnt id=hl-382-6><a class=lnlinks href=#hl-382-6>6</a>
</span><span class=lnt id=hl-382-7><a class=lnlinks href=#hl-382-7>7</a>
</span><span class=lnt id=hl-382-8><a class=lnlinks href=#hl-382-8>8</a>
</span><span class=lnt id=hl-382-9><a class=lnlinks href=#hl-382-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>executor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 添加两个任务，希望它们都在 1s 后执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>executor</span><span class=p>.</span><span class=na>schedule</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;任务1，执行时间：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>1000</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>executor</span><span class=p>.</span><span class=na>schedule</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;任务2，执行时间：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>1000</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-383-1><a class=lnlinks href=#hl-383-1>1</a>
</span><span class=lnt id=hl-383-2><a class=lnlinks href=#hl-383-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>任务1，执行时间：Thu Jan <span class=m>03</span> 12:45:17 CST <span class=m>2019</span> 
</span></span><span class=line><span class=cl>任务2，执行时间：Thu Jan <span class=m>03</span> 12:45:17 CST <span class=m>2019</span> 
</span></span></code></pre></td></tr></table></div></div><p>scheduleAtFixedRate 例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-384-1><a class=lnlinks href=#hl-384-1>1</a>
</span><span class=lnt id=hl-384-2><a class=lnlinks href=#hl-384-2>2</a>
</span><span class=lnt id=hl-384-3><a class=lnlinks href=#hl-384-3>3</a>
</span><span class=lnt id=hl-384-4><a class=lnlinks href=#hl-384-4>4</a>
</span><span class=lnt id=hl-384-5><a class=lnlinks href=#hl-384-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pool</span><span class=p>.</span><span class=na>scheduleAtFixedRate</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-385-1><a class=lnlinks href=#hl-385-1>1</a>
</span><span class=lnt id=hl-385-2><a class=lnlinks href=#hl-385-2>2</a>
</span><span class=lnt id=hl-385-3><a class=lnlinks href=#hl-385-3>3</a>
</span><span class=lnt id=hl-385-4><a class=lnlinks href=#hl-385-4>4</a>
</span><span class=lnt id=hl-385-5><a class=lnlinks href=#hl-385-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:45:43.167 c.TestTimer <span class=o>[</span>main<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>21:45:44.215 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:45:45.215 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:45:46.215 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:45:47.215 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span></code></pre></td></tr></table></div></div><p>scheduleAtFixedRate 例子（任务执行时间超过了间隔时间）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-386-1><a class=lnlinks href=#hl-386-1>1</a>
</span><span class=lnt id=hl-386-2><a class=lnlinks href=#hl-386-2>2</a>
</span><span class=lnt id=hl-386-3><a class=lnlinks href=#hl-386-3>3</a>
</span><span class=lnt id=hl-386-4><a class=lnlinks href=#hl-386-4>4</a>
</span><span class=lnt id=hl-386-5><a class=lnlinks href=#hl-386-5>5</a>
</span><span class=lnt id=hl-386-6><a class=lnlinks href=#hl-386-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pool</span><span class=p>.</span><span class=na>scheduleAtFixedRate</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出分析：一开始，延时 1s，接下来，由于任务执行时间 > 间隔时间，间隔被『撑』到了 2s</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-387-1><a class=lnlinks href=#hl-387-1>1</a>
</span><span class=lnt id=hl-387-2><a class=lnlinks href=#hl-387-2>2</a>
</span><span class=lnt id=hl-387-3><a class=lnlinks href=#hl-387-3>3</a>
</span><span class=lnt id=hl-387-4><a class=lnlinks href=#hl-387-4>4</a>
</span><span class=lnt id=hl-387-5><a class=lnlinks href=#hl-387-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:44:30.311 c.TestTimer <span class=o>[</span>main<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>21:44:31.360 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:44:33.361 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:44:35.362 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:44:37.362 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running...
</span></span></code></pre></td></tr></table></div></div><p>scheduleWithFixedDelay 例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-388-1><a class=lnlinks href=#hl-388-1>1</a>
</span><span class=lnt id=hl-388-2><a class=lnlinks href=#hl-388-2>2</a>
</span><span class=lnt id=hl-388-3><a class=lnlinks href=#hl-388-3>3</a>
</span><span class=lnt id=hl-388-4><a class=lnlinks href=#hl-388-4>4</a>
</span><span class=lnt id=hl-388-5><a class=lnlinks href=#hl-388-5>5</a>
</span><span class=lnt id=hl-388-6><a class=lnlinks href=#hl-388-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pool</span><span class=p>.</span><span class=na>scheduleWithFixedDelay</span><span class=p>(()</span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出分析：一开始，延时 1s，scheduleWithFixedDelay 的间隔是 上一个任务结束 &lt;-> 延时 &lt;-> 下一个任务开始 所 以间隔都是 3s</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-389-1><a class=lnlinks href=#hl-389-1>1</a>
</span><span class=lnt id=hl-389-2><a class=lnlinks href=#hl-389-2>2</a>
</span><span class=lnt id=hl-389-3><a class=lnlinks href=#hl-389-3>3</a>
</span><span class=lnt id=hl-389-4><a class=lnlinks href=#hl-389-4>4</a>
</span><span class=lnt id=hl-389-5><a class=lnlinks href=#hl-389-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:40:55.078 c.TestTimer <span class=o>[</span>main<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>21:40:56.140 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:40:59.143 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:41:02.145 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:41:05.147 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>评价</strong> 整个线程池表现为：线程数固定，任务数多于线程数时，会放入无界队列排队。任务执行完毕，这些线 程也不会被释放。用来执行延迟或反复执行的任务</p></blockquote><h5 id=正确处理执行任务异常><a href=#%e6%ad%a3%e7%a1%ae%e5%a4%84%e7%90%86%e6%89%a7%e8%a1%8c%e4%bb%bb%e5%8a%a1%e5%bc%82%e5%b8%b8 class=header-anchor>#</a>
正确处理执行任务异常</h5><p>不论是哪个线程池，在线程执行的任务发生异常后既不会抛出，也不会捕获，这时就需要我们做一定的处理。</p><p><strong>方法1：主动捉异常</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-390-1><a class=lnlinks href=#hl-390-1>1</a>
</span><span class=lnt id=hl-390-2><a class=lnlinks href=#hl-390-2>2</a>
</span><span class=lnt id=hl-390-3><a class=lnlinks href=#hl-390-3>3</a>
</span><span class=lnt id=hl-390-4><a class=lnlinks href=#hl-390-4>4</a>
</span><span class=lnt id=hl-390-5><a class=lnlinks href=#hl-390-5>5</a>
</span><span class=lnt id=hl-390-6><a class=lnlinks href=#hl-390-6>6</a>
</span><span class=lnt id=hl-390-7><a class=lnlinks href=#hl-390-7>7</a>
</span><span class=lnt id=hl-390-8><a class=lnlinks href=#hl-390-8>8</a>
</span><span class=lnt id=hl-390-9><a class=lnlinks href=#hl-390-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;error:&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-391-1><a class=lnlinks href=#hl-391-1>1</a>
</span><span class=lnt id=hl-391-2><a class=lnlinks href=#hl-391-2>2</a>
</span><span class=lnt id=hl-391-3><a class=lnlinks href=#hl-391-3>3</a>
</span><span class=lnt id=hl-391-4><a class=lnlinks href=#hl-391-4>4</a>
</span><span class=lnt id=hl-391-5><a class=lnlinks href=#hl-391-5>5</a>
</span><span class=lnt id=hl-391-6><a class=lnlinks href=#hl-391-6>6</a>
</span><span class=lnt id=hl-391-7><a class=lnlinks href=#hl-391-7>7</a>
</span><span class=lnt id=hl-391-8><a class=lnlinks href=#hl-391-8>8</a>
</span><span class=lnt id=hl-391-9><a class=lnlinks href=#hl-391-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:59:04.558 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - task1 
</span></span><span class=line><span class=cl>21:59:04.562 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - error: 
</span></span><span class=line><span class=cl>java.lang.ArithmeticException: / by zero 
</span></span><span class=line><span class=cl> at cn.itcast.n8.TestTimer.lambda<span class=nv>$main$0</span><span class=o>(</span>TestTimer.java:28<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.Executors<span class=nv>$RunnableAdapter</span>.call<span class=o>(</span>Executors.java:511<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.FutureTask.run<span class=o>(</span>FutureTask.java:266<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.ThreadPoolExecutor.runWorker<span class=o>(</span>ThreadPoolExecutor.java:1149<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.ThreadPoolExecutor<span class=nv>$Worker</span>.run<span class=o>(</span>ThreadPoolExecutor.java:624<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Thread.run<span class=o>(</span>Thread.java:748<span class=o>)</span> 
</span></span></code></pre></td></tr></table></div></div><p><strong>方法2：使用 Future</strong></p><p>说明：</p><ul><li>lambda表达式内要有返回值，编译器才能将其识别为Callable，否则将识别为Runnable，也就不能用FutureTask</li><li>方法中如果出异常，<code>futuretask.get</code>会返回这个异常，否者正常返回。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-392-1><a class=lnlinks href=#hl-392-1>1</a>
</span><span class=lnt id=hl-392-2><a class=lnlinks href=#hl-392-2>2</a>
</span><span class=lnt id=hl-392-3><a class=lnlinks href=#hl-392-3>3</a>
</span><span class=lnt id=hl-392-4><a class=lnlinks href=#hl-392-4>4</a>
</span><span class=lnt id=hl-392-5><a class=lnlinks href=#hl-392-5>5</a>
</span><span class=lnt id=hl-392-6><a class=lnlinks href=#hl-392-6>6</a>
</span><span class=lnt id=hl-392-7><a class=lnlinks href=#hl-392-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Boolean</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;result:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-393-1><a class=lnlinks href=#hl-393-1> 1</a>
</span><span class=lnt id=hl-393-2><a class=lnlinks href=#hl-393-2> 2</a>
</span><span class=lnt id=hl-393-3><a class=lnlinks href=#hl-393-3> 3</a>
</span><span class=lnt id=hl-393-4><a class=lnlinks href=#hl-393-4> 4</a>
</span><span class=lnt id=hl-393-5><a class=lnlinks href=#hl-393-5> 5</a>
</span><span class=lnt id=hl-393-6><a class=lnlinks href=#hl-393-6> 6</a>
</span><span class=lnt id=hl-393-7><a class=lnlinks href=#hl-393-7> 7</a>
</span><span class=lnt id=hl-393-8><a class=lnlinks href=#hl-393-8> 8</a>
</span><span class=lnt id=hl-393-9><a class=lnlinks href=#hl-393-9> 9</a>
</span><span class=lnt id=hl-393-10><a class=lnlinks href=#hl-393-10>10</a>
</span><span class=lnt id=hl-393-11><a class=lnlinks href=#hl-393-11>11</a>
</span><span class=lnt id=hl-393-12><a class=lnlinks href=#hl-393-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:54:58.208 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - task1 
</span></span><span class=line><span class=cl>Exception in thread <span class=s2>&#34;main&#34;</span> java.util.concurrent.ExecutionException: 
</span></span><span class=line><span class=cl>java.lang.ArithmeticException: / by zero 
</span></span><span class=line><span class=cl> at java.util.concurrent.FutureTask.report<span class=o>(</span>FutureTask.java:122<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.FutureTask.get<span class=o>(</span>FutureTask.java:192<span class=o>)</span> 
</span></span><span class=line><span class=cl> at cn.itcast.n8.TestTimer.main<span class=o>(</span>TestTimer.java:31<span class=o>)</span> 
</span></span><span class=line><span class=cl>Caused by: java.lang.ArithmeticException: / by zero 
</span></span><span class=line><span class=cl> at cn.itcast.n8.TestTimer.lambda<span class=nv>$main$0</span><span class=o>(</span>TestTimer.java:28<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.FutureTask.run<span class=o>(</span>FutureTask.java:266<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.ThreadPoolExecutor.runWorker<span class=o>(</span>ThreadPoolExecutor.java:1149<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.ThreadPoolExecutor<span class=nv>$Worker</span>.run<span class=o>(</span>ThreadPoolExecutor.java:624<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Thread.run<span class=o>(</span>Thread.java:748<span class=o>)</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=font-colorgreen-应用之定时任务font><a href=#font-colorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1font class=header-anchor>#</a>
<font color=green>* 应用之定时任务</font></h5><p>如何让每周四 18:00:00 定时执行任务？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-394-1><a class=lnlinks href=#hl-394-1> 1</a>
</span><span class=lnt id=hl-394-2><a class=lnlinks href=#hl-394-2> 2</a>
</span><span class=lnt id=hl-394-3><a class=lnlinks href=#hl-394-3> 3</a>
</span><span class=lnt id=hl-394-4><a class=lnlinks href=#hl-394-4> 4</a>
</span><span class=lnt id=hl-394-5><a class=lnlinks href=#hl-394-5> 5</a>
</span><span class=lnt id=hl-394-6><a class=lnlinks href=#hl-394-6> 6</a>
</span><span class=lnt id=hl-394-7><a class=lnlinks href=#hl-394-7> 7</a>
</span><span class=lnt id=hl-394-8><a class=lnlinks href=#hl-394-8> 8</a>
</span><span class=lnt id=hl-394-9><a class=lnlinks href=#hl-394-9> 9</a>
</span><span class=lnt id=hl-394-10><a class=lnlinks href=#hl-394-10>10</a>
</span><span class=lnt id=hl-394-11><a class=lnlinks href=#hl-394-11>11</a>
</span><span class=lnt id=hl-394-12><a class=lnlinks href=#hl-394-12>12</a>
</span><span class=lnt id=hl-394-13><a class=lnlinks href=#hl-394-13>13</a>
</span><span class=lnt id=hl-394-14><a class=lnlinks href=#hl-394-14>14</a>
</span><span class=lnt id=hl-394-15><a class=lnlinks href=#hl-394-15>15</a>
</span><span class=lnt id=hl-394-16><a class=lnlinks href=#hl-394-16>16</a>
</span><span class=lnt id=hl-394-17><a class=lnlinks href=#hl-394-17>17</a>
</span><span class=lnt id=hl-394-18><a class=lnlinks href=#hl-394-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 获得当前时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获取本周四 18:00:00.000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>thursday</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>now</span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=n>DayOfWeek</span><span class=p>.</span><span class=na>THURSDAY</span><span class=p>).</span><span class=na>withHour</span><span class=p>(</span><span class=n>18</span><span class=p>).</span><span class=na>withMinute</span><span class=p>(</span><span class=n>0</span><span class=p>).</span><span class=na>withSecond</span><span class=p>(</span><span class=n>0</span><span class=p>).</span><span class=na>withNano</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 如果当前时间已经超过 本周四 18:00:00.000， 那么找下周四 18:00:00.000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=p>(</span><span class=n>now</span><span class=p>.</span><span class=na>compareTo</span><span class=p>(</span><span class=n>thursday</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thursday</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thursday</span><span class=p>.</span><span class=na>plusWeeks</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 计算时间差，即延时执行时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>long</span><span class=w> </span><span class=n>initialDelay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Duration</span><span class=p>.</span><span class=na>between</span><span class=p>(</span><span class=n>now</span><span class=p>,</span><span class=w> </span><span class=n>thursday</span><span class=p>).</span><span class=na>toMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 计算间隔时间，即 1 周的毫秒值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>long</span><span class=w> </span><span class=n>oneWeek</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>7</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>3600</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>executor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;开始时间：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>executor</span><span class=p>.</span><span class=na>scheduleAtFixedRate</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;执行时间：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>initialDelay</span><span class=p>,</span><span class=w> </span><span class=n>oneWeek</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=tomcat-线程池><a href=#tomcat-%e7%ba%bf%e7%a8%8b%e6%b1%a0 class=header-anchor>#</a>
Tomcat 线程池</h5><p>Tomcat 在哪里用到了线程池呢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-395-1><a class=lnlinks href=#hl-395-1> 1</a>
</span><span class=lnt id=hl-395-2><a class=lnlinks href=#hl-395-2> 2</a>
</span><span class=lnt id=hl-395-3><a class=lnlinks href=#hl-395-3> 3</a>
</span><span class=lnt id=hl-395-4><a class=lnlinks href=#hl-395-4> 4</a>
</span><span class=lnt id=hl-395-5><a class=lnlinks href=#hl-395-5> 5</a>
</span><span class=lnt id=hl-395-6><a class=lnlinks href=#hl-395-6> 6</a>
</span><span class=lnt id=hl-395-7><a class=lnlinks href=#hl-395-7> 7</a>
</span><span class=lnt id=hl-395-8><a class=lnlinks href=#hl-395-8> 8</a>
</span><span class=lnt id=hl-395-9><a class=lnlinks href=#hl-395-9> 9</a>
</span><span class=lnt id=hl-395-10><a class=lnlinks href=#hl-395-10>10</a>
</span><span class=lnt id=hl-395-11><a class=lnlinks href=#hl-395-11>11</a>
</span><span class=lnt id=hl-395-12><a class=lnlinks href=#hl-395-12>12</a>
</span><span class=lnt id=hl-395-13><a class=lnlinks href=#hl-395-13>13</a>
</span><span class=lnt id=hl-395-14><a class=lnlinks href=#hl-395-14>14</a>
</span><span class=lnt id=hl-395-15><a class=lnlinks href=#hl-395-15>15</a>
</span><span class=lnt id=hl-395-16><a class=lnlinks href=#hl-395-16>16</a>
</span><span class=lnt id=hl-395-17><a class=lnlinks href=#hl-395-17>17</a>
</span><span class=lnt id=hl-395-18><a class=lnlinks href=#hl-395-18>18</a>
</span><span class=lnt id=hl-395-19><a class=lnlinks href=#hl-395-19>19</a>
</span><span class=lnt id=hl-395-20><a class=lnlinks href=#hl-395-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph LR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>subgraph Connector-&gt;NIO EndPoint
</span></span><span class=line><span class=cl>t1(LimitLatch)
</span></span><span class=line><span class=cl>t2(Acceptor)
</span></span><span class=line><span class=cl>t3(SocketChannel 1)
</span></span><span class=line><span class=cl>t4(SocketChannel 2)
</span></span><span class=line><span class=cl>t5(Poller)
</span></span><span class=line><span class=cl>subgraph Executor
</span></span><span class=line><span class=cl>t7(worker1)
</span></span><span class=line><span class=cl>t8(worker2)
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>t1 --&gt; t2
</span></span><span class=line><span class=cl>t2 --&gt; t3
</span></span><span class=line><span class=cl>t2 --&gt; t4
</span></span><span class=line><span class=cl>t3 --有读--&gt; t5
</span></span><span class=line><span class=cl>t4 --有读--&gt; t5
</span></span><span class=line><span class=cl>t5 --socketProcessor--&gt; t7
</span></span><span class=line><span class=cl>t5 --socketProcessor--&gt; t8
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><ul><li>LimitLatch 用来限流，可以控制最大连接个数，类似 J.U.C 中的 Semaphore 后面再讲</li><li>Acceptor 只负责【接收新的 socket 连接】</li><li>Poller 只负责监听 socket channel 是否有【可读的 I/O 事件】</li><li>一旦可读，封装一个任务对象（socketProcessor），提交给 Executor 线程池处理</li><li>Executor 线程池中的工作线程最终负责【处理请求】</li></ul><p>Tomcat 线程池扩展了 ThreadPoolExecutor，行为稍有不同</p><ul><li>如果总线程数达到 maximumPoolSize<ul><li>这时不会立刻抛 RejectedExecutionException 异常</li><li>而是再次尝试将任务放入队列，如果还失败，才抛出 RejectedExecutionException 异常</li></ul></li></ul><p>源码 tomcat-7.0.42</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-396-1><a class=lnlinks href=#hl-396-1> 1</a>
</span><span class=lnt id=hl-396-2><a class=lnlinks href=#hl-396-2> 2</a>
</span><span class=lnt id=hl-396-3><a class=lnlinks href=#hl-396-3> 3</a>
</span><span class=lnt id=hl-396-4><a class=lnlinks href=#hl-396-4> 4</a>
</span><span class=lnt id=hl-396-5><a class=lnlinks href=#hl-396-5> 5</a>
</span><span class=lnt id=hl-396-6><a class=lnlinks href=#hl-396-6> 6</a>
</span><span class=lnt id=hl-396-7><a class=lnlinks href=#hl-396-7> 7</a>
</span><span class=lnt id=hl-396-8><a class=lnlinks href=#hl-396-8> 8</a>
</span><span class=lnt id=hl-396-9><a class=lnlinks href=#hl-396-9> 9</a>
</span><span class=lnt id=hl-396-10><a class=lnlinks href=#hl-396-10>10</a>
</span><span class=lnt id=hl-396-11><a class=lnlinks href=#hl-396-11>11</a>
</span><span class=lnt id=hl-396-12><a class=lnlinks href=#hl-396-12>12</a>
</span><span class=lnt id=hl-396-13><a class=lnlinks href=#hl-396-13>13</a>
</span><span class=lnt id=hl-396-14><a class=lnlinks href=#hl-396-14>14</a>
</span><span class=lnt id=hl-396-15><a class=lnlinks href=#hl-396-15>15</a>
</span><span class=lnt id=hl-396-16><a class=lnlinks href=#hl-396-16>16</a>
</span><span class=lnt id=hl-396-17><a class=lnlinks href=#hl-396-17>17</a>
</span><span class=lnt id=hl-396-18><a class=lnlinks href=#hl-396-18>18</a>
</span><span class=lnt id=hl-396-19><a class=lnlinks href=#hl-396-19>19</a>
</span><span class=lnt id=hl-396-20><a class=lnlinks href=#hl-396-20>20</a>
</span><span class=lnt id=hl-396-21><a class=lnlinks href=#hl-396-21>21</a>
</span><span class=lnt id=hl-396-22><a class=lnlinks href=#hl-396-22>22</a>
</span><span class=lnt id=hl-396-23><a class=lnlinks href=#hl-396-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>command</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>submittedCount</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>command</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RejectedExecutionException</span><span class=w> </span><span class=n>rx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kd>super</span><span class=p>.</span><span class=na>getQueue</span><span class=p>()</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>TaskQueue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>TaskQueue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>TaskQueue</span><span class=p>)</span><span class=kd>super</span><span class=p>.</span><span class=na>getQueue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>queue</span><span class=p>.</span><span class=na>force</span><span class=p>(</span><span class=n>command</span><span class=p>,</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>submittedCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RejectedExecutionException</span><span class=p>(</span><span class=s>&#34;Queue capacity is full.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>submittedCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RejectedExecutionException</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>submittedCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>rx</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>TaskQueue.java</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-397-1><a class=lnlinks href=#hl-397-1>1</a>
</span><span class=lnt id=hl-397-2><a class=lnlinks href=#hl-397-2>2</a>
</span><span class=lnt id=hl-397-3><a class=lnlinks href=#hl-397-3>3</a>
</span><span class=lnt id=hl-397-4><a class=lnlinks href=#hl-397-4>4</a>
</span><span class=lnt id=hl-397-5><a class=lnlinks href=#hl-397-5>5</a>
</span><span class=lnt id=hl-397-6><a class=lnlinks href=#hl-397-6>6</a>
</span><span class=lnt id=hl-397-7><a class=lnlinks href=#hl-397-7>7</a>
</span><span class=lnt id=hl-397-8><a class=lnlinks href=#hl-397-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>force</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>o</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>parent</span><span class=p>.</span><span class=na>isShutdown</span><span class=p>()</span><span class=w> </span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RejectedExecutionException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;Executor not running, can&#39;t force a command into the queue&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=n>o</span><span class=p>,</span><span class=n>timeout</span><span class=p>,</span><span class=n>unit</span><span class=p>);</span><span class=w> </span><span class=c1>//forces the item onto the queue, to be used if the task </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>is</span><span class=w> </span><span class=n>rejected</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Connector 配置</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>配置项</th><th style=text-align:center>默认值</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>acceptorThreadCount</code></td><td style=text-align:center>1</td><td style=text-align:center>acceptor 线程数量</td></tr><tr><td style=text-align:center><code>pollerThreadCount</code></td><td style=text-align:center>1</td><td style=text-align:center>poller 线程数量</td></tr><tr><td style=text-align:center><code>minSpareThreads</code></td><td style=text-align:center>10</td><td style=text-align:center>核心线程数，即 corePoolSize</td></tr><tr><td style=text-align:center><code>maxThreads</code></td><td style=text-align:center>200</td><td style=text-align:center>最大线程数，即 maximumPoolSize</td></tr><tr><td style=text-align:center><code>executor</code></td><td style=text-align:center>-</td><td style=text-align:center>Executor 名称，用来引用下面的 Executor</td></tr></tbody></table></div><p>Executor 线程配置</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>配置项</th><th style=text-align:center>默认值</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>threadPriority</code></td><td style=text-align:center>5</td><td style=text-align:center>线程优先级</td></tr><tr><td style=text-align:center><code>deamon</code></td><td style=text-align:center>true</td><td style=text-align:center>是否守护线程</td></tr><tr><td style=text-align:center><code>minSpareThreads</code></td><td style=text-align:center>25</td><td style=text-align:center>核心线程数，即corePoolSize</td></tr><tr><td style=text-align:center><code>maxThreads</code></td><td style=text-align:center>200</td><td style=text-align:center>最大线程数，即 maximumPoolSize</td></tr><tr><td style=text-align:center><code>maxIdleTime</code></td><td style=text-align:center>60000</td><td style=text-align:center>线程生存时间，单位是毫秒，默认值即 1 分钟</td></tr><tr><td style=text-align:center><code>maxQueueSize</code></td><td style=text-align:center>Integer.MAX_VALUE</td><td style=text-align:center>队列长度</td></tr><tr><td style=text-align:center><code>prestartminSpareThreads</code></td><td style=text-align:center>false</td><td style=text-align:center>核心线程是否在服务器启动时启动</td></tr></tbody></table></div><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312104017979.png width=900 height=600 loading=lazy decoding=async alt=image-20220312104017979 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=forkjoin><a href=#forkjoin class=header-anchor>#</a>
Fork/Join</h4><h5 id=概念><a href=#%e6%a6%82%e5%bf%b5 class=header-anchor>#</a>
概念</h5><p>Fork/Join 是 JDK 1.7 加入的新的线程池实现，它体现的是一种分治思想，适用于能够进行任务拆分的 cpu 密集型 运算</p><p>所谓的任务拆分，是将一个大任务拆分为算法上相同的小任务，直至不能拆分可以直接求解。跟递归相关的一些计 算，如归并排序、斐波那契数列、都可以用分治思想进行求解</p><p>Fork/Join 在分治的基础上加入了多线程，可以把每个任务的分解和合并交给不同的线程来完成，进一步提升了运 算效率</p><p>Fork/Join 默认会创建与 cpu 核心数大小相同的线程池</p><h5 id=font-colorgreen应用之求和font><a href=#font-colorgreen%e5%ba%94%e7%94%a8%e4%b9%8b%e6%b1%82%e5%92%8cfont class=header-anchor>#</a>
<font color=green>应用之求和</font></h5><p>提交给 Fork/Join 线程池的任务需要继承 RecursiveTask（有返回值）或 RecursiveAction（没有返回值），例如下 面定义了一个对 1~n 之间的整数求和的任务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-398-1><a class=lnlinks href=#hl-398-1> 1</a>
</span><span class=lnt id=hl-398-2><a class=lnlinks href=#hl-398-2> 2</a>
</span><span class=lnt id=hl-398-3><a class=lnlinks href=#hl-398-3> 3</a>
</span><span class=lnt id=hl-398-4><a class=lnlinks href=#hl-398-4> 4</a>
</span><span class=lnt id=hl-398-5><a class=lnlinks href=#hl-398-5> 5</a>
</span><span class=lnt id=hl-398-6><a class=lnlinks href=#hl-398-6> 6</a>
</span><span class=lnt id=hl-398-7><a class=lnlinks href=#hl-398-7> 7</a>
</span><span class=lnt id=hl-398-8><a class=lnlinks href=#hl-398-8> 8</a>
</span><span class=lnt id=hl-398-9><a class=lnlinks href=#hl-398-9> 9</a>
</span><span class=lnt id=hl-398-10><a class=lnlinks href=#hl-398-10>10</a>
</span><span class=lnt id=hl-398-11><a class=lnlinks href=#hl-398-11>11</a>
</span><span class=lnt id=hl-398-12><a class=lnlinks href=#hl-398-12>12</a>
</span><span class=lnt id=hl-398-13><a class=lnlinks href=#hl-398-13>13</a>
</span><span class=lnt id=hl-398-14><a class=lnlinks href=#hl-398-14>14</a>
</span><span class=lnt id=hl-398-15><a class=lnlinks href=#hl-398-15>15</a>
</span><span class=lnt id=hl-398-16><a class=lnlinks href=#hl-398-16>16</a>
</span><span class=lnt id=hl-398-17><a class=lnlinks href=#hl-398-17>17</a>
</span><span class=lnt id=hl-398-18><a class=lnlinks href=#hl-398-18>18</a>
</span><span class=lnt id=hl-398-19><a class=lnlinks href=#hl-398-19>19</a>
</span><span class=lnt id=hl-398-20><a class=lnlinks href=#hl-398-20>20</a>
</span><span class=lnt id=hl-398-21><a class=lnlinks href=#hl-398-21>21</a>
</span><span class=lnt id=hl-398-22><a class=lnlinks href=#hl-398-22>22</a>
</span><span class=lnt id=hl-398-23><a class=lnlinks href=#hl-398-23>23</a>
</span><span class=lnt id=hl-398-24><a class=lnlinks href=#hl-398-24>24</a>
</span><span class=lnt id=hl-398-25><a class=lnlinks href=#hl-398-25>25</a>
</span><span class=lnt id=hl-398-26><a class=lnlinks href=#hl-398-26>26</a>
</span><span class=lnt id=hl-398-27><a class=lnlinks href=#hl-398-27>27</a>
</span><span class=lnt id=hl-398-28><a class=lnlinks href=#hl-398-28>28</a>
</span><span class=lnt id=hl-398-29><a class=lnlinks href=#hl-398-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.AddTask&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>AddTask1</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>RecursiveTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AddTask1</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;{&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=sc>&#39;}&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>compute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果 n 已经为 1，可以求得结果了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;join() {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 将任务进行拆分(fork)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AddTask1</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AddTask1</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>fork</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;fork() {} + {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 合并(join)结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;join() {} + {} = {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>然后提交给 ForkJoinPool 来执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-399-1><a class=lnlinks href=#hl-399-1>1</a>
</span><span class=lnt id=hl-399-2><a class=lnlinks href=#hl-399-2>2</a>
</span><span class=lnt id=hl-399-3><a class=lnlinks href=#hl-399-3>3</a>
</span><span class=lnt id=hl-399-4><a class=lnlinks href=#hl-399-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ForkJoinPool</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ForkJoinPool</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>pool</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AddTask1</span><span class=p>(</span><span class=n>5</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-400-1><a class=lnlinks href=#hl-400-1> 1</a>
</span><span class=lnt id=hl-400-2><a class=lnlinks href=#hl-400-2> 2</a>
</span><span class=lnt id=hl-400-3><a class=lnlinks href=#hl-400-3> 3</a>
</span><span class=lnt id=hl-400-4><a class=lnlinks href=#hl-400-4> 4</a>
</span><span class=lnt id=hl-400-5><a class=lnlinks href=#hl-400-5> 5</a>
</span><span class=lnt id=hl-400-6><a class=lnlinks href=#hl-400-6> 6</a>
</span><span class=lnt id=hl-400-7><a class=lnlinks href=#hl-400-7> 7</a>
</span><span class=lnt id=hl-400-8><a class=lnlinks href=#hl-400-8> 8</a>
</span><span class=lnt id=hl-400-9><a class=lnlinks href=#hl-400-9> 9</a>
</span><span class=lnt id=hl-400-10><a class=lnlinks href=#hl-400-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-0<span class=o>]</span> - fork<span class=o>()</span> <span class=m>2</span> + <span class=o>{</span>1<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-1<span class=o>]</span> - fork<span class=o>()</span> <span class=m>5</span> + <span class=o>{</span>4<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-0<span class=o>]</span> - join<span class=o>()</span> <span class=m>1</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-0<span class=o>]</span> - join<span class=o>()</span> <span class=m>2</span> + <span class=o>{</span>1<span class=o>}</span> <span class=o>=</span> <span class=m>3</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-2<span class=o>]</span> - fork<span class=o>()</span> <span class=m>4</span> + <span class=o>{</span>3<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-3<span class=o>]</span> - fork<span class=o>()</span> <span class=m>3</span> + <span class=o>{</span>2<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-3<span class=o>]</span> - join<span class=o>()</span> <span class=m>3</span> + <span class=o>{</span>2<span class=o>}</span> <span class=o>=</span> <span class=m>6</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-2<span class=o>]</span> - join<span class=o>()</span> <span class=m>4</span> + <span class=o>{</span>3<span class=o>}</span> <span class=o>=</span> <span class=m>10</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-1<span class=o>]</span> - join<span class=o>()</span> <span class=m>5</span> + <span class=o>{</span>4<span class=o>}</span> <span class=o>=</span> <span class=m>15</span> 
</span></span><span class=line><span class=cl><span class=m>15</span> 
</span></span></code></pre></td></tr></table></div></div><p>用图来表示</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312104252674.png width=900 height=600 loading=lazy decoding=async alt=image-20220312104252674 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>改进</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-401-1><a class=lnlinks href=#hl-401-1> 1</a>
</span><span class=lnt id=hl-401-2><a class=lnlinks href=#hl-401-2> 2</a>
</span><span class=lnt id=hl-401-3><a class=lnlinks href=#hl-401-3> 3</a>
</span><span class=lnt id=hl-401-4><a class=lnlinks href=#hl-401-4> 4</a>
</span><span class=lnt id=hl-401-5><a class=lnlinks href=#hl-401-5> 5</a>
</span><span class=lnt id=hl-401-6><a class=lnlinks href=#hl-401-6> 6</a>
</span><span class=lnt id=hl-401-7><a class=lnlinks href=#hl-401-7> 7</a>
</span><span class=lnt id=hl-401-8><a class=lnlinks href=#hl-401-8> 8</a>
</span><span class=lnt id=hl-401-9><a class=lnlinks href=#hl-401-9> 9</a>
</span><span class=lnt id=hl-401-10><a class=lnlinks href=#hl-401-10>10</a>
</span><span class=lnt id=hl-401-11><a class=lnlinks href=#hl-401-11>11</a>
</span><span class=lnt id=hl-401-12><a class=lnlinks href=#hl-401-12>12</a>
</span><span class=lnt id=hl-401-13><a class=lnlinks href=#hl-401-13>13</a>
</span><span class=lnt id=hl-401-14><a class=lnlinks href=#hl-401-14>14</a>
</span><span class=lnt id=hl-401-15><a class=lnlinks href=#hl-401-15>15</a>
</span><span class=lnt id=hl-401-16><a class=lnlinks href=#hl-401-16>16</a>
</span><span class=lnt id=hl-401-17><a class=lnlinks href=#hl-401-17>17</a>
</span><span class=lnt id=hl-401-18><a class=lnlinks href=#hl-401-18>18</a>
</span><span class=lnt id=hl-401-19><a class=lnlinks href=#hl-401-19>19</a>
</span><span class=lnt id=hl-401-20><a class=lnlinks href=#hl-401-20>20</a>
</span><span class=lnt id=hl-401-21><a class=lnlinks href=#hl-401-21>21</a>
</span><span class=lnt id=hl-401-22><a class=lnlinks href=#hl-401-22>22</a>
</span><span class=lnt id=hl-401-23><a class=lnlinks href=#hl-401-23>23</a>
</span><span class=lnt id=hl-401-24><a class=lnlinks href=#hl-401-24>24</a>
</span><span class=lnt id=hl-401-25><a class=lnlinks href=#hl-401-25>25</a>
</span><span class=lnt id=hl-401-26><a class=lnlinks href=#hl-401-26>26</a>
</span><span class=lnt id=hl-401-27><a class=lnlinks href=#hl-401-27>27</a>
</span><span class=lnt id=hl-401-28><a class=lnlinks href=#hl-401-28>28</a>
</span><span class=lnt id=hl-401-29><a class=lnlinks href=#hl-401-29>29</a>
</span><span class=lnt id=hl-401-30><a class=lnlinks href=#hl-401-30>30</a>
</span><span class=lnt id=hl-401-31><a class=lnlinks href=#hl-401-31>31</a>
</span><span class=lnt id=hl-401-32><a class=lnlinks href=#hl-401-32>32</a>
</span><span class=lnt id=hl-401-33><a class=lnlinks href=#hl-401-33>33</a>
</span><span class=lnt id=hl-401-34><a class=lnlinks href=#hl-401-34>34</a>
</span><span class=lnt id=hl-401-35><a class=lnlinks href=#hl-401-35>35</a>
</span><span class=lnt id=hl-401-36><a class=lnlinks href=#hl-401-36>36</a>
</span><span class=lnt id=hl-401-37><a class=lnlinks href=#hl-401-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddTask3</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>RecursiveTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AddTask3</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>begin</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>end</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>begin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;{&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>begin</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;,&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=sc>&#39;}&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>compute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 5, 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>begin</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>end</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;join() {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>begin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 4, 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;join() {} + {} = {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>begin</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>begin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>mid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>begin</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w> </span><span class=c1>// 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AddTask3</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AddTask3</span><span class=p>(</span><span class=n>begin</span><span class=p>,</span><span class=w> </span><span class=n>mid</span><span class=p>);</span><span class=w> </span><span class=c1>// 1,3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>fork</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AddTask3</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AddTask3</span><span class=p>(</span><span class=n>mid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=p>);</span><span class=w> </span><span class=c1>// 4,5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>fork</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;fork() {} + {} = ?&#34;</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>,</span><span class=w> </span><span class=n>t2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;join() {} + {} = {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>,</span><span class=w> </span><span class=n>t2</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>然后提交给 ForkJoinPool 来执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-402-1><a class=lnlinks href=#hl-402-1>1</a>
</span><span class=lnt id=hl-402-2><a class=lnlinks href=#hl-402-2>2</a>
</span><span class=lnt id=hl-402-3><a class=lnlinks href=#hl-402-3>3</a>
</span><span class=lnt id=hl-402-4><a class=lnlinks href=#hl-402-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ForkJoinPool</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ForkJoinPool</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>pool</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AddTask3</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>10</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-403-1><a class=lnlinks href=#hl-403-1>1</a>
</span><span class=lnt id=hl-403-2><a class=lnlinks href=#hl-403-2>2</a>
</span><span class=lnt id=hl-403-3><a class=lnlinks href=#hl-403-3>3</a>
</span><span class=lnt id=hl-403-4><a class=lnlinks href=#hl-403-4>4</a>
</span><span class=lnt id=hl-403-5><a class=lnlinks href=#hl-403-5>5</a>
</span><span class=lnt id=hl-403-6><a class=lnlinks href=#hl-403-6>6</a>
</span><span class=lnt id=hl-403-7><a class=lnlinks href=#hl-403-7>7</a>
</span><span class=lnt id=hl-403-8><a class=lnlinks href=#hl-403-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-0<span class=o>]</span> - join<span class=o>()</span> <span class=m>1</span> + <span class=nv>2</span> <span class=o>=</span> <span class=m>3</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-3<span class=o>]</span> - join<span class=o>()</span> <span class=m>4</span> + <span class=nv>5</span> <span class=o>=</span> <span class=m>9</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-0<span class=o>]</span> - join<span class=o>()</span> <span class=m>3</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-1<span class=o>]</span> - fork<span class=o>()</span> <span class=o>{</span>1,3<span class=o>}</span> + <span class=o>{</span>4,5<span class=o>}</span> <span class=o>=</span> ? 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-2<span class=o>]</span> - fork<span class=o>()</span> <span class=o>{</span>1,2<span class=o>}</span> + <span class=o>{</span>3,3<span class=o>}</span> <span class=o>=</span> ? 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-2<span class=o>]</span> - join<span class=o>()</span> <span class=o>{</span>1,2<span class=o>}</span> + <span class=o>{</span>3,3<span class=o>}</span> <span class=o>=</span> <span class=m>6</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-1<span class=o>]</span> - join<span class=o>()</span> <span class=o>{</span>1,3<span class=o>}</span> + <span class=o>{</span>4,5<span class=o>}</span> <span class=o>=</span> <span class=m>15</span> 
</span></span><span class=line><span class=cl><span class=m>15</span> 
</span></span></code></pre></td></tr></table></div></div><p>用图来表示</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312104428504.png width=900 height=600 loading=lazy decoding=async alt=image-20220312104428504 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=font-colorblueaqs-原理font><a href=#font-colorblueaqs-%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>*AQS 原理</font></h2><h3 id=概述-1><a href=#%e6%a6%82%e8%bf%b0-1 class=header-anchor>#</a>
概述</h3><p>全称是 AbstractQueuedSynchronizer，是阻塞式锁和相关的同步器工具的框架</p><p>特点：</p><ul><li>用 state 属性来表示资源的状态（分独占模式和共享模式），子类需要定义如何维护这个状态，控制如何获取 锁和释放锁<ul><li>getState - 获取 state 状态</li><li>setState - 设置 state 状态</li><li>compareAndSetState - cas 机制设置 state 状态</li><li>独占模式是只有一个线程能够访问资源，而共享模式可以允许多个线程访问资源</li></ul></li><li>提供了基于 FIFO 的等待队列，类似于 Monitor 的 EntryList</li><li>条件变量来实现等待、唤醒机制，支持多个条件变量，类似于 Monitor 的 WaitSet</li></ul><p>子类主要实现这样一些方法（默认抛出 UnsupportedOperationException）</p><ul><li>tryAcquire</li><li>tryRelease</li><li>tryAcquireShared</li><li>tryReleaseShared</li><li>isHeldExclusively</li></ul><p>获取锁的姿势</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-404-1><a class=lnlinks href=#hl-404-1>1</a>
</span><span class=lnt id=hl-404-2><a class=lnlinks href=#hl-404-2>2</a>
</span><span class=lnt id=hl-404-3><a class=lnlinks href=#hl-404-3>3</a>
</span><span class=lnt id=hl-404-4><a class=lnlinks href=#hl-404-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 如果获取锁失败</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 入队, 可以选择阻塞当前线程 park unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>释放锁的姿势</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-405-1><a class=lnlinks href=#hl-405-1>1</a>
</span><span class=lnt id=hl-405-2><a class=lnlinks href=#hl-405-2>2</a>
</span><span class=lnt id=hl-405-3><a class=lnlinks href=#hl-405-3>3</a>
</span><span class=lnt id=hl-405-4><a class=lnlinks href=#hl-405-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 如果释放锁成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryRelease</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 让阻塞线程恢复运行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=实现不可重入锁><a href=#%e5%ae%9e%e7%8e%b0%e4%b8%8d%e5%8f%af%e9%87%8d%e5%85%a5%e9%94%81 class=header-anchor>#</a>
实现不可重入锁</h3><h5 id=自定义同步器><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%90%8c%e6%ad%a5%e5%99%a8 class=header-anchor>#</a>
<strong>自定义同步器</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-406-1><a class=lnlinks href=#hl-406-1> 1</a>
</span><span class=lnt id=hl-406-2><a class=lnlinks href=#hl-406-2> 2</a>
</span><span class=lnt id=hl-406-3><a class=lnlinks href=#hl-406-3> 3</a>
</span><span class=lnt id=hl-406-4><a class=lnlinks href=#hl-406-4> 4</a>
</span><span class=lnt id=hl-406-5><a class=lnlinks href=#hl-406-5> 5</a>
</span><span class=lnt id=hl-406-6><a class=lnlinks href=#hl-406-6> 6</a>
</span><span class=lnt id=hl-406-7><a class=lnlinks href=#hl-406-7> 7</a>
</span><span class=lnt id=hl-406-8><a class=lnlinks href=#hl-406-8> 8</a>
</span><span class=lnt id=hl-406-9><a class=lnlinks href=#hl-406-9> 9</a>
</span><span class=lnt id=hl-406-10><a class=lnlinks href=#hl-406-10>10</a>
</span><span class=lnt id=hl-406-11><a class=lnlinks href=#hl-406-11>11</a>
</span><span class=lnt id=hl-406-12><a class=lnlinks href=#hl-406-12>12</a>
</span><span class=lnt id=hl-406-13><a class=lnlinks href=#hl-406-13>13</a>
</span><span class=lnt id=hl-406-14><a class=lnlinks href=#hl-406-14>14</a>
</span><span class=lnt id=hl-406-15><a class=lnlinks href=#hl-406-15>15</a>
</span><span class=lnt id=hl-406-16><a class=lnlinks href=#hl-406-16>16</a>
</span><span class=lnt id=hl-406-17><a class=lnlinks href=#hl-406-17>17</a>
</span><span class=lnt id=hl-406-18><a class=lnlinks href=#hl-406-18>18</a>
</span><span class=lnt id=hl-406-19><a class=lnlinks href=#hl-406-19>19</a>
</span><span class=lnt id=hl-406-20><a class=lnlinks href=#hl-406-20>20</a>
</span><span class=lnt id=hl-406-21><a class=lnlinks href=#hl-406-21>21</a>
</span><span class=lnt id=hl-406-22><a class=lnlinks href=#hl-406-22>22</a>
</span><span class=lnt id=hl-406-23><a class=lnlinks href=#hl-406-23>23</a>
</span><span class=lnt id=hl-406-24><a class=lnlinks href=#hl-406-24>24</a>
</span><span class=lnt id=hl-406-25><a class=lnlinks href=#hl-406-25>25</a>
</span><span class=lnt id=hl-406-26><a class=lnlinks href=#hl-406-26>26</a>
</span><span class=lnt id=hl-406-27><a class=lnlinks href=#hl-406-27>27</a>
</span><span class=lnt id=hl-406-28><a class=lnlinks href=#hl-406-28>28</a>
</span><span class=lnt id=hl-406-29><a class=lnlinks href=#hl-406-29>29</a>
</span><span class=lnt id=hl-406-30><a class=lnlinks href=#hl-406-30>30</a>
</span><span class=lnt id=hl-406-31><a class=lnlinks href=#hl-406-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>MySync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractQueuedSynchronizer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquires</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryRelease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>acquires</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>getState</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setState</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=nf>newCondition</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConditionObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isHeldExclusively</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getState</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=自定义锁><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e9%94%81 class=header-anchor>#</a>
<strong>自定义锁</strong></h5><p>有了自定义同步器，很容易复用 AQS ，实现一个功能完备的自定义锁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-407-1><a class=lnlinks href=#hl-407-1> 1</a>
</span><span class=lnt id=hl-407-2><a class=lnlinks href=#hl-407-2> 2</a>
</span><span class=lnt id=hl-407-3><a class=lnlinks href=#hl-407-3> 3</a>
</span><span class=lnt id=hl-407-4><a class=lnlinks href=#hl-407-4> 4</a>
</span><span class=lnt id=hl-407-5><a class=lnlinks href=#hl-407-5> 5</a>
</span><span class=lnt id=hl-407-6><a class=lnlinks href=#hl-407-6> 6</a>
</span><span class=lnt id=hl-407-7><a class=lnlinks href=#hl-407-7> 7</a>
</span><span class=lnt id=hl-407-8><a class=lnlinks href=#hl-407-8> 8</a>
</span><span class=lnt id=hl-407-9><a class=lnlinks href=#hl-407-9> 9</a>
</span><span class=lnt id=hl-407-10><a class=lnlinks href=#hl-407-10>10</a>
</span><span class=lnt id=hl-407-11><a class=lnlinks href=#hl-407-11>11</a>
</span><span class=lnt id=hl-407-12><a class=lnlinks href=#hl-407-12>12</a>
</span><span class=lnt id=hl-407-13><a class=lnlinks href=#hl-407-13>13</a>
</span><span class=lnt id=hl-407-14><a class=lnlinks href=#hl-407-14>14</a>
</span><span class=lnt id=hl-407-15><a class=lnlinks href=#hl-407-15>15</a>
</span><span class=lnt id=hl-407-16><a class=lnlinks href=#hl-407-16>16</a>
</span><span class=lnt id=hl-407-17><a class=lnlinks href=#hl-407-17>17</a>
</span><span class=lnt id=hl-407-18><a class=lnlinks href=#hl-407-18>18</a>
</span><span class=lnt id=hl-407-19><a class=lnlinks href=#hl-407-19>19</a>
</span><span class=lnt id=hl-407-20><a class=lnlinks href=#hl-407-20>20</a>
</span><span class=lnt id=hl-407-21><a class=lnlinks href=#hl-407-21>21</a>
</span><span class=lnt id=hl-407-22><a class=lnlinks href=#hl-407-22>22</a>
</span><span class=lnt id=hl-407-23><a class=lnlinks href=#hl-407-23>23</a>
</span><span class=lnt id=hl-407-24><a class=lnlinks href=#hl-407-24>24</a>
</span><span class=lnt id=hl-407-25><a class=lnlinks href=#hl-407-25>25</a>
</span><span class=lnt id=hl-407-26><a class=lnlinks href=#hl-407-26>26</a>
</span><span class=lnt id=hl-407-27><a class=lnlinks href=#hl-407-27>27</a>
</span><span class=lnt id=hl-407-28><a class=lnlinks href=#hl-407-28>28</a>
</span><span class=lnt id=hl-407-29><a class=lnlinks href=#hl-407-29>29</a>
</span><span class=lnt id=hl-407-30><a class=lnlinks href=#hl-407-30>30</a>
</span><span class=lnt id=hl-407-31><a class=lnlinks href=#hl-407-31>31</a>
</span><span class=lnt id=hl-407-32><a class=lnlinks href=#hl-407-32>32</a>
</span><span class=lnt id=hl-407-33><a class=lnlinks href=#hl-407-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>MyLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>MySync</span><span class=w> </span><span class=n>sync</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MySync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试，不成功，进入等待队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>acquire</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试，不成功，进入等待队列，可打断</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lockInterruptibly</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>acquireInterruptibly</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试一次，不成功返回，不进入队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryLock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sync</span><span class=p>.</span><span class=na>tryAcquire</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试，不成功，进入等待队列，有时限</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryLock</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sync</span><span class=p>.</span><span class=na>tryAcquireNanos</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>.</span><span class=na>toNanos</span><span class=p>(</span><span class=n>time</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 释放锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 生成条件变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=nf>newCondition</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sync</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-408-1><a class=lnlinks href=#hl-408-1> 1</a>
</span><span class=lnt id=hl-408-2><a class=lnlinks href=#hl-408-2> 2</a>
</span><span class=lnt id=hl-408-3><a class=lnlinks href=#hl-408-3> 3</a>
</span><span class=lnt id=hl-408-4><a class=lnlinks href=#hl-408-4> 4</a>
</span><span class=lnt id=hl-408-5><a class=lnlinks href=#hl-408-5> 5</a>
</span><span class=lnt id=hl-408-6><a class=lnlinks href=#hl-408-6> 6</a>
</span><span class=lnt id=hl-408-7><a class=lnlinks href=#hl-408-7> 7</a>
</span><span class=lnt id=hl-408-8><a class=lnlinks href=#hl-408-8> 8</a>
</span><span class=lnt id=hl-408-9><a class=lnlinks href=#hl-408-9> 9</a>
</span><span class=lnt id=hl-408-10><a class=lnlinks href=#hl-408-10>10</a>
</span><span class=lnt id=hl-408-11><a class=lnlinks href=#hl-408-11>11</a>
</span><span class=lnt id=hl-408-12><a class=lnlinks href=#hl-408-12>12</a>
</span><span class=lnt id=hl-408-13><a class=lnlinks href=#hl-408-13>13</a>
</span><span class=lnt id=hl-408-14><a class=lnlinks href=#hl-408-14>14</a>
</span><span class=lnt id=hl-408-15><a class=lnlinks href=#hl-408-15>15</a>
</span><span class=lnt id=hl-408-16><a class=lnlinks href=#hl-408-16>16</a>
</span><span class=lnt id=hl-408-17><a class=lnlinks href=#hl-408-17>17</a>
</span><span class=lnt id=hl-408-18><a class=lnlinks href=#hl-408-18>18</a>
</span><span class=lnt id=hl-408-19><a class=lnlinks href=#hl-408-19>19</a>
</span><span class=lnt id=hl-408-20><a class=lnlinks href=#hl-408-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>MyLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MyLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;locking...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unlocking...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;locking...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unlocking...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-409-1><a class=lnlinks href=#hl-409-1>1</a>
</span><span class=lnt id=hl-409-2><a class=lnlinks href=#hl-409-2>2</a>
</span><span class=lnt id=hl-409-3><a class=lnlinks href=#hl-409-3>3</a>
</span><span class=lnt id=hl-409-4><a class=lnlinks href=#hl-409-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>22:29:28.727 c.TestAqs <span class=o>[</span>t1<span class=o>]</span> - locking... 
</span></span><span class=line><span class=cl>22:29:29.732 c.TestAqs <span class=o>[</span>t1<span class=o>]</span> - unlocking... 
</span></span><span class=line><span class=cl>22:29:29.732 c.TestAqs <span class=o>[</span>t2<span class=o>]</span> - locking... 
</span></span><span class=line><span class=cl>22:29:29.732 c.TestAqs <span class=o>[</span>t2<span class=o>]</span> - unlocking... 
</span></span></code></pre></td></tr></table></div></div><p>不可重入测试</p><p>如果改为下面代码，会发现自己也会被挡住（只会打印一次 locking）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-410-1><a class=lnlinks href=#hl-410-1>1</a>
</span><span class=lnt id=hl-410-2><a class=lnlinks href=#hl-410-2>2</a>
</span><span class=lnt id=hl-410-3><a class=lnlinks href=#hl-410-3>3</a>
</span><span class=lnt id=hl-410-4><a class=lnlinks href=#hl-410-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>lock.lock<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>log.debug<span class=o>(</span><span class=s2>&#34;locking...&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>lock.lock<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>log.debug<span class=o>(</span><span class=s2>&#34;locking...&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=心得><a href=#%e5%bf%83%e5%be%97 class=header-anchor>#</a>
心得</h3><h5 id=起源><a href=#%e8%b5%b7%e6%ba%90 class=header-anchor>#</a>
<strong>起源</strong></h5><p>早期程序员会自己通过一种同步器去实现另一种相近的同步器，例如用可重入锁去实现信号量，或反之。这显然不 够优雅，于是在 JSR166（java 规范提案）中创建了 AQS，提供了这种通用的同步器机制。</p><h5 id=目标><a href=#%e7%9b%ae%e6%a0%87 class=header-anchor>#</a>
<strong>目标</strong></h5><p>AQS 要实现的功能目标</p><ul><li>阻塞版本获取锁 acquire 和非阻塞的版本尝试获取锁 tryAcquire</li><li>获取锁超时机制</li><li>通过打断取消机制</li><li>独占机制及共享机制</li><li>条件不满足时的等待机制</li></ul><p>要实现的性能目标</p><blockquote><p>Instead, the primary performance goal here is scalability: to predictably maintain efficiency even, or especially, when synchronizers are contended.</p></blockquote><h5 id=设计><a href=#%e8%ae%be%e8%ae%a1 class=header-anchor>#</a>
<strong>设计</strong></h5><p>AQS 的基本思想其实很简单</p><p>获取锁的逻辑</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-411-1><a class=lnlinks href=#hl-411-1>1</a>
</span><span class=lnt id=hl-411-2><a class=lnlinks href=#hl-411-2>2</a>
</span><span class=lnt id=hl-411-3><a class=lnlinks href=#hl-411-3>3</a>
</span><span class=lnt id=hl-411-4><a class=lnlinks href=#hl-411-4>4</a>
</span><span class=lnt id=hl-411-5><a class=lnlinks href=#hl-411-5>5</a>
</span><span class=lnt id=hl-411-6><a class=lnlinks href=#hl-411-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>while</span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=n>状态不允许获取</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>队列中还没有此线程</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>入队并阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>当前线程出队</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>释放锁的逻辑</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-412-1><a class=lnlinks href=#hl-412-1>1</a>
</span><span class=lnt id=hl-412-2><a class=lnlinks href=#hl-412-2>2</a>
</span><span class=lnt id=hl-412-3><a class=lnlinks href=#hl-412-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=n>状态允许了</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>恢复阻塞的线程</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>要点</p><ul><li>原子维护 state 状态</li><li>阻塞及恢复线程</li><li>维护队列</li></ul><ol><li>state 设计<ul><li>state 使用 volatile 配合 cas 保证其修改时的原子性</li><li>state 使用了 32bit int 来维护同步状态，因为当时使用 long 在很多平台下测试的结果并不理想</li></ul></li></ol><ol start=2><li>阻塞恢复设计<ul><li>早期的控制线程暂停和恢复的 api 有 suspend 和 resume，但它们是不可用的，因为如果先调用的 resume 那么 suspend 将感知不到</li><li>解决方法是使用 park & unpark 来实现线程的暂停和恢复，具体原理在之前讲过了，先 unpark 再 park 也没 问题</li><li>park & unpark 是针对线程的，而不是针对同步器的，因此控制粒度更为精细</li><li>park 线程还可以通过 interrupt 打断</li></ul></li><li>队列设计<ul><li>使用了 FIFO 先入先出队列，并不支持优先级队列</li><li>设计时借鉴了 CLH 队列，它是一种单向无锁队列</li></ul></li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312234238685.png width=900 height=600 loading=lazy decoding=async alt=image-20220312234238685 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>队列中有 head 和 tail 两个指针节点，都用 volatile 修饰配合 cas 使用，每个节点有 state 维护节点状态 入队伪代码，只需要考虑 tail 赋值的原子性</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-413-1><a class=lnlinks href=#hl-413-1>1</a>
</span><span class=lnt id=hl-413-2><a class=lnlinks href=#hl-413-2>2</a>
</span><span class=lnt id=hl-413-3><a class=lnlinks href=#hl-413-3>3</a>
</span><span class=lnt id=hl-413-4><a class=lnlinks href=#hl-413-4>4</a>
</span><span class=lnt id=hl-413-5><a class=lnlinks href=#hl-413-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 原来的 tail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 用 cas 在原来 tail 的基础上改为 node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=n>tail</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>))</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>出队伪代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-414-1><a class=lnlinks href=#hl-414-1>1</a>
</span><span class=lnt id=hl-414-2><a class=lnlinks href=#hl-414-2>2</a>
</span><span class=lnt id=hl-414-3><a class=lnlinks href=#hl-414-3>3</a>
</span><span class=lnt id=hl-414-4><a class=lnlinks href=#hl-414-4>4</a>
</span><span class=lnt id=hl-414-5><a class=lnlinks href=#hl-414-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// prev 是上一个节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>while</span><span class=p>((</span><span class=n>Node</span><span class=w> </span><span class=n>prev</span><span class=o>=</span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=p>).</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>唤醒状态</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 设置头节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>CLH 好处：</p><ul><li>无锁，使用自旋</li><li>快速，无阻塞</li></ul><p>AQS 在一些方面改进了 CLH</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-415-1><a class=lnlinks href=#hl-415-1> 1</a>
</span><span class=lnt id=hl-415-2><a class=lnlinks href=#hl-415-2> 2</a>
</span><span class=lnt id=hl-415-3><a class=lnlinks href=#hl-415-3> 3</a>
</span><span class=lnt id=hl-415-4><a class=lnlinks href=#hl-415-4> 4</a>
</span><span class=lnt id=hl-415-5><a class=lnlinks href=#hl-415-5> 5</a>
</span><span class=lnt id=hl-415-6><a class=lnlinks href=#hl-415-6> 6</a>
</span><span class=lnt id=hl-415-7><a class=lnlinks href=#hl-415-7> 7</a>
</span><span class=lnt id=hl-415-8><a class=lnlinks href=#hl-415-8> 8</a>
</span><span class=lnt id=hl-415-9><a class=lnlinks href=#hl-415-9> 9</a>
</span><span class=lnt id=hl-415-10><a class=lnlinks href=#hl-415-10>10</a>
</span><span class=lnt id=hl-415-11><a class=lnlinks href=#hl-415-11>11</a>
</span><span class=lnt id=hl-415-12><a class=lnlinks href=#hl-415-12>12</a>
</span><span class=lnt id=hl-415-13><a class=lnlinks href=#hl-415-13>13</a>
</span><span class=lnt id=hl-415-14><a class=lnlinks href=#hl-415-14>14</a>
</span><span class=lnt id=hl-415-15><a class=lnlinks href=#hl-415-15>15</a>
</span><span class=lnt id=hl-415-16><a class=lnlinks href=#hl-415-16>16</a>
</span><span class=lnt id=hl-415-17><a class=lnlinks href=#hl-415-17>17</a>
</span><span class=lnt id=hl-415-18><a class=lnlinks href=#hl-415-18>18</a>
</span><span class=lnt id=hl-415-19><a class=lnlinks href=#hl-415-19>19</a>
</span><span class=lnt id=hl-415-20><a class=lnlinks href=#hl-415-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=nf>enq</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 队列中还没有元素 tail 为 null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 将 head 从 null -&gt; dummy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetHead</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 将 node 的 prev 设置为原来的 tail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 将 tail 从原来的 tail 设置为 node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetTail</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 原来 tail 的 next 设置为 node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>t</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=主要用到-aqs-的并发工具类><a href=#%e4%b8%bb%e8%a6%81%e7%94%a8%e5%88%b0-aqs-%e7%9a%84%e5%b9%b6%e5%8f%91%e5%b7%a5%e5%85%b7%e7%b1%bb class=header-anchor>#</a>
主要用到 AQS 的并发工具类</h5><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312235232687.png width=900 height=600 loading=lazy decoding=async alt=image-20220312235232687 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=reentrantlock-原理><a href=#reentrantlock-%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
ReentrantLock 原理</h2><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312235320716.png width=900 height=600 loading=lazy decoding=async alt=image-20220312235320716 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h3 id=非公平锁实现原理><a href=#%e9%9d%9e%e5%85%ac%e5%b9%b3%e9%94%81%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
非公平锁实现原理</h3><h5 id=加锁解锁流程><a href=#%e5%8a%a0%e9%94%81%e8%a7%a3%e9%94%81%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
加锁解锁流程</h5><p>先从构造器开始看，默认为非公平锁实现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-416-1><a class=lnlinks href=#hl-416-1>1</a>
</span><span class=lnt id=hl-416-2><a class=lnlinks href=#hl-416-2>2</a>
</span><span class=lnt id=hl-416-3><a class=lnlinks href=#hl-416-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ReentrantLock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sync</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NonfairSync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>NonfairSync 继承自 AQS 没有竞争时</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153311208.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153311208 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>第一个竞争出现时</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153333551.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153333551 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>Thread-1 执行了</p><ol><li>CAS 尝试将 state 由 0 改为 1，结果失败</li><li>进入 tryAcquire 逻辑，这时 state 已经是1，结果仍然失败</li><li>接下来进入 addWaiter 逻辑，构造 Node 队列<ul><li>图中黄色三角表示该 Node 的 waitStatus 状态，其中 0 为默认正常状态</li><li>Node 的创建是懒惰的</li><li>其中第一个 Node 称为 Dummy（哑元）或哨兵，用来占位，并不关联线程</li></ul></li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153434087.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153434087 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>当前线程进入 acquireQueued 逻辑</p><ol><li>acquireQueued 会在一个死循环中不断尝试获得锁，失败后进入 park 阻塞</li><li>如果自己是紧邻着 head（排第二位），那么再次 tryAcquire 尝试获取锁，当然这时 state 仍为 1，失败</li><li>进入 shouldParkAfterFailedAcquire 逻辑，将前驱 node，即 head 的 waitStatus 改为 -1，这次返回 false
<img src=https://logan.1357810.xyz/notgit/juc/image-20220314153526384.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153526384 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></li><li>shouldParkAfterFailedAcquire 执行完毕回到 acquireQueued ，再次 tryAcquire 尝试获取锁，当然这时 state 仍为 1，失败</li><li>当再次进入 shouldParkAfterFailedAcquire 时，这时因为其前驱 node 的 waitStatus 已经是 -1，这次返回 true</li><li>进入 parkAndCheckInterrupt， Thread-1 park（灰色表示）</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153708216.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153708216 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>再次有多个线程经历上述过程竞争失败，变成这个样子</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314154029099.png width=900 height=600 loading=lazy decoding=async alt=image-20220314154029099 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>Thread-0 释放锁，进入 tryRelease 流程，如果成功</p><ul><li>设置 exclusiveOwnerThread 为 null</li><li>state = 0</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153831407.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153831407 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>当前队列不为 null，并且 head 的 waitStatus = -1，进入 unparkSuccessor 流程</p><p>找到队列中离 head 最近的一个 Node（没取消的），unpark 恢复其运行，本例中即为 Thread-1</p><p>回到 Thread-1 的 acquireQueued 流程</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153919958.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153919958 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>如果加锁成功（没有竞争），会设置</p><ul><li>exclusiveOwnerThread 为 Thread-1，state = 1</li><li>head 指向刚刚 Thread-1 所在的 Node，该 Node 清空 Thread</li><li>原本的 head 因为从链表断开，而可被垃圾回收</li></ul><p>如果这时候有其它线程来竞争（非公平的体现），例如这时有 Thread-4 来了</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314154048958.png width=900 height=600 loading=lazy decoding=async alt=image-20220314154048958 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>如果不巧又被 Thread-4 占了先</p><ul><li>Thread-4 被设置为 exclusiveOwnerThread，state = 1</li><li>Thread-1 再次进入 acquireQueued 流程，获取锁失败，重新进入 park 阻塞</li></ul><h5 id=加锁源码><a href=#%e5%8a%a0%e9%94%81%e6%ba%90%e7%a0%81 class=header-anchor>#</a>
加锁源码</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-417-1><a class=lnlinks href=#hl-417-1>  1</a>
</span><span class=lnt id=hl-417-2><a class=lnlinks href=#hl-417-2>  2</a>
</span><span class=lnt id=hl-417-3><a class=lnlinks href=#hl-417-3>  3</a>
</span><span class=lnt id=hl-417-4><a class=lnlinks href=#hl-417-4>  4</a>
</span><span class=lnt id=hl-417-5><a class=lnlinks href=#hl-417-5>  5</a>
</span><span class=lnt id=hl-417-6><a class=lnlinks href=#hl-417-6>  6</a>
</span><span class=lnt id=hl-417-7><a class=lnlinks href=#hl-417-7>  7</a>
</span><span class=lnt id=hl-417-8><a class=lnlinks href=#hl-417-8>  8</a>
</span><span class=lnt id=hl-417-9><a class=lnlinks href=#hl-417-9>  9</a>
</span><span class=lnt id=hl-417-10><a class=lnlinks href=#hl-417-10> 10</a>
</span><span class=lnt id=hl-417-11><a class=lnlinks href=#hl-417-11> 11</a>
</span><span class=lnt id=hl-417-12><a class=lnlinks href=#hl-417-12> 12</a>
</span><span class=lnt id=hl-417-13><a class=lnlinks href=#hl-417-13> 13</a>
</span><span class=lnt id=hl-417-14><a class=lnlinks href=#hl-417-14> 14</a>
</span><span class=lnt id=hl-417-15><a class=lnlinks href=#hl-417-15> 15</a>
</span><span class=lnt id=hl-417-16><a class=lnlinks href=#hl-417-16> 16</a>
</span><span class=lnt id=hl-417-17><a class=lnlinks href=#hl-417-17> 17</a>
</span><span class=lnt id=hl-417-18><a class=lnlinks href=#hl-417-18> 18</a>
</span><span class=lnt id=hl-417-19><a class=lnlinks href=#hl-417-19> 19</a>
</span><span class=lnt id=hl-417-20><a class=lnlinks href=#hl-417-20> 20</a>
</span><span class=lnt id=hl-417-21><a class=lnlinks href=#hl-417-21> 21</a>
</span><span class=lnt id=hl-417-22><a class=lnlinks href=#hl-417-22> 22</a>
</span><span class=lnt id=hl-417-23><a class=lnlinks href=#hl-417-23> 23</a>
</span><span class=lnt id=hl-417-24><a class=lnlinks href=#hl-417-24> 24</a>
</span><span class=lnt id=hl-417-25><a class=lnlinks href=#hl-417-25> 25</a>
</span><span class=lnt id=hl-417-26><a class=lnlinks href=#hl-417-26> 26</a>
</span><span class=lnt id=hl-417-27><a class=lnlinks href=#hl-417-27> 27</a>
</span><span class=lnt id=hl-417-28><a class=lnlinks href=#hl-417-28> 28</a>
</span><span class=lnt id=hl-417-29><a class=lnlinks href=#hl-417-29> 29</a>
</span><span class=lnt id=hl-417-30><a class=lnlinks href=#hl-417-30> 30</a>
</span><span class=lnt id=hl-417-31><a class=lnlinks href=#hl-417-31> 31</a>
</span><span class=lnt id=hl-417-32><a class=lnlinks href=#hl-417-32> 32</a>
</span><span class=lnt id=hl-417-33><a class=lnlinks href=#hl-417-33> 33</a>
</span><span class=lnt id=hl-417-34><a class=lnlinks href=#hl-417-34> 34</a>
</span><span class=lnt id=hl-417-35><a class=lnlinks href=#hl-417-35> 35</a>
</span><span class=lnt id=hl-417-36><a class=lnlinks href=#hl-417-36> 36</a>
</span><span class=lnt id=hl-417-37><a class=lnlinks href=#hl-417-37> 37</a>
</span><span class=lnt id=hl-417-38><a class=lnlinks href=#hl-417-38> 38</a>
</span><span class=lnt id=hl-417-39><a class=lnlinks href=#hl-417-39> 39</a>
</span><span class=lnt id=hl-417-40><a class=lnlinks href=#hl-417-40> 40</a>
</span><span class=lnt id=hl-417-41><a class=lnlinks href=#hl-417-41> 41</a>
</span><span class=lnt id=hl-417-42><a class=lnlinks href=#hl-417-42> 42</a>
</span><span class=lnt id=hl-417-43><a class=lnlinks href=#hl-417-43> 43</a>
</span><span class=lnt id=hl-417-44><a class=lnlinks href=#hl-417-44> 44</a>
</span><span class=lnt id=hl-417-45><a class=lnlinks href=#hl-417-45> 45</a>
</span><span class=lnt id=hl-417-46><a class=lnlinks href=#hl-417-46> 46</a>
</span><span class=lnt id=hl-417-47><a class=lnlinks href=#hl-417-47> 47</a>
</span><span class=lnt id=hl-417-48><a class=lnlinks href=#hl-417-48> 48</a>
</span><span class=lnt id=hl-417-49><a class=lnlinks href=#hl-417-49> 49</a>
</span><span class=lnt id=hl-417-50><a class=lnlinks href=#hl-417-50> 50</a>
</span><span class=lnt id=hl-417-51><a class=lnlinks href=#hl-417-51> 51</a>
</span><span class=lnt id=hl-417-52><a class=lnlinks href=#hl-417-52> 52</a>
</span><span class=lnt id=hl-417-53><a class=lnlinks href=#hl-417-53> 53</a>
</span><span class=lnt id=hl-417-54><a class=lnlinks href=#hl-417-54> 54</a>
</span><span class=lnt id=hl-417-55><a class=lnlinks href=#hl-417-55> 55</a>
</span><span class=lnt id=hl-417-56><a class=lnlinks href=#hl-417-56> 56</a>
</span><span class=lnt id=hl-417-57><a class=lnlinks href=#hl-417-57> 57</a>
</span><span class=lnt id=hl-417-58><a class=lnlinks href=#hl-417-58> 58</a>
</span><span class=lnt id=hl-417-59><a class=lnlinks href=#hl-417-59> 59</a>
</span><span class=lnt id=hl-417-60><a class=lnlinks href=#hl-417-60> 60</a>
</span><span class=lnt id=hl-417-61><a class=lnlinks href=#hl-417-61> 61</a>
</span><span class=lnt id=hl-417-62><a class=lnlinks href=#hl-417-62> 62</a>
</span><span class=lnt id=hl-417-63><a class=lnlinks href=#hl-417-63> 63</a>
</span><span class=lnt id=hl-417-64><a class=lnlinks href=#hl-417-64> 64</a>
</span><span class=lnt id=hl-417-65><a class=lnlinks href=#hl-417-65> 65</a>
</span><span class=lnt id=hl-417-66><a class=lnlinks href=#hl-417-66> 66</a>
</span><span class=lnt id=hl-417-67><a class=lnlinks href=#hl-417-67> 67</a>
</span><span class=lnt id=hl-417-68><a class=lnlinks href=#hl-417-68> 68</a>
</span><span class=lnt id=hl-417-69><a class=lnlinks href=#hl-417-69> 69</a>
</span><span class=lnt id=hl-417-70><a class=lnlinks href=#hl-417-70> 70</a>
</span><span class=lnt id=hl-417-71><a class=lnlinks href=#hl-417-71> 71</a>
</span><span class=lnt id=hl-417-72><a class=lnlinks href=#hl-417-72> 72</a>
</span><span class=lnt id=hl-417-73><a class=lnlinks href=#hl-417-73> 73</a>
</span><span class=lnt id=hl-417-74><a class=lnlinks href=#hl-417-74> 74</a>
</span><span class=lnt id=hl-417-75><a class=lnlinks href=#hl-417-75> 75</a>
</span><span class=lnt id=hl-417-76><a class=lnlinks href=#hl-417-76> 76</a>
</span><span class=lnt id=hl-417-77><a class=lnlinks href=#hl-417-77> 77</a>
</span><span class=lnt id=hl-417-78><a class=lnlinks href=#hl-417-78> 78</a>
</span><span class=lnt id=hl-417-79><a class=lnlinks href=#hl-417-79> 79</a>
</span><span class=lnt id=hl-417-80><a class=lnlinks href=#hl-417-80> 80</a>
</span><span class=lnt id=hl-417-81><a class=lnlinks href=#hl-417-81> 81</a>
</span><span class=lnt id=hl-417-82><a class=lnlinks href=#hl-417-82> 82</a>
</span><span class=lnt id=hl-417-83><a class=lnlinks href=#hl-417-83> 83</a>
</span><span class=lnt id=hl-417-84><a class=lnlinks href=#hl-417-84> 84</a>
</span><span class=lnt id=hl-417-85><a class=lnlinks href=#hl-417-85> 85</a>
</span><span class=lnt id=hl-417-86><a class=lnlinks href=#hl-417-86> 86</a>
</span><span class=lnt id=hl-417-87><a class=lnlinks href=#hl-417-87> 87</a>
</span><span class=lnt id=hl-417-88><a class=lnlinks href=#hl-417-88> 88</a>
</span><span class=lnt id=hl-417-89><a class=lnlinks href=#hl-417-89> 89</a>
</span><span class=lnt id=hl-417-90><a class=lnlinks href=#hl-417-90> 90</a>
</span><span class=lnt id=hl-417-91><a class=lnlinks href=#hl-417-91> 91</a>
</span><span class=lnt id=hl-417-92><a class=lnlinks href=#hl-417-92> 92</a>
</span><span class=lnt id=hl-417-93><a class=lnlinks href=#hl-417-93> 93</a>
</span><span class=lnt id=hl-417-94><a class=lnlinks href=#hl-417-94> 94</a>
</span><span class=lnt id=hl-417-95><a class=lnlinks href=#hl-417-95> 95</a>
</span><span class=lnt id=hl-417-96><a class=lnlinks href=#hl-417-96> 96</a>
</span><span class=lnt id=hl-417-97><a class=lnlinks href=#hl-417-97> 97</a>
</span><span class=lnt id=hl-417-98><a class=lnlinks href=#hl-417-98> 98</a>
</span><span class=lnt id=hl-417-99><a class=lnlinks href=#hl-417-99> 99</a>
</span><span class=lnt id=hl-417-100><a class=lnlinks href=#hl-417-100>100</a>
</span><span class=lnt id=hl-417-101><a class=lnlinks href=#hl-417-101>101</a>
</span><span class=lnt id=hl-417-102><a class=lnlinks href=#hl-417-102>102</a>
</span><span class=lnt id=hl-417-103><a class=lnlinks href=#hl-417-103>103</a>
</span><span class=lnt id=hl-417-104><a class=lnlinks href=#hl-417-104>104</a>
</span><span class=lnt id=hl-417-105><a class=lnlinks href=#hl-417-105>105</a>
</span><span class=lnt id=hl-417-106><a class=lnlinks href=#hl-417-106>106</a>
</span><span class=lnt id=hl-417-107><a class=lnlinks href=#hl-417-107>107</a>
</span><span class=lnt id=hl-417-108><a class=lnlinks href=#hl-417-108>108</a>
</span><span class=lnt id=hl-417-109><a class=lnlinks href=#hl-417-109>109</a>
</span><span class=lnt id=hl-417-110><a class=lnlinks href=#hl-417-110>110</a>
</span><span class=lnt id=hl-417-111><a class=lnlinks href=#hl-417-111>111</a>
</span><span class=lnt id=hl-417-112><a class=lnlinks href=#hl-417-112>112</a>
</span><span class=lnt id=hl-417-113><a class=lnlinks href=#hl-417-113>113</a>
</span><span class=lnt id=hl-417-114><a class=lnlinks href=#hl-417-114>114</a>
</span><span class=lnt id=hl-417-115><a class=lnlinks href=#hl-417-115>115</a>
</span><span class=lnt id=hl-417-116><a class=lnlinks href=#hl-417-116>116</a>
</span><span class=lnt id=hl-417-117><a class=lnlinks href=#hl-417-117>117</a>
</span><span class=lnt id=hl-417-118><a class=lnlinks href=#hl-417-118>118</a>
</span><span class=lnt id=hl-417-119><a class=lnlinks href=#hl-417-119>119</a>
</span><span class=lnt id=hl-417-120><a class=lnlinks href=#hl-417-120>120</a>
</span><span class=lnt id=hl-417-121><a class=lnlinks href=#hl-417-121>121</a>
</span><span class=lnt id=hl-417-122><a class=lnlinks href=#hl-417-122>122</a>
</span><span class=lnt id=hl-417-123><a class=lnlinks href=#hl-417-123>123</a>
</span><span class=lnt id=hl-417-124><a class=lnlinks href=#hl-417-124>124</a>
</span><span class=lnt id=hl-417-125><a class=lnlinks href=#hl-417-125>125</a>
</span><span class=lnt id=hl-417-126><a class=lnlinks href=#hl-417-126>126</a>
</span><span class=lnt id=hl-417-127><a class=lnlinks href=#hl-417-127>127</a>
</span><span class=lnt id=hl-417-128><a class=lnlinks href=#hl-417-128>128</a>
</span><span class=lnt id=hl-417-129><a class=lnlinks href=#hl-417-129>129</a>
</span><span class=lnt id=hl-417-130><a class=lnlinks href=#hl-417-130>130</a>
</span><span class=lnt id=hl-417-131><a class=lnlinks href=#hl-417-131>131</a>
</span><span class=lnt id=hl-417-132><a class=lnlinks href=#hl-417-132>132</a>
</span><span class=lnt id=hl-417-133><a class=lnlinks href=#hl-417-133>133</a>
</span><span class=lnt id=hl-417-134><a class=lnlinks href=#hl-417-134>134</a>
</span><span class=lnt id=hl-417-135><a class=lnlinks href=#hl-417-135>135</a>
</span><span class=lnt id=hl-417-136><a class=lnlinks href=#hl-417-136>136</a>
</span><span class=lnt id=hl-417-137><a class=lnlinks href=#hl-417-137>137</a>
</span><span class=lnt id=hl-417-138><a class=lnlinks href=#hl-417-138>138</a>
</span><span class=lnt id=hl-417-139><a class=lnlinks href=#hl-417-139>139</a>
</span><span class=lnt id=hl-417-140><a class=lnlinks href=#hl-417-140>140</a>
</span><span class=lnt id=hl-417-141><a class=lnlinks href=#hl-417-141>141</a>
</span><span class=lnt id=hl-417-142><a class=lnlinks href=#hl-417-142>142</a>
</span><span class=lnt id=hl-417-143><a class=lnlinks href=#hl-417-143>143</a>
</span><span class=lnt id=hl-417-144><a class=lnlinks href=#hl-417-144>144</a>
</span><span class=lnt id=hl-417-145><a class=lnlinks href=#hl-417-145>145</a>
</span><span class=lnt id=hl-417-146><a class=lnlinks href=#hl-417-146>146</a>
</span><span class=lnt id=hl-417-147><a class=lnlinks href=#hl-417-147>147</a>
</span><span class=lnt id=hl-417-148><a class=lnlinks href=#hl-417-148>148</a>
</span><span class=lnt id=hl-417-149><a class=lnlinks href=#hl-417-149>149</a>
</span><span class=lnt id=hl-417-150><a class=lnlinks href=#hl-417-150>150</a>
</span><span class=lnt id=hl-417-151><a class=lnlinks href=#hl-417-151>151</a>
</span><span class=lnt id=hl-417-152><a class=lnlinks href=#hl-417-152>152</a>
</span><span class=lnt id=hl-417-153><a class=lnlinks href=#hl-417-153>153</a>
</span><span class=lnt id=hl-417-154><a class=lnlinks href=#hl-417-154>154</a>
</span><span class=lnt id=hl-417-155><a class=lnlinks href=#hl-417-155>155</a>
</span><span class=lnt id=hl-417-156><a class=lnlinks href=#hl-417-156>156</a>
</span><span class=lnt id=hl-417-157><a class=lnlinks href=#hl-417-157>157</a>
</span><span class=lnt id=hl-417-158><a class=lnlinks href=#hl-417-158>158</a>
</span><span class=lnt id=hl-417-159><a class=lnlinks href=#hl-417-159>159</a>
</span><span class=lnt id=hl-417-160><a class=lnlinks href=#hl-417-160>160</a>
</span><span class=lnt id=hl-417-161><a class=lnlinks href=#hl-417-161>161</a>
</span><span class=lnt id=hl-417-162><a class=lnlinks href=#hl-417-162>162</a>
</span><span class=lnt id=hl-417-163><a class=lnlinks href=#hl-417-163>163</a>
</span><span class=lnt id=hl-417-164><a class=lnlinks href=#hl-417-164>164</a>
</span><span class=lnt id=hl-417-165><a class=lnlinks href=#hl-417-165>165</a>
</span><span class=lnt id=hl-417-166><a class=lnlinks href=#hl-417-166>166</a>
</span><span class=lnt id=hl-417-167><a class=lnlinks href=#hl-417-167>167</a>
</span><span class=lnt id=hl-417-168><a class=lnlinks href=#hl-417-168>168</a>
</span><span class=lnt id=hl-417-169><a class=lnlinks href=#hl-417-169>169</a>
</span><span class=lnt id=hl-417-170><a class=lnlinks href=#hl-417-170>170</a>
</span><span class=lnt id=hl-417-171><a class=lnlinks href=#hl-417-171>171</a>
</span><span class=lnt id=hl-417-172><a class=lnlinks href=#hl-417-172>172</a>
</span><span class=lnt id=hl-417-173><a class=lnlinks href=#hl-417-173>173</a>
</span><span class=lnt id=hl-417-174><a class=lnlinks href=#hl-417-174>174</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Sync 继承自 AQS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>7316153563782823691L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 加锁实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 首先用 cas 尝试（仅尝试一次）将 state 从 0 改为 1, 如果成功表示获得了独占锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果尝试失败，进入 ㈠</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acquire</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈠ AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ㈡ tryAcquire </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 当 tryAcquire 返回为 false 时, 先调用 addWaiter ㈣, 接着 acquireQueued ㈤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>EXCLUSIVE</span><span class=p>),</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈡ 进入 ㈢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>nonfairTryAcquire</span><span class=p>(</span><span class=n>acquires</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈢ Sync 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>nonfairTryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果还没有获得锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 尝试用 cas 获得, 这里体现了非公平性: 不去检查 AQS 队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>acquires</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>current</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果已经获得了锁, 线程还是当前线程, 表示发生了锁重入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// state++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>acquires</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=c1>// overflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum lock count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setState</span><span class=p>(</span><span class=n>nextc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取失败, 回到调用处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈣ AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//将当前node加入等待队列末尾等待，并返回当前node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=nf>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>mode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 将当前线程关联到一个 Node 对象上, 模式为独占模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>(),</span><span class=w> </span><span class=n>mode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//非公平同步器中有head和tail两个引用分别指向了等待队列的第一个和最后一个节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//pred指的是node的前驱，从队尾插入，所以pred为tail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果 tail 不为 null, 说明已经有了等待队列了，cas 尝试将 Node 对象加入 AQS 队列尾部</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pred</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//将node的前驱节点设置为pred</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//尝试将队列的tial从当前的pred修改为node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetTail</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 双向链表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//如果pred为null，说明等待队列还未创建，调用enq方法创建队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 尝试将 Node 加入 AQS, 进入 ㈥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enq</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈥ AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//该方法就是创建等待队列，并将node插入队列的尾部。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=nf>enq</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 还没有, 设置 head 为哨兵节点（不对应线程，状态为 0）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetHead</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//将head赋值给tail，head和tail同时指向哨兵节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// cas 尝试将 Node 对象加入 AQS 队列尾部</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//设置node的前驱节点为队列的最后一个节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//尝试将队列的尾部从当前的tail设置为node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetTail</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//将node设为上一个tail的后继节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>t</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈤ AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//在队列中循环等待，只有当排队排到第一名并且获得了锁才能出队并从方法中退出。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//返回打断状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>acquireQueued</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//找到当前node的前驱节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>predecessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 上一个节点是 head, 表示轮到自己（当前线程对应的 node）了, 尝试获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 获取成功, 设置自己（当前线程对应的 node）为 head</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setHead</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 上一个节点 help GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 返回中断标记 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>interrupted</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 判断是否应当 park, 进入 ㈦</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// park 等待, 此时 Node 的状态被置为 Node.SIGNAL ㈧</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>parkAndCheckInterrupt</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cancelAcquire</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈦ AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//判断acquire失败以后是否应该阻塞等待。从规则上来讲：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//1.如果前驱节点都阻塞了，那么当前节点也应该阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//2.如果前驱节点取消，那么应该将前驱节点前移，直到其状态不为取消为止。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//3.如果前两种情况都不是，尝试将前驱节点状态设为SIGNAL，返回false（不用阻塞，等到下次在阻塞）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取上一个节点的状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 上一个节点都在阻塞, 那么自己也阻塞好了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// &gt; 0 表示取消状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 上一个节点取消, 那么重构删除前面所有取消的节点, 返回到外层循环重试</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>prev</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>pred</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 这次还没有阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 但下次如果重试不成功, 则需要阻塞，这时需要设置上一个节点状态为 Node.SIGNAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>ws</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈧ 阻塞当前线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>parkAndCheckInterrupt</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p><p>是否需要 unpark 是由当前节点的前驱节点的 waitStatus == Node.SIGNAL 来决定，而不是本节点的 waitStatus 决定</p></blockquote><p>总结：</p><ul><li>调用<code>lock</code>，尝试将state从0修改为1<ul><li>成功：将owner设为当前线程</li><li>失败：调用<code>acquire</code>-><code>tryAcquire</code>-><code>nonfairTryAcquire</code>，判断state=0则获得锁，或者state不为0但当前线程持有锁则重入锁，以上两种情况<code>tryAcquire</code>返回true，剩余情况返回false。<ul><li>true：获得锁</li><li>false：调用<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code>,其中<code>addwiter</code>将关联线程的节点插入AQS队列尾部，进入<code>acquireQueued</code>中的for循环:<ul><li>如果当前节点是头节点，并尝试获得锁成功，将当前节点设为头节点，清除此节点信息，返回打断标记。</li><li>调用<code>shoudParkAfterFailure</code>,第一次调用返回false，并将前驱节点改为-1，第二次循环如果再进入此方法，会进入阻塞并检查打断的方法。</li></ul></li></ul></li></ul></li></ul><h5 id=解锁源码><a href=#%e8%a7%a3%e9%94%81%e6%ba%90%e7%a0%81 class=header-anchor>#</a>
解锁源码</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-418-1><a class=lnlinks href=#hl-418-1> 1</a>
</span><span class=lnt id=hl-418-2><a class=lnlinks href=#hl-418-2> 2</a>
</span><span class=lnt id=hl-418-3><a class=lnlinks href=#hl-418-3> 3</a>
</span><span class=lnt id=hl-418-4><a class=lnlinks href=#hl-418-4> 4</a>
</span><span class=lnt id=hl-418-5><a class=lnlinks href=#hl-418-5> 5</a>
</span><span class=lnt id=hl-418-6><a class=lnlinks href=#hl-418-6> 6</a>
</span><span class=lnt id=hl-418-7><a class=lnlinks href=#hl-418-7> 7</a>
</span><span class=lnt id=hl-418-8><a class=lnlinks href=#hl-418-8> 8</a>
</span><span class=lnt id=hl-418-9><a class=lnlinks href=#hl-418-9> 9</a>
</span><span class=lnt id=hl-418-10><a class=lnlinks href=#hl-418-10>10</a>
</span><span class=lnt id=hl-418-11><a class=lnlinks href=#hl-418-11>11</a>
</span><span class=lnt id=hl-418-12><a class=lnlinks href=#hl-418-12>12</a>
</span><span class=lnt id=hl-418-13><a class=lnlinks href=#hl-418-13>13</a>
</span><span class=lnt id=hl-418-14><a class=lnlinks href=#hl-418-14>14</a>
</span><span class=lnt id=hl-418-15><a class=lnlinks href=#hl-418-15>15</a>
</span><span class=lnt id=hl-418-16><a class=lnlinks href=#hl-418-16>16</a>
</span><span class=lnt id=hl-418-17><a class=lnlinks href=#hl-418-17>17</a>
</span><span class=lnt id=hl-418-18><a class=lnlinks href=#hl-418-18>18</a>
</span><span class=lnt id=hl-418-19><a class=lnlinks href=#hl-418-19>19</a>
</span><span class=lnt id=hl-418-20><a class=lnlinks href=#hl-418-20>20</a>
</span><span class=lnt id=hl-418-21><a class=lnlinks href=#hl-418-21>21</a>
</span><span class=lnt id=hl-418-22><a class=lnlinks href=#hl-418-22>22</a>
</span><span class=lnt id=hl-418-23><a class=lnlinks href=#hl-418-23>23</a>
</span><span class=lnt id=hl-418-24><a class=lnlinks href=#hl-418-24>24</a>
</span><span class=lnt id=hl-418-25><a class=lnlinks href=#hl-418-25>25</a>
</span><span class=lnt id=hl-418-26><a class=lnlinks href=#hl-418-26>26</a>
</span><span class=lnt id=hl-418-27><a class=lnlinks href=#hl-418-27>27</a>
</span><span class=lnt id=hl-418-28><a class=lnlinks href=#hl-418-28>28</a>
</span><span class=lnt id=hl-418-29><a class=lnlinks href=#hl-418-29>29</a>
</span><span class=lnt id=hl-418-30><a class=lnlinks href=#hl-418-30>30</a>
</span><span class=lnt id=hl-418-31><a class=lnlinks href=#hl-418-31>31</a>
</span><span class=lnt id=hl-418-32><a class=lnlinks href=#hl-418-32>32</a>
</span><span class=lnt id=hl-418-33><a class=lnlinks href=#hl-418-33>33</a>
</span><span class=lnt id=hl-418-34><a class=lnlinks href=#hl-418-34>34</a>
</span><span class=lnt id=hl-418-35><a class=lnlinks href=#hl-418-35>35</a>
</span><span class=lnt id=hl-418-36><a class=lnlinks href=#hl-418-36>36</a>
</span><span class=lnt id=hl-418-37><a class=lnlinks href=#hl-418-37>37</a>
</span><span class=lnt id=hl-418-38><a class=lnlinks href=#hl-418-38>38</a>
</span><span class=lnt id=hl-418-39><a class=lnlinks href=#hl-418-39>39</a>
</span><span class=lnt id=hl-418-40><a class=lnlinks href=#hl-418-40>40</a>
</span><span class=lnt id=hl-418-41><a class=lnlinks href=#hl-418-41>41</a>
</span><span class=lnt id=hl-418-42><a class=lnlinks href=#hl-418-42>42</a>
</span><span class=lnt id=hl-418-43><a class=lnlinks href=#hl-418-43>43</a>
</span><span class=lnt id=hl-418-44><a class=lnlinks href=#hl-418-44>44</a>
</span><span class=lnt id=hl-418-45><a class=lnlinks href=#hl-418-45>45</a>
</span><span class=lnt id=hl-418-46><a class=lnlinks href=#hl-418-46>46</a>
</span><span class=lnt id=hl-418-47><a class=lnlinks href=#hl-418-47>47</a>
</span><span class=lnt id=hl-418-48><a class=lnlinks href=#hl-418-48>48</a>
</span><span class=lnt id=hl-418-49><a class=lnlinks href=#hl-418-49>49</a>
</span><span class=lnt id=hl-418-50><a class=lnlinks href=#hl-418-50>50</a>
</span><span class=lnt id=hl-418-51><a class=lnlinks href=#hl-418-51>51</a>
</span><span class=lnt id=hl-418-52><a class=lnlinks href=#hl-418-52>52</a>
</span><span class=lnt id=hl-418-53><a class=lnlinks href=#hl-418-53>53</a>
</span><span class=lnt id=hl-418-54><a class=lnlinks href=#hl-418-54>54</a>
</span><span class=lnt id=hl-418-55><a class=lnlinks href=#hl-418-55>55</a>
</span><span class=lnt id=hl-418-56><a class=lnlinks href=#hl-418-56>56</a>
</span><span class=lnt id=hl-418-57><a class=lnlinks href=#hl-418-57>57</a>
</span><span class=lnt id=hl-418-58><a class=lnlinks href=#hl-418-58>58</a>
</span><span class=lnt id=hl-418-59><a class=lnlinks href=#hl-418-59>59</a>
</span><span class=lnt id=hl-418-60><a class=lnlinks href=#hl-418-60>60</a>
</span><span class=lnt id=hl-418-61><a class=lnlinks href=#hl-418-61>61</a>
</span><span class=lnt id=hl-418-62><a class=lnlinks href=#hl-418-62>62</a>
</span><span class=lnt id=hl-418-63><a class=lnlinks href=#hl-418-63>63</a>
</span><span class=lnt id=hl-418-64><a class=lnlinks href=#hl-418-64>64</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Sync 继承自 AQS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 解锁实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>release</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 尝试释放锁, 进入 ㈠</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryRelease</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 队列头节点 unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 队列不为 null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// waitStatus == Node.SIGNAL 才需要 unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// unpark AQS 中等待的线程, 进入 ㈡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈠ Sync 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryRelease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>releases</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// state--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>releases</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>free</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 支持锁重入, 只有 state 减为 0, 才释放成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>free</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setState</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>free</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈡ AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unparkSuccessor</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果状态为 Node.SIGNAL 尝试重置状态为 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 不成功也可以</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>ws</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 找到需要 unpark 的节点, 但本节点从 AQS 队列中脱离, 是由唤醒节点完成的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 不考虑已取消的节点, 从 AQS 队列从后至前找到队列最前面需要 unpark 的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>prev</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>thread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>总结：</p><ul><li><code>unlock</code>-><code>syn.release</code>(1)-><code>tryRelease</code>(1),如果当前线程并不持有锁，抛异常。state减去1,如果之后state为0，解锁成功，返回true；如果仍大于0，表示解锁不完全，当前线程依旧持有锁，返回false。</li><li>返回true：检查AQS队列第一个节点状态图是否为<code>SIGNAL</code>(意味着有责任唤醒其后记节点)，如果有，调用<code>unparkSuccessor</code>。<ul><li>再<code>unparkSuccessor</code>中，不考虑已取消的节点, 从 AQS 队列从后至前找到队列最前面需要 unpark 的节点，如果有，将其唤醒。</li></ul></li><li>返回false：</li></ul><h3 id=可重入原理><a href=#%e5%8f%af%e9%87%8d%e5%85%a5%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
可重入原理</h3><p>当持有锁的线程再次尝试获取锁时，会将state的值加1，state表示锁的重入量。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-419-1><a class=lnlinks href=#hl-419-1> 1</a>
</span><span class=lnt id=hl-419-2><a class=lnlinks href=#hl-419-2> 2</a>
</span><span class=lnt id=hl-419-3><a class=lnlinks href=#hl-419-3> 3</a>
</span><span class=lnt id=hl-419-4><a class=lnlinks href=#hl-419-4> 4</a>
</span><span class=lnt id=hl-419-5><a class=lnlinks href=#hl-419-5> 5</a>
</span><span class=lnt id=hl-419-6><a class=lnlinks href=#hl-419-6> 6</a>
</span><span class=lnt id=hl-419-7><a class=lnlinks href=#hl-419-7> 7</a>
</span><span class=lnt id=hl-419-8><a class=lnlinks href=#hl-419-8> 8</a>
</span><span class=lnt id=hl-419-9><a class=lnlinks href=#hl-419-9> 9</a>
</span><span class=lnt id=hl-419-10><a class=lnlinks href=#hl-419-10>10</a>
</span><span class=lnt id=hl-419-11><a class=lnlinks href=#hl-419-11>11</a>
</span><span class=lnt id=hl-419-12><a class=lnlinks href=#hl-419-12>12</a>
</span><span class=lnt id=hl-419-13><a class=lnlinks href=#hl-419-13>13</a>
</span><span class=lnt id=hl-419-14><a class=lnlinks href=#hl-419-14>14</a>
</span><span class=lnt id=hl-419-15><a class=lnlinks href=#hl-419-15>15</a>
</span><span class=lnt id=hl-419-16><a class=lnlinks href=#hl-419-16>16</a>
</span><span class=lnt id=hl-419-17><a class=lnlinks href=#hl-419-17>17</a>
</span><span class=lnt id=hl-419-18><a class=lnlinks href=#hl-419-18>18</a>
</span><span class=lnt id=hl-419-19><a class=lnlinks href=#hl-419-19>19</a>
</span><span class=lnt id=hl-419-20><a class=lnlinks href=#hl-419-20>20</a>
</span><span class=lnt id=hl-419-21><a class=lnlinks href=#hl-419-21>21</a>
</span><span class=lnt id=hl-419-22><a class=lnlinks href=#hl-419-22>22</a>
</span><span class=lnt id=hl-419-23><a class=lnlinks href=#hl-419-23>23</a>
</span><span class=lnt id=hl-419-24><a class=lnlinks href=#hl-419-24>24</a>
</span><span class=lnt id=hl-419-25><a class=lnlinks href=#hl-419-25>25</a>
</span><span class=lnt id=hl-419-26><a class=lnlinks href=#hl-419-26>26</a>
</span><span class=lnt id=hl-419-27><a class=lnlinks href=#hl-419-27>27</a>
</span><span class=lnt id=hl-419-28><a class=lnlinks href=#hl-419-28>28</a>
</span><span class=lnt id=hl-419-29><a class=lnlinks href=#hl-419-29>29</a>
</span><span class=lnt id=hl-419-30><a class=lnlinks href=#hl-419-30>30</a>
</span><span class=lnt id=hl-419-31><a class=lnlinks href=#hl-419-31>31</a>
</span><span class=lnt id=hl-419-32><a class=lnlinks href=#hl-419-32>32</a>
</span><span class=lnt id=hl-419-33><a class=lnlinks href=#hl-419-33>33</a>
</span><span class=lnt id=hl-419-34><a class=lnlinks href=#hl-419-34>34</a>
</span><span class=lnt id=hl-419-35><a class=lnlinks href=#hl-419-35>35</a>
</span><span class=lnt id=hl-419-36><a class=lnlinks href=#hl-419-36>36</a>
</span><span class=lnt id=hl-419-37><a class=lnlinks href=#hl-419-37>37</a>
</span><span class=lnt id=hl-419-38><a class=lnlinks href=#hl-419-38>38</a>
</span><span class=lnt id=hl-419-39><a class=lnlinks href=#hl-419-39>39</a>
</span><span class=lnt id=hl-419-40><a class=lnlinks href=#hl-419-40>40</a>
</span><span class=lnt id=hl-419-41><a class=lnlinks href=#hl-419-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>nonfairTryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>acquires</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>current</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果已经获得了锁, 线程还是当前线程, 表示发生了锁重入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// state++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>acquires</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=c1>// overflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum lock count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setState</span><span class=p>(</span><span class=n>nextc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryRelease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>releases</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// state-- </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>releases</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>free</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 支持锁重入, 只有 state 减为 0, 才释放成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>free</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setState</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>free</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=可打断原理><a href=#%e5%8f%af%e6%89%93%e6%96%ad%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
可打断原理</h3><p><strong>不可打断模式</strong></p><p>在此模式下，即使它被打断，仍会驻留在 AQS 队列中，并将打断信号存储在一个interrupt变量中。一直要等到获得锁后方能得知自己被打断了,并且调用<code>selfInterrupt</code>方法打断自己。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-420-1><a class=lnlinks href=#hl-420-1> 1</a>
</span><span class=lnt id=hl-420-2><a class=lnlinks href=#hl-420-2> 2</a>
</span><span class=lnt id=hl-420-3><a class=lnlinks href=#hl-420-3> 3</a>
</span><span class=lnt id=hl-420-4><a class=lnlinks href=#hl-420-4> 4</a>
</span><span class=lnt id=hl-420-5><a class=lnlinks href=#hl-420-5> 5</a>
</span><span class=lnt id=hl-420-6><a class=lnlinks href=#hl-420-6> 6</a>
</span><span class=lnt id=hl-420-7><a class=lnlinks href=#hl-420-7> 7</a>
</span><span class=lnt id=hl-420-8><a class=lnlinks href=#hl-420-8> 8</a>
</span><span class=lnt id=hl-420-9><a class=lnlinks href=#hl-420-9> 9</a>
</span><span class=lnt id=hl-420-10><a class=lnlinks href=#hl-420-10>10</a>
</span><span class=lnt id=hl-420-11><a class=lnlinks href=#hl-420-11>11</a>
</span><span class=lnt id=hl-420-12><a class=lnlinks href=#hl-420-12>12</a>
</span><span class=lnt id=hl-420-13><a class=lnlinks href=#hl-420-13>13</a>
</span><span class=lnt id=hl-420-14><a class=lnlinks href=#hl-420-14>14</a>
</span><span class=lnt id=hl-420-15><a class=lnlinks href=#hl-420-15>15</a>
</span><span class=lnt id=hl-420-16><a class=lnlinks href=#hl-420-16>16</a>
</span><span class=lnt id=hl-420-17><a class=lnlinks href=#hl-420-17>17</a>
</span><span class=lnt id=hl-420-18><a class=lnlinks href=#hl-420-18>18</a>
</span><span class=lnt id=hl-420-19><a class=lnlinks href=#hl-420-19>19</a>
</span><span class=lnt id=hl-420-20><a class=lnlinks href=#hl-420-20>20</a>
</span><span class=lnt id=hl-420-21><a class=lnlinks href=#hl-420-21>21</a>
</span><span class=lnt id=hl-420-22><a class=lnlinks href=#hl-420-22>22</a>
</span><span class=lnt id=hl-420-23><a class=lnlinks href=#hl-420-23>23</a>
</span><span class=lnt id=hl-420-24><a class=lnlinks href=#hl-420-24>24</a>
</span><span class=lnt id=hl-420-25><a class=lnlinks href=#hl-420-25>25</a>
</span><span class=lnt id=hl-420-26><a class=lnlinks href=#hl-420-26>26</a>
</span><span class=lnt id=hl-420-27><a class=lnlinks href=#hl-420-27>27</a>
</span><span class=lnt id=hl-420-28><a class=lnlinks href=#hl-420-28>28</a>
</span><span class=lnt id=hl-420-29><a class=lnlinks href=#hl-420-29>29</a>
</span><span class=lnt id=hl-420-30><a class=lnlinks href=#hl-420-30>30</a>
</span><span class=lnt id=hl-420-31><a class=lnlinks href=#hl-420-31>31</a>
</span><span class=lnt id=hl-420-32><a class=lnlinks href=#hl-420-32>32</a>
</span><span class=lnt id=hl-420-33><a class=lnlinks href=#hl-420-33>33</a>
</span><span class=lnt id=hl-420-34><a class=lnlinks href=#hl-420-34>34</a>
</span><span class=lnt id=hl-420-35><a class=lnlinks href=#hl-420-35>35</a>
</span><span class=lnt id=hl-420-36><a class=lnlinks href=#hl-420-36>36</a>
</span><span class=lnt id=hl-420-37><a class=lnlinks href=#hl-420-37>37</a>
</span><span class=lnt id=hl-420-38><a class=lnlinks href=#hl-420-38>38</a>
</span><span class=lnt id=hl-420-39><a class=lnlinks href=#hl-420-39>39</a>
</span><span class=lnt id=hl-420-40><a class=lnlinks href=#hl-420-40>40</a>
</span><span class=lnt id=hl-420-41><a class=lnlinks href=#hl-420-41>41</a>
</span><span class=lnt id=hl-420-42><a class=lnlinks href=#hl-420-42>42</a>
</span><span class=lnt id=hl-420-43><a class=lnlinks href=#hl-420-43>43</a>
</span><span class=lnt id=hl-420-44><a class=lnlinks href=#hl-420-44>44</a>
</span><span class=lnt id=hl-420-45><a class=lnlinks href=#hl-420-45>45</a>
</span><span class=lnt id=hl-420-46><a class=lnlinks href=#hl-420-46>46</a>
</span><span class=lnt id=hl-420-47><a class=lnlinks href=#hl-420-47>47</a>
</span><span class=lnt id=hl-420-48><a class=lnlinks href=#hl-420-48>48</a>
</span><span class=lnt id=hl-420-49><a class=lnlinks href=#hl-420-49>49</a>
</span><span class=lnt id=hl-420-50><a class=lnlinks href=#hl-420-50>50</a>
</span><span class=lnt id=hl-420-51><a class=lnlinks href=#hl-420-51>51</a>
</span><span class=lnt id=hl-420-52><a class=lnlinks href=#hl-420-52>52</a>
</span><span class=lnt id=hl-420-53><a class=lnlinks href=#hl-420-53>53</a>
</span><span class=lnt id=hl-420-54><a class=lnlinks href=#hl-420-54>54</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Sync 继承自 AQS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>parkAndCheckInterrupt</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果打断标记已经是 true, 则 park 会失效</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// interrupted 会清除打断标记</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>acquireQueued</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>predecessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setHead</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 还是需要获得锁后, 才能返回打断状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>interrupted</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>parkAndCheckInterrupt</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 如果是因为 interrupt 被唤醒, 返回打断状态为 true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cancelAcquire</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>EXCLUSIVE</span><span class=p>),</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果打断状态为 true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//响应打断标记，打断自己</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>selfInterrupt</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 重新产生一次中断</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>可打断模式</strong></p><p>此模式下即使线程在等待队列中等待，一旦被打断，就会立刻抛出打断异常。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-421-1><a class=lnlinks href=#hl-421-1> 1</a>
</span><span class=lnt id=hl-421-2><a class=lnlinks href=#hl-421-2> 2</a>
</span><span class=lnt id=hl-421-3><a class=lnlinks href=#hl-421-3> 3</a>
</span><span class=lnt id=hl-421-4><a class=lnlinks href=#hl-421-4> 4</a>
</span><span class=lnt id=hl-421-5><a class=lnlinks href=#hl-421-5> 5</a>
</span><span class=lnt id=hl-421-6><a class=lnlinks href=#hl-421-6> 6</a>
</span><span class=lnt id=hl-421-7><a class=lnlinks href=#hl-421-7> 7</a>
</span><span class=lnt id=hl-421-8><a class=lnlinks href=#hl-421-8> 8</a>
</span><span class=lnt id=hl-421-9><a class=lnlinks href=#hl-421-9> 9</a>
</span><span class=lnt id=hl-421-10><a class=lnlinks href=#hl-421-10>10</a>
</span><span class=lnt id=hl-421-11><a class=lnlinks href=#hl-421-11>11</a>
</span><span class=lnt id=hl-421-12><a class=lnlinks href=#hl-421-12>12</a>
</span><span class=lnt id=hl-421-13><a class=lnlinks href=#hl-421-13>13</a>
</span><span class=lnt id=hl-421-14><a class=lnlinks href=#hl-421-14>14</a>
</span><span class=lnt id=hl-421-15><a class=lnlinks href=#hl-421-15>15</a>
</span><span class=lnt id=hl-421-16><a class=lnlinks href=#hl-421-16>16</a>
</span><span class=lnt id=hl-421-17><a class=lnlinks href=#hl-421-17>17</a>
</span><span class=lnt id=hl-421-18><a class=lnlinks href=#hl-421-18>18</a>
</span><span class=lnt id=hl-421-19><a class=lnlinks href=#hl-421-19>19</a>
</span><span class=lnt id=hl-421-20><a class=lnlinks href=#hl-421-20>20</a>
</span><span class=lnt id=hl-421-21><a class=lnlinks href=#hl-421-21>21</a>
</span><span class=lnt id=hl-421-22><a class=lnlinks href=#hl-421-22>22</a>
</span><span class=lnt id=hl-421-23><a class=lnlinks href=#hl-421-23>23</a>
</span><span class=lnt id=hl-421-24><a class=lnlinks href=#hl-421-24>24</a>
</span><span class=lnt id=hl-421-25><a class=lnlinks href=#hl-421-25>25</a>
</span><span class=lnt id=hl-421-26><a class=lnlinks href=#hl-421-26>26</a>
</span><span class=lnt id=hl-421-27><a class=lnlinks href=#hl-421-27>27</a>
</span><span class=lnt id=hl-421-28><a class=lnlinks href=#hl-421-28>28</a>
</span><span class=lnt id=hl-421-29><a class=lnlinks href=#hl-421-29>29</a>
</span><span class=lnt id=hl-421-30><a class=lnlinks href=#hl-421-30>30</a>
</span><span class=lnt id=hl-421-31><a class=lnlinks href=#hl-421-31>31</a>
</span><span class=lnt id=hl-421-32><a class=lnlinks href=#hl-421-32>32</a>
</span><span class=lnt id=hl-421-33><a class=lnlinks href=#hl-421-33>33</a>
</span><span class=lnt id=hl-421-34><a class=lnlinks href=#hl-421-34>34</a>
</span><span class=lnt id=hl-421-35><a class=lnlinks href=#hl-421-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquireInterruptibly</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果没有获得到锁, 进入 ㈠</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doAcquireInterruptibly</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈠ 可打断的获取锁流程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doAcquireInterruptibly</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>EXCLUSIVE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>predecessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setHead</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// help GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>parkAndCheckInterrupt</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 在 park 过程中如果被 interrupt 会进入此</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 这时候抛出异常, 而不会再次进入 for (;;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cancelAcquire</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=公平锁实现原理><a href=#%e5%85%ac%e5%b9%b3%e9%94%81%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
公平锁实现原理</h3><p>简而言之，公平与非公平的区别在于，公平锁中的tryAcquire方法被重写了，新来的线程即便得知了锁的state为0，也要先判断等待队列中是否还有线程等待，只有当队列没有线程等待式，才获得锁。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-422-1><a class=lnlinks href=#hl-422-1> 1</a>
</span><span class=lnt id=hl-422-2><a class=lnlinks href=#hl-422-2> 2</a>
</span><span class=lnt id=hl-422-3><a class=lnlinks href=#hl-422-3> 3</a>
</span><span class=lnt id=hl-422-4><a class=lnlinks href=#hl-422-4> 4</a>
</span><span class=lnt id=hl-422-5><a class=lnlinks href=#hl-422-5> 5</a>
</span><span class=lnt id=hl-422-6><a class=lnlinks href=#hl-422-6> 6</a>
</span><span class=lnt id=hl-422-7><a class=lnlinks href=#hl-422-7> 7</a>
</span><span class=lnt id=hl-422-8><a class=lnlinks href=#hl-422-8> 8</a>
</span><span class=lnt id=hl-422-9><a class=lnlinks href=#hl-422-9> 9</a>
</span><span class=lnt id=hl-422-10><a class=lnlinks href=#hl-422-10>10</a>
</span><span class=lnt id=hl-422-11><a class=lnlinks href=#hl-422-11>11</a>
</span><span class=lnt id=hl-422-12><a class=lnlinks href=#hl-422-12>12</a>
</span><span class=lnt id=hl-422-13><a class=lnlinks href=#hl-422-13>13</a>
</span><span class=lnt id=hl-422-14><a class=lnlinks href=#hl-422-14>14</a>
</span><span class=lnt id=hl-422-15><a class=lnlinks href=#hl-422-15>15</a>
</span><span class=lnt id=hl-422-16><a class=lnlinks href=#hl-422-16>16</a>
</span><span class=lnt id=hl-422-17><a class=lnlinks href=#hl-422-17>17</a>
</span><span class=lnt id=hl-422-18><a class=lnlinks href=#hl-422-18>18</a>
</span><span class=lnt id=hl-422-19><a class=lnlinks href=#hl-422-19>19</a>
</span><span class=lnt id=hl-422-20><a class=lnlinks href=#hl-422-20>20</a>
</span><span class=lnt id=hl-422-21><a class=lnlinks href=#hl-422-21>21</a>
</span><span class=lnt id=hl-422-22><a class=lnlinks href=#hl-422-22>22</a>
</span><span class=lnt id=hl-422-23><a class=lnlinks href=#hl-422-23>23</a>
</span><span class=lnt id=hl-422-24><a class=lnlinks href=#hl-422-24>24</a>
</span><span class=lnt id=hl-422-25><a class=lnlinks href=#hl-422-25>25</a>
</span><span class=lnt id=hl-422-26><a class=lnlinks href=#hl-422-26>26</a>
</span><span class=lnt id=hl-422-27><a class=lnlinks href=#hl-422-27>27</a>
</span><span class=lnt id=hl-422-28><a class=lnlinks href=#hl-422-28>28</a>
</span><span class=lnt id=hl-422-29><a class=lnlinks href=#hl-422-29>29</a>
</span><span class=lnt id=hl-422-30><a class=lnlinks href=#hl-422-30>30</a>
</span><span class=lnt id=hl-422-31><a class=lnlinks href=#hl-422-31>31</a>
</span><span class=lnt id=hl-422-32><a class=lnlinks href=#hl-422-32>32</a>
</span><span class=lnt id=hl-422-33><a class=lnlinks href=#hl-422-33>33</a>
</span><span class=lnt id=hl-422-34><a class=lnlinks href=#hl-422-34>34</a>
</span><span class=lnt id=hl-422-35><a class=lnlinks href=#hl-422-35>35</a>
</span><span class=lnt id=hl-422-36><a class=lnlinks href=#hl-422-36>36</a>
</span><span class=lnt id=hl-422-37><a class=lnlinks href=#hl-422-37>37</a>
</span><span class=lnt id=hl-422-38><a class=lnlinks href=#hl-422-38>38</a>
</span><span class=lnt id=hl-422-39><a class=lnlinks href=#hl-422-39>39</a>
</span><span class=lnt id=hl-422-40><a class=lnlinks href=#hl-422-40>40</a>
</span><span class=lnt id=hl-422-41><a class=lnlinks href=#hl-422-41>41</a>
</span><span class=lnt id=hl-422-42><a class=lnlinks href=#hl-422-42>42</a>
</span><span class=lnt id=hl-422-43><a class=lnlinks href=#hl-422-43>43</a>
</span><span class=lnt id=hl-422-44><a class=lnlinks href=#hl-422-44>44</a>
</span><span class=lnt id=hl-422-45><a class=lnlinks href=#hl-422-45>45</a>
</span><span class=lnt id=hl-422-46><a class=lnlinks href=#hl-422-46>46</a>
</span><span class=lnt id=hl-422-47><a class=lnlinks href=#hl-422-47>47</a>
</span><span class=lnt id=hl-422-48><a class=lnlinks href=#hl-422-48>48</a>
</span><span class=lnt id=hl-422-49><a class=lnlinks href=#hl-422-49>49</a>
</span><span class=lnt id=hl-422-50><a class=lnlinks href=#hl-422-50>50</a>
</span><span class=lnt id=hl-422-51><a class=lnlinks href=#hl-422-51>51</a>
</span><span class=lnt id=hl-422-52><a class=lnlinks href=#hl-422-52>52</a>
</span><span class=lnt id=hl-422-53><a class=lnlinks href=#hl-422-53>53</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>FairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>3000897897090466540L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>acquire</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>EXCLUSIVE</span><span class=p>),</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 与非公平锁主要区别在于 tryAcquire 方法的实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 先检查 AQS 队列中是否有前驱节点, 没有才去竞争</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasQueuedPredecessors</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>acquires</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>current</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>acquires</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum lock count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setState</span><span class=p>(</span><span class=n>nextc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈠ AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//存疑</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>hasQueuedPredecessors</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// h != t 时表示队列中有 Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// (s = h.next) == null 表示队列中还有没有老二</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 或者队列中老二线程不是此线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>s</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=条件变量实现原理><a href=#%e6%9d%a1%e4%bb%b6%e5%8f%98%e9%87%8f%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
条件变量实现原理</h3><p>每个条件变量其实就对应着一个等待队列，其实现类是 ConditionObject</p><h4 id=await-流程><a href=#await-%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
await 流程</h4><p>开始 Thread-0 持有锁，调用 await，进入 ConditionObject 的 addConditionWaiter 流程</p><p>创建新的 Node 状态为 -2（Node.CONDITION），关联 Thread-0，加入等待队列尾部</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171543622.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171543622 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>接下来进入 AQS 的 fullyRelease 流程，释放同步器上的锁</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171600661.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171600661 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>unpark AQS 队列中的下一个节点，竞争锁，假设没有其他竞争线程，那么 Thread-1 竞争成功</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171619415.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171619415 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>park 阻塞 Thread-0</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171637949.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171637949 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>总结：</p><ul><li>创建一个节点，关联当前线程，并插入到当前Condition队列的尾部</li><li>调用<code>fullRelease</code>，完全释放同步器中的锁，并记录当前线程的锁重入数</li><li>唤醒(park)AQS队列中的第一个线程</li><li>调用park方法，阻塞当前线程。</li></ul><h4 id=signal-流程><a href=#signal-%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
signal 流程</h4><p>假设 Thread-1 要来唤醒 Thread-0</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171703144.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171703144 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>进入 ConditionObject 的 doSignal 流程，取得等待队列中第一个 Node，即 Thread-0 所在 Node</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171727397.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171727397 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>执行 transferForSignal 流程，将该 Node 加入 AQS 队列尾部，将 Thread-0 的 waitStatus 改为 0，Thread-3 的 waitStatus 改为 -1</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171749467.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171749467 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>Thread-1 释放锁，进入 unlock 流程，略</p><p>总结：</p><ul><li>当前持有锁的线程唤醒等待队列中的线程，调用doSignal或doSignalAll方法，将等待队列中的第一个（或全部）节点插入到AQS队列中的尾部。</li><li>将插入的节点的状态从Condition设置为0，将插入节点的前一个节点的状态设置为-1（意味着要承担唤醒后一个节点的责任）</li><li>当前线程释放锁，parkAQS队列中的第一个节点线程。</li></ul><h4 id=源码><a href=#%e6%ba%90%e7%a0%81 class=header-anchor>#</a>
源码</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-423-1><a class=lnlinks href=#hl-423-1>  1</a>
</span><span class=lnt id=hl-423-2><a class=lnlinks href=#hl-423-2>  2</a>
</span><span class=lnt id=hl-423-3><a class=lnlinks href=#hl-423-3>  3</a>
</span><span class=lnt id=hl-423-4><a class=lnlinks href=#hl-423-4>  4</a>
</span><span class=lnt id=hl-423-5><a class=lnlinks href=#hl-423-5>  5</a>
</span><span class=lnt id=hl-423-6><a class=lnlinks href=#hl-423-6>  6</a>
</span><span class=lnt id=hl-423-7><a class=lnlinks href=#hl-423-7>  7</a>
</span><span class=lnt id=hl-423-8><a class=lnlinks href=#hl-423-8>  8</a>
</span><span class=lnt id=hl-423-9><a class=lnlinks href=#hl-423-9>  9</a>
</span><span class=lnt id=hl-423-10><a class=lnlinks href=#hl-423-10> 10</a>
</span><span class=lnt id=hl-423-11><a class=lnlinks href=#hl-423-11> 11</a>
</span><span class=lnt id=hl-423-12><a class=lnlinks href=#hl-423-12> 12</a>
</span><span class=lnt id=hl-423-13><a class=lnlinks href=#hl-423-13> 13</a>
</span><span class=lnt id=hl-423-14><a class=lnlinks href=#hl-423-14> 14</a>
</span><span class=lnt id=hl-423-15><a class=lnlinks href=#hl-423-15> 15</a>
</span><span class=lnt id=hl-423-16><a class=lnlinks href=#hl-423-16> 16</a>
</span><span class=lnt id=hl-423-17><a class=lnlinks href=#hl-423-17> 17</a>
</span><span class=lnt id=hl-423-18><a class=lnlinks href=#hl-423-18> 18</a>
</span><span class=lnt id=hl-423-19><a class=lnlinks href=#hl-423-19> 19</a>
</span><span class=lnt id=hl-423-20><a class=lnlinks href=#hl-423-20> 20</a>
</span><span class=lnt id=hl-423-21><a class=lnlinks href=#hl-423-21> 21</a>
</span><span class=lnt id=hl-423-22><a class=lnlinks href=#hl-423-22> 22</a>
</span><span class=lnt id=hl-423-23><a class=lnlinks href=#hl-423-23> 23</a>
</span><span class=lnt id=hl-423-24><a class=lnlinks href=#hl-423-24> 24</a>
</span><span class=lnt id=hl-423-25><a class=lnlinks href=#hl-423-25> 25</a>
</span><span class=lnt id=hl-423-26><a class=lnlinks href=#hl-423-26> 26</a>
</span><span class=lnt id=hl-423-27><a class=lnlinks href=#hl-423-27> 27</a>
</span><span class=lnt id=hl-423-28><a class=lnlinks href=#hl-423-28> 28</a>
</span><span class=lnt id=hl-423-29><a class=lnlinks href=#hl-423-29> 29</a>
</span><span class=lnt id=hl-423-30><a class=lnlinks href=#hl-423-30> 30</a>
</span><span class=lnt id=hl-423-31><a class=lnlinks href=#hl-423-31> 31</a>
</span><span class=lnt id=hl-423-32><a class=lnlinks href=#hl-423-32> 32</a>
</span><span class=lnt id=hl-423-33><a class=lnlinks href=#hl-423-33> 33</a>
</span><span class=lnt id=hl-423-34><a class=lnlinks href=#hl-423-34> 34</a>
</span><span class=lnt id=hl-423-35><a class=lnlinks href=#hl-423-35> 35</a>
</span><span class=lnt id=hl-423-36><a class=lnlinks href=#hl-423-36> 36</a>
</span><span class=lnt id=hl-423-37><a class=lnlinks href=#hl-423-37> 37</a>
</span><span class=lnt id=hl-423-38><a class=lnlinks href=#hl-423-38> 38</a>
</span><span class=lnt id=hl-423-39><a class=lnlinks href=#hl-423-39> 39</a>
</span><span class=lnt id=hl-423-40><a class=lnlinks href=#hl-423-40> 40</a>
</span><span class=lnt id=hl-423-41><a class=lnlinks href=#hl-423-41> 41</a>
</span><span class=lnt id=hl-423-42><a class=lnlinks href=#hl-423-42> 42</a>
</span><span class=lnt id=hl-423-43><a class=lnlinks href=#hl-423-43> 43</a>
</span><span class=lnt id=hl-423-44><a class=lnlinks href=#hl-423-44> 44</a>
</span><span class=lnt id=hl-423-45><a class=lnlinks href=#hl-423-45> 45</a>
</span><span class=lnt id=hl-423-46><a class=lnlinks href=#hl-423-46> 46</a>
</span><span class=lnt id=hl-423-47><a class=lnlinks href=#hl-423-47> 47</a>
</span><span class=lnt id=hl-423-48><a class=lnlinks href=#hl-423-48> 48</a>
</span><span class=lnt id=hl-423-49><a class=lnlinks href=#hl-423-49> 49</a>
</span><span class=lnt id=hl-423-50><a class=lnlinks href=#hl-423-50> 50</a>
</span><span class=lnt id=hl-423-51><a class=lnlinks href=#hl-423-51> 51</a>
</span><span class=lnt id=hl-423-52><a class=lnlinks href=#hl-423-52> 52</a>
</span><span class=lnt id=hl-423-53><a class=lnlinks href=#hl-423-53> 53</a>
</span><span class=lnt id=hl-423-54><a class=lnlinks href=#hl-423-54> 54</a>
</span><span class=lnt id=hl-423-55><a class=lnlinks href=#hl-423-55> 55</a>
</span><span class=lnt id=hl-423-56><a class=lnlinks href=#hl-423-56> 56</a>
</span><span class=lnt id=hl-423-57><a class=lnlinks href=#hl-423-57> 57</a>
</span><span class=lnt id=hl-423-58><a class=lnlinks href=#hl-423-58> 58</a>
</span><span class=lnt id=hl-423-59><a class=lnlinks href=#hl-423-59> 59</a>
</span><span class=lnt id=hl-423-60><a class=lnlinks href=#hl-423-60> 60</a>
</span><span class=lnt id=hl-423-61><a class=lnlinks href=#hl-423-61> 61</a>
</span><span class=lnt id=hl-423-62><a class=lnlinks href=#hl-423-62> 62</a>
</span><span class=lnt id=hl-423-63><a class=lnlinks href=#hl-423-63> 63</a>
</span><span class=lnt id=hl-423-64><a class=lnlinks href=#hl-423-64> 64</a>
</span><span class=lnt id=hl-423-65><a class=lnlinks href=#hl-423-65> 65</a>
</span><span class=lnt id=hl-423-66><a class=lnlinks href=#hl-423-66> 66</a>
</span><span class=lnt id=hl-423-67><a class=lnlinks href=#hl-423-67> 67</a>
</span><span class=lnt id=hl-423-68><a class=lnlinks href=#hl-423-68> 68</a>
</span><span class=lnt id=hl-423-69><a class=lnlinks href=#hl-423-69> 69</a>
</span><span class=lnt id=hl-423-70><a class=lnlinks href=#hl-423-70> 70</a>
</span><span class=lnt id=hl-423-71><a class=lnlinks href=#hl-423-71> 71</a>
</span><span class=lnt id=hl-423-72><a class=lnlinks href=#hl-423-72> 72</a>
</span><span class=lnt id=hl-423-73><a class=lnlinks href=#hl-423-73> 73</a>
</span><span class=lnt id=hl-423-74><a class=lnlinks href=#hl-423-74> 74</a>
</span><span class=lnt id=hl-423-75><a class=lnlinks href=#hl-423-75> 75</a>
</span><span class=lnt id=hl-423-76><a class=lnlinks href=#hl-423-76> 76</a>
</span><span class=lnt id=hl-423-77><a class=lnlinks href=#hl-423-77> 77</a>
</span><span class=lnt id=hl-423-78><a class=lnlinks href=#hl-423-78> 78</a>
</span><span class=lnt id=hl-423-79><a class=lnlinks href=#hl-423-79> 79</a>
</span><span class=lnt id=hl-423-80><a class=lnlinks href=#hl-423-80> 80</a>
</span><span class=lnt id=hl-423-81><a class=lnlinks href=#hl-423-81> 81</a>
</span><span class=lnt id=hl-423-82><a class=lnlinks href=#hl-423-82> 82</a>
</span><span class=lnt id=hl-423-83><a class=lnlinks href=#hl-423-83> 83</a>
</span><span class=lnt id=hl-423-84><a class=lnlinks href=#hl-423-84> 84</a>
</span><span class=lnt id=hl-423-85><a class=lnlinks href=#hl-423-85> 85</a>
</span><span class=lnt id=hl-423-86><a class=lnlinks href=#hl-423-86> 86</a>
</span><span class=lnt id=hl-423-87><a class=lnlinks href=#hl-423-87> 87</a>
</span><span class=lnt id=hl-423-88><a class=lnlinks href=#hl-423-88> 88</a>
</span><span class=lnt id=hl-423-89><a class=lnlinks href=#hl-423-89> 89</a>
</span><span class=lnt id=hl-423-90><a class=lnlinks href=#hl-423-90> 90</a>
</span><span class=lnt id=hl-423-91><a class=lnlinks href=#hl-423-91> 91</a>
</span><span class=lnt id=hl-423-92><a class=lnlinks href=#hl-423-92> 92</a>
</span><span class=lnt id=hl-423-93><a class=lnlinks href=#hl-423-93> 93</a>
</span><span class=lnt id=hl-423-94><a class=lnlinks href=#hl-423-94> 94</a>
</span><span class=lnt id=hl-423-95><a class=lnlinks href=#hl-423-95> 95</a>
</span><span class=lnt id=hl-423-96><a class=lnlinks href=#hl-423-96> 96</a>
</span><span class=lnt id=hl-423-97><a class=lnlinks href=#hl-423-97> 97</a>
</span><span class=lnt id=hl-423-98><a class=lnlinks href=#hl-423-98> 98</a>
</span><span class=lnt id=hl-423-99><a class=lnlinks href=#hl-423-99> 99</a>
</span><span class=lnt id=hl-423-100><a class=lnlinks href=#hl-423-100>100</a>
</span><span class=lnt id=hl-423-101><a class=lnlinks href=#hl-423-101>101</a>
</span><span class=lnt id=hl-423-102><a class=lnlinks href=#hl-423-102>102</a>
</span><span class=lnt id=hl-423-103><a class=lnlinks href=#hl-423-103>103</a>
</span><span class=lnt id=hl-423-104><a class=lnlinks href=#hl-423-104>104</a>
</span><span class=lnt id=hl-423-105><a class=lnlinks href=#hl-423-105>105</a>
</span><span class=lnt id=hl-423-106><a class=lnlinks href=#hl-423-106>106</a>
</span><span class=lnt id=hl-423-107><a class=lnlinks href=#hl-423-107>107</a>
</span><span class=lnt id=hl-423-108><a class=lnlinks href=#hl-423-108>108</a>
</span><span class=lnt id=hl-423-109><a class=lnlinks href=#hl-423-109>109</a>
</span><span class=lnt id=hl-423-110><a class=lnlinks href=#hl-423-110>110</a>
</span><span class=lnt id=hl-423-111><a class=lnlinks href=#hl-423-111>111</a>
</span><span class=lnt id=hl-423-112><a class=lnlinks href=#hl-423-112>112</a>
</span><span class=lnt id=hl-423-113><a class=lnlinks href=#hl-423-113>113</a>
</span><span class=lnt id=hl-423-114><a class=lnlinks href=#hl-423-114>114</a>
</span><span class=lnt id=hl-423-115><a class=lnlinks href=#hl-423-115>115</a>
</span><span class=lnt id=hl-423-116><a class=lnlinks href=#hl-423-116>116</a>
</span><span class=lnt id=hl-423-117><a class=lnlinks href=#hl-423-117>117</a>
</span><span class=lnt id=hl-423-118><a class=lnlinks href=#hl-423-118>118</a>
</span><span class=lnt id=hl-423-119><a class=lnlinks href=#hl-423-119>119</a>
</span><span class=lnt id=hl-423-120><a class=lnlinks href=#hl-423-120>120</a>
</span><span class=lnt id=hl-423-121><a class=lnlinks href=#hl-423-121>121</a>
</span><span class=lnt id=hl-423-122><a class=lnlinks href=#hl-423-122>122</a>
</span><span class=lnt id=hl-423-123><a class=lnlinks href=#hl-423-123>123</a>
</span><span class=lnt id=hl-423-124><a class=lnlinks href=#hl-423-124>124</a>
</span><span class=lnt id=hl-423-125><a class=lnlinks href=#hl-423-125>125</a>
</span><span class=lnt id=hl-423-126><a class=lnlinks href=#hl-423-126>126</a>
</span><span class=lnt id=hl-423-127><a class=lnlinks href=#hl-423-127>127</a>
</span><span class=lnt id=hl-423-128><a class=lnlinks href=#hl-423-128>128</a>
</span><span class=lnt id=hl-423-129><a class=lnlinks href=#hl-423-129>129</a>
</span><span class=lnt id=hl-423-130><a class=lnlinks href=#hl-423-130>130</a>
</span><span class=lnt id=hl-423-131><a class=lnlinks href=#hl-423-131>131</a>
</span><span class=lnt id=hl-423-132><a class=lnlinks href=#hl-423-132>132</a>
</span><span class=lnt id=hl-423-133><a class=lnlinks href=#hl-423-133>133</a>
</span><span class=lnt id=hl-423-134><a class=lnlinks href=#hl-423-134>134</a>
</span><span class=lnt id=hl-423-135><a class=lnlinks href=#hl-423-135>135</a>
</span><span class=lnt id=hl-423-136><a class=lnlinks href=#hl-423-136>136</a>
</span><span class=lnt id=hl-423-137><a class=lnlinks href=#hl-423-137>137</a>
</span><span class=lnt id=hl-423-138><a class=lnlinks href=#hl-423-138>138</a>
</span><span class=lnt id=hl-423-139><a class=lnlinks href=#hl-423-139>139</a>
</span><span class=lnt id=hl-423-140><a class=lnlinks href=#hl-423-140>140</a>
</span><span class=lnt id=hl-423-141><a class=lnlinks href=#hl-423-141>141</a>
</span><span class=lnt id=hl-423-142><a class=lnlinks href=#hl-423-142>142</a>
</span><span class=lnt id=hl-423-143><a class=lnlinks href=#hl-423-143>143</a>
</span><span class=lnt id=hl-423-144><a class=lnlinks href=#hl-423-144>144</a>
</span><span class=lnt id=hl-423-145><a class=lnlinks href=#hl-423-145>145</a>
</span><span class=lnt id=hl-423-146><a class=lnlinks href=#hl-423-146>146</a>
</span><span class=lnt id=hl-423-147><a class=lnlinks href=#hl-423-147>147</a>
</span><span class=lnt id=hl-423-148><a class=lnlinks href=#hl-423-148>148</a>
</span><span class=lnt id=hl-423-149><a class=lnlinks href=#hl-423-149>149</a>
</span><span class=lnt id=hl-423-150><a class=lnlinks href=#hl-423-150>150</a>
</span><span class=lnt id=hl-423-151><a class=lnlinks href=#hl-423-151>151</a>
</span><span class=lnt id=hl-423-152><a class=lnlinks href=#hl-423-152>152</a>
</span><span class=lnt id=hl-423-153><a class=lnlinks href=#hl-423-153>153</a>
</span><span class=lnt id=hl-423-154><a class=lnlinks href=#hl-423-154>154</a>
</span><span class=lnt id=hl-423-155><a class=lnlinks href=#hl-423-155>155</a>
</span><span class=lnt id=hl-423-156><a class=lnlinks href=#hl-423-156>156</a>
</span><span class=lnt id=hl-423-157><a class=lnlinks href=#hl-423-157>157</a>
</span><span class=lnt id=hl-423-158><a class=lnlinks href=#hl-423-158>158</a>
</span><span class=lnt id=hl-423-159><a class=lnlinks href=#hl-423-159>159</a>
</span><span class=lnt id=hl-423-160><a class=lnlinks href=#hl-423-160>160</a>
</span><span class=lnt id=hl-423-161><a class=lnlinks href=#hl-423-161>161</a>
</span><span class=lnt id=hl-423-162><a class=lnlinks href=#hl-423-162>162</a>
</span><span class=lnt id=hl-423-163><a class=lnlinks href=#hl-423-163>163</a>
</span><span class=lnt id=hl-423-164><a class=lnlinks href=#hl-423-164>164</a>
</span><span class=lnt id=hl-423-165><a class=lnlinks href=#hl-423-165>165</a>
</span><span class=lnt id=hl-423-166><a class=lnlinks href=#hl-423-166>166</a>
</span><span class=lnt id=hl-423-167><a class=lnlinks href=#hl-423-167>167</a>
</span><span class=lnt id=hl-423-168><a class=lnlinks href=#hl-423-168>168</a>
</span><span class=lnt id=hl-423-169><a class=lnlinks href=#hl-423-169>169</a>
</span><span class=lnt id=hl-423-170><a class=lnlinks href=#hl-423-170>170</a>
</span><span class=lnt id=hl-423-171><a class=lnlinks href=#hl-423-171>171</a>
</span><span class=lnt id=hl-423-172><a class=lnlinks href=#hl-423-172>172</a>
</span><span class=lnt id=hl-423-173><a class=lnlinks href=#hl-423-173>173</a>
</span><span class=lnt id=hl-423-174><a class=lnlinks href=#hl-423-174>174</a>
</span><span class=lnt id=hl-423-175><a class=lnlinks href=#hl-423-175>175</a>
</span><span class=lnt id=hl-423-176><a class=lnlinks href=#hl-423-176>176</a>
</span><span class=lnt id=hl-423-177><a class=lnlinks href=#hl-423-177>177</a>
</span><span class=lnt id=hl-423-178><a class=lnlinks href=#hl-423-178>178</a>
</span><span class=lnt id=hl-423-179><a class=lnlinks href=#hl-423-179>179</a>
</span><span class=lnt id=hl-423-180><a class=lnlinks href=#hl-423-180>180</a>
</span><span class=lnt id=hl-423-181><a class=lnlinks href=#hl-423-181>181</a>
</span><span class=lnt id=hl-423-182><a class=lnlinks href=#hl-423-182>182</a>
</span><span class=lnt id=hl-423-183><a class=lnlinks href=#hl-423-183>183</a>
</span><span class=lnt id=hl-423-184><a class=lnlinks href=#hl-423-184>184</a>
</span><span class=lnt id=hl-423-185><a class=lnlinks href=#hl-423-185>185</a>
</span><span class=lnt id=hl-423-186><a class=lnlinks href=#hl-423-186>186</a>
</span><span class=lnt id=hl-423-187><a class=lnlinks href=#hl-423-187>187</a>
</span><span class=lnt id=hl-423-188><a class=lnlinks href=#hl-423-188>188</a>
</span><span class=lnt id=hl-423-189><a class=lnlinks href=#hl-423-189>189</a>
</span><span class=lnt id=hl-423-190><a class=lnlinks href=#hl-423-190>190</a>
</span><span class=lnt id=hl-423-191><a class=lnlinks href=#hl-423-191>191</a>
</span><span class=lnt id=hl-423-192><a class=lnlinks href=#hl-423-192>192</a>
</span><span class=lnt id=hl-423-193><a class=lnlinks href=#hl-423-193>193</a>
</span><span class=lnt id=hl-423-194><a class=lnlinks href=#hl-423-194>194</a>
</span><span class=lnt id=hl-423-195><a class=lnlinks href=#hl-423-195>195</a>
</span><span class=lnt id=hl-423-196><a class=lnlinks href=#hl-423-196>196</a>
</span><span class=lnt id=hl-423-197><a class=lnlinks href=#hl-423-197>197</a>
</span><span class=lnt id=hl-423-198><a class=lnlinks href=#hl-423-198>198</a>
</span><span class=lnt id=hl-423-199><a class=lnlinks href=#hl-423-199>199</a>
</span><span class=lnt id=hl-423-200><a class=lnlinks href=#hl-423-200>200</a>
</span><span class=lnt id=hl-423-201><a class=lnlinks href=#hl-423-201>201</a>
</span><span class=lnt id=hl-423-202><a class=lnlinks href=#hl-423-202>202</a>
</span><span class=lnt id=hl-423-203><a class=lnlinks href=#hl-423-203>203</a>
</span><span class=lnt id=hl-423-204><a class=lnlinks href=#hl-423-204>204</a>
</span><span class=lnt id=hl-423-205><a class=lnlinks href=#hl-423-205>205</a>
</span><span class=lnt id=hl-423-206><a class=lnlinks href=#hl-423-206>206</a>
</span><span class=lnt id=hl-423-207><a class=lnlinks href=#hl-423-207>207</a>
</span><span class=lnt id=hl-423-208><a class=lnlinks href=#hl-423-208>208</a>
</span><span class=lnt id=hl-423-209><a class=lnlinks href=#hl-423-209>209</a>
</span><span class=lnt id=hl-423-210><a class=lnlinks href=#hl-423-210>210</a>
</span><span class=lnt id=hl-423-211><a class=lnlinks href=#hl-423-211>211</a>
</span><span class=lnt id=hl-423-212><a class=lnlinks href=#hl-423-212>212</a>
</span><span class=lnt id=hl-423-213><a class=lnlinks href=#hl-423-213>213</a>
</span><span class=lnt id=hl-423-214><a class=lnlinks href=#hl-423-214>214</a>
</span><span class=lnt id=hl-423-215><a class=lnlinks href=#hl-423-215>215</a>
</span><span class=lnt id=hl-423-216><a class=lnlinks href=#hl-423-216>216</a>
</span><span class=lnt id=hl-423-217><a class=lnlinks href=#hl-423-217>217</a>
</span><span class=lnt id=hl-423-218><a class=lnlinks href=#hl-423-218>218</a>
</span><span class=lnt id=hl-423-219><a class=lnlinks href=#hl-423-219>219</a>
</span><span class=lnt id=hl-423-220><a class=lnlinks href=#hl-423-220>220</a>
</span><span class=lnt id=hl-423-221><a class=lnlinks href=#hl-423-221>221</a>
</span><span class=lnt id=hl-423-222><a class=lnlinks href=#hl-423-222>222</a>
</span><span class=lnt id=hl-423-223><a class=lnlinks href=#hl-423-223>223</a>
</span><span class=lnt id=hl-423-224><a class=lnlinks href=#hl-423-224>224</a>
</span><span class=lnt id=hl-423-225><a class=lnlinks href=#hl-423-225>225</a>
</span><span class=lnt id=hl-423-226><a class=lnlinks href=#hl-423-226>226</a>
</span><span class=lnt id=hl-423-227><a class=lnlinks href=#hl-423-227>227</a>
</span><span class=lnt id=hl-423-228><a class=lnlinks href=#hl-423-228>228</a>
</span><span class=lnt id=hl-423-229><a class=lnlinks href=#hl-423-229>229</a>
</span><span class=lnt id=hl-423-230><a class=lnlinks href=#hl-423-230>230</a>
</span><span class=lnt id=hl-423-231><a class=lnlinks href=#hl-423-231>231</a>
</span><span class=lnt id=hl-423-232><a class=lnlinks href=#hl-423-232>232</a>
</span><span class=lnt id=hl-423-233><a class=lnlinks href=#hl-423-233>233</a>
</span><span class=lnt id=hl-423-234><a class=lnlinks href=#hl-423-234>234</a>
</span><span class=lnt id=hl-423-235><a class=lnlinks href=#hl-423-235>235</a>
</span><span class=lnt id=hl-423-236><a class=lnlinks href=#hl-423-236>236</a>
</span><span class=lnt id=hl-423-237><a class=lnlinks href=#hl-423-237>237</a>
</span><span class=lnt id=hl-423-238><a class=lnlinks href=#hl-423-238>238</a>
</span><span class=lnt id=hl-423-239><a class=lnlinks href=#hl-423-239>239</a>
</span><span class=lnt id=hl-423-240><a class=lnlinks href=#hl-423-240>240</a>
</span><span class=lnt id=hl-423-241><a class=lnlinks href=#hl-423-241>241</a>
</span><span class=lnt id=hl-423-242><a class=lnlinks href=#hl-423-242>242</a>
</span><span class=lnt id=hl-423-243><a class=lnlinks href=#hl-423-243>243</a>
</span><span class=lnt id=hl-423-244><a class=lnlinks href=#hl-423-244>244</a>
</span><span class=lnt id=hl-423-245><a class=lnlinks href=#hl-423-245>245</a>
</span><span class=lnt id=hl-423-246><a class=lnlinks href=#hl-423-246>246</a>
</span><span class=lnt id=hl-423-247><a class=lnlinks href=#hl-423-247>247</a>
</span><span class=lnt id=hl-423-248><a class=lnlinks href=#hl-423-248>248</a>
</span><span class=lnt id=hl-423-249><a class=lnlinks href=#hl-423-249>249</a>
</span><span class=lnt id=hl-423-250><a class=lnlinks href=#hl-423-250>250</a>
</span><span class=lnt id=hl-423-251><a class=lnlinks href=#hl-423-251>251</a>
</span><span class=lnt id=hl-423-252><a class=lnlinks href=#hl-423-252>252</a>
</span><span class=lnt id=hl-423-253><a class=lnlinks href=#hl-423-253>253</a>
</span><span class=lnt id=hl-423-254><a class=lnlinks href=#hl-423-254>254</a>
</span><span class=lnt id=hl-423-255><a class=lnlinks href=#hl-423-255>255</a>
</span><span class=lnt id=hl-423-256><a class=lnlinks href=#hl-423-256>256</a>
</span><span class=lnt id=hl-423-257><a class=lnlinks href=#hl-423-257>257</a>
</span><span class=lnt id=hl-423-258><a class=lnlinks href=#hl-423-258>258</a>
</span><span class=lnt id=hl-423-259><a class=lnlinks href=#hl-423-259>259</a>
</span><span class=lnt id=hl-423-260><a class=lnlinks href=#hl-423-260>260</a>
</span><span class=lnt id=hl-423-261><a class=lnlinks href=#hl-423-261>261</a>
</span><span class=lnt id=hl-423-262><a class=lnlinks href=#hl-423-262>262</a>
</span><span class=lnt id=hl-423-263><a class=lnlinks href=#hl-423-263>263</a>
</span><span class=lnt id=hl-423-264><a class=lnlinks href=#hl-423-264>264</a>
</span><span class=lnt id=hl-423-265><a class=lnlinks href=#hl-423-265>265</a>
</span><span class=lnt id=hl-423-266><a class=lnlinks href=#hl-423-266>266</a>
</span><span class=lnt id=hl-423-267><a class=lnlinks href=#hl-423-267>267</a>
</span><span class=lnt id=hl-423-268><a class=lnlinks href=#hl-423-268>268</a>
</span><span class=lnt id=hl-423-269><a class=lnlinks href=#hl-423-269>269</a>
</span><span class=lnt id=hl-423-270><a class=lnlinks href=#hl-423-270>270</a>
</span><span class=lnt id=hl-423-271><a class=lnlinks href=#hl-423-271>271</a>
</span><span class=lnt id=hl-423-272><a class=lnlinks href=#hl-423-272>272</a>
</span><span class=lnt id=hl-423-273><a class=lnlinks href=#hl-423-273>273</a>
</span><span class=lnt id=hl-423-274><a class=lnlinks href=#hl-423-274>274</a>
</span><span class=lnt id=hl-423-275><a class=lnlinks href=#hl-423-275>275</a>
</span><span class=lnt id=hl-423-276><a class=lnlinks href=#hl-423-276>276</a>
</span><span class=lnt id=hl-423-277><a class=lnlinks href=#hl-423-277>277</a>
</span><span class=lnt id=hl-423-278><a class=lnlinks href=#hl-423-278>278</a>
</span><span class=lnt id=hl-423-279><a class=lnlinks href=#hl-423-279>279</a>
</span><span class=lnt id=hl-423-280><a class=lnlinks href=#hl-423-280>280</a>
</span><span class=lnt id=hl-423-281><a class=lnlinks href=#hl-423-281>281</a>
</span><span class=lnt id=hl-423-282><a class=lnlinks href=#hl-423-282>282</a>
</span><span class=lnt id=hl-423-283><a class=lnlinks href=#hl-423-283>283</a>
</span><span class=lnt id=hl-423-284><a class=lnlinks href=#hl-423-284>284</a>
</span><span class=lnt id=hl-423-285><a class=lnlinks href=#hl-423-285>285</a>
</span><span class=lnt id=hl-423-286><a class=lnlinks href=#hl-423-286>286</a>
</span><span class=lnt id=hl-423-287><a class=lnlinks href=#hl-423-287>287</a>
</span><span class=lnt id=hl-423-288><a class=lnlinks href=#hl-423-288>288</a>
</span><span class=lnt id=hl-423-289><a class=lnlinks href=#hl-423-289>289</a>
</span><span class=lnt id=hl-423-290><a class=lnlinks href=#hl-423-290>290</a>
</span><span class=lnt id=hl-423-291><a class=lnlinks href=#hl-423-291>291</a>
</span><span class=lnt id=hl-423-292><a class=lnlinks href=#hl-423-292>292</a>
</span><span class=lnt id=hl-423-293><a class=lnlinks href=#hl-423-293>293</a>
</span><span class=lnt id=hl-423-294><a class=lnlinks href=#hl-423-294>294</a>
</span><span class=lnt id=hl-423-295><a class=lnlinks href=#hl-423-295>295</a>
</span><span class=lnt id=hl-423-296><a class=lnlinks href=#hl-423-296>296</a>
</span><span class=lnt id=hl-423-297><a class=lnlinks href=#hl-423-297>297</a>
</span><span class=lnt id=hl-423-298><a class=lnlinks href=#hl-423-298>298</a>
</span><span class=lnt id=hl-423-299><a class=lnlinks href=#hl-423-299>299</a>
</span><span class=lnt id=hl-423-300><a class=lnlinks href=#hl-423-300>300</a>
</span><span class=lnt id=hl-423-301><a class=lnlinks href=#hl-423-301>301</a>
</span><span class=lnt id=hl-423-302><a class=lnlinks href=#hl-423-302>302</a>
</span><span class=lnt id=hl-423-303><a class=lnlinks href=#hl-423-303>303</a>
</span><span class=lnt id=hl-423-304><a class=lnlinks href=#hl-423-304>304</a>
</span><span class=lnt id=hl-423-305><a class=lnlinks href=#hl-423-305>305</a>
</span><span class=lnt id=hl-423-306><a class=lnlinks href=#hl-423-306>306</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ConditionObject</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Condition</span><span class=p>,</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1173984872572414699L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 第一个等待节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>transient</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 最后一个等待节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>transient</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>lastWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ConditionObject</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈠ 添加一个 Node 至等待队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=nf>addConditionWaiter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 所有已取消的 Node 从队列链表删除, 见 ㈡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unlinkCancelledWaiters</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 创建一个关联当前线程的新 Node, 添加至队列尾部</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>(),</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>firstWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lastWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 唤醒 - 将没取消的第一个节点转移至 AQS 队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doSignal</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 已经是尾节点了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=n>firstWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lastWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 将等待队列中的 Node 转移至 AQS 队列, 不成功且还有节点则继续循环 ㈢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>transferForSignal</span><span class=p>(</span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 队列还有节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 外部类方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈢ 如果节点状态是取消, 返回 false 表示转移失败, 否则转移成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>transferForSignal</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果状态已经不是 Node.CONDITION, 说明被取消了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 加入 AQS 队列尾部</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>enq</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 上一个节点被取消</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ws</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 上一个节点不能设置状态为 Node.SIGNAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>ws</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// unpark 取消阻塞, 让线程重新同步状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>thread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 全部唤醒 - 等待队列的所有节点转移至 AQS 队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doSignalAll</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lastWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>transferForSignal</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlinkCancelledWaiters</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 唤醒 - 必须持有锁才能唤醒, 因此 doSignal 内无需考虑加锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>signal</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHeldExclusively</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doSignal</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 全部唤醒 - 必须持有锁才能唤醒, 因此 doSignalAll 内无需考虑加锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>signalAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHeldExclusively</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doSignalAll</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 不可打断等待 - 直到被唤醒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>awaitUninterruptibly</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 添加一个 Node 至等待队列, 见 ㈠</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addConditionWaiter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 释放节点持有的锁, 见 ㈣</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullyRelease</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果该节点还没有转移至 AQS 队列, 阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnSyncQueue</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// park 阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果被打断, 仅设置打断状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 唤醒后, 尝试竞争锁, 如果失败进入 AQS 队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>savedState</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>interrupted</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doSignalAll</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lastWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>transferForSignal</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlinkCancelledWaiters</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 唤醒 - 必须持有锁才能唤醒, 因此 doSignal 内无需考虑加锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>signal</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHeldExclusively</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doSignal</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 全部唤醒 - 必须持有锁才能唤醒, 因此 doSignalAll 内无需考虑加锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>signalAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHeldExclusively</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doSignalAll</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 不可打断等待 - 直到被唤醒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>awaitUninterruptibly</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 添加一个 Node 至等待队列, 见 ㈠</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addConditionWaiter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 释放节点持有的锁, 见 ㈣</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullyRelease</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果该节点还没有转移至 AQS 队列, 阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnSyncQueue</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// park 阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果被打断, 仅设置打断状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 唤醒后, 尝试竞争锁, 如果失败进入 AQS 队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>savedState</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>interrupted</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 外部类方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈣ 因为某线程可能重入，需要将 state 全部释放</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>fullyRelease</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>release</span><span class=p>(</span><span class=n>savedState</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>savedState</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>node</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CANCELLED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 打断模式 - 在退出等待时重新设置打断状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 打断模式 - 在退出等待时抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>THROW_IE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 判断打断模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>checkInterruptWhileWaiting</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>transferAfterCancelledWait</span><span class=p>(</span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>THROW_IE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈤ 应用打断模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>reportInterruptAfterWait</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>interruptMode</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interruptMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>THROW_IE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interruptMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 等待 - 直到被唤醒或打断</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>await</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 添加一个 Node 至等待队列, 见 ㈠</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addConditionWaiter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 释放节点持有的锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullyRelease</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果该节点还没有转移至 AQS 队列, 阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnSyncQueue</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// park 阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果被打断, 退出等待队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>checkInterruptWhileWaiting</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 退出等待队列后, 还需要获得 AQS 队列的锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>savedState</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>interruptMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>THROW_IE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 所有已取消的 Node 从队列链表删除, 见 ㈡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unlinkCancelledWaiters</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 应用打断模式, 见 ㈤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interruptMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>reportInterruptAfterWait</span><span class=p>(</span><span class=n>interruptMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//向Condition中的等待队列中新增节点，并将此节点返回</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=nf>addConditionWaiter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If lastWaiter is cancelled, clean out.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unlinkCancelledWaiters</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>(),</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>firstWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lastWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//判断当前节点是否在同步器中的队列中等待锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isOnSyncQueue</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=c1>// If has successor, it must be on queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>         * node.prev can be non-null, but not yet on queue because
</span></span></span><span class=line><span class=cl><span class=cm>         * the CAS to place it on queue can fail. So we have to
</span></span></span><span class=line><span class=cl><span class=cm>         * traverse from tail to make sure it actually made it.  It
</span></span></span><span class=line><span class=cl><span class=cm>         * will always be near the tail in calls to this method, and
</span></span></span><span class=line><span class=cl><span class=cm>         * unless the CAS failed (which is unlikely), it will be
</span></span></span><span class=line><span class=cl><span class=cm>         * there, so we hardly ever traverse much.
</span></span></span><span class=line><span class=cl><span class=cm>         */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>findNodeFromTail</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 等待 - 直到被唤醒或打断或超时</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>awaitNanos</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>nanosTimeout</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 添加一个 Node 至等待队列, 见 ㈠</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addConditionWaiter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 释放节点持有的锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullyRelease</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获得最后期限</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>deadline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>nanosTimeout</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果该节点还没有转移至 AQS 队列, 阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnSyncQueue</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 已超时, 退出等待队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nanosTimeout</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0L</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>transferAfterCancelledWait</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// park 阻塞一定时间, spinForTimeoutThreshold 为 1000 ns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nanosTimeout</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>spinForTimeoutThreshold</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>parkNanos</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>nanosTimeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果被打断, 退出等待队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>checkInterruptWhileWaiting</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>nanosTimeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>deadline</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 退出等待队列后, 还需要获得 AQS 队列的锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>savedState</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>interruptMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>THROW_IE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 所有已取消的 Node 从队列链表删除, 见 ㈡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unlinkCancelledWaiters</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 应用打断模式, 见 ㈤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interruptMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>reportInterruptAfterWait</span><span class=p>(</span><span class=n>interruptMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>deadline</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 等待 - 直到被唤醒或打断或超时, 逻辑类似于 awaitNanos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>awaitUntil</span><span class=p>(</span><span class=n>Date</span><span class=w> </span><span class=n>deadline</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 等待 - 直到被唤醒或打断或超时, 逻辑类似于 awaitNanos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>await</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 工具方法 省略 ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=读写锁><a href=#%e8%af%bb%e5%86%99%e9%94%81 class=header-anchor>#</a>
读写锁</h2><h3 id=reentrantreadwritelock><a href=#reentrantreadwritelock class=header-anchor>#</a>
ReentrantReadWriteLock</h3><p>当读操作远远高于写操作时，这时候使用<code>读写锁</code>让<code>读-读</code>可以并发，提高性能。 类似于数据库中的<code>select ... from ... lock in share mode</code></p><p>提供一个<code>数据容器类</code>内部分别使用读锁保护数据的 read() 方法，写锁保护数据的 write() 方法</p><p>测试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-424-1><a class=lnlinks href=#hl-424-1> 1</a>
</span><span class=lnt id=hl-424-2><a class=lnlinks href=#hl-424-2> 2</a>
</span><span class=lnt id=hl-424-3><a class=lnlinks href=#hl-424-3> 3</a>
</span><span class=lnt id=hl-424-4><a class=lnlinks href=#hl-424-4> 4</a>
</span><span class=lnt id=hl-424-5><a class=lnlinks href=#hl-424-5> 5</a>
</span><span class=lnt id=hl-424-6><a class=lnlinks href=#hl-424-6> 6</a>
</span><span class=lnt id=hl-424-7><a class=lnlinks href=#hl-424-7> 7</a>
</span><span class=lnt id=hl-424-8><a class=lnlinks href=#hl-424-8> 8</a>
</span><span class=lnt id=hl-424-9><a class=lnlinks href=#hl-424-9> 9</a>
</span><span class=lnt id=hl-424-10><a class=lnlinks href=#hl-424-10>10</a>
</span><span class=lnt id=hl-424-11><a class=lnlinks href=#hl-424-11>11</a>
</span><span class=lnt id=hl-424-12><a class=lnlinks href=#hl-424-12>12</a>
</span><span class=lnt id=hl-424-13><a class=lnlinks href=#hl-424-13>13</a>
</span><span class=lnt id=hl-424-14><a class=lnlinks href=#hl-424-14>14</a>
</span><span class=lnt id=hl-424-15><a class=lnlinks href=#hl-424-15>15</a>
</span><span class=lnt id=hl-424-16><a class=lnlinks href=#hl-424-16>16</a>
</span><span class=lnt id=hl-424-17><a class=lnlinks href=#hl-424-17>17</a>
</span><span class=lnt id=hl-424-18><a class=lnlinks href=#hl-424-18>18</a>
</span><span class=lnt id=hl-424-19><a class=lnlinks href=#hl-424-19>19</a>
</span><span class=lnt id=hl-424-20><a class=lnlinks href=#hl-424-20>20</a>
</span><span class=lnt id=hl-424-21><a class=lnlinks href=#hl-424-21>21</a>
</span><span class=lnt id=hl-424-22><a class=lnlinks href=#hl-424-22>22</a>
</span><span class=lnt id=hl-424-23><a class=lnlinks href=#hl-424-23>23</a>
</span><span class=lnt id=hl-424-24><a class=lnlinks href=#hl-424-24>24</a>
</span><span class=lnt id=hl-424-25><a class=lnlinks href=#hl-424-25>25</a>
</span><span class=lnt id=hl-424-26><a class=lnlinks href=#hl-424-26>26</a>
</span><span class=lnt id=hl-424-27><a class=lnlinks href=#hl-424-27>27</a>
</span><span class=lnt id=hl-424-28><a class=lnlinks href=#hl-424-28>28</a>
</span><span class=lnt id=hl-424-29><a class=lnlinks href=#hl-424-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DataContainer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=w> </span><span class=n>rw</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>.</span><span class=na>ReadLock</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rw</span><span class=p>.</span><span class=na>readLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>.</span><span class=na>WriteLock</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rw</span><span class=p>.</span><span class=na>writeLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>read</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获取读锁...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;读取&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;释放读锁...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>write</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;获取写锁...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>w</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;写入&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;释放写锁...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>w</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试<code>读锁-读锁</code>可以并发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-425-1><a class=lnlinks href=#hl-425-1>1</a>
</span><span class=lnt id=hl-425-2><a class=lnlinks href=#hl-425-2>2</a>
</span><span class=lnt id=hl-425-3><a class=lnlinks href=#hl-425-3>3</a>
</span><span class=lnt id=hl-425-4><a class=lnlinks href=#hl-425-4>4</a>
</span><span class=lnt id=hl-425-5><a class=lnlinks href=#hl-425-5>5</a>
</span><span class=lnt id=hl-425-6><a class=lnlinks href=#hl-425-6>6</a>
</span><span class=lnt id=hl-425-7><a class=lnlinks href=#hl-425-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DataContainer</span><span class=w> </span><span class=n>dataContainer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataContainer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出结果，从这里可以看到 Thread-0 锁定期间，Thread-1 的读操作不受影响</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-426-1><a class=lnlinks href=#hl-426-1>1</a>
</span><span class=lnt id=hl-426-2><a class=lnlinks href=#hl-426-2>2</a>
</span><span class=lnt id=hl-426-3><a class=lnlinks href=#hl-426-3>3</a>
</span><span class=lnt id=hl-426-4><a class=lnlinks href=#hl-426-4>4</a>
</span><span class=lnt id=hl-426-5><a class=lnlinks href=#hl-426-5>5</a>
</span><span class=lnt id=hl-426-6><a class=lnlinks href=#hl-426-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>14:05:14.341 c.DataContainer <span class=o>[</span>t2<span class=o>]</span> - 获取读锁... 
</span></span><span class=line><span class=cl>14:05:14.341 c.DataContainer <span class=o>[</span>t1<span class=o>]</span> - 获取读锁... 
</span></span><span class=line><span class=cl>14:05:14.345 c.DataContainer <span class=o>[</span>t1<span class=o>]</span> - 读取
</span></span><span class=line><span class=cl>14:05:14.345 c.DataContainer <span class=o>[</span>t2<span class=o>]</span> - 读取
</span></span><span class=line><span class=cl>14:05:15.365 c.DataContainer <span class=o>[</span>t2<span class=o>]</span> - 释放读锁... 
</span></span><span class=line><span class=cl>14:05:15.386 c.DataContainer <span class=o>[</span>t1<span class=o>]</span> - 释放读锁... 
</span></span></code></pre></td></tr></table></div></div><p>测试<code>读锁-写锁</code>相互阻塞</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-427-1><a class=lnlinks href=#hl-427-1>1</a>
</span><span class=lnt id=hl-427-2><a class=lnlinks href=#hl-427-2>2</a>
</span><span class=lnt id=hl-427-3><a class=lnlinks href=#hl-427-3>3</a>
</span><span class=lnt id=hl-427-4><a class=lnlinks href=#hl-427-4>4</a>
</span><span class=lnt id=hl-427-5><a class=lnlinks href=#hl-427-5>5</a>
</span><span class=lnt id=hl-427-6><a class=lnlinks href=#hl-427-6>6</a>
</span><span class=lnt id=hl-427-7><a class=lnlinks href=#hl-427-7>7</a>
</span><span class=lnt id=hl-427-8><a class=lnlinks href=#hl-427-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DataContainer</span><span class=w> </span><span class=n>dataContainer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataContainer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>write</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-428-1><a class=lnlinks href=#hl-428-1>1</a>
</span><span class=lnt id=hl-428-2><a class=lnlinks href=#hl-428-2>2</a>
</span><span class=lnt id=hl-428-3><a class=lnlinks href=#hl-428-3>3</a>
</span><span class=lnt id=hl-428-4><a class=lnlinks href=#hl-428-4>4</a>
</span><span class=lnt id=hl-428-5><a class=lnlinks href=#hl-428-5>5</a>
</span><span class=lnt id=hl-428-6><a class=lnlinks href=#hl-428-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>21</span><span class=p>.</span><span class=na>838</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>获取读锁</span><span class=p>...</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>21</span><span class=p>.</span><span class=na>838</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t2</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>获取写锁</span><span class=p>...</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>21</span><span class=p>.</span><span class=na>841</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t2</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>写入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>22</span><span class=p>.</span><span class=na>843</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t2</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>释放写锁</span><span class=p>...</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>22</span><span class=p>.</span><span class=na>843</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>读取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>23</span><span class=p>.</span><span class=na>843</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>释放读锁</span><span class=p>...</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p><code>写锁-写锁</code>也是相互阻塞的，这里就不测试了</p><p><strong>注意事项</strong></p><ul><li>读锁不支持条件变量</li><li>重入时升级不支持：即持有读锁的情况下去获取写锁，会导致获取写锁永久等待</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-429-1><a class=lnlinks href=#hl-429-1> 1</a>
</span><span class=lnt id=hl-429-2><a class=lnlinks href=#hl-429-2> 2</a>
</span><span class=lnt id=hl-429-3><a class=lnlinks href=#hl-429-3> 3</a>
</span><span class=lnt id=hl-429-4><a class=lnlinks href=#hl-429-4> 4</a>
</span><span class=lnt id=hl-429-5><a class=lnlinks href=#hl-429-5> 5</a>
</span><span class=lnt id=hl-429-6><a class=lnlinks href=#hl-429-6> 6</a>
</span><span class=lnt id=hl-429-7><a class=lnlinks href=#hl-429-7> 7</a>
</span><span class=lnt id=hl-429-8><a class=lnlinks href=#hl-429-8> 8</a>
</span><span class=lnt id=hl-429-9><a class=lnlinks href=#hl-429-9> 9</a>
</span><span class=lnt id=hl-429-10><a class=lnlinks href=#hl-429-10>10</a>
</span><span class=lnt id=hl-429-11><a class=lnlinks href=#hl-429-11>11</a>
</span><span class=lnt id=hl-429-12><a class=lnlinks href=#hl-429-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>r</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>w</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>w</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>r</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>重入时降级支持：即持有写锁的情况下去获取读锁</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-430-1><a class=lnlinks href=#hl-430-1> 1</a>
</span><span class=lnt id=hl-430-2><a class=lnlinks href=#hl-430-2> 2</a>
</span><span class=lnt id=hl-430-3><a class=lnlinks href=#hl-430-3> 3</a>
</span><span class=lnt id=hl-430-4><a class=lnlinks href=#hl-430-4> 4</a>
</span><span class=lnt id=hl-430-5><a class=lnlinks href=#hl-430-5> 5</a>
</span><span class=lnt id=hl-430-6><a class=lnlinks href=#hl-430-6> 6</a>
</span><span class=lnt id=hl-430-7><a class=lnlinks href=#hl-430-7> 7</a>
</span><span class=lnt id=hl-430-8><a class=lnlinks href=#hl-430-8> 8</a>
</span><span class=lnt id=hl-430-9><a class=lnlinks href=#hl-430-9> 9</a>
</span><span class=lnt id=hl-430-10><a class=lnlinks href=#hl-430-10>10</a>
</span><span class=lnt id=hl-430-11><a class=lnlinks href=#hl-430-11>11</a>
</span><span class=lnt id=hl-430-12><a class=lnlinks href=#hl-430-12>12</a>
</span><span class=lnt id=hl-430-13><a class=lnlinks href=#hl-430-13>13</a>
</span><span class=lnt id=hl-430-14><a class=lnlinks href=#hl-430-14>14</a>
</span><span class=lnt id=hl-430-15><a class=lnlinks href=#hl-430-15>15</a>
</span><span class=lnt id=hl-430-16><a class=lnlinks href=#hl-430-16>16</a>
</span><span class=lnt id=hl-430-17><a class=lnlinks href=#hl-430-17>17</a>
</span><span class=lnt id=hl-430-18><a class=lnlinks href=#hl-430-18>18</a>
</span><span class=lnt id=hl-430-19><a class=lnlinks href=#hl-430-19>19</a>
</span><span class=lnt id=hl-430-20><a class=lnlinks href=#hl-430-20>20</a>
</span><span class=lnt id=hl-430-21><a class=lnlinks href=#hl-430-21>21</a>
</span><span class=lnt id=hl-430-22><a class=lnlinks href=#hl-430-22>22</a>
</span><span class=lnt id=hl-430-23><a class=lnlinks href=#hl-430-23>23</a>
</span><span class=lnt id=hl-430-24><a class=lnlinks href=#hl-430-24>24</a>
</span><span class=lnt id=hl-430-25><a class=lnlinks href=#hl-430-25>25</a>
</span><span class=lnt id=hl-430-26><a class=lnlinks href=#hl-430-26>26</a>
</span><span class=lnt id=hl-430-27><a class=lnlinks href=#hl-430-27>27</a>
</span><span class=lnt id=hl-430-28><a class=lnlinks href=#hl-430-28>28</a>
</span><span class=lnt id=hl-430-29><a class=lnlinks href=#hl-430-29>29</a>
</span><span class=lnt id=hl-430-30><a class=lnlinks href=#hl-430-30>30</a>
</span><span class=lnt id=hl-430-31><a class=lnlinks href=#hl-430-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>CachedData</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否有效，如果失效，需要重新计算 data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>cacheValid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=w> </span><span class=n>rwl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>processCachedData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>rwl</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cacheValid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获取写锁前必须释放读锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rwl</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rwl</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 判断是否有其它线程已经获取了写锁、更新了缓存, 避免重复更新</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cacheValid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>cacheValid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 降级为读锁, 释放写锁, 这样能够让其它线程读取缓存</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>rwl</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>rwl</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 自己用完数据, 释放读锁 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>use</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rwl</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=font-colorgreen-应用之缓存font><a href=#font-colorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e7%bc%93%e5%ad%98font class=header-anchor>#</a>
<font color=green>* 应用之缓存</font></h3><h5 id=缓存更新策略><a href=#%e7%bc%93%e5%ad%98%e6%9b%b4%e6%96%b0%e7%ad%96%e7%95%a5 class=header-anchor>#</a>
缓存更新策略</h5><p>更新时，是先清缓存还是先更新数据库</p><p><strong>先清缓存</strong></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314184059810.png width=900 height=600 loading=lazy decoding=async alt=image-20220314184059810 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>先更新数据库</strong></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314184117264.png width=900 height=600 loading=lazy decoding=async alt=image-20220314184117264 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>补充一种情况，假设查询线程 A 查询数据时恰好缓存数据由于时间到期失效，或是第一次查询</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314184138172.png width=900 height=600 loading=lazy decoding=async alt=image-20220314184138172 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>这种情况的出现几率非常小，见 facebook 论文</p><h5 id=读写锁实现一致性缓存><a href=#%e8%af%bb%e5%86%99%e9%94%81%e5%ae%9e%e7%8e%b0%e4%b8%80%e8%87%b4%e6%80%a7%e7%bc%93%e5%ad%98 class=header-anchor>#</a>
读写锁实现一致性缓存</h5><p>使用读写锁实现一个简单的按需加载缓存</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-431-1><a class=lnlinks href=#hl-431-1> 1</a>
</span><span class=lnt id=hl-431-2><a class=lnlinks href=#hl-431-2> 2</a>
</span><span class=lnt id=hl-431-3><a class=lnlinks href=#hl-431-3> 3</a>
</span><span class=lnt id=hl-431-4><a class=lnlinks href=#hl-431-4> 4</a>
</span><span class=lnt id=hl-431-5><a class=lnlinks href=#hl-431-5> 5</a>
</span><span class=lnt id=hl-431-6><a class=lnlinks href=#hl-431-6> 6</a>
</span><span class=lnt id=hl-431-7><a class=lnlinks href=#hl-431-7> 7</a>
</span><span class=lnt id=hl-431-8><a class=lnlinks href=#hl-431-8> 8</a>
</span><span class=lnt id=hl-431-9><a class=lnlinks href=#hl-431-9> 9</a>
</span><span class=lnt id=hl-431-10><a class=lnlinks href=#hl-431-10>10</a>
</span><span class=lnt id=hl-431-11><a class=lnlinks href=#hl-431-11>11</a>
</span><span class=lnt id=hl-431-12><a class=lnlinks href=#hl-431-12>12</a>
</span><span class=lnt id=hl-431-13><a class=lnlinks href=#hl-431-13>13</a>
</span><span class=lnt id=hl-431-14><a class=lnlinks href=#hl-431-14>14</a>
</span><span class=lnt id=hl-431-15><a class=lnlinks href=#hl-431-15>15</a>
</span><span class=lnt id=hl-431-16><a class=lnlinks href=#hl-431-16>16</a>
</span><span class=lnt id=hl-431-17><a class=lnlinks href=#hl-431-17>17</a>
</span><span class=lnt id=hl-431-18><a class=lnlinks href=#hl-431-18>18</a>
</span><span class=lnt id=hl-431-19><a class=lnlinks href=#hl-431-19>19</a>
</span><span class=lnt id=hl-431-20><a class=lnlinks href=#hl-431-20>20</a>
</span><span class=lnt id=hl-431-21><a class=lnlinks href=#hl-431-21>21</a>
</span><span class=lnt id=hl-431-22><a class=lnlinks href=#hl-431-22>22</a>
</span><span class=lnt id=hl-431-23><a class=lnlinks href=#hl-431-23>23</a>
</span><span class=lnt id=hl-431-24><a class=lnlinks href=#hl-431-24>24</a>
</span><span class=lnt id=hl-431-25><a class=lnlinks href=#hl-431-25>25</a>
</span><span class=lnt id=hl-431-26><a class=lnlinks href=#hl-431-26>26</a>
</span><span class=lnt id=hl-431-27><a class=lnlinks href=#hl-431-27>27</a>
</span><span class=lnt id=hl-431-28><a class=lnlinks href=#hl-431-28>28</a>
</span><span class=lnt id=hl-431-29><a class=lnlinks href=#hl-431-29>29</a>
</span><span class=lnt id=hl-431-30><a class=lnlinks href=#hl-431-30>30</a>
</span><span class=lnt id=hl-431-31><a class=lnlinks href=#hl-431-31>31</a>
</span><span class=lnt id=hl-431-32><a class=lnlinks href=#hl-431-32>32</a>
</span><span class=lnt id=hl-431-33><a class=lnlinks href=#hl-431-33>33</a>
</span><span class=lnt id=hl-431-34><a class=lnlinks href=#hl-431-34>34</a>
</span><span class=lnt id=hl-431-35><a class=lnlinks href=#hl-431-35>35</a>
</span><span class=lnt id=hl-431-36><a class=lnlinks href=#hl-431-36>36</a>
</span><span class=lnt id=hl-431-37><a class=lnlinks href=#hl-431-37>37</a>
</span><span class=lnt id=hl-431-38><a class=lnlinks href=#hl-431-38>38</a>
</span><span class=lnt id=hl-431-39><a class=lnlinks href=#hl-431-39>39</a>
</span><span class=lnt id=hl-431-40><a class=lnlinks href=#hl-431-40>40</a>
</span><span class=lnt id=hl-431-41><a class=lnlinks href=#hl-431-41>41</a>
</span><span class=lnt id=hl-431-42><a class=lnlinks href=#hl-431-42>42</a>
</span><span class=lnt id=hl-431-43><a class=lnlinks href=#hl-431-43>43</a>
</span><span class=lnt id=hl-431-44><a class=lnlinks href=#hl-431-44>44</a>
</span><span class=lnt id=hl-431-45><a class=lnlinks href=#hl-431-45>45</a>
</span><span class=lnt id=hl-431-46><a class=lnlinks href=#hl-431-46>46</a>
</span><span class=lnt id=hl-431-47><a class=lnlinks href=#hl-431-47>47</a>
</span><span class=lnt id=hl-431-48><a class=lnlinks href=#hl-431-48>48</a>
</span><span class=lnt id=hl-431-49><a class=lnlinks href=#hl-431-49>49</a>
</span><span class=lnt id=hl-431-50><a class=lnlinks href=#hl-431-50>50</a>
</span><span class=lnt id=hl-431-51><a class=lnlinks href=#hl-431-51>51</a>
</span><span class=lnt id=hl-431-52><a class=lnlinks href=#hl-431-52>52</a>
</span><span class=lnt id=hl-431-53><a class=lnlinks href=#hl-431-53>53</a>
</span><span class=lnt id=hl-431-54><a class=lnlinks href=#hl-431-54>54</a>
</span><span class=lnt id=hl-431-55><a class=lnlinks href=#hl-431-55>55</a>
</span><span class=lnt id=hl-431-56><a class=lnlinks href=#hl-431-56>56</a>
</span><span class=lnt id=hl-431-57><a class=lnlinks href=#hl-431-57>57</a>
</span><span class=lnt id=hl-431-58><a class=lnlinks href=#hl-431-58>58</a>
</span><span class=lnt id=hl-431-59><a class=lnlinks href=#hl-431-59>59</a>
</span><span class=lnt id=hl-431-60><a class=lnlinks href=#hl-431-60>60</a>
</span><span class=lnt id=hl-431-61><a class=lnlinks href=#hl-431-61>61</a>
</span><span class=lnt id=hl-431-62><a class=lnlinks href=#hl-431-62>62</a>
</span><span class=lnt id=hl-431-63><a class=lnlinks href=#hl-431-63>63</a>
</span><span class=lnt id=hl-431-64><a class=lnlinks href=#hl-431-64>64</a>
</span><span class=lnt id=hl-431-65><a class=lnlinks href=#hl-431-65>65</a>
</span><span class=lnt id=hl-431-66><a class=lnlinks href=#hl-431-66>66</a>
</span><span class=lnt id=hl-431-67><a class=lnlinks href=#hl-431-67>67</a>
</span><span class=lnt id=hl-431-68><a class=lnlinks href=#hl-431-68>68</a>
</span><span class=lnt id=hl-431-69><a class=lnlinks href=#hl-431-69>69</a>
</span><span class=lnt id=hl-431-70><a class=lnlinks href=#hl-431-70>70</a>
</span><span class=lnt id=hl-431-71><a class=lnlinks href=#hl-431-71>71</a>
</span><span class=lnt id=hl-431-72><a class=lnlinks href=#hl-431-72>72</a>
</span><span class=lnt id=hl-431-73><a class=lnlinks href=#hl-431-73>73</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>GenericCachedDao</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// HashMap 作为缓存非线程安全, 需要保护</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>SqlPair</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ReentrantReadWriteLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GenericDao</span><span class=w> </span><span class=n>genericDao</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GenericDao</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>update</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SqlPair</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SqlPair</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 加写锁, 防止其它线程对缓存读取和更改</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>rows</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>genericDao</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>rows</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>queryOne</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>beanClass</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SqlPair</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SqlPair</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 加读锁, 防止其它线程对缓存更改</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 加写锁, 防止其它线程对缓存读取和更改</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// get 方法上面部分是可能多个线程进来的, 可能已经向缓存填充了数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 为防止重复查询数据库, 再次验证</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 如果没有, 查询数据库</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>genericDao</span><span class=p>.</span><span class=na>queryOne</span><span class=p>(</span><span class=n>beanClass</span><span class=p>,</span><span class=w> </span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 作为 key 保证其是不可变的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>class</span> <span class=nc>SqlPair</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>params</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>SqlPair</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>sql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>params</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>equals</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>getClass</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=na>getClass</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>SqlPair</span><span class=w> </span><span class=n>sqlPair</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>SqlPair</span><span class=p>)</span><span class=w> </span><span class=n>o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>sql</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>sqlPair</span><span class=p>.</span><span class=na>sql</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Arrays</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>params</span><span class=p>,</span><span class=w> </span><span class=n>sqlPair</span><span class=p>.</span><span class=na>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hashCode</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Objects</span><span class=p>.</span><span class=na>hash</span><span class=p>(</span><span class=n>sql</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>31</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>hashCode</span><span class=p>(</span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p><ul><li><p>以上实现体现的是读写锁的应用，保证缓存和数据库的一致性，但有下面的问题没有考虑</p><ul><li><p>适合读多写少，如果写操作比较频繁，以上实现性能低</p></li><li><p>没有考虑缓存容量</p></li><li><p>没有考虑缓存过期</p></li><li><p>只适合单机</p></li><li><p>并发性还是低，目前只会用一把锁</p></li><li><p>更新方法太过简单粗暴，清空了所有 key（考虑按类型分区或重新设计 key）</p></li></ul></li><li><p>乐观锁实现：用 CAS 去更新</p></li></ul></blockquote><h3 id=font-colorblue-读写锁原理font><a href=#font-colorblue-%e8%af%bb%e5%86%99%e9%94%81%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>* 读写锁原理</font></h3><h4 id=图解流程><a href=#%e5%9b%be%e8%a7%a3%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
图解流程</h4><p>读写锁用的是同一个 Sycn 同步器，因此等待队列、state 等也是同一个</p><p><strong>t1 w.lock，t2 r.lock</strong></p><p>1） t1 成功上锁，流程与 ReentrantLock 加锁相比没有特殊之处，不同是写锁状态占了 state 的低 16 位，而读锁 使用的是 state 的高 16 位</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191716969.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191716969 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>2）t2 执行 r.lock，这时进入读锁的 sync.acquireShared(1) 流程，首先会进入 tryAcquireShared 流程。如果有写 锁占据，那么 tryAcquireShared 返回 -1 表示失败</p><blockquote><p>tryAcquireShared 返回值表示</p><ul><li>-1 表示失败</li><li>0 表示成功，但后继节点不会继续唤醒</li><li>正数表示成功，而且数值是还有几个后继节点需要唤醒，读写锁返回 1</li></ul></blockquote><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191820931.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191820931 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>3）这时会进入 sync.doAcquireShared(1) 流程，首先也是调用 addWaiter 添加节点，不同之处在于节点被设置为 Node.SHARED 模式而非 Node.EXCLUSIVE 模式，注意此时 t2 仍处于活跃状态</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191835250.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191835250 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>4）t2 会看看自己的节点是不是老二，如果是，还会再次调用 tryAcquireShared(1) 来尝试获取锁</p><p>5）如果没有成功，在 doAcquireShared 内 for (;;) 循环一次，把前驱节点的 waitStatus 改为 -1，再 for (;;) 循环一 次尝试 tryAcquireShared(1) 如果还不成功，那么在 parkAndCheckInterrupt() 处 park</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191859644.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191859644 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>t3 r.lock，t4 w.lock</strong></p><p>这种状态下，假设又有 t3 加读锁和 t4 加写锁，这期间 t1 仍然持有锁，就变成了下面的样子</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191927467.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191927467 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>t1 w.unlock</strong></p><p>这时会走到写锁的 sync.release(1) 流程，调用 sync.tryRelease(1) 成功，变成下面的样子</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191953466.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191953466 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>接下来执行唤醒流程 sync.unparkSuccessor，即让老二恢复运行，这时 t2 在 doAcquireShared 内 parkAndCheckInterrupt() 处恢复运行</p><p>这回再来一次 for (;;) 执行 tryAcquireShared 成功则让读锁计数加一</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192033493.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192033493 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>这时 t2 已经恢复运行，接下来 t2 调用 setHeadAndPropagate(node, 1)，它原本所在节点被置为头节点</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192048242.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192048242 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>事情还没完，在 setHeadAndPropagate 方法内还会检查下一个节点是否是 shared，如果是则调用 doReleaseShared() 将 head 的状态从 -1 改为 0 并唤醒老二，这时 t3 在 doAcquireShared 内 parkAndCheckInterrupt() 处恢复运行</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192104962.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192104962 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>这回再来一次 for (;;) 执行 tryAcquireShared 成功则让读锁计数加一</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192123102.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192123102 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>这时 t3 已经恢复运行，接下来 t3 调用 setHeadAndPropagate(node, 1)，它原本所在节点被置为头节点</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192145552.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192145552 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>下一个节点不是 shared 了，因此不会继续唤醒 t4 所在节点</p><p><strong>t2 r.unlock，t3 r.unlock</strong></p><p>t2 进入 sync.releaseShared(1) 中，调用 tryReleaseShared(1) 让计数减一，但由于计数还不为零</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192222303.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192222303 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>t3 进入 sync.releaseShared(1) 中，调用 tryReleaseShared(1) 让计数减一，这回计数为零了，进入 doReleaseShared() 将头节点从 -1 改为 0 并唤醒老二，即</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192239120.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192239120 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>之后 t4 在 acquireQueued 中 parkAndCheckInterrupt 处恢复运行，再次 for (;;) 这次自己是老二，并且没有其他 竞争，tryAcquire(1) 成功，修改头结点，流程结束</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192254698.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192254698 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=源码分析><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 class=header-anchor>#</a>
源码分析</h4><h5 id=写锁上锁流程><a href=#%e5%86%99%e9%94%81%e4%b8%8a%e9%94%81%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
<strong>写锁上锁流程</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-432-1><a class=lnlinks href=#hl-432-1> 1</a>
</span><span class=lnt id=hl-432-2><a class=lnlinks href=#hl-432-2> 2</a>
</span><span class=lnt id=hl-432-3><a class=lnlinks href=#hl-432-3> 3</a>
</span><span class=lnt id=hl-432-4><a class=lnlinks href=#hl-432-4> 4</a>
</span><span class=lnt id=hl-432-5><a class=lnlinks href=#hl-432-5> 5</a>
</span><span class=lnt id=hl-432-6><a class=lnlinks href=#hl-432-6> 6</a>
</span><span class=lnt id=hl-432-7><a class=lnlinks href=#hl-432-7> 7</a>
</span><span class=lnt id=hl-432-8><a class=lnlinks href=#hl-432-8> 8</a>
</span><span class=lnt id=hl-432-9><a class=lnlinks href=#hl-432-9> 9</a>
</span><span class=lnt id=hl-432-10><a class=lnlinks href=#hl-432-10>10</a>
</span><span class=lnt id=hl-432-11><a class=lnlinks href=#hl-432-11>11</a>
</span><span class=lnt id=hl-432-12><a class=lnlinks href=#hl-432-12>12</a>
</span><span class=lnt id=hl-432-13><a class=lnlinks href=#hl-432-13>13</a>
</span><span class=lnt id=hl-432-14><a class=lnlinks href=#hl-432-14>14</a>
</span><span class=lnt id=hl-432-15><a class=lnlinks href=#hl-432-15>15</a>
</span><span class=lnt id=hl-432-16><a class=lnlinks href=#hl-432-16>16</a>
</span><span class=lnt id=hl-432-17><a class=lnlinks href=#hl-432-17>17</a>
</span><span class=lnt id=hl-432-18><a class=lnlinks href=#hl-432-18>18</a>
</span><span class=lnt id=hl-432-19><a class=lnlinks href=#hl-432-19>19</a>
</span><span class=lnt id=hl-432-20><a class=lnlinks href=#hl-432-20>20</a>
</span><span class=lnt id=hl-432-21><a class=lnlinks href=#hl-432-21>21</a>
</span><span class=lnt id=hl-432-22><a class=lnlinks href=#hl-432-22>22</a>
</span><span class=lnt id=hl-432-23><a class=lnlinks href=#hl-432-23>23</a>
</span><span class=lnt id=hl-432-24><a class=lnlinks href=#hl-432-24>24</a>
</span><span class=lnt id=hl-432-25><a class=lnlinks href=#hl-432-25>25</a>
</span><span class=lnt id=hl-432-26><a class=lnlinks href=#hl-432-26>26</a>
</span><span class=lnt id=hl-432-27><a class=lnlinks href=#hl-432-27>27</a>
</span><span class=lnt id=hl-432-28><a class=lnlinks href=#hl-432-28>28</a>
</span><span class=lnt id=hl-432-29><a class=lnlinks href=#hl-432-29>29</a>
</span><span class=lnt id=hl-432-30><a class=lnlinks href=#hl-432-30>30</a>
</span><span class=lnt id=hl-432-31><a class=lnlinks href=#hl-432-31>31</a>
</span><span class=lnt id=hl-432-32><a class=lnlinks href=#hl-432-32>32</a>
</span><span class=lnt id=hl-432-33><a class=lnlinks href=#hl-432-33>33</a>
</span><span class=lnt id=hl-432-34><a class=lnlinks href=#hl-432-34>34</a>
</span><span class=lnt id=hl-432-35><a class=lnlinks href=#hl-432-35>35</a>
</span><span class=lnt id=hl-432-36><a class=lnlinks href=#hl-432-36>36</a>
</span><span class=lnt id=hl-432-37><a class=lnlinks href=#hl-432-37>37</a>
</span><span class=lnt id=hl-432-38><a class=lnlinks href=#hl-432-38>38</a>
</span><span class=lnt id=hl-432-39><a class=lnlinks href=#hl-432-39>39</a>
</span><span class=lnt id=hl-432-40><a class=lnlinks href=#hl-432-40>40</a>
</span><span class=lnt id=hl-432-41><a class=lnlinks href=#hl-432-41>41</a>
</span><span class=lnt id=hl-432-42><a class=lnlinks href=#hl-432-42>42</a>
</span><span class=lnt id=hl-432-43><a class=lnlinks href=#hl-432-43>43</a>
</span><span class=lnt id=hl-432-44><a class=lnlinks href=#hl-432-44>44</a>
</span><span class=lnt id=hl-432-45><a class=lnlinks href=#hl-432-45>45</a>
</span><span class=lnt id=hl-432-46><a class=lnlinks href=#hl-432-46>46</a>
</span><span class=lnt id=hl-432-47><a class=lnlinks href=#hl-432-47>47</a>
</span><span class=lnt id=hl-432-48><a class=lnlinks href=#hl-432-48>48</a>
</span><span class=lnt id=hl-432-49><a class=lnlinks href=#hl-432-49>49</a>
</span><span class=lnt id=hl-432-50><a class=lnlinks href=#hl-432-50>50</a>
</span><span class=lnt id=hl-432-51><a class=lnlinks href=#hl-432-51>51</a>
</span><span class=lnt id=hl-432-52><a class=lnlinks href=#hl-432-52>52</a>
</span><span class=lnt id=hl-432-53><a class=lnlinks href=#hl-432-53>53</a>
</span><span class=lnt id=hl-432-54><a class=lnlinks href=#hl-432-54>54</a>
</span><span class=lnt id=hl-432-55><a class=lnlinks href=#hl-432-55>55</a>
</span><span class=lnt id=hl-432-56><a class=lnlinks href=#hl-432-56>56</a>
</span><span class=lnt id=hl-432-57><a class=lnlinks href=#hl-432-57>57</a>
</span><span class=lnt id=hl-432-58><a class=lnlinks href=#hl-432-58>58</a>
</span><span class=lnt id=hl-432-59><a class=lnlinks href=#hl-432-59>59</a>
</span><span class=lnt id=hl-432-60><a class=lnlinks href=#hl-432-60>60</a>
</span><span class=lnt id=hl-432-61><a class=lnlinks href=#hl-432-61>61</a>
</span><span class=lnt id=hl-432-62><a class=lnlinks href=#hl-432-62>62</a>
</span><span class=lnt id=hl-432-63><a class=lnlinks href=#hl-432-63>63</a>
</span><span class=lnt id=hl-432-64><a class=lnlinks href=#hl-432-64>64</a>
</span><span class=lnt id=hl-432-65><a class=lnlinks href=#hl-432-65>65</a>
</span><span class=lnt id=hl-432-66><a class=lnlinks href=#hl-432-66>66</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ... 省略无关代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 外部类 WriteLock 方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>acquire</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 尝试获得写锁失败</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 将当前线程关联到一个 Node 对象上, 模式为独占模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 进入 AQS 队列阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>EXCLUSIVE</span><span class=p>),</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获得低 16 位, 代表写锁的 state 计数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exclusiveCount</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//表示有写锁或者有读锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// c != 0 and w == 0 表示有读锁, 或者</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>w</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 如果 exclusiveOwnerThread 不是自己</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>current</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 获得锁失败</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 写锁计数超过低 16 位, 报异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>w</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>exclusiveCount</span><span class=p>(</span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>MAX_COUNT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum lock count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 写锁重入, 获得锁成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setState</span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>acquires</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 判断写锁是否该阻塞, 或者</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//非公平锁下，总是返回false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>writerShouldBlock</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 尝试更改计数失败</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获得锁失败</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获得锁成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>current</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 非公平锁 writerShouldBlock 总是返回 false, 无需阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>writerShouldBlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>总结：</p><ul><li><code>lock</code> -> <code>syn.acquire</code> -><code>tryAquire</code><ul><li>如果有锁：<ul><li>如果是写锁或者锁持有者不为自己，返回false</li><li>如果时写锁且为自己持有，则重入</li></ul></li><li>如果无锁：<ul><li>判断无序阻塞并设置state成功后，将owner设为自己，返回true</li></ul></li></ul></li><li>成功，则获得了锁</li><li>失败：<ul><li>调用<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code>进入阻塞队列，将节点状态设置为EXCLUSIVE，之后的逻辑与之前的aquireQueued类似。</li></ul></li></ul><h5 id=写锁释放流程><a href=#%e5%86%99%e9%94%81%e9%87%8a%e6%94%be%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
<strong>写锁释放流程</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-433-1><a class=lnlinks href=#hl-433-1> 1</a>
</span><span class=lnt id=hl-433-2><a class=lnlinks href=#hl-433-2> 2</a>
</span><span class=lnt id=hl-433-3><a class=lnlinks href=#hl-433-3> 3</a>
</span><span class=lnt id=hl-433-4><a class=lnlinks href=#hl-433-4> 4</a>
</span><span class=lnt id=hl-433-5><a class=lnlinks href=#hl-433-5> 5</a>
</span><span class=lnt id=hl-433-6><a class=lnlinks href=#hl-433-6> 6</a>
</span><span class=lnt id=hl-433-7><a class=lnlinks href=#hl-433-7> 7</a>
</span><span class=lnt id=hl-433-8><a class=lnlinks href=#hl-433-8> 8</a>
</span><span class=lnt id=hl-433-9><a class=lnlinks href=#hl-433-9> 9</a>
</span><span class=lnt id=hl-433-10><a class=lnlinks href=#hl-433-10>10</a>
</span><span class=lnt id=hl-433-11><a class=lnlinks href=#hl-433-11>11</a>
</span><span class=lnt id=hl-433-12><a class=lnlinks href=#hl-433-12>12</a>
</span><span class=lnt id=hl-433-13><a class=lnlinks href=#hl-433-13>13</a>
</span><span class=lnt id=hl-433-14><a class=lnlinks href=#hl-433-14>14</a>
</span><span class=lnt id=hl-433-15><a class=lnlinks href=#hl-433-15>15</a>
</span><span class=lnt id=hl-433-16><a class=lnlinks href=#hl-433-16>16</a>
</span><span class=lnt id=hl-433-17><a class=lnlinks href=#hl-433-17>17</a>
</span><span class=lnt id=hl-433-18><a class=lnlinks href=#hl-433-18>18</a>
</span><span class=lnt id=hl-433-19><a class=lnlinks href=#hl-433-19>19</a>
</span><span class=lnt id=hl-433-20><a class=lnlinks href=#hl-433-20>20</a>
</span><span class=lnt id=hl-433-21><a class=lnlinks href=#hl-433-21>21</a>
</span><span class=lnt id=hl-433-22><a class=lnlinks href=#hl-433-22>22</a>
</span><span class=lnt id=hl-433-23><a class=lnlinks href=#hl-433-23>23</a>
</span><span class=lnt id=hl-433-24><a class=lnlinks href=#hl-433-24>24</a>
</span><span class=lnt id=hl-433-25><a class=lnlinks href=#hl-433-25>25</a>
</span><span class=lnt id=hl-433-26><a class=lnlinks href=#hl-433-26>26</a>
</span><span class=lnt id=hl-433-27><a class=lnlinks href=#hl-433-27>27</a>
</span><span class=lnt id=hl-433-28><a class=lnlinks href=#hl-433-28>28</a>
</span><span class=lnt id=hl-433-29><a class=lnlinks href=#hl-433-29>29</a>
</span><span class=lnt id=hl-433-30><a class=lnlinks href=#hl-433-30>30</a>
</span><span class=lnt id=hl-433-31><a class=lnlinks href=#hl-433-31>31</a>
</span><span class=lnt id=hl-433-32><a class=lnlinks href=#hl-433-32>32</a>
</span><span class=lnt id=hl-433-33><a class=lnlinks href=#hl-433-33>33</a>
</span><span class=lnt id=hl-433-34><a class=lnlinks href=#hl-433-34>34</a>
</span><span class=lnt id=hl-433-35><a class=lnlinks href=#hl-433-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ... 省略无关代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// WriteLock 方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>release</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 尝试释放写锁成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryRelease</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// unpark AQS 中等待的线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryRelease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>releases</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHeldExclusively</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>releases</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 因为可重入的原因, 写锁计数为 0, 才算释放成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>free</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exclusiveCount</span><span class=p>(</span><span class=n>nextc</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>free</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setState</span><span class=p>(</span><span class=n>nextc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>free</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>总结：</p><ul><li><p><code>unlock</code>-><code>syn.release</code>-><code>tryRelease</code></p><ul><li>state状态减少<ul><li>如果减为零，表示解锁成功，返回true</li><li>没有减为0，当前线程依旧持有锁</li></ul></li></ul></li><li><p>成功：解锁成功</p><ul><li>如果ASQ队列不为空，则唤醒第一个节点。</li></ul></li><li><p>失败：解锁失败。</p></li></ul><h5 id=读锁上锁流程><a href=#%e8%af%bb%e9%94%81%e4%b8%8a%e9%94%81%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
<strong>读锁上锁流程</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-434-1><a class=lnlinks href=#hl-434-1>  1</a>
</span><span class=lnt id=hl-434-2><a class=lnlinks href=#hl-434-2>  2</a>
</span><span class=lnt id=hl-434-3><a class=lnlinks href=#hl-434-3>  3</a>
</span><span class=lnt id=hl-434-4><a class=lnlinks href=#hl-434-4>  4</a>
</span><span class=lnt id=hl-434-5><a class=lnlinks href=#hl-434-5>  5</a>
</span><span class=lnt id=hl-434-6><a class=lnlinks href=#hl-434-6>  6</a>
</span><span class=lnt id=hl-434-7><a class=lnlinks href=#hl-434-7>  7</a>
</span><span class=lnt id=hl-434-8><a class=lnlinks href=#hl-434-8>  8</a>
</span><span class=lnt id=hl-434-9><a class=lnlinks href=#hl-434-9>  9</a>
</span><span class=lnt id=hl-434-10><a class=lnlinks href=#hl-434-10> 10</a>
</span><span class=lnt id=hl-434-11><a class=lnlinks href=#hl-434-11> 11</a>
</span><span class=lnt id=hl-434-12><a class=lnlinks href=#hl-434-12> 12</a>
</span><span class=lnt id=hl-434-13><a class=lnlinks href=#hl-434-13> 13</a>
</span><span class=lnt id=hl-434-14><a class=lnlinks href=#hl-434-14> 14</a>
</span><span class=lnt id=hl-434-15><a class=lnlinks href=#hl-434-15> 15</a>
</span><span class=lnt id=hl-434-16><a class=lnlinks href=#hl-434-16> 16</a>
</span><span class=lnt id=hl-434-17><a class=lnlinks href=#hl-434-17> 17</a>
</span><span class=lnt id=hl-434-18><a class=lnlinks href=#hl-434-18> 18</a>
</span><span class=lnt id=hl-434-19><a class=lnlinks href=#hl-434-19> 19</a>
</span><span class=lnt id=hl-434-20><a class=lnlinks href=#hl-434-20> 20</a>
</span><span class=lnt id=hl-434-21><a class=lnlinks href=#hl-434-21> 21</a>
</span><span class=lnt id=hl-434-22><a class=lnlinks href=#hl-434-22> 22</a>
</span><span class=lnt id=hl-434-23><a class=lnlinks href=#hl-434-23> 23</a>
</span><span class=lnt id=hl-434-24><a class=lnlinks href=#hl-434-24> 24</a>
</span><span class=lnt id=hl-434-25><a class=lnlinks href=#hl-434-25> 25</a>
</span><span class=lnt id=hl-434-26><a class=lnlinks href=#hl-434-26> 26</a>
</span><span class=lnt id=hl-434-27><a class=lnlinks href=#hl-434-27> 27</a>
</span><span class=lnt id=hl-434-28><a class=lnlinks href=#hl-434-28> 28</a>
</span><span class=lnt id=hl-434-29><a class=lnlinks href=#hl-434-29> 29</a>
</span><span class=lnt id=hl-434-30><a class=lnlinks href=#hl-434-30> 30</a>
</span><span class=lnt id=hl-434-31><a class=lnlinks href=#hl-434-31> 31</a>
</span><span class=lnt id=hl-434-32><a class=lnlinks href=#hl-434-32> 32</a>
</span><span class=lnt id=hl-434-33><a class=lnlinks href=#hl-434-33> 33</a>
</span><span class=lnt id=hl-434-34><a class=lnlinks href=#hl-434-34> 34</a>
</span><span class=lnt id=hl-434-35><a class=lnlinks href=#hl-434-35> 35</a>
</span><span class=lnt id=hl-434-36><a class=lnlinks href=#hl-434-36> 36</a>
</span><span class=lnt id=hl-434-37><a class=lnlinks href=#hl-434-37> 37</a>
</span><span class=lnt id=hl-434-38><a class=lnlinks href=#hl-434-38> 38</a>
</span><span class=lnt id=hl-434-39><a class=lnlinks href=#hl-434-39> 39</a>
</span><span class=lnt id=hl-434-40><a class=lnlinks href=#hl-434-40> 40</a>
</span><span class=lnt id=hl-434-41><a class=lnlinks href=#hl-434-41> 41</a>
</span><span class=lnt id=hl-434-42><a class=lnlinks href=#hl-434-42> 42</a>
</span><span class=lnt id=hl-434-43><a class=lnlinks href=#hl-434-43> 43</a>
</span><span class=lnt id=hl-434-44><a class=lnlinks href=#hl-434-44> 44</a>
</span><span class=lnt id=hl-434-45><a class=lnlinks href=#hl-434-45> 45</a>
</span><span class=lnt id=hl-434-46><a class=lnlinks href=#hl-434-46> 46</a>
</span><span class=lnt id=hl-434-47><a class=lnlinks href=#hl-434-47> 47</a>
</span><span class=lnt id=hl-434-48><a class=lnlinks href=#hl-434-48> 48</a>
</span><span class=lnt id=hl-434-49><a class=lnlinks href=#hl-434-49> 49</a>
</span><span class=lnt id=hl-434-50><a class=lnlinks href=#hl-434-50> 50</a>
</span><span class=lnt id=hl-434-51><a class=lnlinks href=#hl-434-51> 51</a>
</span><span class=lnt id=hl-434-52><a class=lnlinks href=#hl-434-52> 52</a>
</span><span class=lnt id=hl-434-53><a class=lnlinks href=#hl-434-53> 53</a>
</span><span class=lnt id=hl-434-54><a class=lnlinks href=#hl-434-54> 54</a>
</span><span class=lnt id=hl-434-55><a class=lnlinks href=#hl-434-55> 55</a>
</span><span class=lnt id=hl-434-56><a class=lnlinks href=#hl-434-56> 56</a>
</span><span class=lnt id=hl-434-57><a class=lnlinks href=#hl-434-57> 57</a>
</span><span class=lnt id=hl-434-58><a class=lnlinks href=#hl-434-58> 58</a>
</span><span class=lnt id=hl-434-59><a class=lnlinks href=#hl-434-59> 59</a>
</span><span class=lnt id=hl-434-60><a class=lnlinks href=#hl-434-60> 60</a>
</span><span class=lnt id=hl-434-61><a class=lnlinks href=#hl-434-61> 61</a>
</span><span class=lnt id=hl-434-62><a class=lnlinks href=#hl-434-62> 62</a>
</span><span class=lnt id=hl-434-63><a class=lnlinks href=#hl-434-63> 63</a>
</span><span class=lnt id=hl-434-64><a class=lnlinks href=#hl-434-64> 64</a>
</span><span class=lnt id=hl-434-65><a class=lnlinks href=#hl-434-65> 65</a>
</span><span class=lnt id=hl-434-66><a class=lnlinks href=#hl-434-66> 66</a>
</span><span class=lnt id=hl-434-67><a class=lnlinks href=#hl-434-67> 67</a>
</span><span class=lnt id=hl-434-68><a class=lnlinks href=#hl-434-68> 68</a>
</span><span class=lnt id=hl-434-69><a class=lnlinks href=#hl-434-69> 69</a>
</span><span class=lnt id=hl-434-70><a class=lnlinks href=#hl-434-70> 70</a>
</span><span class=lnt id=hl-434-71><a class=lnlinks href=#hl-434-71> 71</a>
</span><span class=lnt id=hl-434-72><a class=lnlinks href=#hl-434-72> 72</a>
</span><span class=lnt id=hl-434-73><a class=lnlinks href=#hl-434-73> 73</a>
</span><span class=lnt id=hl-434-74><a class=lnlinks href=#hl-434-74> 74</a>
</span><span class=lnt id=hl-434-75><a class=lnlinks href=#hl-434-75> 75</a>
</span><span class=lnt id=hl-434-76><a class=lnlinks href=#hl-434-76> 76</a>
</span><span class=lnt id=hl-434-77><a class=lnlinks href=#hl-434-77> 77</a>
</span><span class=lnt id=hl-434-78><a class=lnlinks href=#hl-434-78> 78</a>
</span><span class=lnt id=hl-434-79><a class=lnlinks href=#hl-434-79> 79</a>
</span><span class=lnt id=hl-434-80><a class=lnlinks href=#hl-434-80> 80</a>
</span><span class=lnt id=hl-434-81><a class=lnlinks href=#hl-434-81> 81</a>
</span><span class=lnt id=hl-434-82><a class=lnlinks href=#hl-434-82> 82</a>
</span><span class=lnt id=hl-434-83><a class=lnlinks href=#hl-434-83> 83</a>
</span><span class=lnt id=hl-434-84><a class=lnlinks href=#hl-434-84> 84</a>
</span><span class=lnt id=hl-434-85><a class=lnlinks href=#hl-434-85> 85</a>
</span><span class=lnt id=hl-434-86><a class=lnlinks href=#hl-434-86> 86</a>
</span><span class=lnt id=hl-434-87><a class=lnlinks href=#hl-434-87> 87</a>
</span><span class=lnt id=hl-434-88><a class=lnlinks href=#hl-434-88> 88</a>
</span><span class=lnt id=hl-434-89><a class=lnlinks href=#hl-434-89> 89</a>
</span><span class=lnt id=hl-434-90><a class=lnlinks href=#hl-434-90> 90</a>
</span><span class=lnt id=hl-434-91><a class=lnlinks href=#hl-434-91> 91</a>
</span><span class=lnt id=hl-434-92><a class=lnlinks href=#hl-434-92> 92</a>
</span><span class=lnt id=hl-434-93><a class=lnlinks href=#hl-434-93> 93</a>
</span><span class=lnt id=hl-434-94><a class=lnlinks href=#hl-434-94> 94</a>
</span><span class=lnt id=hl-434-95><a class=lnlinks href=#hl-434-95> 95</a>
</span><span class=lnt id=hl-434-96><a class=lnlinks href=#hl-434-96> 96</a>
</span><span class=lnt id=hl-434-97><a class=lnlinks href=#hl-434-97> 97</a>
</span><span class=lnt id=hl-434-98><a class=lnlinks href=#hl-434-98> 98</a>
</span><span class=lnt id=hl-434-99><a class=lnlinks href=#hl-434-99> 99</a>
</span><span class=lnt id=hl-434-100><a class=lnlinks href=#hl-434-100>100</a>
</span><span class=lnt id=hl-434-101><a class=lnlinks href=#hl-434-101>101</a>
</span><span class=lnt id=hl-434-102><a class=lnlinks href=#hl-434-102>102</a>
</span><span class=lnt id=hl-434-103><a class=lnlinks href=#hl-434-103>103</a>
</span><span class=lnt id=hl-434-104><a class=lnlinks href=#hl-434-104>104</a>
</span><span class=lnt id=hl-434-105><a class=lnlinks href=#hl-434-105>105</a>
</span><span class=lnt id=hl-434-106><a class=lnlinks href=#hl-434-106>106</a>
</span><span class=lnt id=hl-434-107><a class=lnlinks href=#hl-434-107>107</a>
</span><span class=lnt id=hl-434-108><a class=lnlinks href=#hl-434-108>108</a>
</span><span class=lnt id=hl-434-109><a class=lnlinks href=#hl-434-109>109</a>
</span><span class=lnt id=hl-434-110><a class=lnlinks href=#hl-434-110>110</a>
</span><span class=lnt id=hl-434-111><a class=lnlinks href=#hl-434-111>111</a>
</span><span class=lnt id=hl-434-112><a class=lnlinks href=#hl-434-112>112</a>
</span><span class=lnt id=hl-434-113><a class=lnlinks href=#hl-434-113>113</a>
</span><span class=lnt id=hl-434-114><a class=lnlinks href=#hl-434-114>114</a>
</span><span class=lnt id=hl-434-115><a class=lnlinks href=#hl-434-115>115</a>
</span><span class=lnt id=hl-434-116><a class=lnlinks href=#hl-434-116>116</a>
</span><span class=lnt id=hl-434-117><a class=lnlinks href=#hl-434-117>117</a>
</span><span class=lnt id=hl-434-118><a class=lnlinks href=#hl-434-118>118</a>
</span><span class=lnt id=hl-434-119><a class=lnlinks href=#hl-434-119>119</a>
</span><span class=lnt id=hl-434-120><a class=lnlinks href=#hl-434-120>120</a>
</span><span class=lnt id=hl-434-121><a class=lnlinks href=#hl-434-121>121</a>
</span><span class=lnt id=hl-434-122><a class=lnlinks href=#hl-434-122>122</a>
</span><span class=lnt id=hl-434-123><a class=lnlinks href=#hl-434-123>123</a>
</span><span class=lnt id=hl-434-124><a class=lnlinks href=#hl-434-124>124</a>
</span><span class=lnt id=hl-434-125><a class=lnlinks href=#hl-434-125>125</a>
</span><span class=lnt id=hl-434-126><a class=lnlinks href=#hl-434-126>126</a>
</span><span class=lnt id=hl-434-127><a class=lnlinks href=#hl-434-127>127</a>
</span><span class=lnt id=hl-434-128><a class=lnlinks href=#hl-434-128>128</a>
</span><span class=lnt id=hl-434-129><a class=lnlinks href=#hl-434-129>129</a>
</span><span class=lnt id=hl-434-130><a class=lnlinks href=#hl-434-130>130</a>
</span><span class=lnt id=hl-434-131><a class=lnlinks href=#hl-434-131>131</a>
</span><span class=lnt id=hl-434-132><a class=lnlinks href=#hl-434-132>132</a>
</span><span class=lnt id=hl-434-133><a class=lnlinks href=#hl-434-133>133</a>
</span><span class=lnt id=hl-434-134><a class=lnlinks href=#hl-434-134>134</a>
</span><span class=lnt id=hl-434-135><a class=lnlinks href=#hl-434-135>135</a>
</span><span class=lnt id=hl-434-136><a class=lnlinks href=#hl-434-136>136</a>
</span><span class=lnt id=hl-434-137><a class=lnlinks href=#hl-434-137>137</a>
</span><span class=lnt id=hl-434-138><a class=lnlinks href=#hl-434-138>138</a>
</span><span class=lnt id=hl-434-139><a class=lnlinks href=#hl-434-139>139</a>
</span><span class=lnt id=hl-434-140><a class=lnlinks href=#hl-434-140>140</a>
</span><span class=lnt id=hl-434-141><a class=lnlinks href=#hl-434-141>141</a>
</span><span class=lnt id=hl-434-142><a class=lnlinks href=#hl-434-142>142</a>
</span><span class=lnt id=hl-434-143><a class=lnlinks href=#hl-434-143>143</a>
</span><span class=lnt id=hl-434-144><a class=lnlinks href=#hl-434-144>144</a>
</span><span class=lnt id=hl-434-145><a class=lnlinks href=#hl-434-145>145</a>
</span><span class=lnt id=hl-434-146><a class=lnlinks href=#hl-434-146>146</a>
</span><span class=lnt id=hl-434-147><a class=lnlinks href=#hl-434-147>147</a>
</span><span class=lnt id=hl-434-148><a class=lnlinks href=#hl-434-148>148</a>
</span><span class=lnt id=hl-434-149><a class=lnlinks href=#hl-434-149>149</a>
</span><span class=lnt id=hl-434-150><a class=lnlinks href=#hl-434-150>150</a>
</span><span class=lnt id=hl-434-151><a class=lnlinks href=#hl-434-151>151</a>
</span><span class=lnt id=hl-434-152><a class=lnlinks href=#hl-434-152>152</a>
</span><span class=lnt id=hl-434-153><a class=lnlinks href=#hl-434-153>153</a>
</span><span class=lnt id=hl-434-154><a class=lnlinks href=#hl-434-154>154</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ReadLock 方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>acquireShared</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquireShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// tryAcquireShared 返回负数, 表示获取读锁失败</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//大于0的情况在读写锁这里无区别，后面信号量会做进一步处理。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryAcquireShared</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doAcquireShared</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>tryAcquireShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>unused</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果是其它线程持有写锁, 获取读锁失败</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>exclusiveCount</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>getExclusiveOwnerThread</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>current</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sharedCount</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 读锁不该阻塞(如果老二是写锁，读锁该阻塞), 并且</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>readerShouldBlock</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 小于读锁计数, 并且</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>MAX_COUNT</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 尝试增加计数成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>SHARED_UNIT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ... 省略不重要的代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>fullTryAcquireShared</span><span class=p>(</span><span class=n>current</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 非公平锁 readerShouldBlock 看 AQS 队列中第一个节点是否是写锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// true 则该阻塞, false 则不阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>readerShouldBlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>apparentlyFirstQueuedIsExclusive</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 与 tryAcquireShared 功能类似, 但会不断尝试 for (;;) 获取读锁, 执行过程中无阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>fullTryAcquireShared</span><span class=p>(</span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HoldCounter</span><span class=w> </span><span class=n>rh</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>exclusiveCount</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>getExclusiveOwnerThread</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>current</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>readerShouldBlock</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ... 省略不重要的代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sharedCount</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAX_COUNT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum lock count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>SHARED_UNIT</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ... 省略不重要的代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doAcquireShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 将当前线程关联到一个 Node 对象上, 模式为共享模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>SHARED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>predecessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 再一次尝试获取读锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tryAcquireShared</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// ㈠</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// r 表示可用资源数, 在这里总是 1 允许传播</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//（唤醒 AQS 中下一个 Share 节点）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>setHeadAndPropagate</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// help GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interrupted</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 是否在获取读锁失败时阻塞（前一个阶段 waitStatus == Node.SIGNAL）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// park 当前线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>parkAndCheckInterrupt</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cancelAcquire</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈠ AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setHeadAndPropagate</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>propagate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w> </span><span class=c1>// Record old head for check below</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置自己为 head</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setHead</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// propagate 表示有共享资源（例如共享读锁或信号量）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 原 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 现在 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>propagate</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果是最后一个节点或者是等待共享读锁的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>isShared</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 进入 ㈡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>doReleaseShared</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ㈡ AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doReleaseShared</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果 head.waitStatus == Node.SIGNAL ==&gt; 0 成功, 下一个节点 unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果 head.waitStatus == 0 ==&gt; Node.PROPAGATE, 为了解决 bug, 见后面分析</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 队列还有节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>tail</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w> </span><span class=c1>// loop to recheck cases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 下一个节点 unpark 如果成功获取读锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 并且下下个节点还是 shared, 继续 doReleaseShared</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>PROPAGATE</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w> </span><span class=c1>// loop on failed CAS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=c1>// loop if head changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>总结：</p><ul><li><code>lock</code>-><code>syn.acquireShare</code>-><code>tryAcquireShare</code><ul><li>如果其他线程持有写锁：则失败，返回-1</li><li>否则：判断无需等待后，将state加上一个写锁的单位，返回1</li></ul></li><li>返回值大于等于0：成功</li><li>返回值小于0：<ul><li>调用doAcquireShare，类似之前的aquireQueued,将当前线程关联节点，状态设置为SHARE，插入AQS队列尾部。在for循环中判断当前节点的前驱节点是否为头节点<ul><li>是：调用<code>tryAcquireShare</code><ul><li>如果返回值大于等于0，则获取锁成功，并调用<code>setHeadAndPropagate</code>，出队，并不断唤醒AQS队列中的状态为SHARE的节点，直到下一个节点为EXCLUSIVE。记录打断标记，之后退出方法（不返回打断标记）</li></ul></li></ul></li><li>判断是否在失败后阻塞<ul><li>是：阻塞住，并监测打断信号。</li><li>否则：将前驱节点状态设为-1。（下一次循环就又要阻塞了）</li></ul></li></ul></li></ul><h5 id=读锁释放流程><a href=#%e8%af%bb%e9%94%81%e9%87%8a%e6%94%be%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
<strong>读锁释放流程</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-435-1><a class=lnlinks href=#hl-435-1> 1</a>
</span><span class=lnt id=hl-435-2><a class=lnlinks href=#hl-435-2> 2</a>
</span><span class=lnt id=hl-435-3><a class=lnlinks href=#hl-435-3> 3</a>
</span><span class=lnt id=hl-435-4><a class=lnlinks href=#hl-435-4> 4</a>
</span><span class=lnt id=hl-435-5><a class=lnlinks href=#hl-435-5> 5</a>
</span><span class=lnt id=hl-435-6><a class=lnlinks href=#hl-435-6> 6</a>
</span><span class=lnt id=hl-435-7><a class=lnlinks href=#hl-435-7> 7</a>
</span><span class=lnt id=hl-435-8><a class=lnlinks href=#hl-435-8> 8</a>
</span><span class=lnt id=hl-435-9><a class=lnlinks href=#hl-435-9> 9</a>
</span><span class=lnt id=hl-435-10><a class=lnlinks href=#hl-435-10>10</a>
</span><span class=lnt id=hl-435-11><a class=lnlinks href=#hl-435-11>11</a>
</span><span class=lnt id=hl-435-12><a class=lnlinks href=#hl-435-12>12</a>
</span><span class=lnt id=hl-435-13><a class=lnlinks href=#hl-435-13>13</a>
</span><span class=lnt id=hl-435-14><a class=lnlinks href=#hl-435-14>14</a>
</span><span class=lnt id=hl-435-15><a class=lnlinks href=#hl-435-15>15</a>
</span><span class=lnt id=hl-435-16><a class=lnlinks href=#hl-435-16>16</a>
</span><span class=lnt id=hl-435-17><a class=lnlinks href=#hl-435-17>17</a>
</span><span class=lnt id=hl-435-18><a class=lnlinks href=#hl-435-18>18</a>
</span><span class=lnt id=hl-435-19><a class=lnlinks href=#hl-435-19>19</a>
</span><span class=lnt id=hl-435-20><a class=lnlinks href=#hl-435-20>20</a>
</span><span class=lnt id=hl-435-21><a class=lnlinks href=#hl-435-21>21</a>
</span><span class=lnt id=hl-435-22><a class=lnlinks href=#hl-435-22>22</a>
</span><span class=lnt id=hl-435-23><a class=lnlinks href=#hl-435-23>23</a>
</span><span class=lnt id=hl-435-24><a class=lnlinks href=#hl-435-24>24</a>
</span><span class=lnt id=hl-435-25><a class=lnlinks href=#hl-435-25>25</a>
</span><span class=lnt id=hl-435-26><a class=lnlinks href=#hl-435-26>26</a>
</span><span class=lnt id=hl-435-27><a class=lnlinks href=#hl-435-27>27</a>
</span><span class=lnt id=hl-435-28><a class=lnlinks href=#hl-435-28>28</a>
</span><span class=lnt id=hl-435-29><a class=lnlinks href=#hl-435-29>29</a>
</span><span class=lnt id=hl-435-30><a class=lnlinks href=#hl-435-30>30</a>
</span><span class=lnt id=hl-435-31><a class=lnlinks href=#hl-435-31>31</a>
</span><span class=lnt id=hl-435-32><a class=lnlinks href=#hl-435-32>32</a>
</span><span class=lnt id=hl-435-33><a class=lnlinks href=#hl-435-33>33</a>
</span><span class=lnt id=hl-435-34><a class=lnlinks href=#hl-435-34>34</a>
</span><span class=lnt id=hl-435-35><a class=lnlinks href=#hl-435-35>35</a>
</span><span class=lnt id=hl-435-36><a class=lnlinks href=#hl-435-36>36</a>
</span><span class=lnt id=hl-435-37><a class=lnlinks href=#hl-435-37>37</a>
</span><span class=lnt id=hl-435-38><a class=lnlinks href=#hl-435-38>38</a>
</span><span class=lnt id=hl-435-39><a class=lnlinks href=#hl-435-39>39</a>
</span><span class=lnt id=hl-435-40><a class=lnlinks href=#hl-435-40>40</a>
</span><span class=lnt id=hl-435-41><a class=lnlinks href=#hl-435-41>41</a>
</span><span class=lnt id=hl-435-42><a class=lnlinks href=#hl-435-42>42</a>
</span><span class=lnt id=hl-435-43><a class=lnlinks href=#hl-435-43>43</a>
</span><span class=lnt id=hl-435-44><a class=lnlinks href=#hl-435-44>44</a>
</span><span class=lnt id=hl-435-45><a class=lnlinks href=#hl-435-45>45</a>
</span><span class=lnt id=hl-435-46><a class=lnlinks href=#hl-435-46>46</a>
</span><span class=lnt id=hl-435-47><a class=lnlinks href=#hl-435-47>47</a>
</span><span class=lnt id=hl-435-48><a class=lnlinks href=#hl-435-48>48</a>
</span><span class=lnt id=hl-435-49><a class=lnlinks href=#hl-435-49>49</a>
</span><span class=lnt id=hl-435-50><a class=lnlinks href=#hl-435-50>50</a>
</span><span class=lnt id=hl-435-51><a class=lnlinks href=#hl-435-51>51</a>
</span><span class=lnt id=hl-435-52><a class=lnlinks href=#hl-435-52>52</a>
</span><span class=lnt id=hl-435-53><a class=lnlinks href=#hl-435-53>53</a>
</span><span class=lnt id=hl-435-54><a class=lnlinks href=#hl-435-54>54</a>
</span><span class=lnt id=hl-435-55><a class=lnlinks href=#hl-435-55>55</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ReadLock 方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>releaseShared</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>releaseShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryReleaseShared</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doReleaseShared</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryReleaseShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>unused</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ... 省略不重要的代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>SHARED_UNIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>nextc</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 读锁的计数不会影响其它获取读锁线程, 但会影响其它获取写锁线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 计数为 0 才是真正释放</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doReleaseShared</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果 head.waitStatus == Node.SIGNAL ==&gt; 0 成功, 下一个节点 unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果 head.waitStatus == 0 ==&gt; Node.PROPAGATE </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>tail</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 如果有其它线程也在释放读锁，那么需要将 waitStatus 先改为 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 防止 unparkSuccessor 被多次执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w> </span><span class=c1>// loop to recheck cases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 如果已经是 0 了，改为 -3，用来解决传播性，见后文信号量 bug 分析</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>PROPAGATE</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w> </span><span class=c1>// loop on failed CAS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=c1>// loop if head changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>总结：</p><ul><li><code>unlock</code>-><code>releaseShared</code>-><code>tryReleaseShared</code>,将state减去一个share单元，最后state为0则返回true，不然返回false。</li><li>返回tue：调用<code>doReleaseShare</code>,唤醒队列中的节点。</li><li>返回false：解锁不完全。</li></ul><h3 id=stampedlock><a href=#stampedlock class=header-anchor>#</a>
StampedLock</h3><p>该类自 JDK 8 加入，是为了进一步优化读性能，它的特点是在使用读锁、写锁时都必须配合【戳】使用 加解读锁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-436-1><a class=lnlinks href=#hl-436-1>1</a>
</span><span class=lnt id=hl-436-2><a class=lnlinks href=#hl-436-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>long</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>readLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>unlockRead</span><span class=p>(</span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>加解写锁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-437-1><a class=lnlinks href=#hl-437-1>1</a>
</span><span class=lnt id=hl-437-2><a class=lnlinks href=#hl-437-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>long</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>unlockWrite</span><span class=p>(</span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>乐观读，StampedLock 支持 tryOptimisticRead() 方法（乐观读），读取完毕后需要做一次 戳校验 如果校验通 过，表示这期间确实没有写操作，数据可以安全使用，如果校验没通过，需要重新获取读锁，保证数据安全。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-438-1><a class=lnlinks href=#hl-438-1>1</a>
</span><span class=lnt id=hl-438-2><a class=lnlinks href=#hl-438-2>2</a>
</span><span class=lnt id=hl-438-3><a class=lnlinks href=#hl-438-3>3</a>
</span><span class=lnt id=hl-438-4><a class=lnlinks href=#hl-438-4>4</a>
</span><span class=lnt id=hl-438-5><a class=lnlinks href=#hl-438-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>long</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>tryOptimisticRead</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 验戳</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>lock</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>stamp</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 锁升级</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>提供一个<code>数据容器类</code>内部分别使用读锁保护数据的<code>read()</code>方法，写锁保护数据的<code>write()</code>方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-439-1><a class=lnlinks href=#hl-439-1> 1</a>
</span><span class=lnt id=hl-439-2><a class=lnlinks href=#hl-439-2> 2</a>
</span><span class=lnt id=hl-439-3><a class=lnlinks href=#hl-439-3> 3</a>
</span><span class=lnt id=hl-439-4><a class=lnlinks href=#hl-439-4> 4</a>
</span><span class=lnt id=hl-439-5><a class=lnlinks href=#hl-439-5> 5</a>
</span><span class=lnt id=hl-439-6><a class=lnlinks href=#hl-439-6> 6</a>
</span><span class=lnt id=hl-439-7><a class=lnlinks href=#hl-439-7> 7</a>
</span><span class=lnt id=hl-439-8><a class=lnlinks href=#hl-439-8> 8</a>
</span><span class=lnt id=hl-439-9><a class=lnlinks href=#hl-439-9> 9</a>
</span><span class=lnt id=hl-439-10><a class=lnlinks href=#hl-439-10>10</a>
</span><span class=lnt id=hl-439-11><a class=lnlinks href=#hl-439-11>11</a>
</span><span class=lnt id=hl-439-12><a class=lnlinks href=#hl-439-12>12</a>
</span><span class=lnt id=hl-439-13><a class=lnlinks href=#hl-439-13>13</a>
</span><span class=lnt id=hl-439-14><a class=lnlinks href=#hl-439-14>14</a>
</span><span class=lnt id=hl-439-15><a class=lnlinks href=#hl-439-15>15</a>
</span><span class=lnt id=hl-439-16><a class=lnlinks href=#hl-439-16>16</a>
</span><span class=lnt id=hl-439-17><a class=lnlinks href=#hl-439-17>17</a>
</span><span class=lnt id=hl-439-18><a class=lnlinks href=#hl-439-18>18</a>
</span><span class=lnt id=hl-439-19><a class=lnlinks href=#hl-439-19>19</a>
</span><span class=lnt id=hl-439-20><a class=lnlinks href=#hl-439-20>20</a>
</span><span class=lnt id=hl-439-21><a class=lnlinks href=#hl-439-21>21</a>
</span><span class=lnt id=hl-439-22><a class=lnlinks href=#hl-439-22>22</a>
</span><span class=lnt id=hl-439-23><a class=lnlinks href=#hl-439-23>23</a>
</span><span class=lnt id=hl-439-24><a class=lnlinks href=#hl-439-24>24</a>
</span><span class=lnt id=hl-439-25><a class=lnlinks href=#hl-439-25>25</a>
</span><span class=lnt id=hl-439-26><a class=lnlinks href=#hl-439-26>26</a>
</span><span class=lnt id=hl-439-27><a class=lnlinks href=#hl-439-27>27</a>
</span><span class=lnt id=hl-439-28><a class=lnlinks href=#hl-439-28>28</a>
</span><span class=lnt id=hl-439-29><a class=lnlinks href=#hl-439-29>29</a>
</span><span class=lnt id=hl-439-30><a class=lnlinks href=#hl-439-30>30</a>
</span><span class=lnt id=hl-439-31><a class=lnlinks href=#hl-439-31>31</a>
</span><span class=lnt id=hl-439-32><a class=lnlinks href=#hl-439-32>32</a>
</span><span class=lnt id=hl-439-33><a class=lnlinks href=#hl-439-33>33</a>
</span><span class=lnt id=hl-439-34><a class=lnlinks href=#hl-439-34>34</a>
</span><span class=lnt id=hl-439-35><a class=lnlinks href=#hl-439-35>35</a>
</span><span class=lnt id=hl-439-36><a class=lnlinks href=#hl-439-36>36</a>
</span><span class=lnt id=hl-439-37><a class=lnlinks href=#hl-439-37>37</a>
</span><span class=lnt id=hl-439-38><a class=lnlinks href=#hl-439-38>38</a>
</span><span class=lnt id=hl-439-39><a class=lnlinks href=#hl-439-39>39</a>
</span><span class=lnt id=hl-439-40><a class=lnlinks href=#hl-439-40>40</a>
</span><span class=lnt id=hl-439-41><a class=lnlinks href=#hl-439-41>41</a>
</span><span class=lnt id=hl-439-42><a class=lnlinks href=#hl-439-42>42</a>
</span><span class=lnt id=hl-439-43><a class=lnlinks href=#hl-439-43>43</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JAVA data-lang=JAVA><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DataContainerStamped</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>StampedLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StampedLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DataContainerStamped</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>read</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>readTime</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//获取戳</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>tryOptimisticRead</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;optimistic read locking...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//读取数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>readTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//读取数据之后再验戳</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>stamp</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read finish...{}, data:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//如果验戳失败，说明已经数据已经被修改，需要升级锁重新读。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 锁升级 - 读锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;updating to read lock... {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>readLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read lock {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>readTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read finish...{}, data:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read unlock {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlockRead</span><span class=p>(</span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>write</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>newData</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;write lock {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newData</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;write unlock {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlockWrite</span><span class=p>(</span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>测试<code>读-读</code>可以优化</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-440-1><a class=lnlinks href=#hl-440-1> 1</a>
</span><span class=lnt id=hl-440-2><a class=lnlinks href=#hl-440-2> 2</a>
</span><span class=lnt id=hl-440-3><a class=lnlinks href=#hl-440-3> 3</a>
</span><span class=lnt id=hl-440-4><a class=lnlinks href=#hl-440-4> 4</a>
</span><span class=lnt id=hl-440-5><a class=lnlinks href=#hl-440-5> 5</a>
</span><span class=lnt id=hl-440-6><a class=lnlinks href=#hl-440-6> 6</a>
</span><span class=lnt id=hl-440-7><a class=lnlinks href=#hl-440-7> 7</a>
</span><span class=lnt id=hl-440-8><a class=lnlinks href=#hl-440-8> 8</a>
</span><span class=lnt id=hl-440-9><a class=lnlinks href=#hl-440-9> 9</a>
</span><span class=lnt id=hl-440-10><a class=lnlinks href=#hl-440-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JAVA data-lang=JAVA><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DataContainerStamped</span><span class=w> </span><span class=n>dataContainer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataContainerStamped</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出结果，可以看到实际没有加读锁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-441-1><a class=lnlinks href=#hl-441-1>1</a>
</span><span class=lnt id=hl-441-2><a class=lnlinks href=#hl-441-2>2</a>
</span><span class=lnt id=hl-441-3><a class=lnlinks href=#hl-441-3>3</a>
</span><span class=lnt id=hl-441-4><a class=lnlinks href=#hl-441-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SH data-lang=SH><span class=line><span class=cl>15:58:50.217 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - optimistic <span class=nb>read</span> locking...256 
</span></span><span class=line><span class=cl>15:58:50.717 c.DataContainerStamped <span class=o>[</span>t2<span class=o>]</span> - optimistic <span class=nb>read</span> locking...256 
</span></span><span class=line><span class=cl>15:58:50.717 c.DataContainerStamped <span class=o>[</span>t2<span class=o>]</span> - <span class=nb>read</span> finish...256, data:1 
</span></span><span class=line><span class=cl>15:58:51.220 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - <span class=nb>read</span> finish...256, data:1 
</span></span></code></pre></td></tr></table></div></div><p>测试<code>读-写</code>时优化读补加读锁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-442-1><a class=lnlinks href=#hl-442-1> 1</a>
</span><span class=lnt id=hl-442-2><a class=lnlinks href=#hl-442-2> 2</a>
</span><span class=lnt id=hl-442-3><a class=lnlinks href=#hl-442-3> 3</a>
</span><span class=lnt id=hl-442-4><a class=lnlinks href=#hl-442-4> 4</a>
</span><span class=lnt id=hl-442-5><a class=lnlinks href=#hl-442-5> 5</a>
</span><span class=lnt id=hl-442-6><a class=lnlinks href=#hl-442-6> 6</a>
</span><span class=lnt id=hl-442-7><a class=lnlinks href=#hl-442-7> 7</a>
</span><span class=lnt id=hl-442-8><a class=lnlinks href=#hl-442-8> 8</a>
</span><span class=lnt id=hl-442-9><a class=lnlinks href=#hl-442-9> 9</a>
</span><span class=lnt id=hl-442-10><a class=lnlinks href=#hl-442-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JAVA data-lang=JAVA><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DataContainerStamped</span><span class=w> </span><span class=n>dataContainer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataContainerStamped</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-443-1><a class=lnlinks href=#hl-443-1>1</a>
</span><span class=lnt id=hl-443-2><a class=lnlinks href=#hl-443-2>2</a>
</span><span class=lnt id=hl-443-3><a class=lnlinks href=#hl-443-3>3</a>
</span><span class=lnt id=hl-443-4><a class=lnlinks href=#hl-443-4>4</a>
</span><span class=lnt id=hl-443-5><a class=lnlinks href=#hl-443-5>5</a>
</span><span class=lnt id=hl-443-6><a class=lnlinks href=#hl-443-6>6</a>
</span><span class=lnt id=hl-443-7><a class=lnlinks href=#hl-443-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SH data-lang=SH><span class=line><span class=cl>15:57:00.219 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - optimistic <span class=nb>read</span> locking...256 
</span></span><span class=line><span class=cl>15:57:00.717 c.DataContainerStamped <span class=o>[</span>t2<span class=o>]</span> - write lock <span class=m>384</span> 
</span></span><span class=line><span class=cl>15:57:01.225 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - updating to <span class=nb>read</span> lock... <span class=m>256</span> 
</span></span><span class=line><span class=cl>15:57:02.719 c.DataContainerStamped <span class=o>[</span>t2<span class=o>]</span> - write unlock <span class=m>384</span> 
</span></span><span class=line><span class=cl>15:57:02.719 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - <span class=nb>read</span> lock <span class=m>513</span> 
</span></span><span class=line><span class=cl>15:57:03.719 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - <span class=nb>read</span> finish...513, data:1000 
</span></span><span class=line><span class=cl>15:57:03.719 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - <span class=nb>read</span> unlock <span class=m>513</span> 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p><ul><li>StampedLock 不支持条件变量</li><li>StampedLock 不支持可重入</li></ul></blockquote><h2 id=semaphore><a href=#semaphore class=header-anchor>#</a>
Semaphore</h2><h3 id=基本使用-1><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8-1 class=header-anchor>#</a>
基本使用</h3><p>[ˈsɛməˌfɔr] 信号量，用来限制能同时访问共享资源的线程上限。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-444-1><a class=lnlinks href=#hl-444-1> 1</a>
</span><span class=lnt id=hl-444-2><a class=lnlinks href=#hl-444-2> 2</a>
</span><span class=lnt id=hl-444-3><a class=lnlinks href=#hl-444-3> 3</a>
</span><span class=lnt id=hl-444-4><a class=lnlinks href=#hl-444-4> 4</a>
</span><span class=lnt id=hl-444-5><a class=lnlinks href=#hl-444-5> 5</a>
</span><span class=lnt id=hl-444-6><a class=lnlinks href=#hl-444-6> 6</a>
</span><span class=lnt id=hl-444-7><a class=lnlinks href=#hl-444-7> 7</a>
</span><span class=lnt id=hl-444-8><a class=lnlinks href=#hl-444-8> 8</a>
</span><span class=lnt id=hl-444-9><a class=lnlinks href=#hl-444-9> 9</a>
</span><span class=lnt id=hl-444-10><a class=lnlinks href=#hl-444-10>10</a>
</span><span class=lnt id=hl-444-11><a class=lnlinks href=#hl-444-11>11</a>
</span><span class=lnt id=hl-444-12><a class=lnlinks href=#hl-444-12>12</a>
</span><span class=lnt id=hl-444-13><a class=lnlinks href=#hl-444-13>13</a>
</span><span class=lnt id=hl-444-14><a class=lnlinks href=#hl-444-14>14</a>
</span><span class=lnt id=hl-444-15><a class=lnlinks href=#hl-444-15>15</a>
</span><span class=lnt id=hl-444-16><a class=lnlinks href=#hl-444-16>16</a>
</span><span class=lnt id=hl-444-17><a class=lnlinks href=#hl-444-17>17</a>
</span><span class=lnt id=hl-444-18><a class=lnlinks href=#hl-444-18>18</a>
</span><span class=lnt id=hl-444-19><a class=lnlinks href=#hl-444-19>19</a>
</span><span class=lnt id=hl-444-20><a class=lnlinks href=#hl-444-20>20</a>
</span><span class=lnt id=hl-444-21><a class=lnlinks href=#hl-444-21>21</a>
</span><span class=lnt id=hl-444-22><a class=lnlinks href=#hl-444-22>22</a>
</span><span class=lnt id=hl-444-23><a class=lnlinks href=#hl-444-23>23</a>
</span><span class=lnt id=hl-444-24><a class=lnlinks href=#hl-444-24>24</a>
</span><span class=lnt id=hl-444-25><a class=lnlinks href=#hl-444-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1. 创建 semaphore 对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Semaphore</span><span class=w> </span><span class=n>semaphore</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Semaphore</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2. 10个线程同时运行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 3. 获取许可</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>semaphore</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//对于非打断式获取，如果此过程中被打断，线程依旧会等到获取了信号量之后才进入catch块。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//catch块中的线程依旧持有信号量，捕获该异常后catch块可以不做任何处理。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 4. 释放许可</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>semaphore</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-445-1><a class=lnlinks href=#hl-445-1> 1</a>
</span><span class=lnt id=hl-445-2><a class=lnlinks href=#hl-445-2> 2</a>
</span><span class=lnt id=hl-445-3><a class=lnlinks href=#hl-445-3> 3</a>
</span><span class=lnt id=hl-445-4><a class=lnlinks href=#hl-445-4> 4</a>
</span><span class=lnt id=hl-445-5><a class=lnlinks href=#hl-445-5> 5</a>
</span><span class=lnt id=hl-445-6><a class=lnlinks href=#hl-445-6> 6</a>
</span><span class=lnt id=hl-445-7><a class=lnlinks href=#hl-445-7> 7</a>
</span><span class=lnt id=hl-445-8><a class=lnlinks href=#hl-445-8> 8</a>
</span><span class=lnt id=hl-445-9><a class=lnlinks href=#hl-445-9> 9</a>
</span><span class=lnt id=hl-445-10><a class=lnlinks href=#hl-445-10>10</a>
</span><span class=lnt id=hl-445-11><a class=lnlinks href=#hl-445-11>11</a>
</span><span class=lnt id=hl-445-12><a class=lnlinks href=#hl-445-12>12</a>
</span><span class=lnt id=hl-445-13><a class=lnlinks href=#hl-445-13>13</a>
</span><span class=lnt id=hl-445-14><a class=lnlinks href=#hl-445-14>14</a>
</span><span class=lnt id=hl-445-15><a class=lnlinks href=#hl-445-15>15</a>
</span><span class=lnt id=hl-445-16><a class=lnlinks href=#hl-445-16>16</a>
</span><span class=lnt id=hl-445-17><a class=lnlinks href=#hl-445-17>17</a>
</span><span class=lnt id=hl-445-18><a class=lnlinks href=#hl-445-18>18</a>
</span><span class=lnt id=hl-445-19><a class=lnlinks href=#hl-445-19>19</a>
</span><span class=lnt id=hl-445-20><a class=lnlinks href=#hl-445-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>07:35:15.485 c.TestSemaphore <span class=o>[</span>Thread-2<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:15.485 c.TestSemaphore <span class=o>[</span>Thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:15.485 c.TestSemaphore <span class=o>[</span>Thread-0<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-2<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-0<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-1<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-3<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-5<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-4<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-5<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-4<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-3<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-6<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-7<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-9<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:18.491 c.TestSemaphore <span class=o>[</span>Thread-6<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:18.491 c.TestSemaphore <span class=o>[</span>Thread-7<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:18.491 c.TestSemaphore <span class=o>[</span>Thread-9<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:18.491 c.TestSemaphore <span class=o>[</span>Thread-8<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:19.492 c.TestSemaphore <span class=o>[</span>Thread-8<span class=o>]</span> - end... 
</span></span></code></pre></td></tr></table></div></div><p>说明：</p><ul><li>Semaphore有两个构造器：<code>Semaphore(int permits)</code>和<code>Semaphore(int permits,boolean fair)</code></li><li>permits表示允许同时访问共享资源的线程数。</li><li>fair表示公平与否，与之前的ReentrantLock一样。</li></ul><h3 id=font-colorgreen-semaphore-应用font><a href=#font-colorgreen-semaphore-%e5%ba%94%e7%94%a8font class=header-anchor>#</a>
<font color=green>* Semaphore 应用</font></h3><p>semaphore 限制对共享资源的使用</p><ul><li>使用 Semaphore 限流，在访问高峰期时，让请求线程阻塞，高峰期过去再释放许可，当然它只适合限制单机 线程数量，并且仅是限制线程数，而不是限制资源数（例如连接数，请对比 Tomcat LimitLatch 的实现）</li><li>用 Semaphore 实现简单连接池，对比『享元模式』下的实现（用wait notify），性能和可读性显然更好， 注意下面的实现中线程数和数据库连接数是相等的</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-446-1><a class=lnlinks href=#hl-446-1> 1</a>
</span><span class=lnt id=hl-446-2><a class=lnlinks href=#hl-446-2> 2</a>
</span><span class=lnt id=hl-446-3><a class=lnlinks href=#hl-446-3> 3</a>
</span><span class=lnt id=hl-446-4><a class=lnlinks href=#hl-446-4> 4</a>
</span><span class=lnt id=hl-446-5><a class=lnlinks href=#hl-446-5> 5</a>
</span><span class=lnt id=hl-446-6><a class=lnlinks href=#hl-446-6> 6</a>
</span><span class=lnt id=hl-446-7><a class=lnlinks href=#hl-446-7> 7</a>
</span><span class=lnt id=hl-446-8><a class=lnlinks href=#hl-446-8> 8</a>
</span><span class=lnt id=hl-446-9><a class=lnlinks href=#hl-446-9> 9</a>
</span><span class=lnt id=hl-446-10><a class=lnlinks href=#hl-446-10>10</a>
</span><span class=lnt id=hl-446-11><a class=lnlinks href=#hl-446-11>11</a>
</span><span class=lnt id=hl-446-12><a class=lnlinks href=#hl-446-12>12</a>
</span><span class=lnt id=hl-446-13><a class=lnlinks href=#hl-446-13>13</a>
</span><span class=lnt id=hl-446-14><a class=lnlinks href=#hl-446-14>14</a>
</span><span class=lnt id=hl-446-15><a class=lnlinks href=#hl-446-15>15</a>
</span><span class=lnt id=hl-446-16><a class=lnlinks href=#hl-446-16>16</a>
</span><span class=lnt id=hl-446-17><a class=lnlinks href=#hl-446-17>17</a>
</span><span class=lnt id=hl-446-18><a class=lnlinks href=#hl-446-18>18</a>
</span><span class=lnt id=hl-446-19><a class=lnlinks href=#hl-446-19>19</a>
</span><span class=lnt id=hl-446-20><a class=lnlinks href=#hl-446-20>20</a>
</span><span class=lnt id=hl-446-21><a class=lnlinks href=#hl-446-21>21</a>
</span><span class=lnt id=hl-446-22><a class=lnlinks href=#hl-446-22>22</a>
</span><span class=lnt id=hl-446-23><a class=lnlinks href=#hl-446-23>23</a>
</span><span class=lnt id=hl-446-24><a class=lnlinks href=#hl-446-24>24</a>
</span><span class=lnt id=hl-446-25><a class=lnlinks href=#hl-446-25>25</a>
</span><span class=lnt id=hl-446-26><a class=lnlinks href=#hl-446-26>26</a>
</span><span class=lnt id=hl-446-27><a class=lnlinks href=#hl-446-27>27</a>
</span><span class=lnt id=hl-446-28><a class=lnlinks href=#hl-446-28>28</a>
</span><span class=lnt id=hl-446-29><a class=lnlinks href=#hl-446-29>29</a>
</span><span class=lnt id=hl-446-30><a class=lnlinks href=#hl-446-30>30</a>
</span><span class=lnt id=hl-446-31><a class=lnlinks href=#hl-446-31>31</a>
</span><span class=lnt id=hl-446-32><a class=lnlinks href=#hl-446-32>32</a>
</span><span class=lnt id=hl-446-33><a class=lnlinks href=#hl-446-33>33</a>
</span><span class=lnt id=hl-446-34><a class=lnlinks href=#hl-446-34>34</a>
</span><span class=lnt id=hl-446-35><a class=lnlinks href=#hl-446-35>35</a>
</span><span class=lnt id=hl-446-36><a class=lnlinks href=#hl-446-36>36</a>
</span><span class=lnt id=hl-446-37><a class=lnlinks href=#hl-446-37>37</a>
</span><span class=lnt id=hl-446-38><a class=lnlinks href=#hl-446-38>38</a>
</span><span class=lnt id=hl-446-39><a class=lnlinks href=#hl-446-39>39</a>
</span><span class=lnt id=hl-446-40><a class=lnlinks href=#hl-446-40>40</a>
</span><span class=lnt id=hl-446-41><a class=lnlinks href=#hl-446-41>41</a>
</span><span class=lnt id=hl-446-42><a class=lnlinks href=#hl-446-42>42</a>
</span><span class=lnt id=hl-446-43><a class=lnlinks href=#hl-446-43>43</a>
</span><span class=lnt id=hl-446-44><a class=lnlinks href=#hl-446-44>44</a>
</span><span class=lnt id=hl-446-45><a class=lnlinks href=#hl-446-45>45</a>
</span><span class=lnt id=hl-446-46><a class=lnlinks href=#hl-446-46>46</a>
</span><span class=lnt id=hl-446-47><a class=lnlinks href=#hl-446-47>47</a>
</span><span class=lnt id=hl-446-48><a class=lnlinks href=#hl-446-48>48</a>
</span><span class=lnt id=hl-446-49><a class=lnlinks href=#hl-446-49>49</a>
</span><span class=lnt id=hl-446-50><a class=lnlinks href=#hl-446-50>50</a>
</span><span class=lnt id=hl-446-51><a class=lnlinks href=#hl-446-51>51</a>
</span><span class=lnt id=hl-446-52><a class=lnlinks href=#hl-446-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Pool&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Pool</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1. 连接池大小</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2. 连接对象数组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Connection</span><span class=o>[]</span><span class=w> </span><span class=n>connections</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 3. 连接状态数组 0 表示空闲， 1 表示繁忙</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AtomicIntegerArray</span><span class=w> </span><span class=n>states</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Semaphore</span><span class=w> </span><span class=n>semaphore</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 4. 构造方法初始化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Pool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>poolSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>poolSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 让许可数与资源数一致</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>semaphore</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Semaphore</span><span class=p>(</span><span class=n>poolSize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>connections</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Connection</span><span class=o>[</span><span class=n>poolSize</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>states</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicIntegerArray</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>poolSize</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MockConnection</span><span class=p>(</span><span class=s>&#34;连接&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 5. 借连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=nf>borrow</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=c1>// t1, t2, t3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取许可</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>semaphore</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w> </span><span class=c1>// 没有许可的线程，在此等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获取空闲连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>states</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>states</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;borrow {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 不会执行到这里</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 6. 归还连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>free</span><span class=p>(</span><span class=n>Connection</span><span class=w> </span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>states</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;free {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>semaphore</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=font-colorblue-semaphore-原理font><a href=#font-colorblue-semaphore-%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>* Semaphore 原理</font></h3><h4 id=加锁解锁流程-1><a href=#%e5%8a%a0%e9%94%81%e8%a7%a3%e9%94%81%e6%b5%81%e7%a8%8b-1 class=header-anchor>#</a>
加锁解锁流程</h4><p>Semaphore有点像一个停车场，permits就好像停车位数量，当线程获得了permits就像是获得了停车位，然后停车场显示空余车位减一。</p><p>刚开始，permits（state）为 3，这时 5 个线程来获取资源</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220315211610470.png width=900 height=600 loading=lazy decoding=async alt=image-20220315211610470 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>假设其中 Thread-1，Thread-2，Thread-4 cas 竞争成功，而 Thread-0 和 Thread-3 竞争失败，进入 AQS 队列 park 阻塞</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220315211646132.png width=900 height=600 loading=lazy decoding=async alt=image-20220315211646132 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>这时 Thread-4 释放了 permits，状态如下</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220315211712384.png width=900 height=600 loading=lazy decoding=async alt=image-20220315211712384 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>接下来 Thread-0 竞争成功，permits 再次设置为 0，设置自己为 head 节点，断开原来的 head 节点，unpark 接 下来的 Thread-3 节点，但由于 permits 是 0，因此 Thread-3 在尝试不成功后再次进入 park 状态</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220315211741166.png width=900 height=600 loading=lazy decoding=async alt=image-20220315211741166 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=源码分析-1><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-1 class=header-anchor>#</a>
源码分析</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-447-1><a class=lnlinks href=#hl-447-1>  1</a>
</span><span class=lnt id=hl-447-2><a class=lnlinks href=#hl-447-2>  2</a>
</span><span class=lnt id=hl-447-3><a class=lnlinks href=#hl-447-3>  3</a>
</span><span class=lnt id=hl-447-4><a class=lnlinks href=#hl-447-4>  4</a>
</span><span class=lnt id=hl-447-5><a class=lnlinks href=#hl-447-5>  5</a>
</span><span class=lnt id=hl-447-6><a class=lnlinks href=#hl-447-6>  6</a>
</span><span class=lnt id=hl-447-7><a class=lnlinks href=#hl-447-7>  7</a>
</span><span class=lnt id=hl-447-8><a class=lnlinks href=#hl-447-8>  8</a>
</span><span class=lnt id=hl-447-9><a class=lnlinks href=#hl-447-9>  9</a>
</span><span class=lnt id=hl-447-10><a class=lnlinks href=#hl-447-10> 10</a>
</span><span class=lnt id=hl-447-11><a class=lnlinks href=#hl-447-11> 11</a>
</span><span class=lnt id=hl-447-12><a class=lnlinks href=#hl-447-12> 12</a>
</span><span class=lnt id=hl-447-13><a class=lnlinks href=#hl-447-13> 13</a>
</span><span class=lnt id=hl-447-14><a class=lnlinks href=#hl-447-14> 14</a>
</span><span class=lnt id=hl-447-15><a class=lnlinks href=#hl-447-15> 15</a>
</span><span class=lnt id=hl-447-16><a class=lnlinks href=#hl-447-16> 16</a>
</span><span class=lnt id=hl-447-17><a class=lnlinks href=#hl-447-17> 17</a>
</span><span class=lnt id=hl-447-18><a class=lnlinks href=#hl-447-18> 18</a>
</span><span class=lnt id=hl-447-19><a class=lnlinks href=#hl-447-19> 19</a>
</span><span class=lnt id=hl-447-20><a class=lnlinks href=#hl-447-20> 20</a>
</span><span class=lnt id=hl-447-21><a class=lnlinks href=#hl-447-21> 21</a>
</span><span class=lnt id=hl-447-22><a class=lnlinks href=#hl-447-22> 22</a>
</span><span class=lnt id=hl-447-23><a class=lnlinks href=#hl-447-23> 23</a>
</span><span class=lnt id=hl-447-24><a class=lnlinks href=#hl-447-24> 24</a>
</span><span class=lnt id=hl-447-25><a class=lnlinks href=#hl-447-25> 25</a>
</span><span class=lnt id=hl-447-26><a class=lnlinks href=#hl-447-26> 26</a>
</span><span class=lnt id=hl-447-27><a class=lnlinks href=#hl-447-27> 27</a>
</span><span class=lnt id=hl-447-28><a class=lnlinks href=#hl-447-28> 28</a>
</span><span class=lnt id=hl-447-29><a class=lnlinks href=#hl-447-29> 29</a>
</span><span class=lnt id=hl-447-30><a class=lnlinks href=#hl-447-30> 30</a>
</span><span class=lnt id=hl-447-31><a class=lnlinks href=#hl-447-31> 31</a>
</span><span class=lnt id=hl-447-32><a class=lnlinks href=#hl-447-32> 32</a>
</span><span class=lnt id=hl-447-33><a class=lnlinks href=#hl-447-33> 33</a>
</span><span class=lnt id=hl-447-34><a class=lnlinks href=#hl-447-34> 34</a>
</span><span class=lnt id=hl-447-35><a class=lnlinks href=#hl-447-35> 35</a>
</span><span class=lnt id=hl-447-36><a class=lnlinks href=#hl-447-36> 36</a>
</span><span class=lnt id=hl-447-37><a class=lnlinks href=#hl-447-37> 37</a>
</span><span class=lnt id=hl-447-38><a class=lnlinks href=#hl-447-38> 38</a>
</span><span class=lnt id=hl-447-39><a class=lnlinks href=#hl-447-39> 39</a>
</span><span class=lnt id=hl-447-40><a class=lnlinks href=#hl-447-40> 40</a>
</span><span class=lnt id=hl-447-41><a class=lnlinks href=#hl-447-41> 41</a>
</span><span class=lnt id=hl-447-42><a class=lnlinks href=#hl-447-42> 42</a>
</span><span class=lnt id=hl-447-43><a class=lnlinks href=#hl-447-43> 43</a>
</span><span class=lnt id=hl-447-44><a class=lnlinks href=#hl-447-44> 44</a>
</span><span class=lnt id=hl-447-45><a class=lnlinks href=#hl-447-45> 45</a>
</span><span class=lnt id=hl-447-46><a class=lnlinks href=#hl-447-46> 46</a>
</span><span class=lnt id=hl-447-47><a class=lnlinks href=#hl-447-47> 47</a>
</span><span class=lnt id=hl-447-48><a class=lnlinks href=#hl-447-48> 48</a>
</span><span class=lnt id=hl-447-49><a class=lnlinks href=#hl-447-49> 49</a>
</span><span class=lnt id=hl-447-50><a class=lnlinks href=#hl-447-50> 50</a>
</span><span class=lnt id=hl-447-51><a class=lnlinks href=#hl-447-51> 51</a>
</span><span class=lnt id=hl-447-52><a class=lnlinks href=#hl-447-52> 52</a>
</span><span class=lnt id=hl-447-53><a class=lnlinks href=#hl-447-53> 53</a>
</span><span class=lnt id=hl-447-54><a class=lnlinks href=#hl-447-54> 54</a>
</span><span class=lnt id=hl-447-55><a class=lnlinks href=#hl-447-55> 55</a>
</span><span class=lnt id=hl-447-56><a class=lnlinks href=#hl-447-56> 56</a>
</span><span class=lnt id=hl-447-57><a class=lnlinks href=#hl-447-57> 57</a>
</span><span class=lnt id=hl-447-58><a class=lnlinks href=#hl-447-58> 58</a>
</span><span class=lnt id=hl-447-59><a class=lnlinks href=#hl-447-59> 59</a>
</span><span class=lnt id=hl-447-60><a class=lnlinks href=#hl-447-60> 60</a>
</span><span class=lnt id=hl-447-61><a class=lnlinks href=#hl-447-61> 61</a>
</span><span class=lnt id=hl-447-62><a class=lnlinks href=#hl-447-62> 62</a>
</span><span class=lnt id=hl-447-63><a class=lnlinks href=#hl-447-63> 63</a>
</span><span class=lnt id=hl-447-64><a class=lnlinks href=#hl-447-64> 64</a>
</span><span class=lnt id=hl-447-65><a class=lnlinks href=#hl-447-65> 65</a>
</span><span class=lnt id=hl-447-66><a class=lnlinks href=#hl-447-66> 66</a>
</span><span class=lnt id=hl-447-67><a class=lnlinks href=#hl-447-67> 67</a>
</span><span class=lnt id=hl-447-68><a class=lnlinks href=#hl-447-68> 68</a>
</span><span class=lnt id=hl-447-69><a class=lnlinks href=#hl-447-69> 69</a>
</span><span class=lnt id=hl-447-70><a class=lnlinks href=#hl-447-70> 70</a>
</span><span class=lnt id=hl-447-71><a class=lnlinks href=#hl-447-71> 71</a>
</span><span class=lnt id=hl-447-72><a class=lnlinks href=#hl-447-72> 72</a>
</span><span class=lnt id=hl-447-73><a class=lnlinks href=#hl-447-73> 73</a>
</span><span class=lnt id=hl-447-74><a class=lnlinks href=#hl-447-74> 74</a>
</span><span class=lnt id=hl-447-75><a class=lnlinks href=#hl-447-75> 75</a>
</span><span class=lnt id=hl-447-76><a class=lnlinks href=#hl-447-76> 76</a>
</span><span class=lnt id=hl-447-77><a class=lnlinks href=#hl-447-77> 77</a>
</span><span class=lnt id=hl-447-78><a class=lnlinks href=#hl-447-78> 78</a>
</span><span class=lnt id=hl-447-79><a class=lnlinks href=#hl-447-79> 79</a>
</span><span class=lnt id=hl-447-80><a class=lnlinks href=#hl-447-80> 80</a>
</span><span class=lnt id=hl-447-81><a class=lnlinks href=#hl-447-81> 81</a>
</span><span class=lnt id=hl-447-82><a class=lnlinks href=#hl-447-82> 82</a>
</span><span class=lnt id=hl-447-83><a class=lnlinks href=#hl-447-83> 83</a>
</span><span class=lnt id=hl-447-84><a class=lnlinks href=#hl-447-84> 84</a>
</span><span class=lnt id=hl-447-85><a class=lnlinks href=#hl-447-85> 85</a>
</span><span class=lnt id=hl-447-86><a class=lnlinks href=#hl-447-86> 86</a>
</span><span class=lnt id=hl-447-87><a class=lnlinks href=#hl-447-87> 87</a>
</span><span class=lnt id=hl-447-88><a class=lnlinks href=#hl-447-88> 88</a>
</span><span class=lnt id=hl-447-89><a class=lnlinks href=#hl-447-89> 89</a>
</span><span class=lnt id=hl-447-90><a class=lnlinks href=#hl-447-90> 90</a>
</span><span class=lnt id=hl-447-91><a class=lnlinks href=#hl-447-91> 91</a>
</span><span class=lnt id=hl-447-92><a class=lnlinks href=#hl-447-92> 92</a>
</span><span class=lnt id=hl-447-93><a class=lnlinks href=#hl-447-93> 93</a>
</span><span class=lnt id=hl-447-94><a class=lnlinks href=#hl-447-94> 94</a>
</span><span class=lnt id=hl-447-95><a class=lnlinks href=#hl-447-95> 95</a>
</span><span class=lnt id=hl-447-96><a class=lnlinks href=#hl-447-96> 96</a>
</span><span class=lnt id=hl-447-97><a class=lnlinks href=#hl-447-97> 97</a>
</span><span class=lnt id=hl-447-98><a class=lnlinks href=#hl-447-98> 98</a>
</span><span class=lnt id=hl-447-99><a class=lnlinks href=#hl-447-99> 99</a>
</span><span class=lnt id=hl-447-100><a class=lnlinks href=#hl-447-100>100</a>
</span><span class=lnt id=hl-447-101><a class=lnlinks href=#hl-447-101>101</a>
</span><span class=lnt id=hl-447-102><a class=lnlinks href=#hl-447-102>102</a>
</span><span class=lnt id=hl-447-103><a class=lnlinks href=#hl-447-103>103</a>
</span><span class=lnt id=hl-447-104><a class=lnlinks href=#hl-447-104>104</a>
</span><span class=lnt id=hl-447-105><a class=lnlinks href=#hl-447-105>105</a>
</span><span class=lnt id=hl-447-106><a class=lnlinks href=#hl-447-106>106</a>
</span><span class=lnt id=hl-447-107><a class=lnlinks href=#hl-447-107>107</a>
</span><span class=lnt id=hl-447-108><a class=lnlinks href=#hl-447-108>108</a>
</span><span class=lnt id=hl-447-109><a class=lnlinks href=#hl-447-109>109</a>
</span><span class=lnt id=hl-447-110><a class=lnlinks href=#hl-447-110>110</a>
</span><span class=lnt id=hl-447-111><a class=lnlinks href=#hl-447-111>111</a>
</span><span class=lnt id=hl-447-112><a class=lnlinks href=#hl-447-112>112</a>
</span><span class=lnt id=hl-447-113><a class=lnlinks href=#hl-447-113>113</a>
</span><span class=lnt id=hl-447-114><a class=lnlinks href=#hl-447-114>114</a>
</span><span class=lnt id=hl-447-115><a class=lnlinks href=#hl-447-115>115</a>
</span><span class=lnt id=hl-447-116><a class=lnlinks href=#hl-447-116>116</a>
</span><span class=lnt id=hl-447-117><a class=lnlinks href=#hl-447-117>117</a>
</span><span class=lnt id=hl-447-118><a class=lnlinks href=#hl-447-118>118</a>
</span><span class=lnt id=hl-447-119><a class=lnlinks href=#hl-447-119>119</a>
</span><span class=lnt id=hl-447-120><a class=lnlinks href=#hl-447-120>120</a>
</span><span class=lnt id=hl-447-121><a class=lnlinks href=#hl-447-121>121</a>
</span><span class=lnt id=hl-447-122><a class=lnlinks href=#hl-447-122>122</a>
</span><span class=lnt id=hl-447-123><a class=lnlinks href=#hl-447-123>123</a>
</span><span class=lnt id=hl-447-124><a class=lnlinks href=#hl-447-124>124</a>
</span><span class=lnt id=hl-447-125><a class=lnlinks href=#hl-447-125>125</a>
</span><span class=lnt id=hl-447-126><a class=lnlinks href=#hl-447-126>126</a>
</span><span class=lnt id=hl-447-127><a class=lnlinks href=#hl-447-127>127</a>
</span><span class=lnt id=hl-447-128><a class=lnlinks href=#hl-447-128>128</a>
</span><span class=lnt id=hl-447-129><a class=lnlinks href=#hl-447-129>129</a>
</span><span class=lnt id=hl-447-130><a class=lnlinks href=#hl-447-130>130</a>
</span><span class=lnt id=hl-447-131><a class=lnlinks href=#hl-447-131>131</a>
</span><span class=lnt id=hl-447-132><a class=lnlinks href=#hl-447-132>132</a>
</span><span class=lnt id=hl-447-133><a class=lnlinks href=#hl-447-133>133</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>2694183684443567898L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NonfairSync</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>permits</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// permits 即 state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>permits</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Semaphore 方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>acquireSharedInterruptibly</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquireSharedInterruptibly</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryAcquireShared</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doAcquireSharedInterruptibly</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试获得共享锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>tryAcquireShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>nonfairTryAcquireShared</span><span class=p>(</span><span class=n>acquires</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>nonfairTryAcquireShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>available</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>remaining</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>available</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>acquires</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 如果许可已经用完, 返回负数, 表示获取失败, 进入 doAcquireSharedInterruptibly</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>remaining</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 如果 cas 重试成功, 返回正数, 表示获取成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>available</span><span class=p>,</span><span class=w> </span><span class=n>remaining</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>remaining</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doAcquireSharedInterruptibly</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>SHARED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>predecessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 再次尝试获取许可</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tryAcquireShared</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// 成功后本线程出队（AQS）, 所在 Node设置为 head</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// 如果 head.waitStatus == Node.SIGNAL ==&gt; 0 成功, 下一个节点 unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// 如果 head.waitStatus == 0 ==&gt; Node.PROPAGATE </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// r 表示可用资源数, 为 0 则不会继续传播</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>setHeadAndPropagate</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// help GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 不成功, 设置上一个节点 waitStatus = Node.SIGNAL, 下轮进入 park 阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>parkAndCheckInterrupt</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cancelAcquire</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Semaphore 方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>release</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>releaseShared</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>releaseShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryReleaseShared</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doReleaseShared</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync 继承过来的方法, 方便阅读, 放在此处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryReleaseShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>releases</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>releases</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>current</span><span class=p>)</span><span class=w> </span><span class=c1>// overflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum permit count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>current</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setHeadAndPropagate</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>propagate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w> </span><span class=c1>// Record old head for check below</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 设置自己为 head</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>setHead</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// propagate 表示有共享资源（例如共享读锁或信号量）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 原 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 现在 head waitStatus == Node.SIGNAL 或 Node.PROPAGATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>propagate</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果是最后一个节点或者是等待共享读锁的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>isShared</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doReleaseShared</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doReleaseShared</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>tail</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w>            </span><span class=c1>// loop to recheck cases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>PROPAGATE</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>continue</span><span class=p>;</span><span class=w>                </span><span class=c1>// loop on failed CAS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w>                   </span><span class=c1>// loop if head changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=加锁流程总结><a href=#%e5%8a%a0%e9%94%81%e6%b5%81%e7%a8%8b%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
加锁流程总结：</h5><ul><li><code>acquire</code>-><code>acquireSharedInterruptibly(1)</code>-><code>tryAcquireShared(1)</code>-><code>nonfairTryAcquireShared(1)</code>,如果资源用完了，返回负数，<code>tryAcquireShared</code>返回负数，表示失败。否则返回正数，<code>tryAcquireShared</code>返回正数,表示成功。<ul><li>如果成功，获取信号量成功。</li><li>如果失败，调用<code>doAcquireSharedInterruptibly</code>,进入for循环：<ul><li>如果当前驱节点为头节点，调用<code>tryAcquireShared</code>尝试获取锁<ul><li>如果结果大于等于0，表明获取锁成功，调用<code>setHeadAndPropagate</code>，将当前节点设为头节点，之后又调用<code>doReleaseShared</code>，唤醒后继节点。</li></ul></li><li>调用<code>shoudParkAfterFailure</code>,第一次调用返回false，并将前驱节点改为-1，第二次循环如果再进入此方法，会进入阻塞并检查打断的方法。</li></ul></li></ul></li></ul><h5 id=解锁流程总结><a href=#%e8%a7%a3%e9%94%81%e6%b5%81%e7%a8%8b%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
解锁流程总结：</h5><ul><li><code>release</code>-><code>sync.releaseShared(1)</code>-><code>tryReleaseShared(1)</code>,只要不发生整数溢出，就返回true<ul><li>如果返回true，调用<code>doReleaseShared</code>，唤醒后继节点。</li><li>如果返回false，解锁失败。</li></ul></li></ul><h4 id=为什么要有-propagate><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e6%9c%89-propagate class=header-anchor>#</a>
为什么要有 PROPAGATE</h4><h2 id=countdownlatch><a href=#countdownlatch class=header-anchor>#</a>
CountdownLatch</h2><p>用来进行线程同步协作，等待所有线程完成倒计时。</p><p>其中构造参数用来初始化等待计数值，await() 用来等待计数归零，countDown() 用来让计数减一</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-448-1><a class=lnlinks href=#hl-448-1> 1</a>
</span><span class=lnt id=hl-448-2><a class=lnlinks href=#hl-448-2> 2</a>
</span><span class=lnt id=hl-448-3><a class=lnlinks href=#hl-448-3> 3</a>
</span><span class=lnt id=hl-448-4><a class=lnlinks href=#hl-448-4> 4</a>
</span><span class=lnt id=hl-448-5><a class=lnlinks href=#hl-448-5> 5</a>
</span><span class=lnt id=hl-448-6><a class=lnlinks href=#hl-448-6> 6</a>
</span><span class=lnt id=hl-448-7><a class=lnlinks href=#hl-448-7> 7</a>
</span><span class=lnt id=hl-448-8><a class=lnlinks href=#hl-448-8> 8</a>
</span><span class=lnt id=hl-448-9><a class=lnlinks href=#hl-448-9> 9</a>
</span><span class=lnt id=hl-448-10><a class=lnlinks href=#hl-448-10>10</a>
</span><span class=lnt id=hl-448-11><a class=lnlinks href=#hl-448-11>11</a>
</span><span class=lnt id=hl-448-12><a class=lnlinks href=#hl-448-12>12</a>
</span><span class=lnt id=hl-448-13><a class=lnlinks href=#hl-448-13>13</a>
</span><span class=lnt id=hl-448-14><a class=lnlinks href=#hl-448-14>14</a>
</span><span class=lnt id=hl-448-15><a class=lnlinks href=#hl-448-15>15</a>
</span><span class=lnt id=hl-448-16><a class=lnlinks href=#hl-448-16>16</a>
</span><span class=lnt id=hl-448-17><a class=lnlinks href=#hl-448-17>17</a>
</span><span class=lnt id=hl-448-18><a class=lnlinks href=#hl-448-18>18</a>
</span><span class=lnt id=hl-448-19><a class=lnlinks href=#hl-448-19>19</a>
</span><span class=lnt id=hl-448-20><a class=lnlinks href=#hl-448-20>20</a>
</span><span class=lnt id=hl-448-21><a class=lnlinks href=#hl-448-21>21</a>
</span><span class=lnt id=hl-448-22><a class=lnlinks href=#hl-448-22>22</a>
</span><span class=lnt id=hl-448-23><a class=lnlinks href=#hl-448-23>23</a>
</span><span class=lnt id=hl-448-24><a class=lnlinks href=#hl-448-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>latch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;waiting...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>latch</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;wait end...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-449-1><a class=lnlinks href=#hl-449-1>1</a>
</span><span class=lnt id=hl-449-2><a class=lnlinks href=#hl-449-2>2</a>
</span><span class=lnt id=hl-449-3><a class=lnlinks href=#hl-449-3>3</a>
</span><span class=lnt id=hl-449-4><a class=lnlinks href=#hl-449-4>4</a>
</span><span class=lnt id=hl-449-5><a class=lnlinks href=#hl-449-5>5</a>
</span><span class=lnt id=hl-449-6><a class=lnlinks href=#hl-449-6>6</a>
</span><span class=lnt id=hl-449-7><a class=lnlinks href=#hl-449-7>7</a>
</span><span class=lnt id=hl-449-8><a class=lnlinks href=#hl-449-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:44:00.778 c.TestCountDownLatch <span class=o>[</span>main<span class=o>]</span> - waiting... 
</span></span><span class=line><span class=cl>18:44:00.778 c.TestCountDownLatch <span class=o>[</span>Thread-2<span class=o>]</span> - begin... 
</span></span><span class=line><span class=cl>18:44:00.778 c.TestCountDownLatch <span class=o>[</span>Thread-0<span class=o>]</span> - begin... 
</span></span><span class=line><span class=cl>18:44:00.778 c.TestCountDownLatch <span class=o>[</span>Thread-1<span class=o>]</span> - begin... 
</span></span><span class=line><span class=cl>18:44:01.782 c.TestCountDownLatch <span class=o>[</span>Thread-0<span class=o>]</span> - end...2 
</span></span><span class=line><span class=cl>18:44:02.283 c.TestCountDownLatch <span class=o>[</span>Thread-2<span class=o>]</span> - end...1 
</span></span><span class=line><span class=cl>18:44:02.782 c.TestCountDownLatch <span class=o>[</span>Thread-1<span class=o>]</span> - end...0 
</span></span><span class=line><span class=cl>18:44:02.782 c.TestCountDownLatch <span class=o>[</span>main<span class=o>]</span> - <span class=nb>wait</span> end... 
</span></span></code></pre></td></tr></table></div></div><p>相比于join，CountDownLatch能配合线程池使用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-450-1><a class=lnlinks href=#hl-450-1> 1</a>
</span><span class=lnt id=hl-450-2><a class=lnlinks href=#hl-450-2> 2</a>
</span><span class=lnt id=hl-450-3><a class=lnlinks href=#hl-450-3> 3</a>
</span><span class=lnt id=hl-450-4><a class=lnlinks href=#hl-450-4> 4</a>
</span><span class=lnt id=hl-450-5><a class=lnlinks href=#hl-450-5> 5</a>
</span><span class=lnt id=hl-450-6><a class=lnlinks href=#hl-450-6> 6</a>
</span><span class=lnt id=hl-450-7><a class=lnlinks href=#hl-450-7> 7</a>
</span><span class=lnt id=hl-450-8><a class=lnlinks href=#hl-450-8> 8</a>
</span><span class=lnt id=hl-450-9><a class=lnlinks href=#hl-450-9> 9</a>
</span><span class=lnt id=hl-450-10><a class=lnlinks href=#hl-450-10>10</a>
</span><span class=lnt id=hl-450-11><a class=lnlinks href=#hl-450-11>11</a>
</span><span class=lnt id=hl-450-12><a class=lnlinks href=#hl-450-12>12</a>
</span><span class=lnt id=hl-450-13><a class=lnlinks href=#hl-450-13>13</a>
</span><span class=lnt id=hl-450-14><a class=lnlinks href=#hl-450-14>14</a>
</span><span class=lnt id=hl-450-15><a class=lnlinks href=#hl-450-15>15</a>
</span><span class=lnt id=hl-450-16><a class=lnlinks href=#hl-450-16>16</a>
</span><span class=lnt id=hl-450-17><a class=lnlinks href=#hl-450-17>17</a>
</span><span class=lnt id=hl-450-18><a class=lnlinks href=#hl-450-18>18</a>
</span><span class=lnt id=hl-450-19><a class=lnlinks href=#hl-450-19>19</a>
</span><span class=lnt id=hl-450-20><a class=lnlinks href=#hl-450-20>20</a>
</span><span class=lnt id=hl-450-21><a class=lnlinks href=#hl-450-21>21</a>
</span><span class=lnt id=hl-450-22><a class=lnlinks href=#hl-450-22>22</a>
</span><span class=lnt id=hl-450-23><a class=lnlinks href=#hl-450-23>23</a>
</span><span class=lnt id=hl-450-24><a class=lnlinks href=#hl-450-24>24</a>
</span><span class=lnt id=hl-450-25><a class=lnlinks href=#hl-450-25>25</a>
</span><span class=lnt id=hl-450-26><a class=lnlinks href=#hl-450-26>26</a>
</span><span class=lnt id=hl-450-27><a class=lnlinks href=#hl-450-27>27</a>
</span><span class=lnt id=hl-450-28><a class=lnlinks href=#hl-450-28>28</a>
</span><span class=lnt id=hl-450-29><a class=lnlinks href=#hl-450-29>29</a>
</span><span class=lnt id=hl-450-30><a class=lnlinks href=#hl-450-30>30</a>
</span><span class=lnt id=hl-450-31><a class=lnlinks href=#hl-450-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>latch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;waiting...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>latch</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;wait end...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=font-colorgreen-应用之同步等待多线程准备完毕font><a href=#font-colorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e5%90%8c%e6%ad%a5%e7%ad%89%e5%be%85%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%87%86%e5%a4%87%e5%ae%8c%e6%af%95font class=header-anchor>#</a>
<font color=green>* 应用之同步等待多线程准备完毕</font></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-451-1><a class=lnlinks href=#hl-451-1> 1</a>
</span><span class=lnt id=hl-451-2><a class=lnlinks href=#hl-451-2> 2</a>
</span><span class=lnt id=hl-451-3><a class=lnlinks href=#hl-451-3> 3</a>
</span><span class=lnt id=hl-451-4><a class=lnlinks href=#hl-451-4> 4</a>
</span><span class=lnt id=hl-451-5><a class=lnlinks href=#hl-451-5> 5</a>
</span><span class=lnt id=hl-451-6><a class=lnlinks href=#hl-451-6> 6</a>
</span><span class=lnt id=hl-451-7><a class=lnlinks href=#hl-451-7> 7</a>
</span><span class=lnt id=hl-451-8><a class=lnlinks href=#hl-451-8> 8</a>
</span><span class=lnt id=hl-451-9><a class=lnlinks href=#hl-451-9> 9</a>
</span><span class=lnt id=hl-451-10><a class=lnlinks href=#hl-451-10>10</a>
</span><span class=lnt id=hl-451-11><a class=lnlinks href=#hl-451-11>11</a>
</span><span class=lnt id=hl-451-12><a class=lnlinks href=#hl-451-12>12</a>
</span><span class=lnt id=hl-451-13><a class=lnlinks href=#hl-451-13>13</a>
</span><span class=lnt id=hl-451-14><a class=lnlinks href=#hl-451-14>14</a>
</span><span class=lnt id=hl-451-15><a class=lnlinks href=#hl-451-15>15</a>
</span><span class=lnt id=hl-451-16><a class=lnlinks href=#hl-451-16>16</a>
</span><span class=lnt id=hl-451-17><a class=lnlinks href=#hl-451-17>17</a>
</span><span class=lnt id=hl-451-18><a class=lnlinks href=#hl-451-18>18</a>
</span><span class=lnt id=hl-451-19><a class=lnlinks href=#hl-451-19>19</a>
</span><span class=lnt id=hl-451-20><a class=lnlinks href=#hl-451-20>20</a>
</span><span class=lnt id=hl-451-21><a class=lnlinks href=#hl-451-21>21</a>
</span><span class=lnt id=hl-451-22><a class=lnlinks href=#hl-451-22>22</a>
</span><span class=lnt id=hl-451-23><a class=lnlinks href=#hl-451-23>23</a>
</span><span class=lnt id=hl-451-24><a class=lnlinks href=#hl-451-24>24</a>
</span><span class=lnt id=hl-451-25><a class=lnlinks href=#hl-451-25>25</a>
</span><span class=lnt id=hl-451-26><a class=lnlinks href=#hl-451-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>AtomicInteger</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>latch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>all</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[</span><span class=n>10</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Random</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//随机休眠，模拟网络延迟</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>100</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>all</span><span class=o>[</span><span class=n>x</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;(&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;%&#34;</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;)&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//\r可以让当前输出覆盖上一次的输出。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;\r&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>all</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>latch</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;\n游戏开始...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>service</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>中间输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-452-1><a class=lnlinks href=#hl-452-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>t0<span class=o>(</span>52%<span class=o>)</span>, t1<span class=o>(</span>47%<span class=o>)</span>, t2<span class=o>(</span>51%<span class=o>)</span>, t3<span class=o>(</span>40%<span class=o>)</span>, t4<span class=o>(</span>49%<span class=o>)</span>, t5<span class=o>(</span>44%<span class=o>)</span>, t6<span class=o>(</span>49%<span class=o>)</span>, t7<span class=o>(</span>52%<span class=o>)</span>, t8<span class=o>(</span>46%<span class=o>)</span>, t9<span class=o>(</span>46%<span class=o>)]</span> 
</span></span></code></pre></td></tr></table></div></div><p>最后输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-453-1><a class=lnlinks href=#hl-453-1>1</a>
</span><span class=lnt id=hl-453-2><a class=lnlinks href=#hl-453-2>2</a>
</span><span class=lnt id=hl-453-3><a class=lnlinks href=#hl-453-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>t0<span class=o>(</span>100%<span class=o>)</span>, t1<span class=o>(</span>100%<span class=o>)</span>, t2<span class=o>(</span>100%<span class=o>)</span>, t3<span class=o>(</span>100%<span class=o>)</span>, t4<span class=o>(</span>100%<span class=o>)</span>, t5<span class=o>(</span>100%<span class=o>)</span>, t6<span class=o>(</span>100%<span class=o>)</span>, t7<span class=o>(</span>100%<span class=o>)</span>, t8<span class=o>(</span>100%<span class=o>)</span>, 
</span></span><span class=line><span class=cl>t9<span class=o>(</span>100%<span class=o>)]</span> 
</span></span><span class=line><span class=cl>游戏开始... 
</span></span></code></pre></td></tr></table></div></div><h3 id=font-colorgreen-应用之同步等待多个远程调用结束font><a href=#font-colorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e5%90%8c%e6%ad%a5%e7%ad%89%e5%be%85%e5%a4%9a%e4%b8%aa%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8%e7%bb%93%e6%9d%9ffont class=header-anchor>#</a>
<font color=green>* 应用之同步等待多个远程调用结束</font></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-454-1><a class=lnlinks href=#hl-454-1> 1</a>
</span><span class=lnt id=hl-454-2><a class=lnlinks href=#hl-454-2> 2</a>
</span><span class=lnt id=hl-454-3><a class=lnlinks href=#hl-454-3> 3</a>
</span><span class=lnt id=hl-454-4><a class=lnlinks href=#hl-454-4> 4</a>
</span><span class=lnt id=hl-454-5><a class=lnlinks href=#hl-454-5> 5</a>
</span><span class=lnt id=hl-454-6><a class=lnlinks href=#hl-454-6> 6</a>
</span><span class=lnt id=hl-454-7><a class=lnlinks href=#hl-454-7> 7</a>
</span><span class=lnt id=hl-454-8><a class=lnlinks href=#hl-454-8> 8</a>
</span><span class=lnt id=hl-454-9><a class=lnlinks href=#hl-454-9> 9</a>
</span><span class=lnt id=hl-454-10><a class=lnlinks href=#hl-454-10>10</a>
</span><span class=lnt id=hl-454-11><a class=lnlinks href=#hl-454-11>11</a>
</span><span class=lnt id=hl-454-12><a class=lnlinks href=#hl-454-12>12</a>
</span><span class=lnt id=hl-454-13><a class=lnlinks href=#hl-454-13>13</a>
</span><span class=lnt id=hl-454-14><a class=lnlinks href=#hl-454-14>14</a>
</span><span class=lnt id=hl-454-15><a class=lnlinks href=#hl-454-15>15</a>
</span><span class=lnt id=hl-454-16><a class=lnlinks href=#hl-454-16>16</a>
</span><span class=lnt id=hl-454-17><a class=lnlinks href=#hl-454-17>17</a>
</span><span class=lnt id=hl-454-18><a class=lnlinks href=#hl-454-18>18</a>
</span><span class=lnt id=hl-454-19><a class=lnlinks href=#hl-454-19>19</a>
</span><span class=lnt id=hl-454-20><a class=lnlinks href=#hl-454-20>20</a>
</span><span class=lnt id=hl-454-21><a class=lnlinks href=#hl-454-21>21</a>
</span><span class=lnt id=hl-454-22><a class=lnlinks href=#hl-454-22>22</a>
</span><span class=lnt id=hl-454-23><a class=lnlinks href=#hl-454-23>23</a>
</span><span class=lnt id=hl-454-24><a class=lnlinks href=#hl-454-24>24</a>
</span><span class=lnt id=hl-454-25><a class=lnlinks href=#hl-454-25>25</a>
</span><span class=lnt id=hl-454-26><a class=lnlinks href=#hl-454-26>26</a>
</span><span class=lnt id=hl-454-27><a class=lnlinks href=#hl-454-27>27</a>
</span><span class=lnt id=hl-454-28><a class=lnlinks href=#hl-454-28>28</a>
</span><span class=lnt id=hl-454-29><a class=lnlinks href=#hl-454-29>29</a>
</span><span class=lnt id=hl-454-30><a class=lnlinks href=#hl-454-30>30</a>
</span><span class=lnt id=hl-454-31><a class=lnlinks href=#hl-454-31>31</a>
</span><span class=lnt id=hl-454-32><a class=lnlinks href=#hl-454-32>32</a>
</span><span class=lnt id=hl-454-33><a class=lnlinks href=#hl-454-33>33</a>
</span><span class=lnt id=hl-454-34><a class=lnlinks href=#hl-454-34>34</a>
</span><span class=lnt id=hl-454-35><a class=lnlinks href=#hl-454-35>35</a>
</span><span class=lnt id=hl-454-36><a class=lnlinks href=#hl-454-36>36</a>
</span><span class=lnt id=hl-454-37><a class=lnlinks href=#hl-454-37>37</a>
</span><span class=lnt id=hl-454-38><a class=lnlinks href=#hl-454-38>38</a>
</span><span class=lnt id=hl-454-39><a class=lnlinks href=#hl-454-39>39</a>
</span><span class=lnt id=hl-454-40><a class=lnlinks href=#hl-454-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestCountDownlatchController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/order/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>order</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;total&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;2300.00&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/product/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>product</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;小爱音箱&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;price&#34;</span><span class=p>,</span><span class=w> </span><span class=n>300</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;小米手机&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;price&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/logistics/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>logistics</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;中通快递&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sleep</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>millis</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>millis</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>rest远程调用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-455-1><a class=lnlinks href=#hl-455-1> 1</a>
</span><span class=lnt id=hl-455-2><a class=lnlinks href=#hl-455-2> 2</a>
</span><span class=lnt id=hl-455-3><a class=lnlinks href=#hl-455-3> 3</a>
</span><span class=lnt id=hl-455-4><a class=lnlinks href=#hl-455-4> 4</a>
</span><span class=lnt id=hl-455-5><a class=lnlinks href=#hl-455-5> 5</a>
</span><span class=lnt id=hl-455-6><a class=lnlinks href=#hl-455-6> 6</a>
</span><span class=lnt id=hl-455-7><a class=lnlinks href=#hl-455-7> 7</a>
</span><span class=lnt id=hl-455-8><a class=lnlinks href=#hl-455-8> 8</a>
</span><span class=lnt id=hl-455-9><a class=lnlinks href=#hl-455-9> 9</a>
</span><span class=lnt id=hl-455-10><a class=lnlinks href=#hl-455-10>10</a>
</span><span class=lnt id=hl-455-11><a class=lnlinks href=#hl-455-11>11</a>
</span><span class=lnt id=hl-455-12><a class=lnlinks href=#hl-455-12>12</a>
</span><span class=lnt id=hl-455-13><a class=lnlinks href=#hl-455-13>13</a>
</span><span class=lnt id=hl-455-14><a class=lnlinks href=#hl-455-14>14</a>
</span><span class=lnt id=hl-455-15><a class=lnlinks href=#hl-455-15>15</a>
</span><span class=lnt id=hl-455-16><a class=lnlinks href=#hl-455-16>16</a>
</span><span class=lnt id=hl-455-17><a class=lnlinks href=#hl-455-17>17</a>
</span><span class=lnt id=hl-455-18><a class=lnlinks href=#hl-455-18>18</a>
</span><span class=lnt id=hl-455-19><a class=lnlinks href=#hl-455-19>19</a>
</span><span class=lnt id=hl-455-20><a class=lnlinks href=#hl-455-20>20</a>
</span><span class=lnt id=hl-455-21><a class=lnlinks href=#hl-455-21>21</a>
</span><span class=lnt id=hl-455-22><a class=lnlinks href=#hl-455-22>22</a>
</span><span class=lnt id=hl-455-23><a class=lnlinks href=#hl-455-23>23</a>
</span><span class=lnt id=hl-455-24><a class=lnlinks href=#hl-455-24>24</a>
</span><span class=lnt id=hl-455-25><a class=lnlinks href=#hl-455-25>25</a>
</span><span class=lnt id=hl-455-26><a class=lnlinks href=#hl-455-26>26</a>
</span><span class=lnt id=hl-455-27><a class=lnlinks href=#hl-455-27>27</a>
</span><span class=lnt id=hl-455-28><a class=lnlinks href=#hl-455-28>28</a>
</span><span class=lnt id=hl-455-29><a class=lnlinks href=#hl-455-29>29</a>
</span><span class=lnt id=hl-455-30><a class=lnlinks href=#hl-455-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RestTemplate</span><span class=w> </span><span class=n>restTemplate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RestTemplate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newCachedThreadPool</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>latch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>f1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>restTemplate</span><span class=p>.</span><span class=na>getForObject</span><span class=p>(</span><span class=s>&#34;http://localhost:8080/order/{1}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>f2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>restTemplate</span><span class=p>.</span><span class=na>getForObject</span><span class=p>(</span><span class=s>&#34;http://localhost:8080/product/{1}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>f3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>restTemplate</span><span class=p>.</span><span class=na>getForObject</span><span class=p>(</span><span class=s>&#34;http://localhost:8080/product/{1}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>f4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>restTemplate</span><span class=p>.</span><span class=na>getForObject</span><span class=p>(</span><span class=s>&#34;http://localhost:8080/logistics/{1}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>f1</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>f2</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>f3</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>f4</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;执行完毕&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>service</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>执行结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-456-1><a class=lnlinks href=#hl-456-1>1</a>
</span><span class=lnt id=hl-456-2><a class=lnlinks href=#hl-456-2>2</a>
</span><span class=lnt id=hl-456-3><a class=lnlinks href=#hl-456-3>3</a>
</span><span class=lnt id=hl-456-4><a class=lnlinks href=#hl-456-4>4</a>
</span><span class=lnt id=hl-456-5><a class=lnlinks href=#hl-456-5>5</a>
</span><span class=lnt id=hl-456-6><a class=lnlinks href=#hl-456-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:51:39.711 c.TestCountDownLatch <span class=o>[</span>main<span class=o>]</span> - begin 
</span></span><span class=line><span class=cl><span class=o>{</span><span class=nv>total</span><span class=o>=</span>2300.00, <span class=nv>id</span><span class=o>=</span>1<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>{</span><span class=nv>price</span><span class=o>=</span>300, <span class=nv>name</span><span class=o>=</span>小爱音箱, <span class=nv>id</span><span class=o>=</span>1<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>{</span><span class=nv>price</span><span class=o>=</span>2000, <span class=nv>name</span><span class=o>=</span>小米手机, <span class=nv>id</span><span class=o>=</span>2<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>{</span><span class=nv>name</span><span class=o>=</span>中通快递, <span class=nv>id</span><span class=o>=</span>1<span class=o>}</span> 
</span></span><span class=line><span class=cl>19:51:42.407 c.TestCountDownLatch <span class=o>[</span>main<span class=o>]</span> - 执行完毕
</span></span></code></pre></td></tr></table></div></div><p>说明：</p><ul><li>这种等待多个带有返回值的任务的场景，还是用future比较合适，CountdownLatch适合任务没有返回值的场景。</li></ul><h2 id=cyclicbarrier><a href=#cyclicbarrier class=header-anchor>#</a>
CyclicBarrier</h2><p>CountdownLatch的缺点在于不能重用，见下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-457-1><a class=lnlinks href=#hl-457-1> 1</a>
</span><span class=lnt id=hl-457-2><a class=lnlinks href=#hl-457-2> 2</a>
</span><span class=lnt id=hl-457-3><a class=lnlinks href=#hl-457-3> 3</a>
</span><span class=lnt id=hl-457-4><a class=lnlinks href=#hl-457-4> 4</a>
</span><span class=lnt id=hl-457-5><a class=lnlinks href=#hl-457-5> 5</a>
</span><span class=lnt id=hl-457-6><a class=lnlinks href=#hl-457-6> 6</a>
</span><span class=lnt id=hl-457-7><a class=lnlinks href=#hl-457-7> 7</a>
</span><span class=lnt id=hl-457-8><a class=lnlinks href=#hl-457-8> 8</a>
</span><span class=lnt id=hl-457-9><a class=lnlinks href=#hl-457-9> 9</a>
</span><span class=lnt id=hl-457-10><a class=lnlinks href=#hl-457-10>10</a>
</span><span class=lnt id=hl-457-11><a class=lnlinks href=#hl-457-11>11</a>
</span><span class=lnt id=hl-457-12><a class=lnlinks href=#hl-457-12>12</a>
</span><span class=lnt id=hl-457-13><a class=lnlinks href=#hl-457-13>13</a>
</span><span class=lnt id=hl-457-14><a class=lnlinks href=#hl-457-14>14</a>
</span><span class=lnt id=hl-457-15><a class=lnlinks href=#hl-457-15>15</a>
</span><span class=lnt id=hl-457-16><a class=lnlinks href=#hl-457-16>16</a>
</span><span class=lnt id=hl-457-17><a class=lnlinks href=#hl-457-17>17</a>
</span><span class=lnt id=hl-457-18><a class=lnlinks href=#hl-457-18>18</a>
</span><span class=lnt id=hl-457-19><a class=lnlinks href=#hl-457-19>19</a>
</span><span class=lnt id=hl-457-20><a class=lnlinks href=#hl-457-20>20</a>
</span><span class=lnt id=hl-457-21><a class=lnlinks href=#hl-457-21>21</a>
</span><span class=lnt id=hl-457-22><a class=lnlinks href=#hl-457-22>22</a>
</span><span class=lnt id=hl-457-23><a class=lnlinks href=#hl-457-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>latch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task1 start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task2 start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>latch</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task1 task2 finish...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>想要重复使用CountdownLatch进行同步，必须创建多个CountDownLatch对象。</p><p>[ˈsaɪklɪk ˈbæriɚ] 循环栅栏，用来进行线程协作，等待线程满足某个计数。构造时设置『计数个数』，每个线程执 行到某个需要“同步”的时刻调用 await() 方法进行等待，当等待的线程数满足『计数个数』时，继续执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-458-1><a class=lnlinks href=#hl-458-1> 1</a>
</span><span class=lnt id=hl-458-2><a class=lnlinks href=#hl-458-2> 2</a>
</span><span class=lnt id=hl-458-3><a class=lnlinks href=#hl-458-3> 3</a>
</span><span class=lnt id=hl-458-4><a class=lnlinks href=#hl-458-4> 4</a>
</span><span class=lnt id=hl-458-5><a class=lnlinks href=#hl-458-5> 5</a>
</span><span class=lnt id=hl-458-6><a class=lnlinks href=#hl-458-6> 6</a>
</span><span class=lnt id=hl-458-7><a class=lnlinks href=#hl-458-7> 7</a>
</span><span class=lnt id=hl-458-8><a class=lnlinks href=#hl-458-8> 8</a>
</span><span class=lnt id=hl-458-9><a class=lnlinks href=#hl-458-9> 9</a>
</span><span class=lnt id=hl-458-10><a class=lnlinks href=#hl-458-10>10</a>
</span><span class=lnt id=hl-458-11><a class=lnlinks href=#hl-458-11>11</a>
</span><span class=lnt id=hl-458-12><a class=lnlinks href=#hl-458-12>12</a>
</span><span class=lnt id=hl-458-13><a class=lnlinks href=#hl-458-13>13</a>
</span><span class=lnt id=hl-458-14><a class=lnlinks href=#hl-458-14>14</a>
</span><span class=lnt id=hl-458-15><a class=lnlinks href=#hl-458-15>15</a>
</span><span class=lnt id=hl-458-16><a class=lnlinks href=#hl-458-16>16</a>
</span><span class=lnt id=hl-458-17><a class=lnlinks href=#hl-458-17>17</a>
</span><span class=lnt id=hl-458-18><a class=lnlinks href=#hl-458-18>18</a>
</span><span class=lnt id=hl-458-19><a class=lnlinks href=#hl-458-19>19</a>
</span><span class=lnt id=hl-458-20><a class=lnlinks href=#hl-458-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CyclicBarrier</span><span class=w> </span><span class=n>cb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CyclicBarrier</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w> </span><span class=c1>// 个数为2时才会继续执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;线程1开始..&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cb</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w> </span><span class=c1>// 当个数不足时，等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>BrokenBarrierException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;线程1继续向下运行...&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;线程2开始..&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cb</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w> </span><span class=c1>// 2 秒后，线程个数够2，继续运行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>BrokenBarrierException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;线程2继续向下运行...&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p><ul><li>CyclicBarrier 与 CountDownLatch 的主要区别在于 CyclicBarrier 是可以重用的 CyclicBarrier 可以被比 喻为『人满发车』</li><li>CountDownLatch的计数和阻塞方法是分开的两个方法，而CyclicBarrier是一个方法。</li><li>CyclicBarrier的构造器还有一个Runnable类型的参数，在计数为0时会执行其中的run方法。</li></ul></blockquote><h2 id=线程安全集合类概述><a href=#%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e9%9b%86%e5%90%88%e7%b1%bb%e6%a6%82%e8%bf%b0 class=header-anchor>#</a>
线程安全集合类概述</h2><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220316174115768.png width=900 height=600 loading=lazy decoding=async alt=image-20220316174115768 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>线程安全集合类可以分为三大类：</p><ul><li>遗留的线程安全集合如<code>Hashtable</code>，<code>Vector</code></li><li>使用<code>Collections</code>装饰的线程安全集合，如：<ul><li><code>Collections.synchronizedCollection</code></li><li><code>Collections.synchronizedList</code></li><li><code>Collections.synchronizedMap</code></li><li><code>Collections.synchronizedSet</code></li><li><code>Collections.synchronizedNavigableMap</code></li><li><code>Collections.synchronizedNavigableSet</code></li><li><code>Collections.synchronizedSortedMap</code></li><li><code>Collections.synchronizedSortedSet</code></li><li>说明：以上集合均采用修饰模式设计，将非线程安全的集合包装后，在调用方法时包裹了一层synchronized代码块。其并发性并不比遗留的安全集合好。</li></ul></li><li>java.util.concurrent.*</li></ul><p>重点介绍<code>java.util.concurrent.* </code>下的线程安全集合类，可以发现它们有规律，里面包含三类关键词： Blocking、CopyOnWrite、Concurrent</p><ul><li>Blocking 大部分实现基于锁，并提供用来阻塞的方法</li><li>CopyOnWrite 之类容器修改开销相对较重</li><li>Concurrent 类型的容器<ul><li>内部很多操作使用 cas 优化，一般可以提供较高吞吐量</li><li>弱一致性<ul><li>遍历时弱一致性，例如，当利用迭代器遍历时，如果容器发生修改，迭代器仍然可以继续进行遍 历，这时内容是旧的</li><li>求大小弱一致性，size 操作未必是 100% 准确</li><li>读取弱一致性</li></ul></li></ul></li></ul><blockquote><p>遍历时如果发生了修改，对于非安全容器来讲，使用 <strong>fail-fast</strong> 机制也就是让遍历立刻失败，抛出 ConcurrentModificationException，不再继续遍历</p></blockquote><h2 id=concurrenthashmap><a href=#concurrenthashmap class=header-anchor>#</a>
ConcurrentHashMap</h2><h3 id=font-colorgreen应用之单词计数font><a href=#font-colorgreen%e5%ba%94%e7%94%a8%e4%b9%8b%e5%8d%95%e8%af%8d%e8%ae%a1%e6%95%b0font class=header-anchor>#</a>
<font color=green>应用之单词计数</font></h3><p><strong>搭建练习环境：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-459-1><a class=lnlinks href=#hl-459-1> 1</a>
</span><span class=lnt id=hl-459-2><a class=lnlinks href=#hl-459-2> 2</a>
</span><span class=lnt id=hl-459-3><a class=lnlinks href=#hl-459-3> 3</a>
</span><span class=lnt id=hl-459-4><a class=lnlinks href=#hl-459-4> 4</a>
</span><span class=lnt id=hl-459-5><a class=lnlinks href=#hl-459-5> 5</a>
</span><span class=lnt id=hl-459-6><a class=lnlinks href=#hl-459-6> 6</a>
</span><span class=lnt id=hl-459-7><a class=lnlinks href=#hl-459-7> 7</a>
</span><span class=lnt id=hl-459-8><a class=lnlinks href=#hl-459-8> 8</a>
</span><span class=lnt id=hl-459-9><a class=lnlinks href=#hl-459-9> 9</a>
</span><span class=lnt id=hl-459-10><a class=lnlinks href=#hl-459-10>10</a>
</span><span class=lnt id=hl-459-11><a class=lnlinks href=#hl-459-11>11</a>
</span><span class=lnt id=hl-459-12><a class=lnlinks href=#hl-459-12>12</a>
</span><span class=lnt id=hl-459-13><a class=lnlinks href=#hl-459-13>13</a>
</span><span class=lnt id=hl-459-14><a class=lnlinks href=#hl-459-14>14</a>
</span><span class=lnt id=hl-459-15><a class=lnlinks href=#hl-459-15>15</a>
</span><span class=lnt id=hl-459-16><a class=lnlinks href=#hl-459-16>16</a>
</span><span class=lnt id=hl-459-17><a class=lnlinks href=#hl-459-17>17</a>
</span><span class=lnt id=hl-459-18><a class=lnlinks href=#hl-459-18>18</a>
</span><span class=lnt id=hl-459-19><a class=lnlinks href=#hl-459-19>19</a>
</span><span class=lnt id=hl-459-20><a class=lnlinks href=#hl-459-20>20</a>
</span><span class=lnt id=hl-459-21><a class=lnlinks href=#hl-459-21>21</a>
</span><span class=lnt id=hl-459-22><a class=lnlinks href=#hl-459-22>22</a>
</span><span class=lnt id=hl-459-23><a class=lnlinks href=#hl-459-23>23</a>
</span><span class=lnt id=hl-459-24><a class=lnlinks href=#hl-459-24>24</a>
</span><span class=lnt id=hl-459-25><a class=lnlinks href=#hl-459-25>25</a>
</span><span class=lnt id=hl-459-26><a class=lnlinks href=#hl-459-26>26</a>
</span><span class=lnt id=hl-459-27><a class=lnlinks href=#hl-459-27>27</a>
</span><span class=lnt id=hl-459-28><a class=lnlinks href=#hl-459-28>28</a>
</span><span class=lnt id=hl-459-29><a class=lnlinks href=#hl-459-29>29</a>
</span><span class=lnt id=hl-459-30><a class=lnlinks href=#hl-459-30>30</a>
</span><span class=lnt id=hl-459-31><a class=lnlinks href=#hl-459-31>31</a>
</span><span class=lnt id=hl-459-32><a class=lnlinks href=#hl-459-32>32</a>
</span><span class=lnt id=hl-459-33><a class=lnlinks href=#hl-459-33>33</a>
</span><span class=lnt id=hl-459-34><a class=lnlinks href=#hl-459-34>34</a>
</span><span class=lnt id=hl-459-35><a class=lnlinks href=#hl-459-35>35</a>
</span><span class=lnt id=hl-459-36><a class=lnlinks href=#hl-459-36>36</a>
</span><span class=lnt id=hl-459-37><a class=lnlinks href=#hl-459-37>37</a>
</span><span class=lnt id=hl-459-38><a class=lnlinks href=#hl-459-38>38</a>
</span><span class=lnt id=hl-459-39><a class=lnlinks href=#hl-459-39>39</a>
</span><span class=lnt id=hl-459-40><a class=lnlinks href=#hl-459-40>40</a>
</span><span class=lnt id=hl-459-41><a class=lnlinks href=#hl-459-41>41</a>
</span><span class=lnt id=hl-459-42><a class=lnlinks href=#hl-459-42>42</a>
</span><span class=lnt id=hl-459-43><a class=lnlinks href=#hl-459-43>43</a>
</span><span class=lnt id=hl-459-44><a class=lnlinks href=#hl-459-44>44</a>
</span><span class=lnt id=hl-459-45><a class=lnlinks href=#hl-459-45>45</a>
</span><span class=lnt id=hl-459-46><a class=lnlinks href=#hl-459-46>46</a>
</span><span class=lnt id=hl-459-47><a class=lnlinks href=#hl-459-47>47</a>
</span><span class=lnt id=hl-459-48><a class=lnlinks href=#hl-459-48>48</a>
</span><span class=lnt id=hl-459-49><a class=lnlinks href=#hl-459-49>49</a>
</span><span class=lnt id=hl-459-50><a class=lnlinks href=#hl-459-50>50</a>
</span><span class=lnt id=hl-459-51><a class=lnlinks href=#hl-459-51>51</a>
</span><span class=lnt id=hl-459-52><a class=lnlinks href=#hl-459-52>52</a>
</span><span class=lnt id=hl-459-53><a class=lnlinks href=#hl-459-53>53</a>
</span><span class=lnt id=hl-459-54><a class=lnlinks href=#hl-459-54>54</a>
</span><span class=lnt id=hl-459-55><a class=lnlinks href=#hl-459-55>55</a>
</span><span class=lnt id=hl-459-56><a class=lnlinks href=#hl-459-56>56</a>
</span><span class=lnt id=hl-459-57><a class=lnlinks href=#hl-459-57>57</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//在main方法中实现两个接口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//开启26个线程，每个线程调用get方法获取map，从对应的文件读取单词并存储到list中，最后调用accept方法进行统计。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w>  </span><span class=nf>calculate</span><span class=p>(</span><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>supplier</span><span class=p>,</span><span class=w> </span><span class=n>BiConsumer</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>consumer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>supplier</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>26</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>27</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>read</span><span class=p>(</span><span class=n>list</span><span class=p>,</span><span class=n>k</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>consumer</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>count</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>count</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>map</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//读单词方法的实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>read</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>element</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileReader</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.txt&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>((</span><span class=n>element</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reader</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>element</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//生成测试数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>construct</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;abcdefghijklmnopqrstuvwxyz&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=na>length</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>200</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>str</span><span class=p>.</span><span class=na>charAt</span><span class=p>(</span><span class=n>i</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Collections</span><span class=p>.</span><span class=na>shuffle</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>26</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>PrintWriter</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PrintWriter</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileWriter</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.txt&#34;</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>collect</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>subList</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>200</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>200</span><span class=p>).</span><span class=na>stream</span><span class=p>().</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>joining</span><span class=p>(</span><span class=s>&#34;\n&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>collect</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=实现一><a href=#%e5%ae%9e%e7%8e%b0%e4%b8%80 class=header-anchor>#</a>
实现一：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-460-1><a class=lnlinks href=#hl-460-1> 1</a>
</span><span class=lnt id=hl-460-2><a class=lnlinks href=#hl-460-2> 2</a>
</span><span class=lnt id=hl-460-3><a class=lnlinks href=#hl-460-3> 3</a>
</span><span class=lnt id=hl-460-4><a class=lnlinks href=#hl-460-4> 4</a>
</span><span class=lnt id=hl-460-5><a class=lnlinks href=#hl-460-5> 5</a>
</span><span class=lnt id=hl-460-6><a class=lnlinks href=#hl-460-6> 6</a>
</span><span class=lnt id=hl-460-7><a class=lnlinks href=#hl-460-7> 7</a>
</span><span class=lnt id=hl-460-8><a class=lnlinks href=#hl-460-8> 8</a>
</span><span class=lnt id=hl-460-9><a class=lnlinks href=#hl-460-9> 9</a>
</span><span class=lnt id=hl-460-10><a class=lnlinks href=#hl-460-10>10</a>
</span><span class=lnt id=hl-460-11><a class=lnlinks href=#hl-460-11>11</a>
</span><span class=lnt id=hl-460-12><a class=lnlinks href=#hl-460-12>12</a>
</span><span class=lnt id=hl-460-13><a class=lnlinks href=#hl-460-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 创建 map 集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 创建 ConcurrentHashMap 对不对？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 进行计数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>word</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Integer</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>word</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>newValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>word</span><span class=p>,</span><span class=w> </span><span class=n>newValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-461-1><a class=lnlinks href=#hl-461-1>1</a>
</span><span class=lnt id=hl-461-2><a class=lnlinks href=#hl-461-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>{</span><span class=nv>a</span><span class=o>=</span>186, <span class=nv>b</span><span class=o>=</span>192, <span class=nv>c</span><span class=o>=</span>187, <span class=nv>d</span><span class=o>=</span>184, <span class=nv>e</span><span class=o>=</span>185, <span class=nv>f</span><span class=o>=</span>185, <span class=nv>g</span><span class=o>=</span>176, <span class=nv>h</span><span class=o>=</span>185, <span class=nv>i</span><span class=o>=</span>193, <span class=nv>j</span><span class=o>=</span>189, <span class=nv>k</span><span class=o>=</span>187, <span class=nv>l</span><span class=o>=</span>157, <span class=nv>m</span><span class=o>=</span>189, <span class=nv>n</span><span class=o>=</span>181, <span class=nv>o</span><span class=o>=</span>180, <span class=nv>p</span><span class=o>=</span>178, <span class=nv>q</span><span class=o>=</span>185, <span class=nv>r</span><span class=o>=</span>188, <span class=nv>s</span><span class=o>=</span>181, <span class=nv>t</span><span class=o>=</span>183, <span class=nv>u</span><span class=o>=</span>177, <span class=nv>v</span><span class=o>=</span>186, <span class=nv>w</span><span class=o>=</span>188, <span class=nv>x</span><span class=o>=</span>178, <span class=nv>y</span><span class=o>=</span>189, <span class=nv>z</span><span class=o>=</span>186<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=m>47</span>
</span></span></code></pre></td></tr></table></div></div><p>错误原因：</p><ul><li>ConcurrentHashMap虽然每个方法都是线程安全的，但是多个方法的组合并不是线程安全的。</li></ul><h5 id=正确答案一><a href=#%e6%ad%a3%e7%a1%ae%e7%ad%94%e6%a1%88%e4%b8%80 class=header-anchor>#</a>
正确答案一：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-462-1><a class=lnlinks href=#hl-462-1>1</a>
</span><span class=lnt id=hl-462-2><a class=lnlinks href=#hl-462-2>2</a>
</span><span class=lnt id=hl-462-3><a class=lnlinks href=#hl-462-3>3</a>
</span><span class=lnt id=hl-462-4><a class=lnlinks href=#hl-462-4>4</a>
</span><span class=lnt id=hl-462-5><a class=lnlinks href=#hl-462-5>5</a>
</span><span class=lnt id=hl-462-6><a class=lnlinks href=#hl-462-6>6</a>
</span><span class=lnt id=hl-462-7><a class=lnlinks href=#hl-462-7>7</a>
</span><span class=lnt id=hl-462-8><a class=lnlinks href=#hl-462-8>8</a>
</span><span class=lnt id=hl-462-9><a class=lnlinks href=#hl-462-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>LongAdder</span><span class=o>&gt;</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>word</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 注意不能使用 putIfAbsent，此方法返回的是上一次的 value，首次调用返回 null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>computeIfAbsent</span><span class=p>(</span><span class=n>word</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LongAdder</span><span class=p>()).</span><span class=na>increment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>说明：</p><ul><li>computIfAbsent方法的作用是：当map中不存在以参数1为key对应的value时，会将参数2函数式接口的返回值作为value，put进map中，然后返回该value。如果存在key，则直接返回value</li><li>以上两部均是线程安全的。</li></ul><h5 id=正确答案二><a href=#%e6%ad%a3%e7%a1%ae%e7%ad%94%e6%a1%88%e4%ba%8c class=header-anchor>#</a>
正确答案二：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-463-1><a class=lnlinks href=#hl-463-1>1</a>
</span><span class=lnt id=hl-463-2><a class=lnlinks href=#hl-463-2>2</a>
</span><span class=lnt id=hl-463-3><a class=lnlinks href=#hl-463-3>3</a>
</span><span class=lnt id=hl-463-4><a class=lnlinks href=#hl-463-4>4</a>
</span><span class=lnt id=hl-463-5><a class=lnlinks href=#hl-463-5>5</a>
</span><span class=lnt id=hl-463-6><a class=lnlinks href=#hl-463-6>6</a>
</span><span class=lnt id=hl-463-7><a class=lnlinks href=#hl-463-7>7</a>
</span><span class=lnt id=hl-463-8><a class=lnlinks href=#hl-463-8>8</a>
</span><span class=lnt id=hl-463-9><a class=lnlinks href=#hl-463-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>word</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 函数式编程，无需原子变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>merge</span><span class=p>(</span><span class=n>word</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>::</span><span class=n>sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=font-colorblue-concurrenthashmap-原理font><a href=#font-colorblue-concurrenthashmap-%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>* ConcurrentHashMap 原理</font></h3><h4 id=jdk-7-hashmap-并发死链><a href=#jdk-7-hashmap-%e5%b9%b6%e5%8f%91%e6%ad%bb%e9%93%be class=header-anchor>#</a>
JDK 7 HashMap 并发死链</h4><h5 id=测试代码><a href=#%e6%b5%8b%e8%af%95%e4%bb%a3%e7%a0%81 class=header-anchor>#</a>
测试代码</h5><p>注意</p><ul><li>要在 JDK 7 下运行，否则扩容机制和 hash 的计算方法都变了</li><li>以下测试代码是精心准备的，不要随便改动</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-464-1><a class=lnlinks href=#hl-464-1> 1</a>
</span><span class=lnt id=hl-464-2><a class=lnlinks href=#hl-464-2> 2</a>
</span><span class=lnt id=hl-464-3><a class=lnlinks href=#hl-464-3> 3</a>
</span><span class=lnt id=hl-464-4><a class=lnlinks href=#hl-464-4> 4</a>
</span><span class=lnt id=hl-464-5><a class=lnlinks href=#hl-464-5> 5</a>
</span><span class=lnt id=hl-464-6><a class=lnlinks href=#hl-464-6> 6</a>
</span><span class=lnt id=hl-464-7><a class=lnlinks href=#hl-464-7> 7</a>
</span><span class=lnt id=hl-464-8><a class=lnlinks href=#hl-464-8> 8</a>
</span><span class=lnt id=hl-464-9><a class=lnlinks href=#hl-464-9> 9</a>
</span><span class=lnt id=hl-464-10><a class=lnlinks href=#hl-464-10>10</a>
</span><span class=lnt id=hl-464-11><a class=lnlinks href=#hl-464-11>11</a>
</span><span class=lnt id=hl-464-12><a class=lnlinks href=#hl-464-12>12</a>
</span><span class=lnt id=hl-464-13><a class=lnlinks href=#hl-464-13>13</a>
</span><span class=lnt id=hl-464-14><a class=lnlinks href=#hl-464-14>14</a>
</span><span class=lnt id=hl-464-15><a class=lnlinks href=#hl-464-15>15</a>
</span><span class=lnt id=hl-464-16><a class=lnlinks href=#hl-464-16>16</a>
</span><span class=lnt id=hl-464-17><a class=lnlinks href=#hl-464-17>17</a>
</span><span class=lnt id=hl-464-18><a class=lnlinks href=#hl-464-18>18</a>
</span><span class=lnt id=hl-464-19><a class=lnlinks href=#hl-464-19>19</a>
</span><span class=lnt id=hl-464-20><a class=lnlinks href=#hl-464-20>20</a>
</span><span class=lnt id=hl-464-21><a class=lnlinks href=#hl-464-21>21</a>
</span><span class=lnt id=hl-464-22><a class=lnlinks href=#hl-464-22>22</a>
</span><span class=lnt id=hl-464-23><a class=lnlinks href=#hl-464-23>23</a>
</span><span class=lnt id=hl-464-24><a class=lnlinks href=#hl-464-24>24</a>
</span><span class=lnt id=hl-464-25><a class=lnlinks href=#hl-464-25>25</a>
</span><span class=lnt id=hl-464-26><a class=lnlinks href=#hl-464-26>26</a>
</span><span class=lnt id=hl-464-27><a class=lnlinks href=#hl-464-27>27</a>
</span><span class=lnt id=hl-464-28><a class=lnlinks href=#hl-464-28>28</a>
</span><span class=lnt id=hl-464-29><a class=lnlinks href=#hl-464-29>29</a>
</span><span class=lnt id=hl-464-30><a class=lnlinks href=#hl-464-30>30</a>
</span><span class=lnt id=hl-464-31><a class=lnlinks href=#hl-464-31>31</a>
</span><span class=lnt id=hl-464-32><a class=lnlinks href=#hl-464-32>32</a>
</span><span class=lnt id=hl-464-33><a class=lnlinks href=#hl-464-33>33</a>
</span><span class=lnt id=hl-464-34><a class=lnlinks href=#hl-464-34>34</a>
</span><span class=lnt id=hl-464-35><a class=lnlinks href=#hl-464-35>35</a>
</span><span class=lnt id=hl-464-36><a class=lnlinks href=#hl-464-36>36</a>
</span><span class=lnt id=hl-464-37><a class=lnlinks href=#hl-464-37>37</a>
</span><span class=lnt id=hl-464-38><a class=lnlinks href=#hl-464-38>38</a>
</span><span class=lnt id=hl-464-39><a class=lnlinks href=#hl-464-39>39</a>
</span><span class=lnt id=hl-464-40><a class=lnlinks href=#hl-464-40>40</a>
</span><span class=lnt id=hl-464-41><a class=lnlinks href=#hl-464-41>41</a>
</span><span class=lnt id=hl-464-42><a class=lnlinks href=#hl-464-42>42</a>
</span><span class=lnt id=hl-464-43><a class=lnlinks href=#hl-464-43>43</a>
</span><span class=lnt id=hl-464-44><a class=lnlinks href=#hl-464-44>44</a>
</span><span class=lnt id=hl-464-45><a class=lnlinks href=#hl-464-45>45</a>
</span><span class=lnt id=hl-464-46><a class=lnlinks href=#hl-464-46>46</a>
</span><span class=lnt id=hl-464-47><a class=lnlinks href=#hl-464-47>47</a>
</span><span class=lnt id=hl-464-48><a class=lnlinks href=#hl-464-48>48</a>
</span><span class=lnt id=hl-464-49><a class=lnlinks href=#hl-464-49>49</a>
</span><span class=lnt id=hl-464-50><a class=lnlinks href=#hl-464-50>50</a>
</span><span class=lnt id=hl-464-51><a class=lnlinks href=#hl-464-51>51</a>
</span><span class=lnt id=hl-464-52><a class=lnlinks href=#hl-464-52>52</a>
</span><span class=lnt id=hl-464-53><a class=lnlinks href=#hl-464-53>53</a>
</span><span class=lnt id=hl-464-54><a class=lnlinks href=#hl-464-54>54</a>
</span><span class=lnt id=hl-464-55><a class=lnlinks href=#hl-464-55>55</a>
</span><span class=lnt id=hl-464-56><a class=lnlinks href=#hl-464-56>56</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 测试 java 7 中哪些数字的 hash 结果相等</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;长度为16时，桶下标为1的key&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>64</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>16</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;长度为32时，桶下标为1的key&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>64</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>32</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1, 35, 16, 50 当大小为16时，它们在一个桶内</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 放 12 个元素</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>4</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>5</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>6</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>7</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>8</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>9</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>16</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;扩容前大小[main]:&#34;</span><span class=o>+</span><span class=n>map</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 放第 13 个元素, 发生扩容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>50</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;扩容后大小[Thread-0]:&#34;</span><span class=o>+</span><span class=n>map</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 放第 13 个元素, 发生扩容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>50</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;扩容后大小[Thread-1]:&#34;</span><span class=o>+</span><span class=n>map</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hash</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>k</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>0</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sun</span><span class=p>.</span><span class=na>misc</span><span class=p>.</span><span class=na>Hashing</span><span class=p>.</span><span class=na>stringHash32</span><span class=p>((</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>k</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=n>k</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>20</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>12</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>7</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=死链复现><a href=#%e6%ad%bb%e9%93%be%e5%a4%8d%e7%8e%b0 class=header-anchor>#</a>
死链复现</h5><p>调试工具使用 idea</p><p>在 HashMap 源码 590 行加断点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-465-1><a class=lnlinks href=#hl-465-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span><span class=w> </span><span class=n>newCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>断点的条件如下，目的是让 HashMap 在扩容为 32 时，并且线程为 Thread-0 或 Thread-1 时停下来</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-466-1><a class=lnlinks href=#hl-466-1>1</a>
</span><span class=lnt id=hl-466-2><a class=lnlinks href=#hl-466-2>2</a>
</span><span class=lnt id=hl-466-3><a class=lnlinks href=#hl-466-3>3</a>
</span><span class=lnt id=hl-466-4><a class=lnlinks href=#hl-466-4>4</a>
</span><span class=lnt id=hl-466-5><a class=lnlinks href=#hl-466-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>newTable</span><span class=p>.</span><span class=na>length</span><span class=o>==</span><span class=n>32</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;Thread-0&#34;</span><span class=p>)</span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;Thread-1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>断点暂停方式选择 Thread，否则在调试 Thread-0 时，Thread-1 无法恢复运行</p><p>运行代码，程序在预料的断点位置停了下来，输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-467-1><a class=lnlinks href=#hl-467-1>1</a>
</span><span class=lnt id=hl-467-2><a class=lnlinks href=#hl-467-2>2</a>
</span><span class=lnt id=hl-467-3><a class=lnlinks href=#hl-467-3>3</a>
</span><span class=lnt id=hl-467-4><a class=lnlinks href=#hl-467-4>4</a>
</span><span class=lnt id=hl-467-5><a class=lnlinks href=#hl-467-5>5</a>
</span><span class=lnt id=hl-467-6><a class=lnlinks href=#hl-467-6>6</a>
</span><span class=lnt id=hl-467-7><a class=lnlinks href=#hl-467-7>7</a>
</span><span class=lnt id=hl-467-8><a class=lnlinks href=#hl-467-8>8</a>
</span><span class=lnt id=hl-467-9><a class=lnlinks href=#hl-467-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>长度为16时，桶下标为1的key 
</span></span><span class=line><span class=cl><span class=m>1</span> 
</span></span><span class=line><span class=cl><span class=m>16</span> 
</span></span><span class=line><span class=cl><span class=m>35</span> 
</span></span><span class=line><span class=cl><span class=m>50</span> 
</span></span><span class=line><span class=cl>长度为32时，桶下标为1的key 
</span></span><span class=line><span class=cl><span class=m>1</span> 
</span></span><span class=line><span class=cl><span class=m>35</span> 
</span></span><span class=line><span class=cl>扩容前大小<span class=o>[</span>main<span class=o>]</span>:12 
</span></span></code></pre></td></tr></table></div></div><p>接下来进入扩容流程调试</p><p>在 HashMap 源码 594 行加断点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-468-1><a class=lnlinks href=#hl-468-1>1</a>
</span><span class=lnt id=hl-468-2><a class=lnlinks href=#hl-468-2>2</a>
</span><span class=lnt id=hl-468-3><a class=lnlinks href=#hl-468-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w> </span><span class=c1>// 593</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rehash</span><span class=p>)</span><span class=w> </span><span class=c1>// 594</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这是为了观察 e 节点和 next 节点的状态，Thread-0 单步执行到 594 行，再 594 处再添加一个断点（条件 Thread.currentThread().getName().equals(&ldquo;Thread-0&rdquo;)）</p><p>这时可以在 Variables 面板观察到 e 和 next 变量，使用<code>view as -> Object</code>查看节点状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-469-1><a class=lnlinks href=#hl-469-1>1</a>
</span><span class=lnt id=hl-469-2><a class=lnlinks href=#hl-469-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>e</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>16</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>next</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>16</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>在 Threads 面板选中 Thread-1 恢复运行，可以看到控制台输出新的内容如下，Thread-1 扩容已完成</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-470-1><a class=lnlinks href=#hl-470-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>newTable</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-471-1><a class=lnlinks href=#hl-471-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>扩容后大小:13 
</span></span></code></pre></td></tr></table></div></div><p>这时 Thread-0 还停在 594 处， Variables 面板变量的状态已经变化为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-472-1><a class=lnlinks href=#hl-472-1>1</a>
</span><span class=lnt id=hl-472-2><a class=lnlinks href=#hl-472-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>e</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>next</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>为什么呢，因为 Thread-1 扩容时链表也是后加入的元素放入链表头，因此链表就倒过来了，但 Thread-1 虽然结 果正确，但它结束后 Thread-0 还要继续运行</p><p>接下来就可以单步调试（F8）观察死链的产生了</p><p>下一轮循环到 594，将 e 搬迁到 newTable 链表头</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-473-1><a class=lnlinks href=#hl-473-1>1</a>
</span><span class=lnt id=hl-473-2><a class=lnlinks href=#hl-473-2>2</a>
</span><span class=lnt id=hl-473-3><a class=lnlinks href=#hl-473-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>newTable</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>e</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>next</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>下一轮循环到 594，将 e 搬迁到 newTable 链表头</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-474-1><a class=lnlinks href=#hl-474-1>1</a>
</span><span class=lnt id=hl-474-2><a class=lnlinks href=#hl-474-2>2</a>
</span><span class=lnt id=hl-474-3><a class=lnlinks href=#hl-474-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>newTable</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>e</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>next</span><span class=w> </span><span class=kc>null</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>再看看源码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-475-1><a class=lnlinks href=#hl-475-1>1</a>
</span><span class=lnt id=hl-475-2><a class=lnlinks href=#hl-475-2>2</a>
</span><span class=lnt id=hl-475-3><a class=lnlinks href=#hl-475-3>3</a>
</span><span class=lnt id=hl-475-4><a class=lnlinks href=#hl-475-4>4</a>
</span><span class=lnt id=hl-475-5><a class=lnlinks href=#hl-475-5>5</a>
</span><span class=lnt id=hl-475-6><a class=lnlinks href=#hl-475-6>6</a>
</span><span class=lnt id=hl-475-7><a class=lnlinks href=#hl-475-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 这时 e (1,35)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 而 newTable[1] (35,1)-&gt;(1,35) 因为是同一个对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>newTable</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 再尝试将 e 作为链表头, 死链已成</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 虽然 next 是 null, 会进入下一个链表的复制, 但死链已经形成了</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=源码分析-2><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-2 class=header-anchor>#</a>
<strong>源码分析</strong></h5><p>HashMap 的并发死链发生在扩容时</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-476-1><a class=lnlinks href=#hl-476-1> 1</a>
</span><span class=lnt id=hl-476-2><a class=lnlinks href=#hl-476-2> 2</a>
</span><span class=lnt id=hl-476-3><a class=lnlinks href=#hl-476-3> 3</a>
</span><span class=lnt id=hl-476-4><a class=lnlinks href=#hl-476-4> 4</a>
</span><span class=lnt id=hl-476-5><a class=lnlinks href=#hl-476-5> 5</a>
</span><span class=lnt id=hl-476-6><a class=lnlinks href=#hl-476-6> 6</a>
</span><span class=lnt id=hl-476-7><a class=lnlinks href=#hl-476-7> 7</a>
</span><span class=lnt id=hl-476-8><a class=lnlinks href=#hl-476-8> 8</a>
</span><span class=lnt id=hl-476-9><a class=lnlinks href=#hl-476-9> 9</a>
</span><span class=lnt id=hl-476-10><a class=lnlinks href=#hl-476-10>10</a>
</span><span class=lnt id=hl-476-11><a class=lnlinks href=#hl-476-11>11</a>
</span><span class=lnt id=hl-476-12><a class=lnlinks href=#hl-476-12>12</a>
</span><span class=lnt id=hl-476-13><a class=lnlinks href=#hl-476-13>13</a>
</span><span class=lnt id=hl-476-14><a class=lnlinks href=#hl-476-14>14</a>
</span><span class=lnt id=hl-476-15><a class=lnlinks href=#hl-476-15>15</a>
</span><span class=lnt id=hl-476-16><a class=lnlinks href=#hl-476-16>16</a>
</span><span class=lnt id=hl-476-17><a class=lnlinks href=#hl-476-17>17</a>
</span><span class=lnt id=hl-476-18><a class=lnlinks href=#hl-476-18>18</a>
</span><span class=lnt id=hl-476-19><a class=lnlinks href=#hl-476-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 将 table 迁移至 newTable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>transfer</span><span class=p>(</span><span class=n>Entry</span><span class=o>[]</span><span class=w> </span><span class=n>newTable</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>rehash</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>newCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>table</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 1 处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rehash</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>indexFor</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=p>,</span><span class=w> </span><span class=n>newCapacity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 2 处</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 将新元素加入 newTable[i], 原 newTable[i] 作为新元素的 next</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newTable</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>假设 map 中初始元素是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-477-1><a class=lnlinks href=#hl-477-1> 1</a>
</span><span class=lnt id=hl-477-2><a class=lnlinks href=#hl-477-2> 2</a>
</span><span class=lnt id=hl-477-3><a class=lnlinks href=#hl-477-3> 3</a>
</span><span class=lnt id=hl-477-4><a class=lnlinks href=#hl-477-4> 4</a>
</span><span class=lnt id=hl-477-5><a class=lnlinks href=#hl-477-5> 5</a>
</span><span class=lnt id=hl-477-6><a class=lnlinks href=#hl-477-6> 6</a>
</span><span class=lnt id=hl-477-7><a class=lnlinks href=#hl-477-7> 7</a>
</span><span class=lnt id=hl-477-8><a class=lnlinks href=#hl-477-8> 8</a>
</span><span class=lnt id=hl-477-9><a class=lnlinks href=#hl-477-9> 9</a>
</span><span class=lnt id=hl-477-10><a class=lnlinks href=#hl-477-10>10</a>
</span><span class=lnt id=hl-477-11><a class=lnlinks href=#hl-477-11>11</a>
</span><span class=lnt id=hl-477-12><a class=lnlinks href=#hl-477-12>12</a>
</span><span class=lnt id=hl-477-13><a class=lnlinks href=#hl-477-13>13</a>
</span><span class=lnt id=hl-477-14><a class=lnlinks href=#hl-477-14>14</a>
</span><span class=lnt id=hl-477-15><a class=lnlinks href=#hl-477-15>15</a>
</span><span class=lnt id=hl-477-16><a class=lnlinks href=#hl-477-16>16</a>
</span><span class=lnt id=hl-477-17><a class=lnlinks href=#hl-477-17>17</a>
</span><span class=lnt id=hl-477-18><a class=lnlinks href=#hl-477-18>18</a>
</span><span class=lnt id=hl-477-19><a class=lnlinks href=#hl-477-19>19</a>
</span><span class=lnt id=hl-477-20><a class=lnlinks href=#hl-477-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>原始链表</span><span class=err>，</span><span class=n>格式</span><span class=err>：</span><span class=o>[</span><span class=n>下标</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=n>next</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>16</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>16</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>线程</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>执行到</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=n>处</span><span class=w> </span><span class=err>，</span><span class=n>此时局部变量</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=nf>为</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=n>35</span><span class=p>)</span><span class=err>，</span><span class=n>而局部变量</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=nf>为</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>16</span><span class=p>)</span><span class=w> </span><span class=n>线程</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>挂起</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>线程</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=n>开始执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>第一次循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>第二次循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>第三次循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>17</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>16</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>切换回线程</span><span class=w> </span><span class=n>a</span><span class=err>，</span><span class=n>此时局部变量</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=n>和</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=n>被恢复</span><span class=err>，</span><span class=n>引用没变但内容变了</span><span class=err>：</span><span class=n>e</span><span class=w> </span><span class=nf>的内容被改为</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=err>，</span><span class=n>而</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=n>的内</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>容被改为</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=n>并链向</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>第一次循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>第二次循环</span><span class=err>，</span><span class=n>注意这时</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=nf>是</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=n>并链向</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=n>所以</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=nf>又是</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>第三次循环</span><span class=err>，</span><span class=n>e</span><span class=w> </span><span class=nf>是</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=err>，</span><span class=n>而</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=n>是</span><span class=w> </span><span class=kc>null</span><span class=err>，</span><span class=n>但</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=n>被放入链表头</span><span class=err>，</span><span class=n>这样</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=n>变成了</span><span class=w> </span><span class=n>35</span><span class=w> </span><span class=err>（</span><span class=n>2</span><span class=w> </span><span class=n>处</span><span class=err>）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=n>35</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>已经是死链了</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>小结</strong></p><ul><li>究其原因，是因为在多线程环境下使用了非线程安全的 map 集合</li><li>JDK 8 虽然将扩容算法做了调整，不再将元素加入链表头（而是保持与扩容前一样的顺序），但仍不意味着能 够在多线程环境下能够安全扩容，还会出现其它问题（如扩容丢数据）</li></ul><h4 id=jdk-8-concurrenthashmap><a href=#jdk-8-concurrenthashmap class=header-anchor>#</a>
JDK 8 ConcurrentHashMap</h4><h5 id=重要属性和内部类><a href=#%e9%87%8d%e8%a6%81%e5%b1%9e%e6%80%a7%e5%92%8c%e5%86%85%e9%83%a8%e7%b1%bb class=header-anchor>#</a>
重要属性和内部类</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-478-1><a class=lnlinks href=#hl-478-1> 1</a>
</span><span class=lnt id=hl-478-2><a class=lnlinks href=#hl-478-2> 2</a>
</span><span class=lnt id=hl-478-3><a class=lnlinks href=#hl-478-3> 3</a>
</span><span class=lnt id=hl-478-4><a class=lnlinks href=#hl-478-4> 4</a>
</span><span class=lnt id=hl-478-5><a class=lnlinks href=#hl-478-5> 5</a>
</span><span class=lnt id=hl-478-6><a class=lnlinks href=#hl-478-6> 6</a>
</span><span class=lnt id=hl-478-7><a class=lnlinks href=#hl-478-7> 7</a>
</span><span class=lnt id=hl-478-8><a class=lnlinks href=#hl-478-8> 8</a>
</span><span class=lnt id=hl-478-9><a class=lnlinks href=#hl-478-9> 9</a>
</span><span class=lnt id=hl-478-10><a class=lnlinks href=#hl-478-10>10</a>
</span><span class=lnt id=hl-478-11><a class=lnlinks href=#hl-478-11>11</a>
</span><span class=lnt id=hl-478-12><a class=lnlinks href=#hl-478-12>12</a>
</span><span class=lnt id=hl-478-13><a class=lnlinks href=#hl-478-13>13</a>
</span><span class=lnt id=hl-478-14><a class=lnlinks href=#hl-478-14>14</a>
</span><span class=lnt id=hl-478-15><a class=lnlinks href=#hl-478-15>15</a>
</span><span class=lnt id=hl-478-16><a class=lnlinks href=#hl-478-16>16</a>
</span><span class=lnt id=hl-478-17><a class=lnlinks href=#hl-478-17>17</a>
</span><span class=lnt id=hl-478-18><a class=lnlinks href=#hl-478-18>18</a>
</span><span class=lnt id=hl-478-19><a class=lnlinks href=#hl-478-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 默认为 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 当初始化时, 为 -1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 当扩容时, 为 -(1 + 扩容线程数)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 当初始化或扩容完成后，为 下一次的扩容的阈值大小</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>sizeCtl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 整个 ConcurrentHashMap 就是一个 Node[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// hash 表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>table</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 扩容时的 新 hash 表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>nextTable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 扩容时如果某个 bin 迁移完毕, 用 ForwardingNode 作为旧 table bin 的头结点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ForwardingNode</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 用在 compute 以及 computeIfAbsent 时, 用来占位, 计算完成后替换为普通 Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ReservationNode</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 作为 treebin 的头节点, 存储 root 和 first</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>TreeBin</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 作为 treebin 的节点, 存储 parent, left, right</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=重要方法><a href=#%e9%87%8d%e8%a6%81%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
重要方法</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-479-1><a class=lnlinks href=#hl-479-1>1</a>
</span><span class=lnt id=hl-479-2><a class=lnlinks href=#hl-479-2>2</a>
</span><span class=lnt id=hl-479-3><a class=lnlinks href=#hl-479-3>3</a>
</span><span class=lnt id=hl-479-4><a class=lnlinks href=#hl-479-4>4</a>
</span><span class=lnt id=hl-479-5><a class=lnlinks href=#hl-479-5>5</a>
</span><span class=lnt id=hl-479-6><a class=lnlinks href=#hl-479-6>6</a>
</span><span class=lnt id=hl-479-7><a class=lnlinks href=#hl-479-7>7</a>
</span><span class=lnt id=hl-479-8><a class=lnlinks href=#hl-479-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 获取 Node[] 中第 i 个 Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=nf>tabAt</span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// cas 修改 Node[] 中第 i 个 Node 的值, c 为旧值, v 为新值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>casTabAt</span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 直接修改 Node[] 中第 i 个 Node 的值, v 为新值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setTabAt</span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=构造器分析><a href=#%e6%9e%84%e9%80%a0%e5%99%a8%e5%88%86%e6%9e%90 class=header-anchor>#</a>
构造器分析</h5><p>可以看到实现了懒惰初始化，在构造方法中仅仅计算了 table 的大小，以后在第一次使用时才会真正创建</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-480-1><a class=lnlinks href=#hl-480-1> 1</a>
</span><span class=lnt id=hl-480-2><a class=lnlinks href=#hl-480-2> 2</a>
</span><span class=lnt id=hl-480-3><a class=lnlinks href=#hl-480-3> 3</a>
</span><span class=lnt id=hl-480-4><a class=lnlinks href=#hl-480-4> 4</a>
</span><span class=lnt id=hl-480-5><a class=lnlinks href=#hl-480-5> 5</a>
</span><span class=lnt id=hl-480-6><a class=lnlinks href=#hl-480-6> 6</a>
</span><span class=lnt id=hl-480-7><a class=lnlinks href=#hl-480-7> 7</a>
</span><span class=lnt id=hl-480-8><a class=lnlinks href=#hl-480-8> 8</a>
</span><span class=lnt id=hl-480-9><a class=lnlinks href=#hl-480-9> 9</a>
</span><span class=lnt id=hl-480-10><a class=lnlinks href=#hl-480-10>10</a>
</span><span class=lnt id=hl-480-11><a class=lnlinks href=#hl-480-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ConcurrentHashMap</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>initialCapacity</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>loadFactor</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>loadFactor</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>initialCapacity</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>initialCapacity</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=p>)</span><span class=w> </span><span class=c1>// Use at least as many bins</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>initialCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=p>;</span><span class=w> </span><span class=c1>// as estimated threads</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)(</span><span class=n>1</span><span class=p>.</span><span class=na>0</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>initialCapacity</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>loadFactor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// tableSizeFor 仍然是保证计算的大小是 2^n, 即 16,32,64 ... </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>cap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>MAXIMUM_CAPACITY</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MAXIMUM_CAPACITY</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>tableSizeFor</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>size</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>sizeCtl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=get流程><a href=#get%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
get流程</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-481-1><a class=lnlinks href=#hl-481-1> 1</a>
</span><span class=lnt id=hl-481-2><a class=lnlinks href=#hl-481-2> 2</a>
</span><span class=lnt id=hl-481-3><a class=lnlinks href=#hl-481-3> 3</a>
</span><span class=lnt id=hl-481-4><a class=lnlinks href=#hl-481-4> 4</a>
</span><span class=lnt id=hl-481-5><a class=lnlinks href=#hl-481-5> 5</a>
</span><span class=lnt id=hl-481-6><a class=lnlinks href=#hl-481-6> 6</a>
</span><span class=lnt id=hl-481-7><a class=lnlinks href=#hl-481-7> 7</a>
</span><span class=lnt id=hl-481-8><a class=lnlinks href=#hl-481-8> 8</a>
</span><span class=lnt id=hl-481-9><a class=lnlinks href=#hl-481-9> 9</a>
</span><span class=lnt id=hl-481-10><a class=lnlinks href=#hl-481-10>10</a>
</span><span class=lnt id=hl-481-11><a class=lnlinks href=#hl-481-11>11</a>
</span><span class=lnt id=hl-481-12><a class=lnlinks href=#hl-481-12>12</a>
</span><span class=lnt id=hl-481-13><a class=lnlinks href=#hl-481-13>13</a>
</span><span class=lnt id=hl-481-14><a class=lnlinks href=#hl-481-14>14</a>
</span><span class=lnt id=hl-481-15><a class=lnlinks href=#hl-481-15>15</a>
</span><span class=lnt id=hl-481-16><a class=lnlinks href=#hl-481-16>16</a>
</span><span class=lnt id=hl-481-17><a class=lnlinks href=#hl-481-17>17</a>
</span><span class=lnt id=hl-481-18><a class=lnlinks href=#hl-481-18>18</a>
</span><span class=lnt id=hl-481-19><a class=lnlinks href=#hl-481-19>19</a>
</span><span class=lnt id=hl-481-20><a class=lnlinks href=#hl-481-20>20</a>
</span><span class=lnt id=hl-481-21><a class=lnlinks href=#hl-481-21>21</a>
</span><span class=lnt id=hl-481-22><a class=lnlinks href=#hl-481-22>22</a>
</span><span class=lnt id=hl-481-23><a class=lnlinks href=#hl-481-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>;</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>eh</span><span class=p>;</span><span class=w> </span><span class=n>K</span><span class=w> </span><span class=n>ek</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// spread 方法能确保返回结果是正数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>spread</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>hashCode</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tabAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>h</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果头结点已经是要查找的 key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>eh</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>h</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>ek</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>ek</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>ek</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>val</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// hash 为负数表示该 bin 在扩容中或是 treebin, 这时调用 find 方法来查找</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>eh</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>find</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>val</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 正常遍历链表, 用 equals 比较</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>((</span><span class=n>ek</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>ek</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>ek</span><span class=p>))))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>val</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>总结：</p><ul><li>如果table不为空且长度大于0且索引位置有元素<ul><li>if 头节点key的hash值相等<ul><li>头节点的key指向同一个地址或者equals<ul><li>返回value</li></ul></li></ul></li><li>else if 头节点的hash为负数（bin在扩容或者是treebin）<ul><li>调用find方法查找</li></ul></li><li>进入循环（e不为空）：<ul><li>节点key的hash值相等，且key指向同一个地址或equals<ul><li>返回value</li></ul></li></ul></li></ul></li><li>返回null</li></ul><h5 id=put-流程><a href=#put-%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
put 流程</h5><p>以下数组简称（table），链表简称（bin）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-482-1><a class=lnlinks href=#hl-482-1>  1</a>
</span><span class=lnt id=hl-482-2><a class=lnlinks href=#hl-482-2>  2</a>
</span><span class=lnt id=hl-482-3><a class=lnlinks href=#hl-482-3>  3</a>
</span><span class=lnt id=hl-482-4><a class=lnlinks href=#hl-482-4>  4</a>
</span><span class=lnt id=hl-482-5><a class=lnlinks href=#hl-482-5>  5</a>
</span><span class=lnt id=hl-482-6><a class=lnlinks href=#hl-482-6>  6</a>
</span><span class=lnt id=hl-482-7><a class=lnlinks href=#hl-482-7>  7</a>
</span><span class=lnt id=hl-482-8><a class=lnlinks href=#hl-482-8>  8</a>
</span><span class=lnt id=hl-482-9><a class=lnlinks href=#hl-482-9>  9</a>
</span><span class=lnt id=hl-482-10><a class=lnlinks href=#hl-482-10> 10</a>
</span><span class=lnt id=hl-482-11><a class=lnlinks href=#hl-482-11> 11</a>
</span><span class=lnt id=hl-482-12><a class=lnlinks href=#hl-482-12> 12</a>
</span><span class=lnt id=hl-482-13><a class=lnlinks href=#hl-482-13> 13</a>
</span><span class=lnt id=hl-482-14><a class=lnlinks href=#hl-482-14> 14</a>
</span><span class=lnt id=hl-482-15><a class=lnlinks href=#hl-482-15> 15</a>
</span><span class=lnt id=hl-482-16><a class=lnlinks href=#hl-482-16> 16</a>
</span><span class=lnt id=hl-482-17><a class=lnlinks href=#hl-482-17> 17</a>
</span><span class=lnt id=hl-482-18><a class=lnlinks href=#hl-482-18> 18</a>
</span><span class=lnt id=hl-482-19><a class=lnlinks href=#hl-482-19> 19</a>
</span><span class=lnt id=hl-482-20><a class=lnlinks href=#hl-482-20> 20</a>
</span><span class=lnt id=hl-482-21><a class=lnlinks href=#hl-482-21> 21</a>
</span><span class=lnt id=hl-482-22><a class=lnlinks href=#hl-482-22> 22</a>
</span><span class=lnt id=hl-482-23><a class=lnlinks href=#hl-482-23> 23</a>
</span><span class=lnt id=hl-482-24><a class=lnlinks href=#hl-482-24> 24</a>
</span><span class=lnt id=hl-482-25><a class=lnlinks href=#hl-482-25> 25</a>
</span><span class=lnt id=hl-482-26><a class=lnlinks href=#hl-482-26> 26</a>
</span><span class=lnt id=hl-482-27><a class=lnlinks href=#hl-482-27> 27</a>
</span><span class=lnt id=hl-482-28><a class=lnlinks href=#hl-482-28> 28</a>
</span><span class=lnt id=hl-482-29><a class=lnlinks href=#hl-482-29> 29</a>
</span><span class=lnt id=hl-482-30><a class=lnlinks href=#hl-482-30> 30</a>
</span><span class=lnt id=hl-482-31><a class=lnlinks href=#hl-482-31> 31</a>
</span><span class=lnt id=hl-482-32><a class=lnlinks href=#hl-482-32> 32</a>
</span><span class=lnt id=hl-482-33><a class=lnlinks href=#hl-482-33> 33</a>
</span><span class=lnt id=hl-482-34><a class=lnlinks href=#hl-482-34> 34</a>
</span><span class=lnt id=hl-482-35><a class=lnlinks href=#hl-482-35> 35</a>
</span><span class=lnt id=hl-482-36><a class=lnlinks href=#hl-482-36> 36</a>
</span><span class=lnt id=hl-482-37><a class=lnlinks href=#hl-482-37> 37</a>
</span><span class=lnt id=hl-482-38><a class=lnlinks href=#hl-482-38> 38</a>
</span><span class=lnt id=hl-482-39><a class=lnlinks href=#hl-482-39> 39</a>
</span><span class=lnt id=hl-482-40><a class=lnlinks href=#hl-482-40> 40</a>
</span><span class=lnt id=hl-482-41><a class=lnlinks href=#hl-482-41> 41</a>
</span><span class=lnt id=hl-482-42><a class=lnlinks href=#hl-482-42> 42</a>
</span><span class=lnt id=hl-482-43><a class=lnlinks href=#hl-482-43> 43</a>
</span><span class=lnt id=hl-482-44><a class=lnlinks href=#hl-482-44> 44</a>
</span><span class=lnt id=hl-482-45><a class=lnlinks href=#hl-482-45> 45</a>
</span><span class=lnt id=hl-482-46><a class=lnlinks href=#hl-482-46> 46</a>
</span><span class=lnt id=hl-482-47><a class=lnlinks href=#hl-482-47> 47</a>
</span><span class=lnt id=hl-482-48><a class=lnlinks href=#hl-482-48> 48</a>
</span><span class=lnt id=hl-482-49><a class=lnlinks href=#hl-482-49> 49</a>
</span><span class=lnt id=hl-482-50><a class=lnlinks href=#hl-482-50> 50</a>
</span><span class=lnt id=hl-482-51><a class=lnlinks href=#hl-482-51> 51</a>
</span><span class=lnt id=hl-482-52><a class=lnlinks href=#hl-482-52> 52</a>
</span><span class=lnt id=hl-482-53><a class=lnlinks href=#hl-482-53> 53</a>
</span><span class=lnt id=hl-482-54><a class=lnlinks href=#hl-482-54> 54</a>
</span><span class=lnt id=hl-482-55><a class=lnlinks href=#hl-482-55> 55</a>
</span><span class=lnt id=hl-482-56><a class=lnlinks href=#hl-482-56> 56</a>
</span><span class=lnt id=hl-482-57><a class=lnlinks href=#hl-482-57> 57</a>
</span><span class=lnt id=hl-482-58><a class=lnlinks href=#hl-482-58> 58</a>
</span><span class=lnt id=hl-482-59><a class=lnlinks href=#hl-482-59> 59</a>
</span><span class=lnt id=hl-482-60><a class=lnlinks href=#hl-482-60> 60</a>
</span><span class=lnt id=hl-482-61><a class=lnlinks href=#hl-482-61> 61</a>
</span><span class=lnt id=hl-482-62><a class=lnlinks href=#hl-482-62> 62</a>
</span><span class=lnt id=hl-482-63><a class=lnlinks href=#hl-482-63> 63</a>
</span><span class=lnt id=hl-482-64><a class=lnlinks href=#hl-482-64> 64</a>
</span><span class=lnt id=hl-482-65><a class=lnlinks href=#hl-482-65> 65</a>
</span><span class=lnt id=hl-482-66><a class=lnlinks href=#hl-482-66> 66</a>
</span><span class=lnt id=hl-482-67><a class=lnlinks href=#hl-482-67> 67</a>
</span><span class=lnt id=hl-482-68><a class=lnlinks href=#hl-482-68> 68</a>
</span><span class=lnt id=hl-482-69><a class=lnlinks href=#hl-482-69> 69</a>
</span><span class=lnt id=hl-482-70><a class=lnlinks href=#hl-482-70> 70</a>
</span><span class=lnt id=hl-482-71><a class=lnlinks href=#hl-482-71> 71</a>
</span><span class=lnt id=hl-482-72><a class=lnlinks href=#hl-482-72> 72</a>
</span><span class=lnt id=hl-482-73><a class=lnlinks href=#hl-482-73> 73</a>
</span><span class=lnt id=hl-482-74><a class=lnlinks href=#hl-482-74> 74</a>
</span><span class=lnt id=hl-482-75><a class=lnlinks href=#hl-482-75> 75</a>
</span><span class=lnt id=hl-482-76><a class=lnlinks href=#hl-482-76> 76</a>
</span><span class=lnt id=hl-482-77><a class=lnlinks href=#hl-482-77> 77</a>
</span><span class=lnt id=hl-482-78><a class=lnlinks href=#hl-482-78> 78</a>
</span><span class=lnt id=hl-482-79><a class=lnlinks href=#hl-482-79> 79</a>
</span><span class=lnt id=hl-482-80><a class=lnlinks href=#hl-482-80> 80</a>
</span><span class=lnt id=hl-482-81><a class=lnlinks href=#hl-482-81> 81</a>
</span><span class=lnt id=hl-482-82><a class=lnlinks href=#hl-482-82> 82</a>
</span><span class=lnt id=hl-482-83><a class=lnlinks href=#hl-482-83> 83</a>
</span><span class=lnt id=hl-482-84><a class=lnlinks href=#hl-482-84> 84</a>
</span><span class=lnt id=hl-482-85><a class=lnlinks href=#hl-482-85> 85</a>
</span><span class=lnt id=hl-482-86><a class=lnlinks href=#hl-482-86> 86</a>
</span><span class=lnt id=hl-482-87><a class=lnlinks href=#hl-482-87> 87</a>
</span><span class=lnt id=hl-482-88><a class=lnlinks href=#hl-482-88> 88</a>
</span><span class=lnt id=hl-482-89><a class=lnlinks href=#hl-482-89> 89</a>
</span><span class=lnt id=hl-482-90><a class=lnlinks href=#hl-482-90> 90</a>
</span><span class=lnt id=hl-482-91><a class=lnlinks href=#hl-482-91> 91</a>
</span><span class=lnt id=hl-482-92><a class=lnlinks href=#hl-482-92> 92</a>
</span><span class=lnt id=hl-482-93><a class=lnlinks href=#hl-482-93> 93</a>
</span><span class=lnt id=hl-482-94><a class=lnlinks href=#hl-482-94> 94</a>
</span><span class=lnt id=hl-482-95><a class=lnlinks href=#hl-482-95> 95</a>
</span><span class=lnt id=hl-482-96><a class=lnlinks href=#hl-482-96> 96</a>
</span><span class=lnt id=hl-482-97><a class=lnlinks href=#hl-482-97> 97</a>
</span><span class=lnt id=hl-482-98><a class=lnlinks href=#hl-482-98> 98</a>
</span><span class=lnt id=hl-482-99><a class=lnlinks href=#hl-482-99> 99</a>
</span><span class=lnt id=hl-482-100><a class=lnlinks href=#hl-482-100>100</a>
</span><span class=lnt id=hl-482-101><a class=lnlinks href=#hl-482-101>101</a>
</span><span class=lnt id=hl-482-102><a class=lnlinks href=#hl-482-102>102</a>
</span><span class=lnt id=hl-482-103><a class=lnlinks href=#hl-482-103>103</a>
</span><span class=lnt id=hl-482-104><a class=lnlinks href=#hl-482-104>104</a>
</span><span class=lnt id=hl-482-105><a class=lnlinks href=#hl-482-105>105</a>
</span><span class=lnt id=hl-482-106><a class=lnlinks href=#hl-482-106>106</a>
</span><span class=lnt id=hl-482-107><a class=lnlinks href=#hl-482-107>107</a>
</span><span class=lnt id=hl-482-108><a class=lnlinks href=#hl-482-108>108</a>
</span><span class=lnt id=hl-482-109><a class=lnlinks href=#hl-482-109>109</a>
</span><span class=lnt id=hl-482-110><a class=lnlinks href=#hl-482-110>110</a>
</span><span class=lnt id=hl-482-111><a class=lnlinks href=#hl-482-111>111</a>
</span><span class=lnt id=hl-482-112><a class=lnlinks href=#hl-482-112>112</a>
</span><span class=lnt id=hl-482-113><a class=lnlinks href=#hl-482-113>113</a>
</span><span class=lnt id=hl-482-114><a class=lnlinks href=#hl-482-114>114</a>
</span><span class=lnt id=hl-482-115><a class=lnlinks href=#hl-482-115>115</a>
</span><span class=lnt id=hl-482-116><a class=lnlinks href=#hl-482-116>116</a>
</span><span class=lnt id=hl-482-117><a class=lnlinks href=#hl-482-117>117</a>
</span><span class=lnt id=hl-482-118><a class=lnlinks href=#hl-482-118>118</a>
</span><span class=lnt id=hl-482-119><a class=lnlinks href=#hl-482-119>119</a>
</span><span class=lnt id=hl-482-120><a class=lnlinks href=#hl-482-120>120</a>
</span><span class=lnt id=hl-482-121><a class=lnlinks href=#hl-482-121>121</a>
</span><span class=lnt id=hl-482-122><a class=lnlinks href=#hl-482-122>122</a>
</span><span class=lnt id=hl-482-123><a class=lnlinks href=#hl-482-123>123</a>
</span><span class=lnt id=hl-482-124><a class=lnlinks href=#hl-482-124>124</a>
</span><span class=lnt id=hl-482-125><a class=lnlinks href=#hl-482-125>125</a>
</span><span class=lnt id=hl-482-126><a class=lnlinks href=#hl-482-126>126</a>
</span><span class=lnt id=hl-482-127><a class=lnlinks href=#hl-482-127>127</a>
</span><span class=lnt id=hl-482-128><a class=lnlinks href=#hl-482-128>128</a>
</span><span class=lnt id=hl-482-129><a class=lnlinks href=#hl-482-129>129</a>
</span><span class=lnt id=hl-482-130><a class=lnlinks href=#hl-482-130>130</a>
</span><span class=lnt id=hl-482-131><a class=lnlinks href=#hl-482-131>131</a>
</span><span class=lnt id=hl-482-132><a class=lnlinks href=#hl-482-132>132</a>
</span><span class=lnt id=hl-482-133><a class=lnlinks href=#hl-482-133>133</a>
</span><span class=lnt id=hl-482-134><a class=lnlinks href=#hl-482-134>134</a>
</span><span class=lnt id=hl-482-135><a class=lnlinks href=#hl-482-135>135</a>
</span><span class=lnt id=hl-482-136><a class=lnlinks href=#hl-482-136>136</a>
</span><span class=lnt id=hl-482-137><a class=lnlinks href=#hl-482-137>137</a>
</span><span class=lnt id=hl-482-138><a class=lnlinks href=#hl-482-138>138</a>
</span><span class=lnt id=hl-482-139><a class=lnlinks href=#hl-482-139>139</a>
</span><span class=lnt id=hl-482-140><a class=lnlinks href=#hl-482-140>140</a>
</span><span class=lnt id=hl-482-141><a class=lnlinks href=#hl-482-141>141</a>
</span><span class=lnt id=hl-482-142><a class=lnlinks href=#hl-482-142>142</a>
</span><span class=lnt id=hl-482-143><a class=lnlinks href=#hl-482-143>143</a>
</span><span class=lnt id=hl-482-144><a class=lnlinks href=#hl-482-144>144</a>
</span><span class=lnt id=hl-482-145><a class=lnlinks href=#hl-482-145>145</a>
</span><span class=lnt id=hl-482-146><a class=lnlinks href=#hl-482-146>146</a>
</span><span class=lnt id=hl-482-147><a class=lnlinks href=#hl-482-147>147</a>
</span><span class=lnt id=hl-482-148><a class=lnlinks href=#hl-482-148>148</a>
</span><span class=lnt id=hl-482-149><a class=lnlinks href=#hl-482-149>149</a>
</span><span class=lnt id=hl-482-150><a class=lnlinks href=#hl-482-150>150</a>
</span><span class=lnt id=hl-482-151><a class=lnlinks href=#hl-482-151>151</a>
</span><span class=lnt id=hl-482-152><a class=lnlinks href=#hl-482-152>152</a>
</span><span class=lnt id=hl-482-153><a class=lnlinks href=#hl-482-153>153</a>
</span><span class=lnt id=hl-482-154><a class=lnlinks href=#hl-482-154>154</a>
</span><span class=lnt id=hl-482-155><a class=lnlinks href=#hl-482-155>155</a>
</span><span class=lnt id=hl-482-156><a class=lnlinks href=#hl-482-156>156</a>
</span><span class=lnt id=hl-482-157><a class=lnlinks href=#hl-482-157>157</a>
</span><span class=lnt id=hl-482-158><a class=lnlinks href=#hl-482-158>158</a>
</span><span class=lnt id=hl-482-159><a class=lnlinks href=#hl-482-159>159</a>
</span><span class=lnt id=hl-482-160><a class=lnlinks href=#hl-482-160>160</a>
</span><span class=lnt id=hl-482-161><a class=lnlinks href=#hl-482-161>161</a>
</span><span class=lnt id=hl-482-162><a class=lnlinks href=#hl-482-162>162</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>putVal</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>final</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>putVal</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>onlyIfAbsent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NullPointerException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 其中 spread 方法会综合高位低位, 具有更好的 hash 性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>spread</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>hashCode</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>binCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// f 是链表头节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// fh 是链表头结点的 hash</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// i 是链表在 table 中的下标</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>fh</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 要创建 table</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tab</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 初始化 table 使用了 cas, 无需 synchronized 创建成功, 进入下一轮循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>initTable</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 要创建链表头节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tabAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>hash</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 添加链表头使用了 cas, 无需 synchronized</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>casTabAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 帮忙扩容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>fh</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>hash</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MOVED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 帮忙之后, 进入下一轮循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helpTransfer</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>V</span><span class=w> </span><span class=n>oldVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 锁住链表头节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 再次确认链表头节点没有被移动</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tabAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 链表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fh</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>binCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// 遍历链表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>;;</span><span class=w> </span><span class=o>++</span><span class=n>binCount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>K</span><span class=w> </span><span class=n>ek</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// 找到相同的 key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>((</span><span class=n>ek</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                 </span><span class=p>(</span><span class=n>ek</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>ek</span><span class=p>))))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>oldVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>val</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// 更新</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>onlyIfAbsent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>e</span><span class=p>.</span><span class=na>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// 已经是最后的节点了, 新增 Node, 追加至链表尾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                          </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 红黑树</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>TreeBin</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>binCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// putTreeVal 会看 key 是否已经在树中, 是, 则返回对应的 TreeNode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>TreeBin</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=n>f</span><span class=p>).</span><span class=na>putTreeVal</span><span class=p>(</span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                              </span><span class=n>value</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>oldVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>val</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>onlyIfAbsent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>p</span><span class=p>.</span><span class=na>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 释放链表头节点的锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>binCount</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>binCount</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>TREEIFY_THRESHOLD</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 如果链表长度 &gt;= 树化阈值(8), 进行链表转为红黑树</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>treeifyBin</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>oldVal</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>oldVal</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 增加 size 计数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>addCount</span><span class=p>(</span><span class=n>1L</span><span class=p>,</span><span class=w> </span><span class=n>binCount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=nf>initTable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>sc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sizeCtl</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>yield</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 尝试将 sizeCtl 设置为 -1（表示初始化 table）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>U</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>SIZECTL</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获得锁, 创建 table, 这时其它线程会在 while() 循环中 yield 直至 table 创建</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>sc</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>DEFAULT_CAPACITY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>nt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=p>)</span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;?</span><span class=p>,</span><span class=o>?&gt;[</span><span class=n>n</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sizeCtl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>tab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// check 是之前 binCount 的个数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addCount</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>check</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CounterCell</span><span class=o>[]</span><span class=w> </span><span class=n>as</span><span class=p>;</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 已经有了 counterCells, 向 cell 累加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>counterCells</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 还没有, 向 baseCount 累加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>!</span><span class=n>U</span><span class=p>.</span><span class=na>compareAndSwapLong</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>BASECOUNT</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>baseCount</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CounterCell</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>m</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>uncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 还没有 counterCells</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>as</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 还没有 cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=o>[</span><span class=n>ThreadLocalRandom</span><span class=p>.</span><span class=na>getProbe</span><span class=p>()</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>m</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// cell cas 增加计数失败</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=p>(</span><span class=n>uncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>U</span><span class=p>.</span><span class=na>compareAndSwapLong</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>CELLVALUE</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>value</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 创建累加单元数组和cell, 累加重试</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fullAddCount</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>uncontended</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>check</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取元素个数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sumCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>check</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>nt</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)(</span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sizeCtl</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>MAXIMUM_CAPACITY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resizeStamp</span><span class=p>(</span><span class=n>n</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>sc</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>RESIZE_STAMP_SHIFT</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>sc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MAX_RESIZERS</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>nt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextTable</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>transferIndex</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// newtable 已经创建了，帮忙扩容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>U</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>SIZECTL</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>transfer</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>nt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 需要扩容，这时 newtable 未创建</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>U</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>SIZECTL</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                         </span><span class=p>(</span><span class=n>rs</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>RESIZE_STAMP_SHIFT</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>2</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>transfer</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sumCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>总结：</p><ul><li>进入for循环：<ul><li>if table为null或者长度 为0<ul><li>初始化表</li></ul></li><li>else if 索引处无节点<ul><li>创建节点，填入key和value，放入table，退出循环</li></ul></li><li>else if 索引处节点的hash值为MOVE（ForwardingNode），表示正在扩容和迁移<ul><li>帮忙</li></ul></li><li>else<ul><li>锁住头节点<ul><li>if 再次确认头节点没有被移动<ul><li>if 头节点hash值大于0（表示这是一个链表）<ul><li>遍历链表找到对应key，如果没有，创建。</li></ul></li><li>else if 节点为红黑树节点<ul><li>调用<code>putTreeVal</code>查看是否有对应key的数节点<ul><li>如果有且为覆盖模式，将值覆盖，返回旧值</li><li>如果没有，创建并插入，返回null</li></ul></li></ul></li></ul></li><li>解锁</li></ul></li><li>if binCount不为0<ul><li>如果binCount大于树化阈值8<ul><li>树化</li></ul></li><li>如果旧值不为null<ul><li>返回旧值</li></ul></li><li>break</li></ul></li></ul></li></ul></li><li>增加size计数</li><li>return null</li></ul><h5 id=size-计算流程><a href=#size-%e8%ae%a1%e7%ae%97%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
size 计算流程</h5><p>size 计算实际发生在 put，remove 改变集合元素的操作之中</p><ul><li>没有竞争发生，向 baseCount 累加计数</li><li>有竞争发生，新建 counterCells，向其中的一个 cell 累加计<ul><li>counterCells 初始有两个 cell</li><li>如果计数竞争比较激烈，会创建新的 cell 来累加计数</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-483-1><a class=lnlinks href=#hl-483-1> 1</a>
</span><span class=lnt id=hl-483-2><a class=lnlinks href=#hl-483-2> 2</a>
</span><span class=lnt id=hl-483-3><a class=lnlinks href=#hl-483-3> 3</a>
</span><span class=lnt id=hl-483-4><a class=lnlinks href=#hl-483-4> 4</a>
</span><span class=lnt id=hl-483-5><a class=lnlinks href=#hl-483-5> 5</a>
</span><span class=lnt id=hl-483-6><a class=lnlinks href=#hl-483-6> 6</a>
</span><span class=lnt id=hl-483-7><a class=lnlinks href=#hl-483-7> 7</a>
</span><span class=lnt id=hl-483-8><a class=lnlinks href=#hl-483-8> 8</a>
</span><span class=lnt id=hl-483-9><a class=lnlinks href=#hl-483-9> 9</a>
</span><span class=lnt id=hl-483-10><a class=lnlinks href=#hl-483-10>10</a>
</span><span class=lnt id=hl-483-11><a class=lnlinks href=#hl-483-11>11</a>
</span><span class=lnt id=hl-483-12><a class=lnlinks href=#hl-483-12>12</a>
</span><span class=lnt id=hl-483-13><a class=lnlinks href=#hl-483-13>13</a>
</span><span class=lnt id=hl-483-14><a class=lnlinks href=#hl-483-14>14</a>
</span><span class=lnt id=hl-483-15><a class=lnlinks href=#hl-483-15>15</a>
</span><span class=lnt id=hl-483-16><a class=lnlinks href=#hl-483-16>16</a>
</span><span class=lnt id=hl-483-17><a class=lnlinks href=#hl-483-17>17</a>
</span><span class=lnt id=hl-483-18><a class=lnlinks href=#hl-483-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>size</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sumCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>n</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0L</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>n</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>sumCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CounterCell</span><span class=o>[]</span><span class=w> </span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>counterCells</span><span class=p>;</span><span class=w> </span><span class=n>CounterCell</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 将 baseCount 计数与所有 cell 计数累加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>baseCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>as</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=总结><a href=#%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
总结</h5><p><strong>Java 8</strong> 数组（Node） +（ 链表 Node | 红黑树 TreeNode ） 以下数组简称（table），链表简称（bin）</p><ul><li>初始化，使用 cas 来保证并发安全，懒惰初始化 table</li><li>树化，当 table.length &lt; 64 时，先尝试扩容，超过 64 时，并且 bin.length > 8 时，会将链表树化，树化过程 会用 synchronized 锁住链表头</li><li>put，如果该 bin 尚未创建，只需要使用 cas 创建 bin；如果已经有了，锁住链表头进行后续 put 操作，元素 添加至 bin 的尾部</li><li>get，无锁操作仅需要保证可见性，扩容过程中 get 操作拿到的是 ForwardingNode 它会让 get 操作在新 table 进行搜索</li><li>扩容，扩容时以 bin 为单位进行，需要对 bin 进行 synchronized，但这时妙的是其它竞争线程也不是无事可 做，它们会帮助把其它 bin 进行扩容，扩容时平均只有 1/6 的节点会把复制到新 table 中</li><li>size，元素个数保存在 baseCount 中，并发时的个数变动保存在 CounterCell[] 当中。最后统计数量时累加 即可</li></ul><p>源码分析 <a class=link href=http://www.importnew.com/28263.html target=_blank rel=noopener>http://www.importnew.com/28263.html
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><p>其它实现 <a class=link href=https://github.com/boundary/high-scale-lib target=_blank rel=noopener>Cliff Click&rsquo;s high scale lib
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><h4 id=jdk-7-concurrenthashmap><a href=#jdk-7-concurrenthashmap class=header-anchor>#</a>
JDK 7 ConcurrentHashMap</h4><p>它维护了一个 segment 数组，每个 segment 对应一把锁</p><ul><li>优点：如果多个线程访问不同的 segment，实际是没有冲突的，这与 jdk8 中是类似的</li><li>缺点：Segments 数组默认大小为16，这个容量初始化指定后就不能改变了，并且不是懒惰初始化</li></ul><h5 id=构造器分析-1><a href=#%e6%9e%84%e9%80%a0%e5%99%a8%e5%88%86%e6%9e%90-1 class=header-anchor>#</a>
构造器分析</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-484-1><a class=lnlinks href=#hl-484-1> 1</a>
</span><span class=lnt id=hl-484-2><a class=lnlinks href=#hl-484-2> 2</a>
</span><span class=lnt id=hl-484-3><a class=lnlinks href=#hl-484-3> 3</a>
</span><span class=lnt id=hl-484-4><a class=lnlinks href=#hl-484-4> 4</a>
</span><span class=lnt id=hl-484-5><a class=lnlinks href=#hl-484-5> 5</a>
</span><span class=lnt id=hl-484-6><a class=lnlinks href=#hl-484-6> 6</a>
</span><span class=lnt id=hl-484-7><a class=lnlinks href=#hl-484-7> 7</a>
</span><span class=lnt id=hl-484-8><a class=lnlinks href=#hl-484-8> 8</a>
</span><span class=lnt id=hl-484-9><a class=lnlinks href=#hl-484-9> 9</a>
</span><span class=lnt id=hl-484-10><a class=lnlinks href=#hl-484-10>10</a>
</span><span class=lnt id=hl-484-11><a class=lnlinks href=#hl-484-11>11</a>
</span><span class=lnt id=hl-484-12><a class=lnlinks href=#hl-484-12>12</a>
</span><span class=lnt id=hl-484-13><a class=lnlinks href=#hl-484-13>13</a>
</span><span class=lnt id=hl-484-14><a class=lnlinks href=#hl-484-14>14</a>
</span><span class=lnt id=hl-484-15><a class=lnlinks href=#hl-484-15>15</a>
</span><span class=lnt id=hl-484-16><a class=lnlinks href=#hl-484-16>16</a>
</span><span class=lnt id=hl-484-17><a class=lnlinks href=#hl-484-17>17</a>
</span><span class=lnt id=hl-484-18><a class=lnlinks href=#hl-484-18>18</a>
</span><span class=lnt id=hl-484-19><a class=lnlinks href=#hl-484-19>19</a>
</span><span class=lnt id=hl-484-20><a class=lnlinks href=#hl-484-20>20</a>
</span><span class=lnt id=hl-484-21><a class=lnlinks href=#hl-484-21>21</a>
</span><span class=lnt id=hl-484-22><a class=lnlinks href=#hl-484-22>22</a>
</span><span class=lnt id=hl-484-23><a class=lnlinks href=#hl-484-23>23</a>
</span><span class=lnt id=hl-484-24><a class=lnlinks href=#hl-484-24>24</a>
</span><span class=lnt id=hl-484-25><a class=lnlinks href=#hl-484-25>25</a>
</span><span class=lnt id=hl-484-26><a class=lnlinks href=#hl-484-26>26</a>
</span><span class=lnt id=hl-484-27><a class=lnlinks href=#hl-484-27>27</a>
</span><span class=lnt id=hl-484-28><a class=lnlinks href=#hl-484-28>28</a>
</span><span class=lnt id=hl-484-29><a class=lnlinks href=#hl-484-29>29</a>
</span><span class=lnt id=hl-484-30><a class=lnlinks href=#hl-484-30>30</a>
</span><span class=lnt id=hl-484-31><a class=lnlinks href=#hl-484-31>31</a>
</span><span class=lnt id=hl-484-32><a class=lnlinks href=#hl-484-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ConcurrentHashMap</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>initialCapacity</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>loadFactor</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>loadFactor</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>initialCapacity</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>concurrencyLevel</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>MAX_SEGMENTS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>concurrencyLevel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MAX_SEGMENTS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ssize 必须是 2^n, 即 2, 4, 8, 16 ... 表示了 segments 数组的大小</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>sshift</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ssize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>ssize</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>++</span><span class=n>sshift</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ssize</span><span class=w> </span><span class=o>&lt;&lt;=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// segmentShift 默认是 32 - 4 = 28</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>segmentShift</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>32</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>sshift</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// segmentMask 默认是 15 即 0000 0000 0000 1111</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>segmentMask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ssize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>initialCapacity</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>MAXIMUM_CAPACITY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>initialCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MAXIMUM_CAPACITY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>initialCapacity</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>ssize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>ssize</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>initialCapacity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>++</span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>cap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MIN_SEGMENT_TABLE_CAPACITY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>cap</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cap</span><span class=w> </span><span class=o>&lt;&lt;=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 创建 segments and segments[0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>s0</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>loadFactor</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>cap</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>loadFactor</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=p>)</span><span class=k>new</span><span class=w> </span><span class=n>HashEntry</span><span class=o>[</span><span class=n>cap</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>ss</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=p>)</span><span class=k>new</span><span class=w> </span><span class=n>Segment</span><span class=o>[</span><span class=n>ssize</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>putOrderedObject</span><span class=p>(</span><span class=n>ss</span><span class=p>,</span><span class=w> </span><span class=n>SBASE</span><span class=p>,</span><span class=w> </span><span class=n>s0</span><span class=p>);</span><span class=w> </span><span class=c1>// ordered write of segments[0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>segments</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ss</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>构造完成，如下图所示</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317180837785.png width=900 height=600 loading=lazy decoding=async alt=image-20220317180837785 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>可以看到 ConcurrentHashMap 没有实现懒惰初始化，空间占用不友好</p><p>其中 this.segmentShift 和 this.segmentMask 的作用是决定将 key 的 hash 结果匹配到哪个 segment</p><p>例如，根据某一 hash 值求 segment 位置，先将高位向低位移动 this.segmentShift 位</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317180919562.png width=900 height=600 loading=lazy decoding=async alt=image-20220317180919562 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>结果再与 this.segmentMask 做位于运算，最终得到 1010 即下标为 10 的 segment</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317180935914.png width=900 height=600 loading=lazy decoding=async alt=image-20220317180935914 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=put-流程-1><a href=#put-%e6%b5%81%e7%a8%8b-1 class=header-anchor>#</a>
put 流程</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-485-1><a class=lnlinks href=#hl-485-1> 1</a>
</span><span class=lnt id=hl-485-2><a class=lnlinks href=#hl-485-2> 2</a>
</span><span class=lnt id=hl-485-3><a class=lnlinks href=#hl-485-3> 3</a>
</span><span class=lnt id=hl-485-4><a class=lnlinks href=#hl-485-4> 4</a>
</span><span class=lnt id=hl-485-5><a class=lnlinks href=#hl-485-5> 5</a>
</span><span class=lnt id=hl-485-6><a class=lnlinks href=#hl-485-6> 6</a>
</span><span class=lnt id=hl-485-7><a class=lnlinks href=#hl-485-7> 7</a>
</span><span class=lnt id=hl-485-8><a class=lnlinks href=#hl-485-8> 8</a>
</span><span class=lnt id=hl-485-9><a class=lnlinks href=#hl-485-9> 9</a>
</span><span class=lnt id=hl-485-10><a class=lnlinks href=#hl-485-10>10</a>
</span><span class=lnt id=hl-485-11><a class=lnlinks href=#hl-485-11>11</a>
</span><span class=lnt id=hl-485-12><a class=lnlinks href=#hl-485-12>12</a>
</span><span class=lnt id=hl-485-13><a class=lnlinks href=#hl-485-13>13</a>
</span><span class=lnt id=hl-485-14><a class=lnlinks href=#hl-485-14>14</a>
</span><span class=lnt id=hl-485-15><a class=lnlinks href=#hl-485-15>15</a>
</span><span class=lnt id=hl-485-16><a class=lnlinks href=#hl-485-16>16</a>
</span><span class=lnt id=hl-485-17><a class=lnlinks href=#hl-485-17>17</a>
</span><span class=lnt id=hl-485-18><a class=lnlinks href=#hl-485-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NullPointerException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 计算出 segment 下标</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>hash</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>segmentShift</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>segmentMask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 获得 segment 对象, 判断是否为 null, 是则创建该 segment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>getObject</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>(</span><span class=n>segments</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>j</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>SSHIFT</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>SBASE</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这时不能确定是否真的为 null, 因为其它线程也发现该 segment 为 null,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 因此在 ensureSegment 里用 cas 方式保证该 segment 安全性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ensureSegment</span><span class=p>(</span><span class=n>j</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 进入 segment 的put 流程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>segment 继承了可重入锁（ReentrantLock），它的 put 方法为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-486-1><a class=lnlinks href=#hl-486-1> 1</a>
</span><span class=lnt id=hl-486-2><a class=lnlinks href=#hl-486-2> 2</a>
</span><span class=lnt id=hl-486-3><a class=lnlinks href=#hl-486-3> 3</a>
</span><span class=lnt id=hl-486-4><a class=lnlinks href=#hl-486-4> 4</a>
</span><span class=lnt id=hl-486-5><a class=lnlinks href=#hl-486-5> 5</a>
</span><span class=lnt id=hl-486-6><a class=lnlinks href=#hl-486-6> 6</a>
</span><span class=lnt id=hl-486-7><a class=lnlinks href=#hl-486-7> 7</a>
</span><span class=lnt id=hl-486-8><a class=lnlinks href=#hl-486-8> 8</a>
</span><span class=lnt id=hl-486-9><a class=lnlinks href=#hl-486-9> 9</a>
</span><span class=lnt id=hl-486-10><a class=lnlinks href=#hl-486-10>10</a>
</span><span class=lnt id=hl-486-11><a class=lnlinks href=#hl-486-11>11</a>
</span><span class=lnt id=hl-486-12><a class=lnlinks href=#hl-486-12>12</a>
</span><span class=lnt id=hl-486-13><a class=lnlinks href=#hl-486-13>13</a>
</span><span class=lnt id=hl-486-14><a class=lnlinks href=#hl-486-14>14</a>
</span><span class=lnt id=hl-486-15><a class=lnlinks href=#hl-486-15>15</a>
</span><span class=lnt id=hl-486-16><a class=lnlinks href=#hl-486-16>16</a>
</span><span class=lnt id=hl-486-17><a class=lnlinks href=#hl-486-17>17</a>
</span><span class=lnt id=hl-486-18><a class=lnlinks href=#hl-486-18>18</a>
</span><span class=lnt id=hl-486-19><a class=lnlinks href=#hl-486-19>19</a>
</span><span class=lnt id=hl-486-20><a class=lnlinks href=#hl-486-20>20</a>
</span><span class=lnt id=hl-486-21><a class=lnlinks href=#hl-486-21>21</a>
</span><span class=lnt id=hl-486-22><a class=lnlinks href=#hl-486-22>22</a>
</span><span class=lnt id=hl-486-23><a class=lnlinks href=#hl-486-23>23</a>
</span><span class=lnt id=hl-486-24><a class=lnlinks href=#hl-486-24>24</a>
</span><span class=lnt id=hl-486-25><a class=lnlinks href=#hl-486-25>25</a>
</span><span class=lnt id=hl-486-26><a class=lnlinks href=#hl-486-26>26</a>
</span><span class=lnt id=hl-486-27><a class=lnlinks href=#hl-486-27>27</a>
</span><span class=lnt id=hl-486-28><a class=lnlinks href=#hl-486-28>28</a>
</span><span class=lnt id=hl-486-29><a class=lnlinks href=#hl-486-29>29</a>
</span><span class=lnt id=hl-486-30><a class=lnlinks href=#hl-486-30>30</a>
</span><span class=lnt id=hl-486-31><a class=lnlinks href=#hl-486-31>31</a>
</span><span class=lnt id=hl-486-32><a class=lnlinks href=#hl-486-32>32</a>
</span><span class=lnt id=hl-486-33><a class=lnlinks href=#hl-486-33>33</a>
</span><span class=lnt id=hl-486-34><a class=lnlinks href=#hl-486-34>34</a>
</span><span class=lnt id=hl-486-35><a class=lnlinks href=#hl-486-35>35</a>
</span><span class=lnt id=hl-486-36><a class=lnlinks href=#hl-486-36>36</a>
</span><span class=lnt id=hl-486-37><a class=lnlinks href=#hl-486-37>37</a>
</span><span class=lnt id=hl-486-38><a class=lnlinks href=#hl-486-38>38</a>
</span><span class=lnt id=hl-486-39><a class=lnlinks href=#hl-486-39>39</a>
</span><span class=lnt id=hl-486-40><a class=lnlinks href=#hl-486-40>40</a>
</span><span class=lnt id=hl-486-41><a class=lnlinks href=#hl-486-41>41</a>
</span><span class=lnt id=hl-486-42><a class=lnlinks href=#hl-486-42>42</a>
</span><span class=lnt id=hl-486-43><a class=lnlinks href=#hl-486-43>43</a>
</span><span class=lnt id=hl-486-44><a class=lnlinks href=#hl-486-44>44</a>
</span><span class=lnt id=hl-486-45><a class=lnlinks href=#hl-486-45>45</a>
</span><span class=lnt id=hl-486-46><a class=lnlinks href=#hl-486-46>46</a>
</span><span class=lnt id=hl-486-47><a class=lnlinks href=#hl-486-47>47</a>
</span><span class=lnt id=hl-486-48><a class=lnlinks href=#hl-486-48>48</a>
</span><span class=lnt id=hl-486-49><a class=lnlinks href=#hl-486-49>49</a>
</span><span class=lnt id=hl-486-50><a class=lnlinks href=#hl-486-50>50</a>
</span><span class=lnt id=hl-486-51><a class=lnlinks href=#hl-486-51>51</a>
</span><span class=lnt id=hl-486-52><a class=lnlinks href=#hl-486-52>52</a>
</span><span class=lnt id=hl-486-53><a class=lnlinks href=#hl-486-53>53</a>
</span><span class=lnt id=hl-486-54><a class=lnlinks href=#hl-486-54>54</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>onlyIfAbsent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试加锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tryLock</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果不成功, 进入 scanAndLockForPut 流程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果是多核 cpu 最多 tryLock 64 次, 进入 lock 流程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 在尝试期间, 还可以顺便看该节点在链表中有没有, 如果没有顺便创建出来</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>scanAndLockForPut</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 执行到这里 segment 已经被成功加锁, 可以安全执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>V</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>hash</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entryAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 更新</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>K</span><span class=w> </span><span class=n>k</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>k</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>onlyIfAbsent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>++</span><span class=n>modCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 新增</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 1) 之前等待锁时, node 已经被创建, next 指向链表头</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>node</span><span class=p>.</span><span class=na>setNext</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 2) 创建新 node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 3) 扩容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>threshold</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>MAXIMUM_CAPACITY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>rehash</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 将 node 作为链表头</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setEntryAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>index</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>++</span><span class=n>modCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=rehash-流程><a href=#rehash-%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
rehash 流程</h5><p>发生在 put 中，因为此时已经获得了锁，因此 rehash 时不需要考虑线程安全</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-487-1><a class=lnlinks href=#hl-487-1> 1</a>
</span><span class=lnt id=hl-487-2><a class=lnlinks href=#hl-487-2> 2</a>
</span><span class=lnt id=hl-487-3><a class=lnlinks href=#hl-487-3> 3</a>
</span><span class=lnt id=hl-487-4><a class=lnlinks href=#hl-487-4> 4</a>
</span><span class=lnt id=hl-487-5><a class=lnlinks href=#hl-487-5> 5</a>
</span><span class=lnt id=hl-487-6><a class=lnlinks href=#hl-487-6> 6</a>
</span><span class=lnt id=hl-487-7><a class=lnlinks href=#hl-487-7> 7</a>
</span><span class=lnt id=hl-487-8><a class=lnlinks href=#hl-487-8> 8</a>
</span><span class=lnt id=hl-487-9><a class=lnlinks href=#hl-487-9> 9</a>
</span><span class=lnt id=hl-487-10><a class=lnlinks href=#hl-487-10>10</a>
</span><span class=lnt id=hl-487-11><a class=lnlinks href=#hl-487-11>11</a>
</span><span class=lnt id=hl-487-12><a class=lnlinks href=#hl-487-12>12</a>
</span><span class=lnt id=hl-487-13><a class=lnlinks href=#hl-487-13>13</a>
</span><span class=lnt id=hl-487-14><a class=lnlinks href=#hl-487-14>14</a>
</span><span class=lnt id=hl-487-15><a class=lnlinks href=#hl-487-15>15</a>
</span><span class=lnt id=hl-487-16><a class=lnlinks href=#hl-487-16>16</a>
</span><span class=lnt id=hl-487-17><a class=lnlinks href=#hl-487-17>17</a>
</span><span class=lnt id=hl-487-18><a class=lnlinks href=#hl-487-18>18</a>
</span><span class=lnt id=hl-487-19><a class=lnlinks href=#hl-487-19>19</a>
</span><span class=lnt id=hl-487-20><a class=lnlinks href=#hl-487-20>20</a>
</span><span class=lnt id=hl-487-21><a class=lnlinks href=#hl-487-21>21</a>
</span><span class=lnt id=hl-487-22><a class=lnlinks href=#hl-487-22>22</a>
</span><span class=lnt id=hl-487-23><a class=lnlinks href=#hl-487-23>23</a>
</span><span class=lnt id=hl-487-24><a class=lnlinks href=#hl-487-24>24</a>
</span><span class=lnt id=hl-487-25><a class=lnlinks href=#hl-487-25>25</a>
</span><span class=lnt id=hl-487-26><a class=lnlinks href=#hl-487-26>26</a>
</span><span class=lnt id=hl-487-27><a class=lnlinks href=#hl-487-27>27</a>
</span><span class=lnt id=hl-487-28><a class=lnlinks href=#hl-487-28>28</a>
</span><span class=lnt id=hl-487-29><a class=lnlinks href=#hl-487-29>29</a>
</span><span class=lnt id=hl-487-30><a class=lnlinks href=#hl-487-30>30</a>
</span><span class=lnt id=hl-487-31><a class=lnlinks href=#hl-487-31>31</a>
</span><span class=lnt id=hl-487-32><a class=lnlinks href=#hl-487-32>32</a>
</span><span class=lnt id=hl-487-33><a class=lnlinks href=#hl-487-33>33</a>
</span><span class=lnt id=hl-487-34><a class=lnlinks href=#hl-487-34>34</a>
</span><span class=lnt id=hl-487-35><a class=lnlinks href=#hl-487-35>35</a>
</span><span class=lnt id=hl-487-36><a class=lnlinks href=#hl-487-36>36</a>
</span><span class=lnt id=hl-487-37><a class=lnlinks href=#hl-487-37>37</a>
</span><span class=lnt id=hl-487-38><a class=lnlinks href=#hl-487-38>38</a>
</span><span class=lnt id=hl-487-39><a class=lnlinks href=#hl-487-39>39</a>
</span><span class=lnt id=hl-487-40><a class=lnlinks href=#hl-487-40>40</a>
</span><span class=lnt id=hl-487-41><a class=lnlinks href=#hl-487-41>41</a>
</span><span class=lnt id=hl-487-42><a class=lnlinks href=#hl-487-42>42</a>
</span><span class=lnt id=hl-487-43><a class=lnlinks href=#hl-487-43>43</a>
</span><span class=lnt id=hl-487-44><a class=lnlinks href=#hl-487-44>44</a>
</span><span class=lnt id=hl-487-45><a class=lnlinks href=#hl-487-45>45</a>
</span><span class=lnt id=hl-487-46><a class=lnlinks href=#hl-487-46>46</a>
</span><span class=lnt id=hl-487-47><a class=lnlinks href=#hl-487-47>47</a>
</span><span class=lnt id=hl-487-48><a class=lnlinks href=#hl-487-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>rehash</span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>oldTable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>oldCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldTable</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>newCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldCapacity</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>threshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>newCapacity</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>loadFactor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>newTable</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=p>)</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashEntry</span><span class=o>[</span><span class=n>newCapacity</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>sizeMask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newCapacity</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>oldCapacity</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldTable</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sizeMask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=c1>// Single node on list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>newTable</span><span class=o>[</span><span class=n>idx</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// Reuse consecutive sequence at same slot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>lastRun</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>lastIdx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>idx</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 过一遍链表, 尽可能把 rehash 后 idx 不变的节点重用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=n>last</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sizeMask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>lastIdx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lastIdx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>k</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lastRun</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>newTable</span><span class=o>[</span><span class=n>lastIdx</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastRun</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 剩余节点需要新建</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>lastRun</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>V</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>hash</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sizeMask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=o>[</span><span class=n>k</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>newTable</span><span class=o>[</span><span class=n>k</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>key</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 扩容完成, 才加入新的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>nodeIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sizeMask</span><span class=p>;</span><span class=w> </span><span class=c1>// add the new node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>node</span><span class=p>.</span><span class=na>setNext</span><span class=p>(</span><span class=n>newTable</span><span class=o>[</span><span class=n>nodeIndex</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>newTable</span><span class=o>[</span><span class=n>nodeIndex</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 替换为新的 HashEntry table</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>附，调试代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-488-1><a class=lnlinks href=#hl-488-1> 1</a>
</span><span class=lnt id=hl-488-2><a class=lnlinks href=#hl-488-2> 2</a>
</span><span class=lnt id=hl-488-3><a class=lnlinks href=#hl-488-3> 3</a>
</span><span class=lnt id=hl-488-4><a class=lnlinks href=#hl-488-4> 4</a>
</span><span class=lnt id=hl-488-5><a class=lnlinks href=#hl-488-5> 5</a>
</span><span class=lnt id=hl-488-6><a class=lnlinks href=#hl-488-6> 6</a>
</span><span class=lnt id=hl-488-7><a class=lnlinks href=#hl-488-7> 7</a>
</span><span class=lnt id=hl-488-8><a class=lnlinks href=#hl-488-8> 8</a>
</span><span class=lnt id=hl-488-9><a class=lnlinks href=#hl-488-9> 9</a>
</span><span class=lnt id=hl-488-10><a class=lnlinks href=#hl-488-10>10</a>
</span><span class=lnt id=hl-488-11><a class=lnlinks href=#hl-488-11>11</a>
</span><span class=lnt id=hl-488-12><a class=lnlinks href=#hl-488-12>12</a>
</span><span class=lnt id=hl-488-13><a class=lnlinks href=#hl-488-13>13</a>
</span><span class=lnt id=hl-488-14><a class=lnlinks href=#hl-488-14>14</a>
</span><span class=lnt id=hl-488-15><a class=lnlinks href=#hl-488-15>15</a>
</span><span class=lnt id=hl-488-16><a class=lnlinks href=#hl-488-16>16</a>
</span><span class=lnt id=hl-488-17><a class=lnlinks href=#hl-488-17>17</a>
</span><span class=lnt id=hl-488-18><a class=lnlinks href=#hl-488-18>18</a>
</span><span class=lnt id=hl-488-19><a class=lnlinks href=#hl-488-19>19</a>
</span><span class=lnt id=hl-488-20><a class=lnlinks href=#hl-488-20>20</a>
</span><span class=lnt id=hl-488-21><a class=lnlinks href=#hl-488-21>21</a>
</span><span class=lnt id=hl-488-22><a class=lnlinks href=#hl-488-22>22</a>
</span><span class=lnt id=hl-488-23><a class=lnlinks href=#hl-488-23>23</a>
</span><span class=lnt id=hl-488-24><a class=lnlinks href=#hl-488-24>24</a>
</span><span class=lnt id=hl-488-25><a class=lnlinks href=#hl-488-25>25</a>
</span><span class=lnt id=hl-488-26><a class=lnlinks href=#hl-488-26>26</a>
</span><span class=lnt id=hl-488-27><a class=lnlinks href=#hl-488-27>27</a>
</span><span class=lnt id=hl-488-28><a class=lnlinks href=#hl-488-28>28</a>
</span><span class=lnt id=hl-488-29><a class=lnlinks href=#hl-488-29>29</a>
</span><span class=lnt id=hl-488-30><a class=lnlinks href=#hl-488-30>30</a>
</span><span class=lnt id=hl-488-31><a class=lnlinks href=#hl-488-31>31</a>
</span><span class=lnt id=hl-488-32><a class=lnlinks href=#hl-488-32>32</a>
</span><span class=lnt id=hl-488-33><a class=lnlinks href=#hl-488-33>33</a>
</span><span class=lnt id=hl-488-34><a class=lnlinks href=#hl-488-34>34</a>
</span><span class=lnt id=hl-488-35><a class=lnlinks href=#hl-488-35>35</a>
</span><span class=lnt id=hl-488-36><a class=lnlinks href=#hl-488-36>36</a>
</span><span class=lnt id=hl-488-37><a class=lnlinks href=#hl-488-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>segmentIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>hash</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>28</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>15</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>segmentIndex</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>4</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>8</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>segmentIndex</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>2</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>4</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                               </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>8</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>15</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 2 扩容为 4 15 的 hash%8 与其他不同</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>169</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>197</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 4 扩容为 8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>341</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>484</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>545</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 8 扩容为 16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>912</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>941</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ok&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hash</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>k</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>0</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>h</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>String</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sun</span><span class=p>.</span><span class=na>misc</span><span class=p>.</span><span class=na>Hashing</span><span class=p>.</span><span class=na>stringHash32</span><span class=p>((</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>k</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=n>k</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Spread bits to regularize both segment and index locations,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// using variant of single-word Wang/Jenkins hash.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>15</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>0xffffcd7d</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>6</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>14</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>16</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=get-流程><a href=#get-%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
get 流程</h5><p>get 时并未加锁，用了 UNSAFE 方法保证了可见性，扩容过程中，get 先发生就从旧表取内容，get 后发生就从新 表取内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-489-1><a class=lnlinks href=#hl-489-1> 1</a>
</span><span class=lnt id=hl-489-2><a class=lnlinks href=#hl-489-2> 2</a>
</span><span class=lnt id=hl-489-3><a class=lnlinks href=#hl-489-3> 3</a>
</span><span class=lnt id=hl-489-4><a class=lnlinks href=#hl-489-4> 4</a>
</span><span class=lnt id=hl-489-5><a class=lnlinks href=#hl-489-5> 5</a>
</span><span class=lnt id=hl-489-6><a class=lnlinks href=#hl-489-6> 6</a>
</span><span class=lnt id=hl-489-7><a class=lnlinks href=#hl-489-7> 7</a>
</span><span class=lnt id=hl-489-8><a class=lnlinks href=#hl-489-8> 8</a>
</span><span class=lnt id=hl-489-9><a class=lnlinks href=#hl-489-9> 9</a>
</span><span class=lnt id=hl-489-10><a class=lnlinks href=#hl-489-10>10</a>
</span><span class=lnt id=hl-489-11><a class=lnlinks href=#hl-489-11>11</a>
</span><span class=lnt id=hl-489-12><a class=lnlinks href=#hl-489-12>12</a>
</span><span class=lnt id=hl-489-13><a class=lnlinks href=#hl-489-13>13</a>
</span><span class=lnt id=hl-489-14><a class=lnlinks href=#hl-489-14>14</a>
</span><span class=lnt id=hl-489-15><a class=lnlinks href=#hl-489-15>15</a>
</span><span class=lnt id=hl-489-16><a class=lnlinks href=#hl-489-16>16</a>
</span><span class=lnt id=hl-489-17><a class=lnlinks href=#hl-489-17>17</a>
</span><span class=lnt id=hl-489-18><a class=lnlinks href=#hl-489-18>18</a>
</span><span class=lnt id=hl-489-19><a class=lnlinks href=#hl-489-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w> </span><span class=c1>// manually integrate access methods to reduce overhead</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// u 为 segment 对象在数组中的偏移量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>u</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(((</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>segmentShift</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>segmentMask</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>SSHIFT</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>SBASE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// s 即为 segment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>getObjectVolatile</span><span class=p>(</span><span class=n>segments</span><span class=p>,</span><span class=w> </span><span class=n>u</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>table</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>getObjectVolatile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=kt>long</span><span class=p>)(((</span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>h</span><span class=p>))</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>TSHIFT</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>TBASE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>K</span><span class=w> </span><span class=n>k</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>k</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=size-计算流程-1><a href=#size-%e8%ae%a1%e7%ae%97%e6%b5%81%e7%a8%8b-1 class=header-anchor>#</a>
size 计算流程</h5><ul><li>计算元素个数前，先不加锁计算两次，如果前后两次结果如一样，认为个数正确返回</li><li>如果不一样，进行重试，重试次数超过 3，将所有 segment 锁住，重新计算个数返回</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-490-1><a class=lnlinks href=#hl-490-1> 1</a>
</span><span class=lnt id=hl-490-2><a class=lnlinks href=#hl-490-2> 2</a>
</span><span class=lnt id=hl-490-3><a class=lnlinks href=#hl-490-3> 3</a>
</span><span class=lnt id=hl-490-4><a class=lnlinks href=#hl-490-4> 4</a>
</span><span class=lnt id=hl-490-5><a class=lnlinks href=#hl-490-5> 5</a>
</span><span class=lnt id=hl-490-6><a class=lnlinks href=#hl-490-6> 6</a>
</span><span class=lnt id=hl-490-7><a class=lnlinks href=#hl-490-7> 7</a>
</span><span class=lnt id=hl-490-8><a class=lnlinks href=#hl-490-8> 8</a>
</span><span class=lnt id=hl-490-9><a class=lnlinks href=#hl-490-9> 9</a>
</span><span class=lnt id=hl-490-10><a class=lnlinks href=#hl-490-10>10</a>
</span><span class=lnt id=hl-490-11><a class=lnlinks href=#hl-490-11>11</a>
</span><span class=lnt id=hl-490-12><a class=lnlinks href=#hl-490-12>12</a>
</span><span class=lnt id=hl-490-13><a class=lnlinks href=#hl-490-13>13</a>
</span><span class=lnt id=hl-490-14><a class=lnlinks href=#hl-490-14>14</a>
</span><span class=lnt id=hl-490-15><a class=lnlinks href=#hl-490-15>15</a>
</span><span class=lnt id=hl-490-16><a class=lnlinks href=#hl-490-16>16</a>
</span><span class=lnt id=hl-490-17><a class=lnlinks href=#hl-490-17>17</a>
</span><span class=lnt id=hl-490-18><a class=lnlinks href=#hl-490-18>18</a>
</span><span class=lnt id=hl-490-19><a class=lnlinks href=#hl-490-19>19</a>
</span><span class=lnt id=hl-490-20><a class=lnlinks href=#hl-490-20>20</a>
</span><span class=lnt id=hl-490-21><a class=lnlinks href=#hl-490-21>21</a>
</span><span class=lnt id=hl-490-22><a class=lnlinks href=#hl-490-22>22</a>
</span><span class=lnt id=hl-490-23><a class=lnlinks href=#hl-490-23>23</a>
</span><span class=lnt id=hl-490-24><a class=lnlinks href=#hl-490-24>24</a>
</span><span class=lnt id=hl-490-25><a class=lnlinks href=#hl-490-25>25</a>
</span><span class=lnt id=hl-490-26><a class=lnlinks href=#hl-490-26>26</a>
</span><span class=lnt id=hl-490-27><a class=lnlinks href=#hl-490-27>27</a>
</span><span class=lnt id=hl-490-28><a class=lnlinks href=#hl-490-28>28</a>
</span><span class=lnt id=hl-490-29><a class=lnlinks href=#hl-490-29>29</a>
</span><span class=lnt id=hl-490-30><a class=lnlinks href=#hl-490-30>30</a>
</span><span class=lnt id=hl-490-31><a class=lnlinks href=#hl-490-31>31</a>
</span><span class=lnt id=hl-490-32><a class=lnlinks href=#hl-490-32>32</a>
</span><span class=lnt id=hl-490-33><a class=lnlinks href=#hl-490-33>33</a>
</span><span class=lnt id=hl-490-34><a class=lnlinks href=#hl-490-34>34</a>
</span><span class=lnt id=hl-490-35><a class=lnlinks href=#hl-490-35>35</a>
</span><span class=lnt id=hl-490-36><a class=lnlinks href=#hl-490-36>36</a>
</span><span class=lnt id=hl-490-37><a class=lnlinks href=#hl-490-37>37</a>
</span><span class=lnt id=hl-490-38><a class=lnlinks href=#hl-490-38>38</a>
</span><span class=lnt id=hl-490-39><a class=lnlinks href=#hl-490-39>39</a>
</span><span class=lnt id=hl-490-40><a class=lnlinks href=#hl-490-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>size</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Try a few times to get accurate count. On failure due to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// continuous async changes in table, resort to locking.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>segments</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>segments</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>overflow</span><span class=p>;</span><span class=w> </span><span class=c1>// true if size overflows 32 bits</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>sum</span><span class=p>;</span><span class=w> </span><span class=c1>// sum of modCounts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0L</span><span class=p>;</span><span class=w> </span><span class=c1>// previous sum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>retries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=c1>// first iteration isn&#39;t retry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>retries</span><span class=o>++</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>RETRIES_BEFORE_LOCK</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 超过重试次数, 需要创建所有 segment 并加锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>segments</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>j</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ensureSegment</span><span class=p>(</span><span class=n>j</span><span class=p>).</span><span class=na>lock</span><span class=p>();</span><span class=w> </span><span class=c1>// force creation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>overflow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>segments</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>j</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>seg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>segmentAt</span><span class=p>(</span><span class=n>segments</span><span class=p>,</span><span class=w> </span><span class=n>j</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>seg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>seg</span><span class=p>.</span><span class=na>modCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seg</span><span class=p>.</span><span class=na>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>overflow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sum</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>last</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>retries</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>RETRIES_BEFORE_LOCK</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>segments</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>j</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>segmentAt</span><span class=p>(</span><span class=n>segments</span><span class=p>,</span><span class=w> </span><span class=n>j</span><span class=p>).</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>overflow</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=blockingqueue><a href=#blockingqueue class=header-anchor>#</a>
BlockingQueue</h2><h3 id=font-colorblue-blockingqueue-原理font><a href=#font-colorblue-blockingqueue-%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>* BlockingQueue 原理</font></h3><h4 id=基本的入队出队><a href=#%e5%9f%ba%e6%9c%ac%e7%9a%84%e5%85%a5%e9%98%9f%e5%87%ba%e9%98%9f class=header-anchor>#</a>
基本的入队出队</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-491-1><a class=lnlinks href=#hl-491-1> 1</a>
</span><span class=lnt id=hl-491-2><a class=lnlinks href=#hl-491-2> 2</a>
</span><span class=lnt id=hl-491-3><a class=lnlinks href=#hl-491-3> 3</a>
</span><span class=lnt id=hl-491-4><a class=lnlinks href=#hl-491-4> 4</a>
</span><span class=lnt id=hl-491-5><a class=lnlinks href=#hl-491-5> 5</a>
</span><span class=lnt id=hl-491-6><a class=lnlinks href=#hl-491-6> 6</a>
</span><span class=lnt id=hl-491-7><a class=lnlinks href=#hl-491-7> 7</a>
</span><span class=lnt id=hl-491-8><a class=lnlinks href=#hl-491-8> 8</a>
</span><span class=lnt id=hl-491-9><a class=lnlinks href=#hl-491-9> 9</a>
</span><span class=lnt id=hl-491-10><a class=lnlinks href=#hl-491-10>10</a>
</span><span class=lnt id=hl-491-11><a class=lnlinks href=#hl-491-11>11</a>
</span><span class=lnt id=hl-491-12><a class=lnlinks href=#hl-491-12>12</a>
</span><span class=lnt id=hl-491-13><a class=lnlinks href=#hl-491-13>13</a>
</span><span class=lnt id=hl-491-14><a class=lnlinks href=#hl-491-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractQueue</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>implements</span><span class=w> </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>E</span><span class=w> </span><span class=n>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> 		* 下列三种情况之一
</span></span></span><span class=line><span class=cl><span class=cm> 		* - 真正的后继节点
</span></span></span><span class=line><span class=cl><span class=cm> 		* - 自己, 发生在出队时
</span></span></span><span class=line><span class=cl><span class=cm> 		* - null, 表示是没有后继节点, 是最后了
</span></span></span><span class=line><span class=cl><span class=cm> 		*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=初始化链表><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e9%93%be%e8%a1%a8 class=header-anchor>#</a>
初始化链表</h5><p><code>last = head = new Node(null);</code>Dummy 节点用来占位，item 为 null</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220316215902936.png width=900 height=600 loading=lazy decoding=async alt=image-20220316215902936 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=当一个节点入队><a href=#%e5%bd%93%e4%b8%80%e4%b8%aa%e8%8a%82%e7%82%b9%e5%85%a5%e9%98%9f class=header-anchor>#</a>
当一个节点入队</h5><p><code>last = last.next = node;</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220316215925456.png width=900 height=600 loading=lazy decoding=async alt=image-20220316215925456 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>再来一个节点入队<code>last = last.next = node;</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220316215949461.png width=900 height=600 loading=lazy decoding=async alt=image-20220316215949461 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=出队><a href=#%e5%87%ba%e9%98%9f class=header-anchor>#</a>
出队</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-492-1><a class=lnlinks href=#hl-492-1> 1</a>
</span><span class=lnt id=hl-492-2><a class=lnlinks href=#hl-492-2> 2</a>
</span><span class=lnt id=hl-492-3><a class=lnlinks href=#hl-492-3> 3</a>
</span><span class=lnt id=hl-492-4><a class=lnlinks href=#hl-492-4> 4</a>
</span><span class=lnt id=hl-492-5><a class=lnlinks href=#hl-492-5> 5</a>
</span><span class=lnt id=hl-492-6><a class=lnlinks href=#hl-492-6> 6</a>
</span><span class=lnt id=hl-492-7><a class=lnlinks href=#hl-492-7> 7</a>
</span><span class=lnt id=hl-492-8><a class=lnlinks href=#hl-492-8> 8</a>
</span><span class=lnt id=hl-492-9><a class=lnlinks href=#hl-492-9> 9</a>
</span><span class=lnt id=hl-492-10><a class=lnlinks href=#hl-492-10>10</a>
</span><span class=lnt id=hl-492-11><a class=lnlinks href=#hl-492-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//临时变量h用来指向哨兵</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//first用来指向第一个元素</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>h</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w> </span><span class=c1>// help GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//head赋值为first，表示first节点就是下一个哨兵。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>E</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//删除first节点中的数据，表示真正成为了哨兵，第一个元素出队。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>first</span><span class=p>.</span><span class=na>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>h = head</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317142826808.png width=900 height=600 loading=lazy decoding=async alt=image-20220317142826808 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><code>first = h.next</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317142906729.png width=900 height=600 loading=lazy decoding=async alt=image-20220317142906729 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><code>h.next = h</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317142924725.png width=900 height=600 loading=lazy decoding=async alt=image-20220317142924725 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><code>head = first</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317142942832.png width=900 height=600 loading=lazy decoding=async alt=image-20220317142942832 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-493-1><a class=lnlinks href=#hl-493-1>1</a>
</span><span class=lnt id=hl-493-2><a class=lnlinks href=#hl-493-2>2</a>
</span><span class=lnt id=hl-493-3><a class=lnlinks href=#hl-493-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>E</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>first</span><span class=p>.</span><span class=na>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317143001497.png width=900 height=600 loading=lazy decoding=async alt=image-20220317143001497 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=加锁分析><a href=#%e5%8a%a0%e9%94%81%e5%88%86%e6%9e%90 class=header-anchor>#</a>
加锁分析</h4><p><strong>高明之处</strong>在于用了两把锁和 dummy 节点</p><ul><li>用一把锁，同一时刻，最多只允许有一个线程（生产者或消费者，二选一）执行</li><li>用两把锁，同一时刻，可以允许两个线程同时（一个生产者与一个消费者）执行<ul><li>消费者与消费者线程仍然串行</li><li>生产者与生产者线程仍然串行</li></ul></li></ul><p>线程安全分析</p><ul><li>当节点总数大于 2 时（包括 dummy 节点），putLock 保证的是 last 节点的线程安全，takeLock 保证的是 head 节点的线程安全。两把锁保证了入队和出队没有竞争</li><li>当节点总数等于 2 时（即一个 dummy 节点，一个正常节点）这时候，仍然是两把锁锁两个对象，不会竞争</li><li>当节点总数等于 1 时（就一个 dummy 节点）这时 take 线程会被 notEmpty 条件阻塞，有竞争，会阻塞</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-494-1><a class=lnlinks href=#hl-494-1>1</a>
</span><span class=lnt id=hl-494-2><a class=lnlinks href=#hl-494-2>2</a>
</span><span class=lnt id=hl-494-3><a class=lnlinks href=#hl-494-3>3</a>
</span><span class=lnt id=hl-494-4><a class=lnlinks href=#hl-494-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 用于 put(阻塞) offer(非阻塞)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>putLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 用户 take(阻塞) poll(非阻塞)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>takeLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>put 操作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-495-1><a class=lnlinks href=#hl-495-1> 1</a>
</span><span class=lnt id=hl-495-2><a class=lnlinks href=#hl-495-2> 2</a>
</span><span class=lnt id=hl-495-3><a class=lnlinks href=#hl-495-3> 3</a>
</span><span class=lnt id=hl-495-4><a class=lnlinks href=#hl-495-4> 4</a>
</span><span class=lnt id=hl-495-5><a class=lnlinks href=#hl-495-5> 5</a>
</span><span class=lnt id=hl-495-6><a class=lnlinks href=#hl-495-6> 6</a>
</span><span class=lnt id=hl-495-7><a class=lnlinks href=#hl-495-7> 7</a>
</span><span class=lnt id=hl-495-8><a class=lnlinks href=#hl-495-8> 8</a>
</span><span class=lnt id=hl-495-9><a class=lnlinks href=#hl-495-9> 9</a>
</span><span class=lnt id=hl-495-10><a class=lnlinks href=#hl-495-10>10</a>
</span><span class=lnt id=hl-495-11><a class=lnlinks href=#hl-495-11>11</a>
</span><span class=lnt id=hl-495-12><a class=lnlinks href=#hl-495-12>12</a>
</span><span class=lnt id=hl-495-13><a class=lnlinks href=#hl-495-13>13</a>
</span><span class=lnt id=hl-495-14><a class=lnlinks href=#hl-495-14>14</a>
</span><span class=lnt id=hl-495-15><a class=lnlinks href=#hl-495-15>15</a>
</span><span class=lnt id=hl-495-16><a class=lnlinks href=#hl-495-16>16</a>
</span><span class=lnt id=hl-495-17><a class=lnlinks href=#hl-495-17>17</a>
</span><span class=lnt id=hl-495-18><a class=lnlinks href=#hl-495-18>18</a>
</span><span class=lnt id=hl-495-19><a class=lnlinks href=#hl-495-19>19</a>
</span><span class=lnt id=hl-495-20><a class=lnlinks href=#hl-495-20>20</a>
</span><span class=lnt id=hl-495-21><a class=lnlinks href=#hl-495-21>21</a>
</span><span class=lnt id=hl-495-22><a class=lnlinks href=#hl-495-22>22</a>
</span><span class=lnt id=hl-495-23><a class=lnlinks href=#hl-495-23>23</a>
</span><span class=lnt id=hl-495-24><a class=lnlinks href=#hl-495-24>24</a>
</span><span class=lnt id=hl-495-25><a class=lnlinks href=#hl-495-25>25</a>
</span><span class=lnt id=hl-495-26><a class=lnlinks href=#hl-495-26>26</a>
</span><span class=lnt id=hl-495-27><a class=lnlinks href=#hl-495-27>27</a>
</span><span class=lnt id=hl-495-28><a class=lnlinks href=#hl-495-28>28</a>
</span><span class=lnt id=hl-495-29><a class=lnlinks href=#hl-495-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//LinkedBlockingQueue不支持空元素</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NullPointerException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>putLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>putLock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// count 用来维护元素计数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>putLock</span><span class=p>.</span><span class=na>lockInterruptibly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 满了等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 倒过来读就好: 等待 notFull</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notFull</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 有空位, 入队且计数加一</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enqueue</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 除了自己 put 以外, 队列还有空位, 由自己叫醒其他 put 线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notFull</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>putLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果队列中有一个元素, 叫醒 take 线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这里调用的是 notEmpty.signal() 而不是 notEmpty.signalAll() 是为了减少竞争</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>signalNotEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>take 操作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-496-1><a class=lnlinks href=#hl-496-1> 1</a>
</span><span class=lnt id=hl-496-2><a class=lnlinks href=#hl-496-2> 2</a>
</span><span class=lnt id=hl-496-3><a class=lnlinks href=#hl-496-3> 3</a>
</span><span class=lnt id=hl-496-4><a class=lnlinks href=#hl-496-4> 4</a>
</span><span class=lnt id=hl-496-5><a class=lnlinks href=#hl-496-5> 5</a>
</span><span class=lnt id=hl-496-6><a class=lnlinks href=#hl-496-6> 6</a>
</span><span class=lnt id=hl-496-7><a class=lnlinks href=#hl-496-7> 7</a>
</span><span class=lnt id=hl-496-8><a class=lnlinks href=#hl-496-8> 8</a>
</span><span class=lnt id=hl-496-9><a class=lnlinks href=#hl-496-9> 9</a>
</span><span class=lnt id=hl-496-10><a class=lnlinks href=#hl-496-10>10</a>
</span><span class=lnt id=hl-496-11><a class=lnlinks href=#hl-496-11>11</a>
</span><span class=lnt id=hl-496-12><a class=lnlinks href=#hl-496-12>12</a>
</span><span class=lnt id=hl-496-13><a class=lnlinks href=#hl-496-13>13</a>
</span><span class=lnt id=hl-496-14><a class=lnlinks href=#hl-496-14>14</a>
</span><span class=lnt id=hl-496-15><a class=lnlinks href=#hl-496-15>15</a>
</span><span class=lnt id=hl-496-16><a class=lnlinks href=#hl-496-16>16</a>
</span><span class=lnt id=hl-496-17><a class=lnlinks href=#hl-496-17>17</a>
</span><span class=lnt id=hl-496-18><a class=lnlinks href=#hl-496-18>18</a>
</span><span class=lnt id=hl-496-19><a class=lnlinks href=#hl-496-19>19</a>
</span><span class=lnt id=hl-496-20><a class=lnlinks href=#hl-496-20>20</a>
</span><span class=lnt id=hl-496-21><a class=lnlinks href=#hl-496-21>21</a>
</span><span class=lnt id=hl-496-22><a class=lnlinks href=#hl-496-22>22</a>
</span><span class=lnt id=hl-496-23><a class=lnlinks href=#hl-496-23>23</a>
</span><span class=lnt id=hl-496-24><a class=lnlinks href=#hl-496-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>take</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>E</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>takeLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>takeLock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>takeLock</span><span class=p>.</span><span class=na>lockInterruptibly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notEmpty</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dequeue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=p>.</span><span class=na>getAndDecrement</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notEmpty</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>takeLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果队列中只有一个空位时, 叫醒 put 线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果有多个线程进行出队, 第一个线程满足 c == capacity, 但后续线程 c &lt; capacity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这里调用的是 notFull.signal() 而不是 notFull.signalAll() 是为了减少竞争</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>signalNotFull</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>由 put 唤醒 put 是为了避免信号不足</p></blockquote><h4 id=性能比较><a href=#%e6%80%a7%e8%83%bd%e6%af%94%e8%be%83 class=header-anchor>#</a>
性能比较</h4><p>主要列举 LinkedBlockingQueue 与 ArrayBlockingQueue 的性能比较</p><ul><li>Linked 支持有界，Array 强制有界</li><li>Linked 实现是链表，Array 实现是数组</li><li>Linked 是懒惰的，而 Array 需要提前初始化 Node 数组</li><li>Linked 每次入队会生成新 Node，而 Array 的 Node 是提前创建好的</li><li>Linked 两把锁，Array 一把锁</li></ul><h2 id=concurrentlinkedqueue><a href=#concurrentlinkedqueue class=header-anchor>#</a>
ConcurrentLinkedQueue</h2><p>ConcurrentLinkedQueue 的设计与 LinkedBlockingQueue 非常像，也是</p><ul><li>两把【锁】，同一时刻，可以允许两个线程同时（一个生产者与一个消费者）执行</li><li>dummy 节点的引入让两把【锁】将来锁住的是不同对象，避免竞争</li><li>只是这【锁】使用了 cas 来实现</li></ul><p>事实上，ConcurrentLinkedQueue 应用还是非常广泛的</p><p>例如之前讲的 Tomcat 的 Connector 结构时，Acceptor 作为生产者向 Poller 消费者传递事件信息时，正是采用了 ConcurrentLinkedQueue 将 SocketChannel 给 Poller 使用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-497-1><a class=lnlinks href=#hl-497-1> 1</a>
</span><span class=lnt id=hl-497-2><a class=lnlinks href=#hl-497-2> 2</a>
</span><span class=lnt id=hl-497-3><a class=lnlinks href=#hl-497-3> 3</a>
</span><span class=lnt id=hl-497-4><a class=lnlinks href=#hl-497-4> 4</a>
</span><span class=lnt id=hl-497-5><a class=lnlinks href=#hl-497-5> 5</a>
</span><span class=lnt id=hl-497-6><a class=lnlinks href=#hl-497-6> 6</a>
</span><span class=lnt id=hl-497-7><a class=lnlinks href=#hl-497-7> 7</a>
</span><span class=lnt id=hl-497-8><a class=lnlinks href=#hl-497-8> 8</a>
</span><span class=lnt id=hl-497-9><a class=lnlinks href=#hl-497-9> 9</a>
</span><span class=lnt id=hl-497-10><a class=lnlinks href=#hl-497-10>10</a>
</span><span class=lnt id=hl-497-11><a class=lnlinks href=#hl-497-11>11</a>
</span><span class=lnt id=hl-497-12><a class=lnlinks href=#hl-497-12>12</a>
</span><span class=lnt id=hl-497-13><a class=lnlinks href=#hl-497-13>13</a>
</span><span class=lnt id=hl-497-14><a class=lnlinks href=#hl-497-14>14</a>
</span><span class=lnt id=hl-497-15><a class=lnlinks href=#hl-497-15>15</a>
</span><span class=lnt id=hl-497-16><a class=lnlinks href=#hl-497-16>16</a>
</span><span class=lnt id=hl-497-17><a class=lnlinks href=#hl-497-17>17</a>
</span><span class=lnt id=hl-497-18><a class=lnlinks href=#hl-497-18>18</a>
</span><span class=lnt id=hl-497-19><a class=lnlinks href=#hl-497-19>19</a>
</span><span class=lnt id=hl-497-20><a class=lnlinks href=#hl-497-20>20</a>
</span><span class=lnt id=hl-497-21><a class=lnlinks href=#hl-497-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>graph LR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>subgraph Connector-&gt;NIO EndPoint
</span></span><span class=line><span class=cl>t1(LimitLatch)
</span></span><span class=line><span class=cl>t2(Acceptor)
</span></span><span class=line><span class=cl>t3(SocketChannel 1)
</span></span><span class=line><span class=cl>t4(SocketChannel 2)
</span></span><span class=line><span class=cl>t5(Poller)
</span></span><span class=line><span class=cl>subgraph Executor
</span></span><span class=line><span class=cl>t7(worker1)
</span></span><span class=line><span class=cl>t8(worker2)
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>t1 --&gt; t2
</span></span><span class=line><span class=cl>t2 --&gt; t3
</span></span><span class=line><span class=cl>t2 --&gt; t4
</span></span><span class=line><span class=cl>t3 --有读--&gt; t5
</span></span><span class=line><span class=cl>t4 --有读--&gt; t5
</span></span><span class=line><span class=cl>t5 --socketProcessor--&gt; t7
</span></span><span class=line><span class=cl>t5 --socketProcessor--&gt; t8
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><h3 id=font-colorblueconcurrentlinkedqueue-原理font><a href=#font-colorblueconcurrentlinkedqueue-%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>*ConcurrentLinkedQueue 原理</font></h3><h4 id=模仿-concurrentlinkedqueue><a href=#%e6%a8%a1%e4%bb%bf-concurrentlinkedqueue class=header-anchor>#</a>
模仿 ConcurrentLinkedQueue</h4><p>初始代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-498-1><a class=lnlinks href=#hl-498-1>  1</a>
</span><span class=lnt id=hl-498-2><a class=lnlinks href=#hl-498-2>  2</a>
</span><span class=lnt id=hl-498-3><a class=lnlinks href=#hl-498-3>  3</a>
</span><span class=lnt id=hl-498-4><a class=lnlinks href=#hl-498-4>  4</a>
</span><span class=lnt id=hl-498-5><a class=lnlinks href=#hl-498-5>  5</a>
</span><span class=lnt id=hl-498-6><a class=lnlinks href=#hl-498-6>  6</a>
</span><span class=lnt id=hl-498-7><a class=lnlinks href=#hl-498-7>  7</a>
</span><span class=lnt id=hl-498-8><a class=lnlinks href=#hl-498-8>  8</a>
</span><span class=lnt id=hl-498-9><a class=lnlinks href=#hl-498-9>  9</a>
</span><span class=lnt id=hl-498-10><a class=lnlinks href=#hl-498-10> 10</a>
</span><span class=lnt id=hl-498-11><a class=lnlinks href=#hl-498-11> 11</a>
</span><span class=lnt id=hl-498-12><a class=lnlinks href=#hl-498-12> 12</a>
</span><span class=lnt id=hl-498-13><a class=lnlinks href=#hl-498-13> 13</a>
</span><span class=lnt id=hl-498-14><a class=lnlinks href=#hl-498-14> 14</a>
</span><span class=lnt id=hl-498-15><a class=lnlinks href=#hl-498-15> 15</a>
</span><span class=lnt id=hl-498-16><a class=lnlinks href=#hl-498-16> 16</a>
</span><span class=lnt id=hl-498-17><a class=lnlinks href=#hl-498-17> 17</a>
</span><span class=lnt id=hl-498-18><a class=lnlinks href=#hl-498-18> 18</a>
</span><span class=lnt id=hl-498-19><a class=lnlinks href=#hl-498-19> 19</a>
</span><span class=lnt id=hl-498-20><a class=lnlinks href=#hl-498-20> 20</a>
</span><span class=lnt id=hl-498-21><a class=lnlinks href=#hl-498-21> 21</a>
</span><span class=lnt id=hl-498-22><a class=lnlinks href=#hl-498-22> 22</a>
</span><span class=lnt id=hl-498-23><a class=lnlinks href=#hl-498-23> 23</a>
</span><span class=lnt id=hl-498-24><a class=lnlinks href=#hl-498-24> 24</a>
</span><span class=lnt id=hl-498-25><a class=lnlinks href=#hl-498-25> 25</a>
</span><span class=lnt id=hl-498-26><a class=lnlinks href=#hl-498-26> 26</a>
</span><span class=lnt id=hl-498-27><a class=lnlinks href=#hl-498-27> 27</a>
</span><span class=lnt id=hl-498-28><a class=lnlinks href=#hl-498-28> 28</a>
</span><span class=lnt id=hl-498-29><a class=lnlinks href=#hl-498-29> 29</a>
</span><span class=lnt id=hl-498-30><a class=lnlinks href=#hl-498-30> 30</a>
</span><span class=lnt id=hl-498-31><a class=lnlinks href=#hl-498-31> 31</a>
</span><span class=lnt id=hl-498-32><a class=lnlinks href=#hl-498-32> 32</a>
</span><span class=lnt id=hl-498-33><a class=lnlinks href=#hl-498-33> 33</a>
</span><span class=lnt id=hl-498-34><a class=lnlinks href=#hl-498-34> 34</a>
</span><span class=lnt id=hl-498-35><a class=lnlinks href=#hl-498-35> 35</a>
</span><span class=lnt id=hl-498-36><a class=lnlinks href=#hl-498-36> 36</a>
</span><span class=lnt id=hl-498-37><a class=lnlinks href=#hl-498-37> 37</a>
</span><span class=lnt id=hl-498-38><a class=lnlinks href=#hl-498-38> 38</a>
</span><span class=lnt id=hl-498-39><a class=lnlinks href=#hl-498-39> 39</a>
</span><span class=lnt id=hl-498-40><a class=lnlinks href=#hl-498-40> 40</a>
</span><span class=lnt id=hl-498-41><a class=lnlinks href=#hl-498-41> 41</a>
</span><span class=lnt id=hl-498-42><a class=lnlinks href=#hl-498-42> 42</a>
</span><span class=lnt id=hl-498-43><a class=lnlinks href=#hl-498-43> 43</a>
</span><span class=lnt id=hl-498-44><a class=lnlinks href=#hl-498-44> 44</a>
</span><span class=lnt id=hl-498-45><a class=lnlinks href=#hl-498-45> 45</a>
</span><span class=lnt id=hl-498-46><a class=lnlinks href=#hl-498-46> 46</a>
</span><span class=lnt id=hl-498-47><a class=lnlinks href=#hl-498-47> 47</a>
</span><span class=lnt id=hl-498-48><a class=lnlinks href=#hl-498-48> 48</a>
</span><span class=lnt id=hl-498-49><a class=lnlinks href=#hl-498-49> 49</a>
</span><span class=lnt id=hl-498-50><a class=lnlinks href=#hl-498-50> 50</a>
</span><span class=lnt id=hl-498-51><a class=lnlinks href=#hl-498-51> 51</a>
</span><span class=lnt id=hl-498-52><a class=lnlinks href=#hl-498-52> 52</a>
</span><span class=lnt id=hl-498-53><a class=lnlinks href=#hl-498-53> 53</a>
</span><span class=lnt id=hl-498-54><a class=lnlinks href=#hl-498-54> 54</a>
</span><span class=lnt id=hl-498-55><a class=lnlinks href=#hl-498-55> 55</a>
</span><span class=lnt id=hl-498-56><a class=lnlinks href=#hl-498-56> 56</a>
</span><span class=lnt id=hl-498-57><a class=lnlinks href=#hl-498-57> 57</a>
</span><span class=lnt id=hl-498-58><a class=lnlinks href=#hl-498-58> 58</a>
</span><span class=lnt id=hl-498-59><a class=lnlinks href=#hl-498-59> 59</a>
</span><span class=lnt id=hl-498-60><a class=lnlinks href=#hl-498-60> 60</a>
</span><span class=lnt id=hl-498-61><a class=lnlinks href=#hl-498-61> 61</a>
</span><span class=lnt id=hl-498-62><a class=lnlinks href=#hl-498-62> 62</a>
</span><span class=lnt id=hl-498-63><a class=lnlinks href=#hl-498-63> 63</a>
</span><span class=lnt id=hl-498-64><a class=lnlinks href=#hl-498-64> 64</a>
</span><span class=lnt id=hl-498-65><a class=lnlinks href=#hl-498-65> 65</a>
</span><span class=lnt id=hl-498-66><a class=lnlinks href=#hl-498-66> 66</a>
</span><span class=lnt id=hl-498-67><a class=lnlinks href=#hl-498-67> 67</a>
</span><span class=lnt id=hl-498-68><a class=lnlinks href=#hl-498-68> 68</a>
</span><span class=lnt id=hl-498-69><a class=lnlinks href=#hl-498-69> 69</a>
</span><span class=lnt id=hl-498-70><a class=lnlinks href=#hl-498-70> 70</a>
</span><span class=lnt id=hl-498-71><a class=lnlinks href=#hl-498-71> 71</a>
</span><span class=lnt id=hl-498-72><a class=lnlinks href=#hl-498-72> 72</a>
</span><span class=lnt id=hl-498-73><a class=lnlinks href=#hl-498-73> 73</a>
</span><span class=lnt id=hl-498-74><a class=lnlinks href=#hl-498-74> 74</a>
</span><span class=lnt id=hl-498-75><a class=lnlinks href=#hl-498-75> 75</a>
</span><span class=lnt id=hl-498-76><a class=lnlinks href=#hl-498-76> 76</a>
</span><span class=lnt id=hl-498-77><a class=lnlinks href=#hl-498-77> 77</a>
</span><span class=lnt id=hl-498-78><a class=lnlinks href=#hl-498-78> 78</a>
</span><span class=lnt id=hl-498-79><a class=lnlinks href=#hl-498-79> 79</a>
</span><span class=lnt id=hl-498-80><a class=lnlinks href=#hl-498-80> 80</a>
</span><span class=lnt id=hl-498-81><a class=lnlinks href=#hl-498-81> 81</a>
</span><span class=lnt id=hl-498-82><a class=lnlinks href=#hl-498-82> 82</a>
</span><span class=lnt id=hl-498-83><a class=lnlinks href=#hl-498-83> 83</a>
</span><span class=lnt id=hl-498-84><a class=lnlinks href=#hl-498-84> 84</a>
</span><span class=lnt id=hl-498-85><a class=lnlinks href=#hl-498-85> 85</a>
</span><span class=lnt id=hl-498-86><a class=lnlinks href=#hl-498-86> 86</a>
</span><span class=lnt id=hl-498-87><a class=lnlinks href=#hl-498-87> 87</a>
</span><span class=lnt id=hl-498-88><a class=lnlinks href=#hl-498-88> 88</a>
</span><span class=lnt id=hl-498-89><a class=lnlinks href=#hl-498-89> 89</a>
</span><span class=lnt id=hl-498-90><a class=lnlinks href=#hl-498-90> 90</a>
</span><span class=lnt id=hl-498-91><a class=lnlinks href=#hl-498-91> 91</a>
</span><span class=lnt id=hl-498-92><a class=lnlinks href=#hl-498-92> 92</a>
</span><span class=lnt id=hl-498-93><a class=lnlinks href=#hl-498-93> 93</a>
</span><span class=lnt id=hl-498-94><a class=lnlinks href=#hl-498-94> 94</a>
</span><span class=lnt id=hl-498-95><a class=lnlinks href=#hl-498-95> 95</a>
</span><span class=lnt id=hl-498-96><a class=lnlinks href=#hl-498-96> 96</a>
</span><span class=lnt id=hl-498-97><a class=lnlinks href=#hl-498-97> 97</a>
</span><span class=lnt id=hl-498-98><a class=lnlinks href=#hl-498-98> 98</a>
</span><span class=lnt id=hl-498-99><a class=lnlinks href=#hl-498-99> 99</a>
</span><span class=lnt id=hl-498-100><a class=lnlinks href=#hl-498-100>100</a>
</span><span class=lnt id=hl-498-101><a class=lnlinks href=#hl-498-101>101</a>
</span><span class=lnt id=hl-498-102><a class=lnlinks href=#hl-498-102>102</a>
</span><span class=lnt id=hl-498-103><a class=lnlinks href=#hl-498-103>103</a>
</span><span class=lnt id=hl-498-104><a class=lnlinks href=#hl-498-104>104</a>
</span><span class=lnt id=hl-498-105><a class=lnlinks href=#hl-498-105>105</a>
</span><span class=lnt id=hl-498-106><a class=lnlinks href=#hl-498-106>106</a>
</span><span class=lnt id=hl-498-107><a class=lnlinks href=#hl-498-107>107</a>
</span><span class=lnt id=hl-498-108><a class=lnlinks href=#hl-498-108>108</a>
</span><span class=lnt id=hl-498-109><a class=lnlinks href=#hl-498-109>109</a>
</span><span class=lnt id=hl-498-110><a class=lnlinks href=#hl-498-110>110</a>
</span><span class=lnt id=hl-498-111><a class=lnlinks href=#hl-498-111>111</a>
</span><span class=lnt id=hl-498-112><a class=lnlinks href=#hl-498-112>112</a>
</span><span class=lnt id=hl-498-113><a class=lnlinks href=#hl-498-113>113</a>
</span><span class=lnt id=hl-498-114><a class=lnlinks href=#hl-498-114>114</a>
</span><span class=lnt id=hl-498-115><a class=lnlinks href=#hl-498-115>115</a>
</span><span class=lnt id=hl-498-116><a class=lnlinks href=#hl-498-116>116</a>
</span><span class=lnt id=hl-498-117><a class=lnlinks href=#hl-498-117>117</a>
</span><span class=lnt id=hl-498-118><a class=lnlinks href=#hl-498-118>118</a>
</span><span class=lnt id=hl-498-119><a class=lnlinks href=#hl-498-119>119</a>
</span><span class=lnt id=hl-498-120><a class=lnlinks href=#hl-498-120>120</a>
</span><span class=lnt id=hl-498-121><a class=lnlinks href=#hl-498-121>121</a>
</span><span class=lnt id=hl-498-122><a class=lnlinks href=#hl-498-122>122</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>cn.itcast.concurrent.thirdpart.test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Collection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Iterator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Queue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.atomic.AtomicReference</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test3</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MyQueue</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MyQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=s>&#34;3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>queue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>MyQueue</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Queue</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StringBuilder</span><span class=w> </span><span class=n>sb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringBuilder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>get</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>E</span><span class=w> </span><span class=n>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>item</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sb</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>item</span><span class=p>).</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;-&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sb</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sb</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>size</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isEmpty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>contains</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=nf>iterator</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=nf>toArray</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=o>[]</span><span class=w> </span><span class=nf>toArray</span><span class=p>(</span><span class=n>T</span><span class=o>[]</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>remove</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>containsAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>addAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>removeAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>retainAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>clear</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>remove</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>element</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MyQueue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>last</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>dequeue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*Node&lt;E&gt; h = head;
</span></span></span><span class=line><span class=cl><span class=cm> 		Node&lt;E&gt; first = h.next;
</span></span></span><span class=line><span class=cl><span class=cm> 		h.next = h;
</span></span></span><span class=line><span class=cl><span class=cm> 		head = first;
</span></span></span><span class=line><span class=cl><span class=cm>        E x = first.item;
</span></span></span><span class=line><span class=cl><span class=cm> 		first.item = null;
</span></span></span><span class=line><span class=cl><span class=cm> 		return x;*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>poll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>offer</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>volatile</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=n>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>Node</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>item</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>offer</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-499-1><a class=lnlinks href=#hl-499-1> 1</a>
</span><span class=lnt id=hl-499-2><a class=lnlinks href=#hl-499-2> 2</a>
</span><span class=lnt id=hl-499-3><a class=lnlinks href=#hl-499-3> 3</a>
</span><span class=lnt id=hl-499-4><a class=lnlinks href=#hl-499-4> 4</a>
</span><span class=lnt id=hl-499-5><a class=lnlinks href=#hl-499-5> 5</a>
</span><span class=lnt id=hl-499-6><a class=lnlinks href=#hl-499-6> 6</a>
</span><span class=lnt id=hl-499-7><a class=lnlinks href=#hl-499-7> 7</a>
</span><span class=lnt id=hl-499-8><a class=lnlinks href=#hl-499-8> 8</a>
</span><span class=lnt id=hl-499-9><a class=lnlinks href=#hl-499-9> 9</a>
</span><span class=lnt id=hl-499-10><a class=lnlinks href=#hl-499-10>10</a>
</span><span class=lnt id=hl-499-11><a class=lnlinks href=#hl-499-11>11</a>
</span><span class=lnt id=hl-499-12><a class=lnlinks href=#hl-499-12>12</a>
</span><span class=lnt id=hl-499-13><a class=lnlinks href=#hl-499-13>13</a>
</span><span class=lnt id=hl-499-14><a class=lnlinks href=#hl-499-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>offer</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取尾节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// S1: 真正尾节点的 next 是 null, cas 从 null 到新节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 这时的 last 已经是倒数第二, next 不为空了, 其它线程的 cas 肯定失败</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// S2: 更新 last 为倒数第一的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=copyonwritearraylist><a href=#copyonwritearraylist class=header-anchor>#</a>
CopyOnWriteArrayList</h2><p><code>CopyOnWriteArraySet</code>是它的马甲 底层实现采用了 写入时拷贝 的思想，增删改操作会将底层数组拷贝一份，更 改操作在新数组上执行，这时不影响其它线程的<strong>并发读</strong>，<strong>读写分离</strong>。 以新增为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-500-1><a class=lnlinks href=#hl-500-1> 1</a>
</span><span class=lnt id=hl-500-2><a class=lnlinks href=#hl-500-2> 2</a>
</span><span class=lnt id=hl-500-3><a class=lnlinks href=#hl-500-3> 3</a>
</span><span class=lnt id=hl-500-4><a class=lnlinks href=#hl-500-4> 4</a>
</span><span class=lnt id=hl-500-5><a class=lnlinks href=#hl-500-5> 5</a>
</span><span class=lnt id=hl-500-6><a class=lnlinks href=#hl-500-6> 6</a>
</span><span class=lnt id=hl-500-7><a class=lnlinks href=#hl-500-7> 7</a>
</span><span class=lnt id=hl-500-8><a class=lnlinks href=#hl-500-8> 8</a>
</span><span class=lnt id=hl-500-9><a class=lnlinks href=#hl-500-9> 9</a>
</span><span class=lnt id=hl-500-10><a class=lnlinks href=#hl-500-10>10</a>
</span><span class=lnt id=hl-500-11><a class=lnlinks href=#hl-500-11>11</a>
</span><span class=lnt id=hl-500-12><a class=lnlinks href=#hl-500-12>12</a>
</span><span class=lnt id=hl-500-13><a class=lnlinks href=#hl-500-13>13</a>
</span><span class=lnt id=hl-500-14><a class=lnlinks href=#hl-500-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取旧的数组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>es</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getArray</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>es</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 拷贝新的数组（这里是比较耗时的操作，但不影响其它读线程）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>es</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>copyOf</span><span class=p>(</span><span class=n>es</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 添加新元素</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>es</span><span class=o>[</span><span class=n>len</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 替换旧的数组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setArray</span><span class=p>(</span><span class=n>es</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>这里的源码版本是 Java 11，在 Java 1.8 中使用的是可重入锁而不是 synchronized</p></blockquote><p>其它读操作并未加锁，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-501-1><a class=lnlinks href=#hl-501-1>1</a>
</span><span class=lnt id=hl-501-2><a class=lnlinks href=#hl-501-2>2</a>
</span><span class=lnt id=hl-501-3><a class=lnlinks href=#hl-501-3>3</a>
</span><span class=lnt id=hl-501-4><a class=lnlinks href=#hl-501-4>4</a>
</span><span class=lnt id=hl-501-5><a class=lnlinks href=#hl-501-5>5</a>
</span><span class=lnt id=hl-501-6><a class=lnlinks href=#hl-501-6>6</a>
</span><span class=lnt id=hl-501-7><a class=lnlinks href=#hl-501-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>forEach</span><span class=p>(</span><span class=n>Consumer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>action</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Objects</span><span class=p>.</span><span class=na>requireNonNull</span><span class=p>(</span><span class=n>action</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>getArray</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>E</span><span class=p>)</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>action</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>适合『读多写少』的应用场景</p><h5 id=get-弱一致性image-20220317202641399httpslogan1357810xyznotgitjucimage-20220317202641399png><a href=#get-%e5%bc%b1%e4%b8%80%e8%87%b4%e6%80%a7image-20220317202641399httpslogan1357810xyznotgitjucimage-20220317202641399png class=header-anchor>#</a>
get 弱一致性
<img src=https://logan.1357810.xyz/notgit/juc/image-20220317202641399.png width=900 height=600 loading=lazy decoding=async alt=image-20220317202641399 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></h5><div class=table-wrapper><table><thead><tr><th style=text-align:center>时间点</th><th style=text-align:center>操作</th></tr></thead><tbody><tr><td style=text-align:center>1</td><td style=text-align:center>Thread-0 getArray()</td></tr><tr><td style=text-align:center>2</td><td style=text-align:center>Thread-1 getArray()</td></tr><tr><td style=text-align:center>3</td><td style=text-align:center>Thread-1 setArray(arrayCopy)</td></tr><tr><td style=text-align:center>4</td><td style=text-align:center>Thread-0 array[index]</td></tr></tbody></table></div><blockquote><p>不容易测试，但问题确实存在</p></blockquote><h5 id=迭代器弱一致性><a href=#%e8%bf%ad%e4%bb%a3%e5%99%a8%e5%bc%b1%e4%b8%80%e8%87%b4%e6%80%a7 class=header-anchor>#</a>
迭代器弱一致性</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-502-1><a class=lnlinks href=#hl-502-1> 1</a>
</span><span class=lnt id=hl-502-2><a class=lnlinks href=#hl-502-2> 2</a>
</span><span class=lnt id=hl-502-3><a class=lnlinks href=#hl-502-3> 3</a>
</span><span class=lnt id=hl-502-4><a class=lnlinks href=#hl-502-4> 4</a>
</span><span class=lnt id=hl-502-5><a class=lnlinks href=#hl-502-5> 5</a>
</span><span class=lnt id=hl-502-6><a class=lnlinks href=#hl-502-6> 6</a>
</span><span class=lnt id=hl-502-7><a class=lnlinks href=#hl-502-7> 7</a>
</span><span class=lnt id=hl-502-8><a class=lnlinks href=#hl-502-8> 8</a>
</span><span class=lnt id=hl-502-9><a class=lnlinks href=#hl-502-9> 9</a>
</span><span class=lnt id=hl-502-10><a class=lnlinks href=#hl-502-10>10</a>
</span><span class=lnt id=hl-502-11><a class=lnlinks href=#hl-502-11>11</a>
</span><span class=lnt id=hl-502-12><a class=lnlinks href=#hl-502-12>12</a>
</span><span class=lnt id=hl-502-13><a class=lnlinks href=#hl-502-13>13</a>
</span><span class=lnt id=hl-502-14><a class=lnlinks href=#hl-502-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CopyOnWriteArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>iter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>list</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep1s</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//此时主线程的iterator依旧指向旧的数组。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>iter</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>iter</span><span class=p>.</span><span class=na>next</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>不要觉得弱一致性就不好</p><ul><li>数据库的 MVCC 都是弱一致性的表现</li><li>并发高和一致性是矛盾的，需要权衡</li></ul></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/juc/>Juc</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2024年5月8日 21:39</span></section></footer></article><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/waline/2.9.1/waline.min.css crossorigin=anonymous><script src=https://cdn.bootcdn.net/ajax/libs/waline/2.9.1/waline.min.js crossorigin=anonymous></script><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],lang:"zh-cn",locale:{admin:"Admin",placeholder:null},requiredMeta:["nick"],serverURL:"https://waline.wssw.fun/"})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 &nbsp;&nbsp;by &nbsp; logan</section><section class=powerby>发表了88篇文章 ·
总计565.78k字</section><section class=powerby><div class=powerby><span id=busuanzi_container_site_pv>本站总访问量<span id=busuanzi_value_site_pv></span>次
</span><span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span></div></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.js crossorigin=anonymous defer></script><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.css crossorigin=anonymous><script src=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js crossorigin=anonymous defer></script><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css crossorigin=anonymous></main></div><script type=text/javascript src=/ts/main.js defer></script><a href=javascript:void(0) class=right_things id=back-to-top title=返回顶部></a><style>html{scroll-behavior:smooth}#back-to-top{z-index:998!important;transition:1.5s ease,opacity 2s ease,visibility 2s ease,right .8s ease;opacity:0;display:inline-block;visibility:hidden;position:fixed;bottom:10px;right:10px;width:55px;height:55px;font-size:30px;text-align:center;line-height:50px;border-radius:20px;box-shadow:var(--shadow-l1);cursor:pointer;color:var(--body-text-color);background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #241348 0%, #4d0404 100%); }}#back-to-top:before{content:' ';display:inline-block;position:relative;top:0;transform:rotate(135deg);height:10px;width:10px;border-width:0 0 2px 2px;border-style:solid}#back-to-top:hover{transform:scale(1.1,1.1);background-image:linear-gradient(-225deg,#E3FDF5 0%,#FFE6FA 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #432581 0%, #861818 100%); }}#back-to-top:hover:before{border-color:#2674e0}@media screen and (max-width:768px){#back-to-top{width:35px;height:35px;font-size:10px;right:15px}}</style><script>function resizeRight(){var t=document.querySelectorAll(".right_things"),e=window.innerWidth;t.length>0&&t.forEach(function(t){e>2100?t.style.right="280px":e>1800?t.style.right="120px":e<1800&&(t.style.right="10px")})}window.addEventListener("resize",function(){requestAnimationFrame(resizeRight)});function backToTop(){window.scrollTo({top:0,behavior:"smooth"})}window.onload=function(){requestAnimationFrame(resizeRight);var t=this.document.documentElement.scrollTop||this.document.body.scrollTop,e=this.document.getElementById("back-to-top");t>0?(e.style.visibility="visible",e.style.opacity="1"):(e.style.opacity="0",e.style.visibility="hidden")},window.onscroll=function(){var t=this.document.documentElement.scrollTop||this.document.body.scrollTop,e=this.document.getElementById("back-to-top");t<400?(e.style.opacity="0",e.style.visibility="hidden"):(e.style.visibility="visible",e.style.opacity="1",e.addEventListener("click",backToTop,!1))}</script><style>.toggle-toc-inner,.toggle-toc-inner svg{z-index:1!important;pointer-events:none}.toggle-toc-inner{width:100%;height:100%;display:flex;align-items:center;justify-content:center}.toggle-toc-inner svg{display:none}#toc-container{display:none;position:fixed;bottom:120px;right:80px;padding:10px;border:1px solid #96979a50;border-radius:var(--card-border-radius);box-shadow:rgba(14,30,37,.12)0 2px 4px,rgba(14,30,37,.32)0 2px 16px;z-index:997!important;max-height:80vh;overflow-y:auto;width:auto;max-width:290px;background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(45deg, #8baaaa 0%, #ae8b9c 100%); color: #FFFFFFB2; }}#TableOfContents{background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(45deg, #8baaaa 0%, #ae8b9c 100%); }}#TableOfContents a:hover{font-weight:bolder}[data-scheme=dark] #TableOfContents a{color:#212223}[data-scheme=dark] #TableOfContents a:hover{color:#052ed3}#toggle-toc{transition:1.5s ease,opacity 2s ease,visibility 2s ease,right .8s ease;opacity:0;display:block;visibility:hidden;position:fixed;bottom:75px;right:10px;width:55px;height:55px;font-size:1.7rem;padding:5px;z-index:1000!important;border:0 solid #96979a50;border-radius:20px;box-shadow:var(--shadow-l1);color:#707070;cursor:pointer;background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #241348 0%, #4d0404 100%); color: #FFFFFFB2; } animation: jump 0.3s 4;animation-delay:.6s}#toggle-toc:hover{transform:scale(1.1,1.1);background-image:linear-gradient(-225deg,#E3FDF5 0%,#FFE6FA 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #432581 0%, #861818 100%); }}.widget--toc #TableOfContents{overflow-x:auto;max-height:66vh;width:auto}.toggle-toc-inner::before{content:'目录'}@media screen and (max-width:768px){#toggle-toc{width:35px;height:35px;font-size:10px;bottom:60px;right:15px}.toggle-toc-inner::before{content:''}.toggle-toc-inner svg{display:block}#toc-container{bottom:100px;right:60px}}</style><a id=toggle-toc class=right_things title=目录 href=javascript:void(0)><div class=toggle-toc-inner><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></div></a><section class="widget archives" id=toc-container><h2 class=section-title>目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#2进程与线程>2.进程与线程</a><ol><li><a href=#21-进程与线程>2.1 进程与线程</a><ol><li><a href=#进程>进程</a></li><li><a href=#线程>线程</a></li><li><a href=#二者对比>二者对比</a></li></ol></li><li><a href=#22-并行与并发>2.2 并行与并发</a></li><li><a href=#23-应用>2.3 应用</a><ol><li><a href=#textcolorgreen应用之异步调用案例1->$\textcolor{Green}{*应用之异步调用（案例1）} $</a><ol><li><a href=#需要等待结果>需要等待结果</a><ol><li><a href=#future-实现同步>Future 实现（同步）</a></li><li><a href=#自定义实现同步>自定义实现（同步）</a></li><li><a href=#completablefuture-实现异步>CompletableFuture 实现（异步）</a></li><li><a href=#blockingqueue-实现异步>BlockingQueue 实现（异步）</a></li></ol></li><li><a href=#不需等待结果>不需等待结果</a><ol><li><a href=#普通线程实现>普通线程实现</a></li><li><a href=#线程池实现>线程池实现</a></li><li><a href=#completablefuture-实现>CompletableFuture 实现</a></li></ol></li></ol></li><li><a href=#textcolorgreen应用之提高效率案例1->$\textcolor{Green}{*应用之提高效率（案例1） }$</a><ol><li><ol><li><a href=#1设计>1.设计</a></li><li><a href=#2结论>2.结论</a></li></ol></li></ol></li></ol></li></ol></li><li><a href=#3java-线程>3.Java 线程</a><ol><li><a href=#31-创建和运行线程>3.1 创建和运行线程</a><ol><li><a href=#方法一直接使用-thread>方法一，直接使用 Thread</a></li><li><a href=#方法二使用-runnable-配合-thread>方法二，使用 Runnable 配合 Thread</a><ol><li><ol><li><a href=#thread-与-runnable-的关系>Thread 与 Runnable 的关系</a></li><li><a href=#小结>小结</a></li></ol></li></ol></li><li><a href=#方法三futuretask-配合-thread>方法三，FutureTask 配合 Thread</a></li></ol></li><li><a href=#32-观察多个线程同时运行>3.2 观察多个线程同时运行</a></li><li><a href=#33-查看进程线程的方法>3.3 查看进程线程的方法</a><ol><li><a href=#windows>windows</a></li><li><a href=#linux>Linux</a></li><li><a href=#java>Java</a></li></ol></li><li><a href=#textcolorblue34--原理之线程运行->$\textcolor{Blue}{3.4 * 原理之线程运行} $</a><ol><li><a href=#栈与栈帧>栈与栈帧</a></li><li><a href=#线程上下文切换thread-context-switch>线程上下文切换（Thread Context Switch）</a></li></ol></li><li><a href=#35常见方法>3.5常见方法</a></li><li><a href=#36-start-与-run>3.6 start 与 run</a><ol><li><a href=#调用-run>调用 run</a></li><li><a href=#调用start>调用start</a></li><li><a href=#小结-1>小结</a></li></ol></li><li><a href=#37-sleep-与-yield>3.7 sleep 与 yield</a><ol><li><a href=#sleep>sleep</a></li><li><a href=#yield>yield</a></li><li><a href=#线程优先级>线程优先级</a></li><li><a href=#测试优先级和yield>测试优先级和yield</a></li><li><a href=#textcolorgreen-应用之限制案例1-->$\textcolor{Green}{* 应用之限制（案例1） } $</a><ol><li><a href=#sleep-实现>sleep 实现</a></li><li><a href=#wait-实现>wait 实现</a></li><li><a href=#条件变量实现>条件变量实现</a></li></ol></li></ol></li><li><a href=#38-join-方法详解>3.8 join 方法详解</a><ol><li><a href=#为什么需要-join>为什么需要 join</a></li><li><a href=#textcolorgreen-应用之同步案例1>$\textcolor{green}{* 应用之同步（案例1）}$</a></li><li><a href=#有时效的join>有时效的join</a></li></ol></li><li><a href=#39-interrupt方法详解>3.9 interrupt方法详解</a><ol><li><a href=#interrupt说明><code>Interrupt</code>说明</a></li><li><a href=#打断-sleepwaitjoin-的线程>打断 sleep，wait，join 的线程</a></li><li><a href=#打断正常运行的线程>打断正常运行的线程</a></li><li><a href=#font-colororange-模式之两阶段终止font><font color=orange>* 模式之两阶段终止</font></a><ol><li><a href=#错误思路>错误思路</a></li><li><a href=#两阶段终止模式>两阶段终止模式</a><ol><li><a href=#利用-isinterrupted>利用 isInterrupted</a></li><li><a href=#利用停止标记>利用停止标记</a></li></ol></li></ol></li><li><a href=#打断-park-线程>打断 park 线程</a></li></ol></li><li><a href=#310-不推荐的方法>3.10 不推荐的方法</a></li><li><a href=#311-主线程与守护线程>3.11 主线程与守护线程</a></li><li><a href=#312-五种状态>3.12 五种状态</a></li><li><a href=#313-六种状态>3.13 六种状态</a></li><li><a href=#314-习题>3.14 习题</a><ol><li><a href=#textcolorgreen-应用之统筹烧水泡茶>$\textcolor{green}{* 应用之统筹（烧水泡茶）}$</a><ol><li><a href=#解法1join>解法1：join</a></li><li><a href=#解法2waitnotify>解法2：wait/notify</a></li><li><a href=#解法3第三者协调>解法3：第三者协调</a></li></ol></li></ol></li><li><a href=#本章小结>本章小结</a></li></ol></li><li><a href=#4共享模型之管程>4.共享模型之管程</a><ol><li><a href=#41共享带来的问题>4.1共享带来的问题</a><ol><li><ol><li><ol><li><a href=#java代码示例><strong>Java代码示例</strong></a></li><li><a href=#问题分析><strong>问题分析</strong></a></li><li><a href=#临界区-critical-section><strong>临界区 Critical Section</strong></a></li><li><a href=#竞态条件-race-condition><strong>竞态条件 Race Condition</strong></a></li></ol></li></ol></li></ol></li><li><a href=#42-synchronized-解决方案>4.2 synchronized 解决方案</a><ol><li><ol><li><ol><li><a href=#textcolorgreen应用之互斥>*<em>$\textcolor{green}{<em>应用之互斥}$</em></em></a></li><li><a href=#synchronized><strong>synchronized</strong></a></li><li><a href=#面向对象改进><strong>面向对象改进</strong></a></li></ol></li></ol></li></ol></li><li><a href=#43-方法上的-synchronized>4.3 方法上的 synchronized</a><ol><li><ol><li><ol><li><a href=#不加-synchronized-的方法><strong>不加 synchronized 的方法</strong></a></li><li><a href=#所谓的线程八锁><strong>所谓的“线程八锁”</strong></a></li></ol></li></ol></li></ol></li><li><a href=#44-变量的线程安全分析>4.4 变量的线程安全分析</a><ol><li><ol><li><ol><li><a href=#成员变量和静态变量是否线程安全><strong>成员变量和静态变量是否线程安全？</strong></a></li><li><a href=#局部变量是否线程安全><strong>局部变量是否线程安全？</strong></a></li><li><a href=#局部变量线程安全分析><strong>局部变量线程安全分析</strong></a></li><li><a href=#常见线程安全类><strong>常见线程安全类</strong></a></li><li><a href=#实例分析>实例分析</a></li></ol></li></ol></li></ol></li><li><a href=#45-习题>4.5 习题</a><ol><li><ol><li><ol><li><a href=#卖票练习>卖票练习</a></li><li><a href=#转账练习>转账练习</a></li></ol></li></ol></li></ol></li><li><a href=#46-monitor-概念>4.6 Monitor 概念</a><ol><li><a href=#java-对象头><strong>Java 对象头</strong></a></li><li><a href=#font-colorblue-原理之monitor锁font><font color=blue>* 原理之Monitor(锁)</font></a></li><li><a href=#font-colorblue-原理之-synchronizedfont><font color=blue>* 原理之 synchronized</font></a></li><li><a href=#font-colorblue-原理之-synchronized-进阶font><font color=blue>* 原理之 synchronized 进阶</font></a><ol><li><a href=#轻量级锁>轻量级锁</a></li><li><a href=#锁膨胀>锁膨胀</a></li><li><a href=#自旋优化>自旋优化</a></li><li><a href=#偏向锁>偏向锁</a><ol><li><a href=#偏向状态>偏向状态</a></li><li><a href=#撤销---调用对象-hashcode>撤销 - 调用对象 hashCode</a></li><li><a href=#撤销---其它线程使用对象>撤销 - 其它线程使用对象</a></li><li><a href=#撤销---调用-waitnotify>撤销 - 调用 wait/notify</a></li><li><a href=#批量重偏向><strong>批量重偏向</strong></a></li><li><a href=#批量撤销>批量撤销</a></li><li><a href=#锁消除>锁消除</a></li></ol></li></ol></li></ol></li><li><a href=#47-wait-notify>4.7 wait notify</a><ol><li><ol><li><a href=#font-colorblue-原理之-wait--notifyfont><font color=blue>* 原理之 wait / notify</font></a></li><li><a href=#api-介绍><strong>API 介绍</strong></a></li></ol></li></ol></li><li><a href=#48-wait-notify-的正确姿势>4.8 wait notify 的正确姿势</a><ol><li><ol><li><a href=#sleeplong-n-和-waitlong-n-的区别><code>sleep(long n)</code> 和 <code>wait(long n)</code> 的区别</a></li><li><a href=#step-1>step 1</a></li><li><a href=#step-2>step 2</a></li><li><a href=#step-3>step 3</a></li><li><a href=#step-4>step 4</a></li><li><a href=#step-5>step 5</a></li><li><a href=#textcolororange模式之保护性暂停>$\textcolor{orange}{*模式之保护性暂停}$</a><ol><li><a href=#1定义><strong>1.定义</strong></a></li><li><a href=#2实现><strong>2.实现</strong></a></li><li><a href=#3带超时版-guardedobject><strong>3.带超时版 GuardedObject</strong></a></li><li><a href=#textcolorblue-原理之-join>$\textcolor{blue}{* 原理之 join}$</a></li><li><a href=#4多任务版guardedobject><strong>4.多任务版</strong>GuardedObject</a></li></ol></li><li><a href=#textcolororange-模式之生产者消费者>$\textcolor{orange}{* 模式之生产者消费者}$</a><ol><li><a href=#1定义-1>1.定义</a></li><li><a href=#2实现-1>2.实现</a></li></ol></li></ol></li></ol></li><li><a href=#49-park--unpark>4.9 Park & Unpark</a><ol><li><ol><li><ol><li><a href=#基本使用>基本使用</a></li><li><a href=#特点>特点</a></li><li><a href=#textcolorblue-原理之park和unpark>$\textcolor{blue}{* 原理之park和unpark}$</a></li></ol></li></ol></li></ol></li><li><a href=#410-重新理解线程状态转换>4.10 重新理解线程状态转换</a><ol><li><ol><li><ol><li><a href=#情况-1-new----runnable>情况 1 <code>NEW --> RUNNABLE</code></a></li><li><a href=#情况-2-runnable----waiting>情况 2 <code>RUNNABLE &lt;--> WAITING</code></a></li><li><a href=#情况-3-runnable----waiting>情况 3 <code>RUNNABLE &lt;--> WAITING</code></a></li><li><a href=#情况-4-runnable----waiting>情况 4 <code>RUNNABLE &lt;--> WAITING</code></a></li><li><a href=#情况-5-runnable----timed_waiting>情况 5 <code>RUNNABLE &lt;--> TIMED_WAITING</code></a></li><li><a href=#情况-6-runnable----timed_waiting>情况 6 <code>RUNNABLE &lt;--> TIMED_WAITING</code></a></li><li><a href=#情况-7-runnable----timed_waiting>情况 7 <code>RUNNABLE &lt;--> TIMED_WAITING</code></a></li><li><a href=#情况-8-runnable----timed_waiting>情况 8 <code>RUNNABLE &lt;--> TIMED_WAITING</code></a></li><li><a href=#情况-9-runnable----blocked>情况 9 <code>RUNNABLE &lt;--> BLOCKED</code></a></li><li><a href=#情况-10-runnable----terminated>情况 10 <code>RUNNABLE &lt;--> TERMINATED</code></a></li></ol></li></ol></li></ol></li><li><a href=#411-多把锁>4.11 多把锁</a></li><li><a href=#412-活跃性>4.12 活跃性</a><ol><li><ol><li><ol><li><a href=#死锁><strong>死锁</strong></a></li><li><a href=#定位死锁><strong>定位死锁</strong></a></li><li><a href=#活锁><strong>活锁</strong></a></li><li><a href=#饥饿><strong>饥饿</strong></a></li></ol></li></ol></li></ol></li><li><a href=#413-reentrantlock>4.13 ReentrantLock</a><ol><li><ol><li><a href=#可重入>可重入</a></li><li><a href=#可打断>可打断</a></li><li><a href=#锁超时>锁超时</a></li><li><a href=#公平锁>公平锁</a></li><li><a href=#条件变量>条件变量</a><ol><li><a href=#使用要点>使用要点</a></li><li><a href=#详细api>详细API</a></li></ol></li><li><a href=#font-colororange-同步模式之顺序控制font><font color=orange>* 同步模式之顺序控制</font></a><ol><li><a href=#固定运行顺序>固定运行顺序</a></li><li><a href=#交替输出>交替输出</a></li></ol></li></ol></li></ol></li><li><a href=#本章小结-1>本章小结</a></li></ol></li><li><a href=#5共享模型之内存>5.共享模型之内存</a><ol><li><a href=#51-java-内存模型>5.1 Java 内存模型</a></li><li><a href=#52-可见性>5.2 可见性</a><ol><li><ol><li><a href=#退不出的循环>退不出的循环</a></li><li><a href=#解决方法>解决方法</a></li><li><a href=#可见性-vs-原子性>可见性 vs 原子性</a></li><li><a href=#font-colororange-模式之两阶段终止font-1><font color=orange>* 模式之两阶段终止</font></a><ol><li><a href=#1错误思路>1.错误思路</a></li><li><a href=#2两阶段终止模式>2.两阶段终止模式</a></li><li><a href=#利用volatile修饰的停止标记>利用volatile修饰的停止标记</a></li></ol></li><li><a href=#font-colororange-模式之-balkingfont><font color=orange>* 模式之 Balking</font></a><ol><li><a href=#1定义-2>1.定义</a></li><li><a href=#2实现-2>2.实现</a></li></ol></li></ol></li></ol></li><li><a href=#53-有序性>5.3 有序性</a><ol><li><ol><li><a href=#font-colorblue-原理之指令级并行font><font color=blue>* 原理之指令级并行</font></a><ol><li><a href=#名词>名词</a></li><li><a href=#指令重排序优化>指令重排序优化</a></li><li><a href=#支持流水线的处理器>支持流水线的处理器</a></li><li><a href=#superscalar-处理器>SuperScalar 处理器</a></li></ol></li><li><a href=#诡异的结果>诡异的结果</a></li><li><a href=#解决方法-1>解决方法</a></li><li><a href=#font-colorblue-原理之-volatilefont><font color=blue>* 原理之 volatile</font></a><ol><li><a href=#如何保证可见性>如何保证可见性</a></li><li><a href=#如何保证有序性>如何保证有序性</a></li><li><a href=#double-checked-locking-问题>double-checked locking 问题</a></li><li><a href=#double-checked-locking-解决>double-checked locking 解决</a></li></ol></li><li><a href=#happens-before>happens-before</a></li><li><a href=#习题>习题</a><ol><li><a href=#balking-模式习题>balking 模式习题</a></li><li><a href=#线程安全单例习题>线程安全单例习题</a></li></ol></li></ol></li></ol></li><li><a href=#本章小结-2>本章小结</a></li></ol></li><li><a href=#6共享模型之无锁>6.共享模型之无锁</a><ol><li><a href=#61-问题提出-应用之互斥>6.1 问题提出 (应用之互斥)</a><ol><li><ol><li><ol><li><a href=#为什么不安全><strong>为什么不安全</strong></a></li><li><a href=#解决思路-锁悲观互斥><strong>解决思路-锁</strong>（悲观互斥）</a></li><li><a href=#解决思路-无锁乐观重试><strong>解决思路-无锁</strong>（乐观重试）</a></li></ol></li></ol></li></ol></li><li><a href=#62-cas-与-volatile>6.2 CAS 与 volatile</a><ol><li><ol><li><ol><li><a href=#慢动作分析>慢动作分析</a></li><li><a href=#volatile>volatile</a></li><li><a href=#cas-的特点>CAS 的特点</a></li></ol></li></ol></li></ol></li><li><a href=#63-原子整数>6.3 原子整数</a></li><li><a href=#64-原子引用>6.4 原子引用</a><ol><li><ol><li><ol><li><a href=#不安全实现><strong>不安全实现</strong></a></li><li><a href=#安全实现-使用锁><strong>安全实现-使用锁</strong></a></li><li><a href=#安全实现-使用-cas><strong>安全实现-使用 CAS</strong></a></li><li><a href=#aba-问题及解决>ABA 问题及解决</a></li></ol></li></ol></li></ol></li><li><a href=#65-原子数组>6.5 原子数组</a></li><li><a href=#66-字段更新器>6.6 字段更新器</a></li><li><a href=#67-原子累加器>6.7 原子累加器</a><ol><li><ol><li><a href=#累加器性能比较>累加器性能比较</a></li><li><a href=#font-colorblue-原理之伪共享cpu-缓存结构font><font color=blue>* 原理之伪共享(CPU 缓存结构)</font></a><ol><li><a href=#cpu-缓存结构><strong>CPU 缓存结构</strong></a></li><li><a href=#cpu-缓存读><strong>CPU 缓存读</strong></a></li><li><a href=#cpu-缓存一致性><strong>CPU 缓存一致性</strong></a></li><li><a href=#内存屏障><strong>内存屏障</strong></a></li></ol></li><li><a href=#font-colorblue-源码之-longadderfont><font color=blue>* 源码之 LongAdder</font></a></li><li><a href=#与运算和取模的关系>与运算和取模的关系</a></li></ol></li></ol></li><li><a href=#68-unsafe>6.8 Unsafe</a><ol><li><ol><li><a href=#概述>概述</a></li><li><a href=#unsafe-cas-操作>Unsafe CAS 操作</a><ol><li><a href=#unsafe实现字段更新>unsafe实现字段更新</a></li><li><a href=#unsafe实现原子整数>unsafe实现原子整数</a></li><li><a href=#手动实现原子整数完整版测试>手动实现原子整数完整版+测试</a></li></ol></li></ol></li></ol></li><li><a href=#69-自定义cas锁><strong>6.9 自定义cas锁</strong></a></li><li><a href=#本章小结-3>本章小结</a></li></ol></li><li><a href=#7共享模型之不可变>7.共享模型之不可变</a><ol><li><a href=#71-日期转换的问题>7.1 日期转换的问题</a><ol><li><ol><li><ol><li><a href=#问题提出>问题提出</a></li><li><a href=#思路---同步锁>思路 - 同步锁</a></li><li><a href=#思路---不可变>思路 - 不可变</a></li></ol></li></ol></li></ol></li><li><a href=#72-不可变设计>7.2 不可变设计</a><ol><li><ol><li><a href=#string类的设计>String类的设计</a></li><li><a href=#final-的使用>final 的使用</a></li><li><a href=#保护性拷贝>保护性拷贝</a></li><li><a href=#font-colororange模式之享元font><font color=orange>*模式之享元</font></a><ol><li><a href=#简介>简介</a></li><li><a href=#体现>体现</a></li><li><a href=#手动实现一个连接池>手动实现一个连接池</a></li></ol></li><li><a href=#font-colorblue-原理之-finalfont><font color=blue>* 原理之 final</font></a><ol><li><a href=#设置-final-变量的原理>设置 final 变量的原理</a></li><li><a href=#读取final变量原理>读取final变量原理</a></li><li><a href=#final总结>final总结</a></li></ol></li></ol></li></ol></li><li><a href=#73-无状态>7.3 无状态</a></li></ol></li><li><a href=#8共享模型之工具>8.共享模型之工具</a><ol><li><a href=#线程池>线程池</a><ol><li><ol><li><a href=#自定义线程池>自定义线程池</a></li><li><a href=#threadpoolexecutor>ThreadPoolExecutor</a><ol><li><a href=#线程池状态>线程池状态</a></li><li><a href=#构造方法>构造方法</a></li><li><a href=#工作方式>工作方式</a></li><li><a href=#newfixedthreadpool>newFixedThreadPool</a></li><li><a href=#newcachedthreadpool>newCachedThreadPool</a></li><li><a href=#newsinglethreadexecutor>newSingleThreadExecutor</a></li><li><a href=#提交任务>提交任务</a></li><li><a href=#关闭线程池>关闭线程池</a></li><li><a href=#font-colororange模式之-worker-threadfont><font color=orange>*模式之 Worker Thread</font></a></li><li><a href=#任务调度线程池>任务调度线程池</a></li><li><a href=#正确处理执行任务异常>正确处理执行任务异常</a></li><li><a href=#font-colorgreen-应用之定时任务font><font color=green>* 应用之定时任务</font></a></li><li><a href=#tomcat-线程池>Tomcat 线程池</a></li></ol></li><li><a href=#forkjoin>Fork/Join</a><ol><li><a href=#概念>概念</a></li><li><a href=#font-colorgreen应用之求和font><font color=green>应用之求和</font></a></li></ol></li></ol></li></ol></li><li><a href=#font-colorblueaqs-原理font><font color=blue>*AQS 原理</font></a><ol><li><a href=#概述-1>概述</a></li><li><a href=#实现不可重入锁>实现不可重入锁</a><ol><li><ol><li><a href=#自定义同步器><strong>自定义同步器</strong></a></li><li><a href=#自定义锁><strong>自定义锁</strong></a></li></ol></li></ol></li><li><a href=#心得>心得</a><ol><li><ol><li><a href=#起源><strong>起源</strong></a></li><li><a href=#目标><strong>目标</strong></a></li><li><a href=#设计><strong>设计</strong></a></li><li><a href=#主要用到-aqs-的并发工具类>主要用到 AQS 的并发工具类</a></li></ol></li></ol></li></ol></li><li><a href=#reentrantlock-原理>ReentrantLock 原理</a><ol><li><a href=#非公平锁实现原理>非公平锁实现原理</a><ol><li><ol><li><a href=#加锁解锁流程>加锁解锁流程</a></li><li><a href=#加锁源码>加锁源码</a></li><li><a href=#解锁源码>解锁源码</a></li></ol></li></ol></li><li><a href=#可重入原理>可重入原理</a></li><li><a href=#可打断原理>可打断原理</a></li><li><a href=#公平锁实现原理>公平锁实现原理</a></li><li><a href=#条件变量实现原理>条件变量实现原理</a><ol><li><a href=#await-流程>await 流程</a></li><li><a href=#signal-流程>signal 流程</a></li><li><a href=#源码>源码</a></li></ol></li></ol></li><li><a href=#读写锁>读写锁</a><ol><li><a href=#reentrantreadwritelock>ReentrantReadWriteLock</a></li><li><a href=#font-colorgreen-应用之缓存font><font color=green>* 应用之缓存</font></a><ol><li><ol><li><a href=#缓存更新策略>缓存更新策略</a></li><li><a href=#读写锁实现一致性缓存>读写锁实现一致性缓存</a></li></ol></li></ol></li><li><a href=#font-colorblue-读写锁原理font><font color=blue>* 读写锁原理</font></a><ol><li><a href=#图解流程>图解流程</a></li><li><a href=#源码分析>源码分析</a><ol><li><a href=#写锁上锁流程><strong>写锁上锁流程</strong></a></li><li><a href=#写锁释放流程><strong>写锁释放流程</strong></a></li><li><a href=#读锁上锁流程><strong>读锁上锁流程</strong></a></li><li><a href=#读锁释放流程><strong>读锁释放流程</strong></a></li></ol></li></ol></li><li><a href=#stampedlock>StampedLock</a></li></ol></li><li><a href=#semaphore>Semaphore</a><ol><li><a href=#基本使用-1>基本使用</a></li><li><a href=#font-colorgreen-semaphore-应用font><font color=green>* Semaphore 应用</font></a></li><li><a href=#font-colorblue-semaphore-原理font><font color=blue>* Semaphore 原理</font></a><ol><li><a href=#加锁解锁流程-1>加锁解锁流程</a></li><li><a href=#源码分析-1>源码分析</a><ol><li><a href=#加锁流程总结>加锁流程总结：</a></li><li><a href=#解锁流程总结>解锁流程总结：</a></li></ol></li><li><a href=#为什么要有-propagate>为什么要有 PROPAGATE</a></li></ol></li></ol></li><li><a href=#countdownlatch>CountdownLatch</a><ol><li><a href=#font-colorgreen-应用之同步等待多线程准备完毕font><font color=green>* 应用之同步等待多线程准备完毕</font></a></li><li><a href=#font-colorgreen-应用之同步等待多个远程调用结束font><font color=green>* 应用之同步等待多个远程调用结束</font></a></li></ol></li><li><a href=#cyclicbarrier>CyclicBarrier</a></li><li><a href=#线程安全集合类概述>线程安全集合类概述</a></li><li><a href=#concurrenthashmap>ConcurrentHashMap</a><ol><li><a href=#font-colorgreen应用之单词计数font><font color=green>应用之单词计数</font></a><ol><li><ol><li><a href=#实现一>实现一：</a></li><li><a href=#正确答案一>正确答案一：</a></li><li><a href=#正确答案二>正确答案二：</a></li></ol></li></ol></li><li><a href=#font-colorblue-concurrenthashmap-原理font><font color=blue>* ConcurrentHashMap 原理</font></a><ol><li><a href=#jdk-7-hashmap-并发死链>JDK 7 HashMap 并发死链</a><ol><li><a href=#测试代码>测试代码</a></li><li><a href=#死链复现>死链复现</a></li><li><a href=#源码分析-2><strong>源码分析</strong></a></li></ol></li><li><a href=#jdk-8-concurrenthashmap>JDK 8 ConcurrentHashMap</a><ol><li><a href=#重要属性和内部类>重要属性和内部类</a></li><li><a href=#重要方法>重要方法</a></li><li><a href=#构造器分析>构造器分析</a></li><li><a href=#get流程>get流程</a></li><li><a href=#put-流程>put 流程</a></li><li><a href=#size-计算流程>size 计算流程</a></li><li><a href=#总结>总结</a></li></ol></li><li><a href=#jdk-7-concurrenthashmap>JDK 7 ConcurrentHashMap</a><ol><li><a href=#构造器分析-1>构造器分析</a></li><li><a href=#put-流程-1>put 流程</a></li><li><a href=#rehash-流程>rehash 流程</a></li><li><a href=#get-流程>get 流程</a></li><li><a href=#size-计算流程-1>size 计算流程</a></li></ol></li></ol></li></ol></li><li><a href=#blockingqueue>BlockingQueue</a><ol><li><a href=#font-colorblue-blockingqueue-原理font><font color=blue>* BlockingQueue 原理</font></a><ol><li><a href=#基本的入队出队>基本的入队出队</a><ol><li><a href=#初始化链表>初始化链表</a></li><li><a href=#当一个节点入队>当一个节点入队</a></li><li><a href=#出队>出队</a></li></ol></li><li><a href=#加锁分析>加锁分析</a></li><li><a href=#性能比较>性能比较</a></li></ol></li></ol></li><li><a href=#concurrentlinkedqueue>ConcurrentLinkedQueue</a><ol><li><a href=#font-colorblueconcurrentlinkedqueue-原理font><font color=blue>*ConcurrentLinkedQueue 原理</font></a><ol><li><a href=#模仿-concurrentlinkedqueue>模仿 ConcurrentLinkedQueue</a></li></ol></li></ol></li><li><a href=#copyonwritearraylist>CopyOnWriteArrayList</a><ol><li><ol><li><ol><li><a href=#get-弱一致性image-20220317202641399httpslogan1357810xyznotgitjucimage-20220317202641399png>get 弱一致性<img src=https://logan.1357810.xyz/notgit/juc/image-20220317202641399.png alt=image-20220317202641399></a></li><li><a href=#迭代器弱一致性>迭代器弱一致性</a></li></ol></li></ol></li></ol></li></ol></li></ol></nav></div></section><script>var toggleButton=document.getElementById("toggle-toc"),tocContainer=document.getElementById("toc-container"),scrollThreshold=400;function extracted(){var e=window.scrollY||window.pageYOffset;e>=scrollThreshold?(toggleButton.style.visibility="visible",toggleButton.style.opacity="1"):(toggleButton.style.opacity="0",toggleButton.style.visibility="hidden")}window.addEventListener("scroll",function(){extracted()}),window.onload=function(){extracted()},toggleButton.addEventListener("click",function(e){tocContainer.style.display==="none"||tocContainer.style.display===""?tocContainer.style.display="block":tocContainer.style.display="none",e.stopPropagation()}),"ontouchstart"in window||toggleButton.addEventListener("mouseover",function(){tocContainer.style.display="block"}),document.addEventListener("click",function(e){!tocContainer.contains(e.target)&&!toggleButton.contains(e.target)&&e.target!==toggleButton&&e.target!==tocContainer&&(tocContainer.style.display="none")})</script><script src=https://cdn.bootcdn.net/ajax/libs/nprogress/0.2.0/nprogress.min.js crossorigin=anonymous></script><div class=top-scroll-bar></div><style>.top-scroll-bar,.page-load-progress-bar{position:fixed;top:0;left:0;z-index:9999;display:none;width:0;height:4px;border-radius:5px;background-image:linear-gradient(to right,#5a0ca6 0%,rgba(208,114,155,.84) 50%,#29d 100%); [data-scheme="light"] & { background-image: linear-gradient(to right, #78ee6e 0%, #5069e3 50%, #29d 100%); }}#nprogress{pointer-events:none}#nprogress .my_bar{background-image:linear-gradient(to right,#5a0ca6 0%,rgba(208,114,155,.84) 50%,#29d 100%); [data-scheme="light"] & { background-image: linear-gradient(to right, #78ee6e 0%, #5069e3 50%, #29d 100%); } position: fixed;z-index:9999;top:0;left:0;border-radius:10px;width:100%;height:5px}#nprogress .my_peg{display:block;position:absolute;right:0;width:100px;height:100%;box-shadow:0 0 10px #29d,0 0 5px #29d;opacity:1;-webkit-transform:rotate(3deg)translate(0,-4px);-ms-transform:rotate(3deg)translate(0,-4px);transform:rotate(3deg)translate(0,-4px)}#nprogress .my_spinner{display:block;position:fixed;z-index:1031;top:15px;right:15px}#nprogress .my_spinner-icon{width:25px;height:25px;box-sizing:border-box;border:solid 3px transparent;border-top-color:#29d;border-left-color:#29d;border-radius:50%;-webkit-animation:nprogress-spinner 400ms linear infinite;animation:nprogress-spinner 400ms linear infinite}.nprogress-custom-parent{overflow:hidden;position:relative}.nprogress-custom-parent #nprogress .my_spinner,.nprogress-custom-parent #nprogress .my_bar{position:absolute}@-webkit-keyframes nprogress-spinner{0%{-webkit-transform:rotate(0)}100%{-webkit-transform:rotate(360deg)}}@keyframes nprogress-spinner{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style><script>var my_template='<div class="my_bar" role="bar"><div class="my_peg"></div></div><div class="my_spinner" role="spinner"><div class="my_spinner-icon"></div></div>';NProgress.configure({template:my_template}),NProgress.start(),document.addEventListener("readystatechange",()=>{if(document.readyState==="interactive"&&NProgress.inc(.6),document.readyState==="complete"){NProgress.done(!0),NProgress.configure({template:my_template,minimum:0,trickle:!1,showSpinner:!1});var e=document.querySelector(".top-scroll-bar");window.addEventListener("scroll",function(){var t=document.documentElement.scrollTop||document.body.scrollTop,n=document.documentElement.scrollHeight-document.documentElement.clientHeight,s=t/n*100;e.style.width=s+"%",e.style.display="block"})}})</script><script>function loadScript(e,t){var n=document.querySelector('script[src="'+e+'"]'),s=!1;n.onload=function(){s||(s=!0,t&&window[t]())},n.onreadystatechange=function(){!s&&(n.readyState==="loaded"||n.readyState==="complete")&&(s=!0,t&&window[t]())}}</script></body></html>