<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="javaå¤šçº¿ç¨‹,JUC,çº¿ç¨‹å®‰å…¨"><meta name=keywords content="javaå¤šçº¿ç¨‹,JUC,çº¿ç¨‹å®‰å…¨,çº¿ç¨‹é”"><title>JUC</title>
<link rel=canonical href=https://logan.wssw.fun/articles/java/juc/juc/><link rel=stylesheet href=/scss/style.min.13aa7f8d1031a866f598038f5f109d260d836a6b68cfc49d43713498eb7a1e2b.css><meta property='og:title' content="JUC"><meta property='og:description' content="javaå¤šçº¿ç¨‹,JUC,çº¿ç¨‹å®‰å…¨"><meta property='og:url' content='https://logan.wssw.fun/articles/java/juc/juc/'><meta property='og:site_name' content='Logançš„åšå®¢'><meta property='og:type' content='article'><meta property='article:section' content='Articles'><meta property='article:tag' content='java'><meta property='article:tag' content='juc'><meta property='article:published_time' content='2024-03-03T12:49:51+08:00'><meta property='article:modified_time' content='2024-05-08T21:39:00+08:00'><meta property='og:image' content='https://logan.wssw.fun/img/ttg.jpg'><meta name=twitter:title content="JUC"><meta name=twitter:description content="javaå¤šçº¿ç¨‹,JUC,çº¿ç¨‹å®‰å…¨"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://logan.wssw.fun/img/ttg.jpg'><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script async src="https://www.googletagmanager.com/gtag/js?id=G-R7GQB9XXQW"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-R7GQB9XXQW")}</script><meta name=google-site-verification content="3CAZCWVpDIWQxfZCqLMpov13bCzaH1QdnlHZTNnNjfM"><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css crossorigin=anonymous><script src=https://cdn.bootcdn.net/ajax/libs/busuanzi/2.3.0/bsz.pure.mini.min.js crossorigin=anonymous async></script><meta name=referrer content="no-referrer-when-downgrade"><script src=/js/sceneanimation.min.8c8c65611aaf0c8996e6d8a06f3e3bc82e6c8d2d2ab542e7cde8df7bceeeba9e.js integrity="sha256-jIxlYRqvDImW5tigbz47yC5sjS0qtULnzejfe87uup4=" crossorigin=anonymous async></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e==="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar-3K_hu560d426f92925c766fafa78be2429fd1_3226_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy decoding=async alt=Avatar>
</a><span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>LoganğŸŒ€</a></h1><h2 class=site-description>Starry serenade âœï¸</h2></div></header><ol class=menu-social><li><a href=https://github.com/loganoxo target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://blog.csdn.net/u014229652 target=_blank title=my_csdn rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>ä¸»é¡µ</span></a></li><li class=current><a href=/articles/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-heart" width="44" height="44" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/></svg>
<span>æˆ‘çš„</span></a></li><li><a href=/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span></a></li><li><a href=/page/photos/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-camera" width="44" height="44" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7h1a2 2 0 002-2 1 1 0 011-1h6a1 1 0 011 1 2 2 0 002 2h1a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9a2 2 0 012-2"/><path d="M9 13a3 3 0 106 0 3 3 0 00-6 0"/></svg>
<span>ç›¸å†Œ</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span></a></li><li><a href=/timeline/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-fish-christianity" width="44" height="44" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 7S16.354 17 9.692 17c-3.226.025-6.194-1.905-7.692-5 1.498-3.095 4.466-5.025 7.692-5C16.354 7 22 17 22 17"/></svg>
<span>å¹´è½´</span></a></li><li><a href=/page/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>å‹é“¾</span></a></li><li><a href=/page/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äº</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" p-id="14930" width="128" height="128"><path d="M253.939302 502.92736a269.74208 269.74208.0 00122.90048 235.84768 257.024 257.024.0 00259.95264 9.07264c81.46944-44.27776 135.70048-130.49856 139.0592-226.7136 5.14048-147.3536-107.37664-270.1312-250.63424-275.1488-145.32608-5.05856-266.1376 109.568-271.27808 256.94208zM531.730022.3072c16.384.57344 32.256 15.48288 31.62112 33.8944l-3.72736 106.43456c-.57344 16.384-15.4624 32.256-33.8944 31.60064-16.384-.57344-32.23552-15.4624-31.60064-33.8944l3.72736-106.43456c2.74432-20.3776 15.4624-32.23552 33.87392-31.60064zm493.89568 527.52384c-.57344 16.384-13.35296 30.26944-33.8944 31.60064l-104.36608-3.64544c-16.384-.57344-32.19456-17.53088-31.62112-33.8944.57344-16.384 15.48288-32.256 33.8944-31.60064l104.38656 3.64544a32.3584 32.3584.0 0131.60064 33.8944zm-855.53152-29.9008c-.57344 16.384-13.35296 30.28992-33.8944 31.62112l-104.38656-3.64544c-16.384-.57344-32.17408-17.5104-31.60064-33.8944.57344-16.384 15.4624-32.256 33.8944-31.60064l104.38656 3.64544a32.3584 32.3584.0 0131.60064 33.8944zm325.91872 525.76256c-16.384-.57344-32.256-15.48288-31.62112-33.8944l3.72736-106.43456c.57344-16.384 15.4624-32.256 33.8944-31.60064 16.384.57344 32.23552 15.4624 31.60064 33.8944l-3.72736 106.43456c-2.74432 20.3776-17.5104 32.1536-33.87392 31.60064zm401.32608-871.26016c11.85792 12.6976 11.0592 35.2256-1.6384 47.06304l-78.37696 73.09312c-12.6976 11.85792-33.1776 11.14112-47.08352-1.6384-11.83744-12.6976-11.0592-35.2256 1.6384-47.08352l78.39744-73.09312c16.85504-13.74208 35.2256-11.0592 47.06304 1.6384zm-15.50336 737.1776c-12.6976 11.85792-31.1296 11.22304-47.06304-1.6384l-70.9632-80.34304c-11.85792-12.6976-11.0592-35.2256 1.6384-47.08352s35.2256-11.0592 47.08352 1.6384l73.07264 78.37696c9.728 14.68416 8.94976 37.21216-3.76832 49.0496zm-596.31616-645.8368c-12.6976 11.85792-31.1296 11.20256-47.06304-1.6384l-73.09312-78.37696c-11.85792-12.6976-11.0592-35.2256 1.6384-47.08352s35.2256-11.0592 47.08352 1.6384l73.09312 78.37696c11.776 14.7456 11.0592 35.2256-1.6384 47.08352zm-138.24 614.05184c-11.85792-12.71808-11.0592-35.2256 1.6384-47.08352l78.37696-73.09312c12.6976-11.83744 33.1776-11.12064 47.08352 1.6384 11.83744 12.71808 11.0592 35.2256-1.6384 47.104l-78.39744 73.07264c-16.7936 11.71456-35.2256 11.0592-47.06304-1.6384z" fill="#ffb948"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="128" height="128"><path d="M578.256332 591.814252v-82.970701m0 95.54202a12.655127 12.655127.0 01-12.571318-12.571319v-82.970701a12.571318 12.571318.0 1125.142636.0v82.970701a12.571318 12.571318.0 01-12.571318 12.571319z" fill="#f89b1b"/><path d="M598.873294 479.342858a36.959676 36.959676.0 01-27.573092-61.59946 52.380493 52.380493.0 1062.521357 36.540632 36.875867 36.875867.0 01-34.948265 25.058828zm204.0744-109.035234v-82.970701m0 95.542019a12.571318 12.571318.0 01-12.571318-12.571318v-82.970701a12.571318 12.571318.0 1125.142636.0v82.970701a12.571318 12.571318.0 01-12.571318 12.571318z" fill="#f89b1b"/><path d="M823.9837 257.83623a36.959676 36.959676.0 01-27.6569-61.515651 52.129067 52.129067.0 1064.616576 50.285273 53.050963 53.050963.0 00-2.011411-14.163685A36.875867 36.875867.0 01823.9837 257.83623z" fill="#f89b1b"/><path d="M803.282929 328.822274a59.588049 59.588049.0 0159.588049 59.588048V785.66398H743.694881V388.410322a59.588049 59.588049.0 0159.588048-59.588048zM581.776301 551.16699a143.145411 143.145411.0 01143.145411 143.145411V837.54162H438.463272V694.312401A143.145411 143.145411.0 01581.776301 551.16699z" fill="#612273"/><path d="M600.968514 198.667225l-49.111951-4.693292a8.380879 8.380879.0 01-7.039938-5.196145l-17.599845-42.658674a8.380879 8.380879.0 00-15.672244.0l-17.432228 42.658674a8.380879 8.380879.0 01-7.039938 5.196145l-49.11195 4.693292a8.380879 8.380879.0 00-4.777101 14.750347l36.959676 32.51781a8.380879 8.380879.0 012.681881 8.380878l-11.06276 45.67579a8.380879 8.380879.0 0012.487509 9.302776L515.232123 285.074086a8.380879 8.380879.0 018.380879.0l40.982497 24.136931a8.380879 8.380879.0 0012.571319-9.302776l-10.978952-45.675789a8.380879 8.380879.0 012.681882-8.380879L606.08085 213.417572a8.380879 8.380879.0 00-5.028528-14.750347z" fill="#fed150"/><path d="M470.897274 246.77347l1.927602-8.380879a8.380879 8.380879.0 00-2.681881-8.380879l-35.032074-30.506399a8.380879 8.380879.0 00-1.927602 13.912259l36.959676 32.51781a6.788512 6.788512.0 01.754279.838088zM603.98563 199.589122l-34.948265 30.674016a8.380879 8.380879.0 00-2.681881 8.380879l1.927602 8.380879a6.788512 6.788512.0 01.754279-.838088l37.043485-32.769236a8.380879 8.380879.0 00-2.09522-13.82845zm-28.578797 92.189667a8.380879 8.380879.0 01-10.643716 1.759985l-40.982498-24.053123a8.380879 8.380879.0 00-8.380879.0L474.249625 293.454965a8.380879 8.380879.0 01-10.643716-1.676176l-1.927602 8.380879a8.380879 8.380879.0 0012.487509 9.302775l41.066307-24.388357a8.380879 8.380879.0 018.380879.0l40.982497 24.136931a8.380879 8.380879.0 0012.571319-9.302776z" fill="#fed150" opacity=".5"/><path d="M434.608068 426.543321l-28.159753-2.681881a4.86091 4.86091.0 01-4.022822-3.017117l-10.057054-24.388357a4.86091 4.86091.0 00-8.967541.0l-9.973245 24.388357a4.693292 4.693292.0 01-4.022822 3.017117l-28.159753 2.681881a4.86091 4.86091.0 00-2.76569 8.380879l21.203623 18.605551a4.944719 4.944719.0 011.592367 4.777101L354.654484 484.455194a4.86091 4.86091.0 007.123747 5.363762l23.466461-13.82845a5.196145 5.196145.0 014.944718.0l23.466461 13.82845a4.86091 4.86091.0 007.123747-5.363762l-6.285659-26.064533a4.86091 4.86091.0 011.508558-4.777101l21.203624-18.605551a4.86091 4.86091.0 00-2.849499-8.380879z" fill="#fed150"/><path d="M360.102055 454.032604l1.173323-4.609484a4.944719 4.944719.0 00-1.592367-5.112336l-20.0303-17.683654a4.944719 4.944719.0 00-1.173323 8.380879l21.203623 18.605551zm76.182189-26.98643-20.0303 17.26461a4.86091 4.86091.0 00-1.508559 4.777101l1.173323 4.693292v-.502852l21.203624-18.605551a4.86091 4.86091.0 00-.838088-7.6266zM419.94153 479.845711a4.777101 4.777101.0 01-6.034233 1.005705l-23.46646-13.82845a5.196145 5.196145.0 00-4.944719.0l-23.466461 13.82845a4.777101 4.777101.0 01-6.034233-1.005705l-1.089514 4.609483a4.86091 4.86091.0 007.123747 5.363762l23.466461-13.82845a5.196145 5.196145.0 014.944719.0l23.46646 13.82845a4.86091 4.86091.0 007.123747-5.363762z" fill="#fed150" opacity=".5"/><path d="M635.413926 803.68287A414.685886 414.685886.0 01459.41547 18.729756 9.805628 9.805628.0 00453.967898.124205a513.831683 513.831683.0 10567.050264 607.027056 9.805628 9.805628.0 00-18.186507-6.704704A414.350651 414.350651.0 01635.413926 803.68287z" fill="#fed150" p-id="22313"/><path d="M50.931434 292.868303a460.110249 460.110249.0 00275.311871 359.455895 413.847798 413.847798.0 01133.339782-633.594442A9.805628 9.805628.0 00453.967898.124205 513.915492 513.915492.0 0050.931434 292.868303z" fill="#fed150" opacity=".4" p-id="22314"/><path d="M1006.016389 597.261823A513.664065 513.664065.0 013.914704 475.320036c-.670471 10.308481-1.257132 20.616962-1.257132 31.093061a513.831683 513.831683.0 001018.36059 100.570546 9.805628 9.805628.0 00-15.001773-9.72182zM231.539373 332.258434c0 7.458982.67047 14.917964 1.257132 22.293138A414.769695 414.769695.0 01459.583087 18.729756 9.805628 9.805628.0 00453.967898.124205a505.869848 505.869848.0 00-94.620122 20.868388A413.177328 413.177328.0 00231.539373 332.258434z" fill="#fed150" opacity=".5" p-id="22315"/><path d="M715.032275 421.514794m17.683654.0h141.217809q17.683654.0 17.683655 17.683654v-.083809q0 17.683654-17.683655 17.683655H732.715929q-17.683654.0-17.683654-17.683655v.083809q0-17.683654 17.683654-17.683654z" fill="#eb3d72" p-id="22316"/><path d="M205.139605 319.603307c4.441866-6.872321 22.041711-45.340555-11.817039-67.047031s-51.626214 8.380879-51.626214 8.380879a25.142637 25.142637.0 1042.742482 27.489282s2.179029 5.950424-6.537085 18.437934-25.142637 12.236083-43.077718.754279-47.01673-65.789899-.67047-138.787354c1.592367-2.514264 3.352352-4.693292 5.028527-7.039938a26.818812 26.818812.0 00-23.047417-2.430455 33.523515 33.523515.0 00-18.689359 17.683654c-31.260678 64.36515-22.628373 127.724594 21.203623 155.884347 48.944333 31.093061 82.048804-6.453277 86.49067-13.325597zM734.224488 931.491272c6.453277-2.681881 37.713955-21.45505 24.304548-53.386198s-40.647262-19.35983-40.647262-19.35983a21.874094 21.874094.0 1016.761757 40.312027s-1.340941 5.363762-13.577023 9.973246S697.264812 905.259122 689.889638 888.497364s-1.340941-69.561295 67.047031-98.894371c2.346646-1.005705 4.693292-1.676176 7.039938-2.514263a31.931148 31.931148.0 00-1.927602-3.352352 28.578797 28.578797.0 00-38.635851-7.542791c-51.87764 30.841634-74.422204 81.545951-57.325212 122.277023 19.778874 46.262451 61.59946 35.786353 68.136546 33.020662zM279.813236 802.844782c-5.950424-3.687587-39.390131-18.354125-57.660447 11.146569s7.794217 44.334849 7.794217 44.334849a21.874094 21.874094.0 1023.047417-36.875867s5.112336-2.011411 16.007479 5.279954 10.811334 21.622667 1.173323 37.211102-55.984271 41.317733-119.511333 2.430455c-2.179029-1.340941-4.106631-2.849499-6.118041-4.274249a22.376947 22.376947.0 00-1.676176 3.51997 28.662606 28.662606.0 0016.342714 36.037779c55.146183 24.388357 109.538087 13.409406 132.920739-24.136931 26.399768-42.9101-6.369468-70.902235-12.319892-74.673631zM431.00429 694.312401h302.298301m0 20.952197H431.00429a20.952197 20.952197.0 010-41.904394h302.298301a20.952197 20.952197.0 010 41.904394z" fill="#eb3d72" p-id="22317"/><path d="M255.760113 683.082023m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".4" p-id="22318"/><path d="M356.246851 840.977781m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".4" p-id="22319"/><path d="M54.870447 472.135302m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".4" p-id="22320"/><path d="M561.410765 873.914635m-30.171164.0a30.171164 30.171164.0 1060.342328.0 30.171164 30.171164.0 10-60.342328.0z" fill="#fed150" opacity=".5" p-id="22321"/><path d="M445.167976 825.13792m-19.862683.0a19.862683 19.862683.0 1039.725365.0 19.862683 19.862683.0 10-39.725365.0z" fill="#fed150" opacity=".5" p-id="22322"/><path d="M149.406761 689.786726m-19.862683.0a19.862683 19.862683.0 1039.725365.0 19.862683 19.862683.0 10-39.725365.0z" fill="#fed150" opacity=".5" p-id="22323"/><path d="M132.225959 633.299603m-18.940786.0a18.940786 18.940786.0 1037.881572.0 18.940786 18.940786.0 10-37.881572.0z" fill="#fed150" opacity=".4" p-id="22324"/><path d="M475.339139 906.935297m-18.940786.0a18.940786 18.940786.0 1037.881573.0 18.940786 18.940786.0 10-37.881573.0z" fill="#fed150" opacity=".4" p-id="22325"/></svg>
<span>ä¸»é¢˜</span></li></ol></li></ol></aside><main class="main full-width"><div class=breadcrumb><li><a href=/>é¦–é¡µ</a></li><li><a href=/articles/>æˆ‘çš„å‘å¸ƒ</a></li><li class=active><a href=/articles/java/juc/juc/>JUC</a></li></div><article class=main-article><header class="article-header not-page"><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352z"/></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"/><use href="#gentle-wave" x="48" y="3"/><use href="#gentle-wave" x="48" y="5"/><use href="#gentle-wave" x="48" y="7"/></g></svg></section><style>.main-hero-waves-area{--icat-post-waveone:rgba(17, 17, 17, 0.78);--icat-post-wavetwo:rgba(17, 17, 17, 0.51);--icat-post-wavethree:rgba(17, 17, 17, 0.212);--icat-post-wavefour:rgb(17, 17, 17);opacity:1; [data-scheme="light"] & { --icat-post-waveone: rgba(255, 255, 255, 0.741); --icat-post-wavetwo: rgba(255, 255, 255, 0.51); --icat-post-wavethree: rgba(255, 255, 255, 0.212); --icat-post-wavefour: #fff; }}.waves-area{width:100%;position:absolute;left:0;bottom:0;z-index:5}.waves-area .waves-svg{width:100%;height:8rem}@media screen and (max-width:768px){.waves-area .waves-svg{height:40px;min-height:40px}}.waves-area .waves-svg .parallax>use{-webkit-animation:move-forever 25s cubic-bezier(.55,.5,.45,.5)infinite;-moz-animation:move-forever 25s cubic-bezier(.55,.5,.45,.5)infinite;-o-animation:move-forever 25s cubic-bezier(.55,.5,.45,.5)infinite;-ms-animation:move-forever 25s cubic-bezier(.55,.5,.45,.5)infinite;animation:move-forever 25s cubic-bezier(.55,.5,.45,.5)infinite}.waves-area .waves-svg .parallax>use:nth-child(1){-webkit-animation-delay:-2s;-moz-animation-delay:-2s;-o-animation-delay:-2s;-ms-animation-delay:-2s;animation-delay:-2s;-webkit-animation-duration:7s;-moz-animation-duration:7s;-o-animation-duration:7s;-ms-animation-duration:7s;animation-duration:7s;fill:var(--icat-post-waveone)}.waves-area .waves-svg .parallax>use:nth-child(2){-webkit-animation-delay:-3s;-moz-animation-delay:-3s;-o-animation-delay:-3s;-ms-animation-delay:-3s;animation-delay:-3s;-webkit-animation-duration:10s;-moz-animation-duration:10s;-o-animation-duration:10s;-ms-animation-duration:10s;animation-duration:10s;fill:var(--icat-post-wavetwo)}.waves-area .waves-svg .parallax>use:nth-child(3){-webkit-animation-delay:-4s;-moz-animation-delay:-4s;-o-animation-delay:-4s;-ms-animation-delay:-4s;animation-delay:-4s;-webkit-animation-duration:13s;-moz-animation-duration:13s;-o-animation-duration:13s;-ms-animation-duration:13s;animation-duration:13s;fill:var(--icat-post-wavethree)}.waves-area .waves-svg .parallax>use:nth-child(4){-webkit-animation-delay:-5s;-moz-animation-delay:-5s;-o-animation-delay:-5s;-ms-animation-delay:-5s;animation-delay:-5s;-webkit-animation-duration:20s;-moz-animation-duration:20s;-o-animation-duration:20s;-ms-animation-duration:20s;animation-duration:20s;fill:var(--icat-post-wavefour)}@keyframes move-forever{0%{transform:translate3d(-90px,0,0)}100%{transform:translate3d(85px,0,0)}}</style><div class=article-details><header class=article-category><a href=/categories/java/>Java</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/articles/java/juc/juc/>JUC</a></h2><h3 class=article-subtitle>javaå¤šçº¿ç¨‹,JUC,çº¿ç¨‹å®‰å…¨</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024å¹´3æœˆ3æ—¥</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 199 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><p>1.å‡†å¤‡</p><p>pom.xml ä¾èµ–å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;properties&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class=nt>&lt;/project.build.sourceEncoding&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;maven.compiler.source&gt;</span>1.8<span class=nt>&lt;/maven.compiler.source&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;maven.compiler.target&gt;</span>1.8<span class=nt>&lt;/maven.compiler.target&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/properties&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;dependencies&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>junit<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>junit<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;version&gt;</span>4.11<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;scope&gt;</span>test<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>org.projectlombok<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>lombok<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;version&gt;</span>1.18.22<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;scope&gt;</span>provided<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>slf4j-api<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;version&gt;</span>1.7.22<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>ch.qos.logback<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>logback-classic<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;version&gt;</span>1.2.3<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;groupId&gt;</span>org.junit.jupiter<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;artifactId&gt;</span>junit-jupiter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;version&gt;</span>RELEASE<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;scope&gt;</span>compile<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>logback.xml é…ç½®å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;configuration</span> <span class=na>scan=</span><span class=s>&#34;true&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;appender</span> <span class=na>name=</span><span class=s>&#34;STDOUT&#34;</span> <span class=na>class=</span><span class=s>&#34;ch.qos.logback.core.ConsoleAppender&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;encoder&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;pattern&gt;</span>%date{HH:mm:ss} [%t] %logger - %m%n<span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/encoder&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/appender&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;logger</span> <span class=na>name=</span><span class=s>&#34;c&#34;</span> <span class=na>level=</span><span class=s>&#34;debug&#34;</span> <span class=na>additivity=</span><span class=s>&#34;false&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;appender-ref</span> <span class=na>ref=</span><span class=s>&#34;STDOUT&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/logger&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;root</span> <span class=na>level=</span><span class=s>&#34;ERROR&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;appender-ref</span> <span class=na>ref=</span><span class=s>&#34;STDOUT&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/root&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=2è¿›ç¨‹ä¸çº¿ç¨‹><a href=#2%e8%bf%9b%e7%a8%8b%e4%b8%8e%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
2.è¿›ç¨‹ä¸çº¿ç¨‹</h1><h2 id=21-è¿›ç¨‹ä¸çº¿ç¨‹><a href=#21-%e8%bf%9b%e7%a8%8b%e4%b8%8e%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
2.1 è¿›ç¨‹ä¸çº¿ç¨‹</h2><h3 id=è¿›ç¨‹><a href=#%e8%bf%9b%e7%a8%8b class=header-anchor>#</a>
è¿›ç¨‹</h3><ul><li>ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½è‡³ CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨ æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ã€ç®¡ç†å†…å­˜ã€ç®¡ç† IO çš„ ã€‚</li><li>å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ã€‚</li><li>è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚è®°äº‹æœ¬ã€ç”»å›¾ã€æµè§ˆå™¨ ç­‰ï¼‰ï¼Œä¹Ÿæœ‰çš„ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚ç½‘æ˜“äº‘éŸ³ä¹ã€360 å®‰å…¨å«å£«ç­‰ï¼‰</li></ul><h3 id=çº¿ç¨‹><a href=#%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
çº¿ç¨‹</h3><ul><li><p>ä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸ºä¸€åˆ°å¤šä¸ªçº¿ç¨‹ã€‚</p></li><li><p>ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™ CPU æ‰§è¡Œ</p></li><li><p>Java ä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚ åœ¨ windows ä¸­è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œ ä¸ºçº¿ç¨‹çš„å®¹å™¨</p></li></ul><h3 id=äºŒè€…å¯¹æ¯”><a href=#%e4%ba%8c%e8%80%85%e5%af%b9%e6%af%94 class=header-anchor>#</a>
äºŒè€…å¯¹æ¯”</h3><ul><li><p>è¿›ç¨‹åŸºæœ¬ä¸Šç›¸äº’ç‹¬ç«‹çš„ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†</p></li><li><p>è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä¾›å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº«</p></li><li><p>è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚</p><ul><li>åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸º IPCï¼ˆInter-process communicationï¼‰</li><li>ä¸åŒè®¡ç®—æœºä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå®ˆå…±åŒçš„åè®®ï¼Œä¾‹å¦‚ HTTP</li></ul></li><li><p>çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºå®ƒä»¬å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ï¼Œä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡</p></li><li><p>çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬ä¸Šè¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½</p></li></ul><h2 id=22-å¹¶è¡Œä¸å¹¶å‘><a href=#22-%e5%b9%b6%e8%a1%8c%e4%b8%8e%e5%b9%b6%e5%8f%91 class=header-anchor>#</a>
2.2 å¹¶è¡Œä¸å¹¶å‘</h2><p>å•æ ¸cpuä¸‹ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯<strong>ä¸²è¡Œæ‰§è¡Œ</strong>çš„ã€‚æ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åšä»»åŠ¡è°ƒåº¦å™¨ï¼Œå°† cpu çš„æ—¶é—´ç‰‡ï¼ˆwindows ä¸‹æ—¶é—´ç‰‡æœ€å°çº¦ä¸º 15 æ¯«ç§’ï¼‰åˆ†ç»™ä¸åŒçš„ç¨‹åºä½¿ç”¨ï¼Œåªæ˜¯ç”±äº cpu åœ¨çº¿ç¨‹é—´ï¼ˆæ—¶é—´ç‰‡å¾ˆçŸ­ï¼‰çš„åˆ‡æ¢éå¸¸å¿«ï¼Œäººç±»æ„Ÿè§‰æ˜¯åŒæ—¶è¿è¡Œçš„ ã€‚æ€»ç»“ä¸ºä¸€å¥è¯å°±æ˜¯ï¼š <strong>å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œ</strong> ã€‚</p><p>ä¸€èˆ¬ä¼šå°†è¿™ç§çº¿ç¨‹è½®æµä½¿ç”¨ CPU çš„åšæ³•ç§°ä¸ºå¹¶å‘ï¼Œ concurrent</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>CPU</th><th style=text-align:center>æ—¶é—´ç‰‡ 1</th><th style=text-align:center>æ—¶é—´ç‰‡ 2</th><th style=text-align:center>æ—¶é—´ç‰‡ 3</th><th style=text-align:center>æ—¶é—´ç‰‡ 4</th></tr></thead><tbody><tr><td style=text-align:center>core</td><td style=text-align:center>çº¿ç¨‹ 1</td><td style=text-align:center>çº¿ç¨‹ 2</td><td style=text-align:center>çº¿ç¨‹ 3</td><td style=text-align:center>çº¿ç¨‹ 4</td></tr></tbody></table></div><p>å¤šæ ¸ cpuä¸‹ï¼Œæ¯ä¸ª æ ¸ï¼ˆcoreï¼‰ éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹å¯ä»¥æ˜¯å¹¶è¡Œçš„ã€‚</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>CPU</th><th style=text-align:center>æ—¶é—´ç‰‡ 1</th><th style=text-align:center>æ—¶é—´ç‰‡ 2</th><th style=text-align:center>æ—¶é—´ç‰‡ 3</th><th style=text-align:center>æ—¶é—´ç‰‡ 4</th></tr></thead><tbody><tr><td style=text-align:center>core1</td><td style=text-align:center>çº¿ç¨‹ 1</td><td style=text-align:center>çº¿ç¨‹ 2</td><td style=text-align:center>çº¿ç¨‹ 3</td><td style=text-align:center>çº¿ç¨‹ 4</td></tr><tr><td style=text-align:center>core2</td><td style=text-align:center>çº¿ç¨‹ 4</td><td style=text-align:center>çº¿ç¨‹ 4</td><td style=text-align:center>çº¿ç¨‹ 2</td><td style=text-align:center>çº¿ç¨‹ 2</td></tr></tbody></table></div><p>å¼•ç”¨ Rob Pike çš„ä¸€æ®µæè¿°ï¼š</p><p>â€‹ å¹¶å‘ï¼ˆconcurrentï¼‰æ˜¯åŒä¸€æ—¶é—´åº”å¯¹ï¼ˆdealing withï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ› ã€‚</p><p>â€‹ å¹¶è¡Œï¼ˆparallelï¼‰æ˜¯åŒä¸€æ—¶é—´åŠ¨æ‰‹åšï¼ˆdoingï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›ã€‚</p><h2 id=23-åº”ç”¨><a href=#23-%e5%ba%94%e7%94%a8 class=header-anchor>#</a>
2.3 åº”ç”¨</h2><h3 id=textcolorgreenåº”ç”¨ä¹‹å¼‚æ­¥è°ƒç”¨æ¡ˆä¾‹1-><a href=#textcolorgreen%e5%ba%94%e7%94%a8%e4%b9%8b%e5%bc%82%e6%ad%a5%e8%b0%83%e7%94%a8%e6%a1%88%e4%be%8b1- class=header-anchor>#</a>
$\textcolor{Green}{*åº”ç”¨ä¹‹å¼‚æ­¥è°ƒç”¨ï¼ˆæ¡ˆä¾‹1ï¼‰} $</h3><h4 id=éœ€è¦ç­‰å¾…ç»“æœ><a href=#%e9%9c%80%e8%a6%81%e7%ad%89%e5%be%85%e7%bb%93%e6%9e%9c class=header-anchor>#</a>
éœ€è¦ç­‰å¾…ç»“æœ</h4><p>è¿™æ—¶æ—¢å¯ä»¥ä½¿ç”¨åŒæ­¥å¤„ç†ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¼‚æ­¥æ¥å¤„ç†</p><p>join å®ç°ï¼ˆåŒæ­¥ï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æœä¸º:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:30:40.453 <span class=o>[</span>main<span class=o>]</span> c.TestJoin - å¼€å§‹
</span></span><span class=line><span class=cl>20:30:40.541 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestJoin - å¼€å§‹
</span></span><span class=line><span class=cl>20:30:41.543 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestJoin - ç»“æŸ
</span></span><span class=line><span class=cl>20:30:41.551 <span class=o>[</span>main<span class=o>]</span> c.TestJoin - ç»“æœä¸º:10
</span></span></code></pre></td></tr></table></div></div><p>è¯„ä»·</p><ul><li>éœ€è¦å¤–éƒ¨å…±äº«å˜é‡ï¼Œä¸ç¬¦åˆé¢å‘å¯¹è±¡å°è£…çš„æ€æƒ³</li><li>å¿…é¡»ç­‰å¾…çº¿ç¨‹ç»“æŸï¼Œä¸èƒ½é…åˆçº¿ç¨‹æ± ä½¿ç”¨</li></ul><h5 id=future-å®ç°åŒæ­¥><a href=#future-%e5%ae%9e%e7%8e%b0%e5%90%8c%e6%ad%a5 class=header-anchor>#</a>
Future å®ç°ï¼ˆåŒæ­¥ï¼‰</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FutureTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FutureTask</span><span class=o>&lt;&gt;</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æœä¸º:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2>2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3>3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>10:11:57.880 c.TestSync <span class=o>[</span>main<span class=o>]</span> - å¼€å§‹
</span></span><span class=line><span class=cl>10:11:57.942 c.TestSync <span class=o>[</span>t1<span class=o>]</span> - å¼€å§‹
</span></span><span class=line><span class=cl>10:11:58.943 c.TestSync <span class=o>[</span>t1<span class=o>]</span> - ç»“æŸ
</span></span><span class=line><span class=cl>10:11:58.943 c.TestSync <span class=o>[</span>main<span class=o>]</span> - ç»“æœä¸º:10
</span></span></code></pre></td></tr></table></div></div><p>è¯„ä»·</p><ul><li>è§„é¿äº†ä½¿ç”¨ join ä¹‹å‰çš„ç¼ºç‚¹</li><li>å¯ä»¥æ–¹ä¾¿é…åˆçº¿ç¨‹æ± ä½¿ç”¨</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æœä¸º:{}, result çš„ç±»å‹:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(),</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>10:17:40.090 c.TestSync <span class=o>[</span>main<span class=o>]</span> - å¼€å§‹
</span></span><span class=line><span class=cl>10:17:40.150 c.TestSync <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - å¼€å§‹
</span></span><span class=line><span class=cl>10:17:41.151 c.TestSync <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - ç»“æŸ
</span></span><span class=line><span class=cl>10:17:41.151 c.TestSync <span class=o>[</span>main<span class=o>]</span> - ç»“æœä¸º:10, result çš„ç±»å‹:class java.util.concurrent.FutureTask
</span></span></code></pre></td></tr></table></div></div><p>è¯„ä»·</p><ul><li>ä»ç„¶æ˜¯ main çº¿ç¨‹æ¥æ”¶ç»“æœ</li><li>get æ–¹æ³•æ˜¯è®©è°ƒç”¨çº¿ç¨‹åŒæ­¥ç­‰å¾…</li></ul><h5 id=è‡ªå®šä¹‰å®ç°åŒæ­¥><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%ae%9e%e7%8e%b0%e5%90%8c%e6%ad%a5 class=header-anchor>#</a>
è‡ªå®šä¹‰å®ç°ï¼ˆåŒæ­¥ï¼‰</h5><p>è§æ¨¡å¼ç¯‡ï¼šä¿æŠ¤æ€§æš‚åœæ¨¡å¼</p><h5 id=completablefuture-å®ç°å¼‚æ­¥><a href=#completablefuture-%e5%ae%9e%e7%8e%b0%e5%bc%82%e6%ad%a5 class=header-anchor>#</a>
CompletableFuture å®ç°ï¼ˆå¼‚æ­¥ï¼‰</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test4</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿›è¡Œè®¡ç®—çš„çº¿ç¨‹æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>computeService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ¥æ”¶ç»“æœçš„çº¿ç¨‹æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>resultService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CompletableFuture</span><span class=p>.</span><span class=na>supplyAsync</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=n>computeService</span><span class=p>).</span><span class=na>thenAcceptAsync</span><span class=p>((</span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æœä¸º:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=n>resultService</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2>2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3>3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>10:36:28.114 c.TestSync <span class=o>[</span>main<span class=o>]</span> - å¼€å§‹
</span></span><span class=line><span class=cl>10:36:28.164 c.TestSync <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - å¼€å§‹
</span></span><span class=line><span class=cl>10:36:29.165 c.TestSync <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - ç»“æŸ
</span></span><span class=line><span class=cl>10:36:29.165 c.TestSync <span class=o>[</span>pool-2-thread-1<span class=o>]</span> - ç»“æœä¸º:10
</span></span></code></pre></td></tr></table></div></div><p>è¯„ä»·</p><ul><li>å¯ä»¥è®©è°ƒç”¨çº¿ç¨‹å¼‚æ­¥å¤„ç†ç»“æœï¼Œå®é™…æ˜¯å…¶ä»–çº¿ç¨‹å»åŒæ­¥ç­‰å¾…</li><li>å¯ä»¥æ–¹ä¾¿åœ°åˆ†ç¦»ä¸åŒèŒè´£çš„çº¿ç¨‹æ± </li><li>ä»¥ä»»åŠ¡ä¸ºä¸­å¿ƒï¼Œè€Œä¸æ˜¯ä»¥çº¿ç¨‹ä¸ºä¸­å¿ƒ</li></ul><h5 id=blockingqueue-å®ç°å¼‚æ­¥><a href=#blockingqueue-%e5%ae%9e%e7%8e%b0%e5%bc%82%e6%ad%a5 class=header-anchor>#</a>
BlockingQueue å®ç°ï¼ˆå¼‚æ­¥ï¼‰</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14>14</a>
</span><span class=lnt id=hl-10-15><a class=lnlinks href=#hl-10-15>15</a>
</span><span class=lnt id=hl-10-16><a class=lnlinks href=#hl-10-16>16</a>
</span><span class=lnt id=hl-10-17><a class=lnlinks href=#hl-10-17>17</a>
</span><span class=lnt id=hl-10-18><a class=lnlinks href=#hl-10-18>18</a>
</span><span class=lnt id=hl-10-19><a class=lnlinks href=#hl-10-19>19</a>
</span><span class=lnt id=hl-10-20><a class=lnlinks href=#hl-10-20>20</a>
</span><span class=lnt id=hl-10-21><a class=lnlinks href=#hl-10-21>21</a>
</span><span class=lnt id=hl-10-22><a class=lnlinks href=#hl-10-22>22</a>
</span><span class=lnt id=hl-10-23><a class=lnlinks href=#hl-10-23>23</a>
</span><span class=lnt id=hl-10-24><a class=lnlinks href=#hl-10-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test6</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>consumer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>producer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SynchronousQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>producer</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>consumer</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Integer</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æœä¸º:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=ä¸éœ€ç­‰å¾…ç»“æœ><a href=#%e4%b8%8d%e9%9c%80%e7%ad%89%e5%be%85%e7%bb%93%e6%9e%9c class=header-anchor>#</a>
ä¸éœ€ç­‰å¾…ç»“æœ</h4><p>è¿™æ—¶æœ€å¥½æ˜¯ä½¿ç”¨å¼‚æ­¥æ¥å¤„ç†</p><h5 id=æ™®é€šçº¿ç¨‹å®ç°><a href=#%e6%99%ae%e9%80%9a%e7%ba%bf%e7%a8%8b%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
æ™®é€šçº¿ç¨‹å®ç°</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span><span class=lnt id=hl-11-13><a class=lnlinks href=#hl-11-13>13</a>
</span><span class=lnt id=hl-11-14><a class=lnlinks href=#hl-11-14>14</a>
</span><span class=lnt id=hl-11-15><a class=lnlinks href=#hl-11-15>15</a>
</span><span class=lnt id=hl-11-16><a class=lnlinks href=#hl-11-16>16</a>
</span><span class=lnt id=hl-11-17><a class=lnlinks href=#hl-11-17>17</a>
</span><span class=lnt id=hl-11-18><a class=lnlinks href=#hl-11-18>18</a>
</span><span class=lnt id=hl-11-19><a class=lnlinks href=#hl-11-19>19</a>
</span><span class=lnt id=hl-11-20><a class=lnlinks href=#hl-11-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.FileReader&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FileReader</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>read</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>filename</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>filename</span><span class=p>.</span><span class=na>lastIndexOf</span><span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>separator</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>shortName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>filename</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>idx</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>FileInputStream</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=n>filename</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read [{}] start ...&#34;</span><span class=p>,</span><span class=w> </span><span class=n>shortName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>1024</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read [{}] end ... cost: {} ms&#34;</span><span class=p>,</span><span class=w> </span><span class=n>shortName</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ²¡æœ‰ç”¨çº¿ç¨‹æ—¶ï¼Œæ–¹æ³•çš„è°ƒç”¨æ˜¯åŒæ­¥çš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5>5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6>6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7>7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Sync&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>fullPath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;E:\\1.mp4&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FileReader</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>fullPath</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;do other things ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:39:15 <span class=o>[</span>main<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ...
</span></span><span class=line><span class=cl>18:39:19 <span class=o>[</span>main<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>4090</span> ms
</span></span><span class=line><span class=cl>18:39:19 <span class=o>[</span>main<span class=o>]</span> c.Sync - <span class=k>do</span> other things ...
</span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨äº†çº¿ç¨‹åï¼Œæ–¹æ³•çš„è°ƒç”¨æ—¶å¼‚æ­¥çš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1>1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2>2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3>3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>FileReader</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>MP4_FULL_PATH</span><span class=p>)).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;do other things ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1>1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2>2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:41:53 <span class=o>[</span>main<span class=o>]</span> c.Async - <span class=k>do</span> other things ...
</span></span><span class=line><span class=cl>18:41:53 <span class=o>[</span>Thread-0<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ...
</span></span><span class=line><span class=cl>18:41:57 <span class=o>[</span>Thread-0<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>4197</span> ms
</span></span></code></pre></td></tr></table></div></div><h5 id=çº¿ç¨‹æ± å®ç°><a href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
çº¿ç¨‹æ± å®ç°</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1>1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2>2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3>3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4>4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5>5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>execute</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>FileReader</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>MP4_FULL_PATH</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;do other things ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1>1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2>2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:03:31.245 c.TestAsyc <span class=o>[</span>main<span class=o>]</span> - <span class=k>do</span> other things ... 
</span></span><span class=line><span class=cl>11:03:31.245 c.FileReader <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ... 
</span></span><span class=line><span class=cl>11:03:33.479 c.FileReader <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>2235</span> ms
</span></span></code></pre></td></tr></table></div></div><h5 id=completablefuture-å®ç°><a href=#completablefuture-%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
CompletableFuture å®ç°</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1>1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2>2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3>3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4>4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CompletableFuture</span><span class=p>.</span><span class=na>runAsync</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>FileReader</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>MP4_FULL_PATH</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;do other things ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>in</span><span class=p>.</span><span class=na>read</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1>1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2>2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:09:38.145 c.TestAsyc <span class=o>[</span>main<span class=o>]</span> - <span class=k>do</span> other things ... 
</span></span><span class=line><span class=cl>11:09:38.145 c.FileReader <span class=o>[</span>ForkJoinPool.commonPool-worker-1<span class=o>]</span> - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ... 
</span></span><span class=line><span class=cl>11:09:40.514 c.FileReader <span class=o>[</span>ForkJoinPool.commonPool-worker-1<span class=o>]</span> - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>2369</span> ms 
</span></span></code></pre></td></tr></table></div></div><p>ä»¥è°ƒç”¨æ–¹è§’åº¦æ¥è®²ï¼Œ</p><ul><li>å¦‚æœ éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥</li><li>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</li></ul><p><strong>1.è®¾è®¡</strong></p><p>å¤šçº¿ç¨‹å¯ä»¥è®©æ–¹æ³•æ‰§è¡Œå˜ä¸ºå¼‚æ­¥çš„ï¼ˆå³ä¸è¦å·´å·´å¹²ç­‰ç€ï¼‰ã€æ¯”å¦‚è¯´è¯»å–ç£ç›˜æ–‡ä»¶æ—¶ï¼Œå‡è®¾è¯»å–æ“ä½œèŠ±è´¹äº† 5 ç§’é’Ÿï¼Œå¦‚æœæ²¡æœ‰çº¿ç¨‹è°ƒåº¦æœºåˆ¶ï¼Œè¿™ 5 ç§’ cpu ä»€ä¹ˆéƒ½åšä¸äº†ï¼Œå…¶å®ƒä»£ç éƒ½å¾—æš‚åœ&mldr;</p><p><strong>2.ç»“è®º</strong></p><ul><li>æ¯”å¦‚åœ¨é¡¹ç›®ä¸­ï¼Œè§†é¢‘æ–‡ä»¶éœ€è¦è½¬æ¢æ ¼å¼ç­‰æ“ä½œæ¯”è¾ƒè´¹æ—¶ï¼Œè¿™æ—¶å¼€ä¸€ä¸ªæ–°çº¿ç¨‹å¤„ç†è§†é¢‘è½¬æ¢ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹</li><li>tomcat çš„å¼‚æ­¥ servlet ä¹Ÿæ˜¯ç±»ä¼¼çš„ç›®çš„ï¼Œè®©ç”¨æˆ·çº¿ç¨‹å¤„ç†è€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œé¿å…é˜»å¡ tomcat çš„å·¥ä½œçº¿ç¨‹</li><li>ui ç¨‹åºä¸­ï¼Œå¼€çº¿ç¨‹è¿›è¡Œå…¶ä»–æ“ä½œï¼Œé¿å…é˜»å¡ ui çº¿ç¨‹</li></ul><h3 id=textcolorgreenåº”ç”¨ä¹‹æé«˜æ•ˆç‡æ¡ˆä¾‹1-><a href=#textcolorgreen%e5%ba%94%e7%94%a8%e4%b9%8b%e6%8f%90%e9%ab%98%e6%95%88%e7%8e%87%e6%a1%88%e4%be%8b1- class=header-anchor>#</a>
$\textcolor{Green}{*åº”ç”¨ä¹‹æé«˜æ•ˆç‡ï¼ˆæ¡ˆä¾‹1ï¼‰ }$</h3><p>å……åˆ†åˆ©ç”¨å¤šæ ¸ cpu çš„ä¼˜åŠ¿ï¼Œæé«˜è¿è¡Œæ•ˆç‡ã€‚æƒ³è±¡ä¸‹é¢çš„åœºæ™¯ï¼Œæ‰§è¡Œ 3 ä¸ªè®¡ç®—ï¼Œæœ€åå°†è®¡ç®—ç»“æœæ±‡æ€»ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1>1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2>2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3>3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>è®¡ç®— 1 èŠ±è´¹ 10 ms
</span></span><span class=line><span class=cl>è®¡ç®— 2 èŠ±è´¹ 11 ms
</span></span><span class=line><span class=cl>è®¡ç®— 3 èŠ±è´¹ 9 ms
</span></span><span class=line><span class=cl>æ±‡æ€»éœ€è¦ 1 ms
</span></span></code></pre></td></tr></table></div></div><ul><li><p>å¦‚æœæ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œé‚£ä¹ˆæ€»å…±èŠ±è´¹çš„æ—¶é—´æ˜¯ 10 + 11 + 9 + 1 = 31ms</p></li><li><p>ä½†å¦‚æœæ˜¯å››æ ¸ cpuï¼Œå„ä¸ªæ ¸å¿ƒåˆ†åˆ«ä½¿ç”¨çº¿ç¨‹ 1 æ‰§è¡Œè®¡ç®— 1ï¼Œçº¿ç¨‹ 2 æ‰§è¡Œè®¡ç®— 2ï¼Œçº¿ç¨‹ 3 æ‰§è¡Œè®¡ç®— 3ï¼Œé‚£ä¹ˆ 3 ä¸ª çº¿ç¨‹æ˜¯å¹¶è¡Œçš„ï¼ŒèŠ±è´¹æ—¶é—´åªå–å†³äºæœ€é•¿çš„é‚£ä¸ªçº¿ç¨‹è¿è¡Œçš„æ—¶é—´ï¼Œå³ 11ms æœ€ååŠ ä¸Šæ±‡æ€»æ—¶é—´åªä¼šèŠ±è´¹ 12ms</p></li></ul><blockquote><p><strong>æ³¨æ„ï¼š</strong></p><p>éœ€è¦åœ¨å¤šæ ¸ cpu æ‰èƒ½æé«˜æ•ˆç‡ï¼Œå•æ ¸ä»ç„¶æ—¶æ˜¯è½®æµæ‰§è¡Œ</p></blockquote><h5 id=1è®¾è®¡><a href=#1%e8%ae%be%e8%ae%a1 class=header-anchor>#</a>
1.è®¾è®¡</h5><blockquote><p>ä»£ç è§ã€åº”ç”¨ä¹‹æ•ˆç‡-æ¡ˆä¾‹1ã€‘</p></blockquote><h5 id=2ç»“è®º><a href=#2%e7%bb%93%e8%ae%ba class=header-anchor>#</a>
2.ç»“è®º</h5><ol><li>å•æ ¸ cpu ä¸‹ï¼Œå¤šçº¿ç¨‹ä¸èƒ½å®é™…æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œåªæ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„ä»»åŠ¡ä¹‹é—´åˆ‡æ¢ï¼Œä¸åŒçº¿ç¨‹è½®æµä½¿ç”¨ cpu ï¼Œä¸è‡³äºä¸€ä¸ªçº¿ç¨‹æ€»å ç”¨ cpuï¼Œåˆ«çš„çº¿ç¨‹æ²¡æ³•å¹²æ´»</li><li>å¤šæ ¸ cpu å¯ä»¥å¹¶è¡Œè·‘å¤šä¸ªçº¿ç¨‹ï¼Œä½†èƒ½å¦æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡è¿˜æ˜¯è¦åˆ†æƒ…å†µçš„<ul><li>æœ‰äº›ä»»åŠ¡ï¼Œç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œå°†ä»»åŠ¡æ‹†åˆ†ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå½“ç„¶å¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚ä½†ä¸æ˜¯æ‰€æœ‰è®¡ç®—ä»» åŠ¡éƒ½èƒ½æ‹†åˆ†ï¼ˆå‚è€ƒåæ–‡çš„ã€é˜¿å§†è¾¾å°”å®šå¾‹ã€‘ï¼‰</li><li>ä¹Ÿä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦æ‹†åˆ†ï¼Œä»»åŠ¡çš„ç›®çš„å¦‚æœä¸åŒï¼Œè°ˆæ‹†åˆ†å’Œæ•ˆç‡æ²¡å•¥æ„ä¹‰</li></ul></li><li>IO æ“ä½œä¸å ç”¨ cpuï¼Œåªæ˜¯æˆ‘ä»¬ä¸€èˆ¬æ‹·è´æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ã€é˜»å¡ IOã€‘ï¼Œè¿™æ—¶ç›¸å½“äºçº¿ç¨‹è™½ç„¶ä¸ç”¨ cpuï¼Œä½†éœ€è¦ä¸€ ç›´ç­‰å¾… IO ç»“æŸï¼Œæ²¡èƒ½å……åˆ†åˆ©ç”¨çº¿ç¨‹ã€‚æ‰€ä»¥æ‰æœ‰åé¢çš„ã€éé˜»å¡ IOã€‘å’Œã€å¼‚æ­¥ IOã€‘ä¼˜åŒ–ã€‚</li></ol><h1 id=3java-çº¿ç¨‹><a href=#3java-%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
3.Java çº¿ç¨‹</h1><h2 id=31-åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹><a href=#31-%e5%88%9b%e5%bb%ba%e5%92%8c%e8%bf%90%e8%a1%8c%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
3.1 åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹</h2><h3 id=æ–¹æ³•ä¸€ç›´æ¥ä½¿ç”¨-thread><a href=#%e6%96%b9%e6%b3%95%e4%b8%80%e7%9b%b4%e6%8e%a5%e4%bd%bf%e7%94%a8-thread class=header-anchor>#</a>
æ–¹æ³•ä¸€ï¼Œç›´æ¥ä½¿ç”¨ Thread</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1>1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2>2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3>3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4>4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5>5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6>6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7>7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åˆ›å»ºçº¿ç¨‹å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¦æ‰§è¡Œçš„ä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å¯åŠ¨çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1>1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2>2</a>
</span><span class=lnt id=hl-22-3><a class=lnlinks href=#hl-22-3>3</a>
</span><span class=lnt id=hl-22-4><a class=lnlinks href=#hl-22-4>4</a>
</span><span class=lnt id=hl-22-5><a class=lnlinks href=#hl-22-5>5</a>
</span><span class=lnt id=hl-22-6><a class=lnlinks href=#hl-22-6>6</a>
</span><span class=lnt id=hl-22-7><a class=lnlinks href=#hl-22-7>7</a>
</span><span class=lnt id=hl-22-8><a class=lnlinks href=#hl-22-8>8</a>
</span><span class=lnt id=hl-22-9><a class=lnlinks href=#hl-22-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æ„é€ æ–¹æ³•çš„å‚æ•°æ˜¯ç»™çº¿ç¨‹æŒ‡å®šåå­—ï¼Œæ¨è</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=s>&#34;t1&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// run æ–¹æ³•å†…å®ç°äº†è¦æ‰§è¡Œçš„ä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>19:19:00 [t1] c.ThreadStarter - hello
</span></span></code></pre></td></tr></table></div></div><h3 id=æ–¹æ³•äºŒä½¿ç”¨-runnable-é…åˆ-thread><a href=#%e6%96%b9%e6%b3%95%e4%ba%8c%e4%bd%bf%e7%94%a8-runnable-%e9%85%8d%e5%90%88-thread class=header-anchor>#</a>
æ–¹æ³•äºŒï¼Œä½¿ç”¨ Runnable é…åˆ Thread</h3><p>æŠŠã€çº¿ç¨‹ã€‘å’Œã€ä»»åŠ¡ã€‘ï¼ˆè¦æ‰§è¡Œçš„ä»£ç ï¼‰åˆ†å¼€</p><ul><li>Thread ä»£è¡¨çº¿ç¨‹</li><li>Runnable å¯è¿è¡Œçš„ä»»åŠ¡ï¼ˆçº¿ç¨‹è¦æ‰§è¡Œçš„ä»£ç ï¼‰</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1>1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2>2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3>3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4>4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5>5</a>
</span><span class=lnt id=hl-24-6><a class=lnlinks href=#hl-24-6>6</a>
</span><span class=lnt id=hl-24-7><a class=lnlinks href=#hl-24-7>7</a>
</span><span class=lnt id=hl-24-8><a class=lnlinks href=#hl-24-8>8</a>
</span><span class=lnt id=hl-24-9><a class=lnlinks href=#hl-24-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Runnable</span><span class=w> </span><span class=n>runnable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¦æ‰§è¡Œçš„ä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// åˆ›å»ºçº¿ç¨‹å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=w> </span><span class=n>runnable</span><span class=w> </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å¯åŠ¨çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>ä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åˆ›å»ºä»»åŠ¡å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Runnable</span><span class=w> </span><span class=n>task2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>task2</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>9:19:00 [t2] c.ThreadStarter - hello
</span></span></code></pre></td></tr></table></div></div><p>Java 8 ä»¥åå¯ä»¥ä½¿ç”¨ lambda ç²¾ç®€ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1>1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2>2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3>3</a>
</span><span class=lnt id=hl-27-4><a class=lnlinks href=#hl-27-4>4</a>
</span><span class=lnt id=hl-27-5><a class=lnlinks href=#hl-27-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åˆ›å»ºä»»åŠ¡å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Runnable</span><span class=w> </span><span class=n>task2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>task2</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=thread-ä¸-runnable-çš„å…³ç³»><a href=#thread-%e4%b8%8e-runnable-%e7%9a%84%e5%85%b3%e7%b3%bb class=header-anchor>#</a>
Thread ä¸ Runnable çš„å…³ç³»</h5><p>åˆ†æ Thread çš„æºç ï¼Œç†æ¸…å®ƒä¸ Runnable çš„å…³ç³»</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1>1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2>2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3>3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//Runnableæºç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a class=lnlinks href=#hl-29-1> 1</a>
</span><span class=lnt id=hl-29-2><a class=lnlinks href=#hl-29-2> 2</a>
</span><span class=lnt id=hl-29-3><a class=lnlinks href=#hl-29-3> 3</a>
</span><span class=lnt id=hl-29-4><a class=lnlinks href=#hl-29-4> 4</a>
</span><span class=lnt id=hl-29-5><a class=lnlinks href=#hl-29-5> 5</a>
</span><span class=lnt id=hl-29-6><a class=lnlinks href=#hl-29-6> 6</a>
</span><span class=lnt id=hl-29-7><a class=lnlinks href=#hl-29-7> 7</a>
</span><span class=lnt id=hl-29-8><a class=lnlinks href=#hl-29-8> 8</a>
</span><span class=lnt id=hl-29-9><a class=lnlinks href=#hl-29-9> 9</a>
</span><span class=lnt id=hl-29-10><a class=lnlinks href=#hl-29-10>10</a>
</span><span class=lnt id=hl-29-11><a class=lnlinks href=#hl-29-11>11</a>
</span><span class=lnt id=hl-29-12><a class=lnlinks href=#hl-29-12>12</a>
</span><span class=lnt id=hl-29-13><a class=lnlinks href=#hl-29-13>13</a>
</span><span class=lnt id=hl-29-14><a class=lnlinks href=#hl-29-14>14</a>
</span><span class=lnt id=hl-29-15><a class=lnlinks href=#hl-29-15>15</a>
</span><span class=lnt id=hl-29-16><a class=lnlinks href=#hl-29-16>16</a>
</span><span class=lnt id=hl-29-17><a class=lnlinks href=#hl-29-17>17</a>
</span><span class=lnt id=hl-29-18><a class=lnlinks href=#hl-29-18>18</a>
</span><span class=lnt id=hl-29-19><a class=lnlinks href=#hl-29-19>19</a>
</span><span class=lnt id=hl-29-20><a class=lnlinks href=#hl-29-20>20</a>
</span><span class=lnt id=hl-29-21><a class=lnlinks href=#hl-29-21>21</a>
</span><span class=lnt id=hl-29-22><a class=lnlinks href=#hl-29-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//Threadæºç ï¼ˆéƒ¨åˆ†ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Thread</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* What will be run. */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Thread</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>init</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Thread-&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>nextThreadNum</span><span class=p>(),</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>ThreadGroup</span><span class=w> </span><span class=n>g</span><span class=p>,</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=kt>long</span><span class=w> </span><span class=n>stackSize</span><span class=p>,</span><span class=w> </span><span class=n>AccessControlContext</span><span class=w> </span><span class=n>acc</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=kt>boolean</span><span class=w> </span><span class=n>inheritThreadLocals</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>target</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>target</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=å°ç»“><a href=#%e5%b0%8f%e7%bb%93 class=header-anchor>#</a>
å°ç»“</h5><ul><li>æ–¹æ³•1 æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œæ–¹æ³•2 æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆ†å¼€äº†</li><li>ç”¨ Runnable æ›´å®¹æ˜“ä¸çº¿ç¨‹æ± ç­‰é«˜çº§API é…åˆ</li><li>ç”¨ Runnable è®©ä»»åŠ¡ç±»è„±ç¦»äº† Thread ç»§æ‰¿ä½“ç³»ï¼Œæ›´çµæ´»</li></ul><h3 id=æ–¹æ³•ä¸‰futuretask-é…åˆ-thread><a href=#%e6%96%b9%e6%b3%95%e4%b8%89futuretask-%e9%85%8d%e5%90%88-thread class=header-anchor>#</a>
æ–¹æ³•ä¸‰ï¼ŒFutureTask é…åˆ Thread</h3><p>FutureTask èƒ½å¤Ÿæ¥æ”¶ Callable ç±»å‹çš„å‚æ•°ï¼Œç”¨æ¥å¤„ç†æœ‰è¿”å›ç»“æœçš„æƒ…å†µ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-30-1><a class=lnlinks href=#hl-30-1> 1</a>
</span><span class=lnt id=hl-30-2><a class=lnlinks href=#hl-30-2> 2</a>
</span><span class=lnt id=hl-30-3><a class=lnlinks href=#hl-30-3> 3</a>
</span><span class=lnt id=hl-30-4><a class=lnlinks href=#hl-30-4> 4</a>
</span><span class=lnt id=hl-30-5><a class=lnlinks href=#hl-30-5> 5</a>
</span><span class=lnt id=hl-30-6><a class=lnlinks href=#hl-30-6> 6</a>
</span><span class=lnt id=hl-30-7><a class=lnlinks href=#hl-30-7> 7</a>
</span><span class=lnt id=hl-30-8><a class=lnlinks href=#hl-30-8> 8</a>
</span><span class=lnt id=hl-30-9><a class=lnlinks href=#hl-30-9> 9</a>
</span><span class=lnt id=hl-30-10><a class=lnlinks href=#hl-30-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åˆ›å»ºä»»åŠ¡å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>FutureTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>task3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FutureTask</span><span class=o>&lt;&gt;</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>task3</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t3&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä¸»çº¿ç¨‹é˜»å¡ï¼ŒåŒæ­¥ç­‰å¾… task æ‰§è¡Œå®Œæ¯•çš„ç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Integer</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task3</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æœæ˜¯:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-31-1><a class=lnlinks href=#hl-31-1>1</a>
</span><span class=lnt id=hl-31-2><a class=lnlinks href=#hl-31-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>19:22:27 [t3] c.ThreadStarter - hello
</span></span><span class=line><span class=cl>19:22:27 [main] c.ThreadStarter - ç»“æœæ˜¯:100
</span></span></code></pre></td></tr></table></div></div><p>æºç åˆ†æ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-32-1><a class=lnlinks href=#hl-32-1> 1</a>
</span><span class=lnt id=hl-32-2><a class=lnlinks href=#hl-32-2> 2</a>
</span><span class=lnt id=hl-32-3><a class=lnlinks href=#hl-32-3> 3</a>
</span><span class=lnt id=hl-32-4><a class=lnlinks href=#hl-32-4> 4</a>
</span><span class=lnt id=hl-32-5><a class=lnlinks href=#hl-32-5> 5</a>
</span><span class=lnt id=hl-32-6><a class=lnlinks href=#hl-32-6> 6</a>
</span><span class=lnt id=hl-32-7><a class=lnlinks href=#hl-32-7> 7</a>
</span><span class=lnt id=hl-32-8><a class=lnlinks href=#hl-32-8> 8</a>
</span><span class=lnt id=hl-32-9><a class=lnlinks href=#hl-32-9> 9</a>
</span><span class=lnt id=hl-32-10><a class=lnlinks href=#hl-32-10>10</a>
</span><span class=lnt id=hl-32-11><a class=lnlinks href=#hl-32-11>11</a>
</span><span class=lnt id=hl-32-12><a class=lnlinks href=#hl-32-12>12</a>
</span><span class=lnt id=hl-32-13><a class=lnlinks href=#hl-32-13>13</a>
</span><span class=lnt id=hl-32-14><a class=lnlinks href=#hl-32-14>14</a>
</span><span class=lnt id=hl-32-15><a class=lnlinks href=#hl-32-15>15</a>
</span><span class=lnt id=hl-32-16><a class=lnlinks href=#hl-32-16>16</a>
</span><span class=lnt id=hl-32-17><a class=lnlinks href=#hl-32-17>17</a>
</span><span class=lnt id=hl-32-18><a class=lnlinks href=#hl-32-18>18</a>
</span><span class=lnt id=hl-32-19><a class=lnlinks href=#hl-32-19>19</a>
</span><span class=lnt id=hl-32-20><a class=lnlinks href=#hl-32-20>20</a>
</span><span class=lnt id=hl-32-21><a class=lnlinks href=#hl-32-21>21</a>
</span><span class=lnt id=hl-32-22><a class=lnlinks href=#hl-32-22>22</a>
</span><span class=lnt id=hl-32-23><a class=lnlinks href=#hl-32-23>23</a>
</span><span class=lnt id=hl-32-24><a class=lnlinks href=#hl-32-24>24</a>
</span><span class=lnt id=hl-32-25><a class=lnlinks href=#hl-32-25>25</a>
</span><span class=lnt id=hl-32-26><a class=lnlinks href=#hl-32-26>26</a>
</span><span class=lnt id=hl-32-27><a class=lnlinks href=#hl-32-27>27</a>
</span><span class=lnt id=hl-32-28><a class=lnlinks href=#hl-32-28>28</a>
</span><span class=lnt id=hl-32-29><a class=lnlinks href=#hl-32-29>29</a>
</span><span class=lnt id=hl-32-30><a class=lnlinks href=#hl-32-30>30</a>
</span><span class=lnt id=hl-32-31><a class=lnlinks href=#hl-32-31>31</a>
</span><span class=lnt id=hl-32-32><a class=lnlinks href=#hl-32-32>32</a>
</span><span class=lnt id=hl-32-33><a class=lnlinks href=#hl-32-33>33</a>
</span><span class=lnt id=hl-32-34><a class=lnlinks href=#hl-32-34>34</a>
</span><span class=lnt id=hl-32-35><a class=lnlinks href=#hl-32-35>35</a>
</span><span class=lnt id=hl-32-36><a class=lnlinks href=#hl-32-36>36</a>
</span><span class=lnt id=hl-32-37><a class=lnlinks href=#hl-32-37>37</a>
</span><span class=lnt id=hl-32-38><a class=lnlinks href=#hl-32-38>38</a>
</span><span class=lnt id=hl-32-39><a class=lnlinks href=#hl-32-39>39</a>
</span><span class=lnt id=hl-32-40><a class=lnlinks href=#hl-32-40>40</a>
</span><span class=lnt id=hl-32-41><a class=lnlinks href=#hl-32-41>41</a>
</span><span class=lnt id=hl-32-42><a class=lnlinks href=#hl-32-42>42</a>
</span><span class=lnt id=hl-32-43><a class=lnlinks href=#hl-32-43>43</a>
</span><span class=lnt id=hl-32-44><a class=lnlinks href=#hl-32-44>44</a>
</span><span class=lnt id=hl-32-45><a class=lnlinks href=#hl-32-45>45</a>
</span><span class=lnt id=hl-32-46><a class=lnlinks href=#hl-32-46>46</a>
</span><span class=lnt id=hl-32-47><a class=lnlinks href=#hl-32-47>47</a>
</span><span class=lnt id=hl-32-48><a class=lnlinks href=#hl-32-48>48</a>
</span><span class=lnt id=hl-32-49><a class=lnlinks href=#hl-32-49>49</a>
</span><span class=lnt id=hl-32-50><a class=lnlinks href=#hl-32-50>50</a>
</span><span class=lnt id=hl-32-51><a class=lnlinks href=#hl-32-51>51</a>
</span><span class=lnt id=hl-32-52><a class=lnlinks href=#hl-32-52>52</a>
</span><span class=lnt id=hl-32-53><a class=lnlinks href=#hl-32-53>53</a>
</span><span class=lnt id=hl-32-54><a class=lnlinks href=#hl-32-54>54</a>
</span><span class=lnt id=hl-32-55><a class=lnlinks href=#hl-32-55>55</a>
</span><span class=lnt id=hl-32-56><a class=lnlinks href=#hl-32-56>56</a>
</span><span class=lnt id=hl-32-57><a class=lnlinks href=#hl-32-57>57</a>
</span><span class=lnt id=hl-32-58><a class=lnlinks href=#hl-32-58>58</a>
</span><span class=lnt id=hl-32-59><a class=lnlinks href=#hl-32-59>59</a>
</span><span class=lnt id=hl-32-60><a class=lnlinks href=#hl-32-60>60</a>
</span><span class=lnt id=hl-32-61><a class=lnlinks href=#hl-32-61>61</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//FutureTaskæºç ï¼ˆéƒ¨åˆ†ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FutureTask</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>RunnableFuture</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** The underlying callable; nulled out after running */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>callable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** The result to return or exception to throw from get() */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>outcome</span><span class=p>;</span><span class=w> </span><span class=c1>// non-volatile, protected by state reads/writes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>FutureTask</span><span class=p>(</span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>callable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>callable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NullPointerException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>callable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NEW</span><span class=p>;</span><span class=w>       </span><span class=c1>// ensure visibility of callable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>V</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>ran</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>call</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ran</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ran</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ran</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>set</span><span class=p>(</span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>V</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>stateOffset</span><span class=p>,</span><span class=w> </span><span class=n>NEW</span><span class=p>,</span><span class=w> </span><span class=n>COMPLETING</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>outcome</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>putOrderedInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>stateOffset</span><span class=p>,</span><span class=w> </span><span class=n>NORMAL</span><span class=p>);</span><span class=w> </span><span class=c1>// final state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>finishCompletion</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>COMPLETING</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>awaitDone</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>0L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>report</span><span class=p>(</span><span class=n>s</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>report</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>outcome</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NORMAL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>V</span><span class=p>)</span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>CANCELLED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CancellationException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>((</span><span class=n>Throwable</span><span class=p>)</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>    
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-33-1><a class=lnlinks href=#hl-33-1> 1</a>
</span><span class=lnt id=hl-33-2><a class=lnlinks href=#hl-33-2> 2</a>
</span><span class=lnt id=hl-33-3><a class=lnlinks href=#hl-33-3> 3</a>
</span><span class=lnt id=hl-33-4><a class=lnlinks href=#hl-33-4> 4</a>
</span><span class=lnt id=hl-33-5><a class=lnlinks href=#hl-33-5> 5</a>
</span><span class=lnt id=hl-33-6><a class=lnlinks href=#hl-33-6> 6</a>
</span><span class=lnt id=hl-33-7><a class=lnlinks href=#hl-33-7> 7</a>
</span><span class=lnt id=hl-33-8><a class=lnlinks href=#hl-33-8> 8</a>
</span><span class=lnt id=hl-33-9><a class=lnlinks href=#hl-33-9> 9</a>
</span><span class=lnt id=hl-33-10><a class=lnlinks href=#hl-33-10>10</a>
</span><span class=lnt id=hl-33-11><a class=lnlinks href=#hl-33-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//Callableæºç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@FunctionalInterface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Computes a result, or throws an exception if unable to do so.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return computed result
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws Exception if unable to compute a result
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>V</span><span class=w> </span><span class=nf>call</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯´æ˜ï¼š</p><ul><li>FutureTaskå†…ç½®äº†ä¸€ä¸ªCallableå¯¹è±¡ï¼Œåˆå§‹åŒ–æ–¹æ³•å°†æŒ‡å®šçš„Callableèµ‹ç»™è¿™ä¸ªå¯¹è±¡ã€‚</li><li>FutureTaskå®ç°äº†Runnableæ¥å£ï¼Œå¹¶é‡å†™äº†Runæ–¹æ³•ï¼Œåœ¨Runæ–¹æ³•ä¸­è°ƒç”¨äº†Callableä¸­çš„callæ–¹æ³•ï¼Œå¹¶å°†è¿”å›å€¼èµ‹å€¼ç»™outcomeå˜é‡</li><li>getæ–¹æ³•å°±æ˜¯å–å‡ºoutcomeçš„å€¼ã€‚</li></ul><h2 id=32-è§‚å¯Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ><a href=#32-%e8%a7%82%e5%af%9f%e5%a4%9a%e4%b8%aa%e7%ba%bf%e7%a8%8b%e5%90%8c%e6%97%b6%e8%bf%90%e8%a1%8c class=header-anchor>#</a>
3.2 è§‚å¯Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</h2><p>ä¸»è¦æ˜¯ç†è§£</p><ul><li>äº¤æ›¿æ‰§è¡Œ</li><li>è°å…ˆè°åï¼Œä¸ç”±æˆ‘ä»¬æ§åˆ¶</li></ul><p>ç¤ºä¾‹ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-34-1><a class=lnlinks href=#hl-34-1> 1</a>
</span><span class=lnt id=hl-34-2><a class=lnlinks href=#hl-34-2> 2</a>
</span><span class=lnt id=hl-34-3><a class=lnlinks href=#hl-34-3> 3</a>
</span><span class=lnt id=hl-34-4><a class=lnlinks href=#hl-34-4> 4</a>
</span><span class=lnt id=hl-34-5><a class=lnlinks href=#hl-34-5> 5</a>
</span><span class=lnt id=hl-34-6><a class=lnlinks href=#hl-34-6> 6</a>
</span><span class=lnt id=hl-34-7><a class=lnlinks href=#hl-34-7> 7</a>
</span><span class=lnt id=hl-34-8><a class=lnlinks href=#hl-34-8> 8</a>
</span><span class=lnt id=hl-34-9><a class=lnlinks href=#hl-34-9> 9</a>
</span><span class=lnt id=hl-34-10><a class=lnlinks href=#hl-34-10>10</a>
</span><span class=lnt id=hl-34-11><a class=lnlinks href=#hl-34-11>11</a>
</span><span class=lnt id=hl-34-12><a class=lnlinks href=#hl-34-12>12</a>
</span><span class=lnt id=hl-34-13><a class=lnlinks href=#hl-34-13>13</a>
</span><span class=lnt id=hl-34-14><a class=lnlinks href=#hl-34-14>14</a>
</span><span class=lnt id=hl-34-15><a class=lnlinks href=#hl-34-15>15</a>
</span><span class=lnt id=hl-34-16><a class=lnlinks href=#hl-34-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.TestMultiThread&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestMultiThread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿è¡Œç»“æœï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-35-1><a class=lnlinks href=#hl-35-1> 1</a>
</span><span class=lnt id=hl-35-2><a class=lnlinks href=#hl-35-2> 2</a>
</span><span class=lnt id=hl-35-3><a class=lnlinks href=#hl-35-3> 3</a>
</span><span class=lnt id=hl-35-4><a class=lnlinks href=#hl-35-4> 4</a>
</span><span class=lnt id=hl-35-5><a class=lnlinks href=#hl-35-5> 5</a>
</span><span class=lnt id=hl-35-6><a class=lnlinks href=#hl-35-6> 6</a>
</span><span class=lnt id=hl-35-7><a class=lnlinks href=#hl-35-7> 7</a>
</span><span class=lnt id=hl-35-8><a class=lnlinks href=#hl-35-8> 8</a>
</span><span class=lnt id=hl-35-9><a class=lnlinks href=#hl-35-9> 9</a>
</span><span class=lnt id=hl-35-10><a class=lnlinks href=#hl-35-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t2<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t2<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t2<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t2<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>23:45:26.254 c.TestMultiThread <span class=o>[</span>t1<span class=o>]</span> - running
</span></span></code></pre></td></tr></table></div></div><h2 id=33-æŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•><a href=#33-%e6%9f%a5%e7%9c%8b%e8%bf%9b%e7%a8%8b%e7%ba%bf%e7%a8%8b%e7%9a%84%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
3.3 æŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•</h2><h3 id=windows><a href=#windows class=header-anchor>#</a>
windows</h3><ul><li>ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹</li><li>tasklist æŸ¥çœ‹è¿›ç¨‹<ul><li><code>tasklist</code> | <code>findstr</code> (æŸ¥æ‰¾å…³é”®å­—)</li></ul></li><li>taskkill æ€æ­»è¿›ç¨‹<ul><li>taskkill /F(å½»åº•æ€æ­»ï¼‰/PID(è¿›ç¨‹PID)</li></ul></li></ul><h3 id=linux><a href=#linux class=header-anchor>#</a>
Linux</h3><ul><li>ps -fe æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹</li><li>ps -fT -p æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹</li><li>kill æ€æ­»è¿›ç¨‹ top æŒ‰å¤§å†™ H åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹</li><li>top -H -p æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹</li></ul><h3 id=java><a href=#java class=header-anchor>#</a>
Java</h3><ul><li>jps å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹</li><li>jstack æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€</li><li>jconsole æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰</li></ul><p>jconsole è¿œç¨‹ç›‘æ§é…ç½®</p><ul><li><p>éœ€è¦ä»¥å¦‚ä¸‹æ–¹å¼è¿è¡Œä½ çš„ java ç±»</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-36-1><a class=lnlinks href=#hl-36-1>1</a>
</span><span class=lnt id=hl-36-2><a class=lnlinks href=#hl-36-2>2</a>
</span><span class=lnt id=hl-36-3><a class=lnlinks href=#hl-36-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>java -Djava.rmi.server.hostname<span class=o>=</span><span class=sb>`</span>ipåœ°å€<span class=sb>`</span> -Dcom.sun.management.jmxremote -
</span></span><span class=line><span class=cl>Dcom.sun.management.jmxremote.port<span class=o>=</span><span class=sb>`</span>è¿æ¥ç«¯å£<span class=sb>`</span> -Dcom.sun.management.jmxremote.ssl<span class=o>=</span>æ˜¯å¦å®‰å…¨è¿æ¥ -
</span></span><span class=line><span class=cl>Dcom.sun.management.jmxremote.authenticate<span class=o>=</span>æ˜¯å¦è®¤è¯ javaç±»
</span></span></code></pre></td></tr></table></div></div></li><li><p>å…³é—­é˜²ç«å¢™ï¼Œå…è®¸ç«¯å£</p></li><li><p>ä¿®æ”¹ /etc/hosts æ–‡ä»¶å°† 127.0.0.1 æ˜ å°„è‡³ä¸»æœºå</p></li></ul><p>å¦‚æœè¦è®¤è¯è®¿é—®ï¼Œè¿˜éœ€è¦åšå¦‚ä¸‹æ­¥éª¤</p><ul><li>å¤åˆ¶ jmxremote.password æ–‡ä»¶</li><li>ä¿®æ”¹ jmxremote.password å’Œ jmxremote.access æ–‡ä»¶çš„æƒé™ä¸º 600 å³æ–‡ä»¶æ‰€æœ‰è€…å¯è¯»å†™</li><li>è¿æ¥æ—¶å¡«å…¥ controlRoleï¼ˆç”¨æˆ·åï¼‰ï¼ŒR&amp;Dï¼ˆå¯†ç ï¼‰</li></ul><h2 id=textcolorblue34--åŸç†ä¹‹çº¿ç¨‹è¿è¡Œ-><a href=#textcolorblue34--%e5%8e%9f%e7%90%86%e4%b9%8b%e7%ba%bf%e7%a8%8b%e8%bf%90%e8%a1%8c- class=header-anchor>#</a>
$\textcolor{Blue}{3.4 * åŸç†ä¹‹çº¿ç¨‹è¿è¡Œ} $</h2><h3 id=æ ˆä¸æ ˆå¸§><a href=#%e6%a0%88%e4%b8%8e%e6%a0%88%e5%b8%a7 class=header-anchor>#</a>
æ ˆä¸æ ˆå¸§</h3><p>Java Virtual Machine Stacks ï¼ˆJava è™šæ‹Ÿæœºæ ˆï¼‰</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ JVM ä¸­ç”±å †ã€æ ˆã€æ–¹æ³•åŒºæ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜æ˜¯ç»™è°ç”¨çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿ æœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜ã€‚</p><ul><li>æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜</li><li>æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•</li></ul><h3 id=çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢thread-context-switch><a href=#%e7%ba%bf%e7%a8%8b%e4%b8%8a%e4%b8%8b%e6%96%87%e5%88%87%e6%8d%a2thread-context-switch class=header-anchor>#</a>
çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰</h3><p>å› ä¸ºä»¥ä¸‹ä¸€äº›åŸå› å¯¼è‡´ cpu ä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç </p><ul><li>çº¿ç¨‹çš„ cpu æ—¶é—´ç‰‡ç”¨å®Œ</li><li>åƒåœ¾å›æ”¶</li><li>æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ</li><li>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€parkã€synchronizedã€lock ç­‰æ–¹æ³•</li></ul><p>å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJava ä¸­å¯¹åº”çš„æ¦‚å¿µ å°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡ jvm æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„</p><ul><li>çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰</li><li>Context Switch é¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½</li></ul><h2 id=35å¸¸è§æ–¹æ³•><a href=#35%e5%b8%b8%e8%a7%81%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
3.5å¸¸è§æ–¹æ³•</h2><div class=table-wrapper><table><thead><tr><th>æ–¹æ³•</th><th>åŠŸèƒ½</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>public void start()</strong></td><td>å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼›Javaè™šæ‹Ÿæœºè°ƒç”¨æ­¤çº¿ç¨‹çš„runæ–¹æ³•</td><td>start æ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥å°±ç»ªï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ» è¿è¡Œï¼ˆCPU çš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„ startæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç° IllegalThreadStateException</td></tr><tr><td><strong>public void run()</strong></td><td>çº¿ç¨‹å¯åŠ¨åè°ƒç”¨è¯¥æ–¹æ³•</td><td>å¦‚æœåœ¨æ„é€  Thread å¯¹è±¡æ—¶ä¼ é€’äº† Runnable å‚æ•°ï¼Œåˆ™ çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨ Runnable ä¸­çš„ run æ–¹æ³•ï¼Œå¦åˆ™é»˜ è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œ æ¥è¦†ç›–é»˜è®¤è¡Œä¸º</td></tr><tr><td><strong>public void setName(String name)</strong></td><td>ç»™å½“å‰çº¿ç¨‹å–åå­—</td><td></td></tr><tr><td><strong>public void getName()</strong></td><td>è·å–å½“å‰çº¿ç¨‹çš„åå­—ã€‚çº¿ç¨‹å­˜åœ¨é»˜è®¤åç§°ï¼šå­çº¿ç¨‹æ˜¯Thread-ç´¢å¼•ï¼Œä¸»çº¿ç¨‹æ˜¯main</td><td></td></tr><tr><td><strong>public static Thread currentThread()</strong></td><td>è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ï¼Œä»£ç åœ¨å“ªä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ</td><td></td></tr><tr><td><strong>public static void sleep(long time)</strong></td><td>è®©å½“å‰çº¿ç¨‹ä¼‘çœ å¤šå°‘æ¯«ç§’å†ç»§ç»­æ‰§è¡Œã€‚<strong>Thread.sleep(0)</strong> : è®©æ“ä½œç³»ç»Ÿç«‹åˆ»é‡æ–°è¿›è¡Œä¸€æ¬¡cpuç«äº‰</td><td></td></tr><tr><td><strong>public static native void yield()</strong></td><td>æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹CPUçš„ä½¿ç”¨</td><td>ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•å’Œè°ƒè¯•</td></tr><tr><td><strong>public final int getPriority()</strong></td><td>è¿”å›æ­¤çº¿ç¨‹çš„ä¼˜å…ˆçº§</td><td></td></tr><tr><td><strong>public final void setPriority(int priority)</strong></td><td>æ›´æ”¹æ­¤çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå¸¸ç”¨1 5 10</td><td>javaä¸­è§„å®šçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯1~10 çš„æ•´æ•°ï¼Œè¾ƒå¤§çš„ä¼˜å…ˆçº§ èƒ½æé«˜è¯¥çº¿ç¨‹è¢« CPU è°ƒåº¦çš„æœºç‡</td></tr><tr><td><strong>public void interrupt()</strong></td><td>ä¸­æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶</td><td></td></tr><tr><td><strong>public static boolean interrupted()</strong></td><td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</td><td></td></tr><tr><td><strong>public boolean isInterrupted()</strong></td><td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¸æ¸…é™¤æ‰“æ–­æ ‡è®°</td><td></td></tr><tr><td><strong>public final void join()</strong></td><td>ç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸ</td><td></td></tr><tr><td><strong>public final void join(long millis)</strong></td><td>ç­‰å¾…è¿™ä¸ªçº¿ç¨‹æ­»äº¡millisæ¯«ç§’ï¼Œ0æ„å‘³ç€æ°¸è¿œç­‰å¾…</td><td></td></tr><tr><td><strong>public final native boolean isAlive()</strong></td><td>çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆè¿˜æ²¡æœ‰è¿è¡Œå®Œæ¯•ï¼‰</td><td></td></tr><tr><td><strong>public final void setDaemon(boolean on)</strong></td><td>å°†æ­¤çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹æˆ–ç”¨æˆ·çº¿ç¨‹</td><td></td></tr><tr><td><strong>public long getId()</strong></td><td>è·å–çº¿ç¨‹é•¿æ•´å‹ çš„ id</td><td>id å”¯ä¸€</td></tr><tr><td><strong>public state getState()</strong></td><td>è·å–çº¿ç¨‹çŠ¶æ€</td><td>Java ä¸­çº¿ç¨‹çŠ¶æ€æ˜¯ç”¨ 6 ä¸ª enum è¡¨ç¤ºï¼Œåˆ†åˆ«ä¸ºï¼š NEW, RUNNABLE, BLOCKED, WAITING, TIMED_WAITING, TERMINATED</td></tr><tr><td><strong>public boolean isInterrupted()</strong></td><td>åˆ¤æ–­æ˜¯å¦è¢«æ‰“ æ–­</td><td>ä¸ä¼šæ¸…é™¤ æ‰“æ–­æ ‡è®°</td></tr></tbody></table></div><h2 id=36-start-ä¸-run><a href=#36-start-%e4%b8%8e-run class=header-anchor>#</a>
3.6 start ä¸ run</h2><h3 id=è°ƒç”¨-run><a href=#%e8%b0%83%e7%94%a8-run class=header-anchor>#</a>
è°ƒç”¨ run</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-37-1><a class=lnlinks href=#hl-37-1> 1</a>
</span><span class=lnt id=hl-37-2><a class=lnlinks href=#hl-37-2> 2</a>
</span><span class=lnt id=hl-37-3><a class=lnlinks href=#hl-37-3> 3</a>
</span><span class=lnt id=hl-37-4><a class=lnlinks href=#hl-37-4> 4</a>
</span><span class=lnt id=hl-37-5><a class=lnlinks href=#hl-37-5> 5</a>
</span><span class=lnt id=hl-37-6><a class=lnlinks href=#hl-37-6> 6</a>
</span><span class=lnt id=hl-37-7><a class=lnlinks href=#hl-37-7> 7</a>
</span><span class=lnt id=hl-37-8><a class=lnlinks href=#hl-37-8> 8</a>
</span><span class=lnt id=hl-37-9><a class=lnlinks href=#hl-37-9> 9</a>
</span><span class=lnt id=hl-37-10><a class=lnlinks href=#hl-37-10>10</a>
</span><span class=lnt id=hl-37-11><a class=lnlinks href=#hl-37-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=s>&#34;t1&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>FileReader</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>MP4_FULL_PATH</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;do other things ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-38-1><a class=lnlinks href=#hl-38-1>1</a>
</span><span class=lnt id=hl-38-2><a class=lnlinks href=#hl-38-2>2</a>
</span><span class=lnt id=hl-38-3><a class=lnlinks href=#hl-38-3>3</a>
</span><span class=lnt id=hl-38-4><a class=lnlinks href=#hl-38-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:39:14 <span class=o>[</span>main<span class=o>]</span> c.TestStart - main
</span></span><span class=line><span class=cl>19:39:14 <span class=o>[</span>main<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ...
</span></span><span class=line><span class=cl>19:39:18 <span class=o>[</span>main<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>4227</span> ms
</span></span><span class=line><span class=cl>19:39:18 <span class=o>[</span>main<span class=o>]</span> c.TestStart - <span class=k>do</span> other things ...
</span></span></code></pre></td></tr></table></div></div><p>ç¨‹åºä»åœ¨ main çº¿ç¨‹è¿è¡Œï¼Œ FileReader.read() æ–¹æ³•è°ƒç”¨è¿˜æ˜¯åŒæ­¥çš„</p><h3 id=è°ƒç”¨start><a href=#%e8%b0%83%e7%94%a8start class=header-anchor>#</a>
è°ƒç”¨start</h3><p>å°†ä¸Šè¿°ä»£ç çš„ t1.run() æ”¹ä¸º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-39-1><a class=lnlinks href=#hl-39-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-40-1><a class=lnlinks href=#hl-40-1>1</a>
</span><span class=lnt id=hl-40-2><a class=lnlinks href=#hl-40-2>2</a>
</span><span class=lnt id=hl-40-3><a class=lnlinks href=#hl-40-3>3</a>
</span><span class=lnt id=hl-40-4><a class=lnlinks href=#hl-40-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:41:30 <span class=o>[</span>main<span class=o>]</span> c.TestStart - <span class=k>do</span> other things ...
</span></span><span class=line><span class=cl>19:41:30 <span class=o>[</span>t1<span class=o>]</span> c.TestStart - t1
</span></span><span class=line><span class=cl>19:41:30 <span class=o>[</span>t1<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> start ...
</span></span><span class=line><span class=cl>19:41:35 <span class=o>[</span>t1<span class=o>]</span> c.FileReader - <span class=nb>read</span> <span class=o>[</span>1.mp4<span class=o>]</span> end ... cost: <span class=m>4542</span> ms
</span></span></code></pre></td></tr></table></div></div><p>ç¨‹åºåœ¨ t1 çº¿ç¨‹è¿è¡Œï¼Œ FileReader.read() æ–¹æ³•è°ƒç”¨æ˜¯å¼‚æ­¥çš„</p><h3 id=å°ç»“-1><a href=#%e5%b0%8f%e7%bb%93-1 class=header-anchor>#</a>
å°ç»“</h3><ul><li><p>ç›´æ¥è°ƒç”¨ run æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº† runï¼Œæ²¡æœ‰å¯åŠ¨æ–°çš„çº¿ç¨‹</p></li><li><p>ä½¿ç”¨ start æ˜¯å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œé€šè¿‡æ–°çš„çº¿ç¨‹é—´æ¥æ‰§è¡Œ run ä¸­çš„ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-41-1><a class=lnlinks href=#hl-41-1> 1</a>
</span><span class=lnt id=hl-41-2><a class=lnlinks href=#hl-41-2> 2</a>
</span><span class=lnt id=hl-41-3><a class=lnlinks href=#hl-41-3> 3</a>
</span><span class=lnt id=hl-41-4><a class=lnlinks href=#hl-41-4> 4</a>
</span><span class=lnt id=hl-41-5><a class=lnlinks href=#hl-41-5> 5</a>
</span><span class=lnt id=hl-41-6><a class=lnlinks href=#hl-41-6> 6</a>
</span><span class=lnt id=hl-41-7><a class=lnlinks href=#hl-41-7> 7</a>
</span><span class=lnt id=hl-41-8><a class=lnlinks href=#hl-41-8> 8</a>
</span><span class=lnt id=hl-41-9><a class=lnlinks href=#hl-41-9> 9</a>
</span><span class=lnt id=hl-41-10><a class=lnlinks href=#hl-41-10>10</a>
</span><span class=lnt id=hl-41-11><a class=lnlinks href=#hl-41-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=s>&#34;t1&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>t1</span><span class=p>.</span><span class=na>getState</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>t1</span><span class=p>.</span><span class=na>getState</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹è§ï¼Œstartæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œå°†çº¿ç¨‹ä»å°±ç»ªçŠ¶æ€åˆ‡æ¢ä¸ºRunnable</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-42-1><a class=lnlinks href=#hl-42-1>1</a>
</span><span class=lnt id=hl-42-2><a class=lnlinks href=#hl-42-2>2</a>
</span><span class=lnt id=hl-42-3><a class=lnlinks href=#hl-42-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>NEW
</span></span><span class=line><span class=cl>RUNNABLE
</span></span><span class=line><span class=cl>03:45:12.255 c.Test5 <span class=o>[</span>t1<span class=o>]</span> - running...
</span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=37-sleep-ä¸-yield><a href=#37-sleep-%e4%b8%8e-yield class=header-anchor>#</a>
3.7 sleep ä¸ yield</h2><h3 id=sleep><a href=#sleep class=header-anchor>#</a>
sleep</h3><ol><li><p>è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» Running è¿›å…¥ Timed Waiting çŠ¶æ€ï¼ˆé˜»å¡ï¼‰</p></li><li><p>å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ interrupt æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡º InterruptedException</p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-43-1><a class=lnlinks href=#hl-43-1> 1</a>
</span><span class=lnt id=hl-43-2><a class=lnlinks href=#hl-43-2> 2</a>
</span><span class=lnt id=hl-43-3><a class=lnlinks href=#hl-43-3> 3</a>
</span><span class=lnt id=hl-43-4><a class=lnlinks href=#hl-43-4> 4</a>
</span><span class=lnt id=hl-43-5><a class=lnlinks href=#hl-43-5> 5</a>
</span><span class=lnt id=hl-43-6><a class=lnlinks href=#hl-43-6> 6</a>
</span><span class=lnt id=hl-43-7><a class=lnlinks href=#hl-43-7> 7</a>
</span><span class=lnt id=hl-43-8><a class=lnlinks href=#hl-43-8> 8</a>
</span><span class=lnt id=hl-43-9><a class=lnlinks href=#hl-43-9> 9</a>
</span><span class=lnt id=hl-43-10><a class=lnlinks href=#hl-43-10>10</a>
</span><span class=lnt id=hl-43-11><a class=lnlinks href=#hl-43-11>11</a>
</span><span class=lnt id=hl-43-12><a class=lnlinks href=#hl-43-12>12</a>
</span><span class=lnt id=hl-43-13><a class=lnlinks href=#hl-43-13>13</a>
</span><span class=lnt id=hl-43-14><a class=lnlinks href=#hl-43-14>14</a>
</span><span class=lnt id=hl-43-15><a class=lnlinks href=#hl-43-15>15</a>
</span><span class=lnt id=hl-43-16><a class=lnlinks href=#hl-43-16>16</a>
</span><span class=lnt id=hl-43-17><a class=lnlinks href=#hl-43-17>17</a>
</span><span class=lnt id=hl-43-18><a class=lnlinks href=#hl-43-18>18</a>
</span><span class=lnt id=hl-43-19><a class=lnlinks href=#hl-43-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=s>&#34;t1&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;enter sleep...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;wake up...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;interrupt...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºç»“æœï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-44-1><a class=lnlinks href=#hl-44-1>1</a>
</span><span class=lnt id=hl-44-2><a class=lnlinks href=#hl-44-2>2</a>
</span><span class=lnt id=hl-44-3><a class=lnlinks href=#hl-44-3>3</a>
</span><span class=lnt id=hl-44-4><a class=lnlinks href=#hl-44-4>4</a>
</span><span class=lnt id=hl-44-5><a class=lnlinks href=#hl-44-5>5</a>
</span><span class=lnt id=hl-44-6><a class=lnlinks href=#hl-44-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>03:47:18.141 c.Test7 <span class=o>[</span>t1<span class=o>]</span> - enter sleep...
</span></span><span class=line><span class=cl>03:47:19.132 c.Test7 <span class=o>[</span>main<span class=o>]</span> - interrupt...
</span></span><span class=line><span class=cl>03:47:19.132 c.Test7 <span class=o>[</span>t1<span class=o>]</span> - wake up...
</span></span><span class=line><span class=cl>java.lang.InterruptedException: sleep interrupted
</span></span><span class=line><span class=cl>	at java.lang.Thread.sleep<span class=o>(</span>Native Method<span class=o>)</span>
</span></span><span class=line><span class=cl>	at cn.itcast.test.Test7<span class=nv>$1</span>.run<span class=o>(</span>Test7.java:14<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3><li><p>ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ</p></li><li><p>å»ºè®®ç”¨ TimeUnit çš„ sleep ä»£æ›¿ Thread çš„ sleep æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§ ã€‚å…¶åº•å±‚è¿˜æ˜¯sleepæ–¹æ³•ã€‚</p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-45-1><a class=lnlinks href=#hl-45-1> 1</a>
</span><span class=lnt id=hl-45-2><a class=lnlinks href=#hl-45-2> 2</a>
</span><span class=lnt id=hl-45-3><a class=lnlinks href=#hl-45-3> 3</a>
</span><span class=lnt id=hl-45-4><a class=lnlinks href=#hl-45-4> 4</a>
</span><span class=lnt id=hl-45-5><a class=lnlinks href=#hl-45-5> 5</a>
</span><span class=lnt id=hl-45-6><a class=lnlinks href=#hl-45-6> 6</a>
</span><span class=lnt id=hl-45-7><a class=lnlinks href=#hl-45-7> 7</a>
</span><span class=lnt id=hl-45-8><a class=lnlinks href=#hl-45-8> 8</a>
</span><span class=lnt id=hl-45-9><a class=lnlinks href=#hl-45-9> 9</a>
</span><span class=lnt id=hl-45-10><a class=lnlinks href=#hl-45-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Test8&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test8</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;enter&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        Thread.sleep(1000);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol start=5><li>åœ¨å¾ªç¯è®¿é—®é”çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åŠ å…¥sleepè®©çº¿ç¨‹é˜»å¡æ—¶é—´ï¼Œé˜²æ­¢å¤§é‡å ç”¨cpuèµ„æºã€‚</li></ol><h3 id=yield><a href=#yield class=header-anchor>#</a>
yield</h3><ol><li>è°ƒç”¨ yield ä¼šè®©å½“å‰çº¿ç¨‹ä» Running è¿›å…¥ Runnable å°±ç»ªçŠ¶æ€ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶å®ƒçº¿ç¨‹</li><li>å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨</li></ol><h3 id=çº¿ç¨‹ä¼˜å…ˆçº§><a href=#%e7%ba%bf%e7%a8%8b%e4%bc%98%e5%85%88%e7%ba%a7 class=header-anchor>#</a>
çº¿ç¨‹ä¼˜å…ˆçº§</h3><ul><li>çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒ</li><li>å¦‚æœ cpu æ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½† cpu é—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨</li></ul><h3 id=æµ‹è¯•ä¼˜å…ˆçº§å’Œyield><a href=#%e6%b5%8b%e8%af%95%e4%bc%98%e5%85%88%e7%ba%a7%e5%92%8cyield class=header-anchor>#</a>
æµ‹è¯•ä¼˜å…ˆçº§å’Œyield</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-46-1><a class=lnlinks href=#hl-46-1> 1</a>
</span><span class=lnt id=hl-46-2><a class=lnlinks href=#hl-46-2> 2</a>
</span><span class=lnt id=hl-46-3><a class=lnlinks href=#hl-46-3> 3</a>
</span><span class=lnt id=hl-46-4><a class=lnlinks href=#hl-46-4> 4</a>
</span><span class=lnt id=hl-46-5><a class=lnlinks href=#hl-46-5> 5</a>
</span><span class=lnt id=hl-46-6><a class=lnlinks href=#hl-46-6> 6</a>
</span><span class=lnt id=hl-46-7><a class=lnlinks href=#hl-46-7> 7</a>
</span><span class=lnt id=hl-46-8><a class=lnlinks href=#hl-46-8> 8</a>
</span><span class=lnt id=hl-46-9><a class=lnlinks href=#hl-46-9> 9</a>
</span><span class=lnt id=hl-46-10><a class=lnlinks href=#hl-46-10>10</a>
</span><span class=lnt id=hl-46-11><a class=lnlinks href=#hl-46-11>11</a>
</span><span class=lnt id=hl-46-12><a class=lnlinks href=#hl-46-12>12</a>
</span><span class=lnt id=hl-46-13><a class=lnlinks href=#hl-46-13>13</a>
</span><span class=lnt id=hl-46-14><a class=lnlinks href=#hl-46-14>14</a>
</span><span class=lnt id=hl-46-15><a class=lnlinks href=#hl-46-15>15</a>
</span><span class=lnt id=hl-46-16><a class=lnlinks href=#hl-46-16>16</a>
</span><span class=lnt id=hl-46-17><a class=lnlinks href=#hl-46-17>17</a>
</span><span class=lnt id=hl-46-18><a class=lnlinks href=#hl-46-18>18</a>
</span><span class=lnt id=hl-46-19><a class=lnlinks href=#hl-46-19>19</a>
</span><span class=lnt id=hl-46-20><a class=lnlinks href=#hl-46-20>20</a>
</span><span class=lnt id=hl-46-21><a class=lnlinks href=#hl-46-21>21</a>
</span><span class=lnt id=hl-46-22><a class=lnlinks href=#hl-46-22>22</a>
</span><span class=lnt id=hl-46-23><a class=lnlinks href=#hl-46-23>23</a>
</span><span class=lnt id=hl-46-24><a class=lnlinks href=#hl-46-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.TestYield&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestYield</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Runnable</span><span class=w> </span><span class=n>task1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;----&gt;1 &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=o>++</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Runnable</span><span class=w> </span><span class=n>task2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                Thread.yield();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;              ----&gt;2 &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=o>++</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>task1</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>task2</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>setPriority</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>MIN_PRIORITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>setPriority</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>MAX_PRIORITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•ç»“æœï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-47-1><a class=lnlinks href=#hl-47-1>1</a>
</span><span class=lnt id=hl-47-2><a class=lnlinks href=#hl-47-2>2</a>
</span><span class=lnt id=hl-47-3><a class=lnlinks href=#hl-47-3>3</a>
</span><span class=lnt id=hl-47-4><a class=lnlinks href=#hl-47-4>4</a>
</span><span class=lnt id=hl-47-5><a class=lnlinks href=#hl-47-5>5</a>
</span><span class=lnt id=hl-47-6><a class=lnlinks href=#hl-47-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1>#ä¼˜å…ˆçº§</span>
</span></span><span class=line><span class=cl>----&gt;1 <span class=m>283500</span>
</span></span><span class=line><span class=cl>----&gt;2 <span class=m>374389</span>
</span></span><span class=line><span class=cl><span class=c1>#yield</span>
</span></span><span class=line><span class=cl>----&gt;1 <span class=m>119199</span>
</span></span><span class=line><span class=cl>----&gt;2 <span class=m>101074</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹å‡ºï¼Œçº¿ç¨‹ä¼˜å…ˆçº§å’Œyieldä¼šå¯¹çº¿ç¨‹è·å–cpuæ—¶é—´ç‰‡äº§ç”Ÿä¸€å®šå½±å“ï¼Œä½†ä¸ä¼šå½±å“å¤ªå¤§ã€‚</p><h3 id=textcolorgreen-åº”ç”¨ä¹‹é™åˆ¶æ¡ˆä¾‹1--><a href=#textcolorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e9%99%90%e5%88%b6%e6%a1%88%e4%be%8b1-- class=header-anchor>#</a>
$\textcolor{Green}{* åº”ç”¨ä¹‹é™åˆ¶ï¼ˆæ¡ˆä¾‹1ï¼‰ } $</h3><h4 id=sleep-å®ç°><a href=#sleep-%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
sleep å®ç°</h4><p>åœ¨æ²¡æœ‰åˆ©ç”¨ cpu æ¥è®¡ç®—æ—¶ï¼Œä¸è¦è®© while(true) ç©ºè½¬æµªè´¹ cpuï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ yield æˆ– sleep æ¥è®©å‡º cpu çš„ä½¿ç”¨æƒ ç»™å…¶ä»–ç¨‹åº</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-48-1><a class=lnlinks href=#hl-48-1>1</a>
</span><span class=lnt id=hl-48-2><a class=lnlinks href=#hl-48-2>2</a>
</span><span class=lnt id=hl-48-3><a class=lnlinks href=#hl-48-3>3</a>
</span><span class=lnt id=hl-48-4><a class=lnlinks href=#hl-48-4>4</a>
</span><span class=lnt id=hl-48-5><a class=lnlinks href=#hl-48-5>5</a>
</span><span class=lnt id=hl-48-6><a class=lnlinks href=#hl-48-6>6</a>
</span><span class=lnt id=hl-48-7><a class=lnlinks href=#hl-48-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>50</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å¯ä»¥ç”¨ wait æˆ– æ¡ä»¶å˜é‡è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœ</li><li>ä¸åŒçš„æ˜¯ï¼Œåä¸¤ç§éƒ½éœ€è¦åŠ é”ï¼Œå¹¶ä¸”éœ€è¦ç›¸åº”çš„å”¤é†’æ“ä½œï¼Œä¸€èˆ¬é€‚ç”¨äºè¦è¿›è¡ŒåŒæ­¥çš„åœºæ™¯</li><li>sleep é€‚ç”¨äºæ— éœ€é”åŒæ­¥çš„åœºæ™¯</li></ul><h4 id=wait-å®ç°><a href=#wait-%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
wait å®ç°</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-49-1><a class=lnlinks href=#hl-49-1> 1</a>
</span><span class=lnt id=hl-49-2><a class=lnlinks href=#hl-49-2> 2</a>
</span><span class=lnt id=hl-49-3><a class=lnlinks href=#hl-49-3> 3</a>
</span><span class=lnt id=hl-49-4><a class=lnlinks href=#hl-49-4> 4</a>
</span><span class=lnt id=hl-49-5><a class=lnlinks href=#hl-49-5> 5</a>
</span><span class=lnt id=hl-49-6><a class=lnlinks href=#hl-49-6> 6</a>
</span><span class=lnt id=hl-49-7><a class=lnlinks href=#hl-49-7> 7</a>
</span><span class=lnt id=hl-49-8><a class=lnlinks href=#hl-49-8> 8</a>
</span><span class=lnt id=hl-49-9><a class=lnlinks href=#hl-49-9> 9</a>
</span><span class=lnt id=hl-49-10><a class=lnlinks href=#hl-49-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>synchronized</span><span class=p>(</span><span class=n>é”å¯¹è±¡</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>æ¡ä»¶ä¸æ»¡è¶³</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>é”å¯¹è±¡</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// do sth...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=æ¡ä»¶å˜é‡å®ç°><a href=#%e6%9d%a1%e4%bb%b6%e5%8f%98%e9%87%8f%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
æ¡ä»¶å˜é‡å®ç°</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-50-1><a class=lnlinks href=#hl-50-1> 1</a>
</span><span class=lnt id=hl-50-2><a class=lnlinks href=#hl-50-2> 2</a>
</span><span class=lnt id=hl-50-3><a class=lnlinks href=#hl-50-3> 3</a>
</span><span class=lnt id=hl-50-4><a class=lnlinks href=#hl-50-4> 4</a>
</span><span class=lnt id=hl-50-5><a class=lnlinks href=#hl-50-5> 5</a>
</span><span class=lnt id=hl-50-6><a class=lnlinks href=#hl-50-6> 6</a>
</span><span class=lnt id=hl-50-7><a class=lnlinks href=#hl-50-7> 7</a>
</span><span class=lnt id=hl-50-8><a class=lnlinks href=#hl-50-8> 8</a>
</span><span class=lnt id=hl-50-9><a class=lnlinks href=#hl-50-9> 9</a>
</span><span class=lnt id=hl-50-10><a class=lnlinks href=#hl-50-10>10</a>
</span><span class=lnt id=hl-50-11><a class=lnlinks href=#hl-50-11>11</a>
</span><span class=lnt id=hl-50-12><a class=lnlinks href=#hl-50-12>12</a>
</span><span class=lnt id=hl-50-13><a class=lnlinks href=#hl-50-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>æ¡ä»¶ä¸æ»¡è¶³</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>æ¡ä»¶å˜é‡</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// do sth...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=38-join-æ–¹æ³•è¯¦è§£><a href=#38-join-%e6%96%b9%e6%b3%95%e8%af%a6%e8%a7%a3 class=header-anchor>#</a>
3.8 join æ–¹æ³•è¯¦è§£</h2><h3 id=ä¸ºä»€ä¹ˆéœ€è¦-join><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81-join class=header-anchor>#</a>
ä¸ºä»€ä¹ˆéœ€è¦ join</h3><p>ä¸‹é¢çš„ä»£ç æ‰§è¡Œï¼Œæ‰“å° r æ˜¯ä»€ä¹ˆï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-51-1><a class=lnlinks href=#hl-51-1> 1</a>
</span><span class=lnt id=hl-51-2><a class=lnlinks href=#hl-51-2> 2</a>
</span><span class=lnt id=hl-51-3><a class=lnlinks href=#hl-51-3> 3</a>
</span><span class=lnt id=hl-51-4><a class=lnlinks href=#hl-51-4> 4</a>
</span><span class=lnt id=hl-51-5><a class=lnlinks href=#hl-51-5> 5</a>
</span><span class=lnt id=hl-51-6><a class=lnlinks href=#hl-51-6> 6</a>
</span><span class=lnt id=hl-51-7><a class=lnlinks href=#hl-51-7> 7</a>
</span><span class=lnt id=hl-51-8><a class=lnlinks href=#hl-51-8> 8</a>
</span><span class=lnt id=hl-51-9><a class=lnlinks href=#hl-51-9> 9</a>
</span><span class=lnt id=hl-51-10><a class=lnlinks href=#hl-51-10>10</a>
</span><span class=lnt id=hl-51-11><a class=lnlinks href=#hl-51-11>11</a>
</span><span class=lnt id=hl-51-12><a class=lnlinks href=#hl-51-12>12</a>
</span><span class=lnt id=hl-51-13><a class=lnlinks href=#hl-51-13>13</a>
</span><span class=lnt id=hl-51-14><a class=lnlinks href=#hl-51-14>14</a>
</span><span class=lnt id=hl-51-15><a class=lnlinks href=#hl-51-15>15</a>
</span><span class=lnt id=hl-51-16><a class=lnlinks href=#hl-51-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>test1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æœä¸º:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åˆ†æ</p><ul><li>å› ä¸ºä¸»çº¿ç¨‹å’Œçº¿ç¨‹ t1 æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œt1 çº¿ç¨‹éœ€è¦ 1 ç§’ä¹‹åæ‰èƒ½ç®—å‡º r=10</li><li>è€Œä¸»çº¿ç¨‹ä¸€å¼€å§‹å°±è¦æ‰“å° r çš„ç»“æœï¼Œæ‰€ä»¥åªèƒ½æ‰“å°å‡º r=0</li></ul><p>è§£å†³æ–¹æ³•</p><ul><li>ç”¨ sleep è¡Œä¸è¡Œï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</li><li>ç”¨ joinï¼ŒåŠ åœ¨ t1.start() ä¹‹åå³å¯</li></ul><h3 id=textcolorgreen-åº”ç”¨ä¹‹åŒæ­¥æ¡ˆä¾‹1><a href=#textcolorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e5%90%8c%e6%ad%a5%e6%a1%88%e4%be%8b1 class=header-anchor>#</a>
$\textcolor{green}{* åº”ç”¨ä¹‹åŒæ­¥ï¼ˆæ¡ˆä¾‹1ï¼‰}$</h3><p>ä»¥è°ƒç”¨æ–¹è§’åº¦æ¥è®²ï¼Œå¦‚æœ</p><ul><li>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥</li><li>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220224020718153.png width=900 height=600 loading=lazy decoding=async alt=image-20220224020718153 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>ç­‰å¾…å¤šä¸ªç»“æœ</strong></p><p>é—®ï¼Œä¸‹é¢ä»£ç  cost å¤§çº¦å¤šå°‘ç§’ï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-52-1><a class=lnlinks href=#hl-52-1> 1</a>
</span><span class=lnt id=hl-52-2><a class=lnlinks href=#hl-52-2> 2</a>
</span><span class=lnt id=hl-52-3><a class=lnlinks href=#hl-52-3> 3</a>
</span><span class=lnt id=hl-52-4><a class=lnlinks href=#hl-52-4> 4</a>
</span><span class=lnt id=hl-52-5><a class=lnlinks href=#hl-52-5> 5</a>
</span><span class=lnt id=hl-52-6><a class=lnlinks href=#hl-52-6> 6</a>
</span><span class=lnt id=hl-52-7><a class=lnlinks href=#hl-52-7> 7</a>
</span><span class=lnt id=hl-52-8><a class=lnlinks href=#hl-52-8> 8</a>
</span><span class=lnt id=hl-52-9><a class=lnlinks href=#hl-52-9> 9</a>
</span><span class=lnt id=hl-52-10><a class=lnlinks href=#hl-52-10>10</a>
</span><span class=lnt id=hl-52-11><a class=lnlinks href=#hl-52-11>11</a>
</span><span class=lnt id=hl-52-12><a class=lnlinks href=#hl-52-12>12</a>
</span><span class=lnt id=hl-52-13><a class=lnlinks href=#hl-52-13>13</a>
</span><span class=lnt id=hl-52-14><a class=lnlinks href=#hl-52-14>14</a>
</span><span class=lnt id=hl-52-15><a class=lnlinks href=#hl-52-15>15</a>
</span><span class=lnt id=hl-52-16><a class=lnlinks href=#hl-52-16>16</a>
</span><span class=lnt id=hl-52-17><a class=lnlinks href=#hl-52-17>17</a>
</span><span class=lnt id=hl-52-18><a class=lnlinks href=#hl-52-18>18</a>
</span><span class=lnt id=hl-52-19><a class=lnlinks href=#hl-52-19>19</a>
</span><span class=lnt id=hl-52-20><a class=lnlinks href=#hl-52-20>20</a>
</span><span class=lnt id=hl-52-21><a class=lnlinks href=#hl-52-21>21</a>
</span><span class=lnt id=hl-52-22><a class=lnlinks href=#hl-52-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>test2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;r1: {} r2: {} cost: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>  
</span></span></span></code></pre></td></tr></table></div></div><p>åˆ†æå¦‚ä¸‹</p><ul><li>ç¬¬ä¸€ä¸ª joinï¼šç­‰å¾… t1 æ—¶, t2 å¹¶æ²¡æœ‰åœæ­¢, è€Œåœ¨è¿è¡Œ</li><li>ç¬¬äºŒä¸ª joinï¼š1s å, æ‰§è¡Œåˆ°æ­¤, t2 ä¹Ÿè¿è¡Œäº† 1s, å› æ­¤ä¹Ÿåªéœ€å†ç­‰å¾… 1s</li></ul><p>å¦‚æœé¢ å€’ä¸¤ä¸ª join å‘¢ï¼Ÿ</p><p>æœ€ç»ˆéƒ½æ˜¯è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-53-1><a class=lnlinks href=#hl-53-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:45:43.239 <span class=o>[</span>main<span class=o>]</span> c.TestJoin - r1: <span class=m>10</span> r2: <span class=m>20</span> cost: <span class=m>2005</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220224020847406.png width=900 height=600 loading=lazy decoding=async alt=image-20220224020847406 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h3 id=æœ‰æ—¶æ•ˆçš„join><a href=#%e6%9c%89%e6%97%b6%e6%95%88%e7%9a%84join class=header-anchor>#</a>
æœ‰æ—¶æ•ˆçš„join</h3><p>å½“çº¿ç¨‹æ‰§è¡Œæ—¶é—´æ²¡æœ‰è¶…è¿‡joinè®¾å®šæ—¶é—´</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-54-1><a class=lnlinks href=#hl-54-1> 1</a>
</span><span class=lnt id=hl-54-2><a class=lnlinks href=#hl-54-2> 2</a>
</span><span class=lnt id=hl-54-3><a class=lnlinks href=#hl-54-3> 3</a>
</span><span class=lnt id=hl-54-4><a class=lnlinks href=#hl-54-4> 4</a>
</span><span class=lnt id=hl-54-5><a class=lnlinks href=#hl-54-5> 5</a>
</span><span class=lnt id=hl-54-6><a class=lnlinks href=#hl-54-6> 6</a>
</span><span class=lnt id=hl-54-7><a class=lnlinks href=#hl-54-7> 7</a>
</span><span class=lnt id=hl-54-8><a class=lnlinks href=#hl-54-8> 8</a>
</span><span class=lnt id=hl-54-9><a class=lnlinks href=#hl-54-9> 9</a>
</span><span class=lnt id=hl-54-10><a class=lnlinks href=#hl-54-10>10</a>
</span><span class=lnt id=hl-54-11><a class=lnlinks href=#hl-54-11>11</a>
</span><span class=lnt id=hl-54-12><a class=lnlinks href=#hl-54-12>12</a>
</span><span class=lnt id=hl-54-13><a class=lnlinks href=#hl-54-13>13</a>
</span><span class=lnt id=hl-54-14><a class=lnlinks href=#hl-54-14>14</a>
</span><span class=lnt id=hl-54-15><a class=lnlinks href=#hl-54-15>15</a>
</span><span class=lnt id=hl-54-16><a class=lnlinks href=#hl-54-16>16</a>
</span><span class=lnt id=hl-54-17><a class=lnlinks href=#hl-54-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>test3</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// çº¿ç¨‹æ‰§è¡Œç»“æŸä¼šå¯¼è‡´ join ç»“æŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>1500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;r1: {} r2: {} cost: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-55-1><a class=lnlinks href=#hl-55-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:48:01.320 <span class=o>[</span>main<span class=o>]</span> c.TestJoin - r1: <span class=m>10</span> r2: <span class=m>0</span> cost: <span class=m>1010</span>
</span></span></code></pre></td></tr></table></div></div><p>å½“æ‰§è¡Œæ—¶é—´è¶…æ—¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-56-1><a class=lnlinks href=#hl-56-1> 1</a>
</span><span class=lnt id=hl-56-2><a class=lnlinks href=#hl-56-2> 2</a>
</span><span class=lnt id=hl-56-3><a class=lnlinks href=#hl-56-3> 3</a>
</span><span class=lnt id=hl-56-4><a class=lnlinks href=#hl-56-4> 4</a>
</span><span class=lnt id=hl-56-5><a class=lnlinks href=#hl-56-5> 5</a>
</span><span class=lnt id=hl-56-6><a class=lnlinks href=#hl-56-6> 6</a>
</span><span class=lnt id=hl-56-7><a class=lnlinks href=#hl-56-7> 7</a>
</span><span class=lnt id=hl-56-8><a class=lnlinks href=#hl-56-8> 8</a>
</span><span class=lnt id=hl-56-9><a class=lnlinks href=#hl-56-9> 9</a>
</span><span class=lnt id=hl-56-10><a class=lnlinks href=#hl-56-10>10</a>
</span><span class=lnt id=hl-56-11><a class=lnlinks href=#hl-56-11>11</a>
</span><span class=lnt id=hl-56-12><a class=lnlinks href=#hl-56-12>12</a>
</span><span class=lnt id=hl-56-13><a class=lnlinks href=#hl-56-13>13</a>
</span><span class=lnt id=hl-56-14><a class=lnlinks href=#hl-56-14>14</a>
</span><span class=lnt id=hl-56-15><a class=lnlinks href=#hl-56-15>15</a>
</span><span class=lnt id=hl-56-16><a class=lnlinks href=#hl-56-16>16</a>
</span><span class=lnt id=hl-56-17><a class=lnlinks href=#hl-56-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>test3</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// çº¿ç¨‹æ‰§è¡Œç»“æŸä¼šå¯¼è‡´ join ç»“æŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>1500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;r1: {} r2: {} cost: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-57-1><a class=lnlinks href=#hl-57-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:52:15.623 <span class=o>[</span>main<span class=o>]</span> c.TestJoin - r1: <span class=m>0</span> r2: <span class=m>0</span> cost: <span class=m>1502</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=39-interruptæ–¹æ³•è¯¦è§£><a href=#39-interrupt%e6%96%b9%e6%b3%95%e8%af%a6%e8%a7%a3 class=header-anchor>#</a>
3.9 interruptæ–¹æ³•è¯¦è§£</h2><h3 id=interruptè¯´æ˜><a href=#interrupt%e8%af%b4%e6%98%8e class=header-anchor>#</a>
<code>Interrupt</code>è¯´æ˜</h3><p><code>interrupt</code>çš„æœ¬è´¨æ˜¯å°†çº¿ç¨‹çš„æ‰“æ–­æ ‡è®°è®¾ä¸ºtrueï¼Œå¹¶è°ƒç”¨çº¿ç¨‹çš„ä¸‰ä¸ªparkerå¯¹è±¡ï¼ˆC++å®ç°çº§åˆ«ï¼‰unparkè¯¥çº¿ç¨‹ã€‚</p><p>åŸºäºä»¥ä¸Šæœ¬è´¨ï¼Œæœ‰å¦‚ä¸‹è¯´æ˜ï¼š</p><ul><li>æ‰“æ–­çº¿ç¨‹ä¸ç­‰äºä¸­æ–­çº¿ç¨‹ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š<ul><li>æ‰“æ–­æ­£åœ¨è¿è¡Œä¸­çš„çº¿ç¨‹å¹¶ä¸ä¼šå½±å“çº¿ç¨‹çš„è¿è¡Œï¼Œä½†å¦‚æœçº¿ç¨‹ç›‘æµ‹åˆ°äº†æ‰“æ–­æ ‡è®°ä¸ºtrueï¼Œå¯ä»¥è‡ªè¡Œå†³å®šåç»­å¤„ç†ã€‚</li><li>æ‰“æ–­é˜»å¡ä¸­çš„çº¿ç¨‹ä¼šè®©æ­¤çº¿ç¨‹äº§ç”Ÿä¸€ä¸ª<code>InterruptedException</code>å¼‚å¸¸ï¼Œç»“æŸçº¿ç¨‹çš„è¿è¡Œã€‚ä½†å¦‚æœè¯¥å¼‚å¸¸è¢«çº¿ç¨‹æ•è·ä½ï¼Œè¯¥çº¿ç¨‹ä¾ç„¶å¯ä»¥è‡ªè¡Œå†³å®šåç»­å¤„ç†ï¼ˆç»ˆæ­¢è¿è¡Œï¼Œç»§ç»­è¿è¡Œï¼Œåšä¸€äº›å–„åå·¥ä½œç­‰ç­‰ï¼‰</li></ul></li></ul><h3 id=æ‰“æ–­-sleepwaitjoin-çš„çº¿ç¨‹><a href=#%e6%89%93%e6%96%ad-sleepwaitjoin-%e7%9a%84%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
æ‰“æ–­ sleepï¼Œwaitï¼Œjoin çš„çº¿ç¨‹</h3><p>è¿™å‡ ä¸ªæ–¹æ³•éƒ½ä¼šè®©çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€</p><p>æ‰“æ–­ sleep çš„çº¿ç¨‹, ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ï¼Œä»¥ sleep ä¸ºä¾‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-58-1><a class=lnlinks href=#hl-58-1>1</a>
</span><span class=lnt id=hl-58-2><a class=lnlinks href=#hl-58-2>2</a>
</span><span class=lnt id=hl-58-3><a class=lnlinks href=#hl-58-3>3</a>
</span><span class=lnt id=hl-58-4><a class=lnlinks href=#hl-58-4>4</a>
</span><span class=lnt id=hl-58-5><a class=lnlinks href=#hl-58-5>5</a>
</span><span class=lnt id=hl-58-6><a class=lnlinks href=#hl-58-6>6</a>
</span><span class=lnt id=hl-58-7><a class=lnlinks href=#hl-58-7>7</a>
</span><span class=lnt id=hl-58-8><a class=lnlinks href=#hl-58-8>8</a>
</span><span class=lnt id=hl-58-9><a class=lnlinks href=#hl-58-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34; æ‰“æ–­çŠ¶æ€: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>.</span><span class=na>isInterrupted</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-59-1><a class=lnlinks href=#hl-59-1>1</a>
</span><span class=lnt id=hl-59-2><a class=lnlinks href=#hl-59-2>2</a>
</span><span class=lnt id=hl-59-3><a class=lnlinks href=#hl-59-3>3</a>
</span><span class=lnt id=hl-59-4><a class=lnlinks href=#hl-59-4>4</a>
</span><span class=lnt id=hl-59-5><a class=lnlinks href=#hl-59-5>5</a>
</span><span class=lnt id=hl-59-6><a class=lnlinks href=#hl-59-6>6</a>
</span><span class=lnt id=hl-59-7><a class=lnlinks href=#hl-59-7>7</a>
</span><span class=lnt id=hl-59-8><a class=lnlinks href=#hl-59-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>java.lang.InterruptedException: sleep interrupted
</span></span><span class=line><span class=cl> at java.lang.Thread.sleep<span class=o>(</span>Native Method<span class=o>)</span>
</span></span><span class=line><span class=cl> at java.lang.Thread.sleep<span class=o>(</span>Thread.java:340<span class=o>)</span>
</span></span><span class=line><span class=cl> at java.util.concurrent.TimeUnit.sleep<span class=o>(</span>TimeUnit.java:386<span class=o>)</span>
</span></span><span class=line><span class=cl> at cn.itcast.n2.util.Sleeper.sleep<span class=o>(</span>Sleeper.java:8<span class=o>)</span>
</span></span><span class=line><span class=cl> at cn.itcast.n4.TestInterrupt.lambda<span class=nv>$test1$3</span><span class=o>(</span>TestInterrupt.java:59<span class=o>)</span>
</span></span><span class=line><span class=cl> at java.lang.Thread.run<span class=o>(</span>Thread.java:745<span class=o>)</span>
</span></span><span class=line><span class=cl>21:18:10.374 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - æ‰“æ–­çŠ¶æ€: <span class=nb>false</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹><a href=#%e6%89%93%e6%96%ad%e6%ad%a3%e5%b8%b8%e8%bf%90%e8%a1%8c%e7%9a%84%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹</h3><p>æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹, ä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-60-1><a class=lnlinks href=#hl-60-1> 1</a>
</span><span class=lnt id=hl-60-2><a class=lnlinks href=#hl-60-2> 2</a>
</span><span class=lnt id=hl-60-3><a class=lnlinks href=#hl-60-3> 3</a>
</span><span class=lnt id=hl-60-4><a class=lnlinks href=#hl-60-4> 4</a>
</span><span class=lnt id=hl-60-5><a class=lnlinks href=#hl-60-5> 5</a>
</span><span class=lnt id=hl-60-6><a class=lnlinks href=#hl-60-6> 6</a>
</span><span class=lnt id=hl-60-7><a class=lnlinks href=#hl-60-7> 7</a>
</span><span class=lnt id=hl-60-8><a class=lnlinks href=#hl-60-8> 8</a>
</span><span class=lnt id=hl-60-9><a class=lnlinks href=#hl-60-9> 9</a>
</span><span class=lnt id=hl-60-10><a class=lnlinks href=#hl-60-10>10</a>
</span><span class=lnt id=hl-60-11><a class=lnlinks href=#hl-60-11>11</a>
</span><span class=lnt id=hl-60-12><a class=lnlinks href=#hl-60-12>12</a>
</span><span class=lnt id=hl-60-13><a class=lnlinks href=#hl-60-13>13</a>
</span><span class=lnt id=hl-60-14><a class=lnlinks href=#hl-60-14>14</a>
</span><span class=lnt id=hl-60-15><a class=lnlinks href=#hl-60-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>current</span><span class=p>.</span><span class=na>isInterrupted</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>interrupted</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34; æ‰“æ–­çŠ¶æ€: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>interrupted</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-61-1><a class=lnlinks href=#hl-61-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:57:37.964 <span class=o>[</span>t2<span class=o>]</span> c.TestInterrupt - æ‰“æ–­çŠ¶æ€: <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=font-colororange-æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢font><a href=#font-colororange-%e6%a8%a1%e5%bc%8f%e4%b9%8b%e4%b8%a4%e9%98%b6%e6%ae%b5%e7%bb%88%e6%ad%a2font class=header-anchor>#</a>
<font color=orange>* æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢</font></h3><p>Two Phase Termination åœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•â€œä¼˜é›…â€ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿè¿™é‡Œçš„ã€ä¼˜é›…ã€‘æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼šã€‚</p><h4 id=é”™è¯¯æ€è·¯><a href=#%e9%94%99%e8%af%af%e6%80%9d%e8%b7%af class=header-anchor>#</a>
é”™è¯¯æ€è·¯</h4><ul><li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹<ul><li>stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œ å…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”</li></ul></li><li>ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹<ul><li>ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢</li></ul></li></ul><h4 id=ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼><a href=#%e4%b8%a4%e9%98%b6%e6%ae%b5%e7%bb%88%e6%ad%a2%e6%a8%a1%e5%bc%8f class=header-anchor>#</a>
ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</h4><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317193331864.png width=900 height=600 loading=lazy decoding=async alt=image-20220317193331864 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=åˆ©ç”¨-isinterrupted><a href=#%e5%88%a9%e7%94%a8-isinterrupted class=header-anchor>#</a>
åˆ©ç”¨ isInterrupted</h5><p>interrupt å¯ä»¥æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œæ— è®ºè¿™ä¸ªçº¿ç¨‹æ˜¯åœ¨ sleepï¼Œwaitï¼Œè¿˜æ˜¯æ­£å¸¸è¿è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-62-1><a class=lnlinks href=#hl-62-1> 1</a>
</span><span class=lnt id=hl-62-2><a class=lnlinks href=#hl-62-2> 2</a>
</span><span class=lnt id=hl-62-3><a class=lnlinks href=#hl-62-3> 3</a>
</span><span class=lnt id=hl-62-4><a class=lnlinks href=#hl-62-4> 4</a>
</span><span class=lnt id=hl-62-5><a class=lnlinks href=#hl-62-5> 5</a>
</span><span class=lnt id=hl-62-6><a class=lnlinks href=#hl-62-6> 6</a>
</span><span class=lnt id=hl-62-7><a class=lnlinks href=#hl-62-7> 7</a>
</span><span class=lnt id=hl-62-8><a class=lnlinks href=#hl-62-8> 8</a>
</span><span class=lnt id=hl-62-9><a class=lnlinks href=#hl-62-9> 9</a>
</span><span class=lnt id=hl-62-10><a class=lnlinks href=#hl-62-10>10</a>
</span><span class=lnt id=hl-62-11><a class=lnlinks href=#hl-62-11>11</a>
</span><span class=lnt id=hl-62-12><a class=lnlinks href=#hl-62-12>12</a>
</span><span class=lnt id=hl-62-13><a class=lnlinks href=#hl-62-13>13</a>
</span><span class=lnt id=hl-62-14><a class=lnlinks href=#hl-62-14>14</a>
</span><span class=lnt id=hl-62-15><a class=lnlinks href=#hl-62-15>15</a>
</span><span class=lnt id=hl-62-16><a class=lnlinks href=#hl-62-16>16</a>
</span><span class=lnt id=hl-62-17><a class=lnlinks href=#hl-62-17>17</a>
</span><span class=lnt id=hl-62-18><a class=lnlinks href=#hl-62-18>18</a>
</span><span class=lnt id=hl-62-19><a class=lnlinks href=#hl-62-19>19</a>
</span><span class=lnt id=hl-62-20><a class=lnlinks href=#hl-62-20>20</a>
</span><span class=lnt id=hl-62-21><a class=lnlinks href=#hl-62-21>21</a>
</span><span class=lnt id=hl-62-22><a class=lnlinks href=#hl-62-22>22</a>
</span><span class=lnt id=hl-62-23><a class=lnlinks href=#hl-62-23>23</a>
</span><span class=lnt id=hl-62-24><a class=lnlinks href=#hl-62-24>24</a>
</span><span class=lnt id=hl-62-25><a class=lnlinks href=#hl-62-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>TPTInterrupt</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>current</span><span class=p>.</span><span class=na>isInterrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ–™ç†åäº‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å°†ç»“æœä¿å­˜&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>current</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ‰§è¡Œç›‘æ§æ“ä½œ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;ç›‘æ§çº¿ç¨‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è°ƒç”¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-63-1><a class=lnlinks href=#hl-63-1>1</a>
</span><span class=lnt id=hl-63-2><a class=lnlinks href=#hl-63-2>2</a>
</span><span class=lnt id=hl-63-3><a class=lnlinks href=#hl-63-3>3</a>
</span><span class=lnt id=hl-63-4><a class=lnlinks href=#hl-63-4>4</a>
</span><span class=lnt id=hl-63-5><a class=lnlinks href=#hl-63-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TPTInterrupt</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TPTInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>3500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;stop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-64-1><a class=lnlinks href=#hl-64-1>1</a>
</span><span class=lnt id=hl-64-2><a class=lnlinks href=#hl-64-2>2</a>
</span><span class=lnt id=hl-64-3><a class=lnlinks href=#hl-64-3>3</a>
</span><span class=lnt id=hl-64-4><a class=lnlinks href=#hl-64-4>4</a>
</span><span class=lnt id=hl-64-5><a class=lnlinks href=#hl-64-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:49:42.915 c.TwoPhaseTermination <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:49:43.919 c.TwoPhaseTermination <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:49:44.919 c.TwoPhaseTermination <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:49:45.413 c.TestTwoPhaseTermination <span class=o>[</span>main<span class=o>]</span> - stop 
</span></span><span class=line><span class=cl>11:49:45.413 c.TwoPhaseTermination <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - æ–™ç†åäº‹
</span></span></code></pre></td></tr></table></div></div><h5 id=åˆ©ç”¨åœæ­¢æ ‡è®°><a href=#%e5%88%a9%e7%94%a8%e5%81%9c%e6%ad%a2%e6%a0%87%e8%ae%b0 class=header-anchor>#</a>
åˆ©ç”¨åœæ­¢æ ‡è®°</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-65-1><a class=lnlinks href=#hl-65-1> 1</a>
</span><span class=lnt id=hl-65-2><a class=lnlinks href=#hl-65-2> 2</a>
</span><span class=lnt id=hl-65-3><a class=lnlinks href=#hl-65-3> 3</a>
</span><span class=lnt id=hl-65-4><a class=lnlinks href=#hl-65-4> 4</a>
</span><span class=lnt id=hl-65-5><a class=lnlinks href=#hl-65-5> 5</a>
</span><span class=lnt id=hl-65-6><a class=lnlinks href=#hl-65-6> 6</a>
</span><span class=lnt id=hl-65-7><a class=lnlinks href=#hl-65-7> 7</a>
</span><span class=lnt id=hl-65-8><a class=lnlinks href=#hl-65-8> 8</a>
</span><span class=lnt id=hl-65-9><a class=lnlinks href=#hl-65-9> 9</a>
</span><span class=lnt id=hl-65-10><a class=lnlinks href=#hl-65-10>10</a>
</span><span class=lnt id=hl-65-11><a class=lnlinks href=#hl-65-11>11</a>
</span><span class=lnt id=hl-65-12><a class=lnlinks href=#hl-65-12>12</a>
</span><span class=lnt id=hl-65-13><a class=lnlinks href=#hl-65-13>13</a>
</span><span class=lnt id=hl-65-14><a class=lnlinks href=#hl-65-14>14</a>
</span><span class=lnt id=hl-65-15><a class=lnlinks href=#hl-65-15>15</a>
</span><span class=lnt id=hl-65-16><a class=lnlinks href=#hl-65-16>16</a>
</span><span class=lnt id=hl-65-17><a class=lnlinks href=#hl-65-17>17</a>
</span><span class=lnt id=hl-65-18><a class=lnlinks href=#hl-65-18>18</a>
</span><span class=lnt id=hl-65-19><a class=lnlinks href=#hl-65-19>19</a>
</span><span class=lnt id=hl-65-20><a class=lnlinks href=#hl-65-20>20</a>
</span><span class=lnt id=hl-65-21><a class=lnlinks href=#hl-65-21>21</a>
</span><span class=lnt id=hl-65-22><a class=lnlinks href=#hl-65-22>22</a>
</span><span class=lnt id=hl-65-23><a class=lnlinks href=#hl-65-23>23</a>
</span><span class=lnt id=hl-65-24><a class=lnlinks href=#hl-65-24>24</a>
</span><span class=lnt id=hl-65-25><a class=lnlinks href=#hl-65-25>25</a>
</span><span class=lnt id=hl-65-26><a class=lnlinks href=#hl-65-26>26</a>
</span><span class=lnt id=hl-65-27><a class=lnlinks href=#hl-65-27>27</a>
</span><span class=lnt id=hl-65-28><a class=lnlinks href=#hl-65-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœæ­¢æ ‡è®°ç”¨ volatile æ˜¯ä¸ºäº†ä¿è¯è¯¥å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå³ä¸»çº¿ç¨‹æŠŠå®ƒä¿®æ”¹ä¸º true å¯¹ t1 çº¿ç¨‹å¯è§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>TPTVolatile</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>stop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>stop</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ–™ç†åäº‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å°†ç»“æœä¿å­˜&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ‰§è¡Œç›‘æ§æ“ä½œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;ç›‘æ§çº¿ç¨‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è°ƒç”¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-66-1><a class=lnlinks href=#hl-66-1>1</a>
</span><span class=lnt id=hl-66-2><a class=lnlinks href=#hl-66-2>2</a>
</span><span class=lnt id=hl-66-3><a class=lnlinks href=#hl-66-3>3</a>
</span><span class=lnt id=hl-66-4><a class=lnlinks href=#hl-66-4>4</a>
</span><span class=lnt id=hl-66-5><a class=lnlinks href=#hl-66-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TPTVolatile</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TPTVolatile</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>3500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;stop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-67-1><a class=lnlinks href=#hl-67-1>1</a>
</span><span class=lnt id=hl-67-2><a class=lnlinks href=#hl-67-2>2</a>
</span><span class=lnt id=hl-67-3><a class=lnlinks href=#hl-67-3>3</a>
</span><span class=lnt id=hl-67-4><a class=lnlinks href=#hl-67-4>4</a>
</span><span class=lnt id=hl-67-5><a class=lnlinks href=#hl-67-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:54:52.003 c.TPTVolatile <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:54:53.006 c.TPTVolatile <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:54:54.007 c.TPTVolatile <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:54:54.502 c.TestTwoPhaseTermination <span class=o>[</span>main<span class=o>]</span> - stop 
</span></span><span class=line><span class=cl>11:54:54.502 c.TPTVolatile <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - æ–™ç†åäº‹
</span></span></code></pre></td></tr></table></div></div><h3 id=æ‰“æ–­-park-çº¿ç¨‹><a href=#%e6%89%93%e6%96%ad-park-%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
æ‰“æ–­ park çº¿ç¨‹</h3><p>æ‰“æ–­ park çº¿ç¨‹, ä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-68-1><a class=lnlinks href=#hl-68-1> 1</a>
</span><span class=lnt id=hl-68-2><a class=lnlinks href=#hl-68-2> 2</a>
</span><span class=lnt id=hl-68-3><a class=lnlinks href=#hl-68-3> 3</a>
</span><span class=lnt id=hl-68-4><a class=lnlinks href=#hl-68-4> 4</a>
</span><span class=lnt id=hl-68-5><a class=lnlinks href=#hl-68-5> 5</a>
</span><span class=lnt id=hl-68-6><a class=lnlinks href=#hl-68-6> 6</a>
</span><span class=lnt id=hl-68-7><a class=lnlinks href=#hl-68-7> 7</a>
</span><span class=lnt id=hl-68-8><a class=lnlinks href=#hl-68-8> 8</a>
</span><span class=lnt id=hl-68-9><a class=lnlinks href=#hl-68-9> 9</a>
</span><span class=lnt id=hl-68-10><a class=lnlinks href=#hl-68-10>10</a>
</span><span class=lnt id=hl-68-11><a class=lnlinks href=#hl-68-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;park...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unpark...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‰“æ–­çŠ¶æ€ï¼š{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>isInterrupted</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-69-1><a class=lnlinks href=#hl-69-1>1</a>
</span><span class=lnt id=hl-69-2><a class=lnlinks href=#hl-69-2>2</a>
</span><span class=lnt id=hl-69-3><a class=lnlinks href=#hl-69-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:11:52.795 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:11:53.295 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - unpark... 
</span></span><span class=line><span class=cl>21:11:53.295 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - æ‰“æ–­çŠ¶æ€ï¼štrue 
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-70-1><a class=lnlinks href=#hl-70-1> 1</a>
</span><span class=lnt id=hl-70-2><a class=lnlinks href=#hl-70-2> 2</a>
</span><span class=lnt id=hl-70-3><a class=lnlinks href=#hl-70-3> 3</a>
</span><span class=lnt id=hl-70-4><a class=lnlinks href=#hl-70-4> 4</a>
</span><span class=lnt id=hl-70-5><a class=lnlinks href=#hl-70-5> 5</a>
</span><span class=lnt id=hl-70-6><a class=lnlinks href=#hl-70-6> 6</a>
</span><span class=lnt id=hl-70-7><a class=lnlinks href=#hl-70-7> 7</a>
</span><span class=lnt id=hl-70-8><a class=lnlinks href=#hl-70-8> 8</a>
</span><span class=lnt id=hl-70-9><a class=lnlinks href=#hl-70-9> 9</a>
</span><span class=lnt id=hl-70-10><a class=lnlinks href=#hl-70-10>10</a>
</span><span class=lnt id=hl-70-11><a class=lnlinks href=#hl-70-11>11</a>
</span><span class=lnt id=hl-70-12><a class=lnlinks href=#hl-70-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test4</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;park...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‰“æ–­çŠ¶æ€ï¼š{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>isInterrupted</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-71-1><a class=lnlinks href=#hl-71-1> 1</a>
</span><span class=lnt id=hl-71-2><a class=lnlinks href=#hl-71-2> 2</a>
</span><span class=lnt id=hl-71-3><a class=lnlinks href=#hl-71-3> 3</a>
</span><span class=lnt id=hl-71-4><a class=lnlinks href=#hl-71-4> 4</a>
</span><span class=lnt id=hl-71-5><a class=lnlinks href=#hl-71-5> 5</a>
</span><span class=lnt id=hl-71-6><a class=lnlinks href=#hl-71-6> 6</a>
</span><span class=lnt id=hl-71-7><a class=lnlinks href=#hl-71-7> 7</a>
</span><span class=lnt id=hl-71-8><a class=lnlinks href=#hl-71-8> 8</a>
</span><span class=lnt id=hl-71-9><a class=lnlinks href=#hl-71-9> 9</a>
</span><span class=lnt id=hl-71-10><a class=lnlinks href=#hl-71-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:13:48.783 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:13:49.809 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - æ‰“æ–­çŠ¶æ€ï¼štrue 
</span></span><span class=line><span class=cl>21:13:49.812 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - æ‰“æ–­çŠ¶æ€ï¼štrue 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - æ‰“æ–­çŠ¶æ€ï¼štrue 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - æ‰“æ–­çŠ¶æ€ï¼štrue 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - park... 
</span></span><span class=line><span class=cl>21:13:49.813 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestInterrupt - æ‰“æ–­çŠ¶æ€ï¼štrue 
</span></span></code></pre></td></tr></table></div></div><blockquote><p>æç¤º</p><p>å¯ä»¥ä½¿ç”¨ Thread.interrupted() æ¸…é™¤æ‰“æ–­çŠ¶æ€</p></blockquote><h2 id=310-ä¸æ¨èçš„æ–¹æ³•><a href=#310-%e4%b8%8d%e6%8e%a8%e8%8d%90%e7%9a%84%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
3.10 ä¸æ¨èçš„æ–¹æ³•</h2><p>è¿˜æœ‰ä¸€äº›ä¸æ¨èä½¿ç”¨çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å·²è¿‡æ—¶ï¼Œå®¹æ˜“ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>æ–¹æ³•å</th><th style=text-align:center>static</th><th style=text-align:center>åŠŸèƒ½è¯´æ˜</th></tr></thead><tbody><tr><td style=text-align:center>stop()</td><td style=text-align:center></td><td style=text-align:center>åœæ­¢çº¿ç¨‹è¿è¡Œ</td></tr><tr><td style=text-align:center>suspend()</td><td style=text-align:center></td><td style=text-align:center>æŒ‚èµ·ï¼ˆæš‚åœï¼‰çº¿ç¨‹è¿è¡Œ</td></tr><tr><td style=text-align:center>resume()</td><td style=text-align:center></td><td style=text-align:center>æ¢å¤çº¿ç¨‹è¿è¡Œ</td></tr></tbody></table></div><h2 id=311-ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹><a href=#311-%e4%b8%bb%e7%ba%bf%e7%a8%8b%e4%b8%8e%e5%ae%88%e6%8a%a4%e7%ba%bf%e7%a8%8b class=header-anchor>#</a>
3.11 ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒJava è¿›ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸï¼Œæ‰ä¼šç»“æŸã€‚æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚</p><p>ä¾‹:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-72-1><a class=lnlinks href=#hl-72-1> 1</a>
</span><span class=lnt id=hl-72-2><a class=lnlinks href=#hl-72-2> 2</a>
</span><span class=lnt id=hl-72-3><a class=lnlinks href=#hl-72-3> 3</a>
</span><span class=lnt id=hl-72-4><a class=lnlinks href=#hl-72-4> 4</a>
</span><span class=lnt id=hl-72-5><a class=lnlinks href=#hl-72-5> 5</a>
</span><span class=lnt id=hl-72-6><a class=lnlinks href=#hl-72-6> 6</a>
</span><span class=lnt id=hl-72-7><a class=lnlinks href=#hl-72-7> 7</a>
</span><span class=lnt id=hl-72-8><a class=lnlinks href=#hl-72-8> 8</a>
</span><span class=lnt id=hl-72-9><a class=lnlinks href=#hl-72-9> 9</a>
</span><span class=lnt id=hl-72-10><a class=lnlinks href=#hl-72-10>10</a>
</span><span class=lnt id=hl-72-11><a class=lnlinks href=#hl-72-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹è¿è¡Œ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹è¿è¡Œ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è¿è¡Œç»“æŸ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;daemon&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è®¾ç½®è¯¥çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>setDaemon</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è¿è¡Œç»“æŸ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-73-1><a class=lnlinks href=#hl-73-1>1</a>
</span><span class=lnt id=hl-73-2><a class=lnlinks href=#hl-73-2>2</a>
</span><span class=lnt id=hl-73-3><a class=lnlinks href=#hl-73-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>08:26:38.123 <span class=o>[</span>main<span class=o>]</span> c.TestDaemon - å¼€å§‹è¿è¡Œ... 
</span></span><span class=line><span class=cl>08:26:38.213 <span class=o>[</span>daemon<span class=o>]</span> c.TestDaemon - å¼€å§‹è¿è¡Œ... 
</span></span><span class=line><span class=cl>08:26:39.215 <span class=o>[</span>main<span class=o>]</span> c.TestDaemon - è¿è¡Œç»“æŸ... 
</span></span></code></pre></td></tr></table></div></div><blockquote><p>æ³¨æ„</p><ul><li>åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹</li><li>Tomcat ä¸­çš„ Acceptor å’Œ Poller çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚</li></ul></blockquote><h2 id=312-äº”ç§çŠ¶æ€><a href=#312-%e4%ba%94%e7%a7%8d%e7%8a%b6%e6%80%81 class=header-anchor>#</a>
3.12 äº”ç§çŠ¶æ€</h2><p>è¿™æ˜¯ä» <strong>æ“ä½œç³»ç»Ÿ</strong> å±‚é¢æ¥æè¿°çš„</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220224174907408.png width=900 height=600 loading=lazy decoding=async alt=image-20220224174907408 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>ã€åˆå§‹çŠ¶æ€ã€‘ä»…æ˜¯åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”</li><li>ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰æŒ‡è¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼ˆä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼‰ï¼Œå¯ä»¥ç”± CPU è°ƒåº¦æ‰§è¡Œ</li><li>ã€è¿è¡ŒçŠ¶æ€ã€‘æŒ‡è·å–äº† CPU æ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€<ul><li>å½“ CPU æ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»ã€è¿è¡ŒçŠ¶æ€ã€‘è½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼Œä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</li></ul></li><li>ã€é˜»å¡çŠ¶æ€ã€‘<ul><li>å¦‚æœè°ƒç”¨äº†é˜»å¡ APIï¼Œå¦‚ BIO è¯»å†™æ–‡ä»¶ï¼Œè¿™æ—¶è¯¥çº¿ç¨‹å®é™…ä¸ä¼šç”¨åˆ° CPUï¼Œä¼šå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥ ã€é˜»å¡çŠ¶æ€ã€‘</li><li>ç­‰ BIO æ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘</li><li>ä¸ã€å¯è¿è¡ŒçŠ¶æ€ã€‘çš„åŒºåˆ«æ˜¯ï¼Œå¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„çº¿ç¨‹æ¥è¯´åªè¦å®ƒä»¬ä¸€ç›´ä¸å”¤é†’ï¼Œè°ƒåº¦å™¨å°±ä¸€ç›´ä¸ä¼šè€ƒè™‘ è°ƒåº¦å®ƒä»¬</li></ul></li><li>ã€ç»ˆæ­¢çŠ¶æ€ã€‘è¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶å®ƒçŠ¶æ€</li></ul><h2 id=313-å…­ç§çŠ¶æ€><a href=#313-%e5%85%ad%e7%a7%8d%e7%8a%b6%e6%80%81 class=header-anchor>#</a>
3.13 å…­ç§çŠ¶æ€</h2><p>è¿™æ˜¯ä» <strong>Java API</strong> å±‚é¢æ¥æè¿°çš„</p><p>æ ¹æ® Thread.State æšä¸¾ï¼Œåˆ†ä¸ºå…­ç§çŠ¶æ€</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220224175139037.png width=900 height=600 loading=lazy decoding=async alt=image-20220224175139037 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>NEW çº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è°ƒç”¨ start() æ–¹æ³•</li><li>RUNNABLE å½“è°ƒç”¨äº† start() æ–¹æ³•ä¹‹åï¼Œæ³¨æ„ï¼ŒJava API å±‚é¢çš„ RUNNABLE çŠ¶æ€æ¶µç›–äº† æ“ä½œç³»ç»Ÿ å±‚é¢çš„ ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ã€ã€è¿è¡ŒçŠ¶æ€ã€‘å’Œã€é˜»å¡çŠ¶æ€ã€‘ï¼ˆç”±äº BIO å¯¼è‡´çš„çº¿ç¨‹é˜»å¡ï¼Œåœ¨ Java é‡Œæ— æ³•åŒºåˆ†ï¼Œä»ç„¶è®¤ä¸º æ˜¯å¯è¿è¡Œï¼‰</li><li>BLOCKED ï¼Œ WAITING ï¼Œ TIMED_WAITING éƒ½æ˜¯ Java API å±‚é¢å¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„ç»†åˆ†ï¼Œåé¢ä¼šåœ¨çŠ¶æ€è½¬æ¢ä¸€èŠ‚ è¯¦è¿°</li><li>TERMINATED å½“çº¿ç¨‹ä»£ç è¿è¡Œç»“æŸ</li></ul><h2 id=314-ä¹ é¢˜><a href=#314-%e4%b9%a0%e9%a2%98 class=header-anchor>#</a>
3.14 ä¹ é¢˜</h2><p>é˜…è¯»åç½—åºšã€Šç»Ÿç­¹æ–¹æ³•ã€‹ï¼Œç»™å‡ºçƒ§æ°´æ³¡èŒ¶çš„å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆï¼Œæç¤º</p><ul><li>å‚è€ƒå›¾äºŒï¼Œç”¨ä¸¤ä¸ªçº¿ç¨‹ï¼ˆä¸¤ä¸ªäººåä½œï¼‰æ¨¡æ‹Ÿçƒ§æ°´æ³¡èŒ¶è¿‡ç¨‹<ul><li>æ–‡ä¸­åŠæ³•ä¹™ã€ä¸™éƒ½ç›¸å½“äºä»»åŠ¡ä¸²è¡Œ</li><li>è€Œå›¾ä¸€ç›¸å½“äºå¯åŠ¨äº† 4 ä¸ªçº¿ç¨‹ï¼Œæœ‰ç‚¹æµªè´¹</li></ul></li><li>ç”¨ sleep(n) æ¨¡æ‹Ÿæ´—èŒ¶å£¶ã€æ´—æ°´å£¶ç­‰è€—è´¹çš„æ—¶é—´</li></ul><h3 id=textcolorgreen-åº”ç”¨ä¹‹ç»Ÿç­¹çƒ§æ°´æ³¡èŒ¶><a href=#textcolorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e7%bb%9f%e7%ad%b9%e7%83%a7%e6%b0%b4%e6%b3%a1%e8%8c%b6 class=header-anchor>#</a>
$\textcolor{green}{* åº”ç”¨ä¹‹ç»Ÿç­¹ï¼ˆçƒ§æ°´æ³¡èŒ¶ï¼‰}$</h3><h4 id=è§£æ³•1join><a href=#%e8%a7%a3%e6%b3%951join class=header-anchor>#</a>
è§£æ³•1ï¼šjoin</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-74-1><a class=lnlinks href=#hl-74-1> 1</a>
</span><span class=lnt id=hl-74-2><a class=lnlinks href=#hl-74-2> 2</a>
</span><span class=lnt id=hl-74-3><a class=lnlinks href=#hl-74-3> 3</a>
</span><span class=lnt id=hl-74-4><a class=lnlinks href=#hl-74-4> 4</a>
</span><span class=lnt id=hl-74-5><a class=lnlinks href=#hl-74-5> 5</a>
</span><span class=lnt id=hl-74-6><a class=lnlinks href=#hl-74-6> 6</a>
</span><span class=lnt id=hl-74-7><a class=lnlinks href=#hl-74-7> 7</a>
</span><span class=lnt id=hl-74-8><a class=lnlinks href=#hl-74-8> 8</a>
</span><span class=lnt id=hl-74-9><a class=lnlinks href=#hl-74-9> 9</a>
</span><span class=lnt id=hl-74-10><a class=lnlinks href=#hl-74-10>10</a>
</span><span class=lnt id=hl-74-11><a class=lnlinks href=#hl-74-11>11</a>
</span><span class=lnt id=hl-74-12><a class=lnlinks href=#hl-74-12>12</a>
</span><span class=lnt id=hl-74-13><a class=lnlinks href=#hl-74-13>13</a>
</span><span class=lnt id=hl-74-14><a class=lnlinks href=#hl-74-14>14</a>
</span><span class=lnt id=hl-74-15><a class=lnlinks href=#hl-74-15>15</a>
</span><span class=lnt id=hl-74-16><a class=lnlinks href=#hl-74-16>16</a>
</span><span class=lnt id=hl-74-17><a class=lnlinks href=#hl-74-17>17</a>
</span><span class=lnt id=hl-74-18><a class=lnlinks href=#hl-74-18>18</a>
</span><span class=lnt id=hl-74-19><a class=lnlinks href=#hl-74-19>19</a>
</span><span class=lnt id=hl-74-20><a class=lnlinks href=#hl-74-20>20</a>
</span><span class=lnt id=hl-74-21><a class=lnlinks href=#hl-74-21>21</a>
</span><span class=lnt id=hl-74-22><a class=lnlinks href=#hl-74-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ´—æ°´å£¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;çƒ§å¼€æ°´&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>15</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;è€ç‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ´—èŒ¶å£¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ´—èŒ¶æ¯&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‹¿èŒ¶å¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ³¡èŒ¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;å°ç‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-75-1><a class=lnlinks href=#hl-75-1>1</a>
</span><span class=lnt id=hl-75-2><a class=lnlinks href=#hl-75-2>2</a>
</span><span class=lnt id=hl-75-3><a class=lnlinks href=#hl-75-3>3</a>
</span><span class=lnt id=hl-75-4><a class=lnlinks href=#hl-75-4>4</a>
</span><span class=lnt id=hl-75-5><a class=lnlinks href=#hl-75-5>5</a>
</span><span class=lnt id=hl-75-6><a class=lnlinks href=#hl-75-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:19:37.547 <span class=o>[</span>å°ç‹<span class=o>]</span> c.TestMakeTea - æ´—èŒ¶å£¶
</span></span><span class=line><span class=cl>19:19:37.547 <span class=o>[</span>è€ç‹<span class=o>]</span> c.TestMakeTea - æ´—æ°´å£¶
</span></span><span class=line><span class=cl>19:19:38.552 <span class=o>[</span>å°ç‹<span class=o>]</span> c.TestMakeTea - æ´—èŒ¶æ¯
</span></span><span class=line><span class=cl>19:19:38.552 <span class=o>[</span>è€ç‹<span class=o>]</span> c.TestMakeTea - çƒ§å¼€æ°´
</span></span><span class=line><span class=cl>19:19:40.553 <span class=o>[</span>å°ç‹<span class=o>]</span> c.TestMakeTea - æ‹¿èŒ¶å¶
</span></span><span class=line><span class=cl>19:19:53.553 <span class=o>[</span>å°ç‹<span class=o>]</span> c.TestMakeTea - æ³¡èŒ¶
</span></span></code></pre></td></tr></table></div></div><p>è§£æ³•1 çš„ç¼ºé™·ï¼š</p><ul><li>ä¸Šé¢æ¨¡æ‹Ÿçš„æ˜¯å°ç‹ç­‰è€ç‹çš„æ°´çƒ§å¼€äº†ï¼Œå°ç‹æ³¡èŒ¶ï¼Œå¦‚æœåè¿‡æ¥è¦å®ç°è€ç‹ç­‰å°ç‹çš„èŒ¶å¶æ‹¿æ¥äº†ï¼Œè€ç‹æ³¡èŒ¶ å‘¢ï¼Ÿä»£ç æœ€å¥½èƒ½é€‚åº”ä¸¤ç§æƒ…å†µ</li><li>ä¸Šé¢çš„ä¸¤ä¸ªçº¿ç¨‹å…¶å®æ˜¯å„æ‰§è¡Œå„çš„ï¼Œå¦‚æœè¦æ¨¡æ‹Ÿè€ç‹æŠŠæ°´å£¶äº¤ç»™å°ç‹æ³¡èŒ¶ï¼Œæˆ–æ¨¡æ‹Ÿå°ç‹æŠŠèŒ¶å¶äº¤ç»™è€ç‹æ³¡èŒ¶ å‘¢</li></ul><h4 id=è§£æ³•2waitnotify><a href=#%e8%a7%a3%e6%b3%952waitnotify class=header-anchor>#</a>
è§£æ³•2ï¼šwait/notify</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-76-1><a class=lnlinks href=#hl-76-1> 1</a>
</span><span class=lnt id=hl-76-2><a class=lnlinks href=#hl-76-2> 2</a>
</span><span class=lnt id=hl-76-3><a class=lnlinks href=#hl-76-3> 3</a>
</span><span class=lnt id=hl-76-4><a class=lnlinks href=#hl-76-4> 4</a>
</span><span class=lnt id=hl-76-5><a class=lnlinks href=#hl-76-5> 5</a>
</span><span class=lnt id=hl-76-6><a class=lnlinks href=#hl-76-6> 6</a>
</span><span class=lnt id=hl-76-7><a class=lnlinks href=#hl-76-7> 7</a>
</span><span class=lnt id=hl-76-8><a class=lnlinks href=#hl-76-8> 8</a>
</span><span class=lnt id=hl-76-9><a class=lnlinks href=#hl-76-9> 9</a>
</span><span class=lnt id=hl-76-10><a class=lnlinks href=#hl-76-10>10</a>
</span><span class=lnt id=hl-76-11><a class=lnlinks href=#hl-76-11>11</a>
</span><span class=lnt id=hl-76-12><a class=lnlinks href=#hl-76-12>12</a>
</span><span class=lnt id=hl-76-13><a class=lnlinks href=#hl-76-13>13</a>
</span><span class=lnt id=hl-76-14><a class=lnlinks href=#hl-76-14>14</a>
</span><span class=lnt id=hl-76-15><a class=lnlinks href=#hl-76-15>15</a>
</span><span class=lnt id=hl-76-16><a class=lnlinks href=#hl-76-16>16</a>
</span><span class=lnt id=hl-76-17><a class=lnlinks href=#hl-76-17>17</a>
</span><span class=lnt id=hl-76-18><a class=lnlinks href=#hl-76-18>18</a>
</span><span class=lnt id=hl-76-19><a class=lnlinks href=#hl-76-19>19</a>
</span><span class=lnt id=hl-76-20><a class=lnlinks href=#hl-76-20>20</a>
</span><span class=lnt id=hl-76-21><a class=lnlinks href=#hl-76-21>21</a>
</span><span class=lnt id=hl-76-22><a class=lnlinks href=#hl-76-22>22</a>
</span><span class=lnt id=hl-76-23><a class=lnlinks href=#hl-76-23>23</a>
</span><span class=lnt id=hl-76-24><a class=lnlinks href=#hl-76-24>24</a>
</span><span class=lnt id=hl-76-25><a class=lnlinks href=#hl-76-25>25</a>
</span><span class=lnt id=hl-76-26><a class=lnlinks href=#hl-76-26>26</a>
</span><span class=lnt id=hl-76-27><a class=lnlinks href=#hl-76-27>27</a>
</span><span class=lnt id=hl-76-28><a class=lnlinks href=#hl-76-28>28</a>
</span><span class=lnt id=hl-76-29><a class=lnlinks href=#hl-76-29>29</a>
</span><span class=lnt id=hl-76-30><a class=lnlinks href=#hl-76-30>30</a>
</span><span class=lnt id=hl-76-31><a class=lnlinks href=#hl-76-31>31</a>
</span><span class=lnt id=hl-76-32><a class=lnlinks href=#hl-76-32>32</a>
</span><span class=lnt id=hl-76-33><a class=lnlinks href=#hl-76-33>33</a>
</span><span class=lnt id=hl-76-34><a class=lnlinks href=#hl-76-34>34</a>
</span><span class=lnt id=hl-76-35><a class=lnlinks href=#hl-76-35>35</a>
</span><span class=lnt id=hl-76-36><a class=lnlinks href=#hl-76-36>36</a>
</span><span class=lnt id=hl-76-37><a class=lnlinks href=#hl-76-37>37</a>
</span><span class=lnt id=hl-76-38><a class=lnlinks href=#hl-76-38>38</a>
</span><span class=lnt id=hl-76-39><a class=lnlinks href=#hl-76-39>39</a>
</span><span class=lnt id=hl-76-40><a class=lnlinks href=#hl-76-40>40</a>
</span><span class=lnt id=hl-76-41><a class=lnlinks href=#hl-76-41>41</a>
</span><span class=lnt id=hl-76-42><a class=lnlinks href=#hl-76-42>42</a>
</span><span class=lnt id=hl-76-43><a class=lnlinks href=#hl-76-43>43</a>
</span><span class=lnt id=hl-76-44><a class=lnlinks href=#hl-76-44>44</a>
</span><span class=lnt id=hl-76-45><a class=lnlinks href=#hl-76-45>45</a>
</span><span class=lnt id=hl-76-46><a class=lnlinks href=#hl-76-46>46</a>
</span><span class=lnt id=hl-76-47><a class=lnlinks href=#hl-76-47>47</a>
</span><span class=lnt id=hl-76-48><a class=lnlinks href=#hl-76-48>48</a>
</span><span class=lnt id=hl-76-49><a class=lnlinks href=#hl-76-49>49</a>
</span><span class=lnt id=hl-76-50><a class=lnlinks href=#hl-76-50>50</a>
</span><span class=lnt id=hl-76-51><a class=lnlinks href=#hl-76-51>51</a>
</span><span class=lnt id=hl-76-52><a class=lnlinks href=#hl-76-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>S2</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>kettle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;å†·æ°´&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>tea</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>maked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>makeTea</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ´—æ°´å£¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;çƒ§å¼€æ°´&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>kettle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;å¼€æ°´&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>tea</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>maked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‹¿({})æ³¡({})&#34;</span><span class=p>,</span><span class=w> </span><span class=n>kettle</span><span class=p>,</span><span class=w> </span><span class=n>tea</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>maked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;è€ç‹&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ´—èŒ¶å£¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ´—èŒ¶æ¯&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‹¿èŒ¶å¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>tea</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;èŠ±èŒ¶&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>kettle</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;å†·æ°´&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>maked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‹¿({})æ³¡({})&#34;</span><span class=p>,</span><span class=w> </span><span class=n>kettle</span><span class=p>,</span><span class=w> </span><span class=n>tea</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>maked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;å°ç‹&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-77-1><a class=lnlinks href=#hl-77-1>1</a>
</span><span class=lnt id=hl-77-2><a class=lnlinks href=#hl-77-2>2</a>
</span><span class=lnt id=hl-77-3><a class=lnlinks href=#hl-77-3>3</a>
</span><span class=lnt id=hl-77-4><a class=lnlinks href=#hl-77-4>4</a>
</span><span class=lnt id=hl-77-5><a class=lnlinks href=#hl-77-5>5</a>
</span><span class=lnt id=hl-77-6><a class=lnlinks href=#hl-77-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>48</span><span class=p>.</span><span class=na>179</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>å°ç‹</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>æ´—èŒ¶å£¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>48</span><span class=p>.</span><span class=na>179</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>è€ç‹</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>æ´—æ°´å£¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>49</span><span class=p>.</span><span class=na>185</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>è€ç‹</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>çƒ§å¼€æ°´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>49</span><span class=p>.</span><span class=na>185</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>å°ç‹</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>æ´—èŒ¶æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>51</span><span class=p>.</span><span class=na>185</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>å°ç‹</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>æ‹¿èŒ¶å¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>20</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>54</span><span class=p>.</span><span class=na>185</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>S2</span><span class=w> </span><span class=o>[</span><span class=n>è€ç‹</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>æ‹¿</span><span class=p>(</span><span class=n>å¼€æ°´</span><span class=p>)</span><span class=n>æ³¡</span><span class=p>(</span><span class=n>èŠ±èŒ¶</span><span class=p>)</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>è§£æ³•2 è§£å†³äº†è§£æ³•1 çš„é—®é¢˜ï¼Œä¸è¿‡è€ç‹å’Œå°ç‹éœ€è¦ç›¸äº’ç­‰å¾…ï¼Œä¸å¦‚ä»–ä»¬åªè´Ÿè´£å„è‡ªçš„ä»»åŠ¡ï¼Œæ³¡èŒ¶äº¤ç»™ç¬¬ä¸‰äººæ¥åš</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-78-1><a class=lnlinks href=#hl-78-1> 1</a>
</span><span class=lnt id=hl-78-2><a class=lnlinks href=#hl-78-2> 2</a>
</span><span class=lnt id=hl-78-3><a class=lnlinks href=#hl-78-3> 3</a>
</span><span class=lnt id=hl-78-4><a class=lnlinks href=#hl-78-4> 4</a>
</span><span class=lnt id=hl-78-5><a class=lnlinks href=#hl-78-5> 5</a>
</span><span class=lnt id=hl-78-6><a class=lnlinks href=#hl-78-6> 6</a>
</span><span class=lnt id=hl-78-7><a class=lnlinks href=#hl-78-7> 7</a>
</span><span class=lnt id=hl-78-8><a class=lnlinks href=#hl-78-8> 8</a>
</span><span class=lnt id=hl-78-9><a class=lnlinks href=#hl-78-9> 9</a>
</span><span class=lnt id=hl-78-10><a class=lnlinks href=#hl-78-10>10</a>
</span><span class=lnt id=hl-78-11><a class=lnlinks href=#hl-78-11>11</a>
</span><span class=lnt id=hl-78-12><a class=lnlinks href=#hl-78-12>12</a>
</span><span class=lnt id=hl-78-13><a class=lnlinks href=#hl-78-13>13</a>
</span><span class=lnt id=hl-78-14><a class=lnlinks href=#hl-78-14>14</a>
</span><span class=lnt id=hl-78-15><a class=lnlinks href=#hl-78-15>15</a>
</span><span class=lnt id=hl-78-16><a class=lnlinks href=#hl-78-16>16</a>
</span><span class=lnt id=hl-78-17><a class=lnlinks href=#hl-78-17>17</a>
</span><span class=lnt id=hl-78-18><a class=lnlinks href=#hl-78-18>18</a>
</span><span class=lnt id=hl-78-19><a class=lnlinks href=#hl-78-19>19</a>
</span><span class=lnt id=hl-78-20><a class=lnlinks href=#hl-78-20>20</a>
</span><span class=lnt id=hl-78-21><a class=lnlinks href=#hl-78-21>21</a>
</span><span class=lnt id=hl-78-22><a class=lnlinks href=#hl-78-22>22</a>
</span><span class=lnt id=hl-78-23><a class=lnlinks href=#hl-78-23>23</a>
</span><span class=lnt id=hl-78-24><a class=lnlinks href=#hl-78-24>24</a>
</span><span class=lnt id=hl-78-25><a class=lnlinks href=#hl-78-25>25</a>
</span><span class=lnt id=hl-78-26><a class=lnlinks href=#hl-78-26>26</a>
</span><span class=lnt id=hl-78-27><a class=lnlinks href=#hl-78-27>27</a>
</span><span class=lnt id=hl-78-28><a class=lnlinks href=#hl-78-28>28</a>
</span><span class=lnt id=hl-78-29><a class=lnlinks href=#hl-78-29>29</a>
</span><span class=lnt id=hl-78-30><a class=lnlinks href=#hl-78-30>30</a>
</span><span class=lnt id=hl-78-31><a class=lnlinks href=#hl-78-31>31</a>
</span><span class=lnt id=hl-78-32><a class=lnlinks href=#hl-78-32>32</a>
</span><span class=lnt id=hl-78-33><a class=lnlinks href=#hl-78-33>33</a>
</span><span class=lnt id=hl-78-34><a class=lnlinks href=#hl-78-34>34</a>
</span><span class=lnt id=hl-78-35><a class=lnlinks href=#hl-78-35>35</a>
</span><span class=lnt id=hl-78-36><a class=lnlinks href=#hl-78-36>36</a>
</span><span class=lnt id=hl-78-37><a class=lnlinks href=#hl-78-37>37</a>
</span><span class=lnt id=hl-78-38><a class=lnlinks href=#hl-78-38>38</a>
</span><span class=lnt id=hl-78-39><a class=lnlinks href=#hl-78-39>39</a>
</span><span class=lnt id=hl-78-40><a class=lnlinks href=#hl-78-40>40</a>
</span><span class=lnt id=hl-78-41><a class=lnlinks href=#hl-78-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>S3</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>kettle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;å†·æ°´&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>tea</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>makeTea</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ´—æ°´å£¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;çƒ§å¼€æ°´&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>kettle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;å¼€æ°´&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;è€ç‹&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ´—èŒ¶å£¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ´—èŒ¶æ¯&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‹¿èŒ¶å¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>tea</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;èŠ±èŒ¶&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;å°ç‹&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>kettle</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;å†·æ°´&#34;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>tea</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‹¿({})æ³¡({})&#34;</span><span class=p>,</span><span class=w> </span><span class=n>kettle</span><span class=p>,</span><span class=w> </span><span class=n>tea</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;ç‹å¤«äºº&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-79-1><a class=lnlinks href=#hl-79-1>1</a>
</span><span class=lnt id=hl-79-2><a class=lnlinks href=#hl-79-2>2</a>
</span><span class=lnt id=hl-79-3><a class=lnlinks href=#hl-79-3>3</a>
</span><span class=lnt id=hl-79-4><a class=lnlinks href=#hl-79-4>4</a>
</span><span class=lnt id=hl-79-5><a class=lnlinks href=#hl-79-5>5</a>
</span><span class=lnt id=hl-79-6><a class=lnlinks href=#hl-79-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:13:18.202 c.S3 <span class=o>[</span>å°ç‹<span class=o>]</span> - æ´—èŒ¶å£¶
</span></span><span class=line><span class=cl>20:13:18.202 c.S3 <span class=o>[</span>è€ç‹<span class=o>]</span> - æ´—æ°´å£¶
</span></span><span class=line><span class=cl>20:13:19.206 c.S3 <span class=o>[</span>å°ç‹<span class=o>]</span> - æ´—èŒ¶æ¯
</span></span><span class=line><span class=cl>20:13:19.206 c.S3 <span class=o>[</span>è€ç‹<span class=o>]</span> - çƒ§å¼€æ°´
</span></span><span class=line><span class=cl>20:13:21.206 c.S3 <span class=o>[</span>å°ç‹<span class=o>]</span> - æ‹¿èŒ¶å¶
</span></span><span class=line><span class=cl>20:13:24.207 c.S3 <span class=o>[</span>ç‹å¤«äºº<span class=o>]</span> - æ‹¿<span class=o>(</span>å¼€æ°´<span class=o>)</span>æ³¡<span class=o>(</span>èŠ±èŒ¶<span class=o>)</span> 
</span></span></code></pre></td></tr></table></div></div><h4 id=è§£æ³•3ç¬¬ä¸‰è€…åè°ƒ><a href=#%e8%a7%a3%e6%b3%953%e7%ac%ac%e4%b8%89%e8%80%85%e5%8d%8f%e8%b0%83 class=header-anchor>#</a>
è§£æ³•3ï¼šç¬¬ä¸‰è€…åè°ƒ</h4><h2 id=æœ¬ç« å°ç»“><a href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93 class=header-anchor>#</a>
æœ¬ç« å°ç»“</h2><p>æœ¬ç« çš„é‡ç‚¹åœ¨äºæŒæ¡</p><ul><li>çº¿ç¨‹åˆ›å»º</li><li>çº¿ç¨‹é‡è¦ apiï¼Œå¦‚ startï¼Œrunï¼Œsleepï¼Œjoinï¼Œinterrupt ç­‰</li><li>çº¿ç¨‹çŠ¶æ€</li><li>åº”ç”¨æ–¹é¢<ul><li>å¼‚æ­¥è°ƒç”¨ï¼šä¸»çº¿ç¨‹æ‰§è¡ŒæœŸé—´ï¼Œå…¶å®ƒçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œè€—æ—¶æ“ä½œ</li><li>æé«˜æ•ˆç‡ï¼šå¹¶è¡Œè®¡ç®—ï¼Œç¼©çŸ­è¿ç®—æ—¶é—´</li><li>åŒæ­¥ç­‰å¾…ï¼šjoin</li><li>ç»Ÿç­¹è§„åˆ’ï¼šåˆç†ä½¿ç”¨çº¿ç¨‹ï¼Œå¾—åˆ°æœ€ä¼˜æ•ˆæœ</li></ul></li><li>åŸç†æ–¹é¢<ul><li>çº¿ç¨‹è¿è¡Œæµç¨‹ï¼šæ ˆã€æ ˆå¸§ã€ä¸Šä¸‹æ–‡åˆ‡æ¢ã€ç¨‹åºè®¡æ•°å™¨</li><li>Thread ä¸¤ç§åˆ›å»ºæ–¹å¼ çš„æºç </li></ul></li><li>æ¨¡å¼æ–¹é¢<ul><li>ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢</li></ul></li></ul><h1 id=4å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹><a href=#4%e5%85%b1%e4%ba%ab%e6%a8%a1%e5%9e%8b%e4%b9%8b%e7%ae%a1%e7%a8%8b class=header-anchor>#</a>
4.å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹</h1><h2 id=41å…±äº«å¸¦æ¥çš„é—®é¢˜><a href=#41%e5%85%b1%e4%ba%ab%e5%b8%a6%e6%9d%a5%e7%9a%84%e9%97%ae%e9%a2%98 class=header-anchor>#</a>
4.1å…±äº«å¸¦æ¥çš„é—®é¢˜</h2><h5 id=javaä»£ç ç¤ºä¾‹><a href=#java%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b class=header-anchor>#</a>
<strong>Javaä»£ç ç¤ºä¾‹</strong></h5><p>ä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º 0 çš„é™æ€å˜é‡ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œå„åš 5000 æ¬¡ï¼Œç»“æœæ˜¯ 0 å—ï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-80-1><a class=lnlinks href=#hl-80-1> 1</a>
</span><span class=lnt id=hl-80-2><a class=lnlinks href=#hl-80-2> 2</a>
</span><span class=lnt id=hl-80-3><a class=lnlinks href=#hl-80-3> 3</a>
</span><span class=lnt id=hl-80-4><a class=lnlinks href=#hl-80-4> 4</a>
</span><span class=lnt id=hl-80-5><a class=lnlinks href=#hl-80-5> 5</a>
</span><span class=lnt id=hl-80-6><a class=lnlinks href=#hl-80-6> 6</a>
</span><span class=lnt id=hl-80-7><a class=lnlinks href=#hl-80-7> 7</a>
</span><span class=lnt id=hl-80-8><a class=lnlinks href=#hl-80-8> 8</a>
</span><span class=lnt id=hl-80-9><a class=lnlinks href=#hl-80-9> 9</a>
</span><span class=lnt id=hl-80-10><a class=lnlinks href=#hl-80-10>10</a>
</span><span class=lnt id=hl-80-11><a class=lnlinks href=#hl-80-11>11</a>
</span><span class=lnt id=hl-80-12><a class=lnlinks href=#hl-80-12>12</a>
</span><span class=lnt id=hl-80-13><a class=lnlinks href=#hl-80-13>13</a>
</span><span class=lnt id=hl-80-14><a class=lnlinks href=#hl-80-14>14</a>
</span><span class=lnt id=hl-80-15><a class=lnlinks href=#hl-80-15>15</a>
</span><span class=lnt id=hl-80-16><a class=lnlinks href=#hl-80-16>16</a>
</span><span class=lnt id=hl-80-17><a class=lnlinks href=#hl-80-17>17</a>
</span><span class=lnt id=hl-80-18><a class=lnlinks href=#hl-80-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>counter</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>counter</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=n>counter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=é—®é¢˜åˆ†æ><a href=#%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90 class=header-anchor>#</a>
<strong>é—®é¢˜åˆ†æ</strong></h5><p>ä»¥ä¸Šçš„ç»“æœå¯èƒ½æ˜¯æ­£æ•°ã€è´Ÿæ•°ã€é›¶ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º Java ä¸­å¯¹é™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡å¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œè¦å½»åº•ç†è§£ï¼Œå¿…é¡»ä»å­—èŠ‚ç æ¥è¿›è¡Œåˆ†æ</p><p>ä¾‹å¦‚å¯¹äº i++ è€Œè¨€ï¼ˆi ä¸ºé™æ€å˜é‡ï¼‰ï¼Œå®é™…ä¼šäº§ç”Ÿå¦‚ä¸‹çš„ JVM å­—èŠ‚ç æŒ‡ä»¤ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-81-1><a class=lnlinks href=#hl-81-1>1</a>
</span><span class=lnt id=hl-81-2><a class=lnlinks href=#hl-81-2>2</a>
</span><span class=lnt id=hl-81-3><a class=lnlinks href=#hl-81-3>3</a>
</span><span class=lnt id=hl-81-4><a class=lnlinks href=#hl-81-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>getstatic</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=c1>// è·å–é™æ€å˜é‡içš„å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>iconst_1</span><span class=w> </span><span class=c1>// å‡†å¤‡å¸¸é‡1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>iadd</span><span class=w> </span><span class=c1>// è‡ªå¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>putstatic</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=c1>// å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è€Œå¯¹åº” i&ndash; ä¹Ÿæ˜¯ç±»ä¼¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-82-1><a class=lnlinks href=#hl-82-1>1</a>
</span><span class=lnt id=hl-82-2><a class=lnlinks href=#hl-82-2>2</a>
</span><span class=lnt id=hl-82-3><a class=lnlinks href=#hl-82-3>3</a>
</span><span class=lnt id=hl-82-4><a class=lnlinks href=#hl-82-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>getstatic</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=c1>// è·å–é™æ€å˜é‡içš„å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>iconst_1</span><span class=w> </span><span class=c1>// å‡†å¤‡å¸¸é‡1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>isub</span><span class=w> </span><span class=c1>// è‡ªå‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>putstatic</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=c1>// å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è€Œ Java çš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡éœ€è¦åœ¨ä¸»å­˜å’Œå·¥ä½œå†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢ï¼š</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220302204023824.png width=900 height=600 loading=lazy decoding=async alt=image-20220302204023824 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å¦‚æœæ˜¯å•çº¿ç¨‹ä»¥ä¸Š 8 è¡Œä»£ç æ˜¯é¡ºåºæ‰§è¡Œï¼ˆä¸ä¼šäº¤é”™ï¼‰æ²¡æœ‰é—®é¢˜ï¼š</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220302204044489.png width=900 height=600 loading=lazy decoding=async alt=image-20220302204044489 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>ä½†å¤šçº¿ç¨‹ä¸‹è¿™ 8 è¡Œä»£ç å¯èƒ½äº¤é”™è¿è¡Œï¼š å‡ºç°è´Ÿæ•°çš„æƒ…å†µï¼š</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220302204119062.png width=900 height=600 loading=lazy decoding=async alt=image-20220302204119062 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å‡ºç°æ­£æ•°çš„æƒ…å†µï¼š</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220302204145687.png width=900 height=600 loading=lazy decoding=async alt=image-20220302204145687 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=ä¸´ç•ŒåŒº-critical-section><a href=#%e4%b8%b4%e7%95%8c%e5%8c%ba-critical-section class=header-anchor>#</a>
<strong>ä¸´ç•ŒåŒº Critical Section</strong></h5><ul><li><p>ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„</p></li><li><p>é—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®<strong>å…±äº«èµ„æº</strong></p><ul><li><p>å¤šä¸ªçº¿ç¨‹è¯»<strong>å…±äº«èµ„æº</strong>å…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜</p></li><li><p>åœ¨å¤šä¸ªçº¿ç¨‹å¯¹<strong>å…±äº«èµ„æº</strong>è¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜</p></li></ul></li><li><p>ä¸€æ®µä»£ç å—å†…å¦‚æœå­˜åœ¨å¯¹å…±äº«èµ„æºçš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸º<strong>ä¸´ç•ŒåŒº</strong></p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-83-1><a class=lnlinks href=#hl-83-1> 1</a>
</span><span class=lnt id=hl-83-2><a class=lnlinks href=#hl-83-2> 2</a>
</span><span class=lnt id=hl-83-3><a class=lnlinks href=#hl-83-3> 3</a>
</span><span class=lnt id=hl-83-4><a class=lnlinks href=#hl-83-4> 4</a>
</span><span class=lnt id=hl-83-5><a class=lnlinks href=#hl-83-5> 5</a>
</span><span class=lnt id=hl-83-6><a class=lnlinks href=#hl-83-6> 6</a>
</span><span class=lnt id=hl-83-7><a class=lnlinks href=#hl-83-7> 7</a>
</span><span class=lnt id=hl-83-8><a class=lnlinks href=#hl-83-8> 8</a>
</span><span class=lnt id=hl-83-9><a class=lnlinks href=#hl-83-9> 9</a>
</span><span class=lnt id=hl-83-10><a class=lnlinks href=#hl-83-10>10</a>
</span><span class=lnt id=hl-83-11><a class=lnlinks href=#hl-83-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>increment</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸´ç•ŒåŒº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decrement</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸´ç•ŒåŒº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=ç«æ€æ¡ä»¶-race-condition><a href=#%e7%ab%9e%e6%80%81%e6%9d%a1%e4%bb%b6-race-condition class=header-anchor>#</a>
<strong>ç«æ€æ¡ä»¶ Race Condition</strong></h5><p>å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„<strong>æ‰§è¡Œåºåˆ—ä¸åŒ</strong>è€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†<strong>ç«æ€æ¡ä»¶</strong></p><h2 id=42-synchronized-è§£å†³æ–¹æ¡ˆ><a href=#42-synchronized-%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 class=header-anchor>#</a>
4.2 synchronized è§£å†³æ–¹æ¡ˆ</h2><h5 id=textcolorgreenåº”ç”¨ä¹‹äº’æ–¥><a href=#textcolorgreen%e5%ba%94%e7%94%a8%e4%b9%8b%e4%ba%92%e6%96%a5 class=header-anchor>#</a>
*<em>$\textcolor{green}{<em>åº”ç”¨ä¹‹äº’æ–¥}$</em></em></h5><p>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚</p><ul><li>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼ŒLock</li><li>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡</li></ul><p>æœ¬æ¬¡è¯¾ä½¿ç”¨é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼Œæ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå³ä¿—ç§°çš„ã€å¯¹è±¡é”ã€‘ï¼Œå®ƒé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€ æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ã€å¯¹è±¡é”ã€‘ï¼Œå…¶å®ƒçº¿ç¨‹å†æƒ³è·å–è¿™ä¸ªã€å¯¹è±¡é”ã€‘æ—¶å°±ä¼šé˜»å¡ä½ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‹¥æœ‰é” çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</p><blockquote><p><strong>æ³¨æ„</strong></p><p>è™½ç„¶ java ä¸­äº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨ synchronized å…³é”®å­—æ¥å®Œæˆï¼Œä½†å®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š</p><ul><li>äº’æ–¥æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç </li><li>åŒæ­¥æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒã€éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹</li></ul></blockquote><h5 id=synchronized><a href=#synchronized class=header-anchor>#</a>
<strong>synchronized</strong></h5><p>è¯­æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-84-1><a class=lnlinks href=#hl-84-1>1</a>
</span><span class=lnt id=hl-84-2><a class=lnlinks href=#hl-84-2>2</a>
</span><span class=lnt id=hl-84-3><a class=lnlinks href=#hl-84-3>3</a>
</span><span class=lnt id=hl-84-4><a class=lnlinks href=#hl-84-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>synchronized</span><span class=p>(</span><span class=n>å¯¹è±¡</span><span class=p>)</span><span class=w> </span><span class=c1>// çº¿ç¨‹1ï¼Œ çº¿ç¨‹2(blocked)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ä¸´ç•ŒåŒº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è§£å†³</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-85-1><a class=lnlinks href=#hl-85-1> 1</a>
</span><span class=lnt id=hl-85-2><a class=lnlinks href=#hl-85-2> 2</a>
</span><span class=lnt id=hl-85-3><a class=lnlinks href=#hl-85-3> 3</a>
</span><span class=lnt id=hl-85-4><a class=lnlinks href=#hl-85-4> 4</a>
</span><span class=lnt id=hl-85-5><a class=lnlinks href=#hl-85-5> 5</a>
</span><span class=lnt id=hl-85-6><a class=lnlinks href=#hl-85-6> 6</a>
</span><span class=lnt id=hl-85-7><a class=lnlinks href=#hl-85-7> 7</a>
</span><span class=lnt id=hl-85-8><a class=lnlinks href=#hl-85-8> 8</a>
</span><span class=lnt id=hl-85-9><a class=lnlinks href=#hl-85-9> 9</a>
</span><span class=lnt id=hl-85-10><a class=lnlinks href=#hl-85-10>10</a>
</span><span class=lnt id=hl-85-11><a class=lnlinks href=#hl-85-11>11</a>
</span><span class=lnt id=hl-85-12><a class=lnlinks href=#hl-85-12>12</a>
</span><span class=lnt id=hl-85-13><a class=lnlinks href=#hl-85-13>13</a>
</span><span class=lnt id=hl-85-14><a class=lnlinks href=#hl-85-14>14</a>
</span><span class=lnt id=hl-85-15><a class=lnlinks href=#hl-85-15>15</a>
</span><span class=lnt id=hl-85-16><a class=lnlinks href=#hl-85-16>16</a>
</span><span class=lnt id=hl-85-17><a class=lnlinks href=#hl-85-17>17</a>
</span><span class=lnt id=hl-85-18><a class=lnlinks href=#hl-85-18>18</a>
</span><span class=lnt id=hl-85-19><a class=lnlinks href=#hl-85-19>19</a>
</span><span class=lnt id=hl-85-20><a class=lnlinks href=#hl-85-20>20</a>
</span><span class=lnt id=hl-85-21><a class=lnlinks href=#hl-85-21>21</a>
</span><span class=lnt id=hl-85-22><a class=lnlinks href=#hl-85-22>22</a>
</span><span class=lnt id=hl-85-23><a class=lnlinks href=#hl-85-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>room</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>counter</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>counter</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=n>counter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å›¾ç¤ºæµç¨‹</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220303001048763.png width=900 height=600 loading=lazy decoding=async alt=image-20220303001048763 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>æ€è€ƒ</strong></p><p>synchronized å®é™…æ˜¯ç”¨å¯¹è±¡é”ä¿è¯äº†ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡ æ¢æ‰€æ‰“æ–­ã€‚</p><p>ä¸ºäº†åŠ æ·±ç†è§£ï¼Œè¯·æ€è€ƒä¸‹é¢çš„é—®é¢˜</p><ul><li>å¦‚æœæŠŠ synchronized(obj) æ”¾åœ¨ for å¾ªç¯çš„å¤–é¢ï¼Œå¦‚ä½•ç†è§£ï¼Ÿ&ndash; åŸå­æ€§</li><li>å¦‚æœ t1 synchronized(obj1) è€Œ t2 synchronized(obj2) ä¼šæ€æ ·è¿ä½œï¼Ÿ&ndash; é”å¯¹è±¡</li><li>å¦‚æœ t1 synchronized(obj) è€Œ t2 æ²¡æœ‰åŠ ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚ä½•ç†è§£ï¼Ÿ&ndash; é”å¯¹è±¡</li></ul><h5 id=é¢å‘å¯¹è±¡æ”¹è¿›><a href=#%e9%9d%a2%e5%90%91%e5%af%b9%e8%b1%a1%e6%94%b9%e8%bf%9b class=header-anchor>#</a>
<strong>é¢å‘å¯¹è±¡æ”¹è¿›</strong></h5><p>æŠŠéœ€è¦ä¿æŠ¤çš„å…±äº«å˜é‡æ”¾å…¥ä¸€ä¸ªç±»</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-86-1><a class=lnlinks href=#hl-86-1> 1</a>
</span><span class=lnt id=hl-86-2><a class=lnlinks href=#hl-86-2> 2</a>
</span><span class=lnt id=hl-86-3><a class=lnlinks href=#hl-86-3> 3</a>
</span><span class=lnt id=hl-86-4><a class=lnlinks href=#hl-86-4> 4</a>
</span><span class=lnt id=hl-86-5><a class=lnlinks href=#hl-86-5> 5</a>
</span><span class=lnt id=hl-86-6><a class=lnlinks href=#hl-86-6> 6</a>
</span><span class=lnt id=hl-86-7><a class=lnlinks href=#hl-86-7> 7</a>
</span><span class=lnt id=hl-86-8><a class=lnlinks href=#hl-86-8> 8</a>
</span><span class=lnt id=hl-86-9><a class=lnlinks href=#hl-86-9> 9</a>
</span><span class=lnt id=hl-86-10><a class=lnlinks href=#hl-86-10>10</a>
</span><span class=lnt id=hl-86-11><a class=lnlinks href=#hl-86-11>11</a>
</span><span class=lnt id=hl-86-12><a class=lnlinks href=#hl-86-12>12</a>
</span><span class=lnt id=hl-86-13><a class=lnlinks href=#hl-86-13>13</a>
</span><span class=lnt id=hl-86-14><a class=lnlinks href=#hl-86-14>14</a>
</span><span class=lnt id=hl-86-15><a class=lnlinks href=#hl-86-15>15</a>
</span><span class=lnt id=hl-86-16><a class=lnlinks href=#hl-86-16>16</a>
</span><span class=lnt id=hl-86-17><a class=lnlinks href=#hl-86-17>17</a>
</span><span class=lnt id=hl-86-18><a class=lnlinks href=#hl-86-18>18</a>
</span><span class=lnt id=hl-86-19><a class=lnlinks href=#hl-86-19>19</a>
</span><span class=lnt id=hl-86-20><a class=lnlinks href=#hl-86-20>20</a>
</span><span class=lnt id=hl-86-21><a class=lnlinks href=#hl-86-21>21</a>
</span><span class=lnt id=hl-86-22><a class=lnlinks href=#hl-86-22>22</a>
</span><span class=lnt id=hl-86-23><a class=lnlinks href=#hl-86-23>23</a>
</span><span class=lnt id=hl-86-24><a class=lnlinks href=#hl-86-24>24</a>
</span><span class=lnt id=hl-86-25><a class=lnlinks href=#hl-86-25>25</a>
</span><span class=lnt id=hl-86-26><a class=lnlinks href=#hl-86-26>26</a>
</span><span class=lnt id=hl-86-27><a class=lnlinks href=#hl-86-27>27</a>
</span><span class=lnt id=hl-86-28><a class=lnlinks href=#hl-86-28>28</a>
</span><span class=lnt id=hl-86-29><a class=lnlinks href=#hl-86-29>29</a>
</span><span class=lnt id=hl-86-30><a class=lnlinks href=#hl-86-30>30</a>
</span><span class=lnt id=hl-86-31><a class=lnlinks href=#hl-86-31>31</a>
</span><span class=lnt id=hl-86-32><a class=lnlinks href=#hl-86-32>32</a>
</span><span class=lnt id=hl-86-33><a class=lnlinks href=#hl-86-33>33</a>
</span><span class=lnt id=hl-86-34><a class=lnlinks href=#hl-86-34>34</a>
</span><span class=lnt id=hl-86-35><a class=lnlinks href=#hl-86-35>35</a>
</span><span class=lnt id=hl-86-36><a class=lnlinks href=#hl-86-36>36</a>
</span><span class=lnt id=hl-86-37><a class=lnlinks href=#hl-86-37>37</a>
</span><span class=lnt id=hl-86-38><a class=lnlinks href=#hl-86-38>38</a>
</span><span class=lnt id=hl-86-39><a class=lnlinks href=#hl-86-39>39</a>
</span><span class=lnt id=hl-86-40><a class=lnlinks href=#hl-86-40>40</a>
</span><span class=lnt id=hl-86-41><a class=lnlinks href=#hl-86-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Room</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>increment</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>value</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decrement</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>value</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Room</span><span class=w> </span><span class=n>room</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Room</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>room</span><span class=p>.</span><span class=na>increment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>room</span><span class=p>.</span><span class=na>decrement</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;count: {}&#34;</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=n>room</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=43-æ–¹æ³•ä¸Šçš„-synchronized><a href=#43-%e6%96%b9%e6%b3%95%e4%b8%8a%e7%9a%84-synchronized class=header-anchor>#</a>
4.3 æ–¹æ³•ä¸Šçš„ synchronized</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-87-1><a class=lnlinks href=#hl-87-1> 1</a>
</span><span class=lnt id=hl-87-2><a class=lnlinks href=#hl-87-2> 2</a>
</span><span class=lnt id=hl-87-3><a class=lnlinks href=#hl-87-3> 3</a>
</span><span class=lnt id=hl-87-4><a class=lnlinks href=#hl-87-4> 4</a>
</span><span class=lnt id=hl-87-5><a class=lnlinks href=#hl-87-5> 5</a>
</span><span class=lnt id=hl-87-6><a class=lnlinks href=#hl-87-6> 6</a>
</span><span class=lnt id=hl-87-7><a class=lnlinks href=#hl-87-7> 7</a>
</span><span class=lnt id=hl-87-8><a class=lnlinks href=#hl-87-8> 8</a>
</span><span class=lnt id=hl-87-9><a class=lnlinks href=#hl-87-9> 9</a>
</span><span class=lnt id=hl-87-10><a class=lnlinks href=#hl-87-10>10</a>
</span><span class=lnt id=hl-87-11><a class=lnlinks href=#hl-87-11>11</a>
</span><span class=lnt id=hl-87-12><a class=lnlinks href=#hl-87-12>12</a>
</span><span class=lnt id=hl-87-13><a class=lnlinks href=#hl-87-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Test</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//ç­‰ä»·äº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Test</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-88-1><a class=lnlinks href=#hl-88-1> 1</a>
</span><span class=lnt id=hl-88-2><a class=lnlinks href=#hl-88-2> 2</a>
</span><span class=lnt id=hl-88-3><a class=lnlinks href=#hl-88-3> 3</a>
</span><span class=lnt id=hl-88-4><a class=lnlinks href=#hl-88-4> 4</a>
</span><span class=lnt id=hl-88-5><a class=lnlinks href=#hl-88-5> 5</a>
</span><span class=lnt id=hl-88-6><a class=lnlinks href=#hl-88-6> 6</a>
</span><span class=lnt id=hl-88-7><a class=lnlinks href=#hl-88-7> 7</a>
</span><span class=lnt id=hl-88-8><a class=lnlinks href=#hl-88-8> 8</a>
</span><span class=lnt id=hl-88-9><a class=lnlinks href=#hl-88-9> 9</a>
</span><span class=lnt id=hl-88-10><a class=lnlinks href=#hl-88-10>10</a>
</span><span class=lnt id=hl-88-11><a class=lnlinks href=#hl-88-11>11</a>
</span><span class=lnt id=hl-88-12><a class=lnlinks href=#hl-88-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Test</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ç­‰ä»·äº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Test</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>Test</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=ä¸åŠ -synchronized-çš„æ–¹æ³•><a href=#%e4%b8%8d%e5%8a%a0-synchronized-%e7%9a%84%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
<strong>ä¸åŠ  synchronized çš„æ–¹æ³•</strong></h5><p>ä¸åŠ  synchronzied çš„æ–¹æ³•å°±å¥½æ¯”ä¸éµå®ˆè§„åˆ™çš„äººï¼Œä¸å»è€å®æ’é˜Ÿï¼ˆå¥½æ¯”ç¿»çª—æˆ·è¿›å»çš„ï¼‰</p><h5 id=æ‰€è°“çš„çº¿ç¨‹å…«é”><a href=#%e6%89%80%e8%b0%93%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%85%ab%e9%94%81 class=header-anchor>#</a>
<strong>æ‰€è°“çš„â€œçº¿ç¨‹å…«é”â€</strong></h5><p>å…¶å®å°±æ˜¯è€ƒå¯Ÿ synchronized é”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡</p><p>æƒ…å†µ1ï¼š12 æˆ– 21</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-89-1><a class=lnlinks href=#hl-89-1> 1</a>
</span><span class=lnt id=hl-89-2><a class=lnlinks href=#hl-89-2> 2</a>
</span><span class=lnt id=hl-89-3><a class=lnlinks href=#hl-89-3> 3</a>
</span><span class=lnt id=hl-89-4><a class=lnlinks href=#hl-89-4> 4</a>
</span><span class=lnt id=hl-89-5><a class=lnlinks href=#hl-89-5> 5</a>
</span><span class=lnt id=hl-89-6><a class=lnlinks href=#hl-89-6> 6</a>
</span><span class=lnt id=hl-89-7><a class=lnlinks href=#hl-89-7> 7</a>
</span><span class=lnt id=hl-89-8><a class=lnlinks href=#hl-89-8> 8</a>
</span><span class=lnt id=hl-89-9><a class=lnlinks href=#hl-89-9> 9</a>
</span><span class=lnt id=hl-89-10><a class=lnlinks href=#hl-89-10>10</a>
</span><span class=lnt id=hl-89-11><a class=lnlinks href=#hl-89-11>11</a>
</span><span class=lnt id=hl-89-12><a class=lnlinks href=#hl-89-12>12</a>
</span><span class=lnt id=hl-89-13><a class=lnlinks href=#hl-89-13>13</a>
</span><span class=lnt id=hl-89-14><a class=lnlinks href=#hl-89-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æƒ…å†µ2ï¼š1så12ï¼Œæˆ– 2 1så 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-90-1><a class=lnlinks href=#hl-90-1> 1</a>
</span><span class=lnt id=hl-90-2><a class=lnlinks href=#hl-90-2> 2</a>
</span><span class=lnt id=hl-90-3><a class=lnlinks href=#hl-90-3> 3</a>
</span><span class=lnt id=hl-90-4><a class=lnlinks href=#hl-90-4> 4</a>
</span><span class=lnt id=hl-90-5><a class=lnlinks href=#hl-90-5> 5</a>
</span><span class=lnt id=hl-90-6><a class=lnlinks href=#hl-90-6> 6</a>
</span><span class=lnt id=hl-90-7><a class=lnlinks href=#hl-90-7> 7</a>
</span><span class=lnt id=hl-90-8><a class=lnlinks href=#hl-90-8> 8</a>
</span><span class=lnt id=hl-90-9><a class=lnlinks href=#hl-90-9> 9</a>
</span><span class=lnt id=hl-90-10><a class=lnlinks href=#hl-90-10>10</a>
</span><span class=lnt id=hl-90-11><a class=lnlinks href=#hl-90-11>11</a>
</span><span class=lnt id=hl-90-12><a class=lnlinks href=#hl-90-12>12</a>
</span><span class=lnt id=hl-90-13><a class=lnlinks href=#hl-90-13>13</a>
</span><span class=lnt id=hl-90-14><a class=lnlinks href=#hl-90-14>14</a>
</span><span class=lnt id=hl-90-15><a class=lnlinks href=#hl-90-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æƒ…å†µ3ï¼š3 1s 12 æˆ– 23 1s 1 æˆ– 32 1s 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-91-1><a class=lnlinks href=#hl-91-1> 1</a>
</span><span class=lnt id=hl-91-2><a class=lnlinks href=#hl-91-2> 2</a>
</span><span class=lnt id=hl-91-3><a class=lnlinks href=#hl-91-3> 3</a>
</span><span class=lnt id=hl-91-4><a class=lnlinks href=#hl-91-4> 4</a>
</span><span class=lnt id=hl-91-5><a class=lnlinks href=#hl-91-5> 5</a>
</span><span class=lnt id=hl-91-6><a class=lnlinks href=#hl-91-6> 6</a>
</span><span class=lnt id=hl-91-7><a class=lnlinks href=#hl-91-7> 7</a>
</span><span class=lnt id=hl-91-8><a class=lnlinks href=#hl-91-8> 8</a>
</span><span class=lnt id=hl-91-9><a class=lnlinks href=#hl-91-9> 9</a>
</span><span class=lnt id=hl-91-10><a class=lnlinks href=#hl-91-10>10</a>
</span><span class=lnt id=hl-91-11><a class=lnlinks href=#hl-91-11>11</a>
</span><span class=lnt id=hl-91-12><a class=lnlinks href=#hl-91-12>12</a>
</span><span class=lnt id=hl-91-13><a class=lnlinks href=#hl-91-13>13</a>
</span><span class=lnt id=hl-91-14><a class=lnlinks href=#hl-91-14>14</a>
</span><span class=lnt id=hl-91-15><a class=lnlinks href=#hl-91-15>15</a>
</span><span class=lnt id=hl-91-16><a class=lnlinks href=#hl-91-16>16</a>
</span><span class=lnt id=hl-91-17><a class=lnlinks href=#hl-91-17>17</a>
</span><span class=lnt id=hl-91-18><a class=lnlinks href=#hl-91-18>18</a>
</span><span class=lnt id=hl-91-19><a class=lnlinks href=#hl-91-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>c</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>c</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æƒ…å†µ4ï¼š2 1s å 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-92-1><a class=lnlinks href=#hl-92-1> 1</a>
</span><span class=lnt id=hl-92-2><a class=lnlinks href=#hl-92-2> 2</a>
</span><span class=lnt id=hl-92-3><a class=lnlinks href=#hl-92-3> 3</a>
</span><span class=lnt id=hl-92-4><a class=lnlinks href=#hl-92-4> 4</a>
</span><span class=lnt id=hl-92-5><a class=lnlinks href=#hl-92-5> 5</a>
</span><span class=lnt id=hl-92-6><a class=lnlinks href=#hl-92-6> 6</a>
</span><span class=lnt id=hl-92-7><a class=lnlinks href=#hl-92-7> 7</a>
</span><span class=lnt id=hl-92-8><a class=lnlinks href=#hl-92-8> 8</a>
</span><span class=lnt id=hl-92-9><a class=lnlinks href=#hl-92-9> 9</a>
</span><span class=lnt id=hl-92-10><a class=lnlinks href=#hl-92-10>10</a>
</span><span class=lnt id=hl-92-11><a class=lnlinks href=#hl-92-11>11</a>
</span><span class=lnt id=hl-92-12><a class=lnlinks href=#hl-92-12>12</a>
</span><span class=lnt id=hl-92-13><a class=lnlinks href=#hl-92-13>13</a>
</span><span class=lnt id=hl-92-14><a class=lnlinks href=#hl-92-14>14</a>
</span><span class=lnt id=hl-92-15><a class=lnlinks href=#hl-92-15>15</a>
</span><span class=lnt id=hl-92-16><a class=lnlinks href=#hl-92-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n2</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æƒ…å†µ5ï¼š2 1s å 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-93-1><a class=lnlinks href=#hl-93-1> 1</a>
</span><span class=lnt id=hl-93-2><a class=lnlinks href=#hl-93-2> 2</a>
</span><span class=lnt id=hl-93-3><a class=lnlinks href=#hl-93-3> 3</a>
</span><span class=lnt id=hl-93-4><a class=lnlinks href=#hl-93-4> 4</a>
</span><span class=lnt id=hl-93-5><a class=lnlinks href=#hl-93-5> 5</a>
</span><span class=lnt id=hl-93-6><a class=lnlinks href=#hl-93-6> 6</a>
</span><span class=lnt id=hl-93-7><a class=lnlinks href=#hl-93-7> 7</a>
</span><span class=lnt id=hl-93-8><a class=lnlinks href=#hl-93-8> 8</a>
</span><span class=lnt id=hl-93-9><a class=lnlinks href=#hl-93-9> 9</a>
</span><span class=lnt id=hl-93-10><a class=lnlinks href=#hl-93-10>10</a>
</span><span class=lnt id=hl-93-11><a class=lnlinks href=#hl-93-11>11</a>
</span><span class=lnt id=hl-93-12><a class=lnlinks href=#hl-93-12>12</a>
</span><span class=lnt id=hl-93-13><a class=lnlinks href=#hl-93-13>13</a>
</span><span class=lnt id=hl-93-14><a class=lnlinks href=#hl-93-14>14</a>
</span><span class=lnt id=hl-93-15><a class=lnlinks href=#hl-93-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æƒ…å†µ6ï¼š1s å12ï¼Œ æˆ– 2 1så 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-94-1><a class=lnlinks href=#hl-94-1> 1</a>
</span><span class=lnt id=hl-94-2><a class=lnlinks href=#hl-94-2> 2</a>
</span><span class=lnt id=hl-94-3><a class=lnlinks href=#hl-94-3> 3</a>
</span><span class=lnt id=hl-94-4><a class=lnlinks href=#hl-94-4> 4</a>
</span><span class=lnt id=hl-94-5><a class=lnlinks href=#hl-94-5> 5</a>
</span><span class=lnt id=hl-94-6><a class=lnlinks href=#hl-94-6> 6</a>
</span><span class=lnt id=hl-94-7><a class=lnlinks href=#hl-94-7> 7</a>
</span><span class=lnt id=hl-94-8><a class=lnlinks href=#hl-94-8> 8</a>
</span><span class=lnt id=hl-94-9><a class=lnlinks href=#hl-94-9> 9</a>
</span><span class=lnt id=hl-94-10><a class=lnlinks href=#hl-94-10>10</a>
</span><span class=lnt id=hl-94-11><a class=lnlinks href=#hl-94-11>11</a>
</span><span class=lnt id=hl-94-12><a class=lnlinks href=#hl-94-12>12</a>
</span><span class=lnt id=hl-94-13><a class=lnlinks href=#hl-94-13>13</a>
</span><span class=lnt id=hl-94-14><a class=lnlinks href=#hl-94-14>14</a>
</span><span class=lnt id=hl-94-15><a class=lnlinks href=#hl-94-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æƒ…å†µ7ï¼š2 1s å 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-95-1><a class=lnlinks href=#hl-95-1> 1</a>
</span><span class=lnt id=hl-95-2><a class=lnlinks href=#hl-95-2> 2</a>
</span><span class=lnt id=hl-95-3><a class=lnlinks href=#hl-95-3> 3</a>
</span><span class=lnt id=hl-95-4><a class=lnlinks href=#hl-95-4> 4</a>
</span><span class=lnt id=hl-95-5><a class=lnlinks href=#hl-95-5> 5</a>
</span><span class=lnt id=hl-95-6><a class=lnlinks href=#hl-95-6> 6</a>
</span><span class=lnt id=hl-95-7><a class=lnlinks href=#hl-95-7> 7</a>
</span><span class=lnt id=hl-95-8><a class=lnlinks href=#hl-95-8> 8</a>
</span><span class=lnt id=hl-95-9><a class=lnlinks href=#hl-95-9> 9</a>
</span><span class=lnt id=hl-95-10><a class=lnlinks href=#hl-95-10>10</a>
</span><span class=lnt id=hl-95-11><a class=lnlinks href=#hl-95-11>11</a>
</span><span class=lnt id=hl-95-12><a class=lnlinks href=#hl-95-12>12</a>
</span><span class=lnt id=hl-95-13><a class=lnlinks href=#hl-95-13>13</a>
</span><span class=lnt id=hl-95-14><a class=lnlinks href=#hl-95-14>14</a>
</span><span class=lnt id=hl-95-15><a class=lnlinks href=#hl-95-15>15</a>
</span><span class=lnt id=hl-95-16><a class=lnlinks href=#hl-95-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n2</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æƒ…å†µ8ï¼š1s å12ï¼Œ æˆ– 2 1så 1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-96-1><a class=lnlinks href=#hl-96-1> 1</a>
</span><span class=lnt id=hl-96-2><a class=lnlinks href=#hl-96-2> 2</a>
</span><span class=lnt id=hl-96-3><a class=lnlinks href=#hl-96-3> 3</a>
</span><span class=lnt id=hl-96-4><a class=lnlinks href=#hl-96-4> 4</a>
</span><span class=lnt id=hl-96-5><a class=lnlinks href=#hl-96-5> 5</a>
</span><span class=lnt id=hl-96-6><a class=lnlinks href=#hl-96-6> 6</a>
</span><span class=lnt id=hl-96-7><a class=lnlinks href=#hl-96-7> 7</a>
</span><span class=lnt id=hl-96-8><a class=lnlinks href=#hl-96-8> 8</a>
</span><span class=lnt id=hl-96-9><a class=lnlinks href=#hl-96-9> 9</a>
</span><span class=lnt id=hl-96-10><a class=lnlinks href=#hl-96-10>10</a>
</span><span class=lnt id=hl-96-11><a class=lnlinks href=#hl-96-11>11</a>
</span><span class=lnt id=hl-96-12><a class=lnlinks href=#hl-96-12>12</a>
</span><span class=lnt id=hl-96-13><a class=lnlinks href=#hl-96-13>13</a>
</span><span class=lnt id=hl-96-14><a class=lnlinks href=#hl-96-14>14</a>
</span><span class=lnt id=hl-96-15><a class=lnlinks href=#hl-96-15>15</a>
</span><span class=lnt id=hl-96-16><a class=lnlinks href=#hl-96-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Number&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Number</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Number</span><span class=w> </span><span class=n>n2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Number</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n1</span><span class=p>.</span><span class=na>a</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> </span><span class=n>n2</span><span class=p>.</span><span class=na>b</span><span class=p>();</span><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=44-å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ><a href=#44-%e5%8f%98%e9%87%8f%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e5%88%86%e6%9e%90 class=header-anchor>#</a>
4.4 å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ</h2><h5 id=æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨><a href=#%e6%88%90%e5%91%98%e5%8f%98%e9%87%8f%e5%92%8c%e9%9d%99%e6%80%81%e5%8f%98%e9%87%8f%e6%98%af%e5%90%a6%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8 class=header-anchor>#</a>
<strong>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</strong></h5><ul><li>å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li><li>å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆåˆ†ä¸¤ç§æƒ…å†µ<ul><li>å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li><li>å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li></ul></li></ul><h5 id=å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨><a href=#%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%e6%98%af%e5%90%a6%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8 class=header-anchor>#</a>
<strong>å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</strong></h5><ul><li>å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„</li><li>ä½†å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡åˆ™æœªå¿…<ul><li>å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„</li><li>å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li></ul></li></ul><h5 id=å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ><a href=#%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e5%88%86%e6%9e%90 class=header-anchor>#</a>
<strong>å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-97-1><a class=lnlinks href=#hl-97-1>1</a>
</span><span class=lnt id=hl-97-2><a class=lnlinks href=#hl-97-2>2</a>
</span><span class=lnt id=hl-97-3><a class=lnlinks href=#hl-97-3>3</a>
</span><span class=lnt id=hl-97-4><a class=lnlinks href=#hl-97-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>i</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ¯ä¸ªçº¿ç¨‹è°ƒç”¨ test1() æ–¹æ³•æ—¶å±€éƒ¨å˜é‡ iï¼Œä¼šåœ¨æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§å†…å­˜ä¸­è¢«åˆ›å»ºå¤šä»½ï¼Œå› æ­¤ä¸å­˜åœ¨å…±äº«</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-98-1><a class=lnlinks href=#hl-98-1> 1</a>
</span><span class=lnt id=hl-98-2><a class=lnlinks href=#hl-98-2> 2</a>
</span><span class=lnt id=hl-98-3><a class=lnlinks href=#hl-98-3> 3</a>
</span><span class=lnt id=hl-98-4><a class=lnlinks href=#hl-98-4> 4</a>
</span><span class=lnt id=hl-98-5><a class=lnlinks href=#hl-98-5> 5</a>
</span><span class=lnt id=hl-98-6><a class=lnlinks href=#hl-98-6> 6</a>
</span><span class=lnt id=hl-98-7><a class=lnlinks href=#hl-98-7> 7</a>
</span><span class=lnt id=hl-98-8><a class=lnlinks href=#hl-98-8> 8</a>
</span><span class=lnt id=hl-98-9><a class=lnlinks href=#hl-98-9> 9</a>
</span><span class=lnt id=hl-98-10><a class=lnlinks href=#hl-98-10>10</a>
</span><span class=lnt id=hl-98-11><a class=lnlinks href=#hl-98-11>11</a>
</span><span class=lnt id=hl-98-12><a class=lnlinks href=#hl-98-12>12</a>
</span><span class=lnt id=hl-98-13><a class=lnlinks href=#hl-98-13>13</a>
</span><span class=lnt id=hl-98-14><a class=lnlinks href=#hl-98-14>14</a>
</span><span class=lnt id=hl-98-15><a class=lnlinks href=#hl-98-15>15</a>
</span><span class=lnt id=hl-98-16><a class=lnlinks href=#hl-98-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>descriptor</span><span class=p>:</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>flags</span><span class=p>:</span><span class=w> </span><span class=n>ACC_PUBLIC</span><span class=p>,</span><span class=w> </span><span class=n>ACC_STATIC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>stack</span><span class=o>=</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>locals</span><span class=o>=</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>args_size</span><span class=o>=</span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>bipush</span><span class=w> </span><span class=n>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>2</span><span class=p>:</span><span class=w> </span><span class=n>istore_0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>3</span><span class=p>:</span><span class=w> </span><span class=n>iinc</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>6</span><span class=p>:</span><span class=w> </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>LineNumberTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>line</span><span class=w> </span><span class=n>10</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>line</span><span class=w> </span><span class=n>11</span><span class=p>:</span><span class=w> </span><span class=n>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>line</span><span class=w> </span><span class=n>12</span><span class=p>:</span><span class=w> </span><span class=n>6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>LocalVariableTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Start</span><span class=w> </span><span class=n>Length</span><span class=w> </span><span class=n>Slot</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=n>Signature</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>3</span><span class=w>        </span><span class=n>4</span><span class=w>     </span><span class=n>0</span><span class=w>   </span><span class=n>i</span><span class=w>      </span><span class=n>I</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¦‚å›¾</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220303005909688.png width=900 height=600 loading=lazy decoding=async alt=image-20220303005909688 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å±€éƒ¨å˜é‡çš„å¼•ç”¨ç¨æœ‰ä¸åŒ</p><p>å…ˆçœ‹ä¸€ä¸ªæˆå‘˜å˜é‡çš„ä¾‹å­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-99-1><a class=lnlinks href=#hl-99-1> 1</a>
</span><span class=lnt id=hl-99-2><a class=lnlinks href=#hl-99-2> 2</a>
</span><span class=lnt id=hl-99-3><a class=lnlinks href=#hl-99-3> 3</a>
</span><span class=lnt id=hl-99-4><a class=lnlinks href=#hl-99-4> 4</a>
</span><span class=lnt id=hl-99-5><a class=lnlinks href=#hl-99-5> 5</a>
</span><span class=lnt id=hl-99-6><a class=lnlinks href=#hl-99-6> 6</a>
</span><span class=lnt id=hl-99-7><a class=lnlinks href=#hl-99-7> 7</a>
</span><span class=lnt id=hl-99-8><a class=lnlinks href=#hl-99-8> 8</a>
</span><span class=lnt id=hl-99-9><a class=lnlinks href=#hl-99-9> 9</a>
</span><span class=lnt id=hl-99-10><a class=lnlinks href=#hl-99-10>10</a>
</span><span class=lnt id=hl-99-11><a class=lnlinks href=#hl-99-11>11</a>
</span><span class=lnt id=hl-99-12><a class=lnlinks href=#hl-99-12>12</a>
</span><span class=lnt id=hl-99-13><a class=lnlinks href=#hl-99-13>13</a>
</span><span class=lnt id=hl-99-14><a class=lnlinks href=#hl-99-14>14</a>
</span><span class=lnt id=hl-99-15><a class=lnlinks href=#hl-99-15>15</a>
</span><span class=lnt id=hl-99-16><a class=lnlinks href=#hl-99-16>16</a>
</span><span class=lnt id=hl-99-17><a class=lnlinks href=#hl-99-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ThreadUnsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// { ä¸´ç•ŒåŒº, ä¼šäº§ç”Ÿç«æ€æ¡ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method3</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// } ä¸´ç•ŒåŒº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-100-1><a class=lnlinks href=#hl-100-1> 1</a>
</span><span class=lnt id=hl-100-2><a class=lnlinks href=#hl-100-2> 2</a>
</span><span class=lnt id=hl-100-3><a class=lnlinks href=#hl-100-3> 3</a>
</span><span class=lnt id=hl-100-4><a class=lnlinks href=#hl-100-4> 4</a>
</span><span class=lnt id=hl-100-5><a class=lnlinks href=#hl-100-5> 5</a>
</span><span class=lnt id=hl-100-6><a class=lnlinks href=#hl-100-6> 6</a>
</span><span class=lnt id=hl-100-7><a class=lnlinks href=#hl-100-7> 7</a>
</span><span class=lnt id=hl-100-8><a class=lnlinks href=#hl-100-8> 8</a>
</span><span class=lnt id=hl-100-9><a class=lnlinks href=#hl-100-9> 9</a>
</span><span class=lnt id=hl-100-10><a class=lnlinks href=#hl-100-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>THREAD_NUMBER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>LOOP_NUMBER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>200</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ThreadUnsafe</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadUnsafe</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>THREAD_NUMBER</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>test</span><span class=p>.</span><span class=na>method1</span><span class=p>(</span><span class=n>LOOP_NUMBER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;Thread&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ä¸€ç§æƒ…å†µæ˜¯ï¼Œå¦‚æœçº¿ç¨‹2 è¿˜æœª addï¼Œçº¿ç¨‹1 remove å°±ä¼šæŠ¥é”™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-101-1><a class=lnlinks href=#hl-101-1>1</a>
</span><span class=lnt id=hl-101-2><a class=lnlinks href=#hl-101-2>2</a>
</span><span class=lnt id=hl-101-3><a class=lnlinks href=#hl-101-3>3</a>
</span><span class=lnt id=hl-101-4><a class=lnlinks href=#hl-101-4>4</a>
</span><span class=lnt id=hl-101-5><a class=lnlinks href=#hl-101-5>5</a>
</span><span class=lnt id=hl-101-6><a class=lnlinks href=#hl-101-6>6</a>
</span><span class=lnt id=hl-101-7><a class=lnlinks href=#hl-101-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Exception</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=s>&#34;Thread1&#34;</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>IndexOutOfBoundsException</span><span class=p>:</span><span class=w> </span><span class=n>Index</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>Size</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>ArrayList</span><span class=p>.</span><span class=na>rangeCheck</span><span class=p>(</span><span class=n>ArrayList</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>657</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>ArrayList</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>ArrayList</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>496</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>n6</span><span class=p>.</span><span class=na>ThreadUnsafe</span><span class=p>.</span><span class=na>method3</span><span class=p>(</span><span class=n>TestThreadSafe</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>35</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>n6</span><span class=p>.</span><span class=na>ThreadUnsafe</span><span class=p>.</span><span class=na>method1</span><span class=p>(</span><span class=n>TestThreadSafe</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>26</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>n6</span><span class=p>.</span><span class=na>TestThreadSafe</span><span class=p>.</span><span class=na>lambda$main$0</span><span class=p>(</span><span class=n>TestThreadSafe</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>14</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>748</span><span class=p>)</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>åˆ†æï¼š</p><ul><li>æ— è®ºå“ªä¸ªçº¿ç¨‹ä¸­çš„ method2 å¼•ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ä¸­çš„ list æˆå‘˜å˜é‡</li><li>method3 ä¸ method2 åˆ†æç›¸åŒ</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220303010311338.png width=900 height=600 loading=lazy decoding=async alt=image-20220303010311338 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å°† list ä¿®æ”¹ä¸ºå±€éƒ¨å˜é‡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-102-1><a class=lnlinks href=#hl-102-1> 1</a>
</span><span class=lnt id=hl-102-2><a class=lnlinks href=#hl-102-2> 2</a>
</span><span class=lnt id=hl-102-3><a class=lnlinks href=#hl-102-3> 3</a>
</span><span class=lnt id=hl-102-4><a class=lnlinks href=#hl-102-4> 4</a>
</span><span class=lnt id=hl-102-5><a class=lnlinks href=#hl-102-5> 5</a>
</span><span class=lnt id=hl-102-6><a class=lnlinks href=#hl-102-6> 6</a>
</span><span class=lnt id=hl-102-7><a class=lnlinks href=#hl-102-7> 7</a>
</span><span class=lnt id=hl-102-8><a class=lnlinks href=#hl-102-8> 8</a>
</span><span class=lnt id=hl-102-9><a class=lnlinks href=#hl-102-9> 9</a>
</span><span class=lnt id=hl-102-10><a class=lnlinks href=#hl-102-10>10</a>
</span><span class=lnt id=hl-102-11><a class=lnlinks href=#hl-102-11>11</a>
</span><span class=lnt id=hl-102-12><a class=lnlinks href=#hl-102-12>12</a>
</span><span class=lnt id=hl-102-13><a class=lnlinks href=#hl-102-13>13</a>
</span><span class=lnt id=hl-102-14><a class=lnlinks href=#hl-102-14>14</a>
</span><span class=lnt id=hl-102-15><a class=lnlinks href=#hl-102-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ThreadSafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method2</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method3</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é‚£ä¹ˆå°±ä¸ä¼šæœ‰ä¸Šè¿°é—®é¢˜äº†</p><p>åˆ†æï¼š</p><ul><li>list æ˜¯å±€éƒ¨å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨æ—¶ä¼šåˆ›å»ºå…¶ä¸åŒå®ä¾‹ï¼Œæ²¡æœ‰å…±äº«</li><li>è€Œ method2 çš„å‚æ•°æ˜¯ä» method1 ä¸­ä¼ é€’è¿‡æ¥çš„ï¼Œä¸ method1 ä¸­å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡</li><li>method3 çš„å‚æ•°åˆ†æä¸ method2 ç›¸åŒ</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220303010518661.png width=900 height=600 loading=lazy decoding=async alt=image-20220303010518661 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æ–¹æ³•è®¿é—®ä¿®é¥°ç¬¦å¸¦æ¥çš„æ€è€ƒï¼Œå¦‚æœæŠŠ method2 å’Œ method3 çš„æ–¹æ³•ä¿®æ”¹ä¸º public ä¼šä¸ä¼šä»£ç†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</p><ul><li>æƒ…å†µ1ï¼šæœ‰å…¶å®ƒçº¿ç¨‹è°ƒç”¨ method2 å’Œ method3</li><li>æƒ…å†µ2ï¼šåœ¨ æƒ…å†µ1 çš„åŸºç¡€ä¸Šï¼Œä¸º ThreadSafe ç±»æ·»åŠ å­ç±»ï¼Œå­ç±»è¦†ç›– method2 æˆ– method3 æ–¹æ³•ï¼Œ</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-103-1><a class=lnlinks href=#hl-103-1> 1</a>
</span><span class=lnt id=hl-103-2><a class=lnlinks href=#hl-103-2> 2</a>
</span><span class=lnt id=hl-103-3><a class=lnlinks href=#hl-103-3> 3</a>
</span><span class=lnt id=hl-103-4><a class=lnlinks href=#hl-103-4> 4</a>
</span><span class=lnt id=hl-103-5><a class=lnlinks href=#hl-103-5> 5</a>
</span><span class=lnt id=hl-103-6><a class=lnlinks href=#hl-103-6> 6</a>
</span><span class=lnt id=hl-103-7><a class=lnlinks href=#hl-103-7> 7</a>
</span><span class=lnt id=hl-103-8><a class=lnlinks href=#hl-103-8> 8</a>
</span><span class=lnt id=hl-103-9><a class=lnlinks href=#hl-103-9> 9</a>
</span><span class=lnt id=hl-103-10><a class=lnlinks href=#hl-103-10>10</a>
</span><span class=lnt id=hl-103-11><a class=lnlinks href=#hl-103-11>11</a>
</span><span class=lnt id=hl-103-12><a class=lnlinks href=#hl-103-12>12</a>
</span><span class=lnt id=hl-103-13><a class=lnlinks href=#hl-103-13>13</a>
</span><span class=lnt id=hl-103-14><a class=lnlinks href=#hl-103-14>14</a>
</span><span class=lnt id=hl-103-15><a class=lnlinks href=#hl-103-15>15</a>
</span><span class=lnt id=hl-103-16><a class=lnlinks href=#hl-103-16>16</a>
</span><span class=lnt id=hl-103-17><a class=lnlinks href=#hl-103-17>17</a>
</span><span class=lnt id=hl-103-18><a class=lnlinks href=#hl-103-18>18</a>
</span><span class=lnt id=hl-103-19><a class=lnlinks href=#hl-103-19>19</a>
</span><span class=lnt id=hl-103-20><a class=lnlinks href=#hl-103-20>20</a>
</span><span class=lnt id=hl-103-21><a class=lnlinks href=#hl-103-21>21</a>
</span><span class=lnt id=hl-103-22><a class=lnlinks href=#hl-103-22>22</a>
</span><span class=lnt id=hl-103-23><a class=lnlinks href=#hl-103-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ThreadSafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method2</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method3</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>ThreadSafeSubClass</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ThreadSafe</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>ä»è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡º private æˆ– final æä¾›ã€å®‰å…¨ã€‘çš„æ„ä¹‰æ‰€åœ¨ï¼Œè¯·ä½“ä¼šå¼€é—­åŸåˆ™ä¸­çš„ã€é—­ã€‘</p></blockquote><h5 id=å¸¸è§çº¿ç¨‹å®‰å…¨ç±»><a href=#%e5%b8%b8%e8%a7%81%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e7%b1%bb class=header-anchor>#</a>
<strong>å¸¸è§çº¿ç¨‹å®‰å…¨ç±»</strong></h5><ul><li>String</li><li>Integer</li><li>StringBuffer</li><li>Random</li><li>Vector</li><li>Hashtable</li><li>java.util.concurrent åŒ…ä¸‹çš„ç±»</li></ul><p>è¿™é‡Œè¯´å®ƒä»¬æ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯æŒ‡ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-104-1><a class=lnlinks href=#hl-104-1>1</a>
</span><span class=lnt id=hl-104-2><a class=lnlinks href=#hl-104-2>2</a>
</span><span class=lnt id=hl-104-3><a class=lnlinks href=#hl-104-3>3</a>
</span><span class=lnt id=hl-104-4><a class=lnlinks href=#hl-104-4>4</a>
</span><span class=lnt id=hl-104-5><a class=lnlinks href=#hl-104-5>5</a>
</span><span class=lnt id=hl-104-6><a class=lnlinks href=#hl-104-6>6</a>
</span><span class=lnt id=hl-104-7><a class=lnlinks href=#hl-104-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Hashtable</span><span class=w> </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hashtable</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>table</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>table</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å®ƒä»¬çš„æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„</li><li>ä½†æ³¨æ„å®ƒä»¬å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„ï¼Œè§åé¢åˆ†æ</li></ul><p><strong>çº¿ç¨‹å®‰å…¨ç±»æ–¹æ³•çš„ç»„åˆ</strong></p><p>åˆ†æä¸‹é¢ä»£ç æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-105-1><a class=lnlinks href=#hl-105-1>1</a>
</span><span class=lnt id=hl-105-2><a class=lnlinks href=#hl-105-2>2</a>
</span><span class=lnt id=hl-105-3><a class=lnlinks href=#hl-105-3>3</a>
</span><span class=lnt id=hl-105-4><a class=lnlinks href=#hl-105-4>4</a>
</span><span class=lnt id=hl-105-5><a class=lnlinks href=#hl-105-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Hashtable</span><span class=w> </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hashtable</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// çº¿ç¨‹1ï¼Œçº¿ç¨‹2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>table</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>table</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220303011322077.png width=900 height=600 loading=lazy decoding=async alt=image-20220303011322077 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨æ€§</strong></p><p>Stringã€Integer ç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜ï¼Œå› æ­¤å®ƒä»¬çš„æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ æœ‰åŒå­¦æˆ–è®¸æœ‰ç–‘é—®ï¼ŒString æœ‰ replaceï¼Œsubstring ç­‰æ–¹æ³•ã€å¯ä»¥ã€‘æ”¹å˜å€¼å•Šï¼Œé‚£ä¹ˆè¿™äº›æ–¹æ³•åˆæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰ å…¨çš„å‘¢ï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-106-1><a class=lnlinks href=#hl-106-1>1</a>
</span><span class=lnt id=hl-106-2><a class=lnlinks href=#hl-106-2>2</a>
</span><span class=lnt id=hl-106-3><a class=lnlinks href=#hl-106-3>3</a>
</span><span class=lnt id=hl-106-4><a class=lnlinks href=#hl-106-4>4</a>
</span><span class=lnt id=hl-106-5><a class=lnlinks href=#hl-106-5>5</a>
</span><span class=lnt id=hl-106-6><a class=lnlinks href=#hl-106-6>6</a>
</span><span class=lnt id=hl-106-7><a class=lnlinks href=#hl-106-7>7</a>
</span><span class=lnt id=hl-106-8><a class=lnlinks href=#hl-106-8>8</a>
</span><span class=lnt id=hl-106-9><a class=lnlinks href=#hl-106-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Immutable</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Immutable</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getValue</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¦‚æœæƒ³å¢åŠ ä¸€ä¸ªå¢åŠ çš„æ–¹æ³•å‘¢ï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-107-1><a class=lnlinks href=#hl-107-1> 1</a>
</span><span class=lnt id=hl-107-2><a class=lnlinks href=#hl-107-2> 2</a>
</span><span class=lnt id=hl-107-3><a class=lnlinks href=#hl-107-3> 3</a>
</span><span class=lnt id=hl-107-4><a class=lnlinks href=#hl-107-4> 4</a>
</span><span class=lnt id=hl-107-5><a class=lnlinks href=#hl-107-5> 5</a>
</span><span class=lnt id=hl-107-6><a class=lnlinks href=#hl-107-6> 6</a>
</span><span class=lnt id=hl-107-7><a class=lnlinks href=#hl-107-7> 7</a>
</span><span class=lnt id=hl-107-8><a class=lnlinks href=#hl-107-8> 8</a>
</span><span class=lnt id=hl-107-9><a class=lnlinks href=#hl-107-9> 9</a>
</span><span class=lnt id=hl-107-10><a class=lnlinks href=#hl-107-10>10</a>
</span><span class=lnt id=hl-107-11><a class=lnlinks href=#hl-107-11>11</a>
</span><span class=lnt id=hl-107-12><a class=lnlinks href=#hl-107-12>12</a>
</span><span class=lnt id=hl-107-13><a class=lnlinks href=#hl-107-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Immutable</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Immutable</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getValue</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Immutable</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>v</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Immutable</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>v</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=å®ä¾‹åˆ†æ><a href=#%e5%ae%9e%e4%be%8b%e5%88%86%e6%9e%90 class=header-anchor>#</a>
å®ä¾‹åˆ†æ</h5><p>ä¾‹1ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-108-1><a class=lnlinks href=#hl-108-1> 1</a>
</span><span class=lnt id=hl-108-2><a class=lnlinks href=#hl-108-2> 2</a>
</span><span class=lnt id=hl-108-3><a class=lnlinks href=#hl-108-3> 3</a>
</span><span class=lnt id=hl-108-4><a class=lnlinks href=#hl-108-4> 4</a>
</span><span class=lnt id=hl-108-5><a class=lnlinks href=#hl-108-5> 5</a>
</span><span class=lnt id=hl-108-6><a class=lnlinks href=#hl-108-6> 6</a>
</span><span class=lnt id=hl-108-7><a class=lnlinks href=#hl-108-7> 7</a>
</span><span class=lnt id=hl-108-8><a class=lnlinks href=#hl-108-8> 8</a>
</span><span class=lnt id=hl-108-9><a class=lnlinks href=#hl-108-9> 9</a>
</span><span class=lnt id=hl-108-10><a class=lnlinks href=#hl-108-10>10</a>
</span><span class=lnt id=hl-108-11><a class=lnlinks href=#hl-108-11>11</a>
</span><span class=lnt id=hl-108-12><a class=lnlinks href=#hl-108-12>12</a>
</span><span class=lnt id=hl-108-13><a class=lnlinks href=#hl-108-13>13</a>
</span><span class=lnt id=hl-108-14><a class=lnlinks href=#hl-108-14>14</a>
</span><span class=lnt id=hl-108-15><a class=lnlinks href=#hl-108-15>15</a>
</span><span class=lnt id=hl-108-16><a class=lnlinks href=#hl-108-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyServlet</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨ï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨ï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>S1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;...&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨ï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>S2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;...&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨ï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Date</span><span class=w> </span><span class=n>D1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨ï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=n>D2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä½¿ç”¨ä¸Šè¿°å˜é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¾‹2ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-109-1><a class=lnlinks href=#hl-109-1> 1</a>
</span><span class=lnt id=hl-109-2><a class=lnlinks href=#hl-109-2> 2</a>
</span><span class=lnt id=hl-109-3><a class=lnlinks href=#hl-109-3> 3</a>
</span><span class=lnt id=hl-109-4><a class=lnlinks href=#hl-109-4> 4</a>
</span><span class=lnt id=hl-109-5><a class=lnlinks href=#hl-109-5> 5</a>
</span><span class=lnt id=hl-109-6><a class=lnlinks href=#hl-109-6> 6</a>
</span><span class=lnt id=hl-109-7><a class=lnlinks href=#hl-109-7> 7</a>
</span><span class=lnt id=hl-109-8><a class=lnlinks href=#hl-109-8> 8</a>
</span><span class=lnt id=hl-109-9><a class=lnlinks href=#hl-109-9> 9</a>
</span><span class=lnt id=hl-109-10><a class=lnlinks href=#hl-109-10>10</a>
</span><span class=lnt id=hl-109-11><a class=lnlinks href=#hl-109-11>11</a>
</span><span class=lnt id=hl-109-12><a class=lnlinks href=#hl-109-12>12</a>
</span><span class=lnt id=hl-109-13><a class=lnlinks href=#hl-109-13>13</a>
</span><span class=lnt id=hl-109-14><a class=lnlinks href=#hl-109-14>14</a>
</span><span class=lnt id=hl-109-15><a class=lnlinks href=#hl-109-15>15</a>
</span><span class=lnt id=hl-109-16><a class=lnlinks href=#hl-109-16>16</a>
</span><span class=lnt id=hl-109-17><a class=lnlinks href=#hl-109-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyServlet</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨ï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=n>userService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserServiceImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userService</span><span class=p>.</span><span class=na>update</span><span class=p>(...);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è®°å½•è°ƒç”¨æ¬¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¾‹3ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-110-1><a class=lnlinks href=#hl-110-1> 1</a>
</span><span class=lnt id=hl-110-2><a class=lnlinks href=#hl-110-2> 2</a>
</span><span class=lnt id=hl-110-3><a class=lnlinks href=#hl-110-3> 3</a>
</span><span class=lnt id=hl-110-4><a class=lnlinks href=#hl-110-4> 4</a>
</span><span class=lnt id=hl-110-5><a class=lnlinks href=#hl-110-5> 5</a>
</span><span class=lnt id=hl-110-6><a class=lnlinks href=#hl-110-6> 6</a>
</span><span class=lnt id=hl-110-7><a class=lnlinks href=#hl-110-7> 7</a>
</span><span class=lnt id=hl-110-8><a class=lnlinks href=#hl-110-8> 8</a>
</span><span class=lnt id=hl-110-9><a class=lnlinks href=#hl-110-9> 9</a>
</span><span class=lnt id=hl-110-10><a class=lnlinks href=#hl-110-10>10</a>
</span><span class=lnt id=hl-110-11><a class=lnlinks href=#hl-110-11>11</a>
</span><span class=lnt id=hl-110-12><a class=lnlinks href=#hl-110-12>12</a>
</span><span class=lnt id=hl-110-13><a class=lnlinks href=#hl-110-13>13</a>
</span><span class=lnt id=hl-110-14><a class=lnlinks href=#hl-110-14>14</a>
</span><span class=lnt id=hl-110-15><a class=lnlinks href=#hl-110-15>15</a>
</span><span class=lnt id=hl-110-16><a class=lnlinks href=#hl-110-16>16</a>
</span><span class=lnt id=hl-110-17><a class=lnlinks href=#hl-110-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Aspect</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyAspect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨ï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Before</span><span class=p>(</span><span class=s>&#34;execution(* *(..))&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>before</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@After</span><span class=p>(</span><span class=s>&#34;execution(* *(..))&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>after</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;cost time:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=o>-</span><span class=n>start</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¾‹4:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-111-1><a class=lnlinks href=#hl-111-1> 1</a>
</span><span class=lnt id=hl-111-2><a class=lnlinks href=#hl-111-2> 2</a>
</span><span class=lnt id=hl-111-3><a class=lnlinks href=#hl-111-3> 3</a>
</span><span class=lnt id=hl-111-4><a class=lnlinks href=#hl-111-4> 4</a>
</span><span class=lnt id=hl-111-5><a class=lnlinks href=#hl-111-5> 5</a>
</span><span class=lnt id=hl-111-6><a class=lnlinks href=#hl-111-6> 6</a>
</span><span class=lnt id=hl-111-7><a class=lnlinks href=#hl-111-7> 7</a>
</span><span class=lnt id=hl-111-8><a class=lnlinks href=#hl-111-8> 8</a>
</span><span class=lnt id=hl-111-9><a class=lnlinks href=#hl-111-9> 9</a>
</span><span class=lnt id=hl-111-10><a class=lnlinks href=#hl-111-10>10</a>
</span><span class=lnt id=hl-111-11><a class=lnlinks href=#hl-111-11>11</a>
</span><span class=lnt id=hl-111-12><a class=lnlinks href=#hl-111-12>12</a>
</span><span class=lnt id=hl-111-13><a class=lnlinks href=#hl-111-13>13</a>
</span><span class=lnt id=hl-111-14><a class=lnlinks href=#hl-111-14>14</a>
</span><span class=lnt id=hl-111-15><a class=lnlinks href=#hl-111-15>15</a>
</span><span class=lnt id=hl-111-16><a class=lnlinks href=#hl-111-16>16</a>
</span><span class=lnt id=hl-111-17><a class=lnlinks href=#hl-111-17>17</a>
</span><span class=lnt id=hl-111-18><a class=lnlinks href=#hl-111-18>18</a>
</span><span class=lnt id=hl-111-19><a class=lnlinks href=#hl-111-19>19</a>
</span><span class=lnt id=hl-111-20><a class=lnlinks href=#hl-111-20>20</a>
</span><span class=lnt id=hl-111-21><a class=lnlinks href=#hl-111-21>21</a>
</span><span class=lnt id=hl-111-22><a class=lnlinks href=#hl-111-22>22</a>
</span><span class=lnt id=hl-111-23><a class=lnlinks href=#hl-111-23>23</a>
</span><span class=lnt id=hl-111-24><a class=lnlinks href=#hl-111-24>24</a>
</span><span class=lnt id=hl-111-25><a class=lnlinks href=#hl-111-25>25</a>
</span><span class=lnt id=hl-111-26><a class=lnlinks href=#hl-111-26>26</a>
</span><span class=lnt id=hl-111-27><a class=lnlinks href=#hl-111-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyServlet</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=n>userService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserServiceImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userService</span><span class=p>.</span><span class=na>update</span><span class=p>(...);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=n>userDao</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserDaoImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userDao</span><span class=p>.</span><span class=na>update</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserDaoImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;update user set password = ? where username = ?&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ˜¯å¦å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>Connection</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DriverManager</span><span class=p>.</span><span class=na>getConnection</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¾‹5:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-112-1><a class=lnlinks href=#hl-112-1> 1</a>
</span><span class=lnt id=hl-112-2><a class=lnlinks href=#hl-112-2> 2</a>
</span><span class=lnt id=hl-112-3><a class=lnlinks href=#hl-112-3> 3</a>
</span><span class=lnt id=hl-112-4><a class=lnlinks href=#hl-112-4> 4</a>
</span><span class=lnt id=hl-112-5><a class=lnlinks href=#hl-112-5> 5</a>
</span><span class=lnt id=hl-112-6><a class=lnlinks href=#hl-112-6> 6</a>
</span><span class=lnt id=hl-112-7><a class=lnlinks href=#hl-112-7> 7</a>
</span><span class=lnt id=hl-112-8><a class=lnlinks href=#hl-112-8> 8</a>
</span><span class=lnt id=hl-112-9><a class=lnlinks href=#hl-112-9> 9</a>
</span><span class=lnt id=hl-112-10><a class=lnlinks href=#hl-112-10>10</a>
</span><span class=lnt id=hl-112-11><a class=lnlinks href=#hl-112-11>11</a>
</span><span class=lnt id=hl-112-12><a class=lnlinks href=#hl-112-12>12</a>
</span><span class=lnt id=hl-112-13><a class=lnlinks href=#hl-112-13>13</a>
</span><span class=lnt id=hl-112-14><a class=lnlinks href=#hl-112-14>14</a>
</span><span class=lnt id=hl-112-15><a class=lnlinks href=#hl-112-15>15</a>
</span><span class=lnt id=hl-112-16><a class=lnlinks href=#hl-112-16>16</a>
</span><span class=lnt id=hl-112-17><a class=lnlinks href=#hl-112-17>17</a>
</span><span class=lnt id=hl-112-18><a class=lnlinks href=#hl-112-18>18</a>
</span><span class=lnt id=hl-112-19><a class=lnlinks href=#hl-112-19>19</a>
</span><span class=lnt id=hl-112-20><a class=lnlinks href=#hl-112-20>20</a>
</span><span class=lnt id=hl-112-21><a class=lnlinks href=#hl-112-21>21</a>
</span><span class=lnt id=hl-112-22><a class=lnlinks href=#hl-112-22>22</a>
</span><span class=lnt id=hl-112-23><a class=lnlinks href=#hl-112-23>23</a>
</span><span class=lnt id=hl-112-24><a class=lnlinks href=#hl-112-24>24</a>
</span><span class=lnt id=hl-112-25><a class=lnlinks href=#hl-112-25>25</a>
</span><span class=lnt id=hl-112-26><a class=lnlinks href=#hl-112-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyServlet</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=n>userService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserServiceImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userService</span><span class=p>.</span><span class=na>update</span><span class=p>(...);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=n>userDao</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserDaoImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userDao</span><span class=p>.</span><span class=na>update</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserDaoImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>SQLException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;update user set password = ? where username = ?&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DriverManager</span><span class=p>.</span><span class=na>getConnection</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>conn</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¾‹6ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-113-1><a class=lnlinks href=#hl-113-1> 1</a>
</span><span class=lnt id=hl-113-2><a class=lnlinks href=#hl-113-2> 2</a>
</span><span class=lnt id=hl-113-3><a class=lnlinks href=#hl-113-3> 3</a>
</span><span class=lnt id=hl-113-4><a class=lnlinks href=#hl-113-4> 4</a>
</span><span class=lnt id=hl-113-5><a class=lnlinks href=#hl-113-5> 5</a>
</span><span class=lnt id=hl-113-6><a class=lnlinks href=#hl-113-6> 6</a>
</span><span class=lnt id=hl-113-7><a class=lnlinks href=#hl-113-7> 7</a>
</span><span class=lnt id=hl-113-8><a class=lnlinks href=#hl-113-8> 8</a>
</span><span class=lnt id=hl-113-9><a class=lnlinks href=#hl-113-9> 9</a>
</span><span class=lnt id=hl-113-10><a class=lnlinks href=#hl-113-10>10</a>
</span><span class=lnt id=hl-113-11><a class=lnlinks href=#hl-113-11>11</a>
</span><span class=lnt id=hl-113-12><a class=lnlinks href=#hl-113-12>12</a>
</span><span class=lnt id=hl-113-13><a class=lnlinks href=#hl-113-13>13</a>
</span><span class=lnt id=hl-113-14><a class=lnlinks href=#hl-113-14>14</a>
</span><span class=lnt id=hl-113-15><a class=lnlinks href=#hl-113-15>15</a>
</span><span class=lnt id=hl-113-16><a class=lnlinks href=#hl-113-16>16</a>
</span><span class=lnt id=hl-113-17><a class=lnlinks href=#hl-113-17>17</a>
</span><span class=lnt id=hl-113-18><a class=lnlinks href=#hl-113-18>18</a>
</span><span class=lnt id=hl-113-19><a class=lnlinks href=#hl-113-19>19</a>
</span><span class=lnt id=hl-113-20><a class=lnlinks href=#hl-113-20>20</a>
</span><span class=lnt id=hl-113-21><a class=lnlinks href=#hl-113-21>21</a>
</span><span class=lnt id=hl-113-22><a class=lnlinks href=#hl-113-22>22</a>
</span><span class=lnt id=hl-113-23><a class=lnlinks href=#hl-113-23>23</a>
</span><span class=lnt id=hl-113-24><a class=lnlinks href=#hl-113-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyServlet</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=n>userService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserServiceImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userService</span><span class=p>.</span><span class=na>update</span><span class=p>(...);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>UserDao</span><span class=w> </span><span class=n>userDao</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UserDaoImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userDao</span><span class=p>.</span><span class=na>update</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserDaoImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>SQLException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;update user set password = ? where username = ?&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DriverManager</span><span class=p>.</span><span class=na>getConnection</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>conn</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¾‹7:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-114-1><a class=lnlinks href=#hl-114-1> 1</a>
</span><span class=lnt id=hl-114-2><a class=lnlinks href=#hl-114-2> 2</a>
</span><span class=lnt id=hl-114-3><a class=lnlinks href=#hl-114-3> 3</a>
</span><span class=lnt id=hl-114-4><a class=lnlinks href=#hl-114-4> 4</a>
</span><span class=lnt id=hl-114-5><a class=lnlinks href=#hl-114-5> 5</a>
</span><span class=lnt id=hl-114-6><a class=lnlinks href=#hl-114-6> 6</a>
</span><span class=lnt id=hl-114-7><a class=lnlinks href=#hl-114-7> 7</a>
</span><span class=lnt id=hl-114-8><a class=lnlinks href=#hl-114-8> 8</a>
</span><span class=lnt id=hl-114-9><a class=lnlinks href=#hl-114-9> 9</a>
</span><span class=lnt id=hl-114-10><a class=lnlinks href=#hl-114-10>10</a>
</span><span class=lnt id=hl-114-11><a class=lnlinks href=#hl-114-11>11</a>
</span><span class=lnt id=hl-114-12><a class=lnlinks href=#hl-114-12>12</a>
</span><span class=lnt id=hl-114-13><a class=lnlinks href=#hl-114-13>13</a>
</span><span class=lnt id=hl-114-14><a class=lnlinks href=#hl-114-14>14</a>
</span><span class=lnt id=hl-114-15><a class=lnlinks href=#hl-114-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>bar</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ˜¯å¦å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>foo</span><span class=p>(</span><span class=n>sdf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Test</span><span class=p>().</span><span class=na>bar</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ foo çš„è¡Œä¸ºæ˜¯ä¸ç¡®å®šçš„ï¼Œå¯èƒ½å¯¼è‡´ä¸å®‰å…¨çš„å‘ç”Ÿï¼Œè¢«ç§°ä¹‹ä¸º<strong>å¤–æ˜Ÿæ–¹æ³•</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-115-1><a class=lnlinks href=#hl-115-1> 1</a>
</span><span class=lnt id=hl-115-2><a class=lnlinks href=#hl-115-2> 2</a>
</span><span class=lnt id=hl-115-3><a class=lnlinks href=#hl-115-3> 3</a>
</span><span class=lnt id=hl-115-4><a class=lnlinks href=#hl-115-4> 4</a>
</span><span class=lnt id=hl-115-5><a class=lnlinks href=#hl-115-5> 5</a>
</span><span class=lnt id=hl-115-6><a class=lnlinks href=#hl-115-6> 6</a>
</span><span class=lnt id=hl-115-7><a class=lnlinks href=#hl-115-7> 7</a>
</span><span class=lnt id=hl-115-8><a class=lnlinks href=#hl-115-8> 8</a>
</span><span class=lnt id=hl-115-9><a class=lnlinks href=#hl-115-9> 9</a>
</span><span class=lnt id=hl-115-10><a class=lnlinks href=#hl-115-10>10</a>
</span><span class=lnt id=hl-115-11><a class=lnlinks href=#hl-115-11>11</a>
</span><span class=lnt id=hl-115-12><a class=lnlinks href=#hl-115-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>dateStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;1999-10-11 00:00:00&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sdf</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=n>dateStr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ParseException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯·æ¯”è¾ƒ JDK ä¸­ String ç±»çš„å®ç°</p><p>ä¾‹8ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-116-1><a class=lnlinks href=#hl-116-1> 1</a>
</span><span class=lnt id=hl-116-2><a class=lnlinks href=#hl-116-2> 2</a>
</span><span class=lnt id=hl-116-3><a class=lnlinks href=#hl-116-3> 3</a>
</span><span class=lnt id=hl-116-4><a class=lnlinks href=#hl-116-4> 4</a>
</span><span class=lnt id=hl-116-5><a class=lnlinks href=#hl-116-5> 5</a>
</span><span class=lnt id=hl-116-6><a class=lnlinks href=#hl-116-6> 6</a>
</span><span class=lnt id=hl-116-7><a class=lnlinks href=#hl-116-7> 7</a>
</span><span class=lnt id=hl-116-8><a class=lnlinks href=#hl-116-8> 8</a>
</span><span class=lnt id=hl-116-9><a class=lnlinks href=#hl-116-9> 9</a>
</span><span class=lnt id=hl-116-10><a class=lnlinks href=#hl-116-10>10</a>
</span><span class=lnt id=hl-116-11><a class=lnlinks href=#hl-116-11>11</a>
</span><span class=lnt id=hl-116-12><a class=lnlinks href=#hl-116-12>12</a>
</span><span class=lnt id=hl-116-13><a class=lnlinks href=#hl-116-13>13</a>
</span><span class=lnt id=hl-116-14><a class=lnlinks href=#hl-116-14>14</a>
</span><span class=lnt id=hl-116-15><a class=lnlinks href=#hl-116-15>15</a>
</span><span class=lnt id=hl-116-16><a class=lnlinks href=#hl-116-16>16</a>
</span><span class=lnt id=hl-116-17><a class=lnlinks href=#hl-116-17>17</a>
</span><span class=lnt id=hl-116-18><a class=lnlinks href=#hl-116-18>18</a>
</span><span class=lnt id=hl-116-19><a class=lnlinks href=#hl-116-19>19</a>
</span><span class=lnt id=hl-116-20><a class=lnlinks href=#hl-116-20>20</a>
</span><span class=lnt id=hl-116-21><a class=lnlinks href=#hl-116-21>21</a>
</span><span class=lnt id=hl-116-22><a class=lnlinks href=#hl-116-22>22</a>
</span><span class=lnt id=hl-116-23><a class=lnlinks href=#hl-116-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>i</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>j</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>thread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>list</span><span class=p>.</span><span class=na>stream</span><span class=p>().</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>list</span><span class=p>.</span><span class=na>stream</span><span class=p>().</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=45-ä¹ é¢˜><a href=#45-%e4%b9%a0%e9%a2%98 class=header-anchor>#</a>
4.5 ä¹ é¢˜</h2><h5 id=å–ç¥¨ç»ƒä¹ ><a href=#%e5%8d%96%e7%a5%a8%e7%bb%83%e4%b9%a0 class=header-anchor>#</a>
å–ç¥¨ç»ƒä¹ </h5><p>æµ‹è¯•ä¸‹é¢ä»£ç æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¹¶å°è¯•æ”¹æ­£</p><ul><li>å°†sellæ–¹æ³•å£°æ˜ä¸ºsynchronizedå³å¯</li><li>æ³¨æ„åªå°†å¯¹countè¿›è¡Œä¿®æ”¹çš„ä¸€è¡Œä»£ç ç”¨synchronizedæ‹¬èµ·æ¥ä¹Ÿä¸è¡Œã€‚å¯¹countå¤§å°çš„åˆ¤æ–­ä¹Ÿå¿…é¡»æ˜¯ä¸ºåŸå­æ“ä½œçš„ä¸€éƒ¨åˆ†ï¼Œå¦åˆ™ä¹Ÿä¼šå¯¼è‡´countå€¼å¼‚å¸¸ã€‚</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-117-1><a class=lnlinks href=#hl-117-1> 1</a>
</span><span class=lnt id=hl-117-2><a class=lnlinks href=#hl-117-2> 2</a>
</span><span class=lnt id=hl-117-3><a class=lnlinks href=#hl-117-3> 3</a>
</span><span class=lnt id=hl-117-4><a class=lnlinks href=#hl-117-4> 4</a>
</span><span class=lnt id=hl-117-5><a class=lnlinks href=#hl-117-5> 5</a>
</span><span class=lnt id=hl-117-6><a class=lnlinks href=#hl-117-6> 6</a>
</span><span class=lnt id=hl-117-7><a class=lnlinks href=#hl-117-7> 7</a>
</span><span class=lnt id=hl-117-8><a class=lnlinks href=#hl-117-8> 8</a>
</span><span class=lnt id=hl-117-9><a class=lnlinks href=#hl-117-9> 9</a>
</span><span class=lnt id=hl-117-10><a class=lnlinks href=#hl-117-10>10</a>
</span><span class=lnt id=hl-117-11><a class=lnlinks href=#hl-117-11>11</a>
</span><span class=lnt id=hl-117-12><a class=lnlinks href=#hl-117-12>12</a>
</span><span class=lnt id=hl-117-13><a class=lnlinks href=#hl-117-13>13</a>
</span><span class=lnt id=hl-117-14><a class=lnlinks href=#hl-117-14>14</a>
</span><span class=lnt id=hl-117-15><a class=lnlinks href=#hl-117-15>15</a>
</span><span class=lnt id=hl-117-16><a class=lnlinks href=#hl-117-16>16</a>
</span><span class=lnt id=hl-117-17><a class=lnlinks href=#hl-117-17>17</a>
</span><span class=lnt id=hl-117-18><a class=lnlinks href=#hl-117-18>18</a>
</span><span class=lnt id=hl-117-19><a class=lnlinks href=#hl-117-19>19</a>
</span><span class=lnt id=hl-117-20><a class=lnlinks href=#hl-117-20>20</a>
</span><span class=lnt id=hl-117-21><a class=lnlinks href=#hl-117-21>21</a>
</span><span class=lnt id=hl-117-22><a class=lnlinks href=#hl-117-22>22</a>
</span><span class=lnt id=hl-117-23><a class=lnlinks href=#hl-117-23>23</a>
</span><span class=lnt id=hl-117-24><a class=lnlinks href=#hl-117-24>24</a>
</span><span class=lnt id=hl-117-25><a class=lnlinks href=#hl-117-25>25</a>
</span><span class=lnt id=hl-117-26><a class=lnlinks href=#hl-117-26>26</a>
</span><span class=lnt id=hl-117-27><a class=lnlinks href=#hl-117-27>27</a>
</span><span class=lnt id=hl-117-28><a class=lnlinks href=#hl-117-28>28</a>
</span><span class=lnt id=hl-117-29><a class=lnlinks href=#hl-117-29>29</a>
</span><span class=lnt id=hl-117-30><a class=lnlinks href=#hl-117-30>30</a>
</span><span class=lnt id=hl-117-31><a class=lnlinks href=#hl-117-31>31</a>
</span><span class=lnt id=hl-117-32><a class=lnlinks href=#hl-117-32>32</a>
</span><span class=lnt id=hl-117-33><a class=lnlinks href=#hl-117-33>33</a>
</span><span class=lnt id=hl-117-34><a class=lnlinks href=#hl-117-34>34</a>
</span><span class=lnt id=hl-117-35><a class=lnlinks href=#hl-117-35>35</a>
</span><span class=lnt id=hl-117-36><a class=lnlinks href=#hl-117-36>36</a>
</span><span class=lnt id=hl-117-37><a class=lnlinks href=#hl-117-37>37</a>
</span><span class=lnt id=hl-117-38><a class=lnlinks href=#hl-117-38>38</a>
</span><span class=lnt id=hl-117-39><a class=lnlinks href=#hl-117-39>39</a>
</span><span class=lnt id=hl-117-40><a class=lnlinks href=#hl-117-40>40</a>
</span><span class=lnt id=hl-117-41><a class=lnlinks href=#hl-117-41>41</a>
</span><span class=lnt id=hl-117-42><a class=lnlinks href=#hl-117-42>42</a>
</span><span class=lnt id=hl-117-43><a class=lnlinks href=#hl-117-43>43</a>
</span><span class=lnt id=hl-117-44><a class=lnlinks href=#hl-117-44>44</a>
</span><span class=lnt id=hl-117-45><a class=lnlinks href=#hl-117-45>45</a>
</span><span class=lnt id=hl-117-46><a class=lnlinks href=#hl-117-46>46</a>
</span><span class=lnt id=hl-117-47><a class=lnlinks href=#hl-117-47>47</a>
</span><span class=lnt id=hl-117-48><a class=lnlinks href=#hl-117-48>48</a>
</span><span class=lnt id=hl-117-49><a class=lnlinks href=#hl-117-49>49</a>
</span><span class=lnt id=hl-117-50><a class=lnlinks href=#hl-117-50>50</a>
</span><span class=lnt id=hl-117-51><a class=lnlinks href=#hl-117-51>51</a>
</span><span class=lnt id=hl-117-52><a class=lnlinks href=#hl-117-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ExerciseSell</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TicketWindow</span><span class=w> </span><span class=n>ticketWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TicketWindow</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ç”¨æ¥å­˜å‚¨ä¹°å‡ºå»å¤šå°‘å¼ ç¥¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>sellCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Vector</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>2000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// åˆ†æè¿™é‡Œçš„ç«æ€æ¡ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ticketWindow</span><span class=p>.</span><span class=na>sell</span><span class=p>(</span><span class=n>randomAmount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sellCount</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>forEach</span><span class=p>((</span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¹°å‡ºå»çš„ç¥¨æ±‚å’Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;selled count:{}&#34;</span><span class=p>,</span><span class=n>sellCount</span><span class=p>.</span><span class=na>stream</span><span class=p>().</span><span class=na>mapToInt</span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>c</span><span class=p>).</span><span class=na>sum</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å‰©ä½™ç¥¨æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;remainder count:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ticketWindow</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Random ä¸ºçº¿ç¨‹å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Random</span><span class=w> </span><span class=n>random</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// éšæœº 1~5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>randomAmount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>5</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>TicketWindow</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>TicketWindow</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//åœ¨æ–¹æ³•ä¸ŠåŠ ä¸€ä¸ªsynchronizedå³å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>sell</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>    
</span></span></span></code></pre></td></tr></table></div></div><p>å¦å¤–ï¼Œç”¨ä¸‹é¢çš„ä»£ç è¡Œä¸è¡Œï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><ul><li>ä¸è¡Œï¼Œå› ä¸ºsellCountä¼šè¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œå¿…é¡»ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„å®ç°ç±»ã€‚</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-118-1><a class=lnlinks href=#hl-118-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>sellCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•è„šæœ¬</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-119-1><a class=lnlinks href=#hl-119-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=k>for</span> /L %n in <span class=o>(</span>1,1,10<span class=o>)</span> <span class=k>do</span> java -cp <span class=s2>&#34;.;C:\Users\manyh\.m2\repository\ch\qos\logback\logbackclassic\1.2.3\logback-classic-1.2.3.jar;C:\Users\manyh\.m2\repository\ch\qos\logback\logbackcore\1.2.3\logback-core-1.2.3.jar;C:\Users\manyh\.m2\repository\org\slf4j\slf4japi\1.7.25\slf4j-api-1.7.25.jar&#34;</span> cn.itcast.n4.exercise.ExerciseSell
</span></span></code></pre></td></tr></table></div></div><p>è¯´æ˜ï¼š</p><ul><li>ä¸¤æ®µæ²¡æœ‰å‰åå› æœå…³ç³»çš„ä¸´ç•ŒåŒºä»£ç ï¼Œåªéœ€è¦ä¿è¯å„è‡ªçš„åŸå­æ€§å³å¯ï¼Œä¸éœ€è¦æ‹¬èµ·æ¥ã€‚</li></ul><h5 id=è½¬è´¦ç»ƒä¹ ><a href=#%e8%bd%ac%e8%b4%a6%e7%bb%83%e4%b9%a0 class=header-anchor>#</a>
è½¬è´¦ç»ƒä¹ </h5><p>æµ‹è¯•ä¸‹é¢ä»£ç æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¹¶å°è¯•æ”¹æ­£</p><ul><li>å°†transferæ–¹æ³•çš„æ–¹æ³•ä½“ç”¨åŒæ­¥ä»£ç å—åŒ…è£¹ï¼Œå°†å½“Account.classè®¾ä¸ºé”å¯¹è±¡ã€‚</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-120-1><a class=lnlinks href=#hl-120-1> 1</a>
</span><span class=lnt id=hl-120-2><a class=lnlinks href=#hl-120-2> 2</a>
</span><span class=lnt id=hl-120-3><a class=lnlinks href=#hl-120-3> 3</a>
</span><span class=lnt id=hl-120-4><a class=lnlinks href=#hl-120-4> 4</a>
</span><span class=lnt id=hl-120-5><a class=lnlinks href=#hl-120-5> 5</a>
</span><span class=lnt id=hl-120-6><a class=lnlinks href=#hl-120-6> 6</a>
</span><span class=lnt id=hl-120-7><a class=lnlinks href=#hl-120-7> 7</a>
</span><span class=lnt id=hl-120-8><a class=lnlinks href=#hl-120-8> 8</a>
</span><span class=lnt id=hl-120-9><a class=lnlinks href=#hl-120-9> 9</a>
</span><span class=lnt id=hl-120-10><a class=lnlinks href=#hl-120-10>10</a>
</span><span class=lnt id=hl-120-11><a class=lnlinks href=#hl-120-11>11</a>
</span><span class=lnt id=hl-120-12><a class=lnlinks href=#hl-120-12>12</a>
</span><span class=lnt id=hl-120-13><a class=lnlinks href=#hl-120-13>13</a>
</span><span class=lnt id=hl-120-14><a class=lnlinks href=#hl-120-14>14</a>
</span><span class=lnt id=hl-120-15><a class=lnlinks href=#hl-120-15>15</a>
</span><span class=lnt id=hl-120-16><a class=lnlinks href=#hl-120-16>16</a>
</span><span class=lnt id=hl-120-17><a class=lnlinks href=#hl-120-17>17</a>
</span><span class=lnt id=hl-120-18><a class=lnlinks href=#hl-120-18>18</a>
</span><span class=lnt id=hl-120-19><a class=lnlinks href=#hl-120-19>19</a>
</span><span class=lnt id=hl-120-20><a class=lnlinks href=#hl-120-20>20</a>
</span><span class=lnt id=hl-120-21><a class=lnlinks href=#hl-120-21>21</a>
</span><span class=lnt id=hl-120-22><a class=lnlinks href=#hl-120-22>22</a>
</span><span class=lnt id=hl-120-23><a class=lnlinks href=#hl-120-23>23</a>
</span><span class=lnt id=hl-120-24><a class=lnlinks href=#hl-120-24>24</a>
</span><span class=lnt id=hl-120-25><a class=lnlinks href=#hl-120-25>25</a>
</span><span class=lnt id=hl-120-26><a class=lnlinks href=#hl-120-26>26</a>
</span><span class=lnt id=hl-120-27><a class=lnlinks href=#hl-120-27>27</a>
</span><span class=lnt id=hl-120-28><a class=lnlinks href=#hl-120-28>28</a>
</span><span class=lnt id=hl-120-29><a class=lnlinks href=#hl-120-29>29</a>
</span><span class=lnt id=hl-120-30><a class=lnlinks href=#hl-120-30>30</a>
</span><span class=lnt id=hl-120-31><a class=lnlinks href=#hl-120-31>31</a>
</span><span class=lnt id=hl-120-32><a class=lnlinks href=#hl-120-32>32</a>
</span><span class=lnt id=hl-120-33><a class=lnlinks href=#hl-120-33>33</a>
</span><span class=lnt id=hl-120-34><a class=lnlinks href=#hl-120-34>34</a>
</span><span class=lnt id=hl-120-35><a class=lnlinks href=#hl-120-35>35</a>
</span><span class=lnt id=hl-120-36><a class=lnlinks href=#hl-120-36>36</a>
</span><span class=lnt id=hl-120-37><a class=lnlinks href=#hl-120-37>37</a>
</span><span class=lnt id=hl-120-38><a class=lnlinks href=#hl-120-38>38</a>
</span><span class=lnt id=hl-120-39><a class=lnlinks href=#hl-120-39>39</a>
</span><span class=lnt id=hl-120-40><a class=lnlinks href=#hl-120-40>40</a>
</span><span class=lnt id=hl-120-41><a class=lnlinks href=#hl-120-41>41</a>
</span><span class=lnt id=hl-120-42><a class=lnlinks href=#hl-120-42>42</a>
</span><span class=lnt id=hl-120-43><a class=lnlinks href=#hl-120-43>43</a>
</span><span class=lnt id=hl-120-44><a class=lnlinks href=#hl-120-44>44</a>
</span><span class=lnt id=hl-120-45><a class=lnlinks href=#hl-120-45>45</a>
</span><span class=lnt id=hl-120-46><a class=lnlinks href=#hl-120-46>46</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ExerciseTransfer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Account</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Account</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Account</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Account</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>a</span><span class=p>.</span><span class=na>transfer</span><span class=p>(</span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>randomAmount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>b</span><span class=p>.</span><span class=na>transfer</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>randomAmount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æŸ¥çœ‹è½¬è´¦2000æ¬¡åçš„æ€»é‡‘é¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;total:{}&#34;</span><span class=p>,(</span><span class=n>a</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Random ä¸ºçº¿ç¨‹å®‰å…¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Random</span><span class=w> </span><span class=n>random</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// éšæœº 1~100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>randomAmount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>100</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Account</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Account</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>money</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>money</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getMoney</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setMoney</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>money</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>money</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>money</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>transfer</span><span class=p>(</span><span class=n>Account</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>money</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>setMoney</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>target</span><span class=p>.</span><span class=na>setMoney</span><span class=p>(</span><span class=n>target</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™æ ·æ”¹æ­£è¡Œä¸è¡Œï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><ul><li>ä¸è¡Œï¼Œå› ä¸ºä¸åŒçº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•ï¼Œå°†ä¼šé”ä½ä¸åŒçš„å¯¹è±¡</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-121-1><a class=lnlinks href=#hl-121-1>1</a>
</span><span class=lnt id=hl-121-2><a class=lnlinks href=#hl-121-2>2</a>
</span><span class=lnt id=hl-121-3><a class=lnlinks href=#hl-121-3>3</a>
</span><span class=lnt id=hl-121-4><a class=lnlinks href=#hl-121-4>4</a>
</span><span class=lnt id=hl-121-5><a class=lnlinks href=#hl-121-5>5</a>
</span><span class=lnt id=hl-121-6><a class=lnlinks href=#hl-121-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>transfer</span><span class=p>(</span><span class=n>Account</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>money</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>setMoney</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>target</span><span class=p>.</span><span class=na>setMoney</span><span class=p>(</span><span class=n>target</span><span class=p>.</span><span class=na>getMoney</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=46-monitor-æ¦‚å¿µ><a href=#46-monitor-%e6%a6%82%e5%bf%b5 class=header-anchor>#</a>
4.6 Monitor æ¦‚å¿µ</h2><h3 id=java-å¯¹è±¡å¤´><a href=#java-%e5%af%b9%e8%b1%a1%e5%a4%b4 class=header-anchor>#</a>
<strong>Java å¯¹è±¡å¤´</strong></h3><p>ä»¥ 32 ä½è™šæ‹Ÿæœºä¸ºä¾‹</p><p>æ™®é€šå¯¹è±¡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-122-1><a class=lnlinks href=#hl-122-1>1</a>
</span><span class=lnt id=hl-122-2><a class=lnlinks href=#hl-122-2>2</a>
</span><span class=lnt id=hl-122-3><a class=lnlinks href=#hl-122-3>3</a>
</span><span class=lnt id=hl-122-4><a class=lnlinks href=#hl-122-4>4</a>
</span><span class=lnt id=hl-122-5><a class=lnlinks href=#hl-122-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>|--------------------------------------------------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                    <span class=no>Object</span> <span class=no>Header</span> <span class=p>(</span><span class=mi>64</span> <span class=n>bits</span><span class=p>)</span>                   <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|------------------------------------|-------------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>       <span class=no>Mark</span> <span class=no>Word</span> <span class=p>(</span><span class=mi>32</span> <span class=n>bits</span><span class=p>)</span>          <span class=o>|</span>   <span class=no>Klass</span> <span class=no>Word</span> <span class=p>(</span><span class=mi>32</span> <span class=n>bits</span><span class=p>)</span>  <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|------------------------------------|-------------------------|</span>
</span></span></code></pre></td></tr></table></div></div><p>æ•°ç»„å¯¹è±¡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-123-1><a class=lnlinks href=#hl-123-1>1</a>
</span><span class=lnt id=hl-123-2><a class=lnlinks href=#hl-123-2>2</a>
</span><span class=lnt id=hl-123-3><a class=lnlinks href=#hl-123-3>3</a>
</span><span class=lnt id=hl-123-4><a class=lnlinks href=#hl-123-4>4</a>
</span><span class=lnt id=hl-123-5><a class=lnlinks href=#hl-123-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>|---------------------------------------------------------------------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                             <span class=no>Object</span> <span class=no>Header</span> <span class=p>(</span><span class=mi>96</span> <span class=n>bits</span><span class=p>)</span>                             <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------|-----------------------|------------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>        <span class=no>Mark</span> <span class=no>Word</span><span class=p>(</span><span class=mi>32</span><span class=n>bits</span><span class=p>)</span>       <span class=o>|</span>   <span class=no>Klass</span> <span class=no>Word</span><span class=p>(</span><span class=mi>32</span><span class=n>bits</span><span class=p>)</span>  <span class=o>|</span>  <span class=n>array</span> <span class=n>length</span><span class=p>(</span><span class=mi>32</span><span class=n>bits</span><span class=p>)</span>  <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------|-----------------------|------------------------|</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ Mark Word ç»“æ„ä¸º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-124-1><a class=lnlinks href=#hl-124-1> 1</a>
</span><span class=lnt id=hl-124-2><a class=lnlinks href=#hl-124-2> 2</a>
</span><span class=lnt id=hl-124-3><a class=lnlinks href=#hl-124-3> 3</a>
</span><span class=lnt id=hl-124-4><a class=lnlinks href=#hl-124-4> 4</a>
</span><span class=lnt id=hl-124-5><a class=lnlinks href=#hl-124-5> 5</a>
</span><span class=lnt id=hl-124-6><a class=lnlinks href=#hl-124-6> 6</a>
</span><span class=lnt id=hl-124-7><a class=lnlinks href=#hl-124-7> 7</a>
</span><span class=lnt id=hl-124-8><a class=lnlinks href=#hl-124-8> 8</a>
</span><span class=lnt id=hl-124-9><a class=lnlinks href=#hl-124-9> 9</a>
</span><span class=lnt id=hl-124-10><a class=lnlinks href=#hl-124-10>10</a>
</span><span class=lnt id=hl-124-11><a class=lnlinks href=#hl-124-11>11</a>
</span><span class=lnt id=hl-124-12><a class=lnlinks href=#hl-124-12>12</a>
</span><span class=lnt id=hl-124-13><a class=lnlinks href=#hl-124-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                  <span class=no>Mark</span> <span class=no>Word</span> <span class=p>(</span><span class=mi>32</span> <span class=n>bits</span><span class=p>)</span>                  <span class=o>|</span>        <span class=no>State</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>    <span class=ss>hashcode</span><span class=p>:</span><span class=mi>25</span>  <span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span>   <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>0</span>   <span class=o>|</span>   <span class=mo>01</span>    <span class=o>|</span>       <span class=no>Normal</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span><span class=ss>thread</span><span class=p>:</span><span class=mi>23</span><span class=o>|</span><span class=ss>epoch</span><span class=p>:</span><span class=mi>2</span><span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span>   <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>1</span>   <span class=o>|</span>   <span class=mo>01</span>    <span class=o>|</span>       <span class=no>Biased</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>          <span class=ss>ptr_to_lock_record</span><span class=p>:</span><span class=mi>30</span>              <span class=o>|</span>   <span class=mo>00</span>    <span class=o>|</span> <span class=no>Lightweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>          <span class=ss>ptr_to_heavyweight_monitor</span><span class=p>:</span><span class=mi>30</span>      <span class=o>|</span>   <span class=mi>10</span>    <span class=o>|</span> <span class=no>Heavyweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                                             <span class=o>|</span>   <span class=mi>11</span>    <span class=o>|</span>    <span class=no>Marked</span> <span class=k>for</span> <span class=no>GC</span>   <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|-------------------------------------------------------|--------------------|</span>
</span></span></code></pre></td></tr></table></div></div><p>64 ä½è™šæ‹Ÿæœº Mark Word</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-125-1><a class=lnlinks href=#hl-125-1> 1</a>
</span><span class=lnt id=hl-125-2><a class=lnlinks href=#hl-125-2> 2</a>
</span><span class=lnt id=hl-125-3><a class=lnlinks href=#hl-125-3> 3</a>
</span><span class=lnt id=hl-125-4><a class=lnlinks href=#hl-125-4> 4</a>
</span><span class=lnt id=hl-125-5><a class=lnlinks href=#hl-125-5> 5</a>
</span><span class=lnt id=hl-125-6><a class=lnlinks href=#hl-125-6> 6</a>
</span><span class=lnt id=hl-125-7><a class=lnlinks href=#hl-125-7> 7</a>
</span><span class=lnt id=hl-125-8><a class=lnlinks href=#hl-125-8> 8</a>
</span><span class=lnt id=hl-125-9><a class=lnlinks href=#hl-125-9> 9</a>
</span><span class=lnt id=hl-125-10><a class=lnlinks href=#hl-125-10>10</a>
</span><span class=lnt id=hl-125-11><a class=lnlinks href=#hl-125-11>11</a>
</span><span class=lnt id=hl-125-12><a class=lnlinks href=#hl-125-12>12</a>
</span><span class=lnt id=hl-125-13><a class=lnlinks href=#hl-125-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                          <span class=no>Mark</span> <span class=no>Word</span> <span class=p>(</span><span class=mi>64</span> <span class=n>bits</span><span class=p>)</span>                       <span class=o>|</span>        <span class=no>State</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>25</span> <span class=o>|</span> <span class=ss>hashcode</span><span class=p>:</span><span class=mi>31</span> <span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span> <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>0</span> <span class=o>|</span>  <span class=mo>01</span>   <span class=o>|</span>        <span class=no>Normal</span>      <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=ss>thread</span><span class=p>:</span><span class=mi>54</span> <span class=o>|</span>   <span class=ss>epoch</span><span class=p>:</span><span class=mi>2</span>   <span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span> <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span>  <span class=mo>01</span>   <span class=o>|</span>        <span class=no>Biased</span>      <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                    <span class=ss>ptr_to_lock_record</span><span class=p>:</span><span class=mi>62</span>                   <span class=o>|</span>  <span class=mo>00</span>   <span class=o>|</span> <span class=no>Lightweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                 <span class=ss>ptr_to_heavyweight_monitor</span><span class=p>:</span><span class=mi>62</span>              <span class=o>|</span>  <span class=mi>10</span>   <span class=o>|</span> <span class=no>Heavyweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                                                            <span class=o>|</span>  <span class=mi>11</span>   <span class=o>|</span>    <span class=no>Marked</span> <span class=k>for</span> <span class=no>GC</span>   <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å‚è€ƒèµ„æ–™</p><p><a class=link href=https://stackoverflow.com/questions/26357186/what-is-in-java-object-header target=_blank rel=noopener>https://stackoverflow.com/questions/26357186/what-is-in-java-object-header
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></blockquote><h3 id=font-colorblue-åŸç†ä¹‹monitoré”font><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8bmonitor%e9%94%81font class=header-anchor>#</a>
<font color=blue>* åŸç†ä¹‹Monitor(é”)</font></h3><p>Monitor è¢«ç¿»è¯‘ä¸º<strong>ç›‘è§†å™¨</strong>æˆ–<strong>ç®¡ç¨‹</strong></p><p>æ¯ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ª Monitor å¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨ synchronized ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„ Mark Word ä¸­å°±è¢«è®¾ç½®æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆ</p><p>Monitor ç»“æ„å¦‚ä¸‹</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317181913745.png width=900 height=600 loading=lazy decoding=async alt=image-20220317181913745 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>åˆšå¼€å§‹ Monitor ä¸­ Owner ä¸º null</li><li>å½“ Thread-2 æ‰§è¡Œ synchronized(obj) å°±ä¼šå°† Monitor çš„æ‰€æœ‰è€… Owner ç½®ä¸º Thread-2ï¼ŒMonitorä¸­åªèƒ½æœ‰ä¸€ ä¸ª Owner</li><li>åœ¨ Thread-2 ä¸Šé”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ Thread-3ï¼ŒThread-4ï¼ŒThread-5 ä¹Ÿæ¥æ‰§è¡Œ synchronized(obj)ï¼Œå°±ä¼šè¿›å…¥ EntryList BLOCKED</li><li>Thread-2 æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œç„¶åå”¤é†’ EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰çš„æ—¶æ˜¯éå…¬å¹³çš„</li><li>å›¾ä¸­ WaitSet ä¸­çš„ Thread-0ï¼ŒThread-1 æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥ WAITING çŠ¶æ€çš„çº¿ç¨‹ï¼Œåé¢è®² wait-notify æ—¶ä¼šåˆ†æ</li></ul><blockquote><p><strong>æ³¨æ„</strong>ï¼š</p><ul><li>synchronized å¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„ monitor æ‰æœ‰ä¸Šè¿°çš„æ•ˆæœ</li><li>ä¸åŠ  synchronized çš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™</li></ul></blockquote><h3 id=font-colorblue-åŸç†ä¹‹-synchronizedfont><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-synchronizedfont class=header-anchor>#</a>
<font color=blue>* åŸç†ä¹‹ synchronized</font></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-126-1><a class=lnlinks href=#hl-126-1>1</a>
</span><span class=lnt id=hl-126-2><a class=lnlinks href=#hl-126-2>2</a>
</span><span class=lnt id=hl-126-3><a class=lnlinks href=#hl-126-3>3</a>
</span><span class=lnt id=hl-126-4><a class=lnlinks href=#hl-126-4>4</a>
</span><span class=lnt id=hl-126-5><a class=lnlinks href=#hl-126-5>5</a>
</span><span class=lnt id=hl-126-6><a class=lnlinks href=#hl-126-6>6</a>
</span><span class=lnt id=hl-126-7><a class=lnlinks href=#hl-126-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>counter</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯¹åº”çš„å­—èŠ‚ç ä¸º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-127-1><a class=lnlinks href=#hl-127-1> 1</a>
</span><span class=lnt id=hl-127-2><a class=lnlinks href=#hl-127-2> 2</a>
</span><span class=lnt id=hl-127-3><a class=lnlinks href=#hl-127-3> 3</a>
</span><span class=lnt id=hl-127-4><a class=lnlinks href=#hl-127-4> 4</a>
</span><span class=lnt id=hl-127-5><a class=lnlinks href=#hl-127-5> 5</a>
</span><span class=lnt id=hl-127-6><a class=lnlinks href=#hl-127-6> 6</a>
</span><span class=lnt id=hl-127-7><a class=lnlinks href=#hl-127-7> 7</a>
</span><span class=lnt id=hl-127-8><a class=lnlinks href=#hl-127-8> 8</a>
</span><span class=lnt id=hl-127-9><a class=lnlinks href=#hl-127-9> 9</a>
</span><span class=lnt id=hl-127-10><a class=lnlinks href=#hl-127-10>10</a>
</span><span class=lnt id=hl-127-11><a class=lnlinks href=#hl-127-11>11</a>
</span><span class=lnt id=hl-127-12><a class=lnlinks href=#hl-127-12>12</a>
</span><span class=lnt id=hl-127-13><a class=lnlinks href=#hl-127-13>13</a>
</span><span class=lnt id=hl-127-14><a class=lnlinks href=#hl-127-14>14</a>
</span><span class=lnt id=hl-127-15><a class=lnlinks href=#hl-127-15>15</a>
</span><span class=lnt id=hl-127-16><a class=lnlinks href=#hl-127-16>16</a>
</span><span class=lnt id=hl-127-17><a class=lnlinks href=#hl-127-17>17</a>
</span><span class=lnt id=hl-127-18><a class=lnlinks href=#hl-127-18>18</a>
</span><span class=lnt id=hl-127-19><a class=lnlinks href=#hl-127-19>19</a>
</span><span class=lnt id=hl-127-20><a class=lnlinks href=#hl-127-20>20</a>
</span><span class=lnt id=hl-127-21><a class=lnlinks href=#hl-127-21>21</a>
</span><span class=lnt id=hl-127-22><a class=lnlinks href=#hl-127-22>22</a>
</span><span class=lnt id=hl-127-23><a class=lnlinks href=#hl-127-23>23</a>
</span><span class=lnt id=hl-127-24><a class=lnlinks href=#hl-127-24>24</a>
</span><span class=lnt id=hl-127-25><a class=lnlinks href=#hl-127-25>25</a>
</span><span class=lnt id=hl-127-26><a class=lnlinks href=#hl-127-26>26</a>
</span><span class=lnt id=hl-127-27><a class=lnlinks href=#hl-127-27>27</a>
</span><span class=lnt id=hl-127-28><a class=lnlinks href=#hl-127-28>28</a>
</span><span class=lnt id=hl-127-29><a class=lnlinks href=#hl-127-29>29</a>
</span><span class=lnt id=hl-127-30><a class=lnlinks href=#hl-127-30>30</a>
</span><span class=lnt id=hl-127-31><a class=lnlinks href=#hl-127-31>31</a>
</span><span class=lnt id=hl-127-32><a class=lnlinks href=#hl-127-32>32</a>
</span><span class=lnt id=hl-127-33><a class=lnlinks href=#hl-127-33>33</a>
</span><span class=lnt id=hl-127-34><a class=lnlinks href=#hl-127-34>34</a>
</span><span class=lnt id=hl-127-35><a class=lnlinks href=#hl-127-35>35</a>
</span><span class=lnt id=hl-127-36><a class=lnlinks href=#hl-127-36>36</a>
</span><span class=lnt id=hl-127-37><a class=lnlinks href=#hl-127-37>37</a>
</span><span class=lnt id=hl-127-38><a class=lnlinks href=#hl-127-38>38</a>
</span><span class=lnt id=hl-127-39><a class=lnlinks href=#hl-127-39>39</a>
</span><span class=lnt id=hl-127-40><a class=lnlinks href=#hl-127-40>40</a>
</span><span class=lnt id=hl-127-41><a class=lnlinks href=#hl-127-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=o>[]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>descriptor</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=o>[</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>String</span><span class=p>;)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>flags</span><span class=p>:</span><span class=w> </span><span class=n>ACC_PUBLIC</span><span class=p>,</span><span class=w> </span><span class=n>ACC_STATIC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>stack</span><span class=o>=</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>locals</span><span class=o>=</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>args_size</span><span class=o>=</span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>getstatic</span><span class=w> </span><span class=err>#</span><span class=n>2</span><span class=w> </span><span class=c1>// &lt;- lockå¼•ç”¨ ï¼ˆsynchronizedå¼€å§‹ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>3</span><span class=p>:</span><span class=w> </span><span class=n>dup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>4</span><span class=p>:</span><span class=w> </span><span class=n>astore_1</span><span class=w> </span><span class=c1>// lockå¼•ç”¨ -&gt; slot 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>5</span><span class=p>:</span><span class=w> </span><span class=n>monitorenter</span><span class=w> </span><span class=c1>// å°† lockå¯¹è±¡ MarkWord ç½®ä¸º Monitor æŒ‡é’ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>6</span><span class=p>:</span><span class=w> </span><span class=n>getstatic</span><span class=w> </span><span class=err>#</span><span class=n>3</span><span class=w> </span><span class=c1>// &lt;- i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>9</span><span class=p>:</span><span class=w> </span><span class=n>iconst_1</span><span class=w> </span><span class=c1>// å‡†å¤‡å¸¸æ•° 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>10</span><span class=p>:</span><span class=w> </span><span class=n>iadd</span><span class=w> </span><span class=c1>// +1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>11</span><span class=p>:</span><span class=w> </span><span class=n>putstatic</span><span class=w> </span><span class=err>#</span><span class=n>3</span><span class=w> </span><span class=c1>// -&gt; i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>14</span><span class=p>:</span><span class=w> </span><span class=n>aload_1</span><span class=w> </span><span class=c1>// &lt;- lockå¼•ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>15</span><span class=p>:</span><span class=w> </span><span class=n>monitorexit</span><span class=w> </span><span class=c1>// å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryList</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>16</span><span class=p>:</span><span class=w> </span><span class=k>goto</span><span class=w> </span><span class=n>24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>19</span><span class=p>:</span><span class=w> </span><span class=n>astore_2</span><span class=w> </span><span class=c1>// e -&gt; slot 2 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>20</span><span class=p>:</span><span class=w> </span><span class=n>aload_1</span><span class=w> </span><span class=c1>// &lt;- lockå¼•ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>21</span><span class=p>:</span><span class=w> </span><span class=n>monitorexit</span><span class=w> </span><span class=c1>// å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryList</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>22</span><span class=p>:</span><span class=w> </span><span class=n>aload_2</span><span class=w> </span><span class=c1>// &lt;- slot 2 (e)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>23</span><span class=p>:</span><span class=w> </span><span class=n>athrow</span><span class=w> </span><span class=c1>// throw e</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>24</span><span class=p>:</span><span class=w> </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>Exception</span><span class=w> </span><span class=n>table</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>from</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=n>type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>6</span><span class=w>    </span><span class=n>16</span><span class=w>  </span><span class=n>19</span><span class=w>    </span><span class=n>any</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>19</span><span class=w>   </span><span class=n>22</span><span class=w>  </span><span class=n>19</span><span class=w>    </span><span class=n>any</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>LineNumberTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>line</span><span class=w> </span><span class=n>8</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>line</span><span class=w> </span><span class=n>9</span><span class=p>:</span><span class=w> </span><span class=n>6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>line</span><span class=w> </span><span class=n>10</span><span class=p>:</span><span class=w> </span><span class=n>14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>line</span><span class=w> </span><span class=n>11</span><span class=p>:</span><span class=w> </span><span class=n>24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>LocalVariableTable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>Start</span><span class=w> </span><span class=n>Length</span><span class=w> </span><span class=n>Slot</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=n>Signature</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>0</span><span class=w>     </span><span class=n>25</span><span class=w>     </span><span class=n>0</span><span class=w>    </span><span class=n>args</span><span class=w> </span><span class=o>[</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>String</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>StackMapTable</span><span class=p>:</span><span class=w> </span><span class=n>number_of_entries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>frame_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>255</span><span class=w> </span><span class=cm>/* full_frame */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>offset_delta</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>locals</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=w> </span><span class=kd>class</span> <span class=err>&#34;[</span><span class=nc>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>String</span><span class=p>;</span><span class=s>&#34;, class java/lang/Object ]
</span></span></span><span class=line><span class=cl><span class=s>              stack = [ class java/lang/Throwable ]
</span></span></span><span class=line><span class=cl><span class=s>              frame_type = 250 /* chop */
</span></span></span><span class=line><span class=cl><span class=s>              offset_delta = 4
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong></p><p>æ–¹æ³•çº§åˆ«çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°</p></blockquote><h3 id=font-colorblue-åŸç†ä¹‹-synchronized-è¿›é˜¶font><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-synchronized-%e8%bf%9b%e9%98%b6font class=header-anchor>#</a>
<font color=blue>* åŸç†ä¹‹ synchronized è¿›é˜¶</font></h3><h4 id=è½»é‡çº§é”><a href=#%e8%bd%bb%e9%87%8f%e7%ba%a7%e9%94%81 class=header-anchor>#</a>
è½»é‡çº§é”</h4><p>è½»é‡çº§é”çš„ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è¦åŠ é”ï¼Œä½†åŠ é”çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚</p><p>è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯ synchronized</p><p>å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-128-1><a class=lnlinks href=#hl-128-1> 1</a>
</span><span class=lnt id=hl-128-2><a class=lnlinks href=#hl-128-2> 2</a>
</span><span class=lnt id=hl-128-3><a class=lnlinks href=#hl-128-3> 3</a>
</span><span class=lnt id=hl-128-4><a class=lnlinks href=#hl-128-4> 4</a>
</span><span class=lnt id=hl-128-5><a class=lnlinks href=#hl-128-5> 5</a>
</span><span class=lnt id=hl-128-6><a class=lnlinks href=#hl-128-6> 6</a>
</span><span class=lnt id=hl-128-7><a class=lnlinks href=#hl-128-7> 7</a>
</span><span class=lnt id=hl-128-8><a class=lnlinks href=#hl-128-8> 8</a>
</span><span class=lnt id=hl-128-9><a class=lnlinks href=#hl-128-9> 9</a>
</span><span class=lnt id=hl-128-10><a class=lnlinks href=#hl-128-10>10</a>
</span><span class=lnt id=hl-128-11><a class=lnlinks href=#hl-128-11>11</a>
</span><span class=lnt id=hl-128-12><a class=lnlinks href=#hl-128-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŒæ­¥å— A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>method2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŒæ­¥å— B</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p>åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„ Mark Word</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183003930.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183003930 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li><li><p>è®©é”è®°å½•ä¸­ Object reference æŒ‡å‘é”å¯¹è±¡ï¼Œå¹¶å°è¯•ç”¨ cas æ›¿æ¢ Object çš„ Mark Wordï¼Œå°† Mark Word çš„å€¼å­˜ å…¥é”è®°å½•</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183043247.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183043247 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li><li><p>å¦‚æœ cas æ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº† é”è®°å½•åœ°å€å’ŒçŠ¶æ€ 00 ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”ï¼Œè¿™æ—¶å›¾ç¤ºå¦‚ä¸‹</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183112363.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183112363 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li><li><p>å¦‚æœ cas å¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µ</p><ul><li>å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥ Object çš„è½»é‡çº§é”ï¼Œè¿™æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€è¿‡ç¨‹</li><li>å¦‚æœæ˜¯è‡ªå·±æ‰§è¡Œäº† synchronized é”é‡å…¥ï¼Œé‚£ä¹ˆå†æ·»åŠ ä¸€æ¡ Lock Record ä½œä¸ºé‡å…¥çš„è®¡æ•°</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183158959.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183158959 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li><li><p>å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰å¦‚æœæœ‰å–å€¼ä¸º null çš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ—¶é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡ å…¥è®¡æ•°å‡ä¸€</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183219677.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183219677 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li><li><p>å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰é”è®°å½•çš„å€¼ä¸ä¸º nullï¼Œè¿™æ—¶ä½¿ç”¨caså°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´</p><ul><li>æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ</li><li>å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹</li></ul></li></ul><h4 id=é”è†¨èƒ€><a href=#%e9%94%81%e8%86%a8%e8%83%80 class=header-anchor>#</a>
é”è†¨èƒ€</h4><p>å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCAS æ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ ç«äº‰ï¼‰ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-129-1><a class=lnlinks href=#hl-129-1>1</a>
</span><span class=lnt id=hl-129-2><a class=lnlinks href=#hl-129-2>2</a>
</span><span class=lnt id=hl-129-3><a class=lnlinks href=#hl-129-3>3</a>
</span><span class=lnt id=hl-129-4><a class=lnlinks href=#hl-129-4>4</a>
</span><span class=lnt id=hl-129-5><a class=lnlinks href=#hl-129-5>5</a>
</span><span class=lnt id=hl-129-6><a class=lnlinks href=#hl-129-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŒæ­¥å—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å½“ Thread-1 è¿›è¡Œè½»é‡çº§åŠ é”æ—¶ï¼ŒThread-0 å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183453057.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183453057 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>è¿™æ—¶ Thread-1 åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹<ul><li>å³ä¸º Object å¯¹è±¡ç”³è¯· Monitor é”ï¼Œè®© Object æŒ‡å‘é‡é‡çº§é”åœ°å€</li><li>ç„¶åè‡ªå·±è¿›å…¥ Monitor çš„ EntryList BLOCKED</li></ul></li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317183547387.png width=900 height=600 loading=lazy decoding=async alt=image-20220317183547387 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>å½“ Thread-0 é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨ cas å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œå¤±è´¥ã€‚è¿™æ—¶ä¼šè¿›å…¥é‡é‡çº§è§£é” æµç¨‹ï¼Œå³æŒ‰ç…§ Monitor åœ°å€æ‰¾åˆ° Monitor å¯¹è±¡ï¼Œè®¾ç½® Owner ä¸º nullï¼Œå”¤é†’ EntryList ä¸­ BLOCKED çº¿ç¨‹</li></ul><h4 id=è‡ªæ—‹ä¼˜åŒ–><a href=#%e8%87%aa%e6%97%8b%e4%bc%98%e5%8c%96 class=header-anchor>#</a>
è‡ªæ—‹ä¼˜åŒ–</h4><p>é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥ å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚</p><p>è‡ªæ—‹é‡è¯•æˆåŠŸçš„æƒ…å†µ</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>çº¿ç¨‹1 ( core 1ä¸Š)</th><th style=text-align:center>å¯¹è±¡Mark</th><th style=text-align:center>çº¿ç¨‹2 ( core 2ä¸Š)</th></tr></thead><tbody><tr><td style=text-align:center>-</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>è®¿é—®åŒæ­¥å—ï¼Œè·å–monitor</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>æˆåŠŸï¼ˆåŠ é”ï¼‰</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>æ‰§è¡ŒåŒæ­¥å—</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>æ‰§è¡ŒåŒæ­¥å—</td><td style=text-align:center>10(é‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor</td></tr><tr><td style=text-align:center>æ‰§è¡ŒåŒæ­¥å—</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>è‡ªæ—‹é‡è¯•</td></tr><tr><td style=text-align:center>æ‰§è¡Œå®Œæ¯•</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>è‡ªæ—‹é‡è¯•</td></tr><tr><td style=text-align:center>æˆåŠŸï¼ˆè§£é”ï¼‰</td><td style=text-align:center>01ï¼ˆæ— é”ï¼‰</td><td style=text-align:center>è‡ªæ—‹é‡è¯•</td></tr><tr><td style=text-align:center>-</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>æˆåŠŸï¼ˆåŠ é”)</td></tr><tr><td style=text-align:center>-</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>æ‰§è¡ŒåŒæ­¥å—</td></tr><tr><td style=text-align:center>-</td><td style=text-align:center>&mldr;</td><td style=text-align:center>&mldr;</td></tr></tbody></table></div><p>è‡ªæ—‹é‡è¯•å¤±è´¥çš„æƒ…å†µ</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>çº¿ç¨‹1 ( core 1ä¸Š)</th><th style=text-align:center>å¯¹è±¡Mark</th><th style=text-align:center>çº¿ç¨‹2( core 2ä¸Š)</th></tr></thead><tbody><tr><td style=text-align:center>-</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>è®¿é—®åŒæ­¥å—ï¼Œè·å–monitor</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>æˆåŠŸï¼ˆåŠ é”)</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>æ‰§è¡ŒåŒæ­¥å—</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>æ‰§è¡ŒåŒæ­¥å—</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>è®¿é—®åŒæ­¥å—ï¼Œè·å–monitor</td></tr><tr><td style=text-align:center>æ‰§è¡ŒåŒæ­¥å—</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>è‡ªæ—‹é‡è¯•</td></tr><tr><td style=text-align:center>æ‰§è¡ŒåŒæ­¥å—</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>è‡ªæ—‹é‡è¯•</td></tr><tr><td style=text-align:center>æ‰§è¡ŒåŒæ­¥å—</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>è‡ªæ—‹é‡è¯•</td></tr><tr><td style=text-align:center>æ‰§è¡ŒåŒæ­¥å—</td><td style=text-align:center>10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ</td><td style=text-align:center>é˜»å¡</td></tr><tr><td style=text-align:center>-</td><td style=text-align:center>&mldr;</td><td style=text-align:center>&mldr;</td></tr></tbody></table></div><ul><li>è‡ªæ—‹ä¼šå ç”¨ CPU æ—¶é—´ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿ã€‚</li><li>åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼š é«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚</li><li>Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½</li></ul><h4 id=åå‘é”><a href=#%e5%81%8f%e5%90%91%e9%94%81 class=header-anchor>#</a>
åå‘é”</h4><p>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆå°±è‡ªå·±è¿™ä¸ªçº¿ç¨‹ï¼‰ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œã€‚</p><p>Java 6 ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨ CAS å°†çº¿ç¨‹ ID è®¾ç½®åˆ°å¯¹è±¡çš„ Mark Word å¤´ï¼Œä¹‹åå‘ç° è¿™ä¸ªçº¿ç¨‹ ID æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–° CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰</p><p>ä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-130-1><a class=lnlinks href=#hl-130-1> 1</a>
</span><span class=lnt id=hl-130-2><a class=lnlinks href=#hl-130-2> 2</a>
</span><span class=lnt id=hl-130-3><a class=lnlinks href=#hl-130-3> 3</a>
</span><span class=lnt id=hl-130-4><a class=lnlinks href=#hl-130-4> 4</a>
</span><span class=lnt id=hl-130-5><a class=lnlinks href=#hl-130-5> 5</a>
</span><span class=lnt id=hl-130-6><a class=lnlinks href=#hl-130-6> 6</a>
</span><span class=lnt id=hl-130-7><a class=lnlinks href=#hl-130-7> 7</a>
</span><span class=lnt id=hl-130-8><a class=lnlinks href=#hl-130-8> 8</a>
</span><span class=lnt id=hl-130-9><a class=lnlinks href=#hl-130-9> 9</a>
</span><span class=lnt id=hl-130-10><a class=lnlinks href=#hl-130-10>10</a>
</span><span class=lnt id=hl-130-11><a class=lnlinks href=#hl-130-11>11</a>
</span><span class=lnt id=hl-130-12><a class=lnlinks href=#hl-130-12>12</a>
</span><span class=lnt id=hl-130-13><a class=lnlinks href=#hl-130-13>13</a>
</span><span class=lnt id=hl-130-14><a class=lnlinks href=#hl-130-14>14</a>
</span><span class=lnt id=hl-130-15><a class=lnlinks href=#hl-130-15>15</a>
</span><span class=lnt id=hl-130-16><a class=lnlinks href=#hl-130-16>16</a>
</span><span class=lnt id=hl-130-17><a class=lnlinks href=#hl-130-17>17</a>
</span><span class=lnt id=hl-130-18><a class=lnlinks href=#hl-130-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>m1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŒæ­¥å— A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>m2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>m2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŒæ­¥å— B</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>m3</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>m3</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŒæ­¥å— C</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-131-1><a class=lnlinks href=#hl-131-1> 1</a>
</span><span class=lnt id=hl-131-2><a class=lnlinks href=#hl-131-2> 2</a>
</span><span class=lnt id=hl-131-3><a class=lnlinks href=#hl-131-3> 3</a>
</span><span class=lnt id=hl-131-4><a class=lnlinks href=#hl-131-4> 4</a>
</span><span class=lnt id=hl-131-5><a class=lnlinks href=#hl-131-5> 5</a>
</span><span class=lnt id=hl-131-6><a class=lnlinks href=#hl-131-6> 6</a>
</span><span class=lnt id=hl-131-7><a class=lnlinks href=#hl-131-7> 7</a>
</span><span class=lnt id=hl-131-8><a class=lnlinks href=#hl-131-8> 8</a>
</span><span class=lnt id=hl-131-9><a class=lnlinks href=#hl-131-9> 9</a>
</span><span class=lnt id=hl-131-10><a class=lnlinks href=#hl-131-10>10</a>
</span><span class=lnt id=hl-131-11><a class=lnlinks href=#hl-131-11>11</a>
</span><span class=lnt id=hl-131-12><a class=lnlinks href=#hl-131-12>12</a>
</span><span class=lnt id=hl-131-13><a class=lnlinks href=#hl-131-13>13</a>
</span><span class=lnt id=hl-131-14><a class=lnlinks href=#hl-131-14>14</a>
</span><span class=lnt id=hl-131-15><a class=lnlinks href=#hl-131-15>15</a>
</span><span class=lnt id=hl-131-16><a class=lnlinks href=#hl-131-16>16</a>
</span><span class=lnt id=hl-131-17><a class=lnlinks href=#hl-131-17>17</a>
</span><span class=lnt id=hl-131-18><a class=lnlinks href=#hl-131-18>18</a>
</span><span class=lnt id=hl-131-19><a class=lnlinks href=#hl-131-19>19</a>
</span><span class=lnt id=hl-131-20><a class=lnlinks href=#hl-131-20>20</a>
</span><span class=lnt id=hl-131-21><a class=lnlinks href=#hl-131-21>21</a>
</span><span class=lnt id=hl-131-22><a class=lnlinks href=#hl-131-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph LR
</span></span><span class=line><span class=cl>subgraph åå‘é”
</span></span><span class=line><span class=cl>t5(&#34;m1å†…è°ƒç”¨synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t6(&#34;m2å†…è°ƒç”¨synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t7(&#34;m2å†…è°ƒç”¨synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t8(å¯¹è±¡)
</span></span><span class=line><span class=cl>t5 -.ç”¨ThreadIDæ›¿æ¢MarkWord.-&gt; t8
</span></span><span class=line><span class=cl>t6 -.æ£€æŸ¥ThreadIDæ˜¯å¦æ˜¯è‡ªå·±.-&gt; t8
</span></span><span class=line><span class=cl>t7 -.æ£€æŸ¥ThreadIDæ˜¯å¦æ˜¯è‡ªå·±.-&gt; t8
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>subgraph è½»é‡çº§é”
</span></span><span class=line><span class=cl>t1(&#34;m1å†…è°ƒç”¨synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t2(&#34;m2å†…è°ƒç”¨synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t3(&#34;m2å†…è°ƒç”¨synchronized(obj)&#34;)
</span></span><span class=line><span class=cl>t1 -.ç”Ÿæˆé”è®°å½•.-&gt; t1
</span></span><span class=line><span class=cl>t2 -.ç”Ÿæˆé”è®°å½•.-&gt; t2
</span></span><span class=line><span class=cl>t3 -.ç”Ÿæˆé”è®°å½•.-&gt; t3
</span></span><span class=line><span class=cl>t4(å¯¹è±¡)
</span></span><span class=line><span class=cl>t1 -.ç”¨é”è®°å½•æ›¿æ¢markword.-&gt; t4
</span></span><span class=line><span class=cl>t2 -.ç”¨é”è®°å½•æ›¿æ¢markword.-&gt; t4
</span></span><span class=line><span class=cl>t3 -.ç”¨é”è®°å½•æ›¿æ¢markword.-&gt; t4
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><h5 id=åå‘çŠ¶æ€><a href=#%e5%81%8f%e5%90%91%e7%8a%b6%e6%80%81 class=header-anchor>#</a>
åå‘çŠ¶æ€</h5><p>å›å¿†ä¸€ä¸‹å¯¹è±¡å¤´æ ¼å¼</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-132-1><a class=lnlinks href=#hl-132-1> 1</a>
</span><span class=lnt id=hl-132-2><a class=lnlinks href=#hl-132-2> 2</a>
</span><span class=lnt id=hl-132-3><a class=lnlinks href=#hl-132-3> 3</a>
</span><span class=lnt id=hl-132-4><a class=lnlinks href=#hl-132-4> 4</a>
</span><span class=lnt id=hl-132-5><a class=lnlinks href=#hl-132-5> 5</a>
</span><span class=lnt id=hl-132-6><a class=lnlinks href=#hl-132-6> 6</a>
</span><span class=lnt id=hl-132-7><a class=lnlinks href=#hl-132-7> 7</a>
</span><span class=lnt id=hl-132-8><a class=lnlinks href=#hl-132-8> 8</a>
</span><span class=lnt id=hl-132-9><a class=lnlinks href=#hl-132-9> 9</a>
</span><span class=lnt id=hl-132-10><a class=lnlinks href=#hl-132-10>10</a>
</span><span class=lnt id=hl-132-11><a class=lnlinks href=#hl-132-11>11</a>
</span><span class=lnt id=hl-132-12><a class=lnlinks href=#hl-132-12>12</a>
</span><span class=lnt id=hl-132-13><a class=lnlinks href=#hl-132-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                          <span class=no>Mark</span> <span class=no>Word</span> <span class=p>(</span><span class=mi>64</span> <span class=n>bits</span><span class=p>)</span>                       <span class=o>|</span>        <span class=no>State</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>25</span> <span class=o>|</span> <span class=ss>hashcode</span><span class=p>:</span><span class=mi>31</span> <span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span> <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>0</span> <span class=o>|</span>  <span class=mo>01</span>   <span class=o>|</span>        <span class=no>Normal</span>      <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=ss>thread</span><span class=p>:</span><span class=mi>54</span> <span class=o>|</span>   <span class=ss>epoch</span><span class=p>:</span><span class=mi>2</span>   <span class=o>|</span> <span class=ss>unused</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span> <span class=ss>age</span><span class=p>:</span><span class=mi>4</span> <span class=o>|</span> <span class=ss>biased_lock</span><span class=p>:</span><span class=mi>1</span> <span class=o>|</span>  <span class=mo>01</span>   <span class=o>|</span>        <span class=no>Biased</span>      <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                    <span class=ss>ptr_to_lock_record</span><span class=p>:</span><span class=mi>62</span>                   <span class=o>|</span>  <span class=mo>00</span>   <span class=o>|</span> <span class=no>Lightweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                 <span class=ss>ptr_to_heavyweight_monitor</span><span class=p>:</span><span class=mi>62</span>              <span class=o>|</span>  <span class=mi>10</span>   <span class=o>|</span> <span class=no>Heavyweight</span> <span class=no>Locked</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span><span class=line><span class=cl><span class=o>|</span>                                                            <span class=o>|</span>  <span class=mi>11</span>   <span class=o>|</span>    <span class=no>Marked</span> <span class=k>for</span> <span class=no>GC</span>   <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|--------------------------------------------------------------------|--------------------|</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š</p><ul><li>å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkword å€¼ä¸º 0x05 å³æœ€å 3 ä½ä¸º 101ï¼Œè¿™æ—¶å®ƒçš„ threadã€epochã€age éƒ½ä¸º 0</li><li>åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ  VM å‚æ•°<code>- XX:BiasedLockingStartupDelay=0</code>æ¥ç¦ç”¨å»¶è¿Ÿ</li><li>å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkword å€¼ä¸º 0x01 å³æœ€å 3 ä½ä¸º 001ï¼Œè¿™æ—¶å®ƒçš„ hashcodeã€ age éƒ½ä¸º 0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ° hashcode æ—¶æ‰ä¼šèµ‹å€¼</li></ul><p>1ï¼‰ æµ‹è¯•å»¶è¿Ÿç‰¹æ€§</p><p>2ï¼‰ æµ‹è¯•åå‘é”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-133-1><a class=lnlinks href=#hl-133-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Dog</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åˆ©ç”¨ jol ç¬¬ä¸‰æ–¹å·¥å…·æ¥æŸ¥çœ‹å¯¹è±¡å¤´ä¿¡æ¯ï¼ˆæ³¨æ„è¿™é‡Œæˆ‘æ‰©å±•äº† jol è®©å®ƒè¾“å‡ºæ›´ä¸ºç®€æ´ï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-134-1><a class=lnlinks href=#hl-134-1> 1</a>
</span><span class=lnt id=hl-134-2><a class=lnlinks href=#hl-134-2> 2</a>
</span><span class=lnt id=hl-134-3><a class=lnlinks href=#hl-134-3> 3</a>
</span><span class=lnt id=hl-134-4><a class=lnlinks href=#hl-134-4> 4</a>
</span><span class=lnt id=hl-134-5><a class=lnlinks href=#hl-134-5> 5</a>
</span><span class=lnt id=hl-134-6><a class=lnlinks href=#hl-134-6> 6</a>
</span><span class=lnt id=hl-134-7><a class=lnlinks href=#hl-134-7> 7</a>
</span><span class=lnt id=hl-134-8><a class=lnlinks href=#hl-134-8> 8</a>
</span><span class=lnt id=hl-134-9><a class=lnlinks href=#hl-134-9> 9</a>
</span><span class=lnt id=hl-134-10><a class=lnlinks href=#hl-134-10>10</a>
</span><span class=lnt id=hl-134-11><a class=lnlinks href=#hl-134-11>11</a>
</span><span class=lnt id=hl-134-12><a class=lnlinks href=#hl-134-12>12</a>
</span><span class=lnt id=hl-134-13><a class=lnlinks href=#hl-134-13>13</a>
</span><span class=lnt id=hl-134-14><a class=lnlinks href=#hl-134-14>14</a>
</span><span class=lnt id=hl-134-15><a class=lnlinks href=#hl-134-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æ·»åŠ è™šæ‹Ÿæœºå‚æ•° -XX:BiasedLockingStartupDelay=0 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClassLayout</span><span class=w> </span><span class=n>classLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;synchronized å‰&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>classLayout</span><span class=p>.</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;synchronized ä¸­&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>classLayout</span><span class=p>.</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;synchronized å&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>classLayout</span><span class=p>.</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-135-1><a class=lnlinks href=#hl-135-1>1</a>
</span><span class=lnt id=hl-135-2><a class=lnlinks href=#hl-135-2>2</a>
</span><span class=lnt id=hl-135-3><a class=lnlinks href=#hl-135-3>3</a>
</span><span class=lnt id=hl-135-4><a class=lnlinks href=#hl-135-4>4</a>
</span><span class=lnt id=hl-135-5><a class=lnlinks href=#hl-135-5>5</a>
</span><span class=lnt id=hl-135-6><a class=lnlinks href=#hl-135-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:08:58.117 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized å‰
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl>11:08:58.121 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized ä¸­
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11101011</span> <span class=m>11010000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl>11:08:58.121 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized å
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11101011</span> <span class=m>11010000</span> <span class=m>00000101</span> 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong></p><p>å¤„äºåå‘é”çš„å¯¹è±¡è§£é”åï¼Œçº¿ç¨‹ id ä»å­˜å‚¨äºå¯¹è±¡å¤´ä¸­</p></blockquote><p>3ï¼‰æµ‹è¯•ç¦ç”¨</p><p>åœ¨ä¸Šé¢æµ‹è¯•ä»£ç è¿è¡Œæ—¶åœ¨æ·»åŠ  VM å‚æ•° -XX:-UseBiasedLocking ç¦ç”¨åå‘é”</p><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-136-1><a class=lnlinks href=#hl-136-1>1</a>
</span><span class=lnt id=hl-136-2><a class=lnlinks href=#hl-136-2>2</a>
</span><span class=lnt id=hl-136-3><a class=lnlinks href=#hl-136-3>3</a>
</span><span class=lnt id=hl-136-4><a class=lnlinks href=#hl-136-4>4</a>
</span><span class=lnt id=hl-136-5><a class=lnlinks href=#hl-136-5>5</a>
</span><span class=lnt id=hl-136-6><a class=lnlinks href=#hl-136-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:13:10.018 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized å‰
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl>11:13:10.021 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized ä¸­
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>00010100</span> <span class=m>11110011</span> <span class=m>10001000</span> 
</span></span><span class=line><span class=cl>11:13:10.021 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized å
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span></code></pre></td></tr></table></div></div><p>4)æµ‹è¯• hashCode</p><ul><li>æ­£å¸¸çŠ¶æ€å¯¹è±¡ä¸€å¼€å§‹æ˜¯æ²¡æœ‰ hashCode çš„ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ‰ç”Ÿæˆ</li></ul><h5 id=æ’¤é”€---è°ƒç”¨å¯¹è±¡-hashcode><a href=#%e6%92%a4%e9%94%80---%e8%b0%83%e7%94%a8%e5%af%b9%e8%b1%a1-hashcode class=header-anchor>#</a>
æ’¤é”€ - è°ƒç”¨å¯¹è±¡ hashCode</h5><p>è°ƒç”¨äº†å¯¹è±¡çš„ hashCodeï¼Œä½†åå‘é”çš„å¯¹è±¡ MarkWord ä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹ idï¼Œå¦‚æœè°ƒç”¨ hashCode ä¼šå¯¼è‡´åå‘é”è¢« æ’¤é”€</p><ul><li>è½»é‡çº§é”ä¼šåœ¨é”è®°å½•ä¸­è®°å½• hashCode</li><li>é‡é‡çº§é”ä¼šåœ¨ Monitor ä¸­è®°å½• hashCode</li></ul><p>åœ¨è°ƒç”¨ hashCode åä½¿ç”¨åå‘é”ï¼Œè®°å¾—å»æ‰<code>-XX:-UseBiasedLocking</code></p><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-137-1><a class=lnlinks href=#hl-137-1>1</a>
</span><span class=lnt id=hl-137-2><a class=lnlinks href=#hl-137-2>2</a>
</span><span class=lnt id=hl-137-3><a class=lnlinks href=#hl-137-3>3</a>
</span><span class=lnt id=hl-137-4><a class=lnlinks href=#hl-137-4>4</a>
</span><span class=lnt id=hl-137-5><a class=lnlinks href=#hl-137-5>5</a>
</span><span class=lnt id=hl-137-6><a class=lnlinks href=#hl-137-6>6</a>
</span><span class=lnt id=hl-137-7><a class=lnlinks href=#hl-137-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SH data-lang=SH><span class=line><span class=cl>11:22:10.386 c.TestBiased <span class=o>[</span>main<span class=o>]</span> - è°ƒç”¨ hashCode:1778535015 
</span></span><span class=line><span class=cl>11:22:10.391 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized å‰
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>01101010</span> <span class=m>00000010</span> <span class=m>01001010</span> <span class=m>01100111</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl>11:22:10.393 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized ä¸­
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>11000011</span> <span class=m>11110011</span> <span class=m>01101000</span> 
</span></span><span class=line><span class=cl>11:22:10.393 c.TestBiased <span class=o>[</span>t1<span class=o>]</span> - synchronized å
</span></span><span class=line><span class=cl><span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>01101010</span> <span class=m>00000010</span> <span class=m>01001010</span> <span class=m>01100111</span> <span class=m>00000001</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=æ’¤é”€---å…¶å®ƒçº¿ç¨‹ä½¿ç”¨å¯¹è±¡><a href=#%e6%92%a4%e9%94%80---%e5%85%b6%e5%ae%83%e7%ba%bf%e7%a8%8b%e4%bd%bf%e7%94%a8%e5%af%b9%e8%b1%a1 class=header-anchor>#</a>
æ’¤é”€ - å…¶å®ƒçº¿ç¨‹ä½¿ç”¨å¯¹è±¡</h5><p>å½“æœ‰å…¶å®ƒçº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-138-1><a class=lnlinks href=#hl-138-1> 1</a>
</span><span class=lnt id=hl-138-2><a class=lnlinks href=#hl-138-2> 2</a>
</span><span class=lnt id=hl-138-3><a class=lnlinks href=#hl-138-3> 3</a>
</span><span class=lnt id=hl-138-4><a class=lnlinks href=#hl-138-4> 4</a>
</span><span class=lnt id=hl-138-5><a class=lnlinks href=#hl-138-5> 5</a>
</span><span class=lnt id=hl-138-6><a class=lnlinks href=#hl-138-6> 6</a>
</span><span class=lnt id=hl-138-7><a class=lnlinks href=#hl-138-7> 7</a>
</span><span class=lnt id=hl-138-8><a class=lnlinks href=#hl-138-8> 8</a>
</span><span class=lnt id=hl-138-9><a class=lnlinks href=#hl-138-9> 9</a>
</span><span class=lnt id=hl-138-10><a class=lnlinks href=#hl-138-10>10</a>
</span><span class=lnt id=hl-138-11><a class=lnlinks href=#hl-138-11>11</a>
</span><span class=lnt id=hl-138-12><a class=lnlinks href=#hl-138-12>12</a>
</span><span class=lnt id=hl-138-13><a class=lnlinks href=#hl-138-13>13</a>
</span><span class=lnt id=hl-138-14><a class=lnlinks href=#hl-138-14>14</a>
</span><span class=lnt id=hl-138-15><a class=lnlinks href=#hl-138-15>15</a>
</span><span class=lnt id=hl-138-16><a class=lnlinks href=#hl-138-16>16</a>
</span><span class=lnt id=hl-138-17><a class=lnlinks href=#hl-138-17>17</a>
</span><span class=lnt id=hl-138-18><a class=lnlinks href=#hl-138-18>18</a>
</span><span class=lnt id=hl-138-19><a class=lnlinks href=#hl-138-19>19</a>
</span><span class=lnt id=hl-138-20><a class=lnlinks href=#hl-138-20>20</a>
</span><span class=lnt id=hl-138-21><a class=lnlinks href=#hl-138-21>21</a>
</span><span class=lnt id=hl-138-22><a class=lnlinks href=#hl-138-22>22</a>
</span><span class=lnt id=hl-138-23><a class=lnlinks href=#hl-138-23>23</a>
</span><span class=lnt id=hl-138-24><a class=lnlinks href=#hl-138-24>24</a>
</span><span class=lnt id=hl-138-25><a class=lnlinks href=#hl-138-25>25</a>
</span><span class=lnt id=hl-138-26><a class=lnlinks href=#hl-138-26>26</a>
</span><span class=lnt id=hl-138-27><a class=lnlinks href=#hl-138-27>27</a>
</span><span class=lnt id=hl-138-28><a class=lnlinks href=#hl-138-28>28</a>
</span><span class=lnt id=hl-138-29><a class=lnlinks href=#hl-138-29>29</a>
</span><span class=lnt id=hl-138-30><a class=lnlinks href=#hl-138-30>30</a>
</span><span class=lnt id=hl-138-31><a class=lnlinks href=#hl-138-31>31</a>
</span><span class=lnt id=hl-138-32><a class=lnlinks href=#hl-138-32>32</a>
</span><span class=lnt id=hl-138-33><a class=lnlinks href=#hl-138-33>33</a>
</span><span class=lnt id=hl-138-34><a class=lnlinks href=#hl-138-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JAVA data-lang=JAVA><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>TestBiased</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TestBiased</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœä¸ç”¨ wait/notify ä½¿ç”¨ join å¿…é¡»æ‰“å¼€ä¸‹é¢çš„æ³¨é‡Š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å› ä¸ºï¼št1 çº¿ç¨‹ä¸èƒ½ç»“æŸï¼Œå¦åˆ™åº•å±‚çº¿ç¨‹å¯èƒ½è¢« jvm é‡ç”¨ä½œä¸º t2 çº¿ç¨‹ï¼Œåº•å±‚çº¿ç¨‹ id æ˜¯ä¸€æ ·çš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*try {
</span></span></span><span class=line><span class=cl><span class=cm> System.in.read();
</span></span></span><span class=line><span class=cl><span class=cm> } catch (IOException e) {
</span></span></span><span class=line><span class=cl><span class=cm> e.printStackTrace();
</span></span></span><span class=line><span class=cl><span class=cm> }*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>TestBiased</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TestBiased</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-139-1><a class=lnlinks href=#hl-139-1>1</a>
</span><span class=lnt id=hl-139-2><a class=lnlinks href=#hl-139-2>2</a>
</span><span class=lnt id=hl-139-3><a class=lnlinks href=#hl-139-3>3</a>
</span><span class=lnt id=hl-139-4><a class=lnlinks href=#hl-139-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>01000001</span> <span class=m>00010000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>01000001</span> <span class=m>00010000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>10110101</span> <span class=m>11110000</span> <span class=m>01000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=æ’¤é”€---è°ƒç”¨-waitnotify><a href=#%e6%92%a4%e9%94%80---%e8%b0%83%e7%94%a8-waitnotify class=header-anchor>#</a>
æ’¤é”€ - è°ƒç”¨ wait/notify</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-140-1><a class=lnlinks href=#hl-140-1> 1</a>
</span><span class=lnt id=hl-140-2><a class=lnlinks href=#hl-140-2> 2</a>
</span><span class=lnt id=hl-140-3><a class=lnlinks href=#hl-140-3> 3</a>
</span><span class=lnt id=hl-140-4><a class=lnlinks href=#hl-140-4> 4</a>
</span><span class=lnt id=hl-140-5><a class=lnlinks href=#hl-140-5> 5</a>
</span><span class=lnt id=hl-140-6><a class=lnlinks href=#hl-140-6> 6</a>
</span><span class=lnt id=hl-140-7><a class=lnlinks href=#hl-140-7> 7</a>
</span><span class=lnt id=hl-140-8><a class=lnlinks href=#hl-140-8> 8</a>
</span><span class=lnt id=hl-140-9><a class=lnlinks href=#hl-140-9> 9</a>
</span><span class=lnt id=hl-140-10><a class=lnlinks href=#hl-140-10>10</a>
</span><span class=lnt id=hl-140-11><a class=lnlinks href=#hl-140-11>11</a>
</span><span class=lnt id=hl-140-12><a class=lnlinks href=#hl-140-12>12</a>
</span><span class=lnt id=hl-140-13><a class=lnlinks href=#hl-140-13>13</a>
</span><span class=lnt id=hl-140-14><a class=lnlinks href=#hl-140-14>14</a>
</span><span class=lnt id=hl-140-15><a class=lnlinks href=#hl-140-15>15</a>
</span><span class=lnt id=hl-140-16><a class=lnlinks href=#hl-140-16>16</a>
</span><span class=lnt id=hl-140-17><a class=lnlinks href=#hl-140-17>17</a>
</span><span class=lnt id=hl-140-18><a class=lnlinks href=#hl-140-18>18</a>
</span><span class=lnt id=hl-140-19><a class=lnlinks href=#hl-140-19>19</a>
</span><span class=lnt id=hl-140-20><a class=lnlinks href=#hl-140-20>20</a>
</span><span class=lnt id=hl-140-21><a class=lnlinks href=#hl-140-21>21</a>
</span><span class=lnt id=hl-140-22><a class=lnlinks href=#hl-140-22>22</a>
</span><span class=lnt id=hl-140-23><a class=lnlinks href=#hl-140-23>23</a>
</span><span class=lnt id=hl-140-24><a class=lnlinks href=#hl-140-24>24</a>
</span><span class=lnt id=hl-140-25><a class=lnlinks href=#hl-140-25>25</a>
</span><span class=lnt id=hl-140-26><a class=lnlinks href=#hl-140-26>26</a>
</span><span class=lnt id=hl-140-27><a class=lnlinks href=#hl-140-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>d</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>6000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;notify&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>d</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-141-1><a class=lnlinks href=#hl-141-1>1</a>
</span><span class=lnt id=hl-141-2><a class=lnlinks href=#hl-141-2>2</a>
</span><span class=lnt id=hl-141-3><a class=lnlinks href=#hl-141-3>3</a>
</span><span class=lnt id=hl-141-4><a class=lnlinks href=#hl-141-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>10110011</span> <span class=m>11111000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - notify 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011100</span> <span class=m>11010100</span> <span class=m>00001101</span> <span class=m>11001010</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=æ‰¹é‡é‡åå‘><a href=#%e6%89%b9%e9%87%8f%e9%87%8d%e5%81%8f%e5%90%91 class=header-anchor>#</a>
<strong>æ‰¹é‡é‡åå‘</strong></h5><p>å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹ T1 çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘ T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡ çš„ Thread ID</p><p>å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 20 æ¬¡åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œæˆ‘æ˜¯ä¸æ˜¯åå‘é”™äº†å‘¢ï¼Œäºæ˜¯ä¼šåœ¨ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³ åŠ é”çº¿ç¨‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-142-1><a class=lnlinks href=#hl-142-1> 1</a>
</span><span class=lnt id=hl-142-2><a class=lnlinks href=#hl-142-2> 2</a>
</span><span class=lnt id=hl-142-3><a class=lnlinks href=#hl-142-3> 3</a>
</span><span class=lnt id=hl-142-4><a class=lnlinks href=#hl-142-4> 4</a>
</span><span class=lnt id=hl-142-5><a class=lnlinks href=#hl-142-5> 5</a>
</span><span class=lnt id=hl-142-6><a class=lnlinks href=#hl-142-6> 6</a>
</span><span class=lnt id=hl-142-7><a class=lnlinks href=#hl-142-7> 7</a>
</span><span class=lnt id=hl-142-8><a class=lnlinks href=#hl-142-8> 8</a>
</span><span class=lnt id=hl-142-9><a class=lnlinks href=#hl-142-9> 9</a>
</span><span class=lnt id=hl-142-10><a class=lnlinks href=#hl-142-10>10</a>
</span><span class=lnt id=hl-142-11><a class=lnlinks href=#hl-142-11>11</a>
</span><span class=lnt id=hl-142-12><a class=lnlinks href=#hl-142-12>12</a>
</span><span class=lnt id=hl-142-13><a class=lnlinks href=#hl-142-13>13</a>
</span><span class=lnt id=hl-142-14><a class=lnlinks href=#hl-142-14>14</a>
</span><span class=lnt id=hl-142-15><a class=lnlinks href=#hl-142-15>15</a>
</span><span class=lnt id=hl-142-16><a class=lnlinks href=#hl-142-16>16</a>
</span><span class=lnt id=hl-142-17><a class=lnlinks href=#hl-142-17>17</a>
</span><span class=lnt id=hl-142-18><a class=lnlinks href=#hl-142-18>18</a>
</span><span class=lnt id=hl-142-19><a class=lnlinks href=#hl-142-19>19</a>
</span><span class=lnt id=hl-142-20><a class=lnlinks href=#hl-142-20>20</a>
</span><span class=lnt id=hl-142-21><a class=lnlinks href=#hl-142-21>21</a>
</span><span class=lnt id=hl-142-22><a class=lnlinks href=#hl-142-22>22</a>
</span><span class=lnt id=hl-142-23><a class=lnlinks href=#hl-142-23>23</a>
</span><span class=lnt id=hl-142-24><a class=lnlinks href=#hl-142-24>24</a>
</span><span class=lnt id=hl-142-25><a class=lnlinks href=#hl-142-25>25</a>
</span><span class=lnt id=hl-142-26><a class=lnlinks href=#hl-142-26>26</a>
</span><span class=lnt id=hl-142-27><a class=lnlinks href=#hl-142-27>27</a>
</span><span class=lnt id=hl-142-28><a class=lnlinks href=#hl-142-28>28</a>
</span><span class=lnt id=hl-142-29><a class=lnlinks href=#hl-142-29>29</a>
</span><span class=lnt id=hl-142-30><a class=lnlinks href=#hl-142-30>30</a>
</span><span class=lnt id=hl-142-31><a class=lnlinks href=#hl-142-31>31</a>
</span><span class=lnt id=hl-142-32><a class=lnlinks href=#hl-142-32>32</a>
</span><span class=lnt id=hl-142-33><a class=lnlinks href=#hl-142-33>33</a>
</span><span class=lnt id=hl-142-34><a class=lnlinks href=#hl-142-34>34</a>
</span><span class=lnt id=hl-142-35><a class=lnlinks href=#hl-142-35>35</a>
</span><span class=lnt id=hl-142-36><a class=lnlinks href=#hl-142-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test3</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Vector</span><span class=o>&lt;</span><span class=n>Dog</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Vector</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>30</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>d</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>list</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;===============&gt; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>30</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-143-1><a class=lnlinks href=#hl-143-1>  1</a>
</span><span class=lnt id=hl-143-2><a class=lnlinks href=#hl-143-2>  2</a>
</span><span class=lnt id=hl-143-3><a class=lnlinks href=#hl-143-3>  3</a>
</span><span class=lnt id=hl-143-4><a class=lnlinks href=#hl-143-4>  4</a>
</span><span class=lnt id=hl-143-5><a class=lnlinks href=#hl-143-5>  5</a>
</span><span class=lnt id=hl-143-6><a class=lnlinks href=#hl-143-6>  6</a>
</span><span class=lnt id=hl-143-7><a class=lnlinks href=#hl-143-7>  7</a>
</span><span class=lnt id=hl-143-8><a class=lnlinks href=#hl-143-8>  8</a>
</span><span class=lnt id=hl-143-9><a class=lnlinks href=#hl-143-9>  9</a>
</span><span class=lnt id=hl-143-10><a class=lnlinks href=#hl-143-10> 10</a>
</span><span class=lnt id=hl-143-11><a class=lnlinks href=#hl-143-11> 11</a>
</span><span class=lnt id=hl-143-12><a class=lnlinks href=#hl-143-12> 12</a>
</span><span class=lnt id=hl-143-13><a class=lnlinks href=#hl-143-13> 13</a>
</span><span class=lnt id=hl-143-14><a class=lnlinks href=#hl-143-14> 14</a>
</span><span class=lnt id=hl-143-15><a class=lnlinks href=#hl-143-15> 15</a>
</span><span class=lnt id=hl-143-16><a class=lnlinks href=#hl-143-16> 16</a>
</span><span class=lnt id=hl-143-17><a class=lnlinks href=#hl-143-17> 17</a>
</span><span class=lnt id=hl-143-18><a class=lnlinks href=#hl-143-18> 18</a>
</span><span class=lnt id=hl-143-19><a class=lnlinks href=#hl-143-19> 19</a>
</span><span class=lnt id=hl-143-20><a class=lnlinks href=#hl-143-20> 20</a>
</span><span class=lnt id=hl-143-21><a class=lnlinks href=#hl-143-21> 21</a>
</span><span class=lnt id=hl-143-22><a class=lnlinks href=#hl-143-22> 22</a>
</span><span class=lnt id=hl-143-23><a class=lnlinks href=#hl-143-23> 23</a>
</span><span class=lnt id=hl-143-24><a class=lnlinks href=#hl-143-24> 24</a>
</span><span class=lnt id=hl-143-25><a class=lnlinks href=#hl-143-25> 25</a>
</span><span class=lnt id=hl-143-26><a class=lnlinks href=#hl-143-26> 26</a>
</span><span class=lnt id=hl-143-27><a class=lnlinks href=#hl-143-27> 27</a>
</span><span class=lnt id=hl-143-28><a class=lnlinks href=#hl-143-28> 28</a>
</span><span class=lnt id=hl-143-29><a class=lnlinks href=#hl-143-29> 29</a>
</span><span class=lnt id=hl-143-30><a class=lnlinks href=#hl-143-30> 30</a>
</span><span class=lnt id=hl-143-31><a class=lnlinks href=#hl-143-31> 31</a>
</span><span class=lnt id=hl-143-32><a class=lnlinks href=#hl-143-32> 32</a>
</span><span class=lnt id=hl-143-33><a class=lnlinks href=#hl-143-33> 33</a>
</span><span class=lnt id=hl-143-34><a class=lnlinks href=#hl-143-34> 34</a>
</span><span class=lnt id=hl-143-35><a class=lnlinks href=#hl-143-35> 35</a>
</span><span class=lnt id=hl-143-36><a class=lnlinks href=#hl-143-36> 36</a>
</span><span class=lnt id=hl-143-37><a class=lnlinks href=#hl-143-37> 37</a>
</span><span class=lnt id=hl-143-38><a class=lnlinks href=#hl-143-38> 38</a>
</span><span class=lnt id=hl-143-39><a class=lnlinks href=#hl-143-39> 39</a>
</span><span class=lnt id=hl-143-40><a class=lnlinks href=#hl-143-40> 40</a>
</span><span class=lnt id=hl-143-41><a class=lnlinks href=#hl-143-41> 41</a>
</span><span class=lnt id=hl-143-42><a class=lnlinks href=#hl-143-42> 42</a>
</span><span class=lnt id=hl-143-43><a class=lnlinks href=#hl-143-43> 43</a>
</span><span class=lnt id=hl-143-44><a class=lnlinks href=#hl-143-44> 44</a>
</span><span class=lnt id=hl-143-45><a class=lnlinks href=#hl-143-45> 45</a>
</span><span class=lnt id=hl-143-46><a class=lnlinks href=#hl-143-46> 46</a>
</span><span class=lnt id=hl-143-47><a class=lnlinks href=#hl-143-47> 47</a>
</span><span class=lnt id=hl-143-48><a class=lnlinks href=#hl-143-48> 48</a>
</span><span class=lnt id=hl-143-49><a class=lnlinks href=#hl-143-49> 49</a>
</span><span class=lnt id=hl-143-50><a class=lnlinks href=#hl-143-50> 50</a>
</span><span class=lnt id=hl-143-51><a class=lnlinks href=#hl-143-51> 51</a>
</span><span class=lnt id=hl-143-52><a class=lnlinks href=#hl-143-52> 52</a>
</span><span class=lnt id=hl-143-53><a class=lnlinks href=#hl-143-53> 53</a>
</span><span class=lnt id=hl-143-54><a class=lnlinks href=#hl-143-54> 54</a>
</span><span class=lnt id=hl-143-55><a class=lnlinks href=#hl-143-55> 55</a>
</span><span class=lnt id=hl-143-56><a class=lnlinks href=#hl-143-56> 56</a>
</span><span class=lnt id=hl-143-57><a class=lnlinks href=#hl-143-57> 57</a>
</span><span class=lnt id=hl-143-58><a class=lnlinks href=#hl-143-58> 58</a>
</span><span class=lnt id=hl-143-59><a class=lnlinks href=#hl-143-59> 59</a>
</span><span class=lnt id=hl-143-60><a class=lnlinks href=#hl-143-60> 60</a>
</span><span class=lnt id=hl-143-61><a class=lnlinks href=#hl-143-61> 61</a>
</span><span class=lnt id=hl-143-62><a class=lnlinks href=#hl-143-62> 62</a>
</span><span class=lnt id=hl-143-63><a class=lnlinks href=#hl-143-63> 63</a>
</span><span class=lnt id=hl-143-64><a class=lnlinks href=#hl-143-64> 64</a>
</span><span class=lnt id=hl-143-65><a class=lnlinks href=#hl-143-65> 65</a>
</span><span class=lnt id=hl-143-66><a class=lnlinks href=#hl-143-66> 66</a>
</span><span class=lnt id=hl-143-67><a class=lnlinks href=#hl-143-67> 67</a>
</span><span class=lnt id=hl-143-68><a class=lnlinks href=#hl-143-68> 68</a>
</span><span class=lnt id=hl-143-69><a class=lnlinks href=#hl-143-69> 69</a>
</span><span class=lnt id=hl-143-70><a class=lnlinks href=#hl-143-70> 70</a>
</span><span class=lnt id=hl-143-71><a class=lnlinks href=#hl-143-71> 71</a>
</span><span class=lnt id=hl-143-72><a class=lnlinks href=#hl-143-72> 72</a>
</span><span class=lnt id=hl-143-73><a class=lnlinks href=#hl-143-73> 73</a>
</span><span class=lnt id=hl-143-74><a class=lnlinks href=#hl-143-74> 74</a>
</span><span class=lnt id=hl-143-75><a class=lnlinks href=#hl-143-75> 75</a>
</span><span class=lnt id=hl-143-76><a class=lnlinks href=#hl-143-76> 76</a>
</span><span class=lnt id=hl-143-77><a class=lnlinks href=#hl-143-77> 77</a>
</span><span class=lnt id=hl-143-78><a class=lnlinks href=#hl-143-78> 78</a>
</span><span class=lnt id=hl-143-79><a class=lnlinks href=#hl-143-79> 79</a>
</span><span class=lnt id=hl-143-80><a class=lnlinks href=#hl-143-80> 80</a>
</span><span class=lnt id=hl-143-81><a class=lnlinks href=#hl-143-81> 81</a>
</span><span class=lnt id=hl-143-82><a class=lnlinks href=#hl-143-82> 82</a>
</span><span class=lnt id=hl-143-83><a class=lnlinks href=#hl-143-83> 83</a>
</span><span class=lnt id=hl-143-84><a class=lnlinks href=#hl-143-84> 84</a>
</span><span class=lnt id=hl-143-85><a class=lnlinks href=#hl-143-85> 85</a>
</span><span class=lnt id=hl-143-86><a class=lnlinks href=#hl-143-86> 86</a>
</span><span class=lnt id=hl-143-87><a class=lnlinks href=#hl-143-87> 87</a>
</span><span class=lnt id=hl-143-88><a class=lnlinks href=#hl-143-88> 88</a>
</span><span class=lnt id=hl-143-89><a class=lnlinks href=#hl-143-89> 89</a>
</span><span class=lnt id=hl-143-90><a class=lnlinks href=#hl-143-90> 90</a>
</span><span class=lnt id=hl-143-91><a class=lnlinks href=#hl-143-91> 91</a>
</span><span class=lnt id=hl-143-92><a class=lnlinks href=#hl-143-92> 92</a>
</span><span class=lnt id=hl-143-93><a class=lnlinks href=#hl-143-93> 93</a>
</span><span class=lnt id=hl-143-94><a class=lnlinks href=#hl-143-94> 94</a>
</span><span class=lnt id=hl-143-95><a class=lnlinks href=#hl-143-95> 95</a>
</span><span class=lnt id=hl-143-96><a class=lnlinks href=#hl-143-96> 96</a>
</span><span class=lnt id=hl-143-97><a class=lnlinks href=#hl-143-97> 97</a>
</span><span class=lnt id=hl-143-98><a class=lnlinks href=#hl-143-98> 98</a>
</span><span class=lnt id=hl-143-99><a class=lnlinks href=#hl-143-99> 99</a>
</span><span class=lnt id=hl-143-100><a class=lnlinks href=#hl-143-100>100</a>
</span><span class=lnt id=hl-143-101><a class=lnlinks href=#hl-143-101>101</a>
</span><span class=lnt id=hl-143-102><a class=lnlinks href=#hl-143-102>102</a>
</span><span class=lnt id=hl-143-103><a class=lnlinks href=#hl-143-103>103</a>
</span><span class=lnt id=hl-143-104><a class=lnlinks href=#hl-143-104>104</a>
</span><span class=lnt id=hl-143-105><a class=lnlinks href=#hl-143-105>105</a>
</span><span class=lnt id=hl-143-106><a class=lnlinks href=#hl-143-106>106</a>
</span><span class=lnt id=hl-143-107><a class=lnlinks href=#hl-143-107>107</a>
</span><span class=lnt id=hl-143-108><a class=lnlinks href=#hl-143-108>108</a>
</span><span class=lnt id=hl-143-109><a class=lnlinks href=#hl-143-109>109</a>
</span><span class=lnt id=hl-143-110><a class=lnlinks href=#hl-143-110>110</a>
</span><span class=lnt id=hl-143-111><a class=lnlinks href=#hl-143-111>111</a>
</span><span class=lnt id=hl-143-112><a class=lnlinks href=#hl-143-112>112</a>
</span><span class=lnt id=hl-143-113><a class=lnlinks href=#hl-143-113>113</a>
</span><span class=lnt id=hl-143-114><a class=lnlinks href=#hl-143-114>114</a>
</span><span class=lnt id=hl-143-115><a class=lnlinks href=#hl-143-115>115</a>
</span><span class=lnt id=hl-143-116><a class=lnlinks href=#hl-143-116>116</a>
</span><span class=lnt id=hl-143-117><a class=lnlinks href=#hl-143-117>117</a>
</span><span class=lnt id=hl-143-118><a class=lnlinks href=#hl-143-118>118</a>
</span><span class=lnt id=hl-143-119><a class=lnlinks href=#hl-143-119>119</a>
</span><span class=lnt id=hl-143-120><a class=lnlinks href=#hl-143-120>120</a>
</span><span class=lnt id=hl-143-121><a class=lnlinks href=#hl-143-121>121</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>0</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>1</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>2</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>3</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>4</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>5</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>6</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>7</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>8</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>9</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>10</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>11</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>12</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>13</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>14</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>15</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>16</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>17</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>18</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>19</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>20</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>21</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>22</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>23</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>24</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>25</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>26</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>27</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>28</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t1<span class=o>]</span> - <span class=m>29</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=o>===============</span>&gt; 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>0</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>0</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>0</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>1</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>1</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>1</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>2</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>2</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>2</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>3</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>3</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>3</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>4</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>4</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>4</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>5</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>5</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>5</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>6</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>6</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>6</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>7</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span>
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>7</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>7</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>8</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>8</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>8</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>9</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>9</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>9</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>10</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>10</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>10</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>11</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>11</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>11</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>12</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>12</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>12</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>13</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>13</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>13</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>14</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>14</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>14</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>15</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>15</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>15</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>16</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>16</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>16</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>17</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>17</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>17</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>18</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>18</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00100000</span> <span class=m>01011000</span> <span class=m>11110111</span> <span class=m>00000000</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>18</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000001</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>19</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>19</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>19</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>20</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>20</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>20</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>21</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>21</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>21</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>22</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>22</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>22</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>23</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>23</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>23</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>24</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>24</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>24</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>25</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>25</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>25</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>26</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>26</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>26</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>27</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>27</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>27</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>28</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>28</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>28</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>29</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11100000</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>29</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>t2<span class=o>]</span> - <span class=m>29</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00011111</span> <span class=m>11110011</span> <span class=m>11110001</span> <span class=m>00000101</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=æ‰¹é‡æ’¤é”€><a href=#%e6%89%b9%e9%87%8f%e6%92%a4%e9%94%80 class=header-anchor>#</a>
æ‰¹é‡æ’¤é”€</h5><p>å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 40 æ¬¡åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œè‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ã€‚äºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡ éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-144-1><a class=lnlinks href=#hl-144-1> 1</a>
</span><span class=lnt id=hl-144-2><a class=lnlinks href=#hl-144-2> 2</a>
</span><span class=lnt id=hl-144-3><a class=lnlinks href=#hl-144-3> 3</a>
</span><span class=lnt id=hl-144-4><a class=lnlinks href=#hl-144-4> 4</a>
</span><span class=lnt id=hl-144-5><a class=lnlinks href=#hl-144-5> 5</a>
</span><span class=lnt id=hl-144-6><a class=lnlinks href=#hl-144-6> 6</a>
</span><span class=lnt id=hl-144-7><a class=lnlinks href=#hl-144-7> 7</a>
</span><span class=lnt id=hl-144-8><a class=lnlinks href=#hl-144-8> 8</a>
</span><span class=lnt id=hl-144-9><a class=lnlinks href=#hl-144-9> 9</a>
</span><span class=lnt id=hl-144-10><a class=lnlinks href=#hl-144-10>10</a>
</span><span class=lnt id=hl-144-11><a class=lnlinks href=#hl-144-11>11</a>
</span><span class=lnt id=hl-144-12><a class=lnlinks href=#hl-144-12>12</a>
</span><span class=lnt id=hl-144-13><a class=lnlinks href=#hl-144-13>13</a>
</span><span class=lnt id=hl-144-14><a class=lnlinks href=#hl-144-14>14</a>
</span><span class=lnt id=hl-144-15><a class=lnlinks href=#hl-144-15>15</a>
</span><span class=lnt id=hl-144-16><a class=lnlinks href=#hl-144-16>16</a>
</span><span class=lnt id=hl-144-17><a class=lnlinks href=#hl-144-17>17</a>
</span><span class=lnt id=hl-144-18><a class=lnlinks href=#hl-144-18>18</a>
</span><span class=lnt id=hl-144-19><a class=lnlinks href=#hl-144-19>19</a>
</span><span class=lnt id=hl-144-20><a class=lnlinks href=#hl-144-20>20</a>
</span><span class=lnt id=hl-144-21><a class=lnlinks href=#hl-144-21>21</a>
</span><span class=lnt id=hl-144-22><a class=lnlinks href=#hl-144-22>22</a>
</span><span class=lnt id=hl-144-23><a class=lnlinks href=#hl-144-23>23</a>
</span><span class=lnt id=hl-144-24><a class=lnlinks href=#hl-144-24>24</a>
</span><span class=lnt id=hl-144-25><a class=lnlinks href=#hl-144-25>25</a>
</span><span class=lnt id=hl-144-26><a class=lnlinks href=#hl-144-26>26</a>
</span><span class=lnt id=hl-144-27><a class=lnlinks href=#hl-144-27>27</a>
</span><span class=lnt id=hl-144-28><a class=lnlinks href=#hl-144-28>28</a>
</span><span class=lnt id=hl-144-29><a class=lnlinks href=#hl-144-29>29</a>
</span><span class=lnt id=hl-144-30><a class=lnlinks href=#hl-144-30>30</a>
</span><span class=lnt id=hl-144-31><a class=lnlinks href=#hl-144-31>31</a>
</span><span class=lnt id=hl-144-32><a class=lnlinks href=#hl-144-32>32</a>
</span><span class=lnt id=hl-144-33><a class=lnlinks href=#hl-144-33>33</a>
</span><span class=lnt id=hl-144-34><a class=lnlinks href=#hl-144-34>34</a>
</span><span class=lnt id=hl-144-35><a class=lnlinks href=#hl-144-35>35</a>
</span><span class=lnt id=hl-144-36><a class=lnlinks href=#hl-144-36>36</a>
</span><span class=lnt id=hl-144-37><a class=lnlinks href=#hl-144-37>37</a>
</span><span class=lnt id=hl-144-38><a class=lnlinks href=#hl-144-38>38</a>
</span><span class=lnt id=hl-144-39><a class=lnlinks href=#hl-144-39>39</a>
</span><span class=lnt id=hl-144-40><a class=lnlinks href=#hl-144-40>40</a>
</span><span class=lnt id=hl-144-41><a class=lnlinks href=#hl-144-41>41</a>
</span><span class=lnt id=hl-144-42><a class=lnlinks href=#hl-144-42>42</a>
</span><span class=lnt id=hl-144-43><a class=lnlinks href=#hl-144-43>43</a>
</span><span class=lnt id=hl-144-44><a class=lnlinks href=#hl-144-44>44</a>
</span><span class=lnt id=hl-144-45><a class=lnlinks href=#hl-144-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=p>,</span><span class=n>t2</span><span class=p>,</span><span class=n>t3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test4</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Vector</span><span class=o>&lt;</span><span class=n>Dog</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Vector</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>39</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>d</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>t2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;===============&gt; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>t3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;===============&gt; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Dog</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=n>d</span><span class=p>).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t3</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t3</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ClassLayout</span><span class=p>.</span><span class=na>parseInstance</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Dog</span><span class=p>()).</span><span class=na>toPrintableSimple</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>å‚è€ƒèµ„æ–™</p><p><a class=link href=https://github.com/farmerjohngit/myblog/issues/12 target=_blank rel=noopener>https://github.com/farmerjohngit/myblog/issues/12
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><p><a class=link href=https://www.cnblogs.com/LemonFive/p/11246086.html target=_blank rel=noopener>https://www.cnblogs.com/LemonFive/p/11246086.html
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><p><a class=link href=https://www.cnblogs.com/LemonFive/p/11248248.html target=_blank rel=noopener>https://www.cnblogs.com/LemonFive/p/11248248.html
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><p>[åå‘é”è®ºæ–‡](<a class=link href=https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-149958.pdf target=_blank rel=noopener>Eliminating Synchronization-Related Atomic Operations with Biased Locking and Bulk Rebiasing (oracle.com)
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>)</p></blockquote><h5 id=é”æ¶ˆé™¤><a href=#%e9%94%81%e6%b6%88%e9%99%a4 class=header-anchor>#</a>
é”æ¶ˆé™¤</h5><p>é”æ¶ˆé™¤</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-145-1><a class=lnlinks href=#hl-145-1> 1</a>
</span><span class=lnt id=hl-145-2><a class=lnlinks href=#hl-145-2> 2</a>
</span><span class=lnt id=hl-145-3><a class=lnlinks href=#hl-145-3> 3</a>
</span><span class=lnt id=hl-145-4><a class=lnlinks href=#hl-145-4> 4</a>
</span><span class=lnt id=hl-145-5><a class=lnlinks href=#hl-145-5> 5</a>
</span><span class=lnt id=hl-145-6><a class=lnlinks href=#hl-145-6> 6</a>
</span><span class=lnt id=hl-145-7><a class=lnlinks href=#hl-145-7> 7</a>
</span><span class=lnt id=hl-145-8><a class=lnlinks href=#hl-145-8> 8</a>
</span><span class=lnt id=hl-145-9><a class=lnlinks href=#hl-145-9> 9</a>
</span><span class=lnt id=hl-145-10><a class=lnlinks href=#hl-145-10>10</a>
</span><span class=lnt id=hl-145-11><a class=lnlinks href=#hl-145-11>11</a>
</span><span class=lnt id=hl-145-12><a class=lnlinks href=#hl-145-12>12</a>
</span><span class=lnt id=hl-145-13><a class=lnlinks href=#hl-145-13>13</a>
</span><span class=lnt id=hl-145-14><a class=lnlinks href=#hl-145-14>14</a>
</span><span class=lnt id=hl-145-15><a class=lnlinks href=#hl-145-15>15</a>
</span><span class=lnt id=hl-145-16><a class=lnlinks href=#hl-145-16>16</a>
</span><span class=lnt id=hl-145-17><a class=lnlinks href=#hl-145-17>17</a>
</span><span class=lnt id=hl-145-18><a class=lnlinks href=#hl-145-18>18</a>
</span><span class=lnt id=hl-145-19><a class=lnlinks href=#hl-145-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Fork</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@BenchmarkMode</span><span class=p>(</span><span class=n>Mode</span><span class=p>.</span><span class=na>AverageTime</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Warmup</span><span class=p>(</span><span class=n>iterations</span><span class=o>=</span><span class=n>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Measurement</span><span class=p>(</span><span class=n>iterations</span><span class=o>=</span><span class=n>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@OutputTimeUnit</span><span class=p>(</span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>NANOSECONDS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyBenchmark</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Benchmark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>a</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>x</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Benchmark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>b</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>x</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>java -jar benchmarks.jar</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-146-1><a class=lnlinks href=#hl-146-1>1</a>
</span><span class=lnt id=hl-146-2><a class=lnlinks href=#hl-146-2>2</a>
</span><span class=lnt id=hl-146-3><a class=lnlinks href=#hl-146-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Benchmark 			Mode 		Samples 	Score 		Score error 	Units 
</span></span><span class=line><span class=cl>c.i.MyBenchmark.a 	avgt 		<span class=m>5</span> 			1.542 			0.056 		ns/op 
</span></span><span class=line><span class=cl>c.i.MyBenchmark.b 	avgt 		<span class=m>5</span> 			1.518 			0.091 		ns/op 
</span></span></code></pre></td></tr></table></div></div><p><code>java -XX:-EliminateLocks -jar benchmarks.jar</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-147-1><a class=lnlinks href=#hl-147-1>1</a>
</span><span class=lnt id=hl-147-2><a class=lnlinks href=#hl-147-2>2</a>
</span><span class=lnt id=hl-147-3><a class=lnlinks href=#hl-147-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Benchmark 			Mode 		Samples 		Score 		Score error 	Units 
</span></span><span class=line><span class=cl>c.i.MyBenchmark.a 	avgt 		<span class=m>5</span> 				1.507 		0.108 			ns/op 
</span></span><span class=line><span class=cl>c.i.MyBenchmark.b 	avgt 		<span class=m>5</span> 				16.976 		1.572 			ns/op
</span></span></code></pre></td></tr></table></div></div><p>é”ç²—åŒ–</p><p>å¯¹ç›¸åŒå¯¹è±¡å¤šæ¬¡åŠ é”ï¼Œå¯¼è‡´çº¿ç¨‹å‘ç”Ÿå¤šæ¬¡é‡å…¥ï¼Œå¯ä»¥ä½¿ç”¨é”ç²—åŒ–æ–¹å¼æ¥ä¼˜åŒ–ï¼Œè¿™ä¸åŒäºä¹‹å‰è®²çš„ç»†åˆ†é”çš„ç²’åº¦ã€‚</p><h2 id=47-wait-notify><a href=#47-wait-notify class=header-anchor>#</a>
4.7 wait notify</h2><h4 id=font-colorblue-åŸç†ä¹‹-wait--notifyfont><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-wait--notifyfont class=header-anchor>#</a>
<font color=blue>* åŸç†ä¹‹ wait / notify</font></h4><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317191950175.png width=900 height=600 loading=lazy decoding=async alt=image-20220317191950175 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ul><li>Owner çº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨ wait æ–¹æ³•ï¼Œå³å¯è¿›å…¥ WaitSet å˜ä¸º WAITING çŠ¶æ€</li><li>BLOCKED å’Œ WAITING çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨ CPU æ—¶é—´ç‰‡</li><li>BLOCKED çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’</li><li>WAITING çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹è°ƒç”¨ notify æˆ– notifyAll æ—¶å”¤é†’ï¼Œä½†å”¤é†’åå¹¶ä¸æ„å‘³è€…ç«‹åˆ»è·å¾—é”ï¼Œä»éœ€è¿›å…¥ EntryList é‡æ–°ç«äº‰</li></ul><h4 id=api-ä»‹ç»><a href=#api-%e4%bb%8b%e7%bb%8d class=header-anchor>#</a>
<strong>API ä»‹ç»</strong></h4><ul><li><code>obj.wait()</code> è®©è¿›å…¥ object ç›‘è§†å™¨çš„çº¿ç¨‹åˆ° waitSet ç­‰å¾…</li><li><code>obj.notify()</code> åœ¨ object ä¸Šæ­£åœ¨ waitSet ç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’</li><li><code>obj.notifyAll()</code> è®© object ä¸Šæ­£åœ¨ waitSet ç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’</li></ul><p>å®ƒä»¬éƒ½æ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œåä½œçš„æ‰‹æ®µï¼Œéƒ½å±äº Object å¯¹è±¡çš„æ–¹æ³•ã€‚å¿…é¡»è·å¾—æ­¤å¯¹è±¡çš„é”ï¼Œæ‰èƒ½è°ƒç”¨è¿™å‡ ä¸ªæ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-148-1><a class=lnlinks href=#hl-148-1> 1</a>
</span><span class=lnt id=hl-148-2><a class=lnlinks href=#hl-148-2> 2</a>
</span><span class=lnt id=hl-148-3><a class=lnlinks href=#hl-148-3> 3</a>
</span><span class=lnt id=hl-148-4><a class=lnlinks href=#hl-148-4> 4</a>
</span><span class=lnt id=hl-148-5><a class=lnlinks href=#hl-148-5> 5</a>
</span><span class=lnt id=hl-148-6><a class=lnlinks href=#hl-148-6> 6</a>
</span><span class=lnt id=hl-148-7><a class=lnlinks href=#hl-148-7> 7</a>
</span><span class=lnt id=hl-148-8><a class=lnlinks href=#hl-148-8> 8</a>
</span><span class=lnt id=hl-148-9><a class=lnlinks href=#hl-148-9> 9</a>
</span><span class=lnt id=hl-148-10><a class=lnlinks href=#hl-148-10>10</a>
</span><span class=lnt id=hl-148-11><a class=lnlinks href=#hl-148-11>11</a>
</span><span class=lnt id=hl-148-12><a class=lnlinks href=#hl-148-12>12</a>
</span><span class=lnt id=hl-148-13><a class=lnlinks href=#hl-148-13>13</a>
</span><span class=lnt id=hl-148-14><a class=lnlinks href=#hl-148-14>14</a>
</span><span class=lnt id=hl-148-15><a class=lnlinks href=#hl-148-15>15</a>
</span><span class=lnt id=hl-148-16><a class=lnlinks href=#hl-148-16>16</a>
</span><span class=lnt id=hl-148-17><a class=lnlinks href=#hl-148-17>17</a>
</span><span class=lnt id=hl-148-18><a class=lnlinks href=#hl-148-18>18</a>
</span><span class=lnt id=hl-148-19><a class=lnlinks href=#hl-148-19>19</a>
</span><span class=lnt id=hl-148-20><a class=lnlinks href=#hl-148-20>20</a>
</span><span class=lnt id=hl-148-21><a class=lnlinks href=#hl-148-21>21</a>
</span><span class=lnt id=hl-148-22><a class=lnlinks href=#hl-148-22>22</a>
</span><span class=lnt id=hl-148-23><a class=lnlinks href=#hl-148-23>23</a>
</span><span class=lnt id=hl-148-24><a class=lnlinks href=#hl-148-24>24</a>
</span><span class=lnt id=hl-148-25><a class=lnlinks href=#hl-148-25>25</a>
</span><span class=lnt id=hl-148-26><a class=lnlinks href=#hl-148-26>26</a>
</span><span class=lnt id=hl-148-27><a class=lnlinks href=#hl-148-27>27</a>
</span><span class=lnt id=hl-148-28><a class=lnlinks href=#hl-148-28>28</a>
</span><span class=lnt id=hl-148-29><a class=lnlinks href=#hl-148-29>29</a>
</span><span class=lnt id=hl-148-30><a class=lnlinks href=#hl-148-30>30</a>
</span><span class=lnt id=hl-148-31><a class=lnlinks href=#hl-148-31>31</a>
</span><span class=lnt id=hl-148-32><a class=lnlinks href=#hl-148-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‰§è¡Œ....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>obj</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w> </span><span class=c1>// è®©çº¿ç¨‹åœ¨objä¸Šä¸€ç›´ç­‰å¾…ä¸‹å»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å…¶å®ƒä»£ç ....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‰§è¡Œ....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>obj</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w> </span><span class=c1>// è®©çº¿ç¨‹åœ¨objä¸Šä¸€ç›´ç­‰å¾…ä¸‹å»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å…¶å®ƒä»£ç ....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸»çº¿ç¨‹ä¸¤ç§’åæ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å”¤é†’ obj ä¸Šå…¶å®ƒçº¿ç¨‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>obj</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w> </span><span class=c1>// å”¤é†’objä¸Šä¸€ä¸ªçº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// obj.notifyAll(); // å”¤é†’objä¸Šæ‰€æœ‰ç­‰å¾…çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>notify çš„ä¸€ç§ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-149-1><a class=lnlinks href=#hl-149-1>1</a>
</span><span class=lnt id=hl-149-2><a class=lnlinks href=#hl-149-2>2</a>
</span><span class=lnt id=hl-149-3><a class=lnlinks href=#hl-149-3>3</a>
</span><span class=lnt id=hl-149-4><a class=lnlinks href=#hl-149-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:00:53.096 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestWaitNotify - æ‰§è¡Œ.... 
</span></span><span class=line><span class=cl>20:00:53.099 <span class=o>[</span>Thread-1<span class=o>]</span> c.TestWaitNotify - æ‰§è¡Œ.... 
</span></span><span class=line><span class=cl>20:00:55.096 <span class=o>[</span>main<span class=o>]</span> c.TestWaitNotify - å”¤é†’ obj ä¸Šå…¶å®ƒçº¿ç¨‹
</span></span><span class=line><span class=cl>20:00:55.096 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestWaitNotify - å…¶å®ƒä»£ç .... 
</span></span></code></pre></td></tr></table></div></div><p>notifyAll çš„ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-150-1><a class=lnlinks href=#hl-150-1>1</a>
</span><span class=lnt id=hl-150-2><a class=lnlinks href=#hl-150-2>2</a>
</span><span class=lnt id=hl-150-3><a class=lnlinks href=#hl-150-3>3</a>
</span><span class=lnt id=hl-150-4><a class=lnlinks href=#hl-150-4>4</a>
</span><span class=lnt id=hl-150-5><a class=lnlinks href=#hl-150-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:58:15.457 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestWaitNotify - æ‰§è¡Œ.... 
</span></span><span class=line><span class=cl>19:58:15.460 <span class=o>[</span>Thread-1<span class=o>]</span> c.TestWaitNotify - æ‰§è¡Œ.... 
</span></span><span class=line><span class=cl>19:58:17.456 <span class=o>[</span>main<span class=o>]</span> c.TestWaitNotify - å”¤é†’ obj ä¸Šå…¶å®ƒçº¿ç¨‹
</span></span><span class=line><span class=cl>19:58:17.456 <span class=o>[</span>Thread-1<span class=o>]</span> c.TestWaitNotify - å…¶å®ƒä»£ç .... 
</span></span><span class=line><span class=cl>19:58:17.456 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestWaitNotify - å…¶å®ƒä»£ç .... 
</span></span></code></pre></td></tr></table></div></div><p><code>wait()</code> æ–¹æ³•ä¼šé‡Šæ”¾å¯¹è±¡çš„é”ï¼Œè¿›å…¥ WaitSet ç­‰å¾…åŒºï¼Œä»è€Œè®©å…¶ä»–çº¿ç¨‹å°±æœºä¼šè·å–å¯¹è±¡çš„é”ã€‚æ— é™åˆ¶ç­‰å¾…ï¼Œç›´åˆ° notify ä¸ºæ­¢</p><p><code>wait(long n)</code> æœ‰æ—¶é™çš„ç­‰å¾…, åˆ° n æ¯«ç§’åç»“æŸç­‰å¾…ï¼Œæˆ–æ˜¯è¢« notify</p><h2 id=48-wait-notify-çš„æ­£ç¡®å§¿åŠ¿><a href=#48-wait-notify-%e7%9a%84%e6%ad%a3%e7%a1%ae%e5%a7%bf%e5%8a%bf class=header-anchor>#</a>
4.8 wait notify çš„æ­£ç¡®å§¿åŠ¿</h2><p>å¼€å§‹ä¹‹å‰å…ˆçœ‹çœ‹</p><h4 id=sleeplong-n-å’Œ-waitlong-n-çš„åŒºåˆ«><a href=#sleeplong-n-%e5%92%8c-waitlong-n-%e7%9a%84%e5%8c%ba%e5%88%ab class=header-anchor>#</a>
<code>sleep(long n)</code> å’Œ <code>wait(long n)</code> çš„åŒºåˆ«</h4><ol><li>sleep æ˜¯ Thread æ–¹æ³•ï¼Œè€Œ wait æ˜¯ Object çš„æ–¹æ³•</li><li>sleep ä¸éœ€è¦å¼ºåˆ¶å’Œ synchronized é…åˆä½¿ç”¨ï¼Œä½† wait éœ€è¦ å’Œ synchronized ä¸€èµ·ç”¨</li><li>sleep åœ¨ç¡çœ çš„åŒæ—¶ï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”çš„ï¼Œä½† wait åœ¨ç­‰å¾…çš„æ—¶å€™ä¼šé‡Šæ”¾å¯¹è±¡é”</li><li>å®ƒä»¬ çŠ¶æ€ TIMED_WAITING</li></ol><h4 id=step-1><a href=#step-1 class=header-anchor>#</a>
step 1</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-151-1><a class=lnlinks href=#hl-151-1>1</a>
</span><span class=lnt id=hl-151-2><a class=lnlinks href=#hl-151-2>2</a>
</span><span class=lnt id=hl-151-3><a class=lnlinks href=#hl-151-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>room</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasCigarette</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasTakeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€è€ƒä¸‹é¢çš„è§£å†³æ–¹æ¡ˆå¥½ä¸å¥½ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-152-1><a class=lnlinks href=#hl-152-1> 1</a>
</span><span class=lnt id=hl-152-2><a class=lnlinks href=#hl-152-2> 2</a>
</span><span class=lnt id=hl-152-3><a class=lnlinks href=#hl-152-3> 3</a>
</span><span class=lnt id=hl-152-4><a class=lnlinks href=#hl-152-4> 4</a>
</span><span class=lnt id=hl-152-5><a class=lnlinks href=#hl-152-5> 5</a>
</span><span class=lnt id=hl-152-6><a class=lnlinks href=#hl-152-6> 6</a>
</span><span class=lnt id=hl-152-7><a class=lnlinks href=#hl-152-7> 7</a>
</span><span class=lnt id=hl-152-8><a class=lnlinks href=#hl-152-8> 8</a>
</span><span class=lnt id=hl-152-9><a class=lnlinks href=#hl-152-9> 9</a>
</span><span class=lnt id=hl-152-10><a class=lnlinks href=#hl-152-10>10</a>
</span><span class=lnt id=hl-152-11><a class=lnlinks href=#hl-152-11>11</a>
</span><span class=lnt id=hl-152-12><a class=lnlinks href=#hl-152-12>12</a>
</span><span class=lnt id=hl-152-13><a class=lnlinks href=#hl-152-13>13</a>
</span><span class=lnt id=hl-152-14><a class=lnlinks href=#hl-152-14>14</a>
</span><span class=lnt id=hl-152-15><a class=lnlinks href=#hl-152-15>15</a>
</span><span class=lnt id=hl-152-16><a class=lnlinks href=#hl-152-16>16</a>
</span><span class=lnt id=hl-152-17><a class=lnlinks href=#hl-152-17>17</a>
</span><span class=lnt id=hl-152-18><a class=lnlinks href=#hl-152-18>18</a>
</span><span class=lnt id=hl-152-19><a class=lnlinks href=#hl-152-19>19</a>
</span><span class=lnt id=hl-152-20><a class=lnlinks href=#hl-152-20>20</a>
</span><span class=lnt id=hl-152-21><a class=lnlinks href=#hl-152-21>21</a>
</span><span class=lnt id=hl-152-22><a class=lnlinks href=#hl-152-22>22</a>
</span><span class=lnt id=hl-152-23><a class=lnlinks href=#hl-152-23>23</a>
</span><span class=lnt id=hl-152-24><a class=lnlinks href=#hl-152-24>24</a>
</span><span class=lnt id=hl-152-25><a class=lnlinks href=#hl-152-25>25</a>
</span><span class=lnt id=hl-152-26><a class=lnlinks href=#hl-152-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æœ‰çƒŸæ²¡ï¼Ÿ[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æœ‰çƒŸæ²¡ï¼Ÿ[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¯ä»¥å¼€å§‹å¹²æ´»äº†&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;å°å—&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¯ä»¥å¼€å§‹å¹²æ´»äº†&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;å…¶å®ƒäºº&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿™é‡Œèƒ½ä¸èƒ½åŠ  synchronized (room)ï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hasCigarette</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;çƒŸåˆ°äº†å™¢ï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;é€çƒŸçš„&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-153-1><a class=lnlinks href=#hl-153-1> 1</a>
</span><span class=lnt id=hl-153-2><a class=lnlinks href=#hl-153-2> 2</a>
</span><span class=lnt id=hl-153-3><a class=lnlinks href=#hl-153-3> 3</a>
</span><span class=lnt id=hl-153-4><a class=lnlinks href=#hl-153-4> 4</a>
</span><span class=lnt id=hl-153-5><a class=lnlinks href=#hl-153-5> 5</a>
</span><span class=lnt id=hl-153-6><a class=lnlinks href=#hl-153-6> 6</a>
</span><span class=lnt id=hl-153-7><a class=lnlinks href=#hl-153-7> 7</a>
</span><span class=lnt id=hl-153-8><a class=lnlinks href=#hl-153-8> 8</a>
</span><span class=lnt id=hl-153-9><a class=lnlinks href=#hl-153-9> 9</a>
</span><span class=lnt id=hl-153-10><a class=lnlinks href=#hl-153-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:49:49.883 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:49:49.887 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
</span></span><span class=line><span class=cl>20:49:50.882 <span class=o>[</span>é€çƒŸçš„<span class=o>]</span> c.TestCorrectPosture - çƒŸåˆ°äº†å™¢ï¼
</span></span><span class=line><span class=cl>20:49:51.887 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ<span class=o>[</span>true<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:49:51.887 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†
</span></span><span class=line><span class=cl>20:49:51.887 <span class=o>[</span>å…¶å®ƒäºº<span class=o>]</span> c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†
</span></span><span class=line><span class=cl>20:49:51.887 <span class=o>[</span>å…¶å®ƒäºº<span class=o>]</span> c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†
</span></span><span class=line><span class=cl>20:49:51.888 <span class=o>[</span>å…¶å®ƒäºº<span class=o>]</span> c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†
</span></span><span class=line><span class=cl>20:49:51.888 <span class=o>[</span>å…¶å®ƒäºº<span class=o>]</span> c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†
</span></span><span class=line><span class=cl>20:49:51.888 <span class=o>[</span>å…¶å®ƒäºº<span class=o>]</span> c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†
</span></span></code></pre></td></tr></table></div></div><ul><li>å…¶å®ƒå¹²æ´»çš„çº¿ç¨‹ï¼Œéƒ½è¦ä¸€ç›´é˜»å¡ï¼Œæ•ˆç‡å¤ªä½</li><li>å°å—çº¿ç¨‹å¿…é¡»ç¡è¶³ 2s åæ‰èƒ½é†’æ¥ï¼Œå°±ç®—çƒŸæå‰é€åˆ°ï¼Œä¹Ÿæ— æ³•ç«‹åˆ»é†’æ¥</li><li>åŠ äº† synchronized (room) åï¼Œå°±å¥½æ¯”å°å—åœ¨é‡Œé¢åé”äº†é—¨ç¡è§‰ï¼ŒçƒŸæ ¹æœ¬æ²¡æ³•é€è¿›é—¨ï¼Œmain æ²¡åŠ  synchronized å°±å¥½åƒ main çº¿ç¨‹æ˜¯ç¿»çª—æˆ·è¿›æ¥çš„</li><li>è§£å†³æ–¹æ³•ï¼Œä½¿ç”¨ wait - notify æœºåˆ¶</li></ul><h4 id=step-2><a href=#step-2 class=header-anchor>#</a>
step 2</h4><p>æ€è€ƒä¸‹é¢çš„å®ç°è¡Œå—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-154-1><a class=lnlinks href=#hl-154-1> 1</a>
</span><span class=lnt id=hl-154-2><a class=lnlinks href=#hl-154-2> 2</a>
</span><span class=lnt id=hl-154-3><a class=lnlinks href=#hl-154-3> 3</a>
</span><span class=lnt id=hl-154-4><a class=lnlinks href=#hl-154-4> 4</a>
</span><span class=lnt id=hl-154-5><a class=lnlinks href=#hl-154-5> 5</a>
</span><span class=lnt id=hl-154-6><a class=lnlinks href=#hl-154-6> 6</a>
</span><span class=lnt id=hl-154-7><a class=lnlinks href=#hl-154-7> 7</a>
</span><span class=lnt id=hl-154-8><a class=lnlinks href=#hl-154-8> 8</a>
</span><span class=lnt id=hl-154-9><a class=lnlinks href=#hl-154-9> 9</a>
</span><span class=lnt id=hl-154-10><a class=lnlinks href=#hl-154-10>10</a>
</span><span class=lnt id=hl-154-11><a class=lnlinks href=#hl-154-11>11</a>
</span><span class=lnt id=hl-154-12><a class=lnlinks href=#hl-154-12>12</a>
</span><span class=lnt id=hl-154-13><a class=lnlinks href=#hl-154-13>13</a>
</span><span class=lnt id=hl-154-14><a class=lnlinks href=#hl-154-14>14</a>
</span><span class=lnt id=hl-154-15><a class=lnlinks href=#hl-154-15>15</a>
</span><span class=lnt id=hl-154-16><a class=lnlinks href=#hl-154-16>16</a>
</span><span class=lnt id=hl-154-17><a class=lnlinks href=#hl-154-17>17</a>
</span><span class=lnt id=hl-154-18><a class=lnlinks href=#hl-154-18>18</a>
</span><span class=lnt id=hl-154-19><a class=lnlinks href=#hl-154-19>19</a>
</span><span class=lnt id=hl-154-20><a class=lnlinks href=#hl-154-20>20</a>
</span><span class=lnt id=hl-154-21><a class=lnlinks href=#hl-154-21>21</a>
</span><span class=lnt id=hl-154-22><a class=lnlinks href=#hl-154-22>22</a>
</span><span class=lnt id=hl-154-23><a class=lnlinks href=#hl-154-23>23</a>
</span><span class=lnt id=hl-154-24><a class=lnlinks href=#hl-154-24>24</a>
</span><span class=lnt id=hl-154-25><a class=lnlinks href=#hl-154-25>25</a>
</span><span class=lnt id=hl-154-26><a class=lnlinks href=#hl-154-26>26</a>
</span><span class=lnt id=hl-154-27><a class=lnlinks href=#hl-154-27>27</a>
</span><span class=lnt id=hl-154-28><a class=lnlinks href=#hl-154-28>28</a>
</span><span class=lnt id=hl-154-29><a class=lnlinks href=#hl-154-29>29</a>
</span><span class=lnt id=hl-154-30><a class=lnlinks href=#hl-154-30>30</a>
</span><span class=lnt id=hl-154-31><a class=lnlinks href=#hl-154-31>31</a>
</span><span class=lnt id=hl-154-32><a class=lnlinks href=#hl-154-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æœ‰çƒŸæ²¡ï¼Ÿ[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>room</span><span class=p>.</span><span class=na>wait</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æœ‰çƒŸæ²¡ï¼Ÿ[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¯ä»¥å¼€å§‹å¹²æ´»äº†&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;å°å—&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¯ä»¥å¼€å§‹å¹²æ´»äº†&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;å…¶å®ƒäºº&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hasCigarette</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;çƒŸåˆ°äº†å™¢ï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>room</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;é€çƒŸçš„&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>è§£å†³äº†å…¶å®ƒå¹²æ´»çš„çº¿ç¨‹é˜»å¡çš„é—®é¢˜</li><li>ä½†å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…æ¡ä»¶å‘¢ï¼Ÿ</li></ul><h4 id=step-3><a href=#step-3 class=header-anchor>#</a>
step 3</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-155-1><a class=lnlinks href=#hl-155-1> 1</a>
</span><span class=lnt id=hl-155-2><a class=lnlinks href=#hl-155-2> 2</a>
</span><span class=lnt id=hl-155-3><a class=lnlinks href=#hl-155-3> 3</a>
</span><span class=lnt id=hl-155-4><a class=lnlinks href=#hl-155-4> 4</a>
</span><span class=lnt id=hl-155-5><a class=lnlinks href=#hl-155-5> 5</a>
</span><span class=lnt id=hl-155-6><a class=lnlinks href=#hl-155-6> 6</a>
</span><span class=lnt id=hl-155-7><a class=lnlinks href=#hl-155-7> 7</a>
</span><span class=lnt id=hl-155-8><a class=lnlinks href=#hl-155-8> 8</a>
</span><span class=lnt id=hl-155-9><a class=lnlinks href=#hl-155-9> 9</a>
</span><span class=lnt id=hl-155-10><a class=lnlinks href=#hl-155-10>10</a>
</span><span class=lnt id=hl-155-11><a class=lnlinks href=#hl-155-11>11</a>
</span><span class=lnt id=hl-155-12><a class=lnlinks href=#hl-155-12>12</a>
</span><span class=lnt id=hl-155-13><a class=lnlinks href=#hl-155-13>13</a>
</span><span class=lnt id=hl-155-14><a class=lnlinks href=#hl-155-14>14</a>
</span><span class=lnt id=hl-155-15><a class=lnlinks href=#hl-155-15>15</a>
</span><span class=lnt id=hl-155-16><a class=lnlinks href=#hl-155-16>16</a>
</span><span class=lnt id=hl-155-17><a class=lnlinks href=#hl-155-17>17</a>
</span><span class=lnt id=hl-155-18><a class=lnlinks href=#hl-155-18>18</a>
</span><span class=lnt id=hl-155-19><a class=lnlinks href=#hl-155-19>19</a>
</span><span class=lnt id=hl-155-20><a class=lnlinks href=#hl-155-20>20</a>
</span><span class=lnt id=hl-155-21><a class=lnlinks href=#hl-155-21>21</a>
</span><span class=lnt id=hl-155-22><a class=lnlinks href=#hl-155-22>22</a>
</span><span class=lnt id=hl-155-23><a class=lnlinks href=#hl-155-23>23</a>
</span><span class=lnt id=hl-155-24><a class=lnlinks href=#hl-155-24>24</a>
</span><span class=lnt id=hl-155-25><a class=lnlinks href=#hl-155-25>25</a>
</span><span class=lnt id=hl-155-26><a class=lnlinks href=#hl-155-26>26</a>
</span><span class=lnt id=hl-155-27><a class=lnlinks href=#hl-155-27>27</a>
</span><span class=lnt id=hl-155-28><a class=lnlinks href=#hl-155-28>28</a>
</span><span class=lnt id=hl-155-29><a class=lnlinks href=#hl-155-29>29</a>
</span><span class=lnt id=hl-155-30><a class=lnlinks href=#hl-155-30>30</a>
</span><span class=lnt id=hl-155-31><a class=lnlinks href=#hl-155-31>31</a>
</span><span class=lnt id=hl-155-32><a class=lnlinks href=#hl-155-32>32</a>
</span><span class=lnt id=hl-155-33><a class=lnlinks href=#hl-155-33>33</a>
</span><span class=lnt id=hl-155-34><a class=lnlinks href=#hl-155-34>34</a>
</span><span class=lnt id=hl-155-35><a class=lnlinks href=#hl-155-35>35</a>
</span><span class=lnt id=hl-155-36><a class=lnlinks href=#hl-155-36>36</a>
</span><span class=lnt id=hl-155-37><a class=lnlinks href=#hl-155-37>37</a>
</span><span class=lnt id=hl-155-38><a class=lnlinks href=#hl-155-38>38</a>
</span><span class=lnt id=hl-155-39><a class=lnlinks href=#hl-155-39>39</a>
</span><span class=lnt id=hl-155-40><a class=lnlinks href=#hl-155-40>40</a>
</span><span class=lnt id=hl-155-41><a class=lnlinks href=#hl-155-41>41</a>
</span><span class=lnt id=hl-155-42><a class=lnlinks href=#hl-155-42>42</a>
</span><span class=lnt id=hl-155-43><a class=lnlinks href=#hl-155-43>43</a>
</span><span class=lnt id=hl-155-44><a class=lnlinks href=#hl-155-44>44</a>
</span><span class=lnt id=hl-155-45><a class=lnlinks href=#hl-155-45>45</a>
</span><span class=lnt id=hl-155-46><a class=lnlinks href=#hl-155-46>46</a>
</span><span class=lnt id=hl-155-47><a class=lnlinks href=#hl-155-47>47</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æœ‰çƒŸæ²¡ï¼Ÿ[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>room</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æœ‰çƒŸæ²¡ï¼Ÿ[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasCigarette</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¯ä»¥å¼€å§‹å¹²æ´»äº†&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ²¡å¹²æˆæ´»...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;å°å—&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasTakeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasTakeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>room</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasTakeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasTakeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¯ä»¥å¼€å§‹å¹²æ´»äº†&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ²¡å¹²æˆæ´»...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;å°å¥³&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hasTakeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¤–å–åˆ°äº†å™¢ï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>room</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;é€å¤–å–çš„&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-156-1><a class=lnlinks href=#hl-156-1>1</a>
</span><span class=lnt id=hl-156-2><a class=lnlinks href=#hl-156-2>2</a>
</span><span class=lnt id=hl-156-3><a class=lnlinks href=#hl-156-3>3</a>
</span><span class=lnt id=hl-156-4><a class=lnlinks href=#hl-156-4>4</a>
</span><span class=lnt id=hl-156-5><a class=lnlinks href=#hl-156-5>5</a>
</span><span class=lnt id=hl-156-6><a class=lnlinks href=#hl-156-6>6</a>
</span><span class=lnt id=hl-156-7><a class=lnlinks href=#hl-156-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:53:12.173 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:53:12.176 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
</span></span><span class=line><span class=cl>20:53:12.176 <span class=o>[</span>å°å¥³<span class=o>]</span> c.TestCorrectPosture - å¤–å–é€åˆ°æ²¡ï¼Ÿ<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:53:12.176 <span class=o>[</span>å°å¥³<span class=o>]</span> c.TestCorrectPosture - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼
</span></span><span class=line><span class=cl>20:53:13.174 <span class=o>[</span>é€å¤–å–çš„<span class=o>]</span> c.TestCorrectPosture - å¤–å–åˆ°äº†å™¢ï¼
</span></span><span class=line><span class=cl>20:53:13.174 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:53:13.174 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æ²¡å¹²æˆæ´»... 
</span></span></code></pre></td></tr></table></div></div><ul><li>notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ª WaitSet ä¸­çš„çº¿ç¨‹ï¼Œè¿™æ—¶å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå°±å¯èƒ½å”¤é†’ä¸äº†æ­£ç¡®çš„çº¿ ç¨‹ï¼Œç§°ä¹‹ä¸ºã€è™šå‡å”¤é†’ã€‘</li><li>è§£å†³æ–¹æ³•ï¼Œæ”¹ä¸º notifyAll</li></ul><h4 id=step-4><a href=#step-4 class=header-anchor>#</a>
step 4</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-157-1><a class=lnlinks href=#hl-157-1>1</a>
</span><span class=lnt id=hl-157-2><a class=lnlinks href=#hl-157-2>2</a>
</span><span class=lnt id=hl-157-3><a class=lnlinks href=#hl-157-3>3</a>
</span><span class=lnt id=hl-157-4><a class=lnlinks href=#hl-157-4>4</a>
</span><span class=lnt id=hl-157-5><a class=lnlinks href=#hl-157-5>5</a>
</span><span class=lnt id=hl-157-6><a class=lnlinks href=#hl-157-6>6</a>
</span><span class=lnt id=hl-157-7><a class=lnlinks href=#hl-157-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>room</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hasTakeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¤–å–åˆ°äº†å™¢ï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>room</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;é€å¤–å–çš„&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-158-1><a class=lnlinks href=#hl-158-1>1</a>
</span><span class=lnt id=hl-158-2><a class=lnlinks href=#hl-158-2>2</a>
</span><span class=lnt id=hl-158-3><a class=lnlinks href=#hl-158-3>3</a>
</span><span class=lnt id=hl-158-4><a class=lnlinks href=#hl-158-4>4</a>
</span><span class=lnt id=hl-158-5><a class=lnlinks href=#hl-158-5>5</a>
</span><span class=lnt id=hl-158-6><a class=lnlinks href=#hl-158-6>6</a>
</span><span class=lnt id=hl-158-7><a class=lnlinks href=#hl-158-7>7</a>
</span><span class=lnt id=hl-158-8><a class=lnlinks href=#hl-158-8>8</a>
</span><span class=lnt id=hl-158-9><a class=lnlinks href=#hl-158-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:55:23.978 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:55:23.982 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
</span></span><span class=line><span class=cl>20:55:23.982 <span class=o>[</span>å°å¥³<span class=o>]</span> c.TestCorrectPosture - å¤–å–é€åˆ°æ²¡ï¼Ÿ<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:55:23.982 <span class=o>[</span>å°å¥³<span class=o>]</span> c.TestCorrectPosture - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼
</span></span><span class=line><span class=cl>20:55:24.979 <span class=o>[</span>é€å¤–å–çš„<span class=o>]</span> c.TestCorrectPosture - å¤–å–åˆ°äº†å™¢ï¼
</span></span><span class=line><span class=cl>20:55:24.979 <span class=o>[</span>å°å¥³<span class=o>]</span> c.TestCorrectPosture - å¤–å–é€åˆ°æ²¡ï¼Ÿ<span class=o>[</span>true<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:55:24.980 <span class=o>[</span>å°å¥³<span class=o>]</span> c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†
</span></span><span class=line><span class=cl>20:55:24.980 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:55:24.980 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æ²¡å¹²æˆæ´»... 
</span></span></code></pre></td></tr></table></div></div><ul><li>ç”¨ notifyAll ä»…è§£å†³æŸä¸ªçº¿ç¨‹çš„å”¤é†’é—®é¢˜ï¼Œä½†ä½¿ç”¨ if + wait åˆ¤æ–­ä»…æœ‰ä¸€æ¬¡æœºä¼šï¼Œä¸€æ—¦æ¡ä»¶ä¸æˆç«‹ï¼Œå°±æ²¡æœ‰é‡æ–°åˆ¤æ–­çš„æœºä¼šäº†</li><li>è§£å†³æ–¹æ³•ï¼Œç”¨ while + waitï¼Œå½“æ¡ä»¶ä¸æˆç«‹ï¼Œå†æ¬¡ wait</li></ul><h4 id=step-5><a href=#step-5 class=header-anchor>#</a>
step 5</h4><p>å°† if æ”¹ä¸º while</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-159-1><a class=lnlinks href=#hl-159-1>1</a>
</span><span class=lnt id=hl-159-2><a class=lnlinks href=#hl-159-2>2</a>
</span><span class=lnt id=hl-159-3><a class=lnlinks href=#hl-159-3>3</a>
</span><span class=lnt id=hl-159-4><a class=lnlinks href=#hl-159-4>4</a>
</span><span class=lnt id=hl-159-5><a class=lnlinks href=#hl-159-5>5</a>
</span><span class=lnt id=hl-159-6><a class=lnlinks href=#hl-159-6>6</a>
</span><span class=lnt id=hl-159-7><a class=lnlinks href=#hl-159-7>7</a>
</span><span class=lnt id=hl-159-8><a class=lnlinks href=#hl-159-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>room</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ”¹åŠ¨å</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-160-1><a class=lnlinks href=#hl-160-1>1</a>
</span><span class=lnt id=hl-160-2><a class=lnlinks href=#hl-160-2>2</a>
</span><span class=lnt id=hl-160-3><a class=lnlinks href=#hl-160-3>3</a>
</span><span class=lnt id=hl-160-4><a class=lnlinks href=#hl-160-4>4</a>
</span><span class=lnt id=hl-160-5><a class=lnlinks href=#hl-160-5>5</a>
</span><span class=lnt id=hl-160-6><a class=lnlinks href=#hl-160-6>6</a>
</span><span class=lnt id=hl-160-7><a class=lnlinks href=#hl-160-7>7</a>
</span><span class=lnt id=hl-160-8><a class=lnlinks href=#hl-160-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigarette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>room</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-161-1><a class=lnlinks href=#hl-161-1>1</a>
</span><span class=lnt id=hl-161-2><a class=lnlinks href=#hl-161-2>2</a>
</span><span class=lnt id=hl-161-3><a class=lnlinks href=#hl-161-3>3</a>
</span><span class=lnt id=hl-161-4><a class=lnlinks href=#hl-161-4>4</a>
</span><span class=lnt id=hl-161-5><a class=lnlinks href=#hl-161-5>5</a>
</span><span class=lnt id=hl-161-6><a class=lnlinks href=#hl-161-6>6</a>
</span><span class=lnt id=hl-161-7><a class=lnlinks href=#hl-161-7>7</a>
</span><span class=lnt id=hl-161-8><a class=lnlinks href=#hl-161-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:58:34.322 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æœ‰çƒŸæ²¡ï¼Ÿ<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:58:34.326 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
</span></span><span class=line><span class=cl>20:58:34.326 <span class=o>[</span>å°å¥³<span class=o>]</span> c.TestCorrectPosture - å¤–å–é€åˆ°æ²¡ï¼Ÿ<span class=o>[</span>false<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:58:34.326 <span class=o>[</span>å°å¥³<span class=o>]</span> c.TestCorrectPosture - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼
</span></span><span class=line><span class=cl>20:58:35.323 <span class=o>[</span>é€å¤–å–çš„<span class=o>]</span> c.TestCorrectPosture - å¤–å–åˆ°äº†å™¢ï¼
</span></span><span class=line><span class=cl>20:58:35.324 <span class=o>[</span>å°å¥³<span class=o>]</span> c.TestCorrectPosture - å¤–å–é€åˆ°æ²¡ï¼Ÿ<span class=o>[</span>true<span class=o>]</span> 
</span></span><span class=line><span class=cl>20:58:35.324 <span class=o>[</span>å°å¥³<span class=o>]</span> c.TestCorrectPosture - å¯ä»¥å¼€å§‹å¹²æ´»äº†
</span></span><span class=line><span class=cl>20:58:35.324 <span class=o>[</span>å°å—<span class=o>]</span> c.TestCorrectPosture - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-162-1><a class=lnlinks href=#hl-162-1> 1</a>
</span><span class=lnt id=hl-162-2><a class=lnlinks href=#hl-162-2> 2</a>
</span><span class=lnt id=hl-162-3><a class=lnlinks href=#hl-162-3> 3</a>
</span><span class=lnt id=hl-162-4><a class=lnlinks href=#hl-162-4> 4</a>
</span><span class=lnt id=hl-162-5><a class=lnlinks href=#hl-162-5> 5</a>
</span><span class=lnt id=hl-162-6><a class=lnlinks href=#hl-162-6> 6</a>
</span><span class=lnt id=hl-162-7><a class=lnlinks href=#hl-162-7> 7</a>
</span><span class=lnt id=hl-162-8><a class=lnlinks href=#hl-162-8> 8</a>
</span><span class=lnt id=hl-162-9><a class=lnlinks href=#hl-162-9> 9</a>
</span><span class=lnt id=hl-162-10><a class=lnlinks href=#hl-162-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>synchronized</span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>æ¡ä»¶ä¸æˆç«‹</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¹²æ´»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//å¦ä¸€ä¸ªçº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>synchronized</span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=textcolororangeæ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ><a href=#textcolororange%e6%a8%a1%e5%bc%8f%e4%b9%8b%e4%bf%9d%e6%8a%a4%e6%80%a7%e6%9a%82%e5%81%9c class=header-anchor>#</a>
$\textcolor{orange}{*æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ}$</h4><h5 id=1å®šä¹‰><a href=#1%e5%ae%9a%e4%b9%89 class=header-anchor>#</a>
<strong>1.å®šä¹‰</strong></h5><p>å³ Guarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ</p><p>è¦ç‚¹</p><ul><li>æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©ä»–ä»¬å…³è”åŒä¸€ä¸ª GuardedObject</li><li>å¦‚æœæœ‰ç»“æœä¸æ–­ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰</li><li>JDK ä¸­ï¼Œjoin çš„å®ç°ã€Future çš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼</li><li>å› ä¸ºè¦ç­‰å¾…å¦ä¸€æ–¹çš„ç»“æœï¼Œå› æ­¤å½’ç±»åˆ°åŒæ­¥æ¨¡å¼</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304134602353.png width=900 height=600 loading=lazy decoding=async alt=image-20220304134602353 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=2å®ç°><a href=#2%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
<strong>2.å®ç°</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-163-1><a class=lnlinks href=#hl-163-1> 1</a>
</span><span class=lnt id=hl-163-2><a class=lnlinks href=#hl-163-2> 2</a>
</span><span class=lnt id=hl-163-3><a class=lnlinks href=#hl-163-3> 3</a>
</span><span class=lnt id=hl-163-4><a class=lnlinks href=#hl-163-4> 4</a>
</span><span class=lnt id=hl-163-5><a class=lnlinks href=#hl-163-5> 5</a>
</span><span class=lnt id=hl-163-6><a class=lnlinks href=#hl-163-6> 6</a>
</span><span class=lnt id=hl-163-7><a class=lnlinks href=#hl-163-7> 7</a>
</span><span class=lnt id=hl-163-8><a class=lnlinks href=#hl-163-8> 8</a>
</span><span class=lnt id=hl-163-9><a class=lnlinks href=#hl-163-9> 9</a>
</span><span class=lnt id=hl-163-10><a class=lnlinks href=#hl-163-10>10</a>
</span><span class=lnt id=hl-163-11><a class=lnlinks href=#hl-163-11>11</a>
</span><span class=lnt id=hl-163-12><a class=lnlinks href=#hl-163-12>12</a>
</span><span class=lnt id=hl-163-13><a class=lnlinks href=#hl-163-13>13</a>
</span><span class=lnt id=hl-163-14><a class=lnlinks href=#hl-163-14>14</a>
</span><span class=lnt id=hl-163-15><a class=lnlinks href=#hl-163-15>15</a>
</span><span class=lnt id=hl-163-16><a class=lnlinks href=#hl-163-16>16</a>
</span><span class=lnt id=hl-163-17><a class=lnlinks href=#hl-163-17>17</a>
</span><span class=lnt id=hl-163-18><a class=lnlinks href=#hl-163-18>18</a>
</span><span class=lnt id=hl-163-19><a class=lnlinks href=#hl-163-19>19</a>
</span><span class=lnt id=hl-163-20><a class=lnlinks href=#hl-163-20>20</a>
</span><span class=lnt id=hl-163-21><a class=lnlinks href=#hl-163-21>21</a>
</span><span class=lnt id=hl-163-22><a class=lnlinks href=#hl-163-22>22</a>
</span><span class=lnt id=hl-163-23><a class=lnlinks href=#hl-163-23>23</a>
</span><span class=lnt id=hl-163-24><a class=lnlinks href=#hl-163-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>GuardedObject</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æ¡ä»¶ä¸æ»¡è¶³åˆ™ç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>complete</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æ¡ä»¶æ»¡è¶³ï¼Œé€šçŸ¥ç­‰å¾…çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•</p><p>ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-164-1><a class=lnlinks href=#hl-164-1> 1</a>
</span><span class=lnt id=hl-164-2><a class=lnlinks href=#hl-164-2> 2</a>
</span><span class=lnt id=hl-164-3><a class=lnlinks href=#hl-164-3> 3</a>
</span><span class=lnt id=hl-164-4><a class=lnlinks href=#hl-164-4> 4</a>
</span><span class=lnt id=hl-164-5><a class=lnlinks href=#hl-164-5> 5</a>
</span><span class=lnt id=hl-164-6><a class=lnlinks href=#hl-164-6> 6</a>
</span><span class=lnt id=hl-164-7><a class=lnlinks href=#hl-164-7> 7</a>
</span><span class=lnt id=hl-164-8><a class=lnlinks href=#hl-164-8> 8</a>
</span><span class=lnt id=hl-164-9><a class=lnlinks href=#hl-164-9> 9</a>
</span><span class=lnt id=hl-164-10><a class=lnlinks href=#hl-164-10>10</a>
</span><span class=lnt id=hl-164-11><a class=lnlinks href=#hl-164-11>11</a>
</span><span class=lnt id=hl-164-12><a class=lnlinks href=#hl-164-12>12</a>
</span><span class=lnt id=hl-164-13><a class=lnlinks href=#hl-164-13>13</a>
</span><span class=lnt id=hl-164-14><a class=lnlinks href=#hl-164-14>14</a>
</span><span class=lnt id=hl-164-15><a class=lnlinks href=#hl-164-15>15</a>
</span><span class=lnt id=hl-164-16><a class=lnlinks href=#hl-164-16>16</a>
</span><span class=lnt id=hl-164-17><a class=lnlinks href=#hl-164-17>17</a>
</span><span class=lnt id=hl-164-18><a class=lnlinks href=#hl-164-18>18</a>
</span><span class=lnt id=hl-164-19><a class=lnlinks href=#hl-164-19>19</a>
</span><span class=lnt id=hl-164-20><a class=lnlinks href=#hl-164-20>20</a>
</span><span class=lnt id=hl-164-21><a class=lnlinks href=#hl-164-21>21</a>
</span><span class=lnt id=hl-164-22><a class=lnlinks href=#hl-164-22>22</a>
</span><span class=lnt id=hl-164-23><a class=lnlinks href=#hl-164-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GuardedObject</span><span class=w> </span><span class=n>guardedObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MailBoxes</span><span class=p>.</span><span class=na>getGuardedObject</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;é€ä¿¡æˆåŠŸ,id={},å†…å®¹ï¼š{}&#34;</span><span class=p>,</span><span class=n>id</span><span class=p>,</span><span class=n>mail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GuardedObject</span><span class=w> </span><span class=n>guardedObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GuardedObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å­çº¿ç¨‹æ‰§è¡Œä¸‹è½½</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>download</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;download complete...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>complete</span><span class=p>(</span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;waiting...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;get response: [{}] lines&#34;</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>response</span><span class=p>).</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-165-1><a class=lnlinks href=#hl-165-1>1</a>
</span><span class=lnt id=hl-165-2><a class=lnlinks href=#hl-165-2>2</a>
</span><span class=lnt id=hl-165-3><a class=lnlinks href=#hl-165-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>08:42:18.568 <span class=o>[</span>main<span class=o>]</span> c.TestGuardedObject - waiting...
</span></span><span class=line><span class=cl>08:42:23.312 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestGuardedObject - download complete...
</span></span><span class=line><span class=cl>08:42:23.312 <span class=o>[</span>main<span class=o>]</span> c.TestGuardedObject - get response: <span class=o>[</span>3<span class=o>]</span> lines
</span></span></code></pre></td></tr></table></div></div><h5 id=3å¸¦è¶…æ—¶ç‰ˆ-guardedobject><a href=#3%e5%b8%a6%e8%b6%85%e6%97%b6%e7%89%88-guardedobject class=header-anchor>#</a>
<strong>3.å¸¦è¶…æ—¶ç‰ˆ GuardedObject</strong></h5><p>å¦‚æœè¦æ§åˆ¶è¶…æ—¶æ—¶é—´å‘¢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-166-1><a class=lnlinks href=#hl-166-1> 1</a>
</span><span class=lnt id=hl-166-2><a class=lnlinks href=#hl-166-2> 2</a>
</span><span class=lnt id=hl-166-3><a class=lnlinks href=#hl-166-3> 3</a>
</span><span class=lnt id=hl-166-4><a class=lnlinks href=#hl-166-4> 4</a>
</span><span class=lnt id=hl-166-5><a class=lnlinks href=#hl-166-5> 5</a>
</span><span class=lnt id=hl-166-6><a class=lnlinks href=#hl-166-6> 6</a>
</span><span class=lnt id=hl-166-7><a class=lnlinks href=#hl-166-7> 7</a>
</span><span class=lnt id=hl-166-8><a class=lnlinks href=#hl-166-8> 8</a>
</span><span class=lnt id=hl-166-9><a class=lnlinks href=#hl-166-9> 9</a>
</span><span class=lnt id=hl-166-10><a class=lnlinks href=#hl-166-10>10</a>
</span><span class=lnt id=hl-166-11><a class=lnlinks href=#hl-166-11>11</a>
</span><span class=lnt id=hl-166-12><a class=lnlinks href=#hl-166-12>12</a>
</span><span class=lnt id=hl-166-13><a class=lnlinks href=#hl-166-13>13</a>
</span><span class=lnt id=hl-166-14><a class=lnlinks href=#hl-166-14>14</a>
</span><span class=lnt id=hl-166-15><a class=lnlinks href=#hl-166-15>15</a>
</span><span class=lnt id=hl-166-16><a class=lnlinks href=#hl-166-16>16</a>
</span><span class=lnt id=hl-166-17><a class=lnlinks href=#hl-166-17>17</a>
</span><span class=lnt id=hl-166-18><a class=lnlinks href=#hl-166-18>18</a>
</span><span class=lnt id=hl-166-19><a class=lnlinks href=#hl-166-19>19</a>
</span><span class=lnt id=hl-166-20><a class=lnlinks href=#hl-166-20>20</a>
</span><span class=lnt id=hl-166-21><a class=lnlinks href=#hl-166-21>21</a>
</span><span class=lnt id=hl-166-22><a class=lnlinks href=#hl-166-22>22</a>
</span><span class=lnt id=hl-166-23><a class=lnlinks href=#hl-166-23>23</a>
</span><span class=lnt id=hl-166-24><a class=lnlinks href=#hl-166-24>24</a>
</span><span class=lnt id=hl-166-25><a class=lnlinks href=#hl-166-25>25</a>
</span><span class=lnt id=hl-166-26><a class=lnlinks href=#hl-166-26>26</a>
</span><span class=lnt id=hl-166-27><a class=lnlinks href=#hl-166-27>27</a>
</span><span class=lnt id=hl-166-28><a class=lnlinks href=#hl-166-28>28</a>
</span><span class=lnt id=hl-166-29><a class=lnlinks href=#hl-166-29>29</a>
</span><span class=lnt id=hl-166-30><a class=lnlinks href=#hl-166-30>30</a>
</span><span class=lnt id=hl-166-31><a class=lnlinks href=#hl-166-31>31</a>
</span><span class=lnt id=hl-166-32><a class=lnlinks href=#hl-166-32>32</a>
</span><span class=lnt id=hl-166-33><a class=lnlinks href=#hl-166-33>33</a>
</span><span class=lnt id=hl-166-34><a class=lnlinks href=#hl-166-34>34</a>
</span><span class=lnt id=hl-166-35><a class=lnlinks href=#hl-166-35>35</a>
</span><span class=lnt id=hl-166-36><a class=lnlinks href=#hl-166-36>36</a>
</span><span class=lnt id=hl-166-37><a class=lnlinks href=#hl-166-37>37</a>
</span><span class=lnt id=hl-166-38><a class=lnlinks href=#hl-166-38>38</a>
</span><span class=lnt id=hl-166-39><a class=lnlinks href=#hl-166-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>GuardedObjectV2</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>millis</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 1) è®°å½•æœ€åˆæ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>begin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// 2) å·²ç»ç»å†çš„æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>timePassed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// 4) å‡è®¾ millis æ˜¯ 1000ï¼Œç»“æœåœ¨ 400 æ—¶å”¤é†’äº†ï¼Œé‚£ä¹ˆè¿˜æœ‰ 600 è¦ç­‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>waitTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>millis</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>timePassed</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;waitTime: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>waitTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>waitTime</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;break...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>lock</span><span class=p>.</span><span class=na>wait</span><span class=p>(</span><span class=n>waitTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// 3) å¦‚æœæå‰è¢«å”¤é†’ï¼Œè¿™æ—¶å·²ç»ç»å†çš„æ—¶é—´å‡è®¾ä¸º 400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>timePassed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;timePassed: {}, object is null {}&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>timePassed</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>complete</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// æ¡ä»¶æ»¡è¶³ï¼Œé€šçŸ¥ç­‰å¾…çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;notify...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•ï¼Œæ²¡æœ‰è¶…æ—¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-167-1><a class=lnlinks href=#hl-167-1> 1</a>
</span><span class=lnt id=hl-167-2><a class=lnlinks href=#hl-167-2> 2</a>
</span><span class=lnt id=hl-167-3><a class=lnlinks href=#hl-167-3> 3</a>
</span><span class=lnt id=hl-167-4><a class=lnlinks href=#hl-167-4> 4</a>
</span><span class=lnt id=hl-167-5><a class=lnlinks href=#hl-167-5> 5</a>
</span><span class=lnt id=hl-167-6><a class=lnlinks href=#hl-167-6> 6</a>
</span><span class=lnt id=hl-167-7><a class=lnlinks href=#hl-167-7> 7</a>
</span><span class=lnt id=hl-167-8><a class=lnlinks href=#hl-167-8> 8</a>
</span><span class=lnt id=hl-167-9><a class=lnlinks href=#hl-167-9> 9</a>
</span><span class=lnt id=hl-167-10><a class=lnlinks href=#hl-167-10>10</a>
</span><span class=lnt id=hl-167-11><a class=lnlinks href=#hl-167-11>11</a>
</span><span class=lnt id=hl-167-12><a class=lnlinks href=#hl-167-12>12</a>
</span><span class=lnt id=hl-167-13><a class=lnlinks href=#hl-167-13>13</a>
</span><span class=lnt id=hl-167-14><a class=lnlinks href=#hl-167-14>14</a>
</span><span class=lnt id=hl-167-15><a class=lnlinks href=#hl-167-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GuardedObjectV2</span><span class=w> </span><span class=n>v2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GuardedObjectV2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>v2</span><span class=p>.</span><span class=na>complete</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>v2</span><span class=p>.</span><span class=na>complete</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;b&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;c&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v2</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>2500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;get response: [{}] lines&#34;</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>response</span><span class=p>).</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;can&#39;t get response&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-168-1><a class=lnlinks href=#hl-168-1>1</a>
</span><span class=lnt id=hl-168-2><a class=lnlinks href=#hl-168-2>2</a>
</span><span class=lnt id=hl-168-3><a class=lnlinks href=#hl-168-3>3</a>
</span><span class=lnt id=hl-168-4><a class=lnlinks href=#hl-168-4>4</a>
</span><span class=lnt id=hl-168-5><a class=lnlinks href=#hl-168-5>5</a>
</span><span class=lnt id=hl-168-6><a class=lnlinks href=#hl-168-6>6</a>
</span><span class=lnt id=hl-168-7><a class=lnlinks href=#hl-168-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>08:49:39.917 <span class=o>[</span>main<span class=o>]</span> c.GuardedObjectV2 - waitTime: <span class=m>2500</span>
</span></span><span class=line><span class=cl>08:49:40.917 <span class=o>[</span>Thread-0<span class=o>]</span> c.GuardedObjectV2 - notify...
</span></span><span class=line><span class=cl>08:49:40.917 <span class=o>[</span>main<span class=o>]</span> c.GuardedObjectV2 - timePassed: 1003, object is null <span class=nb>true</span>
</span></span><span class=line><span class=cl>08:49:40.917 <span class=o>[</span>main<span class=o>]</span> c.GuardedObjectV2 - waitTime: <span class=m>1497</span>
</span></span><span class=line><span class=cl>08:49:41.918 <span class=o>[</span>Thread-0<span class=o>]</span> c.GuardedObjectV2 - notify...
</span></span><span class=line><span class=cl>08:49:41.918 <span class=o>[</span>main<span class=o>]</span> c.GuardedObjectV2 - timePassed: 2004, object is null <span class=nb>false</span>
</span></span><span class=line><span class=cl>08:49:41.918 <span class=o>[</span>main<span class=o>]</span> c.TestGuardedObjectV2 - get response: <span class=o>[</span>3<span class=o>]</span> lines
</span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•è¶…æ—¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-169-1><a class=lnlinks href=#hl-169-1>1</a>
</span><span class=lnt id=hl-169-2><a class=lnlinks href=#hl-169-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ç­‰å¾…æ—¶é—´ä¸è¶³</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>lines</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v2</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>1500</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-170-1><a class=lnlinks href=#hl-170-1>1</a>
</span><span class=lnt id=hl-170-2><a class=lnlinks href=#hl-170-2>2</a>
</span><span class=lnt id=hl-170-3><a class=lnlinks href=#hl-170-3>3</a>
</span><span class=lnt id=hl-170-4><a class=lnlinks href=#hl-170-4>4</a>
</span><span class=lnt id=hl-170-5><a class=lnlinks href=#hl-170-5>5</a>
</span><span class=lnt id=hl-170-6><a class=lnlinks href=#hl-170-6>6</a>
</span><span class=lnt id=hl-170-7><a class=lnlinks href=#hl-170-7>7</a>
</span><span class=lnt id=hl-170-8><a class=lnlinks href=#hl-170-8>8</a>
</span><span class=lnt id=hl-170-9><a class=lnlinks href=#hl-170-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>54</span><span class=p>.</span><span class=na>963</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>waitTime</span><span class=p>:</span><span class=w> </span><span class=n>1500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>55</span><span class=p>.</span><span class=na>963</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>notify</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>55</span><span class=p>.</span><span class=na>963</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>timePassed</span><span class=p>:</span><span class=w> </span><span class=n>1002</span><span class=p>,</span><span class=w> </span><span class=n>object</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>55</span><span class=p>.</span><span class=na>963</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>waitTime</span><span class=p>:</span><span class=w> </span><span class=n>498</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>56</span><span class=p>.</span><span class=na>461</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>timePassed</span><span class=p>:</span><span class=w> </span><span class=n>1500</span><span class=p>,</span><span class=w> </span><span class=n>object</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>56</span><span class=p>.</span><span class=na>461</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>waitTime</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>56</span><span class=p>.</span><span class=na>461</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>break</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>56</span><span class=p>.</span><span class=na>461</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestGuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>can</span><span class=err>&#39;</span><span class=n>t</span><span class=w> </span><span class=n>get</span><span class=w> </span><span class=n>response</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>08</span><span class=p>:</span><span class=n>47</span><span class=p>:</span><span class=n>56</span><span class=p>.</span><span class=na>963</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>GuardedObjectV2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>notify</span><span class=p>...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=textcolorblue-åŸç†ä¹‹-join><a href=#textcolorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-join class=header-anchor>#</a>
$\textcolor{blue}{* åŸç†ä¹‹ join}$</h5><p>æ˜¯è°ƒç”¨è€…è½®è¯¢æ£€æŸ¥çº¿ç¨‹ alive çŠ¶æ€</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-171-1><a class=lnlinks href=#hl-171-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç­‰ä»·äºä¸‹é¢çš„ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-172-1><a class=lnlinks href=#hl-172-1>1</a>
</span><span class=lnt id=hl-172-2><a class=lnlinks href=#hl-172-2>2</a>
</span><span class=lnt id=hl-172-3><a class=lnlinks href=#hl-172-3>3</a>
</span><span class=lnt id=hl-172-4><a class=lnlinks href=#hl-172-4>4</a>
</span><span class=lnt id=hl-172-5><a class=lnlinks href=#hl-172-5>5</a>
</span><span class=lnt id=hl-172-6><a class=lnlinks href=#hl-172-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>t1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è°ƒç”¨è€…çº¿ç¨‹è¿›å…¥ t1 çš„ waitSet ç­‰å¾…, ç›´åˆ° t1 è¿è¡Œç»“æŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>t1</span><span class=p>.</span><span class=na>isAlive</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>wait</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong></p><p>join ä½“ç°çš„æ˜¯ã€ä¿æŠ¤æ€§æš‚åœã€‘æ¨¡å¼ï¼Œè¯·å‚è€ƒä¹‹</p></blockquote><p>æºç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-173-1><a class=lnlinks href=#hl-173-1> 1</a>
</span><span class=lnt id=hl-173-2><a class=lnlinks href=#hl-173-2> 2</a>
</span><span class=lnt id=hl-173-3><a class=lnlinks href=#hl-173-3> 3</a>
</span><span class=lnt id=hl-173-4><a class=lnlinks href=#hl-173-4> 4</a>
</span><span class=lnt id=hl-173-5><a class=lnlinks href=#hl-173-5> 5</a>
</span><span class=lnt id=hl-173-6><a class=lnlinks href=#hl-173-6> 6</a>
</span><span class=lnt id=hl-173-7><a class=lnlinks href=#hl-173-7> 7</a>
</span><span class=lnt id=hl-173-8><a class=lnlinks href=#hl-173-8> 8</a>
</span><span class=lnt id=hl-173-9><a class=lnlinks href=#hl-173-9> 9</a>
</span><span class=lnt id=hl-173-10><a class=lnlinks href=#hl-173-10>10</a>
</span><span class=lnt id=hl-173-11><a class=lnlinks href=#hl-173-11>11</a>
</span><span class=lnt id=hl-173-12><a class=lnlinks href=#hl-173-12>12</a>
</span><span class=lnt id=hl-173-13><a class=lnlinks href=#hl-173-13>13</a>
</span><span class=lnt id=hl-173-14><a class=lnlinks href=#hl-173-14>14</a>
</span><span class=lnt id=hl-173-15><a class=lnlinks href=#hl-173-15>15</a>
</span><span class=lnt id=hl-173-16><a class=lnlinks href=#hl-173-16>16</a>
</span><span class=lnt id=hl-173-17><a class=lnlinks href=#hl-173-17>17</a>
</span><span class=lnt id=hl-173-18><a class=lnlinks href=#hl-173-18>18</a>
</span><span class=lnt id=hl-173-19><a class=lnlinks href=#hl-173-19>19</a>
</span><span class=lnt id=hl-173-20><a class=lnlinks href=#hl-173-20>20</a>
</span><span class=lnt id=hl-173-21><a class=lnlinks href=#hl-173-21>21</a>
</span><span class=lnt id=hl-173-22><a class=lnlinks href=#hl-173-22>22</a>
</span><span class=lnt id=hl-173-23><a class=lnlinks href=#hl-173-23>23</a>
</span><span class=lnt id=hl-173-24><a class=lnlinks href=#hl-173-24>24</a>
</span><span class=lnt id=hl-173-25><a class=lnlinks href=#hl-173-25>25</a>
</span><span class=lnt id=hl-173-26><a class=lnlinks href=#hl-173-26>26</a>
</span><span class=lnt id=hl-173-27><a class=lnlinks href=#hl-173-27>27</a>
</span><span class=lnt id=hl-173-28><a class=lnlinks href=#hl-173-28>28</a>
</span><span class=lnt id=hl-173-29><a class=lnlinks href=#hl-173-29>29</a>
</span><span class=lnt id=hl-173-30><a class=lnlinks href=#hl-173-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//ä¸å¸¦å‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>join</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>join</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//å¸¦å‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//ç­‰å¾…æ—¶é•¿çš„å®ç°ç±»ä¼¼äºä¹‹å‰çš„ä¿æŠ¤æ€§æš‚åœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>join</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>millis</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>base</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>millis</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;timeout value is negative&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>millis</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isAlive</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>wait</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isAlive</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>millis</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>now</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>delay</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>wait</span><span class=p>(</span><span class=n>delay</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>base</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=4å¤šä»»åŠ¡ç‰ˆguardedobject><a href=#4%e5%a4%9a%e4%bb%bb%e5%8a%a1%e7%89%88guardedobject class=header-anchor>#</a>
<strong>4.å¤šä»»åŠ¡ç‰ˆ</strong>GuardedObject</h5><p>å›¾ä¸­ Futures å°±å¥½æ¯”å±…æ°‘æ¥¼ä¸€å±‚çš„ä¿¡ç®±ï¼ˆæ¯ä¸ªä¿¡ç®±æœ‰æˆ¿é—´ç¼–å·ï¼‰ï¼Œå·¦ä¾§çš„ t0ï¼Œt2ï¼Œt4 å°±å¥½æ¯”ç­‰å¾…é‚®ä»¶çš„å±…æ°‘ï¼Œå³ ä¾§çš„ t1ï¼Œt3ï¼Œt5 å°±å¥½æ¯”é‚®é€’å‘˜ ã€‚</p><p>å¦‚æœéœ€è¦åœ¨å¤šä¸ªç±»ä¹‹é—´ä½¿ç”¨ GuardedObject å¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œå› æ­¤è®¾è®¡ä¸€ä¸ªç”¨æ¥è§£è€¦çš„ä¸­é—´ç±»ï¼Œ è¿™æ ·ä¸ä»…èƒ½å¤Ÿè§£è€¦ã€ç»“æœç­‰å¾…è€…ã€‘å’Œã€ç»“æœç”Ÿäº§è€…ã€‘ï¼Œè¿˜èƒ½å¤ŸåŒæ—¶æ”¯æŒå¤šä¸ªä»»åŠ¡çš„ç®¡ç†ã€‚</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304141821782.png width=900 height=600 loading=lazy decoding=async alt=image-20220304141821782 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æ–°å¢ id ç”¨æ¥æ ‡è¯† Guarded Object</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-174-1><a class=lnlinks href=#hl-174-1> 1</a>
</span><span class=lnt id=hl-174-2><a class=lnlinks href=#hl-174-2> 2</a>
</span><span class=lnt id=hl-174-3><a class=lnlinks href=#hl-174-3> 3</a>
</span><span class=lnt id=hl-174-4><a class=lnlinks href=#hl-174-4> 4</a>
</span><span class=lnt id=hl-174-5><a class=lnlinks href=#hl-174-5> 5</a>
</span><span class=lnt id=hl-174-6><a class=lnlinks href=#hl-174-6> 6</a>
</span><span class=lnt id=hl-174-7><a class=lnlinks href=#hl-174-7> 7</a>
</span><span class=lnt id=hl-174-8><a class=lnlinks href=#hl-174-8> 8</a>
</span><span class=lnt id=hl-174-9><a class=lnlinks href=#hl-174-9> 9</a>
</span><span class=lnt id=hl-174-10><a class=lnlinks href=#hl-174-10>10</a>
</span><span class=lnt id=hl-174-11><a class=lnlinks href=#hl-174-11>11</a>
</span><span class=lnt id=hl-174-12><a class=lnlinks href=#hl-174-12>12</a>
</span><span class=lnt id=hl-174-13><a class=lnlinks href=#hl-174-13>13</a>
</span><span class=lnt id=hl-174-14><a class=lnlinks href=#hl-174-14>14</a>
</span><span class=lnt id=hl-174-15><a class=lnlinks href=#hl-174-15>15</a>
</span><span class=lnt id=hl-174-16><a class=lnlinks href=#hl-174-16>16</a>
</span><span class=lnt id=hl-174-17><a class=lnlinks href=#hl-174-17>17</a>
</span><span class=lnt id=hl-174-18><a class=lnlinks href=#hl-174-18>18</a>
</span><span class=lnt id=hl-174-19><a class=lnlinks href=#hl-174-19>19</a>
</span><span class=lnt id=hl-174-20><a class=lnlinks href=#hl-174-20>20</a>
</span><span class=lnt id=hl-174-21><a class=lnlinks href=#hl-174-21>21</a>
</span><span class=lnt id=hl-174-22><a class=lnlinks href=#hl-174-22>22</a>
</span><span class=lnt id=hl-174-23><a class=lnlinks href=#hl-174-23>23</a>
</span><span class=lnt id=hl-174-24><a class=lnlinks href=#hl-174-24>24</a>
</span><span class=lnt id=hl-174-25><a class=lnlinks href=#hl-174-25>25</a>
</span><span class=lnt id=hl-174-26><a class=lnlinks href=#hl-174-26>26</a>
</span><span class=lnt id=hl-174-27><a class=lnlinks href=#hl-174-27>27</a>
</span><span class=lnt id=hl-174-28><a class=lnlinks href=#hl-174-28>28</a>
</span><span class=lnt id=hl-174-29><a class=lnlinks href=#hl-174-29>29</a>
</span><span class=lnt id=hl-174-30><a class=lnlinks href=#hl-174-30>30</a>
</span><span class=lnt id=hl-174-31><a class=lnlinks href=#hl-174-31>31</a>
</span><span class=lnt id=hl-174-32><a class=lnlinks href=#hl-174-32>32</a>
</span><span class=lnt id=hl-174-33><a class=lnlinks href=#hl-174-33>33</a>
</span><span class=lnt id=hl-174-34><a class=lnlinks href=#hl-174-34>34</a>
</span><span class=lnt id=hl-174-35><a class=lnlinks href=#hl-174-35>35</a>
</span><span class=lnt id=hl-174-36><a class=lnlinks href=#hl-174-36>36</a>
</span><span class=lnt id=hl-174-37><a class=lnlinks href=#hl-174-37>37</a>
</span><span class=lnt id=hl-174-38><a class=lnlinks href=#hl-174-38>38</a>
</span><span class=lnt id=hl-174-39><a class=lnlinks href=#hl-174-39>39</a>
</span><span class=lnt id=hl-174-40><a class=lnlinks href=#hl-174-40>40</a>
</span><span class=lnt id=hl-174-41><a class=lnlinks href=#hl-174-41>41</a>
</span><span class=lnt id=hl-174-42><a class=lnlinks href=#hl-174-42>42</a>
</span><span class=lnt id=hl-174-43><a class=lnlinks href=#hl-174-43>43</a>
</span><span class=lnt id=hl-174-44><a class=lnlinks href=#hl-174-44>44</a>
</span><span class=lnt id=hl-174-45><a class=lnlinks href=#hl-174-45>45</a>
</span><span class=lnt id=hl-174-46><a class=lnlinks href=#hl-174-46>46</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>GuardedObject</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ ‡è¯† Guarded Object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>GuardedObject</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–ç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// timeout è¡¨ç¤ºè¦ç­‰å¾…å¤šä¹… 2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¼€å§‹æ—¶é—´ 15:00:00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>begin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ç»å†çš„æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>passedTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è¿™ä¸€è½®å¾ªç¯åº”è¯¥ç­‰å¾…çš„æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>waitTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeout</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>passedTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ç»å†çš„æ—¶é—´è¶…è¿‡äº†æœ€å¤§ç­‰å¾…æ—¶é—´æ—¶ï¼Œé€€å‡ºå¾ªç¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>timeout</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>passedTime</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>this</span><span class=p>.</span><span class=na>wait</span><span class=p>(</span><span class=n>waitTime</span><span class=p>);</span><span class=w> </span><span class=c1>// è™šå‡å”¤é†’ 15:00:01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ±‚å¾—ç»å†æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>passedTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w> </span><span class=c1>// 15:00:02 1s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// äº§ç”Ÿç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>complete</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ç»™ç»“æœæˆå‘˜å˜é‡èµ‹å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸­é—´è§£è€¦ç±»</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-175-1><a class=lnlinks href=#hl-175-1> 1</a>
</span><span class=lnt id=hl-175-2><a class=lnlinks href=#hl-175-2> 2</a>
</span><span class=lnt id=hl-175-3><a class=lnlinks href=#hl-175-3> 3</a>
</span><span class=lnt id=hl-175-4><a class=lnlinks href=#hl-175-4> 4</a>
</span><span class=lnt id=hl-175-5><a class=lnlinks href=#hl-175-5> 5</a>
</span><span class=lnt id=hl-175-6><a class=lnlinks href=#hl-175-6> 6</a>
</span><span class=lnt id=hl-175-7><a class=lnlinks href=#hl-175-7> 7</a>
</span><span class=lnt id=hl-175-8><a class=lnlinks href=#hl-175-8> 8</a>
</span><span class=lnt id=hl-175-9><a class=lnlinks href=#hl-175-9> 9</a>
</span><span class=lnt id=hl-175-10><a class=lnlinks href=#hl-175-10>10</a>
</span><span class=lnt id=hl-175-11><a class=lnlinks href=#hl-175-11>11</a>
</span><span class=lnt id=hl-175-12><a class=lnlinks href=#hl-175-12>12</a>
</span><span class=lnt id=hl-175-13><a class=lnlinks href=#hl-175-13>13</a>
</span><span class=lnt id=hl-175-14><a class=lnlinks href=#hl-175-14>14</a>
</span><span class=lnt id=hl-175-15><a class=lnlinks href=#hl-175-15>15</a>
</span><span class=lnt id=hl-175-16><a class=lnlinks href=#hl-175-16>16</a>
</span><span class=lnt id=hl-175-17><a class=lnlinks href=#hl-175-17>17</a>
</span><span class=lnt id=hl-175-18><a class=lnlinks href=#hl-175-18>18</a>
</span><span class=lnt id=hl-175-19><a class=lnlinks href=#hl-175-19>19</a>
</span><span class=lnt id=hl-175-20><a class=lnlinks href=#hl-175-20>20</a>
</span><span class=lnt id=hl-175-21><a class=lnlinks href=#hl-175-21>21</a>
</span><span class=lnt id=hl-175-22><a class=lnlinks href=#hl-175-22>22</a>
</span><span class=lnt id=hl-175-23><a class=lnlinks href=#hl-175-23>23</a>
</span><span class=lnt id=hl-175-24><a class=lnlinks href=#hl-175-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Mailboxes</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>GuardedObject</span><span class=o>&gt;</span><span class=w> </span><span class=n>boxes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hashtable</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// äº§ç”Ÿå”¯ä¸€ idï¼Œæ–¹æ³•å¿…é¡»å£°æ˜ä¸ºsynchronized</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>generateId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>id</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>GuardedObject</span><span class=w> </span><span class=nf>getGuardedObject</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>boxes</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>GuardedObject</span><span class=w> </span><span class=nf>createGuardedObject</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GuardedObject</span><span class=w> </span><span class=n>go</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GuardedObject</span><span class=p>(</span><span class=n>generateId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>boxes</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>go</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>go</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>go</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getIds</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>boxes</span><span class=p>.</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸šåŠ¡ç›¸å…³ç±»</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-176-1><a class=lnlinks href=#hl-176-1> 1</a>
</span><span class=lnt id=hl-176-2><a class=lnlinks href=#hl-176-2> 2</a>
</span><span class=lnt id=hl-176-3><a class=lnlinks href=#hl-176-3> 3</a>
</span><span class=lnt id=hl-176-4><a class=lnlinks href=#hl-176-4> 4</a>
</span><span class=lnt id=hl-176-5><a class=lnlinks href=#hl-176-5> 5</a>
</span><span class=lnt id=hl-176-6><a class=lnlinks href=#hl-176-6> 6</a>
</span><span class=lnt id=hl-176-7><a class=lnlinks href=#hl-176-7> 7</a>
</span><span class=lnt id=hl-176-8><a class=lnlinks href=#hl-176-8> 8</a>
</span><span class=lnt id=hl-176-9><a class=lnlinks href=#hl-176-9> 9</a>
</span><span class=lnt id=hl-176-10><a class=lnlinks href=#hl-176-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>People</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Thread</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ”¶ä¿¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GuardedObject</span><span class=w> </span><span class=n>guardedObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mailboxes</span><span class=p>.</span><span class=na>createGuardedObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¼€å§‹æ”¶ä¿¡ id:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>mail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>5000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ”¶åˆ°ä¿¡ id:{}, å†…å®¹:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>mail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-177-1><a class=lnlinks href=#hl-177-1> 1</a>
</span><span class=lnt id=hl-177-2><a class=lnlinks href=#hl-177-2> 2</a>
</span><span class=lnt id=hl-177-3><a class=lnlinks href=#hl-177-3> 3</a>
</span><span class=lnt id=hl-177-4><a class=lnlinks href=#hl-177-4> 4</a>
</span><span class=lnt id=hl-177-5><a class=lnlinks href=#hl-177-5> 5</a>
</span><span class=lnt id=hl-177-6><a class=lnlinks href=#hl-177-6> 6</a>
</span><span class=lnt id=hl-177-7><a class=lnlinks href=#hl-177-7> 7</a>
</span><span class=lnt id=hl-177-8><a class=lnlinks href=#hl-177-8> 8</a>
</span><span class=lnt id=hl-177-9><a class=lnlinks href=#hl-177-9> 9</a>
</span><span class=lnt id=hl-177-10><a class=lnlinks href=#hl-177-10>10</a>
</span><span class=lnt id=hl-177-11><a class=lnlinks href=#hl-177-11>11</a>
</span><span class=lnt id=hl-177-12><a class=lnlinks href=#hl-177-12>12</a>
</span><span class=lnt id=hl-177-13><a class=lnlinks href=#hl-177-13>13</a>
</span><span class=lnt id=hl-177-14><a class=lnlinks href=#hl-177-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Postman</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>mail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Postman</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>mail</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>mail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GuardedObject</span><span class=w> </span><span class=n>guardedObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mailboxes</span><span class=p>.</span><span class=na>getGuardedObject</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;é€ä¿¡ id:{}, å†…å®¹:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>mail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>guardedObject</span><span class=p>.</span><span class=na>complete</span><span class=p>(</span><span class=n>mail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-178-1><a class=lnlinks href=#hl-178-1>1</a>
</span><span class=lnt id=hl-178-2><a class=lnlinks href=#hl-178-2>2</a>
</span><span class=lnt id=hl-178-3><a class=lnlinks href=#hl-178-3>3</a>
</span><span class=lnt id=hl-178-4><a class=lnlinks href=#hl-178-4>4</a>
</span><span class=lnt id=hl-178-5><a class=lnlinks href=#hl-178-5>5</a>
</span><span class=lnt id=hl-178-6><a class=lnlinks href=#hl-178-6>6</a>
</span><span class=lnt id=hl-178-7><a class=lnlinks href=#hl-178-7>7</a>
</span><span class=lnt id=hl-178-8><a class=lnlinks href=#hl-178-8>8</a>
</span><span class=lnt id=hl-178-9><a class=lnlinks href=#hl-178-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>People</span><span class=p>().</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Mailboxes</span><span class=p>.</span><span class=na>getIds</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Postman</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=s>&#34;å†…å®¹&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>id</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æŸæ¬¡è¿è¡Œç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-179-1><a class=lnlinks href=#hl-179-1>1</a>
</span><span class=lnt id=hl-179-2><a class=lnlinks href=#hl-179-2>2</a>
</span><span class=lnt id=hl-179-3><a class=lnlinks href=#hl-179-3>3</a>
</span><span class=lnt id=hl-179-4><a class=lnlinks href=#hl-179-4>4</a>
</span><span class=lnt id=hl-179-5><a class=lnlinks href=#hl-179-5>5</a>
</span><span class=lnt id=hl-179-6><a class=lnlinks href=#hl-179-6>6</a>
</span><span class=lnt id=hl-179-7><a class=lnlinks href=#hl-179-7>7</a>
</span><span class=lnt id=hl-179-8><a class=lnlinks href=#hl-179-8>8</a>
</span><span class=lnt id=hl-179-9><a class=lnlinks href=#hl-179-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>05</span><span class=p>.</span><span class=na>689</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>å¼€å§‹æ”¶ä¿¡</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>05</span><span class=p>.</span><span class=na>689</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>å¼€å§‹æ”¶ä¿¡</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>05</span><span class=p>.</span><span class=na>689</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>å¼€å§‹æ”¶ä¿¡</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>688</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>Postman</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>4</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>é€ä¿¡</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>å†…å®¹</span><span class=p>:</span><span class=n>å†…å®¹2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>688</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>Postman</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>5</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>é€ä¿¡</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>å†…å®¹</span><span class=p>:</span><span class=n>å†…å®¹1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>688</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>æ”¶åˆ°ä¿¡</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>å†…å®¹</span><span class=p>:</span><span class=n>å†…å®¹2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>688</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>æ”¶åˆ°ä¿¡</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>å†…å®¹</span><span class=p>:</span><span class=n>å†…å®¹1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>688</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>Postman</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>3</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>é€ä¿¡</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>å†…å®¹</span><span class=p>:</span><span class=n>å†…å®¹3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>10</span><span class=p>:</span><span class=n>35</span><span class=p>:</span><span class=n>06</span><span class=p>.</span><span class=na>689</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>People</span><span class=w> </span><span class=o>[</span><span class=n>Thread</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>æ”¶åˆ°ä¿¡</span><span class=w> </span><span class=n>id</span><span class=p>:</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>å†…å®¹</span><span class=p>:</span><span class=n>å†…å®¹3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=textcolororange-æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…><a href=#textcolororange-%e6%a8%a1%e5%bc%8f%e4%b9%8b%e7%94%9f%e4%ba%a7%e8%80%85%e6%b6%88%e8%b4%b9%e8%80%85 class=header-anchor>#</a>
$\textcolor{orange}{* æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…}$</h4><h5 id=1å®šä¹‰-1><a href=#1%e5%ae%9a%e4%b9%89-1 class=header-anchor>#</a>
1.å®šä¹‰</h5><p>è¦ç‚¹</p><ul><li>ä¸å‰é¢çš„ä¿æŠ¤æ€§æš‚åœä¸­çš„ GuardObject ä¸åŒï¼Œä¸éœ€è¦äº§ç”Ÿç»“æœå’Œæ¶ˆè´¹ç»“æœçš„çº¿ç¨‹ä¸€ä¸€å¯¹åº”</li><li>æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥ç”¨æ¥å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„çº¿ç¨‹èµ„æº</li><li>ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸å…³å¿ƒæ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®</li><li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡é™åˆ¶çš„ï¼Œæ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®</li><li>JDK ä¸­å„ç§é˜»å¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304142831627.png width=900 height=600 loading=lazy decoding=async alt=image-20220304142831627 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=2å®ç°-1><a href=#2%e5%ae%9e%e7%8e%b0-1 class=header-anchor>#</a>
2.å®ç°</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-180-1><a class=lnlinks href=#hl-180-1> 1</a>
</span><span class=lnt id=hl-180-2><a class=lnlinks href=#hl-180-2> 2</a>
</span><span class=lnt id=hl-180-3><a class=lnlinks href=#hl-180-3> 3</a>
</span><span class=lnt id=hl-180-4><a class=lnlinks href=#hl-180-4> 4</a>
</span><span class=lnt id=hl-180-5><a class=lnlinks href=#hl-180-5> 5</a>
</span><span class=lnt id=hl-180-6><a class=lnlinks href=#hl-180-6> 6</a>
</span><span class=lnt id=hl-180-7><a class=lnlinks href=#hl-180-7> 7</a>
</span><span class=lnt id=hl-180-8><a class=lnlinks href=#hl-180-8> 8</a>
</span><span class=lnt id=hl-180-9><a class=lnlinks href=#hl-180-9> 9</a>
</span><span class=lnt id=hl-180-10><a class=lnlinks href=#hl-180-10>10</a>
</span><span class=lnt id=hl-180-11><a class=lnlinks href=#hl-180-11>11</a>
</span><span class=lnt id=hl-180-12><a class=lnlinks href=#hl-180-12>12</a>
</span><span class=lnt id=hl-180-13><a class=lnlinks href=#hl-180-13>13</a>
</span><span class=lnt id=hl-180-14><a class=lnlinks href=#hl-180-14>14</a>
</span><span class=lnt id=hl-180-15><a class=lnlinks href=#hl-180-15>15</a>
</span><span class=lnt id=hl-180-16><a class=lnlinks href=#hl-180-16>16</a>
</span><span class=lnt id=hl-180-17><a class=lnlinks href=#hl-180-17>17</a>
</span><span class=lnt id=hl-180-18><a class=lnlinks href=#hl-180-18>18</a>
</span><span class=lnt id=hl-180-19><a class=lnlinks href=#hl-180-19>19</a>
</span><span class=lnt id=hl-180-20><a class=lnlinks href=#hl-180-20>20</a>
</span><span class=lnt id=hl-180-21><a class=lnlinks href=#hl-180-21>21</a>
</span><span class=lnt id=hl-180-22><a class=lnlinks href=#hl-180-22>22</a>
</span><span class=lnt id=hl-180-23><a class=lnlinks href=#hl-180-23>23</a>
</span><span class=lnt id=hl-180-24><a class=lnlinks href=#hl-180-24>24</a>
</span><span class=lnt id=hl-180-25><a class=lnlinks href=#hl-180-25>25</a>
</span><span class=lnt id=hl-180-26><a class=lnlinks href=#hl-180-26>26</a>
</span><span class=lnt id=hl-180-27><a class=lnlinks href=#hl-180-27>27</a>
</span><span class=lnt id=hl-180-28><a class=lnlinks href=#hl-180-28>28</a>
</span><span class=lnt id=hl-180-29><a class=lnlinks href=#hl-180-29>29</a>
</span><span class=lnt id=hl-180-30><a class=lnlinks href=#hl-180-30>30</a>
</span><span class=lnt id=hl-180-31><a class=lnlinks href=#hl-180-31>31</a>
</span><span class=lnt id=hl-180-32><a class=lnlinks href=#hl-180-32>32</a>
</span><span class=lnt id=hl-180-33><a class=lnlinks href=#hl-180-33>33</a>
</span><span class=lnt id=hl-180-34><a class=lnlinks href=#hl-180-34>34</a>
</span><span class=lnt id=hl-180-35><a class=lnlinks href=#hl-180-35>35</a>
</span><span class=lnt id=hl-180-36><a class=lnlinks href=#hl-180-36>36</a>
</span><span class=lnt id=hl-180-37><a class=lnlinks href=#hl-180-37>37</a>
</span><span class=lnt id=hl-180-38><a class=lnlinks href=#hl-180-38>38</a>
</span><span class=lnt id=hl-180-39><a class=lnlinks href=#hl-180-39>39</a>
</span><span class=lnt id=hl-180-40><a class=lnlinks href=#hl-180-40>40</a>
</span><span class=lnt id=hl-180-41><a class=lnlinks href=#hl-180-41>41</a>
</span><span class=lnt id=hl-180-42><a class=lnlinks href=#hl-180-42>42</a>
</span><span class=lnt id=hl-180-43><a class=lnlinks href=#hl-180-43>43</a>
</span><span class=lnt id=hl-180-44><a class=lnlinks href=#hl-180-44>44</a>
</span><span class=lnt id=hl-180-45><a class=lnlinks href=#hl-180-45>45</a>
</span><span class=lnt id=hl-180-46><a class=lnlinks href=#hl-180-46>46</a>
</span><span class=lnt id=hl-180-47><a class=lnlinks href=#hl-180-47>47</a>
</span><span class=lnt id=hl-180-48><a class=lnlinks href=#hl-180-48>48</a>
</span><span class=lnt id=hl-180-49><a class=lnlinks href=#hl-180-49>49</a>
</span><span class=lnt id=hl-180-50><a class=lnlinks href=#hl-180-50>50</a>
</span><span class=lnt id=hl-180-51><a class=lnlinks href=#hl-180-51>51</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Message</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Message</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getMessage</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>MessageQueue</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>Message</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MessageQueue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>capacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Message</span><span class=w> </span><span class=nf>take</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ²¡è´§äº†, wait&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>queue</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Message</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>removeFirst</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>Message</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;åº“å­˜å·²è¾¾ä¸Šé™, wait&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>queue</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-181-1><a class=lnlinks href=#hl-181-1> 1</a>
</span><span class=lnt id=hl-181-2><a class=lnlinks href=#hl-181-2> 2</a>
</span><span class=lnt id=hl-181-3><a class=lnlinks href=#hl-181-3> 3</a>
</span><span class=lnt id=hl-181-4><a class=lnlinks href=#hl-181-4> 4</a>
</span><span class=lnt id=hl-181-5><a class=lnlinks href=#hl-181-5> 5</a>
</span><span class=lnt id=hl-181-6><a class=lnlinks href=#hl-181-6> 6</a>
</span><span class=lnt id=hl-181-7><a class=lnlinks href=#hl-181-7> 7</a>
</span><span class=lnt id=hl-181-8><a class=lnlinks href=#hl-181-8> 8</a>
</span><span class=lnt id=hl-181-9><a class=lnlinks href=#hl-181-9> 9</a>
</span><span class=lnt id=hl-181-10><a class=lnlinks href=#hl-181-10>10</a>
</span><span class=lnt id=hl-181-11><a class=lnlinks href=#hl-181-11>11</a>
</span><span class=lnt id=hl-181-12><a class=lnlinks href=#hl-181-12>12</a>
</span><span class=lnt id=hl-181-13><a class=lnlinks href=#hl-181-13>13</a>
</span><span class=lnt id=hl-181-14><a class=lnlinks href=#hl-181-14>14</a>
</span><span class=lnt id=hl-181-15><a class=lnlinks href=#hl-181-15>15</a>
</span><span class=lnt id=hl-181-16><a class=lnlinks href=#hl-181-16>16</a>
</span><span class=lnt id=hl-181-17><a class=lnlinks href=#hl-181-17>17</a>
</span><span class=lnt id=hl-181-18><a class=lnlinks href=#hl-181-18>18</a>
</span><span class=lnt id=hl-181-19><a class=lnlinks href=#hl-181-19>19</a>
</span><span class=lnt id=hl-181-20><a class=lnlinks href=#hl-181-20>20</a>
</span><span class=lnt id=hl-181-21><a class=lnlinks href=#hl-181-21>21</a>
</span><span class=lnt id=hl-181-22><a class=lnlinks href=#hl-181-22>22</a>
</span><span class=lnt id=hl-181-23><a class=lnlinks href=#hl-181-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>MessageQueue</span><span class=w> </span><span class=n>messageQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MessageQueue</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 4 ä¸ªç”Ÿäº§è€…çº¿ç¨‹, ä¸‹è½½ä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>4</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;download...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Downloader</span><span class=p>.</span><span class=na>download</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;try put message({})&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>messageQueue</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Message</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;ç”Ÿäº§è€…&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 1 ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹, å¤„ç†ç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Message</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>messageQueue</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getMessage</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;take message({}): [{}] lines&#34;</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;æ¶ˆè´¹è€…&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æŸæ¬¡è¿è¡Œç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-182-1><a class=lnlinks href=#hl-182-1> 1</a>
</span><span class=lnt id=hl-182-2><a class=lnlinks href=#hl-182-2> 2</a>
</span><span class=lnt id=hl-182-3><a class=lnlinks href=#hl-182-3> 3</a>
</span><span class=lnt id=hl-182-4><a class=lnlinks href=#hl-182-4> 4</a>
</span><span class=lnt id=hl-182-5><a class=lnlinks href=#hl-182-5> 5</a>
</span><span class=lnt id=hl-182-6><a class=lnlinks href=#hl-182-6> 6</a>
</span><span class=lnt id=hl-182-7><a class=lnlinks href=#hl-182-7> 7</a>
</span><span class=lnt id=hl-182-8><a class=lnlinks href=#hl-182-8> 8</a>
</span><span class=lnt id=hl-182-9><a class=lnlinks href=#hl-182-9> 9</a>
</span><span class=lnt id=hl-182-10><a class=lnlinks href=#hl-182-10>10</a>
</span><span class=lnt id=hl-182-11><a class=lnlinks href=#hl-182-11>11</a>
</span><span class=lnt id=hl-182-12><a class=lnlinks href=#hl-182-12>12</a>
</span><span class=lnt id=hl-182-13><a class=lnlinks href=#hl-182-13>13</a>
</span><span class=lnt id=hl-182-14><a class=lnlinks href=#hl-182-14>14</a>
</span><span class=lnt id=hl-182-15><a class=lnlinks href=#hl-182-15>15</a>
</span><span class=lnt id=hl-182-16><a class=lnlinks href=#hl-182-16>16</a>
</span><span class=lnt id=hl-182-17><a class=lnlinks href=#hl-182-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>10:48:38.070 <span class=o>[</span>ç”Ÿäº§è€…3<span class=o>]</span> c.TestProducerConsumer - download...
</span></span><span class=line><span class=cl>10:48:38.070 <span class=o>[</span>ç”Ÿäº§è€…0<span class=o>]</span> c.TestProducerConsumer - download...
</span></span><span class=line><span class=cl>10:48:38.070 <span class=o>[</span>æ¶ˆè´¹è€…<span class=o>]</span> c.MessageQueue - æ²¡è´§äº†, <span class=nb>wait</span>
</span></span><span class=line><span class=cl>10:48:38.070 <span class=o>[</span>ç”Ÿäº§è€…1<span class=o>]</span> c.TestProducerConsumer - download...
</span></span><span class=line><span class=cl>10:48:38.070 <span class=o>[</span>ç”Ÿäº§è€…2<span class=o>]</span> c.TestProducerConsumer - download...
</span></span><span class=line><span class=cl>10:48:41.236 <span class=o>[</span>ç”Ÿäº§è€…1<span class=o>]</span> c.TestProducerConsumer - try put message<span class=o>(</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl>10:48:41.237 <span class=o>[</span>ç”Ÿäº§è€…2<span class=o>]</span> c.TestProducerConsumer - try put message<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl>10:48:41.236 <span class=o>[</span>ç”Ÿäº§è€…0<span class=o>]</span> c.TestProducerConsumer - try put message<span class=o>(</span>0<span class=o>)</span>
</span></span><span class=line><span class=cl>10:48:41.237 <span class=o>[</span>ç”Ÿäº§è€…3<span class=o>]</span> c.TestProducerConsumer - try put message<span class=o>(</span>3<span class=o>)</span>
</span></span><span class=line><span class=cl>10:48:41.239 <span class=o>[</span>ç”Ÿäº§è€…2<span class=o>]</span> c.MessageQueue - åº“å­˜å·²è¾¾ä¸Šé™, <span class=nb>wait</span>
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>ç”Ÿäº§è€…1<span class=o>]</span> c.MessageQueue - åº“å­˜å·²è¾¾ä¸Šé™, <span class=nb>wait</span>
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>æ¶ˆè´¹è€…<span class=o>]</span> c.TestProducerConsumer - take message<span class=o>(</span>0<span class=o>)</span>: <span class=o>[</span>3<span class=o>]</span> lines
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>ç”Ÿäº§è€…2<span class=o>]</span> c.MessageQueue - åº“å­˜å·²è¾¾ä¸Šé™, <span class=nb>wait</span>
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>æ¶ˆè´¹è€…<span class=o>]</span> c.TestProducerConsumer - take message<span class=o>(</span>3<span class=o>)</span>: <span class=o>[</span>3<span class=o>]</span> lines
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>æ¶ˆè´¹è€…<span class=o>]</span> c.TestProducerConsumer - take message<span class=o>(</span>1<span class=o>)</span>: <span class=o>[</span>3<span class=o>]</span> lines
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>æ¶ˆè´¹è€…<span class=o>]</span> c.TestProducerConsumer - take message<span class=o>(</span>2<span class=o>)</span>: <span class=o>[</span>3<span class=o>]</span> lines
</span></span><span class=line><span class=cl>10:48:41.240 <span class=o>[</span>æ¶ˆè´¹è€…<span class=o>]</span> c.MessageQueue - æ²¡è´§äº†, <span class=nb>wait</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»“æœè§£è¯»</p><h2 id=49-park--unpark><a href=#49-park--unpark class=header-anchor>#</a>
4.9 Park & Unpark</h2><h5 id=åŸºæœ¬ä½¿ç”¨><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
åŸºæœ¬ä½¿ç”¨</h5><p>å®ƒä»¬æ˜¯ LockSupport ç±»ä¸­çš„æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-183-1><a class=lnlinks href=#hl-183-1>1</a>
</span><span class=lnt id=hl-183-2><a class=lnlinks href=#hl-183-2>2</a>
</span><span class=lnt id=hl-183-3><a class=lnlinks href=#hl-183-3>3</a>
</span><span class=lnt id=hl-183-4><a class=lnlinks href=#hl-183-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æš‚åœå½“å‰çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æ¢å¤æŸä¸ªçº¿ç¨‹çš„è¿è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>æš‚åœçº¿ç¨‹å¯¹è±¡</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å…ˆ park å† unpark</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-184-1><a class=lnlinks href=#hl-184-1> 1</a>
</span><span class=lnt id=hl-184-2><a class=lnlinks href=#hl-184-2> 2</a>
</span><span class=lnt id=hl-184-3><a class=lnlinks href=#hl-184-3> 3</a>
</span><span class=lnt id=hl-184-4><a class=lnlinks href=#hl-184-4> 4</a>
</span><span class=lnt id=hl-184-5><a class=lnlinks href=#hl-184-5> 5</a>
</span><span class=lnt id=hl-184-6><a class=lnlinks href=#hl-184-6> 6</a>
</span><span class=lnt id=hl-184-7><a class=lnlinks href=#hl-184-7> 7</a>
</span><span class=lnt id=hl-184-8><a class=lnlinks href=#hl-184-8> 8</a>
</span><span class=lnt id=hl-184-9><a class=lnlinks href=#hl-184-9> 9</a>
</span><span class=lnt id=hl-184-10><a class=lnlinks href=#hl-184-10>10</a>
</span><span class=lnt id=hl-184-11><a class=lnlinks href=#hl-184-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;park...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;resume...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unpark...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>t1</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-185-1><a class=lnlinks href=#hl-185-1>1</a>
</span><span class=lnt id=hl-185-2><a class=lnlinks href=#hl-185-2>2</a>
</span><span class=lnt id=hl-185-3><a class=lnlinks href=#hl-185-3>3</a>
</span><span class=lnt id=hl-185-4><a class=lnlinks href=#hl-185-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:42:52.585 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>18:42:53.589 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - park... 
</span></span><span class=line><span class=cl>18:42:54.583 c.TestParkUnpark <span class=o>[</span>main<span class=o>]</span> - unpark... 
</span></span><span class=line><span class=cl>18:42:54.583 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - resume... 
</span></span></code></pre></td></tr></table></div></div><p>å…ˆ unpark å† park</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-186-1><a class=lnlinks href=#hl-186-1> 1</a>
</span><span class=lnt id=hl-186-2><a class=lnlinks href=#hl-186-2> 2</a>
</span><span class=lnt id=hl-186-3><a class=lnlinks href=#hl-186-3> 3</a>
</span><span class=lnt id=hl-186-4><a class=lnlinks href=#hl-186-4> 4</a>
</span><span class=lnt id=hl-186-5><a class=lnlinks href=#hl-186-5> 5</a>
</span><span class=lnt id=hl-186-6><a class=lnlinks href=#hl-186-6> 6</a>
</span><span class=lnt id=hl-186-7><a class=lnlinks href=#hl-186-7> 7</a>
</span><span class=lnt id=hl-186-8><a class=lnlinks href=#hl-186-8> 8</a>
</span><span class=lnt id=hl-186-9><a class=lnlinks href=#hl-186-9> 9</a>
</span><span class=lnt id=hl-186-10><a class=lnlinks href=#hl-186-10>10</a>
</span><span class=lnt id=hl-186-11><a class=lnlinks href=#hl-186-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;park...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;resume...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unpark...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>t1</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-187-1><a class=lnlinks href=#hl-187-1>1</a>
</span><span class=lnt id=hl-187-2><a class=lnlinks href=#hl-187-2>2</a>
</span><span class=lnt id=hl-187-3><a class=lnlinks href=#hl-187-3>3</a>
</span><span class=lnt id=hl-187-4><a class=lnlinks href=#hl-187-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:43:50.765 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>18:43:51.764 c.TestParkUnpark <span class=o>[</span>main<span class=o>]</span> - unpark... 
</span></span><span class=line><span class=cl>18:43:52.769 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - park... 
</span></span><span class=line><span class=cl>18:43:52.769 c.TestParkUnpark <span class=o>[</span>t1<span class=o>]</span> - resume... 
</span></span></code></pre></td></tr></table></div></div><h5 id=ç‰¹ç‚¹><a href=#%e7%89%b9%e7%82%b9 class=header-anchor>#</a>
ç‰¹ç‚¹</h5><p>ä¸ Object çš„ wait & notify ç›¸æ¯”</p><ul><li>waitï¼Œnotify å’Œ notifyAll å¿…é¡»é…åˆ Object Monitor ä¸€èµ·ä½¿ç”¨ï¼Œè€Œ parkï¼Œunpark ä¸å¿…</li><li>park & unpark æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æ¥ã€é˜»å¡ã€‘å’Œã€å”¤é†’ã€‘çº¿ç¨‹ï¼Œè€Œ notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒnotifyAll æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°±ä¸é‚£ä¹ˆã€ç²¾ç¡®ã€‘</li><li>park & unpark å¯ä»¥å…ˆ unparkï¼Œè€Œ wait & notify ä¸èƒ½å…ˆ notify</li></ul><h5 id=textcolorblue-åŸç†ä¹‹parkå’Œunpark><a href=#textcolorblue-%e5%8e%9f%e7%90%86%e4%b9%8bpark%e5%92%8cunpark class=header-anchor>#</a>
$\textcolor{blue}{* åŸç†ä¹‹parkå’Œunpark}$</h5><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ª Parker å¯¹è±¡(ç”±C++ç¼–å†™ï¼Œjavaä¸­ä¸å¯è§)ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆ <code>_counter </code>ï¼Œ <code>_cond </code>å’Œ <code>_mutex</code> æ‰“ä¸ªæ¯”å–»</p><ul><li>çº¿ç¨‹å°±åƒä¸€ä¸ªæ—…äººï¼ŒParker å°±åƒä»–éšèº«æºå¸¦çš„èƒŒåŒ…ï¼Œæ¡ä»¶å˜é‡å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¸ç¯·ã€‚_counter å°±å¥½æ¯”èƒŒåŒ…ä¸­ çš„å¤‡ç”¨å¹²ç²®ï¼ˆ0 ä¸ºè€—å°½ï¼Œ1 ä¸ºå……è¶³ï¼‰</li><li>è°ƒç”¨ park å°±æ˜¯è¦çœ‹éœ€ä¸éœ€è¦åœä¸‹æ¥æ­‡æ¯<ul><li>å¦‚æœå¤‡ç”¨å¹²ç²®è€—å°½ï¼Œé‚£ä¹ˆé’»è¿›å¸ç¯·æ­‡æ¯</li><li>å¦‚æœå¤‡ç”¨å¹²ç²®å……è¶³ï¼Œé‚£ä¹ˆä¸éœ€åœç•™ï¼Œç»§ç»­å‰è¿›</li></ul></li><li>è°ƒç”¨ unparkï¼Œå°±å¥½æ¯”ä»¤å¹²ç²®å……è¶³<ul><li>å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨å¸ç¯·ï¼Œå°±å”¤é†’è®©ä»–ç»§ç»­å‰è¿›</li><li>å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆä¸‹æ¬¡ä»–è°ƒç”¨ park æ—¶ï¼Œä»…æ˜¯æ¶ˆè€—æ‰å¤‡ç”¨å¹²ç²®ï¼Œä¸éœ€åœç•™ç»§ç»­å‰è¿›<ul><li>å› ä¸ºèƒŒåŒ…ç©ºé—´æœ‰é™ï¼Œå¤šæ¬¡è°ƒç”¨ unpark ä»…ä¼šè¡¥å……ä¸€ä»½å¤‡ç”¨å¹²ç²®</li></ul></li></ul></li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304144415441.png width=900 height=600 loading=lazy decoding=async alt=image-20220304144415441 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ol><li>å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•</li><li>æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 0ï¼Œè¿™æ—¶ï¼Œè·å¾— _mutex äº’æ–¥é”</li><li>çº¿ç¨‹è¿›å…¥ _cond æ¡ä»¶å˜é‡é˜»å¡</li><li>è®¾ç½® _counter = 0</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304144548871.png width=900 height=600 loading=lazy decoding=async alt=image-20220304144548871 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ol><li>è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1</li><li>å”¤é†’ _cond æ¡ä»¶å˜é‡ä¸­çš„ Thread_0</li><li>Thread_0 æ¢å¤è¿è¡Œ</li><li>è®¾ç½® _counter ä¸º 0</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304144626180.png width=900 height=600 loading=lazy decoding=async alt=image-20220304144626180 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ol><li>è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1</li><li>å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•</li><li>æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 1ï¼Œè¿™æ—¶çº¿ç¨‹æ— éœ€é˜»å¡ï¼Œç»§ç»­è¿è¡Œ</li><li>è®¾ç½® _counter ä¸º 0</li></ol><h2 id=410-é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢><a href=#410-%e9%87%8d%e6%96%b0%e7%90%86%e8%a7%a3%e7%ba%bf%e7%a8%8b%e7%8a%b6%e6%80%81%e8%bd%ac%e6%8d%a2 class=header-anchor>#</a>
4.10 é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢</h2><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304151245960.png width=900 height=600 loading=lazy decoding=async alt=image-20220304151245960 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å‡è®¾æœ‰çº¿ç¨‹ <code>Thread t</code></p><h5 id=æƒ…å†µ-1-new----runnable><a href=#%e6%83%85%e5%86%b5-1-new----runnable class=header-anchor>#</a>
æƒ…å†µ 1 <code>NEW --> RUNNABLE</code></h5><ul><li>å½“è°ƒç”¨ <code>t.start()</code> æ–¹æ³•æ—¶ï¼Œç”± NEW &ndash;> RUNNABLE</li></ul><h5 id=æƒ…å†µ-2-runnable----waiting><a href=#%e6%83%85%e5%86%b5-2-runnable----waiting class=header-anchor>#</a>
æƒ…å†µ 2 <code>RUNNABLE &lt;--> WAITING</code></h5><p><strong>t çº¿ç¨‹</strong>ç”¨ <code>synchronized(obj)</code> è·å–äº†å¯¹è±¡é”å</p><ul><li>è°ƒç”¨ <code>obj.wait()</code> æ–¹æ³•æ—¶ï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>RUNNABLE --> WAITING</code></li><li>è°ƒç”¨ <code>obj.notify()</code> ï¼Œ <code>obj.notifyAll()</code> ï¼Œ <code>t.interrupt()</code> æ—¶<ul><li>ç«äº‰é”æˆåŠŸï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>WAITING --> RUNNABLE</code></li><li>ç«äº‰é”å¤±è´¥ï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>WAITING --> BLOCKED</code></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-188-1><a class=lnlinks href=#hl-188-1> 1</a>
</span><span class=lnt id=hl-188-2><a class=lnlinks href=#hl-188-2> 2</a>
</span><span class=lnt id=hl-188-3><a class=lnlinks href=#hl-188-3> 3</a>
</span><span class=lnt id=hl-188-4><a class=lnlinks href=#hl-188-4> 4</a>
</span><span class=lnt id=hl-188-5><a class=lnlinks href=#hl-188-5> 5</a>
</span><span class=lnt id=hl-188-6><a class=lnlinks href=#hl-188-6> 6</a>
</span><span class=lnt id=hl-188-7><a class=lnlinks href=#hl-188-7> 7</a>
</span><span class=lnt id=hl-188-8><a class=lnlinks href=#hl-188-8> 8</a>
</span><span class=lnt id=hl-188-9><a class=lnlinks href=#hl-188-9> 9</a>
</span><span class=lnt id=hl-188-10><a class=lnlinks href=#hl-188-10>10</a>
</span><span class=lnt id=hl-188-11><a class=lnlinks href=#hl-188-11>11</a>
</span><span class=lnt id=hl-188-12><a class=lnlinks href=#hl-188-12>12</a>
</span><span class=lnt id=hl-188-13><a class=lnlinks href=#hl-188-13>13</a>
</span><span class=lnt id=hl-188-14><a class=lnlinks href=#hl-188-14>14</a>
</span><span class=lnt id=hl-188-15><a class=lnlinks href=#hl-188-15>15</a>
</span><span class=lnt id=hl-188-16><a class=lnlinks href=#hl-188-16>16</a>
</span><span class=lnt id=hl-188-17><a class=lnlinks href=#hl-188-17>17</a>
</span><span class=lnt id=hl-188-18><a class=lnlinks href=#hl-188-18>18</a>
</span><span class=lnt id=hl-188-19><a class=lnlinks href=#hl-188-19>19</a>
</span><span class=lnt id=hl-188-20><a class=lnlinks href=#hl-188-20>20</a>
</span><span class=lnt id=hl-188-21><a class=lnlinks href=#hl-188-21>21</a>
</span><span class=lnt id=hl-188-22><a class=lnlinks href=#hl-188-22>22</a>
</span><span class=lnt id=hl-188-23><a class=lnlinks href=#hl-188-23>23</a>
</span><span class=lnt id=hl-188-24><a class=lnlinks href=#hl-188-24>24</a>
</span><span class=lnt id=hl-188-25><a class=lnlinks href=#hl-188-25>25</a>
</span><span class=lnt id=hl-188-26><a class=lnlinks href=#hl-188-26>26</a>
</span><span class=lnt id=hl-188-27><a class=lnlinks href=#hl-188-27>27</a>
</span><span class=lnt id=hl-188-28><a class=lnlinks href=#hl-188-28>28</a>
</span><span class=lnt id=hl-188-29><a class=lnlinks href=#hl-188-29>29</a>
</span><span class=lnt id=hl-188-30><a class=lnlinks href=#hl-188-30>30</a>
</span><span class=lnt id=hl-188-31><a class=lnlinks href=#hl-188-31>31</a>
</span><span class=lnt id=hl-188-32><a class=lnlinks href=#hl-188-32>32</a>
</span><span class=lnt id=hl-188-33><a class=lnlinks href=#hl-188-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestWaitNotify</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‰§è¡Œ....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>obj</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å…¶å®ƒä»£ç ....&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// æ–­ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‰§è¡Œ....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>obj</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å…¶å®ƒä»£ç ....&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// æ–­ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å”¤é†’ obj ä¸Šå…¶å®ƒçº¿ç¨‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>obj</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w> </span><span class=c1>// å”¤é†’objä¸Šæ‰€æœ‰ç­‰å¾…çº¿ç¨‹ æ–­ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=æƒ…å†µ-3-runnable----waiting><a href=#%e6%83%85%e5%86%b5-3-runnable----waiting class=header-anchor>#</a>
æƒ…å†µ 3 <code>RUNNABLE &lt;--> WAITING</code></h5><ul><li><strong>å½“å‰çº¿ç¨‹</strong>è°ƒç”¨ <code>t.join()</code> æ–¹æ³•æ—¶ï¼Œ<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>RUNNABLE --> WAITING</code> æ³¨æ„æ˜¯<strong>å½“å‰çº¿ç¨‹</strong>åœ¨<strong>t çº¿ç¨‹å¯¹è±¡</strong>çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</li><li><strong>t çº¿ç¨‹</strong>è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†<strong>å½“å‰çº¿ç¨‹</strong>çš„ interrupt() æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» <code>WAITING --> RUNNABLE</code></li></ul><h5 id=æƒ…å†µ-4-runnable----waiting><a href=#%e6%83%85%e5%86%b5-4-runnable----waiting class=header-anchor>#</a>
æƒ…å†µ 4 <code>RUNNABLE &lt;--> WAITING</code></h5><ul><li><strong>å½“å‰çº¿ç¨‹</strong>è°ƒç”¨ <code>LockSupport.park()</code> æ–¹æ³•ä¼šè®©<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>RUNNABLE --> WAITING</code></li><li>è°ƒç”¨ <code>LockSupport.unpark</code>(ç›®æ ‡çº¿ç¨‹) æˆ–è°ƒç”¨äº†çº¿ç¨‹ çš„ <code>interrupt()</code> ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä» <code>WAITING --> RUNNABLE</code></li></ul><h5 id=æƒ…å†µ-5-runnable----timed_waiting><a href=#%e6%83%85%e5%86%b5-5-runnable----timed_waiting class=header-anchor>#</a>
æƒ…å†µ 5 <code>RUNNABLE &lt;--> TIMED_WAITING</code></h5><p><strong>t çº¿ç¨‹</strong>ç”¨ <code>synchronized(obj)</code> è·å–äº†å¯¹è±¡é”å</p><ul><li>è°ƒç”¨ <code>obj.wait(long n)</code> æ–¹æ³•æ—¶ï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>RUNNABLE --> TIMED_WAITING</code></li><li><strong>t çº¿ç¨‹</strong>ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œæˆ–è°ƒç”¨ <code>obj.notify()</code> ï¼Œ <code>obj.notifyAll()</code> ï¼Œ<code>t.interrupt()</code>æ—¶<ul><li>ç«äº‰é”æˆåŠŸï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>TIMED_WAITING --> RUNNABLE</code></li><li>ç«äº‰é”å¤±è´¥ï¼Œ<strong>t çº¿ç¨‹</strong>ä» <code>TIMED_WAITING --> BLOCKED</code></li></ul></li></ul><h5 id=æƒ…å†µ-6-runnable----timed_waiting><a href=#%e6%83%85%e5%86%b5-6-runnable----timed_waiting class=header-anchor>#</a>
æƒ…å†µ 6 <code>RUNNABLE &lt;--> TIMED_WAITING</code></h5><ul><li><strong>å½“å‰çº¿ç¨‹</strong>è°ƒç”¨ <code>t.join(long n)</code> æ–¹æ³•æ—¶ï¼Œ<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>RUNNABLE --> TIMED_WAITING</code> æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨<strong>t çº¿ç¨‹</strong>å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</li><li><strong>å½“å‰çº¿ç¨‹</strong>ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œæˆ–<strong>t çº¿ç¨‹</strong>è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†<strong>å½“å‰çº¿ç¨‹</strong>çš„ <code>interrupt()</code> æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» <code>TIMED_WAITING --> RUNNABLE</code></li></ul><h5 id=æƒ…å†µ-7-runnable----timed_waiting><a href=#%e6%83%85%e5%86%b5-7-runnable----timed_waiting class=header-anchor>#</a>
æƒ…å†µ 7 <code>RUNNABLE &lt;--> TIMED_WAITING</code></h5><ul><li><strong>å½“å‰çº¿ç¨‹</strong>è°ƒç”¨ <code>Thread.sleep(long n)</code> ï¼Œ<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>RUNNABLE --> TIMED_WAITING</code></li><li><strong>å½“å‰çº¿ç¨‹</strong>ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œ<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>TIMED_WAITING --> RUNNABLE</code></li></ul><h5 id=æƒ…å†µ-8-runnable----timed_waiting><a href=#%e6%83%85%e5%86%b5-8-runnable----timed_waiting class=header-anchor>#</a>
æƒ…å†µ 8 <code>RUNNABLE &lt;--> TIMED_WAITING</code></h5><ul><li><strong>å½“å‰çº¿ç¨‹</strong>è°ƒç”¨ <code>LockSupport.parkNanos(long nanos)</code> æˆ– <code>LockSupport.parkUntil(long millis)</code> æ—¶ï¼Œ<strong>å½“å‰çº¿ç¨‹</strong>ä» <code>RUNNABLE --> TIMED_WAITING</code></li><li>è°ƒç”¨ <code>LockSupport.unpark</code>(ç›®æ ‡çº¿ç¨‹) æˆ–è°ƒç”¨äº†çº¿ç¨‹ çš„ <code>interrupt()</code> ï¼Œæˆ–æ˜¯ç­‰å¾…è¶…æ—¶ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä» <code>TIMED_WAITING--> RUNNABLE</code></li></ul><h5 id=æƒ…å†µ-9-runnable----blocked><a href=#%e6%83%85%e5%86%b5-9-runnable----blocked class=header-anchor>#</a>
æƒ…å†µ 9 <code>RUNNABLE &lt;--> BLOCKED</code></h5><ul><li><strong>t çº¿ç¨‹</strong>ç”¨ <code>synchronized(obj)</code> è·å–äº†å¯¹è±¡é”æ—¶å¦‚æœç«äº‰å¤±è´¥ï¼Œä» <code>RUNNABLE --> BLOCKED</code></li><li>æŒ obj é”çº¿ç¨‹çš„åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œä¼šå”¤é†’è¯¥å¯¹è±¡ä¸Šæ‰€æœ‰ <code>BLOCKED</code> çš„çº¿ç¨‹é‡æ–°ç«äº‰ï¼Œå¦‚æœå…¶ä¸­ <strong>t çº¿ç¨‹</strong>ç«äº‰ æˆåŠŸï¼Œä» <code>BLOCKED --> RUNNABLE</code> ï¼Œå…¶å®ƒå¤±è´¥çš„çº¿ç¨‹ä»ç„¶ <code>BLOCKED</code></li></ul><h5 id=æƒ…å†µ-10-runnable----terminated><a href=#%e6%83%85%e5%86%b5-10-runnable----terminated class=header-anchor>#</a>
æƒ…å†µ 10 <code>RUNNABLE &lt;--> TERMINATED</code></h5><ul><li>å½“å‰çº¿ç¨‹æ‰€æœ‰ä»£ç è¿è¡Œå®Œæ¯•ï¼Œè¿›å…¥ <code>TERMINATED</code></li></ul><h2 id=411-å¤šæŠŠé”><a href=#411-%e5%a4%9a%e6%8a%8a%e9%94%81 class=header-anchor>#</a>
4.11 å¤šæŠŠé”</h2><p><strong>å¤šæŠŠä¸ç›¸å¹²çš„é”</strong></p><p>ä¸€é—´å¤§å±‹å­æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼šç¡è§‰ã€å­¦ä¹ ï¼Œäº’ä¸ç›¸å¹²ã€‚</p><p>ç°åœ¨å°å—è¦å­¦ä¹ ï¼Œå°å¥³è¦ç¡è§‰ï¼Œä½†å¦‚æœåªç”¨ä¸€é—´å±‹å­ï¼ˆä¸€ä¸ªå¯¹è±¡é”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½</p><p>è§£å†³æ–¹æ³•æ˜¯å‡†å¤‡å¤šä¸ªæˆ¿é—´ï¼ˆå¤šä¸ªå¯¹è±¡é”ï¼‰</p><p>ä¾‹å¦‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-189-1><a class=lnlinks href=#hl-189-1> 1</a>
</span><span class=lnt id=hl-189-2><a class=lnlinks href=#hl-189-2> 2</a>
</span><span class=lnt id=hl-189-3><a class=lnlinks href=#hl-189-3> 3</a>
</span><span class=lnt id=hl-189-4><a class=lnlinks href=#hl-189-4> 4</a>
</span><span class=lnt id=hl-189-5><a class=lnlinks href=#hl-189-5> 5</a>
</span><span class=lnt id=hl-189-6><a class=lnlinks href=#hl-189-6> 6</a>
</span><span class=lnt id=hl-189-7><a class=lnlinks href=#hl-189-7> 7</a>
</span><span class=lnt id=hl-189-8><a class=lnlinks href=#hl-189-8> 8</a>
</span><span class=lnt id=hl-189-9><a class=lnlinks href=#hl-189-9> 9</a>
</span><span class=lnt id=hl-189-10><a class=lnlinks href=#hl-189-10>10</a>
</span><span class=lnt id=hl-189-11><a class=lnlinks href=#hl-189-11>11</a>
</span><span class=lnt id=hl-189-12><a class=lnlinks href=#hl-189-12>12</a>
</span><span class=lnt id=hl-189-13><a class=lnlinks href=#hl-189-13>13</a>
</span><span class=lnt id=hl-189-14><a class=lnlinks href=#hl-189-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>BigRoom</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sleep</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;sleeping 2 å°æ—¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>study</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;study 1 å°æ—¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-190-1><a class=lnlinks href=#hl-190-1>1</a>
</span><span class=lnt id=hl-190-2><a class=lnlinks href=#hl-190-2>2</a>
</span><span class=lnt id=hl-190-3><a class=lnlinks href=#hl-190-3>3</a>
</span><span class=lnt id=hl-190-4><a class=lnlinks href=#hl-190-4>4</a>
</span><span class=lnt id=hl-190-5><a class=lnlinks href=#hl-190-5>5</a>
</span><span class=lnt id=hl-190-6><a class=lnlinks href=#hl-190-6>6</a>
</span><span class=lnt id=hl-190-7><a class=lnlinks href=#hl-190-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BigRoom</span><span class=w> </span><span class=n>bigRoom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BigRoom</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>bigRoom</span><span class=p>.</span><span class=na>compute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;å°å—&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>bigRoom</span><span class=p>.</span><span class=na>sleep</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;å°å¥³&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-191-1><a class=lnlinks href=#hl-191-1>1</a>
</span><span class=lnt id=hl-191-2><a class=lnlinks href=#hl-191-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>12:13:54.471 <span class=o>[</span>å°å—<span class=o>]</span> c.BigRoom - study <span class=m>1</span> å°æ—¶
</span></span><span class=line><span class=cl>12:13:55.476 <span class=o>[</span>å°å¥³<span class=o>]</span> c.BigRoom - sleeping <span class=m>2</span> å°æ—¶
</span></span></code></pre></td></tr></table></div></div><p>æ”¹è¿›</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-192-1><a class=lnlinks href=#hl-192-1> 1</a>
</span><span class=lnt id=hl-192-2><a class=lnlinks href=#hl-192-2> 2</a>
</span><span class=lnt id=hl-192-3><a class=lnlinks href=#hl-192-3> 3</a>
</span><span class=lnt id=hl-192-4><a class=lnlinks href=#hl-192-4> 4</a>
</span><span class=lnt id=hl-192-5><a class=lnlinks href=#hl-192-5> 5</a>
</span><span class=lnt id=hl-192-6><a class=lnlinks href=#hl-192-6> 6</a>
</span><span class=lnt id=hl-192-7><a class=lnlinks href=#hl-192-7> 7</a>
</span><span class=lnt id=hl-192-8><a class=lnlinks href=#hl-192-8> 8</a>
</span><span class=lnt id=hl-192-9><a class=lnlinks href=#hl-192-9> 9</a>
</span><span class=lnt id=hl-192-10><a class=lnlinks href=#hl-192-10>10</a>
</span><span class=lnt id=hl-192-11><a class=lnlinks href=#hl-192-11>11</a>
</span><span class=lnt id=hl-192-12><a class=lnlinks href=#hl-192-12>12</a>
</span><span class=lnt id=hl-192-13><a class=lnlinks href=#hl-192-13>13</a>
</span><span class=lnt id=hl-192-14><a class=lnlinks href=#hl-192-14>14</a>
</span><span class=lnt id=hl-192-15><a class=lnlinks href=#hl-192-15>15</a>
</span><span class=lnt id=hl-192-16><a class=lnlinks href=#hl-192-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>BigRoom</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>studyRoom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>bedRoom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sleep</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>bedRoom</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;sleeping 2 å°æ—¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>study</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>studyRoom</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;study 1 å°æ—¶&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æŸæ¬¡æ‰§è¡Œç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-193-1><a class=lnlinks href=#hl-193-1>1</a>
</span><span class=lnt id=hl-193-2><a class=lnlinks href=#hl-193-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>12:15:35.069 <span class=o>[</span>å°å—<span class=o>]</span> c.BigRoom - study <span class=m>1</span> å°æ—¶
</span></span><span class=line><span class=cl>12:15:35.069 <span class=o>[</span>å°å¥³<span class=o>]</span> c.BigRoom - sleeping <span class=m>2</span> å°æ—¶
</span></span></code></pre></td></tr></table></div></div><p>å°†é”çš„ç²’åº¦ç»†åˆ†</p><ul><li>å¥½å¤„ï¼Œæ˜¯å¯ä»¥å¢å¼ºå¹¶å‘åº¦</li><li>åå¤„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”</li><li>å‰æï¼šä¸¤æŠŠé”é”ä½çš„ä¸¤æ®µä»£ç äº’ä¸ç›¸å…³</li></ul><h2 id=412-æ´»è·ƒæ€§><a href=#412-%e6%b4%bb%e8%b7%83%e6%80%a7 class=header-anchor>#</a>
4.12 æ´»è·ƒæ€§</h2><h5 id=æ­»é”><a href=#%e6%ad%bb%e9%94%81 class=header-anchor>#</a>
<strong>æ­»é”</strong></h5><p>æœ‰è¿™æ ·çš„æƒ…å†µï¼šä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”</p><p><code>t1 çº¿ç¨‹</code> è·å¾— <code>Aå¯¹è±¡</code> é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– <code>Bå¯¹è±¡</code> çš„é” <code>t2 çº¿ç¨‹</code> è·å¾— <code>Bå¯¹è±¡</code> é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– <code>Aå¯¹è±¡</code> çš„é” ä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-194-1><a class=lnlinks href=#hl-194-1> 1</a>
</span><span class=lnt id=hl-194-2><a class=lnlinks href=#hl-194-2> 2</a>
</span><span class=lnt id=hl-194-3><a class=lnlinks href=#hl-194-3> 3</a>
</span><span class=lnt id=hl-194-4><a class=lnlinks href=#hl-194-4> 4</a>
</span><span class=lnt id=hl-194-5><a class=lnlinks href=#hl-194-5> 5</a>
</span><span class=lnt id=hl-194-6><a class=lnlinks href=#hl-194-6> 6</a>
</span><span class=lnt id=hl-194-7><a class=lnlinks href=#hl-194-7> 7</a>
</span><span class=lnt id=hl-194-8><a class=lnlinks href=#hl-194-8> 8</a>
</span><span class=lnt id=hl-194-9><a class=lnlinks href=#hl-194-9> 9</a>
</span><span class=lnt id=hl-194-10><a class=lnlinks href=#hl-194-10>10</a>
</span><span class=lnt id=hl-194-11><a class=lnlinks href=#hl-194-11>11</a>
</span><span class=lnt id=hl-194-12><a class=lnlinks href=#hl-194-12>12</a>
</span><span class=lnt id=hl-194-13><a class=lnlinks href=#hl-194-13>13</a>
</span><span class=lnt id=hl-194-14><a class=lnlinks href=#hl-194-14>14</a>
</span><span class=lnt id=hl-194-15><a class=lnlinks href=#hl-194-15>15</a>
</span><span class=lnt id=hl-194-16><a class=lnlinks href=#hl-194-16>16</a>
</span><span class=lnt id=hl-194-17><a class=lnlinks href=#hl-194-17>17</a>
</span><span class=lnt id=hl-194-18><a class=lnlinks href=#hl-194-18>18</a>
</span><span class=lnt id=hl-194-19><a class=lnlinks href=#hl-194-19>19</a>
</span><span class=lnt id=hl-194-20><a class=lnlinks href=#hl-194-20>20</a>
</span><span class=lnt id=hl-194-21><a class=lnlinks href=#hl-194-21>21</a>
</span><span class=lnt id=hl-194-22><a class=lnlinks href=#hl-194-22>22</a>
</span><span class=lnt id=hl-194-23><a class=lnlinks href=#hl-194-23>23</a>
</span><span class=lnt id=hl-194-24><a class=lnlinks href=#hl-194-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Object</span><span class=w> </span><span class=n>A</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Object</span><span class=w> </span><span class=n>B</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>A</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock A&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>B</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock B&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ“ä½œ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>B</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock B&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>A</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock A&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ“ä½œ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-195-1><a class=lnlinks href=#hl-195-1>1</a>
</span><span class=lnt id=hl-195-2><a class=lnlinks href=#hl-195-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>12:22:06.962 <span class=o>[</span>t2<span class=o>]</span> c.TestDeadLock - lock B 
</span></span><span class=line><span class=cl>12:22:06.962 <span class=o>[</span>t1<span class=o>]</span> c.TestDeadLock - lock A
</span></span></code></pre></td></tr></table></div></div><p>è§£å†³æ–¹å¼ï¼š</p><ul><li>ReentrantLock</li></ul><h5 id=å®šä½æ­»é”><a href=#%e5%ae%9a%e4%bd%8d%e6%ad%bb%e9%94%81 class=header-anchor>#</a>
<strong>å®šä½æ­»é”</strong></h5><p>æ£€æµ‹æ­»é”å¯ä»¥ä½¿ç”¨ jconsoleå·¥å…·ï¼Œæˆ–è€…ä½¿ç”¨ jps å®šä½è¿›ç¨‹ idï¼Œå†ç”¨ jstack å®šä½æ­»é”ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-196-1><a class=lnlinks href=#hl-196-1>1</a>
</span><span class=lnt id=hl-196-2><a class=lnlinks href=#hl-196-2>2</a>
</span><span class=lnt id=hl-196-3><a class=lnlinks href=#hl-196-3>3</a>
</span><span class=lnt id=hl-196-4><a class=lnlinks href=#hl-196-4>4</a>
</span><span class=lnt id=hl-196-5><a class=lnlinks href=#hl-196-5>5</a>
</span><span class=lnt id=hl-196-6><a class=lnlinks href=#hl-196-6>6</a>
</span><span class=lnt id=hl-196-7><a class=lnlinks href=#hl-196-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cmd &gt; jps
</span></span><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS: -Dfile.encoding<span class=o>=</span>UTF-8
</span></span><span class=line><span class=cl><span class=m>12320</span> Jps
</span></span><span class=line><span class=cl><span class=m>22816</span> KotlinCompileDaemon
</span></span><span class=line><span class=cl><span class=m>33200</span> TestDeadLock // JVM è¿›ç¨‹
</span></span><span class=line><span class=cl><span class=m>11508</span> Main
</span></span><span class=line><span class=cl><span class=m>28468</span> Launcher
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-197-1><a class=lnlinks href=#hl-197-1> 1</a>
</span><span class=lnt id=hl-197-2><a class=lnlinks href=#hl-197-2> 2</a>
</span><span class=lnt id=hl-197-3><a class=lnlinks href=#hl-197-3> 3</a>
</span><span class=lnt id=hl-197-4><a class=lnlinks href=#hl-197-4> 4</a>
</span><span class=lnt id=hl-197-5><a class=lnlinks href=#hl-197-5> 5</a>
</span><span class=lnt id=hl-197-6><a class=lnlinks href=#hl-197-6> 6</a>
</span><span class=lnt id=hl-197-7><a class=lnlinks href=#hl-197-7> 7</a>
</span><span class=lnt id=hl-197-8><a class=lnlinks href=#hl-197-8> 8</a>
</span><span class=lnt id=hl-197-9><a class=lnlinks href=#hl-197-9> 9</a>
</span><span class=lnt id=hl-197-10><a class=lnlinks href=#hl-197-10>10</a>
</span><span class=lnt id=hl-197-11><a class=lnlinks href=#hl-197-11>11</a>
</span><span class=lnt id=hl-197-12><a class=lnlinks href=#hl-197-12>12</a>
</span><span class=lnt id=hl-197-13><a class=lnlinks href=#hl-197-13>13</a>
</span><span class=lnt id=hl-197-14><a class=lnlinks href=#hl-197-14>14</a>
</span><span class=lnt id=hl-197-15><a class=lnlinks href=#hl-197-15>15</a>
</span><span class=lnt id=hl-197-16><a class=lnlinks href=#hl-197-16>16</a>
</span><span class=lnt id=hl-197-17><a class=lnlinks href=#hl-197-17>17</a>
</span><span class=lnt id=hl-197-18><a class=lnlinks href=#hl-197-18>18</a>
</span><span class=lnt id=hl-197-19><a class=lnlinks href=#hl-197-19>19</a>
</span><span class=lnt id=hl-197-20><a class=lnlinks href=#hl-197-20>20</a>
</span><span class=lnt id=hl-197-21><a class=lnlinks href=#hl-197-21>21</a>
</span><span class=lnt id=hl-197-22><a class=lnlinks href=#hl-197-22>22</a>
</span><span class=lnt id=hl-197-23><a class=lnlinks href=#hl-197-23>23</a>
</span><span class=lnt id=hl-197-24><a class=lnlinks href=#hl-197-24>24</a>
</span><span class=lnt id=hl-197-25><a class=lnlinks href=#hl-197-25>25</a>
</span><span class=lnt id=hl-197-26><a class=lnlinks href=#hl-197-26>26</a>
</span><span class=lnt id=hl-197-27><a class=lnlinks href=#hl-197-27>27</a>
</span><span class=lnt id=hl-197-28><a class=lnlinks href=#hl-197-28>28</a>
</span><span class=lnt id=hl-197-29><a class=lnlinks href=#hl-197-29>29</a>
</span><span class=lnt id=hl-197-30><a class=lnlinks href=#hl-197-30>30</a>
</span><span class=lnt id=hl-197-31><a class=lnlinks href=#hl-197-31>31</a>
</span><span class=lnt id=hl-197-32><a class=lnlinks href=#hl-197-32>32</a>
</span><span class=lnt id=hl-197-33><a class=lnlinks href=#hl-197-33>33</a>
</span><span class=lnt id=hl-197-34><a class=lnlinks href=#hl-197-34>34</a>
</span><span class=lnt id=hl-197-35><a class=lnlinks href=#hl-197-35>35</a>
</span><span class=lnt id=hl-197-36><a class=lnlinks href=#hl-197-36>36</a>
</span><span class=lnt id=hl-197-37><a class=lnlinks href=#hl-197-37>37</a>
</span><span class=lnt id=hl-197-38><a class=lnlinks href=#hl-197-38>38</a>
</span><span class=lnt id=hl-197-39><a class=lnlinks href=#hl-197-39>39</a>
</span><span class=lnt id=hl-197-40><a class=lnlinks href=#hl-197-40>40</a>
</span><span class=lnt id=hl-197-41><a class=lnlinks href=#hl-197-41>41</a>
</span><span class=lnt id=hl-197-42><a class=lnlinks href=#hl-197-42>42</a>
</span><span class=lnt id=hl-197-43><a class=lnlinks href=#hl-197-43>43</a>
</span><span class=lnt id=hl-197-44><a class=lnlinks href=#hl-197-44>44</a>
</span><span class=lnt id=hl-197-45><a class=lnlinks href=#hl-197-45>45</a>
</span><span class=lnt id=hl-197-46><a class=lnlinks href=#hl-197-46>46</a>
</span><span class=lnt id=hl-197-47><a class=lnlinks href=#hl-197-47>47</a>
</span><span class=lnt id=hl-197-48><a class=lnlinks href=#hl-197-48>48</a>
</span><span class=lnt id=hl-197-49><a class=lnlinks href=#hl-197-49>49</a>
</span><span class=lnt id=hl-197-50><a class=lnlinks href=#hl-197-50>50</a>
</span><span class=lnt id=hl-197-51><a class=lnlinks href=#hl-197-51>51</a>
</span><span class=lnt id=hl-197-52><a class=lnlinks href=#hl-197-52>52</a>
</span><span class=lnt id=hl-197-53><a class=lnlinks href=#hl-197-53>53</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cmd &gt; jstack <span class=m>33200</span>
</span></span><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS: -Dfile.encoding<span class=o>=</span>UTF-8
</span></span><span class=line><span class=cl>2018-12-29 05:51:40
</span></span><span class=line><span class=cl>Full thread dump Java HotSpot<span class=o>(</span>TM<span class=o>)</span> 64-Bit Server VM <span class=o>(</span>25.91-b14 mixed mode<span class=o>)</span>:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;DestroyJavaVM&#34;</span> <span class=c1>#13 prio=5 os_prio=0 tid=0x0000000003525000 nid=0x2f60 waiting on condition </span>
</span></span><span class=line><span class=cl><span class=o>[</span>0x0000000000000000<span class=o>]</span>
</span></span><span class=line><span class=cl>	java.lang.Thread.State: RUNNABLE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-1&#34;</span> <span class=c1>#12 prio=5 os_prio=0 tid=0x000000001eb69000 nid=0xd40 waiting for monitor entry </span>
</span></span><span class=line><span class=cl><span class=o>[</span>0x000000001f54f000<span class=o>]</span>
</span></span><span class=line><span class=cl>	java.lang.Thread.State: BLOCKED <span class=o>(</span>on object monitor<span class=o>)</span>
</span></span><span class=line><span class=cl>        at thread.TestDeadLock.lambda<span class=nv>$main$1</span><span class=o>(</span>TestDeadLock.java:28<span class=o>)</span>
</span></span><span class=line><span class=cl>        - waiting to lock &lt;0x000000076b5bf1c0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>        - locked &lt;0x000000076b5bf1d0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>        at thread.TestDeadLock<span class=nv>$$</span>Lambda<span class=nv>$2</span>/883049899.run<span class=o>(</span>Unknown Source<span class=o>)</span>
</span></span><span class=line><span class=cl>        at java.lang.Thread.run<span class=o>(</span>Thread.java:745<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-0&#34;</span> <span class=c1>#11 prio=5 os_prio=0 tid=0x000000001eb68800 nid=0x1b28 waiting for monitor entry </span>
</span></span><span class=line><span class=cl><span class=o>[</span>0x000000001f44f000<span class=o>]</span>
</span></span><span class=line><span class=cl>	java.lang.Thread.State: BLOCKED <span class=o>(</span>on object monitor<span class=o>)</span>
</span></span><span class=line><span class=cl>        at thread.TestDeadLock.lambda<span class=nv>$main$0</span><span class=o>(</span>TestDeadLock.java:15<span class=o>)</span>
</span></span><span class=line><span class=cl>        - waiting to lock &lt;0x000000076b5bf1d0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>         - locked &lt;0x000000076b5bf1c0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl> 		at thread.TestDeadLock<span class=nv>$$</span>Lambda<span class=nv>$1</span>/495053715.run<span class=o>(</span>Unknown Source<span class=o>)</span>
</span></span><span class=line><span class=cl> 		at java.lang.Thread.run<span class=o>(</span>Thread.java:745<span class=o>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>// ç•¥å»éƒ¨åˆ†è¾“å‡º
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Found one Java-level deadlock:
</span></span><span class=line><span class=cl><span class=o>=============================</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-1&#34;</span>:
</span></span><span class=line><span class=cl> 	waiting to lock monitor 0x000000000361d378 <span class=o>(</span>object 0x000000076b5bf1c0, a java.lang.Object<span class=o>)</span>,
</span></span><span class=line><span class=cl> 	which is held by <span class=s2>&#34;Thread-0&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-0&#34;</span>:
</span></span><span class=line><span class=cl>	 waiting to lock monitor 0x000000000361e768 <span class=o>(</span>object 0x000000076b5bf1d0, a java.lang.Object<span class=o>)</span>,
</span></span><span class=line><span class=cl> 	which is held by <span class=s2>&#34;Thread-1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Java stack information <span class=k>for</span> the threads listed above:
</span></span><span class=line><span class=cl><span class=o>===================================================</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-1&#34;</span>:
</span></span><span class=line><span class=cl>         at thread.TestDeadLock.lambda<span class=nv>$main$1</span><span class=o>(</span>TestDeadLock.java:28<span class=o>)</span>
</span></span><span class=line><span class=cl>         - waiting to lock &lt;0x000000076b5bf1c0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>         - locked &lt;0x000000076b5bf1d0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>         at thread.TestDeadLock<span class=nv>$$</span>Lambda<span class=nv>$2</span>/883049899.run<span class=o>(</span>Unknown Source<span class=o>)</span>
</span></span><span class=line><span class=cl>         at java.lang.Thread.run<span class=o>(</span>Thread.java:745<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;Thread-0&#34;</span>:
</span></span><span class=line><span class=cl>         at thread.TestDeadLock.lambda<span class=nv>$main$0</span><span class=o>(</span>TestDeadLock.java:15<span class=o>)</span>
</span></span><span class=line><span class=cl>         - waiting to lock &lt;0x000000076b5bf1d0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>         - locked &lt;0x000000076b5bf1c0&gt; <span class=o>(</span>a java.lang.Object<span class=o>)</span>
</span></span><span class=line><span class=cl>         at thread.TestDeadLock<span class=nv>$$</span>Lambda<span class=nv>$1</span>/495053715.run<span class=o>(</span>Unknown Source<span class=o>)</span>
</span></span><span class=line><span class=cl>         at java.lang.Thread.run<span class=o>(</span>Thread.java:745<span class=o>)</span>
</span></span><span class=line><span class=cl>Found <span class=m>1</span> deadlock.
</span></span></code></pre></td></tr></table></div></div><ul><li>é¿å…æ­»é”è¦æ³¨æ„åŠ é”é¡ºåº</li><li>å¦å¤–å¦‚æœç”±äºæŸä¸ªçº¿ç¨‹è¿›å…¥äº†æ­»å¾ªç¯ï¼Œå¯¼è‡´å…¶å®ƒçº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œå¯¹äºè¿™ç§æƒ…å†µ linux ä¸‹å¯ä»¥é€šè¿‡ top å…ˆå®šä½åˆ° CPU å ç”¨é«˜çš„ Java è¿›ç¨‹ï¼Œå†åˆ©ç”¨ top -Hp è¿›ç¨‹id æ¥å®šä½æ˜¯å“ªä¸ªçº¿ç¨‹ï¼Œæœ€åå†ç”¨ jstack æ’æŸ¥</li></ul><h5 id=æ´»é”><a href=#%e6%b4%bb%e9%94%81 class=header-anchor>#</a>
<strong>æ´»é”</strong></h5><p>æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸï¼Œä¾‹å¦‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-198-1><a class=lnlinks href=#hl-198-1> 1</a>
</span><span class=lnt id=hl-198-2><a class=lnlinks href=#hl-198-2> 2</a>
</span><span class=lnt id=hl-198-3><a class=lnlinks href=#hl-198-3> 3</a>
</span><span class=lnt id=hl-198-4><a class=lnlinks href=#hl-198-4> 4</a>
</span><span class=lnt id=hl-198-5><a class=lnlinks href=#hl-198-5> 5</a>
</span><span class=lnt id=hl-198-6><a class=lnlinks href=#hl-198-6> 6</a>
</span><span class=lnt id=hl-198-7><a class=lnlinks href=#hl-198-7> 7</a>
</span><span class=lnt id=hl-198-8><a class=lnlinks href=#hl-198-8> 8</a>
</span><span class=lnt id=hl-198-9><a class=lnlinks href=#hl-198-9> 9</a>
</span><span class=lnt id=hl-198-10><a class=lnlinks href=#hl-198-10>10</a>
</span><span class=lnt id=hl-198-11><a class=lnlinks href=#hl-198-11>11</a>
</span><span class=lnt id=hl-198-12><a class=lnlinks href=#hl-198-12>12</a>
</span><span class=lnt id=hl-198-13><a class=lnlinks href=#hl-198-13>13</a>
</span><span class=lnt id=hl-198-14><a class=lnlinks href=#hl-198-14>14</a>
</span><span class=lnt id=hl-198-15><a class=lnlinks href=#hl-198-15>15</a>
</span><span class=lnt id=hl-198-16><a class=lnlinks href=#hl-198-16>16</a>
</span><span class=lnt id=hl-198-17><a class=lnlinks href=#hl-198-17>17</a>
</span><span class=lnt id=hl-198-18><a class=lnlinks href=#hl-198-18>18</a>
</span><span class=lnt id=hl-198-19><a class=lnlinks href=#hl-198-19>19</a>
</span><span class=lnt id=hl-198-20><a class=lnlinks href=#hl-198-20>20</a>
</span><span class=lnt id=hl-198-21><a class=lnlinks href=#hl-198-21>21</a>
</span><span class=lnt id=hl-198-22><a class=lnlinks href=#hl-198-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestLiveLock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æœŸæœ›å‡åˆ° 0 é€€å‡ºå¾ªç¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>count</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;count: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æœŸæœ›è¶…è¿‡ 20 é€€å‡ºå¾ªç¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>20</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;count: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è§£å†³æ–¹å¼ï¼š</p><ul><li>é”™å¼€çº¿ç¨‹çš„è¿è¡Œæ—¶é—´ï¼Œä½¿å¾—ä¸€æ–¹ä¸èƒ½æ”¹å˜å¦ä¸€æ–¹çš„ç»“æŸæ¡ä»¶ã€‚</li><li>å°†ç¡çœ æ—¶é—´è°ƒæ•´ä¸ºéšæœºæ•°ã€‚</li></ul><h5 id=é¥¥é¥¿><a href=#%e9%a5%a5%e9%a5%bf class=header-anchor>#</a>
<strong>é¥¥é¥¿</strong></h5><p>å¾ˆå¤šæ•™ç¨‹ä¸­æŠŠé¥¥é¥¿å®šä¹‰ä¸ºï¼Œä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ° CPU è°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸï¼Œé¥¥é¥¿çš„æƒ…å†µä¸æ˜“æ¼”ç¤ºï¼Œè®²è¯»å†™é”æ—¶ä¼šæ¶‰åŠé¥¥é¥¿é—®é¢˜</p><p>ä¸‹é¢æˆ‘è®²ä¸€ä¸‹æˆ‘é‡åˆ°çš„ä¸€ä¸ªçº¿ç¨‹é¥¥é¥¿çš„ä¾‹å­ï¼Œå…ˆæ¥çœ‹çœ‹ä½¿ç”¨é¡ºåºåŠ é”çš„æ–¹å¼è§£å†³ä¹‹å‰çš„æ­»é”é—®é¢˜</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304205818794.png width=900 height=600 loading=lazy decoding=async alt=image-20220304205818794 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>é¡ºåºåŠ é”çš„è§£å†³æ–¹æ¡ˆ</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220304205837519.png width=900 height=600 loading=lazy decoding=async alt=image-20220304205837519 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>è¯´æ˜ï¼š</p><ul><li>é¡ºåºåŠ é”å¯ä»¥è§£å†³æ­»é”é—®é¢˜ï¼Œä½†ä¹Ÿä¼šå¯¼è‡´ä¸€äº›çº¿ç¨‹ä¸€ç›´å¾—ä¸åˆ°é”ï¼Œäº§ç”Ÿé¥¥é¥¿ç°è±¡ã€‚</li><li>è§£å†³æ–¹å¼ï¼šReentrantLock</li></ul><h2 id=413-reentrantlock><a href=#413-reentrantlock class=header-anchor>#</a>
4.13 ReentrantLock</h2><p>ç›¸å¯¹äº synchronized å®ƒå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹</p><ul><li>å¯ä¸­æ–­</li><li>å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´</li><li>å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”</li><li>æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</li></ul><p>ä¸ synchronized ä¸€æ ·ï¼Œéƒ½æ”¯æŒå¯é‡å…¥</p><p>åŸºæœ¬è¯­æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-199-1><a class=lnlinks href=#hl-199-1>1</a>
</span><span class=lnt id=hl-199-2><a class=lnlinks href=#hl-199-2>2</a>
</span><span class=lnt id=hl-199-3><a class=lnlinks href=#hl-199-3>3</a>
</span><span class=lnt id=hl-199-4><a class=lnlinks href=#hl-199-4>4</a>
</span><span class=lnt id=hl-199-5><a class=lnlinks href=#hl-199-5>5</a>
</span><span class=lnt id=hl-199-6><a class=lnlinks href=#hl-199-6>6</a>
</span><span class=lnt id=hl-199-7><a class=lnlinks href=#hl-199-7>7</a>
</span><span class=lnt id=hl-199-8><a class=lnlinks href=#hl-199-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// è·å–é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>reentrantLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c1>// ä¸´ç•ŒåŒº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c1>// é‡Šæ”¾é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>reentrantLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=å¯é‡å…¥><a href=#%e5%8f%af%e9%87%8d%e5%85%a5 class=header-anchor>#</a>
å¯é‡å…¥</h4><p>å¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå› ä¸ºå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé” å¦‚æœæ˜¯ä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-200-1><a class=lnlinks href=#hl-200-1> 1</a>
</span><span class=lnt id=hl-200-2><a class=lnlinks href=#hl-200-2> 2</a>
</span><span class=lnt id=hl-200-3><a class=lnlinks href=#hl-200-3> 3</a>
</span><span class=lnt id=hl-200-4><a class=lnlinks href=#hl-200-4> 4</a>
</span><span class=lnt id=hl-200-5><a class=lnlinks href=#hl-200-5> 5</a>
</span><span class=lnt id=hl-200-6><a class=lnlinks href=#hl-200-6> 6</a>
</span><span class=lnt id=hl-200-7><a class=lnlinks href=#hl-200-7> 7</a>
</span><span class=lnt id=hl-200-8><a class=lnlinks href=#hl-200-8> 8</a>
</span><span class=lnt id=hl-200-9><a class=lnlinks href=#hl-200-9> 9</a>
</span><span class=lnt id=hl-200-10><a class=lnlinks href=#hl-200-10>10</a>
</span><span class=lnt id=hl-200-11><a class=lnlinks href=#hl-200-11>11</a>
</span><span class=lnt id=hl-200-12><a class=lnlinks href=#hl-200-12>12</a>
</span><span class=lnt id=hl-200-13><a class=lnlinks href=#hl-200-13>13</a>
</span><span class=lnt id=hl-200-14><a class=lnlinks href=#hl-200-14>14</a>
</span><span class=lnt id=hl-200-15><a class=lnlinks href=#hl-200-15>15</a>
</span><span class=lnt id=hl-200-16><a class=lnlinks href=#hl-200-16>16</a>
</span><span class=lnt id=hl-200-17><a class=lnlinks href=#hl-200-17>17</a>
</span><span class=lnt id=hl-200-18><a class=lnlinks href=#hl-200-18>18</a>
</span><span class=lnt id=hl-200-19><a class=lnlinks href=#hl-200-19>19</a>
</span><span class=lnt id=hl-200-20><a class=lnlinks href=#hl-200-20>20</a>
</span><span class=lnt id=hl-200-21><a class=lnlinks href=#hl-200-21>21</a>
</span><span class=lnt id=hl-200-22><a class=lnlinks href=#hl-200-22>22</a>
</span><span class=lnt id=hl-200-23><a class=lnlinks href=#hl-200-23>23</a>
</span><span class=lnt id=hl-200-24><a class=lnlinks href=#hl-200-24>24</a>
</span><span class=lnt id=hl-200-25><a class=lnlinks href=#hl-200-25>25</a>
</span><span class=lnt id=hl-200-26><a class=lnlinks href=#hl-200-26>26</a>
</span><span class=lnt id=hl-200-27><a class=lnlinks href=#hl-200-27>27</a>
</span><span class=lnt id=hl-200-28><a class=lnlinks href=#hl-200-28>28</a>
</span><span class=lnt id=hl-200-29><a class=lnlinks href=#hl-200-29>29</a>
</span><span class=lnt id=hl-200-30><a class=lnlinks href=#hl-200-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>method1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;execute method1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>method2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;execute method2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>method3</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;execute method3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-201-1><a class=lnlinks href=#hl-201-1>1</a>
</span><span class=lnt id=hl-201-2><a class=lnlinks href=#hl-201-2>2</a>
</span><span class=lnt id=hl-201-3><a class=lnlinks href=#hl-201-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>17:59:11.862 <span class=o>[</span>main<span class=o>]</span> c.TestReentrant - execute method1 
</span></span><span class=line><span class=cl>17:59:11.865 <span class=o>[</span>main<span class=o>]</span> c.TestReentrant - execute method2 
</span></span><span class=line><span class=cl>17:59:11.865 <span class=o>[</span>main<span class=o>]</span> c.TestReentrant - execute method3
</span></span></code></pre></td></tr></table></div></div><h4 id=å¯æ‰“æ–­><a href=#%e5%8f%af%e6%89%93%e6%96%ad class=header-anchor>#</a>
å¯æ‰“æ–­</h4><p>å¯æ‰“æ–­æŒ‡çš„æ˜¯å¤„äºé˜»å¡çŠ¶æ€ç­‰å¾…é”çš„çº¿ç¨‹å¯ä»¥è¢«æ‰“æ–­ç­‰å¾…ã€‚æ³¨æ„<code>lock.lockInterruptibly()</code>å’Œ<code>lock.trylock()</code>æ–¹æ³•æ˜¯å¯æ‰“æ–­çš„,<code>lock.lock()</code>ä¸æ˜¯ã€‚å¯æ‰“æ–­çš„æ„ä¹‰åœ¨äºé¿å…å¾—ä¸åˆ°é”çš„çº¿ç¨‹æ— é™åˆ¶åœ°ç­‰å¾…ä¸‹å»ï¼Œé˜²æ­¢æ­»é”çš„ä¸€ç§æ–¹å¼ã€‚</p><p>ç¤ºä¾‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-202-1><a class=lnlinks href=#hl-202-1> 1</a>
</span><span class=lnt id=hl-202-2><a class=lnlinks href=#hl-202-2> 2</a>
</span><span class=lnt id=hl-202-3><a class=lnlinks href=#hl-202-3> 3</a>
</span><span class=lnt id=hl-202-4><a class=lnlinks href=#hl-202-4> 4</a>
</span><span class=lnt id=hl-202-5><a class=lnlinks href=#hl-202-5> 5</a>
</span><span class=lnt id=hl-202-6><a class=lnlinks href=#hl-202-6> 6</a>
</span><span class=lnt id=hl-202-7><a class=lnlinks href=#hl-202-7> 7</a>
</span><span class=lnt id=hl-202-8><a class=lnlinks href=#hl-202-8> 8</a>
</span><span class=lnt id=hl-202-9><a class=lnlinks href=#hl-202-9> 9</a>
</span><span class=lnt id=hl-202-10><a class=lnlinks href=#hl-202-10>10</a>
</span><span class=lnt id=hl-202-11><a class=lnlinks href=#hl-202-11>11</a>
</span><span class=lnt id=hl-202-12><a class=lnlinks href=#hl-202-12>12</a>
</span><span class=lnt id=hl-202-13><a class=lnlinks href=#hl-202-13>13</a>
</span><span class=lnt id=hl-202-14><a class=lnlinks href=#hl-202-14>14</a>
</span><span class=lnt id=hl-202-15><a class=lnlinks href=#hl-202-15>15</a>
</span><span class=lnt id=hl-202-16><a class=lnlinks href=#hl-202-16>16</a>
</span><span class=lnt id=hl-202-17><a class=lnlinks href=#hl-202-17>17</a>
</span><span class=lnt id=hl-202-18><a class=lnlinks href=#hl-202-18>18</a>
</span><span class=lnt id=hl-202-19><a class=lnlinks href=#hl-202-19>19</a>
</span><span class=lnt id=hl-202-20><a class=lnlinks href=#hl-202-20>20</a>
</span><span class=lnt id=hl-202-21><a class=lnlinks href=#hl-202-21>21</a>
</span><span class=lnt id=hl-202-22><a class=lnlinks href=#hl-202-22>22</a>
</span><span class=lnt id=hl-202-23><a class=lnlinks href=#hl-202-23>23</a>
</span><span class=lnt id=hl-202-24><a class=lnlinks href=#hl-202-24>24</a>
</span><span class=lnt id=hl-202-25><a class=lnlinks href=#hl-202-25>25</a>
</span><span class=lnt id=hl-202-26><a class=lnlinks href=#hl-202-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¯åŠ¨...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lockInterruptibly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç­‰é”çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å¾—äº†é”&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å¾—äº†é”&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‰§è¡Œæ‰“æ–­&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-203-1><a class=lnlinks href=#hl-203-1> 1</a>
</span><span class=lnt id=hl-203-2><a class=lnlinks href=#hl-203-2> 2</a>
</span><span class=lnt id=hl-203-3><a class=lnlinks href=#hl-203-3> 3</a>
</span><span class=lnt id=hl-203-4><a class=lnlinks href=#hl-203-4> 4</a>
</span><span class=lnt id=hl-203-5><a class=lnlinks href=#hl-203-5> 5</a>
</span><span class=lnt id=hl-203-6><a class=lnlinks href=#hl-203-6> 6</a>
</span><span class=lnt id=hl-203-7><a class=lnlinks href=#hl-203-7> 7</a>
</span><span class=lnt id=hl-203-8><a class=lnlinks href=#hl-203-8> 8</a>
</span><span class=lnt id=hl-203-9><a class=lnlinks href=#hl-203-9> 9</a>
</span><span class=lnt id=hl-203-10><a class=lnlinks href=#hl-203-10>10</a>
</span><span class=lnt id=hl-203-11><a class=lnlinks href=#hl-203-11>11</a>
</span><span class=lnt id=hl-203-12><a class=lnlinks href=#hl-203-12>12</a>
</span><span class=lnt id=hl-203-13><a class=lnlinks href=#hl-203-13>13</a>
</span><span class=lnt id=hl-203-14><a class=lnlinks href=#hl-203-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:02:40.520 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - è·å¾—äº†é”
</span></span><span class=line><span class=cl>18:02:40.524 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - å¯åŠ¨... 
</span></span><span class=line><span class=cl>18:02:41.530 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - æ‰§è¡Œæ‰“æ–­
</span></span><span class=line><span class=cl>java.lang.InterruptedException 
</span></span><span class=line><span class=cl> 		at 
</span></span><span class=line><span class=cl>java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly<span class=o>(</span>AbstractQueuedSynchr
</span></span><span class=line><span class=cl>onizer.java:898<span class=o>)</span> 
</span></span><span class=line><span class=cl> 		at 
</span></span><span class=line><span class=cl>java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly<span class=o>(</span>AbstractQueuedSynchron
</span></span><span class=line><span class=cl>izer.java:1222<span class=o>)</span> 
</span></span><span class=line><span class=cl> 		at java.util.concurrent.locks.ReentrantLock.lockInterruptibly<span class=o>(</span>ReentrantLock.java:335<span class=o>)</span> 
</span></span><span class=line><span class=cl> 		at cn.itcast.n4.reentrant.TestInterrupt.lambda<span class=nv>$main$0</span><span class=o>(</span>TestInterrupt.java:17<span class=o>)</span> 
</span></span><span class=line><span class=cl> 		at java.lang.Thread.run<span class=o>(</span>Thread.java:748<span class=o>)</span> 
</span></span><span class=line><span class=cl>18:02:41.532 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - ç­‰é”çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„å¦‚æœæ˜¯ä¸å¯ä¸­æ–­æ¨¡å¼ï¼Œé‚£ä¹ˆå³ä½¿ä½¿ç”¨äº† interrupt ä¹Ÿä¸ä¼šè®©ç­‰å¾…ä¸­æ–­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-204-1><a class=lnlinks href=#hl-204-1> 1</a>
</span><span class=lnt id=hl-204-2><a class=lnlinks href=#hl-204-2> 2</a>
</span><span class=lnt id=hl-204-3><a class=lnlinks href=#hl-204-3> 3</a>
</span><span class=lnt id=hl-204-4><a class=lnlinks href=#hl-204-4> 4</a>
</span><span class=lnt id=hl-204-5><a class=lnlinks href=#hl-204-5> 5</a>
</span><span class=lnt id=hl-204-6><a class=lnlinks href=#hl-204-6> 6</a>
</span><span class=lnt id=hl-204-7><a class=lnlinks href=#hl-204-7> 7</a>
</span><span class=lnt id=hl-204-8><a class=lnlinks href=#hl-204-8> 8</a>
</span><span class=lnt id=hl-204-9><a class=lnlinks href=#hl-204-9> 9</a>
</span><span class=lnt id=hl-204-10><a class=lnlinks href=#hl-204-10>10</a>
</span><span class=lnt id=hl-204-11><a class=lnlinks href=#hl-204-11>11</a>
</span><span class=lnt id=hl-204-12><a class=lnlinks href=#hl-204-12>12</a>
</span><span class=lnt id=hl-204-13><a class=lnlinks href=#hl-204-13>13</a>
</span><span class=lnt id=hl-204-14><a class=lnlinks href=#hl-204-14>14</a>
</span><span class=lnt id=hl-204-15><a class=lnlinks href=#hl-204-15>15</a>
</span><span class=lnt id=hl-204-16><a class=lnlinks href=#hl-204-16>16</a>
</span><span class=lnt id=hl-204-17><a class=lnlinks href=#hl-204-17>17</a>
</span><span class=lnt id=hl-204-18><a class=lnlinks href=#hl-204-18>18</a>
</span><span class=lnt id=hl-204-19><a class=lnlinks href=#hl-204-19>19</a>
</span><span class=lnt id=hl-204-20><a class=lnlinks href=#hl-204-20>20</a>
</span><span class=lnt id=hl-204-21><a class=lnlinks href=#hl-204-21>21</a>
</span><span class=lnt id=hl-204-22><a class=lnlinks href=#hl-204-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¯åŠ¨...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å¾—äº†é”&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å¾—äº†é”&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‰§è¡Œæ‰“æ–­&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;é‡Šæ”¾äº†é”&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-205-1><a class=lnlinks href=#hl-205-1>1</a>
</span><span class=lnt id=hl-205-2><a class=lnlinks href=#hl-205-2>2</a>
</span><span class=lnt id=hl-205-3><a class=lnlinks href=#hl-205-3>3</a>
</span><span class=lnt id=hl-205-4><a class=lnlinks href=#hl-205-4>4</a>
</span><span class=lnt id=hl-205-5><a class=lnlinks href=#hl-205-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:06:56.261 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - è·å¾—äº†é”
</span></span><span class=line><span class=cl>18:06:56.265 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - å¯åŠ¨... 
</span></span><span class=line><span class=cl>18:06:57.266 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - æ‰§è¡Œæ‰“æ–­ // è¿™æ—¶ t1 å¹¶æ²¡æœ‰è¢«çœŸæ­£æ‰“æ–­, è€Œæ˜¯ä»ç»§ç»­ç­‰å¾…é”
</span></span><span class=line><span class=cl>18:06:58.267 <span class=o>[</span>main<span class=o>]</span> c.TestInterrupt - é‡Šæ”¾äº†é”
</span></span><span class=line><span class=cl>18:06:58.267 <span class=o>[</span>t1<span class=o>]</span> c.TestInterrupt - è·å¾—äº†é”
</span></span></code></pre></td></tr></table></div></div><h4 id=é”è¶…æ—¶><a href=#%e9%94%81%e8%b6%85%e6%97%b6 class=header-anchor>#</a>
é”è¶…æ—¶</h4><p>ç«‹åˆ»å¤±è´¥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-206-1><a class=lnlinks href=#hl-206-1> 1</a>
</span><span class=lnt id=hl-206-2><a class=lnlinks href=#hl-206-2> 2</a>
</span><span class=lnt id=hl-206-3><a class=lnlinks href=#hl-206-3> 3</a>
</span><span class=lnt id=hl-206-4><a class=lnlinks href=#hl-206-4> 4</a>
</span><span class=lnt id=hl-206-5><a class=lnlinks href=#hl-206-5> 5</a>
</span><span class=lnt id=hl-206-6><a class=lnlinks href=#hl-206-6> 6</a>
</span><span class=lnt id=hl-206-7><a class=lnlinks href=#hl-206-7> 7</a>
</span><span class=lnt id=hl-206-8><a class=lnlinks href=#hl-206-8> 8</a>
</span><span class=lnt id=hl-206-9><a class=lnlinks href=#hl-206-9> 9</a>
</span><span class=lnt id=hl-206-10><a class=lnlinks href=#hl-206-10>10</a>
</span><span class=lnt id=hl-206-11><a class=lnlinks href=#hl-206-11>11</a>
</span><span class=lnt id=hl-206-12><a class=lnlinks href=#hl-206-12>12</a>
</span><span class=lnt id=hl-206-13><a class=lnlinks href=#hl-206-13>13</a>
</span><span class=lnt id=hl-206-14><a class=lnlinks href=#hl-206-14>14</a>
</span><span class=lnt id=hl-206-15><a class=lnlinks href=#hl-206-15>15</a>
</span><span class=lnt id=hl-206-16><a class=lnlinks href=#hl-206-16>16</a>
</span><span class=lnt id=hl-206-17><a class=lnlinks href=#hl-206-17>17</a>
</span><span class=lnt id=hl-206-18><a class=lnlinks href=#hl-206-18>18</a>
</span><span class=lnt id=hl-206-19><a class=lnlinks href=#hl-206-19>19</a>
</span><span class=lnt id=hl-206-20><a class=lnlinks href=#hl-206-20>20</a>
</span><span class=lnt id=hl-206-21><a class=lnlinks href=#hl-206-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¯åŠ¨...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>lock</span><span class=p>.</span><span class=na>tryLock</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å–ç«‹åˆ»å¤±è´¥ï¼Œè¿”å›&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å¾—äº†é”&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å¾—äº†é”&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-207-1><a class=lnlinks href=#hl-207-1>1</a>
</span><span class=lnt id=hl-207-2><a class=lnlinks href=#hl-207-2>2</a>
</span><span class=lnt id=hl-207-3><a class=lnlinks href=#hl-207-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:15:02.918 <span class=o>[</span>main<span class=o>]</span> c.TestTimeout - è·å¾—äº†é”
</span></span><span class=line><span class=cl>18:15:02.921 <span class=o>[</span>t1<span class=o>]</span> c.TestTimeout - å¯åŠ¨... 
</span></span><span class=line><span class=cl>18:15:02.921 <span class=o>[</span>t1<span class=o>]</span> c.TestTimeout - è·å–ç«‹åˆ»å¤±è´¥ï¼Œè¿”å›
</span></span></code></pre></td></tr></table></div></div><p>è¶…æ—¶å¤±è´¥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-208-1><a class=lnlinks href=#hl-208-1> 1</a>
</span><span class=lnt id=hl-208-2><a class=lnlinks href=#hl-208-2> 2</a>
</span><span class=lnt id=hl-208-3><a class=lnlinks href=#hl-208-3> 3</a>
</span><span class=lnt id=hl-208-4><a class=lnlinks href=#hl-208-4> 4</a>
</span><span class=lnt id=hl-208-5><a class=lnlinks href=#hl-208-5> 5</a>
</span><span class=lnt id=hl-208-6><a class=lnlinks href=#hl-208-6> 6</a>
</span><span class=lnt id=hl-208-7><a class=lnlinks href=#hl-208-7> 7</a>
</span><span class=lnt id=hl-208-8><a class=lnlinks href=#hl-208-8> 8</a>
</span><span class=lnt id=hl-208-9><a class=lnlinks href=#hl-208-9> 9</a>
</span><span class=lnt id=hl-208-10><a class=lnlinks href=#hl-208-10>10</a>
</span><span class=lnt id=hl-208-11><a class=lnlinks href=#hl-208-11>11</a>
</span><span class=lnt id=hl-208-12><a class=lnlinks href=#hl-208-12>12</a>
</span><span class=lnt id=hl-208-13><a class=lnlinks href=#hl-208-13>13</a>
</span><span class=lnt id=hl-208-14><a class=lnlinks href=#hl-208-14>14</a>
</span><span class=lnt id=hl-208-15><a class=lnlinks href=#hl-208-15>15</a>
</span><span class=lnt id=hl-208-16><a class=lnlinks href=#hl-208-16>16</a>
</span><span class=lnt id=hl-208-17><a class=lnlinks href=#hl-208-17>17</a>
</span><span class=lnt id=hl-208-18><a class=lnlinks href=#hl-208-18>18</a>
</span><span class=lnt id=hl-208-19><a class=lnlinks href=#hl-208-19>19</a>
</span><span class=lnt id=hl-208-20><a class=lnlinks href=#hl-208-20>20</a>
</span><span class=lnt id=hl-208-21><a class=lnlinks href=#hl-208-21>21</a>
</span><span class=lnt id=hl-208-22><a class=lnlinks href=#hl-208-22>22</a>
</span><span class=lnt id=hl-208-23><a class=lnlinks href=#hl-208-23>23</a>
</span><span class=lnt id=hl-208-24><a class=lnlinks href=#hl-208-24>24</a>
</span><span class=lnt id=hl-208-25><a class=lnlinks href=#hl-208-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¯åŠ¨...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>lock</span><span class=p>.</span><span class=na>tryLock</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å–ç­‰å¾… 1s åå¤±è´¥ï¼Œè¿”å›&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å¾—äº†é”&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å¾—äº†é”&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-209-1><a class=lnlinks href=#hl-209-1>1</a>
</span><span class=lnt id=hl-209-2><a class=lnlinks href=#hl-209-2>2</a>
</span><span class=lnt id=hl-209-3><a class=lnlinks href=#hl-209-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:19:40.537 <span class=o>[</span>main<span class=o>]</span> c.TestTimeout - è·å¾—äº†é”
</span></span><span class=line><span class=cl>18:19:40.544 <span class=o>[</span>t1<span class=o>]</span> c.TestTimeout - å¯åŠ¨... 
</span></span><span class=line><span class=cl>18:19:41.547 <span class=o>[</span>t1<span class=o>]</span> c.TestTimeout - è·å–ç­‰å¾… 1s åå¤±è´¥ï¼Œè¿”å›
</span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨ tryLock è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-210-1><a class=lnlinks href=#hl-210-1> 1</a>
</span><span class=lnt id=hl-210-2><a class=lnlinks href=#hl-210-2> 2</a>
</span><span class=lnt id=hl-210-3><a class=lnlinks href=#hl-210-3> 3</a>
</span><span class=lnt id=hl-210-4><a class=lnlinks href=#hl-210-4> 4</a>
</span><span class=lnt id=hl-210-5><a class=lnlinks href=#hl-210-5> 5</a>
</span><span class=lnt id=hl-210-6><a class=lnlinks href=#hl-210-6> 6</a>
</span><span class=lnt id=hl-210-7><a class=lnlinks href=#hl-210-7> 7</a>
</span><span class=lnt id=hl-210-8><a class=lnlinks href=#hl-210-8> 8</a>
</span><span class=lnt id=hl-210-9><a class=lnlinks href=#hl-210-9> 9</a>
</span><span class=lnt id=hl-210-10><a class=lnlinks href=#hl-210-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Chopstick</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Chopstick</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;ç­·å­{&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=sc>&#39;}&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-211-1><a class=lnlinks href=#hl-211-1> 1</a>
</span><span class=lnt id=hl-211-2><a class=lnlinks href=#hl-211-2> 2</a>
</span><span class=lnt id=hl-211-3><a class=lnlinks href=#hl-211-3> 3</a>
</span><span class=lnt id=hl-211-4><a class=lnlinks href=#hl-211-4> 4</a>
</span><span class=lnt id=hl-211-5><a class=lnlinks href=#hl-211-5> 5</a>
</span><span class=lnt id=hl-211-6><a class=lnlinks href=#hl-211-6> 6</a>
</span><span class=lnt id=hl-211-7><a class=lnlinks href=#hl-211-7> 7</a>
</span><span class=lnt id=hl-211-8><a class=lnlinks href=#hl-211-8> 8</a>
</span><span class=lnt id=hl-211-9><a class=lnlinks href=#hl-211-9> 9</a>
</span><span class=lnt id=hl-211-10><a class=lnlinks href=#hl-211-10>10</a>
</span><span class=lnt id=hl-211-11><a class=lnlinks href=#hl-211-11>11</a>
</span><span class=lnt id=hl-211-12><a class=lnlinks href=#hl-211-12>12</a>
</span><span class=lnt id=hl-211-13><a class=lnlinks href=#hl-211-13>13</a>
</span><span class=lnt id=hl-211-14><a class=lnlinks href=#hl-211-14>14</a>
</span><span class=lnt id=hl-211-15><a class=lnlinks href=#hl-211-15>15</a>
</span><span class=lnt id=hl-211-16><a class=lnlinks href=#hl-211-16>16</a>
</span><span class=lnt id=hl-211-17><a class=lnlinks href=#hl-211-17>17</a>
</span><span class=lnt id=hl-211-18><a class=lnlinks href=#hl-211-18>18</a>
</span><span class=lnt id=hl-211-19><a class=lnlinks href=#hl-211-19>19</a>
</span><span class=lnt id=hl-211-20><a class=lnlinks href=#hl-211-20>20</a>
</span><span class=lnt id=hl-211-21><a class=lnlinks href=#hl-211-21>21</a>
</span><span class=lnt id=hl-211-22><a class=lnlinks href=#hl-211-22>22</a>
</span><span class=lnt id=hl-211-23><a class=lnlinks href=#hl-211-23>23</a>
</span><span class=lnt id=hl-211-24><a class=lnlinks href=#hl-211-24>24</a>
</span><span class=lnt id=hl-211-25><a class=lnlinks href=#hl-211-25>25</a>
</span><span class=lnt id=hl-211-26><a class=lnlinks href=#hl-211-26>26</a>
</span><span class=lnt id=hl-211-27><a class=lnlinks href=#hl-211-27>27</a>
</span><span class=lnt id=hl-211-28><a class=lnlinks href=#hl-211-28>28</a>
</span><span class=lnt id=hl-211-29><a class=lnlinks href=#hl-211-29>29</a>
</span><span class=lnt id=hl-211-30><a class=lnlinks href=#hl-211-30>30</a>
</span><span class=lnt id=hl-211-31><a class=lnlinks href=#hl-211-31>31</a>
</span><span class=lnt id=hl-211-32><a class=lnlinks href=#hl-211-32>32</a>
</span><span class=lnt id=hl-211-33><a class=lnlinks href=#hl-211-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Philosopher</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Chopstick</span><span class=w> </span><span class=n>left</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Chopstick</span><span class=w> </span><span class=n>right</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Philosopher</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>Chopstick</span><span class=w> </span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>Chopstick</span><span class=w> </span><span class=n>right</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>left</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>left</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>right</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>right</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°è¯•è·å¾—å·¦æ‰‹ç­·å­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>left</span><span class=p>.</span><span class=na>tryLock</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å°è¯•è·å¾—å³æ‰‹ç­·å­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>right</span><span class=p>.</span><span class=na>tryLock</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>eat</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>right</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>left</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>eat</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;eating...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Sleeper</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=å…¬å¹³é”><a href=#%e5%85%ac%e5%b9%b3%e9%94%81 class=header-anchor>#</a>
å…¬å¹³é”</h4><p>ReentrantLock é»˜è®¤æ˜¯ä¸å…¬å¹³çš„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-212-1><a class=lnlinks href=#hl-212-1> 1</a>
</span><span class=lnt id=hl-212-2><a class=lnlinks href=#hl-212-2> 2</a>
</span><span class=lnt id=hl-212-3><a class=lnlinks href=#hl-212-3> 3</a>
</span><span class=lnt id=hl-212-4><a class=lnlinks href=#hl-212-4> 4</a>
</span><span class=lnt id=hl-212-5><a class=lnlinks href=#hl-212-5> 5</a>
</span><span class=lnt id=hl-212-6><a class=lnlinks href=#hl-212-6> 6</a>
</span><span class=lnt id=hl-212-7><a class=lnlinks href=#hl-212-7> 7</a>
</span><span class=lnt id=hl-212-8><a class=lnlinks href=#hl-212-8> 8</a>
</span><span class=lnt id=hl-212-9><a class=lnlinks href=#hl-212-9> 9</a>
</span><span class=lnt id=hl-212-10><a class=lnlinks href=#hl-212-10>10</a>
</span><span class=lnt id=hl-212-11><a class=lnlinks href=#hl-212-11>11</a>
</span><span class=lnt id=hl-212-12><a class=lnlinks href=#hl-212-12>12</a>
</span><span class=lnt id=hl-212-13><a class=lnlinks href=#hl-212-13>13</a>
</span><span class=lnt id=hl-212-14><a class=lnlinks href=#hl-212-14>14</a>
</span><span class=lnt id=hl-212-15><a class=lnlinks href=#hl-212-15>15</a>
</span><span class=lnt id=hl-212-16><a class=lnlinks href=#hl-212-16>16</a>
</span><span class=lnt id=hl-212-17><a class=lnlinks href=#hl-212-17>17</a>
</span><span class=lnt id=hl-212-18><a class=lnlinks href=#hl-212-18>18</a>
</span><span class=lnt id=hl-212-19><a class=lnlinks href=#hl-212-19>19</a>
</span><span class=lnt id=hl-212-20><a class=lnlinks href=#hl-212-20>20</a>
</span><span class=lnt id=hl-212-21><a class=lnlinks href=#hl-212-21>21</a>
</span><span class=lnt id=hl-212-22><a class=lnlinks href=#hl-212-22>22</a>
</span><span class=lnt id=hl-212-23><a class=lnlinks href=#hl-212-23>23</a>
</span><span class=lnt id=hl-212-24><a class=lnlinks href=#hl-212-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>500</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 1s ä¹‹åå»äº‰æŠ¢é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;å¼ºè¡Œæ’å…¥&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¼ºè¡Œæ’å…¥ï¼Œæœ‰æœºä¼šåœ¨ä¸­é—´è¾“å‡º</p><blockquote><p><strong>æ³¨æ„</strong>ï¼šè¯¥å®éªŒä¸ä¸€å®šæ€»èƒ½å¤ç°</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-213-1><a class=lnlinks href=#hl-213-1> 1</a>
</span><span class=lnt id=hl-213-2><a class=lnlinks href=#hl-213-2> 2</a>
</span><span class=lnt id=hl-213-3><a class=lnlinks href=#hl-213-3> 3</a>
</span><span class=lnt id=hl-213-4><a class=lnlinks href=#hl-213-4> 4</a>
</span><span class=lnt id=hl-213-5><a class=lnlinks href=#hl-213-5> 5</a>
</span><span class=lnt id=hl-213-6><a class=lnlinks href=#hl-213-6> 6</a>
</span><span class=lnt id=hl-213-7><a class=lnlinks href=#hl-213-7> 7</a>
</span><span class=lnt id=hl-213-8><a class=lnlinks href=#hl-213-8> 8</a>
</span><span class=lnt id=hl-213-9><a class=lnlinks href=#hl-213-9> 9</a>
</span><span class=lnt id=hl-213-10><a class=lnlinks href=#hl-213-10>10</a>
</span><span class=lnt id=hl-213-11><a class=lnlinks href=#hl-213-11>11</a>
</span><span class=lnt id=hl-213-12><a class=lnlinks href=#hl-213-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>t39 running... 
</span></span><span class=line><span class=cl>t40 running... 
</span></span><span class=line><span class=cl>t41 running... 
</span></span><span class=line><span class=cl>t42 running... 
</span></span><span class=line><span class=cl>t43 running... 
</span></span><span class=line><span class=cl>å¼ºè¡Œæ’å…¥ start... 
</span></span><span class=line><span class=cl>å¼ºè¡Œæ’å…¥ running... 
</span></span><span class=line><span class=cl>t44 running... 
</span></span><span class=line><span class=cl>t45 running... 
</span></span><span class=line><span class=cl>t46 running... 
</span></span><span class=line><span class=cl>t47 running... 
</span></span><span class=line><span class=cl>t49 running... 
</span></span></code></pre></td></tr></table></div></div><p>æ”¹ä¸ºå…¬å¹³é”å</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-214-1><a class=lnlinks href=#hl-214-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¼ºè¡Œæ’å…¥ï¼Œæ€»æ˜¯åœ¨æœ€åè¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-215-1><a class=lnlinks href=#hl-215-1> 1</a>
</span><span class=lnt id=hl-215-2><a class=lnlinks href=#hl-215-2> 2</a>
</span><span class=lnt id=hl-215-3><a class=lnlinks href=#hl-215-3> 3</a>
</span><span class=lnt id=hl-215-4><a class=lnlinks href=#hl-215-4> 4</a>
</span><span class=lnt id=hl-215-5><a class=lnlinks href=#hl-215-5> 5</a>
</span><span class=lnt id=hl-215-6><a class=lnlinks href=#hl-215-6> 6</a>
</span><span class=lnt id=hl-215-7><a class=lnlinks href=#hl-215-7> 7</a>
</span><span class=lnt id=hl-215-8><a class=lnlinks href=#hl-215-8> 8</a>
</span><span class=lnt id=hl-215-9><a class=lnlinks href=#hl-215-9> 9</a>
</span><span class=lnt id=hl-215-10><a class=lnlinks href=#hl-215-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>t465 running... 
</span></span><span class=line><span class=cl>t464 running... 
</span></span><span class=line><span class=cl>t477 running... 
</span></span><span class=line><span class=cl>t442 running... 
</span></span><span class=line><span class=cl>t468 running... 
</span></span><span class=line><span class=cl>t493 running... 
</span></span><span class=line><span class=cl>t482 running... 
</span></span><span class=line><span class=cl>t485 running... 
</span></span><span class=line><span class=cl>t481 running... 
</span></span><span class=line><span class=cl>å¼ºè¡Œæ’å…¥ running... 
</span></span></code></pre></td></tr></table></div></div><p>å…¬å¹³é”ä¸€èˆ¬æ²¡æœ‰å¿…è¦ï¼Œä¼šé™ä½å¹¶å‘åº¦ï¼Œåé¢åˆ†æåŸç†æ—¶ä¼šè®²è§£</p><h4 id=æ¡ä»¶å˜é‡><a href=#%e6%9d%a1%e4%bb%b6%e5%8f%98%e9%87%8f class=header-anchor>#</a>
æ¡ä»¶å˜é‡</h4><p>synchronized ä¸­ä¹Ÿæœ‰æ¡ä»¶å˜é‡ï¼Œå°±æ˜¯æˆ‘ä»¬è®²åŸç†æ—¶é‚£ä¸ª waitSet ä¼‘æ¯å®¤ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥ waitSet ç­‰å¾…</p><p>ReentrantLock çš„æ¡ä»¶å˜é‡æ¯” synchronized å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡çš„ï¼Œè¿™å°±å¥½æ¯”</p><ul><li>synchronized æ˜¯é‚£äº›ä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹éƒ½åœ¨ä¸€é—´ä¼‘æ¯å®¤ç­‰æ¶ˆæ¯</li><li>è€Œ ReentrantLock æ”¯æŒå¤šé—´ä¼‘æ¯å®¤ï¼Œæœ‰ä¸“é—¨ç­‰çƒŸçš„ä¼‘æ¯å®¤ã€ä¸“é—¨ç­‰æ—©é¤çš„ä¼‘æ¯å®¤ã€å”¤é†’æ—¶ä¹Ÿæ˜¯æŒ‰ä¼‘æ¯å®¤æ¥å”¤ é†’</li></ul><h5 id=ä½¿ç”¨è¦ç‚¹><a href=#%e4%bd%bf%e7%94%a8%e8%a6%81%e7%82%b9 class=header-anchor>#</a>
ä½¿ç”¨è¦ç‚¹</h5><ul><li>await å‰éœ€è¦è·å¾—é”</li><li>await æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥ conditionObject ç­‰å¾…</li><li>await çš„çº¿ç¨‹è¢«å”¤é†’ï¼ˆæˆ–æ‰“æ–­ã€æˆ–è¶…æ—¶ï¼‰å–é‡æ–°ç«äº‰ lock é”</li><li>ç«äº‰ lock é”æˆåŠŸåï¼Œä» await åç»§ç»­æ‰§è¡Œ</li></ul><h5 id=è¯¦ç»†api><a href=#%e8%af%a6%e7%bb%86api class=header-anchor>#</a>
è¯¦ç»†API</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-216-1><a class=lnlinks href=#hl-216-1> 1</a>
</span><span class=lnt id=hl-216-2><a class=lnlinks href=#hl-216-2> 2</a>
</span><span class=lnt id=hl-216-3><a class=lnlinks href=#hl-216-3> 3</a>
</span><span class=lnt id=hl-216-4><a class=lnlinks href=#hl-216-4> 4</a>
</span><span class=lnt id=hl-216-5><a class=lnlinks href=#hl-216-5> 5</a>
</span><span class=lnt id=hl-216-6><a class=lnlinks href=#hl-216-6> 6</a>
</span><span class=lnt id=hl-216-7><a class=lnlinks href=#hl-216-7> 7</a>
</span><span class=lnt id=hl-216-8><a class=lnlinks href=#hl-216-8> 8</a>
</span><span class=lnt id=hl-216-9><a class=lnlinks href=#hl-216-9> 9</a>
</span><span class=lnt id=hl-216-10><a class=lnlinks href=#hl-216-10>10</a>
</span><span class=lnt id=hl-216-11><a class=lnlinks href=#hl-216-11>11</a>
</span><span class=lnt id=hl-216-12><a class=lnlinks href=#hl-216-12>12</a>
</span><span class=lnt id=hl-216-13><a class=lnlinks href=#hl-216-13>13</a>
</span><span class=lnt id=hl-216-14><a class=lnlinks href=#hl-216-14>14</a>
</span><span class=lnt id=hl-216-15><a class=lnlinks href=#hl-216-15>15</a>
</span><span class=lnt id=hl-216-16><a class=lnlinks href=#hl-216-16>16</a>
</span><span class=lnt id=hl-216-17><a class=lnlinks href=#hl-216-17>17</a>
</span><span class=lnt id=hl-216-18><a class=lnlinks href=#hl-216-18>18</a>
</span><span class=lnt id=hl-216-19><a class=lnlinks href=#hl-216-19>19</a>
</span><span class=lnt id=hl-216-20><a class=lnlinks href=#hl-216-20>20</a>
</span><span class=lnt id=hl-216-21><a class=lnlinks href=#hl-216-21>21</a>
</span><span class=lnt id=hl-216-22><a class=lnlinks href=#hl-216-22>22</a>
</span><span class=lnt id=hl-216-23><a class=lnlinks href=#hl-216-23>23</a>
</span><span class=lnt id=hl-216-24><a class=lnlinks href=#hl-216-24>24</a>
</span><span class=lnt id=hl-216-25><a class=lnlinks href=#hl-216-25>25</a>
</span><span class=lnt id=hl-216-26><a class=lnlinks href=#hl-216-26>26</a>
</span><span class=lnt id=hl-216-27><a class=lnlinks href=#hl-216-27>27</a>
</span><span class=lnt id=hl-216-28><a class=lnlinks href=#hl-216-28>28</a>
</span><span class=lnt id=hl-216-29><a class=lnlinks href=#hl-216-29>29</a>
</span><span class=lnt id=hl-216-30><a class=lnlinks href=#hl-216-30>30</a>
</span><span class=lnt id=hl-216-31><a class=lnlinks href=#hl-216-31>31</a>
</span><span class=lnt id=hl-216-32><a class=lnlinks href=#hl-216-32>32</a>
</span><span class=lnt id=hl-216-33><a class=lnlinks href=#hl-216-33>33</a>
</span><span class=lnt id=hl-216-34><a class=lnlinks href=#hl-216-34>34</a>
</span><span class=lnt id=hl-216-35><a class=lnlinks href=#hl-216-35>35</a>
</span><span class=lnt id=hl-216-36><a class=lnlinks href=#hl-216-36>36</a>
</span><span class=lnt id=hl-216-37><a class=lnlinks href=#hl-216-37>37</a>
</span><span class=lnt id=hl-216-38><a class=lnlinks href=#hl-216-38>38</a>
</span><span class=lnt id=hl-216-39><a class=lnlinks href=#hl-216-39>39</a>
</span><span class=lnt id=hl-216-40><a class=lnlinks href=#hl-216-40>40</a>
</span><span class=lnt id=hl-216-41><a class=lnlinks href=#hl-216-41>41</a>
</span><span class=lnt id=hl-216-42><a class=lnlinks href=#hl-216-42>42</a>
</span><span class=lnt id=hl-216-43><a class=lnlinks href=#hl-216-43>43</a>
</span><span class=lnt id=hl-216-44><a class=lnlinks href=#hl-216-44>44</a>
</span><span class=lnt id=hl-216-45><a class=lnlinks href=#hl-216-45>45</a>
</span><span class=lnt id=hl-216-46><a class=lnlinks href=#hl-216-46>46</a>
</span><span class=lnt id=hl-216-47><a class=lnlinks href=#hl-216-47>47</a>
</span><span class=lnt id=hl-216-48><a class=lnlinks href=#hl-216-48>48</a>
</span><span class=lnt id=hl-216-49><a class=lnlinks href=#hl-216-49>49</a>
</span><span class=lnt id=hl-216-50><a class=lnlinks href=#hl-216-50>50</a>
</span><span class=lnt id=hl-216-51><a class=lnlinks href=#hl-216-51>51</a>
</span><span class=lnt id=hl-216-52><a class=lnlinks href=#hl-216-52>52</a>
</span><span class=lnt id=hl-216-53><a class=lnlinks href=#hl-216-53>53</a>
</span><span class=lnt id=hl-216-54><a class=lnlinks href=#hl-216-54>54</a>
</span><span class=lnt id=hl-216-55><a class=lnlinks href=#hl-216-55>55</a>
</span><span class=lnt id=hl-216-56><a class=lnlinks href=#hl-216-56>56</a>
</span><span class=lnt id=hl-216-57><a class=lnlinks href=#hl-216-57>57</a>
</span><span class=lnt id=hl-216-58><a class=lnlinks href=#hl-216-58>58</a>
</span><span class=lnt id=hl-216-59><a class=lnlinks href=#hl-216-59>59</a>
</span><span class=lnt id=hl-216-60><a class=lnlinks href=#hl-216-60>60</a>
</span><span class=lnt id=hl-216-61><a class=lnlinks href=#hl-216-61>61</a>
</span><span class=lnt id=hl-216-62><a class=lnlinks href=#hl-216-62>62</a>
</span><span class=lnt id=hl-216-63><a class=lnlinks href=#hl-216-63>63</a>
</span><span class=lnt id=hl-216-64><a class=lnlinks href=#hl-216-64>64</a>
</span><span class=lnt id=hl-216-65><a class=lnlinks href=#hl-216-65>65</a>
</span><span class=lnt id=hl-216-66><a class=lnlinks href=#hl-216-66>66</a>
</span><span class=lnt id=hl-216-67><a class=lnlinks href=#hl-216-67>67</a>
</span><span class=lnt id=hl-216-68><a class=lnlinks href=#hl-216-68>68</a>
</span><span class=lnt id=hl-216-69><a class=lnlinks href=#hl-216-69>69</a>
</span><span class=lnt id=hl-216-70><a class=lnlinks href=#hl-216-70>70</a>
</span><span class=lnt id=hl-216-71><a class=lnlinks href=#hl-216-71>71</a>
</span><span class=lnt id=hl-216-72><a class=lnlinks href=#hl-216-72>72</a>
</span><span class=lnt id=hl-216-73><a class=lnlinks href=#hl-216-73>73</a>
</span><span class=lnt id=hl-216-74><a class=lnlinks href=#hl-216-74>74</a>
</span><span class=lnt id=hl-216-75><a class=lnlinks href=#hl-216-75>75</a>
</span><span class=lnt id=hl-216-76><a class=lnlinks href=#hl-216-76>76</a>
</span><span class=lnt id=hl-216-77><a class=lnlinks href=#hl-216-77>77</a>
</span><span class=lnt id=hl-216-78><a class=lnlinks href=#hl-216-78>78</a>
</span><span class=lnt id=hl-216-79><a class=lnlinks href=#hl-216-79>79</a>
</span><span class=lnt id=hl-216-80><a class=lnlinks href=#hl-216-80>80</a>
</span><span class=lnt id=hl-216-81><a class=lnlinks href=#hl-216-81>81</a>
</span><span class=lnt id=hl-216-82><a class=lnlinks href=#hl-216-82>82</a>
</span><span class=lnt id=hl-216-83><a class=lnlinks href=#hl-216-83>83</a>
</span><span class=lnt id=hl-216-84><a class=lnlinks href=#hl-216-84>84</a>
</span><span class=lnt id=hl-216-85><a class=lnlinks href=#hl-216-85>85</a>
</span><span class=lnt id=hl-216-86><a class=lnlinks href=#hl-216-86>86</a>
</span><span class=lnt id=hl-216-87><a class=lnlinks href=#hl-216-87>87</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Condition</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>await</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>awaitUninterruptibly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     *  &lt;pre&gt; {@code
</span></span></span><span class=line><span class=cl><span class=cm>     * boolean aMethod(long timeout, TimeUnit unit) {
</span></span></span><span class=line><span class=cl><span class=cm>     *   long nanos = unit.toNanos(timeout);
</span></span></span><span class=line><span class=cl><span class=cm>     *   lock.lock();
</span></span></span><span class=line><span class=cl><span class=cm>     *   try {
</span></span></span><span class=line><span class=cl><span class=cm>     *     while (!conditionBeingWaitedFor()) {
</span></span></span><span class=line><span class=cl><span class=cm>     *       if (nanos &lt;= 0L)
</span></span></span><span class=line><span class=cl><span class=cm>     *         return false;
</span></span></span><span class=line><span class=cl><span class=cm>     *       nanos = theCondition.awaitNanos(nanos);
</span></span></span><span class=line><span class=cl><span class=cm>     *     }
</span></span></span><span class=line><span class=cl><span class=cm>     *     // ...
</span></span></span><span class=line><span class=cl><span class=cm>     *   } finally {
</span></span></span><span class=line><span class=cl><span class=cm>     *     lock.unlock();
</span></span></span><span class=line><span class=cl><span class=cm>     *   }
</span></span></span><span class=line><span class=cl><span class=cm>     * }}&lt;/pre&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param nanosTimeout the maximum time to wait, in nanoseconds
</span></span></span><span class=line><span class=cl><span class=cm>     * @return an estimate of the {@code nanosTimeout} value minus
</span></span></span><span class=line><span class=cl><span class=cm>     *         the time spent waiting upon return from this method.
</span></span></span><span class=line><span class=cl><span class=cm>     *         A positive value may be used as the argument to a
</span></span></span><span class=line><span class=cl><span class=cm>     *         subsequent call to this method to finish waiting out
</span></span></span><span class=line><span class=cl><span class=cm>     *         the desired time.  A value less than or equal to zero
</span></span></span><span class=line><span class=cl><span class=cm>     *         indicates that no time remains.
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws InterruptedException if the current thread is interrupted
</span></span></span><span class=line><span class=cl><span class=cm>     *         (and interruption of thread suspension is supported)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=nf>awaitNanos</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>nanosTimeout</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Causes the current thread to wait until it is signalled or interrupted,
</span></span></span><span class=line><span class=cl><span class=cm>     * or the specified waiting time elapses. This method is behaviorally
</span></span></span><span class=line><span class=cl><span class=cm>     * equivalent to:
</span></span></span><span class=line><span class=cl><span class=cm>     *  &lt;pre&gt; {@code awaitNanos(unit.toNanos(time)) &gt; 0}&lt;/pre&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param time the maximum time to wait
</span></span></span><span class=line><span class=cl><span class=cm>     * @param unit the time unit of the {@code time} argument
</span></span></span><span class=line><span class=cl><span class=cm>     * @return {@code false} if the waiting time detectably elapsed
</span></span></span><span class=line><span class=cl><span class=cm>     *         before return from the method, else {@code true}
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws InterruptedException if the current thread is interrupted
</span></span></span><span class=line><span class=cl><span class=cm>     *         (and interruption of thread suspension is supported)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>await</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Causes the current thread to wait until it is signalled or interrupted,
</span></span></span><span class=line><span class=cl><span class=cm>     * or the specified deadline elapses.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     *  &lt;pre&gt; {@code
</span></span></span><span class=line><span class=cl><span class=cm>     * boolean aMethod(Date deadline) {
</span></span></span><span class=line><span class=cl><span class=cm>     *   boolean stillWaiting = true;
</span></span></span><span class=line><span class=cl><span class=cm>     *   lock.lock();
</span></span></span><span class=line><span class=cl><span class=cm>     *   try {
</span></span></span><span class=line><span class=cl><span class=cm>     *     while (!conditionBeingWaitedFor()) {
</span></span></span><span class=line><span class=cl><span class=cm>     *       if (!stillWaiting)
</span></span></span><span class=line><span class=cl><span class=cm>     *         return false;
</span></span></span><span class=line><span class=cl><span class=cm>     *       stillWaiting = theCondition.awaitUntil(deadline);
</span></span></span><span class=line><span class=cl><span class=cm>     *     }
</span></span></span><span class=line><span class=cl><span class=cm>     *     // ...
</span></span></span><span class=line><span class=cl><span class=cm>     *   } finally {
</span></span></span><span class=line><span class=cl><span class=cm>     *     lock.unlock();
</span></span></span><span class=line><span class=cl><span class=cm>     *   }
</span></span></span><span class=line><span class=cl><span class=cm>     * }}&lt;/pre&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * @param deadline the absolute time to wait until
</span></span></span><span class=line><span class=cl><span class=cm>     * @return {@code false} if the deadline has elapsed upon return, else
</span></span></span><span class=line><span class=cl><span class=cm>     *         {@code true}
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws InterruptedException if the current thread is interrupted
</span></span></span><span class=line><span class=cl><span class=cm>     *         (and interruption of thread suspension is supported)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>awaitUntil</span><span class=p>(</span><span class=n>Date</span><span class=w> </span><span class=n>deadline</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Wakes up one waiting thread.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Wakes up all waiting threads.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>signalAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¾‹å­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-217-1><a class=lnlinks href=#hl-217-1> 1</a>
</span><span class=lnt id=hl-217-2><a class=lnlinks href=#hl-217-2> 2</a>
</span><span class=lnt id=hl-217-3><a class=lnlinks href=#hl-217-3> 3</a>
</span><span class=lnt id=hl-217-4><a class=lnlinks href=#hl-217-4> 4</a>
</span><span class=lnt id=hl-217-5><a class=lnlinks href=#hl-217-5> 5</a>
</span><span class=lnt id=hl-217-6><a class=lnlinks href=#hl-217-6> 6</a>
</span><span class=lnt id=hl-217-7><a class=lnlinks href=#hl-217-7> 7</a>
</span><span class=lnt id=hl-217-8><a class=lnlinks href=#hl-217-8> 8</a>
</span><span class=lnt id=hl-217-9><a class=lnlinks href=#hl-217-9> 9</a>
</span><span class=lnt id=hl-217-10><a class=lnlinks href=#hl-217-10>10</a>
</span><span class=lnt id=hl-217-11><a class=lnlinks href=#hl-217-11>11</a>
</span><span class=lnt id=hl-217-12><a class=lnlinks href=#hl-217-12>12</a>
</span><span class=lnt id=hl-217-13><a class=lnlinks href=#hl-217-13>13</a>
</span><span class=lnt id=hl-217-14><a class=lnlinks href=#hl-217-14>14</a>
</span><span class=lnt id=hl-217-15><a class=lnlinks href=#hl-217-15>15</a>
</span><span class=lnt id=hl-217-16><a class=lnlinks href=#hl-217-16>16</a>
</span><span class=lnt id=hl-217-17><a class=lnlinks href=#hl-217-17>17</a>
</span><span class=lnt id=hl-217-18><a class=lnlinks href=#hl-217-18>18</a>
</span><span class=lnt id=hl-217-19><a class=lnlinks href=#hl-217-19>19</a>
</span><span class=lnt id=hl-217-20><a class=lnlinks href=#hl-217-20>20</a>
</span><span class=lnt id=hl-217-21><a class=lnlinks href=#hl-217-21>21</a>
</span><span class=lnt id=hl-217-22><a class=lnlinks href=#hl-217-22>22</a>
</span><span class=lnt id=hl-217-23><a class=lnlinks href=#hl-217-23>23</a>
</span><span class=lnt id=hl-217-24><a class=lnlinks href=#hl-217-24>24</a>
</span><span class=lnt id=hl-217-25><a class=lnlinks href=#hl-217-25>25</a>
</span><span class=lnt id=hl-217-26><a class=lnlinks href=#hl-217-26>26</a>
</span><span class=lnt id=hl-217-27><a class=lnlinks href=#hl-217-27>27</a>
</span><span class=lnt id=hl-217-28><a class=lnlinks href=#hl-217-28>28</a>
</span><span class=lnt id=hl-217-29><a class=lnlinks href=#hl-217-29>29</a>
</span><span class=lnt id=hl-217-30><a class=lnlinks href=#hl-217-30>30</a>
</span><span class=lnt id=hl-217-31><a class=lnlinks href=#hl-217-31>31</a>
</span><span class=lnt id=hl-217-32><a class=lnlinks href=#hl-217-32>32</a>
</span><span class=lnt id=hl-217-33><a class=lnlinks href=#hl-217-33>33</a>
</span><span class=lnt id=hl-217-34><a class=lnlinks href=#hl-217-34>34</a>
</span><span class=lnt id=hl-217-35><a class=lnlinks href=#hl-217-35>35</a>
</span><span class=lnt id=hl-217-36><a class=lnlinks href=#hl-217-36>36</a>
</span><span class=lnt id=hl-217-37><a class=lnlinks href=#hl-217-37>37</a>
</span><span class=lnt id=hl-217-38><a class=lnlinks href=#hl-217-38>38</a>
</span><span class=lnt id=hl-217-39><a class=lnlinks href=#hl-217-39>39</a>
</span><span class=lnt id=hl-217-40><a class=lnlinks href=#hl-217-40>40</a>
</span><span class=lnt id=hl-217-41><a class=lnlinks href=#hl-217-41>41</a>
</span><span class=lnt id=hl-217-42><a class=lnlinks href=#hl-217-42>42</a>
</span><span class=lnt id=hl-217-43><a class=lnlinks href=#hl-217-43>43</a>
</span><span class=lnt id=hl-217-44><a class=lnlinks href=#hl-217-44>44</a>
</span><span class=lnt id=hl-217-45><a class=lnlinks href=#hl-217-45>45</a>
</span><span class=lnt id=hl-217-46><a class=lnlinks href=#hl-217-46>46</a>
</span><span class=lnt id=hl-217-47><a class=lnlinks href=#hl-217-47>47</a>
</span><span class=lnt id=hl-217-48><a class=lnlinks href=#hl-217-48>48</a>
</span><span class=lnt id=hl-217-49><a class=lnlinks href=#hl-217-49>49</a>
</span><span class=lnt id=hl-217-50><a class=lnlinks href=#hl-217-50>50</a>
</span><span class=lnt id=hl-217-51><a class=lnlinks href=#hl-217-51>51</a>
</span><span class=lnt id=hl-217-52><a class=lnlinks href=#hl-217-52>52</a>
</span><span class=lnt id=hl-217-53><a class=lnlinks href=#hl-217-53>53</a>
</span><span class=lnt id=hl-217-54><a class=lnlinks href=#hl-217-54>54</a>
</span><span class=lnt id=hl-217-55><a class=lnlinks href=#hl-217-55>55</a>
</span><span class=lnt id=hl-217-56><a class=lnlinks href=#hl-217-56>56</a>
</span><span class=lnt id=hl-217-57><a class=lnlinks href=#hl-217-57>57</a>
</span><span class=lnt id=hl-217-58><a class=lnlinks href=#hl-217-58>58</a>
</span><span class=lnt id=hl-217-59><a class=lnlinks href=#hl-217-59>59</a>
</span><span class=lnt id=hl-217-60><a class=lnlinks href=#hl-217-60>60</a>
</span><span class=lnt id=hl-217-61><a class=lnlinks href=#hl-217-61>61</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>waitCigaretteQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>waitbreakfastQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasCigrette</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasBreakfast</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasCigrette</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>waitCigaretteQueue</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç­‰åˆ°äº†å®ƒçš„çƒŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasBreakfast</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>waitbreakfastQueue</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç­‰åˆ°äº†å®ƒçš„æ—©é¤&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sendBreakfast</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sendCigarette</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendCigarette</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;é€çƒŸæ¥äº†&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hasCigrette</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>waitCigaretteQueue</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendBreakfast</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;é€æ—©é¤æ¥äº†&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hasBreakfast</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>waitbreakfastQueue</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-218-1><a class=lnlinks href=#hl-218-1>1</a>
</span><span class=lnt id=hl-218-2><a class=lnlinks href=#hl-218-2>2</a>
</span><span class=lnt id=hl-218-3><a class=lnlinks href=#hl-218-3>3</a>
</span><span class=lnt id=hl-218-4><a class=lnlinks href=#hl-218-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:52:27.680 <span class=o>[</span>main<span class=o>]</span> c.TestCondition - é€æ—©é¤æ¥äº†
</span></span><span class=line><span class=cl>18:52:27.682 <span class=o>[</span>Thread-1<span class=o>]</span> c.TestCondition - ç­‰åˆ°äº†å®ƒçš„æ—©é¤
</span></span><span class=line><span class=cl>18:52:28.683 <span class=o>[</span>main<span class=o>]</span> c.TestCondition - é€çƒŸæ¥äº†
</span></span><span class=line><span class=cl>18:52:28.683 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestCondition - ç­‰åˆ°äº†å®ƒçš„çƒŸ
</span></span></code></pre></td></tr></table></div></div><h4 id=font-colororange-åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶font><a href=#font-colororange-%e5%90%8c%e6%ad%a5%e6%a8%a1%e5%bc%8f%e4%b9%8b%e9%a1%ba%e5%ba%8f%e6%8e%a7%e5%88%b6font class=header-anchor>#</a>
<font color=orange>* åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</font></h4><h5 id=å›ºå®šè¿è¡Œé¡ºåº><a href=#%e5%9b%ba%e5%ae%9a%e8%bf%90%e8%a1%8c%e9%a1%ba%e5%ba%8f class=header-anchor>#</a>
å›ºå®šè¿è¡Œé¡ºåº</h5><p>æ¯”å¦‚ï¼Œå¿…é¡»å…ˆ 2 å 1 æ‰“å°</p><p><strong>wait notify ç‰ˆ</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-219-1><a class=lnlinks href=#hl-219-1> 1</a>
</span><span class=lnt id=hl-219-2><a class=lnlinks href=#hl-219-2> 2</a>
</span><span class=lnt id=hl-219-3><a class=lnlinks href=#hl-219-3> 3</a>
</span><span class=lnt id=hl-219-4><a class=lnlinks href=#hl-219-4> 4</a>
</span><span class=lnt id=hl-219-5><a class=lnlinks href=#hl-219-5> 5</a>
</span><span class=lnt id=hl-219-6><a class=lnlinks href=#hl-219-6> 6</a>
</span><span class=lnt id=hl-219-7><a class=lnlinks href=#hl-219-7> 7</a>
</span><span class=lnt id=hl-219-8><a class=lnlinks href=#hl-219-8> 8</a>
</span><span class=lnt id=hl-219-9><a class=lnlinks href=#hl-219-9> 9</a>
</span><span class=lnt id=hl-219-10><a class=lnlinks href=#hl-219-10>10</a>
</span><span class=lnt id=hl-219-11><a class=lnlinks href=#hl-219-11>11</a>
</span><span class=lnt id=hl-219-12><a class=lnlinks href=#hl-219-12>12</a>
</span><span class=lnt id=hl-219-13><a class=lnlinks href=#hl-219-13>13</a>
</span><span class=lnt id=hl-219-14><a class=lnlinks href=#hl-219-14>14</a>
</span><span class=lnt id=hl-219-15><a class=lnlinks href=#hl-219-15>15</a>
</span><span class=lnt id=hl-219-16><a class=lnlinks href=#hl-219-16>16</a>
</span><span class=lnt id=hl-219-17><a class=lnlinks href=#hl-219-17>17</a>
</span><span class=lnt id=hl-219-18><a class=lnlinks href=#hl-219-18>18</a>
</span><span class=lnt id=hl-219-19><a class=lnlinks href=#hl-219-19>19</a>
</span><span class=lnt id=hl-219-20><a class=lnlinks href=#hl-219-20>20</a>
</span><span class=lnt id=hl-219-21><a class=lnlinks href=#hl-219-21>21</a>
</span><span class=lnt id=hl-219-22><a class=lnlinks href=#hl-219-22>22</a>
</span><span class=lnt id=hl-219-23><a class=lnlinks href=#hl-219-23>23</a>
</span><span class=lnt id=hl-219-24><a class=lnlinks href=#hl-219-24>24</a>
</span><span class=lnt id=hl-219-25><a class=lnlinks href=#hl-219-25>25</a>
</span><span class=lnt id=hl-219-26><a class=lnlinks href=#hl-219-26>26</a>
</span><span class=lnt id=hl-219-27><a class=lnlinks href=#hl-219-27>27</a>
</span><span class=lnt id=hl-219-28><a class=lnlinks href=#hl-219-28>28</a>
</span><span class=lnt id=hl-219-29><a class=lnlinks href=#hl-219-29>29</a>
</span><span class=lnt id=hl-219-30><a class=lnlinks href=#hl-219-30>30</a>
</span><span class=lnt id=hl-219-31><a class=lnlinks href=#hl-219-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ç”¨æ¥åŒæ­¥çš„å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// t2 è¿è¡Œæ ‡è®°ï¼Œ ä»£è¡¨ t2 æ˜¯å¦æ‰§è¡Œè¿‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>t2runed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœ t2 æ²¡æœ‰æ‰§è¡Œè¿‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>t2runed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// t1 å…ˆç­‰ä¸€ä¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>obj</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ä¿®æ”¹è¿è¡Œæ ‡è®°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t2runed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// é€šçŸ¥ obj ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼Œå› æ­¤éœ€è¦ç”¨ notifyAllï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>obj</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Park Unpark ç‰ˆ</strong></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ç°ä¸Šå¾ˆéº»çƒ¦ï¼š</p><ul><li>é¦–å…ˆï¼Œéœ€è¦ä¿è¯å…ˆ wait å† notifyï¼Œå¦åˆ™ wait çº¿ç¨‹æ°¸è¿œå¾—ä¸åˆ°å”¤é†’ã€‚å› æ­¤ä½¿ç”¨äº†ã€è¿è¡Œæ ‡è®°ã€æ¥åˆ¤æ–­è¯¥ä¸è¯¥ wait</li><li>ç¬¬äºŒï¼Œå¦‚æœæœ‰äº›å¹²æ‰°çº¿ç¨‹é”™è¯¯åœ° notify äº† wait çº¿ç¨‹ï¼Œæ¡ä»¶ä¸æ»¡è¶³æ—¶è¿˜è¦é‡æ–°ç­‰å¾…ï¼Œä½¿ç”¨äº† while å¾ªç¯æ¥è§£å†³ æ­¤é—®é¢˜</li><li>æœ€åï¼Œå”¤é†’å¯¹è±¡ä¸Šçš„ wait çº¿ç¨‹éœ€è¦ä½¿ç”¨ notifyAllï¼Œå› ä¸ºã€åŒæ­¥å¯¹è±¡ã€ä¸Šçš„ç­‰å¾…çº¿ç¨‹å¯èƒ½ä¸æ­¢ä¸€ä¸ª</li></ul><p>å¯ä»¥ä½¿ç”¨ LockSupport ç±»çš„ park å’Œ unpark æ¥ç®€åŒ–ä¸Šé¢çš„é¢˜ç›®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-220-1><a class=lnlinks href=#hl-220-1> 1</a>
</span><span class=lnt id=hl-220-2><a class=lnlinks href=#hl-220-2> 2</a>
</span><span class=lnt id=hl-220-3><a class=lnlinks href=#hl-220-3> 3</a>
</span><span class=lnt id=hl-220-4><a class=lnlinks href=#hl-220-4> 4</a>
</span><span class=lnt id=hl-220-5><a class=lnlinks href=#hl-220-5> 5</a>
</span><span class=lnt id=hl-220-6><a class=lnlinks href=#hl-220-6> 6</a>
</span><span class=lnt id=hl-220-7><a class=lnlinks href=#hl-220-7> 7</a>
</span><span class=lnt id=hl-220-8><a class=lnlinks href=#hl-220-8> 8</a>
</span><span class=lnt id=hl-220-9><a class=lnlinks href=#hl-220-9> 9</a>
</span><span class=lnt id=hl-220-10><a class=lnlinks href=#hl-220-10>10</a>
</span><span class=lnt id=hl-220-11><a class=lnlinks href=#hl-220-11>11</a>
</span><span class=lnt id=hl-220-12><a class=lnlinks href=#hl-220-12>12</a>
</span><span class=lnt id=hl-220-13><a class=lnlinks href=#hl-220-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å½“æ²¡æœ‰ã€è®¸å¯ã€æ—¶ï¼Œå½“å‰çº¿ç¨‹æš‚åœè¿è¡Œï¼›æœ‰ã€è®¸å¯ã€æ—¶ï¼Œç”¨æ‰è¿™ä¸ªã€è®¸å¯ã€ï¼Œå½“å‰çº¿ç¨‹æ¢å¤è¿è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç»™çº¿ç¨‹ t1 å‘æ”¾ã€è®¸å¯ã€ï¼ˆå¤šæ¬¡è¿ç»­è°ƒç”¨ unpark åªä¼šå‘æ”¾ä¸€ä¸ªã€è®¸å¯ã€ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>t1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>park å’Œ unpark æ–¹æ³•æ¯”è¾ƒçµæ´»ï¼Œä»–ä¿©è°å…ˆè°ƒç”¨ï¼Œè°åè°ƒç”¨æ— æ‰€è°“ã€‚å¹¶ä¸”æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½è¿›è¡Œã€æš‚åœã€å’Œã€æ¢å¤ã€ï¼Œ ä¸éœ€è¦ã€åŒæ­¥å¯¹è±¡ã€å’Œã€è¿è¡Œæ ‡è®°ã€</p><h5 id=äº¤æ›¿è¾“å‡º><a href=#%e4%ba%a4%e6%9b%bf%e8%be%93%e5%87%ba class=header-anchor>#</a>
äº¤æ›¿è¾“å‡º</h5><p>çº¿ç¨‹ 1 è¾“å‡º a 5 æ¬¡ï¼Œçº¿ç¨‹ 2 è¾“å‡º b 5 æ¬¡ï¼Œçº¿ç¨‹ 3 è¾“å‡º c 5 æ¬¡ã€‚ç°åœ¨è¦æ±‚è¾“å‡º abcabcabcabcabc æ€ä¹ˆå®ç°</p><p><strong>wait notify ç‰ˆ</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-221-1><a class=lnlinks href=#hl-221-1> 1</a>
</span><span class=lnt id=hl-221-2><a class=lnlinks href=#hl-221-2> 2</a>
</span><span class=lnt id=hl-221-3><a class=lnlinks href=#hl-221-3> 3</a>
</span><span class=lnt id=hl-221-4><a class=lnlinks href=#hl-221-4> 4</a>
</span><span class=lnt id=hl-221-5><a class=lnlinks href=#hl-221-5> 5</a>
</span><span class=lnt id=hl-221-6><a class=lnlinks href=#hl-221-6> 6</a>
</span><span class=lnt id=hl-221-7><a class=lnlinks href=#hl-221-7> 7</a>
</span><span class=lnt id=hl-221-8><a class=lnlinks href=#hl-221-8> 8</a>
</span><span class=lnt id=hl-221-9><a class=lnlinks href=#hl-221-9> 9</a>
</span><span class=lnt id=hl-221-10><a class=lnlinks href=#hl-221-10>10</a>
</span><span class=lnt id=hl-221-11><a class=lnlinks href=#hl-221-11>11</a>
</span><span class=lnt id=hl-221-12><a class=lnlinks href=#hl-221-12>12</a>
</span><span class=lnt id=hl-221-13><a class=lnlinks href=#hl-221-13>13</a>
</span><span class=lnt id=hl-221-14><a class=lnlinks href=#hl-221-14>14</a>
</span><span class=lnt id=hl-221-15><a class=lnlinks href=#hl-221-15>15</a>
</span><span class=lnt id=hl-221-16><a class=lnlinks href=#hl-221-16>16</a>
</span><span class=lnt id=hl-221-17><a class=lnlinks href=#hl-221-17>17</a>
</span><span class=lnt id=hl-221-18><a class=lnlinks href=#hl-221-18>18</a>
</span><span class=lnt id=hl-221-19><a class=lnlinks href=#hl-221-19>19</a>
</span><span class=lnt id=hl-221-20><a class=lnlinks href=#hl-221-20>20</a>
</span><span class=lnt id=hl-221-21><a class=lnlinks href=#hl-221-21>21</a>
</span><span class=lnt id=hl-221-22><a class=lnlinks href=#hl-221-22>22</a>
</span><span class=lnt id=hl-221-23><a class=lnlinks href=#hl-221-23>23</a>
</span><span class=lnt id=hl-221-24><a class=lnlinks href=#hl-221-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SyncWaitNotify</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SyncWaitNotify</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>flag</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>loopNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>print</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>waitFlag</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>nextFlag</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>flag</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>waitFlag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>this</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>str</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextFlag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-222-1><a class=lnlinks href=#hl-222-1> 1</a>
</span><span class=lnt id=hl-222-2><a class=lnlinks href=#hl-222-2> 2</a>
</span><span class=lnt id=hl-222-3><a class=lnlinks href=#hl-222-3> 3</a>
</span><span class=lnt id=hl-222-4><a class=lnlinks href=#hl-222-4> 4</a>
</span><span class=lnt id=hl-222-5><a class=lnlinks href=#hl-222-5> 5</a>
</span><span class=lnt id=hl-222-6><a class=lnlinks href=#hl-222-6> 6</a>
</span><span class=lnt id=hl-222-7><a class=lnlinks href=#hl-222-7> 7</a>
</span><span class=lnt id=hl-222-8><a class=lnlinks href=#hl-222-8> 8</a>
</span><span class=lnt id=hl-222-9><a class=lnlinks href=#hl-222-9> 9</a>
</span><span class=lnt id=hl-222-10><a class=lnlinks href=#hl-222-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SyncWaitNotify</span><span class=w> </span><span class=n>syncWaitNotify</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SyncWaitNotify</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncWaitNotify</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=s>&#34;a&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncWaitNotify</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=s>&#34;b&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncWaitNotify</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=s>&#34;c&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Lock æ¡ä»¶å˜é‡ç‰ˆ</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-223-1><a class=lnlinks href=#hl-223-1> 1</a>
</span><span class=lnt id=hl-223-2><a class=lnlinks href=#hl-223-2> 2</a>
</span><span class=lnt id=hl-223-3><a class=lnlinks href=#hl-223-3> 3</a>
</span><span class=lnt id=hl-223-4><a class=lnlinks href=#hl-223-4> 4</a>
</span><span class=lnt id=hl-223-5><a class=lnlinks href=#hl-223-5> 5</a>
</span><span class=lnt id=hl-223-6><a class=lnlinks href=#hl-223-6> 6</a>
</span><span class=lnt id=hl-223-7><a class=lnlinks href=#hl-223-7> 7</a>
</span><span class=lnt id=hl-223-8><a class=lnlinks href=#hl-223-8> 8</a>
</span><span class=lnt id=hl-223-9><a class=lnlinks href=#hl-223-9> 9</a>
</span><span class=lnt id=hl-223-10><a class=lnlinks href=#hl-223-10>10</a>
</span><span class=lnt id=hl-223-11><a class=lnlinks href=#hl-223-11>11</a>
</span><span class=lnt id=hl-223-12><a class=lnlinks href=#hl-223-12>12</a>
</span><span class=lnt id=hl-223-13><a class=lnlinks href=#hl-223-13>13</a>
</span><span class=lnt id=hl-223-14><a class=lnlinks href=#hl-223-14>14</a>
</span><span class=lnt id=hl-223-15><a class=lnlinks href=#hl-223-15>15</a>
</span><span class=lnt id=hl-223-16><a class=lnlinks href=#hl-223-16>16</a>
</span><span class=lnt id=hl-223-17><a class=lnlinks href=#hl-223-17>17</a>
</span><span class=lnt id=hl-223-18><a class=lnlinks href=#hl-223-18>18</a>
</span><span class=lnt id=hl-223-19><a class=lnlinks href=#hl-223-19>19</a>
</span><span class=lnt id=hl-223-20><a class=lnlinks href=#hl-223-20>20</a>
</span><span class=lnt id=hl-223-21><a class=lnlinks href=#hl-223-21>21</a>
</span><span class=lnt id=hl-223-22><a class=lnlinks href=#hl-223-22>22</a>
</span><span class=lnt id=hl-223-23><a class=lnlinks href=#hl-223-23>23</a>
</span><span class=lnt id=hl-223-24><a class=lnlinks href=#hl-223-24>24</a>
</span><span class=lnt id=hl-223-25><a class=lnlinks href=#hl-223-25>25</a>
</span><span class=lnt id=hl-223-26><a class=lnlinks href=#hl-223-26>26</a>
</span><span class=lnt id=hl-223-27><a class=lnlinks href=#hl-223-27>27</a>
</span><span class=lnt id=hl-223-28><a class=lnlinks href=#hl-223-28>28</a>
</span><span class=lnt id=hl-223-29><a class=lnlinks href=#hl-223-29>29</a>
</span><span class=lnt id=hl-223-30><a class=lnlinks href=#hl-223-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AwaitSignal</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(</span><span class=n>Condition</span><span class=w> </span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>print</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>current</span><span class=p>,</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>current</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>str</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>next</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¾ªç¯æ¬¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AwaitSignal</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>loopNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-224-1><a class=lnlinks href=#hl-224-1> 1</a>
</span><span class=lnt id=hl-224-2><a class=lnlinks href=#hl-224-2> 2</a>
</span><span class=lnt id=hl-224-3><a class=lnlinks href=#hl-224-3> 3</a>
</span><span class=lnt id=hl-224-4><a class=lnlinks href=#hl-224-4> 4</a>
</span><span class=lnt id=hl-224-5><a class=lnlinks href=#hl-224-5> 5</a>
</span><span class=lnt id=hl-224-6><a class=lnlinks href=#hl-224-6> 6</a>
</span><span class=lnt id=hl-224-7><a class=lnlinks href=#hl-224-7> 7</a>
</span><span class=lnt id=hl-224-8><a class=lnlinks href=#hl-224-8> 8</a>
</span><span class=lnt id=hl-224-9><a class=lnlinks href=#hl-224-9> 9</a>
</span><span class=lnt id=hl-224-10><a class=lnlinks href=#hl-224-10>10</a>
</span><span class=lnt id=hl-224-11><a class=lnlinks href=#hl-224-11>11</a>
</span><span class=lnt id=hl-224-12><a class=lnlinks href=#hl-224-12>12</a>
</span><span class=lnt id=hl-224-13><a class=lnlinks href=#hl-224-13>13</a>
</span><span class=lnt id=hl-224-14><a class=lnlinks href=#hl-224-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>AwaitSignal</span><span class=w> </span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AwaitSignal</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Condition</span><span class=w> </span><span class=n>aWaitSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Condition</span><span class=w> </span><span class=n>bWaitSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Condition</span><span class=w> </span><span class=n>cWaitSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>as</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>,</span><span class=w> </span><span class=n>aWaitSet</span><span class=p>,</span><span class=w> </span><span class=n>bWaitSet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>as</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>,</span><span class=w> </span><span class=n>bWaitSet</span><span class=p>,</span><span class=w> </span><span class=n>cWaitSet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>as</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;c&#34;</span><span class=p>,</span><span class=w> </span><span class=n>cWaitSet</span><span class=p>,</span><span class=w> </span><span class=n>aWaitSet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>as</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>aWaitSet</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong></p><p>è¯¥å®ç°æ²¡æœ‰è€ƒè™‘ aï¼Œbï¼Œc çº¿ç¨‹éƒ½å°±ç»ªå†å¼€å§‹</p></blockquote><p><strong>Park Unpark ç‰ˆ</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-225-1><a class=lnlinks href=#hl-225-1> 1</a>
</span><span class=lnt id=hl-225-2><a class=lnlinks href=#hl-225-2> 2</a>
</span><span class=lnt id=hl-225-3><a class=lnlinks href=#hl-225-3> 3</a>
</span><span class=lnt id=hl-225-4><a class=lnlinks href=#hl-225-4> 4</a>
</span><span class=lnt id=hl-225-5><a class=lnlinks href=#hl-225-5> 5</a>
</span><span class=lnt id=hl-225-6><a class=lnlinks href=#hl-225-6> 6</a>
</span><span class=lnt id=hl-225-7><a class=lnlinks href=#hl-225-7> 7</a>
</span><span class=lnt id=hl-225-8><a class=lnlinks href=#hl-225-8> 8</a>
</span><span class=lnt id=hl-225-9><a class=lnlinks href=#hl-225-9> 9</a>
</span><span class=lnt id=hl-225-10><a class=lnlinks href=#hl-225-10>10</a>
</span><span class=lnt id=hl-225-11><a class=lnlinks href=#hl-225-11>11</a>
</span><span class=lnt id=hl-225-12><a class=lnlinks href=#hl-225-12>12</a>
</span><span class=lnt id=hl-225-13><a class=lnlinks href=#hl-225-13>13</a>
</span><span class=lnt id=hl-225-14><a class=lnlinks href=#hl-225-14>14</a>
</span><span class=lnt id=hl-225-15><a class=lnlinks href=#hl-225-15>15</a>
</span><span class=lnt id=hl-225-16><a class=lnlinks href=#hl-225-16>16</a>
</span><span class=lnt id=hl-225-17><a class=lnlinks href=#hl-225-17>17</a>
</span><span class=lnt id=hl-225-18><a class=lnlinks href=#hl-225-18>18</a>
</span><span class=lnt id=hl-225-19><a class=lnlinks href=#hl-225-19>19</a>
</span><span class=lnt id=hl-225-20><a class=lnlinks href=#hl-225-20>20</a>
</span><span class=lnt id=hl-225-21><a class=lnlinks href=#hl-225-21>21</a>
</span><span class=lnt id=hl-225-22><a class=lnlinks href=#hl-225-22>22</a>
</span><span class=lnt id=hl-225-23><a class=lnlinks href=#hl-225-23>23</a>
</span><span class=lnt id=hl-225-24><a class=lnlinks href=#hl-225-24>24</a>
</span><span class=lnt id=hl-225-25><a class=lnlinks href=#hl-225-25>25</a>
</span><span class=lnt id=hl-225-26><a class=lnlinks href=#hl-225-26>26</a>
</span><span class=lnt id=hl-225-27><a class=lnlinks href=#hl-225-27>27</a>
</span><span class=lnt id=hl-225-28><a class=lnlinks href=#hl-225-28>28</a>
</span><span class=lnt id=hl-225-29><a class=lnlinks href=#hl-225-29>29</a>
</span><span class=lnt id=hl-225-30><a class=lnlinks href=#hl-225-30>30</a>
</span><span class=lnt id=hl-225-31><a class=lnlinks href=#hl-225-31>31</a>
</span><span class=lnt id=hl-225-32><a class=lnlinks href=#hl-225-32>32</a>
</span><span class=lnt id=hl-225-33><a class=lnlinks href=#hl-225-33>33</a>
</span><span class=lnt id=hl-225-34><a class=lnlinks href=#hl-225-34>34</a>
</span><span class=lnt id=hl-225-35><a class=lnlinks href=#hl-225-35>35</a>
</span><span class=lnt id=hl-225-36><a class=lnlinks href=#hl-225-36>36</a>
</span><span class=lnt id=hl-225-37><a class=lnlinks href=#hl-225-37>37</a>
</span><span class=lnt id=hl-225-38><a class=lnlinks href=#hl-225-38>38</a>
</span><span class=lnt id=hl-225-39><a class=lnlinks href=#hl-225-39>39</a>
</span><span class=lnt id=hl-225-40><a class=lnlinks href=#hl-225-40>40</a>
</span><span class=lnt id=hl-225-41><a class=lnlinks href=#hl-225-41>41</a>
</span><span class=lnt id=hl-225-42><a class=lnlinks href=#hl-225-42>42</a>
</span><span class=lnt id=hl-225-43><a class=lnlinks href=#hl-225-43>43</a>
</span><span class=lnt id=hl-225-44><a class=lnlinks href=#hl-225-44>44</a>
</span><span class=lnt id=hl-225-45><a class=lnlinks href=#hl-225-45>45</a>
</span><span class=lnt id=hl-225-46><a class=lnlinks href=#hl-225-46>46</a>
</span><span class=lnt id=hl-225-47><a class=lnlinks href=#hl-225-47>47</a>
</span><span class=lnt id=hl-225-48><a class=lnlinks href=#hl-225-48>48</a>
</span><span class=lnt id=hl-225-49><a class=lnlinks href=#hl-225-49>49</a>
</span><span class=lnt id=hl-225-50><a class=lnlinks href=#hl-225-50>50</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SyncPark</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=o>[]</span><span class=w> </span><span class=n>threads</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SyncPark</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>loopNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>loopNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setThreads</span><span class=p>(</span><span class=n>Thread</span><span class=p>...</span><span class=w> </span><span class=n>threads</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>threads</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>threads</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>print</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>loopNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=n>str</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>nextThread</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=nf>nextThread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>threads</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>threads</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>current</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>index</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>threads</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>threads</span><span class=o>[</span><span class=n>index</span><span class=o>+</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>threads</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>threads</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>threads</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>SyncPark</span><span class=w> </span><span class=n>syncPark</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SyncPark</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncPark</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncPark</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syncPark</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;c\n&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>syncPark</span><span class=p>.</span><span class=na>setThreads</span><span class=p>(</span><span class=n>t1</span><span class=p>,</span><span class=w> </span><span class=n>t2</span><span class=p>,</span><span class=w> </span><span class=n>t3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>syncPark</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=æœ¬ç« å°ç»“-1><a href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-1 class=header-anchor>#</a>
æœ¬ç« å°ç»“</h2><p>æœ¬ç« æˆ‘ä»¬éœ€è¦é‡ç‚¹æŒæ¡çš„æ˜¯</p><ul><li>åˆ†æå¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå“ªäº›ä»£ç ç‰‡æ®µå±äºä¸´ç•ŒåŒº</li><li>ä½¿ç”¨ synchronized äº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜<ul><li>æŒæ¡ synchronized é”å¯¹è±¡è¯­æ³•</li><li>æŒæ¡ synchronzied åŠ è½½æˆå‘˜æ–¹æ³•å’Œé™æ€æ–¹æ³•è¯­æ³•</li><li>æŒæ¡ wait/notify åŒæ­¥æ–¹æ³•</li></ul></li><li>ä½¿ç”¨ lock äº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜<ul><li>æŒæ¡ lock çš„ä½¿ç”¨ç»†èŠ‚ï¼šå¯æ‰“æ–­ã€é”è¶…æ—¶ã€å…¬å¹³é”ã€æ¡ä»¶å˜é‡</li></ul></li><li>å­¦ä¼šåˆ†æå˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§ã€æŒæ¡å¸¸è§çº¿ç¨‹å®‰å…¨ç±»çš„ä½¿ç”¨<ul><li>çº¿ç¨‹å®‰å…¨ç±»çš„æ–¹æ³•æ˜¯åŸå­æ€§çš„ï¼Œä½†æ–¹æ³•ä¹‹é—´çš„ç»„åˆè¦å…·ä½“åˆ†æã€‚</li></ul></li><li>äº†è§£çº¿ç¨‹æ´»è·ƒæ€§é—®é¢˜ï¼šæ­»é”ã€æ´»é”ã€é¥¥é¥¿ã€‚<ul><li>è§£å†³æ­»é”ã€é¥¥é¥¿çš„æ–¹å¼ï¼šReentranLock</li></ul></li><li><font color=green>åº”ç”¨æ–¹é¢</font><ul><li>äº’æ–¥ï¼šä½¿ç”¨ synchronized æˆ– Lock è¾¾åˆ°å…±äº«èµ„æºäº’æ–¥æ•ˆæœ</li><li>åŒæ­¥ï¼šä½¿ç”¨ wait/notify æˆ– Lock çš„æ¡ä»¶å˜é‡æ¥è¾¾åˆ°çº¿ç¨‹é—´é€šä¿¡æ•ˆæœ</li></ul></li><li><font color=blue>åŸç†æ–¹é¢</font><ul><li>monitorã€synchronized ã€wait/notify åŸç†</li><li>synchronized è¿›é˜¶åŸç†</li><li>park & unpark åŸç†</li></ul></li><li><font color=orange>æ¨¡å¼æ–¹é¢</font><ul><li>åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</li><li>å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…</li><li>åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</li></ul></li></ul><h1 id=5å…±äº«æ¨¡å‹ä¹‹å†…å­˜><a href=#5%e5%85%b1%e4%ba%ab%e6%a8%a1%e5%9e%8b%e4%b9%8b%e5%86%85%e5%ad%98 class=header-anchor>#</a>
5.å…±äº«æ¨¡å‹ä¹‹å†…å­˜</h1><h2 id=51-java-å†…å­˜æ¨¡å‹><a href=#51-java-%e5%86%85%e5%ad%98%e6%a8%a1%e5%9e%8b class=header-anchor>#</a>
5.1 Java å†…å­˜æ¨¡å‹</h2><p>JMM å³ Java Memory Modelï¼Œå®ƒå®šä¹‰äº†ä¸»å­˜ã€å·¥ä½œå†…å­˜æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€ CPU å¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€ CPU æŒ‡ä»¤ä¼˜åŒ–ç­‰ã€‚</p><p>JMMçš„æ„ä¹‰</p><ul><li>è®¡ç®—æœºç¡¬ä»¶åº•å±‚çš„å†…å­˜ç»“æ„è¿‡äºå¤æ‚ï¼ŒJMMçš„æ„ä¹‰åœ¨äºé¿å…ç¨‹åºå‘˜ç›´æ¥ç®¡ç†è®¡ç®—æœºåº•å±‚å†…å­˜ï¼Œç”¨ä¸€äº›å…³é”®å­—synchronizedã€volatileç­‰å¯ä»¥æ–¹ä¾¿çš„ç®¡ç†å†…å­˜ã€‚</li></ul><p>JMM ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢</p><ul><li>åŸå­æ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“</li><li>å¯è§æ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpu ç¼“å­˜çš„å½±å“</li><li>æœ‰åºæ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpu æŒ‡ä»¤å¹¶è¡Œä¼˜åŒ–çš„å½±å“</li></ul><h2 id=52-å¯è§æ€§><a href=#52-%e5%8f%af%e8%a7%81%e6%80%a7 class=header-anchor>#</a>
5.2 å¯è§æ€§</h2><h4 id=é€€ä¸å‡ºçš„å¾ªç¯><a href=#%e9%80%80%e4%b8%8d%e5%87%ba%e7%9a%84%e5%be%aa%e7%8e%af class=header-anchor>#</a>
é€€ä¸å‡ºçš„å¾ªç¯</h4><p>å…ˆæ¥çœ‹ä¸€ä¸ªç°è±¡ï¼Œmain çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-226-1><a class=lnlinks href=#hl-226-1> 1</a>
</span><span class=lnt id=hl-226-2><a class=lnlinks href=#hl-226-2> 2</a>
</span><span class=lnt id=hl-226-3><a class=lnlinks href=#hl-226-3> 3</a>
</span><span class=lnt id=hl-226-4><a class=lnlinks href=#hl-226-4> 4</a>
</span><span class=lnt id=hl-226-5><a class=lnlinks href=#hl-226-5> 5</a>
</span><span class=lnt id=hl-226-6><a class=lnlinks href=#hl-226-6> 6</a>
</span><span class=lnt id=hl-226-7><a class=lnlinks href=#hl-226-7> 7</a>
</span><span class=lnt id=hl-226-8><a class=lnlinks href=#hl-226-8> 8</a>
</span><span class=lnt id=hl-226-9><a class=lnlinks href=#hl-226-9> 9</a>
</span><span class=lnt id=hl-226-10><a class=lnlinks href=#hl-226-10>10</a>
</span><span class=lnt id=hl-226-11><a class=lnlinks href=#hl-226-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>run</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=n>run</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>run</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=c1>// çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåˆ†æä¸€ä¸‹ï¼š</p><ol><li>åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº† run çš„å€¼åˆ°å·¥ä½œå†…å­˜ã€‚</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220305192346249.png width=900 height=600 loading=lazy decoding=async alt=image-20220305192346249 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ol start=2><li>å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œ å‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220305192416102.png width=900 height=600 loading=lazy decoding=async alt=image-20220305192416102 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><ol start=3><li>1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡ çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220305192512523.png width=900 height=600 loading=lazy decoding=async alt=image-20220305192512523 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=è§£å†³æ–¹æ³•><a href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
è§£å†³æ–¹æ³•</h4><p>volatileï¼ˆæ˜“å˜å…³é”®å­—ï¼‰</p><p>å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å– å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜</p><h4 id=å¯è§æ€§-vs-åŸå­æ€§><a href=#%e5%8f%af%e8%a7%81%e6%80%a7-vs-%e5%8e%9f%e5%ad%90%e6%80%a7 class=header-anchor>#</a>
å¯è§æ€§ vs åŸå­æ€§</h4><p>å‰é¢ä¾‹å­ä½“ç°çš„å®é™…å°±æ˜¯å¯è§æ€§ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯ è§ï¼Œ ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä»…ç”¨åœ¨ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œå¤šä¸ªè¯»çº¿ç¨‹çš„æƒ…å†µï¼š ä¸Šä¾‹ä»å­—èŠ‚ç ç†è§£æ˜¯è¿™æ ·çš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-227-1><a class=lnlinks href=#hl-227-1>1</a>
</span><span class=lnt id=hl-227-2><a class=lnlinks href=#hl-227-2>2</a>
</span><span class=lnt id=hl-227-3><a class=lnlinks href=#hl-227-3>3</a>
</span><span class=lnt id=hl-227-4><a class=lnlinks href=#hl-227-4>4</a>
</span><span class=lnt id=hl-227-5><a class=lnlinks href=#hl-227-5>5</a>
</span><span class=lnt id=hl-227-6><a class=lnlinks href=#hl-227-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>getstatic run // çº¿ç¨‹ t è·å– run <span class=nb>true</span> 
</span></span><span class=line><span class=cl>getstatic run // çº¿ç¨‹ t è·å– run <span class=nb>true</span> 
</span></span><span class=line><span class=cl>getstatic run // çº¿ç¨‹ t è·å– run <span class=nb>true</span> 
</span></span><span class=line><span class=cl>getstatic run // çº¿ç¨‹ t è·å– run <span class=nb>true</span> 
</span></span><span class=line><span class=cl>putstatic run // çº¿ç¨‹ main ä¿®æ”¹ run ä¸º falseï¼Œ ä»…æ­¤ä¸€æ¬¡
</span></span><span class=line><span class=cl>getstatic run // çº¿ç¨‹ t è·å– run <span class=nb>false</span> 
</span></span></code></pre></td></tr></table></div></div><p>æ¯”è¾ƒä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬å°†çº¿ç¨‹å®‰å…¨æ—¶ä¸¾çš„ä¾‹å­ï¼šä¸¤ä¸ªçº¿ç¨‹ä¸€ä¸ª i++ ä¸€ä¸ª i&ndash; ï¼Œåªèƒ½ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-228-1><a class=lnlinks href=#hl-228-1>1</a>
</span><span class=lnt id=hl-228-2><a class=lnlinks href=#hl-228-2>2</a>
</span><span class=lnt id=hl-228-3><a class=lnlinks href=#hl-228-3>3</a>
</span><span class=lnt id=hl-228-4><a class=lnlinks href=#hl-228-4>4</a>
</span><span class=lnt id=hl-228-5><a class=lnlinks href=#hl-228-5>5</a>
</span><span class=lnt id=hl-228-6><a class=lnlinks href=#hl-228-6>6</a>
</span><span class=lnt id=hl-228-7><a class=lnlinks href=#hl-228-7>7</a>
</span><span class=lnt id=hl-228-8><a class=lnlinks href=#hl-228-8>8</a>
</span><span class=lnt id=hl-228-9><a class=lnlinks href=#hl-228-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>// å‡è®¾içš„åˆå§‹å€¼ä¸º0 
</span></span><span class=line><span class=cl>getstatic i // çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ <span class=nv>çº¿ç¨‹å†…i</span><span class=o>=</span><span class=m>0</span> 
</span></span><span class=line><span class=cl>getstatic i // çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ <span class=nv>çº¿ç¨‹å†…i</span><span class=o>=</span><span class=m>0</span> 
</span></span><span class=line><span class=cl>iconst_1 // çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1 
</span></span><span class=line><span class=cl>iadd // çº¿ç¨‹1-è‡ªå¢ <span class=nv>çº¿ç¨‹å†…i</span><span class=o>=</span><span class=m>1</span> 
</span></span><span class=line><span class=cl>putstatic i // çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i <span class=nv>é™æ€å˜é‡i</span><span class=o>=</span><span class=m>1</span> 
</span></span><span class=line><span class=cl>iconst_1 // çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1 
</span></span><span class=line><span class=cl>isub // çº¿ç¨‹2-è‡ªå‡ <span class=nv>çº¿ç¨‹å†…i</span><span class=o>=</span>-1 
</span></span><span class=line><span class=cl>putstatic i // çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i <span class=nv>é™æ€å˜é‡i</span><span class=o>=</span>-1 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong></p><p>synchronized è¯­å¥å—æ—¢å¯ä»¥ä¿è¯ä»£ç å—çš„åŸå­æ€§ï¼Œä¹ŸåŒæ—¶ä¿è¯ä»£ç å—å†…å˜é‡çš„å¯è§æ€§ã€‚ä½†ç¼ºç‚¹æ˜¯ synchronized æ˜¯å±äºé‡é‡çº§æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹æ›´ä½ ã€‚</p><p>JMMå…³äºsynchronizedçš„ä¸¤æ¡è§„å®šï¼š</p><p>ã€€ã€€1ï¼‰çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­</p><p>ã€€ã€€2ï¼‰çº¿ç¨‹åŠ é”æ—¶ï¼Œå°†æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œä»è€Œä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è·å–æœ€æ–°çš„å€¼</p><p>ã€€ã€€ã€€ï¼ˆæ³¨æ„ï¼šåŠ é”ä¸è§£é”éœ€è¦æ˜¯åŒä¸€æŠŠé”ï¼‰</p><p>é€šè¿‡ä»¥ä¸Šä¸¤ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°synchronizedèƒ½å¤Ÿå®ç°å¯è§æ€§ã€‚åŒæ—¶ï¼Œç”±äºsynchronizedå…·æœ‰åŒæ­¥é”ï¼Œæ‰€ä»¥å®ƒä¹Ÿå…·æœ‰åŸå­æ€§</p><p>å¦‚æœåœ¨å‰é¢ç¤ºä¾‹çš„æ­»å¾ªç¯ä¸­åŠ å…¥ System.out.println() ä¼šå‘ç°å³ä½¿ä¸åŠ  volatile ä¿®é¥°ç¬¦ï¼Œçº¿ç¨‹ t ä¹Ÿèƒ½æ­£ç¡®çœ‹åˆ° å¯¹ run å˜é‡çš„ä¿®æ”¹äº†ï¼Œæƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆï¼Ÿ(printlnæ–¹æ³•ä¸­æœ‰synchronizedä»£ç å—ä¿è¯äº†å¯è§æ€§)</p><p>synchronizedå…³é”®å­—ä¸èƒ½é˜»æ­¢æŒ‡ä»¤é‡æ’ï¼Œä½†åœ¨ä¸€å®šç¨‹åº¦ä¸Šèƒ½ä¿è¯æœ‰åºæ€§ï¼ˆå¦‚æœå…±äº«å˜é‡æ²¡æœ‰é€ƒé€¸å‡ºåŒæ­¥ä»£ç å—çš„è¯ï¼‰ã€‚å› ä¸ºåœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹æŒ‡ä»¤é‡æ’ä¸å½±å“ç»“æœï¼Œç›¸å½“äºä¿éšœäº†æœ‰åºæ€§ã€‚</p></blockquote><h4 id=font-colororange-æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢font-1><a href=#font-colororange-%e6%a8%a1%e5%bc%8f%e4%b9%8b%e4%b8%a4%e9%98%b6%e6%ae%b5%e7%bb%88%e6%ad%a2font-1 class=header-anchor>#</a>
<font color=orange>* æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢</font></h4><p>Two Phase Termination</p><p>åœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•â€œä¼˜é›…â€ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿè¿™é‡Œçš„ã€ä¼˜é›…ã€‘æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼šã€‚</p><h5 id=1é”™è¯¯æ€è·¯><a href=#1%e9%94%99%e8%af%af%e6%80%9d%e8%b7%af class=header-anchor>#</a>
1.é”™è¯¯æ€è·¯</h5><ul><li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹<ul><li>stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œ å…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”</li></ul></li><li>ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹<ul><li>ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢</li></ul></li></ul><h5 id=2ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼><a href=#2%e4%b8%a4%e9%98%b6%e6%ae%b5%e7%bb%88%e6%ad%a2%e6%a8%a1%e5%bc%8f class=header-anchor>#</a>
2.ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</h5><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220305211507893.png width=900 height=600 loading=lazy decoding=async alt=image-20220305211507893 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>åˆ©ç”¨ isInterrupted</strong></p><p>interrupt å¯ä»¥æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œæ— è®ºè¿™ä¸ªçº¿ç¨‹æ˜¯åœ¨ sleepï¼Œwaitï¼Œè¿˜æ˜¯æ­£å¸¸è¿è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-229-1><a class=lnlinks href=#hl-229-1> 1</a>
</span><span class=lnt id=hl-229-2><a class=lnlinks href=#hl-229-2> 2</a>
</span><span class=lnt id=hl-229-3><a class=lnlinks href=#hl-229-3> 3</a>
</span><span class=lnt id=hl-229-4><a class=lnlinks href=#hl-229-4> 4</a>
</span><span class=lnt id=hl-229-5><a class=lnlinks href=#hl-229-5> 5</a>
</span><span class=lnt id=hl-229-6><a class=lnlinks href=#hl-229-6> 6</a>
</span><span class=lnt id=hl-229-7><a class=lnlinks href=#hl-229-7> 7</a>
</span><span class=lnt id=hl-229-8><a class=lnlinks href=#hl-229-8> 8</a>
</span><span class=lnt id=hl-229-9><a class=lnlinks href=#hl-229-9> 9</a>
</span><span class=lnt id=hl-229-10><a class=lnlinks href=#hl-229-10>10</a>
</span><span class=lnt id=hl-229-11><a class=lnlinks href=#hl-229-11>11</a>
</span><span class=lnt id=hl-229-12><a class=lnlinks href=#hl-229-12>12</a>
</span><span class=lnt id=hl-229-13><a class=lnlinks href=#hl-229-13>13</a>
</span><span class=lnt id=hl-229-14><a class=lnlinks href=#hl-229-14>14</a>
</span><span class=lnt id=hl-229-15><a class=lnlinks href=#hl-229-15>15</a>
</span><span class=lnt id=hl-229-16><a class=lnlinks href=#hl-229-16>16</a>
</span><span class=lnt id=hl-229-17><a class=lnlinks href=#hl-229-17>17</a>
</span><span class=lnt id=hl-229-18><a class=lnlinks href=#hl-229-18>18</a>
</span><span class=lnt id=hl-229-19><a class=lnlinks href=#hl-229-19>19</a>
</span><span class=lnt id=hl-229-20><a class=lnlinks href=#hl-229-20>20</a>
</span><span class=lnt id=hl-229-21><a class=lnlinks href=#hl-229-21>21</a>
</span><span class=lnt id=hl-229-22><a class=lnlinks href=#hl-229-22>22</a>
</span><span class=lnt id=hl-229-23><a class=lnlinks href=#hl-229-23>23</a>
</span><span class=lnt id=hl-229-24><a class=lnlinks href=#hl-229-24>24</a>
</span><span class=lnt id=hl-229-25><a class=lnlinks href=#hl-229-25>25</a>
</span><span class=lnt id=hl-229-26><a class=lnlinks href=#hl-229-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>TPTInterrupt</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>current</span><span class=p>.</span><span class=na>isInterrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ–™ç†åäº‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å°†ç»“æœä¿å­˜&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//æ‰“æ–­sleepçº¿ç¨‹ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œæ‰€ä»¥è¦æ·»åŠ æ ‡è®°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>current</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ‰§è¡Œç›‘æ§æ“ä½œ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;ç›‘æ§çº¿ç¨‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è°ƒç”¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-230-1><a class=lnlinks href=#hl-230-1>1</a>
</span><span class=lnt id=hl-230-2><a class=lnlinks href=#hl-230-2>2</a>
</span><span class=lnt id=hl-230-3><a class=lnlinks href=#hl-230-3>3</a>
</span><span class=lnt id=hl-230-4><a class=lnlinks href=#hl-230-4>4</a>
</span><span class=lnt id=hl-230-5><a class=lnlinks href=#hl-230-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TPTInterrupt</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TPTInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>3500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;stop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-231-1><a class=lnlinks href=#hl-231-1>1</a>
</span><span class=lnt id=hl-231-2><a class=lnlinks href=#hl-231-2>2</a>
</span><span class=lnt id=hl-231-3><a class=lnlinks href=#hl-231-3>3</a>
</span><span class=lnt id=hl-231-4><a class=lnlinks href=#hl-231-4>4</a>
</span><span class=lnt id=hl-231-5><a class=lnlinks href=#hl-231-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:49:42.915 c.TwoPhaseTermination <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:49:43.919 c.TwoPhaseTermination <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:49:44.919 c.TwoPhaseTermination <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:49:45.413 c.TestTwoPhaseTermination <span class=o>[</span>main<span class=o>]</span> - stop 
</span></span><span class=line><span class=cl>11:49:45.413 c.TwoPhaseTermination <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - æ–™ç†åäº‹
</span></span></code></pre></td></tr></table></div></div><h5 id=åˆ©ç”¨volatileä¿®é¥°çš„åœæ­¢æ ‡è®°><a href=#%e5%88%a9%e7%94%a8volatile%e4%bf%ae%e9%a5%b0%e7%9a%84%e5%81%9c%e6%ad%a2%e6%a0%87%e8%ae%b0 class=header-anchor>#</a>
åˆ©ç”¨volatileä¿®é¥°çš„åœæ­¢æ ‡è®°</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-232-1><a class=lnlinks href=#hl-232-1> 1</a>
</span><span class=lnt id=hl-232-2><a class=lnlinks href=#hl-232-2> 2</a>
</span><span class=lnt id=hl-232-3><a class=lnlinks href=#hl-232-3> 3</a>
</span><span class=lnt id=hl-232-4><a class=lnlinks href=#hl-232-4> 4</a>
</span><span class=lnt id=hl-232-5><a class=lnlinks href=#hl-232-5> 5</a>
</span><span class=lnt id=hl-232-6><a class=lnlinks href=#hl-232-6> 6</a>
</span><span class=lnt id=hl-232-7><a class=lnlinks href=#hl-232-7> 7</a>
</span><span class=lnt id=hl-232-8><a class=lnlinks href=#hl-232-8> 8</a>
</span><span class=lnt id=hl-232-9><a class=lnlinks href=#hl-232-9> 9</a>
</span><span class=lnt id=hl-232-10><a class=lnlinks href=#hl-232-10>10</a>
</span><span class=lnt id=hl-232-11><a class=lnlinks href=#hl-232-11>11</a>
</span><span class=lnt id=hl-232-12><a class=lnlinks href=#hl-232-12>12</a>
</span><span class=lnt id=hl-232-13><a class=lnlinks href=#hl-232-13>13</a>
</span><span class=lnt id=hl-232-14><a class=lnlinks href=#hl-232-14>14</a>
</span><span class=lnt id=hl-232-15><a class=lnlinks href=#hl-232-15>15</a>
</span><span class=lnt id=hl-232-16><a class=lnlinks href=#hl-232-16>16</a>
</span><span class=lnt id=hl-232-17><a class=lnlinks href=#hl-232-17>17</a>
</span><span class=lnt id=hl-232-18><a class=lnlinks href=#hl-232-18>18</a>
</span><span class=lnt id=hl-232-19><a class=lnlinks href=#hl-232-19>19</a>
</span><span class=lnt id=hl-232-20><a class=lnlinks href=#hl-232-20>20</a>
</span><span class=lnt id=hl-232-21><a class=lnlinks href=#hl-232-21>21</a>
</span><span class=lnt id=hl-232-22><a class=lnlinks href=#hl-232-22>22</a>
</span><span class=lnt id=hl-232-23><a class=lnlinks href=#hl-232-23>23</a>
</span><span class=lnt id=hl-232-24><a class=lnlinks href=#hl-232-24>24</a>
</span><span class=lnt id=hl-232-25><a class=lnlinks href=#hl-232-25>25</a>
</span><span class=lnt id=hl-232-26><a class=lnlinks href=#hl-232-26>26</a>
</span><span class=lnt id=hl-232-27><a class=lnlinks href=#hl-232-27>27</a>
</span><span class=lnt id=hl-232-28><a class=lnlinks href=#hl-232-28>28</a>
</span><span class=lnt id=hl-232-29><a class=lnlinks href=#hl-232-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åœæ­¢æ ‡è®°ç”¨ volatile æ˜¯ä¸ºäº†ä¿è¯è¯¥å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå³ä¸»çº¿ç¨‹æŠŠå®ƒä¿®æ”¹ä¸º true å¯¹ t1 çº¿ç¨‹å¯è§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>TPTVolatile</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>stop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>stop</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ–™ç†åäº‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å°†ç»“æœä¿å­˜&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ‰§è¡Œç›‘æ§æ“ä½œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=s>&#34;ç›‘æ§çº¿ç¨‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//è®©çº¿ç¨‹ç«‹å³åœæ­¢è€Œä¸æ˜¯ç­‰å¾…sleepç»“æŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è°ƒç”¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-233-1><a class=lnlinks href=#hl-233-1>1</a>
</span><span class=lnt id=hl-233-2><a class=lnlinks href=#hl-233-2>2</a>
</span><span class=lnt id=hl-233-3><a class=lnlinks href=#hl-233-3>3</a>
</span><span class=lnt id=hl-233-4><a class=lnlinks href=#hl-233-4>4</a>
</span><span class=lnt id=hl-233-5><a class=lnlinks href=#hl-233-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TPTVolatile</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TPTVolatile</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>3500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;stop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-234-1><a class=lnlinks href=#hl-234-1>1</a>
</span><span class=lnt id=hl-234-2><a class=lnlinks href=#hl-234-2>2</a>
</span><span class=lnt id=hl-234-3><a class=lnlinks href=#hl-234-3>3</a>
</span><span class=lnt id=hl-234-4><a class=lnlinks href=#hl-234-4>4</a>
</span><span class=lnt id=hl-234-5><a class=lnlinks href=#hl-234-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:54:52.003 c.TPTVolatile <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:54:53.006 c.TPTVolatile <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:54:54.007 c.TPTVolatile <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - å°†ç»“æœä¿å­˜
</span></span><span class=line><span class=cl>11:54:54.502 c.TestTwoPhaseTermination <span class=o>[</span>main<span class=o>]</span> - stop 
</span></span><span class=line><span class=cl>11:54:54.502 c.TPTVolatile <span class=o>[</span>ç›‘æ§çº¿ç¨‹<span class=o>]</span> - æ–™ç†åäº‹
</span></span></code></pre></td></tr></table></div></div><h4 id=font-colororange-æ¨¡å¼ä¹‹-balkingfont><a href=#font-colororange-%e6%a8%a1%e5%bc%8f%e4%b9%8b-balkingfont class=header-anchor>#</a>
<font color=orange>* æ¨¡å¼ä¹‹ Balking</font></h4><h5 id=1å®šä¹‰-2><a href=#1%e5%ae%9a%e4%b9%89-2 class=header-anchor>#</a>
1.å®šä¹‰</h5><p>Balking ï¼ˆçŠ¹è±«ï¼‰æ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹å°±æ— éœ€å†åš äº†ï¼Œç›´æ¥ç»“æŸè¿”å›</p><h5 id=2å®ç°-2><a href=#2%e5%ae%9e%e7%8e%b0-2 class=header-anchor>#</a>
2.å®ç°</h5><p>ä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-235-1><a class=lnlinks href=#hl-235-1> 1</a>
</span><span class=lnt id=hl-235-2><a class=lnlinks href=#hl-235-2> 2</a>
</span><span class=lnt id=hl-235-3><a class=lnlinks href=#hl-235-3> 3</a>
</span><span class=lnt id=hl-235-4><a class=lnlinks href=#hl-235-4> 4</a>
</span><span class=lnt id=hl-235-5><a class=lnlinks href=#hl-235-5> 5</a>
</span><span class=lnt id=hl-235-6><a class=lnlinks href=#hl-235-6> 6</a>
</span><span class=lnt id=hl-235-7><a class=lnlinks href=#hl-235-7> 7</a>
</span><span class=lnt id=hl-235-8><a class=lnlinks href=#hl-235-8> 8</a>
</span><span class=lnt id=hl-235-9><a class=lnlinks href=#hl-235-9> 9</a>
</span><span class=lnt id=hl-235-10><a class=lnlinks href=#hl-235-10>10</a>
</span><span class=lnt id=hl-235-11><a class=lnlinks href=#hl-235-11>11</a>
</span><span class=lnt id=hl-235-12><a class=lnlinks href=#hl-235-12>12</a>
</span><span class=lnt id=hl-235-13><a class=lnlinks href=#hl-235-13>13</a>
</span><span class=lnt id=hl-235-14><a class=lnlinks href=#hl-235-14>14</a>
</span><span class=lnt id=hl-235-15><a class=lnlinks href=#hl-235-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MonitorService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç”¨æ¥è¡¨ç¤ºæ˜¯å¦å·²ç»æœ‰çº¿ç¨‹å·²ç»åœ¨æ‰§è¡Œå¯åŠ¨äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>starting</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å°è¯•å¯åŠ¨ç›‘æ§çº¿ç¨‹...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>starting</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>starting</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//å…¶å®synchronizedå¤–é¢è¿˜å¯ä»¥å†å¥—ä¸€å±‚ifï¼Œæˆ–è€…æ”¹ä¸ºif(!starting)ï¼Œifæ¡†åç›´æ¥return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// çœŸæ­£å¯åŠ¨ç›‘æ§çº¿ç¨‹...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å½“å‰ç«¯é¡µé¢å¤šæ¬¡ç‚¹å‡»æŒ‰é’®è°ƒç”¨ start æ—¶</p><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-236-1><a class=lnlinks href=#hl-236-1>1</a>
</span><span class=lnt id=hl-236-2><a class=lnlinks href=#hl-236-2>2</a>
</span><span class=lnt id=hl-236-3><a class=lnlinks href=#hl-236-3>3</a>
</span><span class=lnt id=hl-236-4><a class=lnlinks href=#hl-236-4>4</a>
</span><span class=lnt id=hl-236-5><a class=lnlinks href=#hl-236-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>[</span><span class=n>http</span><span class=o>-</span><span class=n>nio</span><span class=o>-</span><span class=n>8080</span><span class=o>-</span><span class=n>exec</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>monitor</span><span class=p>.</span><span class=na>service</span><span class=p>.</span><span class=na>MonitorService</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>è¯¥ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨</span><span class=o>?</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>http</span><span class=o>-</span><span class=n>nio</span><span class=o>-</span><span class=n>8080</span><span class=o>-</span><span class=n>exec</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>monitor</span><span class=p>.</span><span class=na>service</span><span class=p>.</span><span class=na>MonitorService</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>http</span><span class=o>-</span><span class=n>nio</span><span class=o>-</span><span class=n>8080</span><span class=o>-</span><span class=n>exec</span><span class=o>-</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>monitor</span><span class=p>.</span><span class=na>service</span><span class=p>.</span><span class=na>MonitorService</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>è¯¥ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨</span><span class=o>?</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>http</span><span class=o>-</span><span class=n>nio</span><span class=o>-</span><span class=n>8080</span><span class=o>-</span><span class=n>exec</span><span class=o>-</span><span class=n>3</span><span class=o>]</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>monitor</span><span class=p>.</span><span class=na>service</span><span class=p>.</span><span class=na>MonitorService</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>è¯¥ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨</span><span class=o>?</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>http</span><span class=o>-</span><span class=n>nio</span><span class=o>-</span><span class=n>8080</span><span class=o>-</span><span class=n>exec</span><span class=o>-</span><span class=n>4</span><span class=o>]</span><span class=w> </span><span class=n>cn</span><span class=p>.</span><span class=na>itcast</span><span class=p>.</span><span class=na>monitor</span><span class=p>.</span><span class=na>service</span><span class=p>.</span><span class=na>MonitorService</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>è¯¥ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨</span><span class=o>?</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å®ƒè¿˜ç»å¸¸ç”¨æ¥å®ç°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-237-1><a class=lnlinks href=#hl-237-1> 1</a>
</span><span class=lnt id=hl-237-2><a class=lnlinks href=#hl-237-2> 2</a>
</span><span class=lnt id=hl-237-3><a class=lnlinks href=#hl-237-3> 3</a>
</span><span class=lnt id=hl-237-4><a class=lnlinks href=#hl-237-4> 4</a>
</span><span class=lnt id=hl-237-5><a class=lnlinks href=#hl-237-5> 5</a>
</span><span class=lnt id=hl-237-6><a class=lnlinks href=#hl-237-6> 6</a>
</span><span class=lnt id=hl-237-7><a class=lnlinks href=#hl-237-7> 7</a>
</span><span class=lnt id=hl-237-8><a class=lnlinks href=#hl-237-8> 8</a>
</span><span class=lnt id=hl-237-9><a class=lnlinks href=#hl-237-9> 9</a>
</span><span class=lnt id=hl-237-10><a class=lnlinks href=#hl-237-10>10</a>
</span><span class=lnt id=hl-237-11><a class=lnlinks href=#hl-237-11>11</a>
</span><span class=lnt id=hl-237-12><a class=lnlinks href=#hl-237-12>12</a>
</span><span class=lnt id=hl-237-13><a class=lnlinks href=#hl-237-13>13</a>
</span><span class=lnt id=hl-237-14><a class=lnlinks href=#hl-237-14>14</a>
</span><span class=lnt id=hl-237-15><a class=lnlinks href=#hl-237-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯¹æ¯”ä¸€ä¸‹ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ï¼šä¿æŠ¤æ€§æš‚åœæ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶çº¿ç¨‹ç­‰å¾…ã€‚</p><h2 id=53-æœ‰åºæ€§><a href=#53-%e6%9c%89%e5%ba%8f%e6%80%a7 class=header-anchor>#</a>
5.3 æœ‰åºæ€§</h2><p>JVM ä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåºï¼Œæ€è€ƒä¸‹é¢ä¸€æ®µä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-238-1><a class=lnlinks href=#hl-238-1>1</a>
</span><span class=lnt id=hl-238-2><a class=lnlinks href=#hl-238-2>2</a>
</span><span class=lnt id=hl-238-3><a class=lnlinks href=#hl-238-3>3</a>
</span><span class=lnt id=hl-238-4><a class=lnlinks href=#hl-238-4>4</a>
</span><span class=lnt id=hl-238-5><a class=lnlinks href=#hl-238-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// åœ¨æŸä¸ªçº¿ç¨‹å†…æ‰§è¡Œå¦‚ä¸‹èµ‹å€¼æ“ä½œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè‡³äºæ˜¯å…ˆæ‰§è¡Œ i è¿˜æ˜¯ å…ˆæ‰§è¡Œ j ï¼Œå¯¹æœ€ç»ˆçš„ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä»£ç çœŸæ­£æ‰§è¡Œæ—¶ï¼Œæ—¢å¯ä»¥æ˜¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-239-1><a class=lnlinks href=#hl-239-1>1</a>
</span><span class=lnt id=hl-239-2><a class=lnlinks href=#hl-239-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¹Ÿå¯ä»¥æ˜¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-240-1><a class=lnlinks href=#hl-240-1>1</a>
</span><span class=lnt id=hl-240-2><a class=lnlinks href=#hl-240-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™ç§ç‰¹æ€§ç§°ä¹‹ä¸ºã€æŒ‡ä»¤é‡æ’ã€ï¼Œå¤šçº¿ç¨‹ä¸‹ã€æŒ‡ä»¤é‡æ’ã€ä¼šå½±å“æ­£ç¡®æ€§ã€‚ä¸ºä»€ä¹ˆè¦æœ‰é‡æ’æŒ‡ä»¤è¿™é¡¹ä¼˜åŒ–å‘¢ï¼Ÿä» CPU æ‰§è¡ŒæŒ‡ä»¤çš„åŸç†æ¥ç†è§£ä¸€ä¸‹å§</p><h4 id=font-colorblue-åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œfont><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b%e6%8c%87%e4%bb%a4%e7%ba%a7%e5%b9%b6%e8%a1%8cfont class=header-anchor>#</a>
<font color=blue>* åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ</font></h4><h5 id=åè¯><a href=#%e5%90%8d%e8%af%8d class=header-anchor>#</a>
åè¯</h5><p><strong>Clock Cycle Time</strong></p><p>ä¸»é¢‘çš„æ¦‚å¿µå¤§å®¶æ¥è§¦çš„æ¯”è¾ƒå¤šï¼Œè€Œ CPU çš„ Clock Cycle Timeï¼ˆæ—¶é’Ÿå‘¨æœŸæ—¶é—´ï¼‰ï¼Œç­‰äºä¸»é¢‘çš„å€’æ•°ï¼Œæ„æ€æ˜¯ CPU èƒ½ å¤Ÿè¯†åˆ«çš„æœ€å°æ—¶é—´å•ä½ï¼Œæ¯”å¦‚è¯´ 4G ä¸»é¢‘çš„ CPU çš„ Clock Cycle Time å°±æ˜¯ 0.25 nsï¼Œä½œä¸ºå¯¹æ¯”ï¼Œæˆ‘ä»¬å¢™ä¸ŠæŒ‚é’Ÿçš„ Cycle Time æ˜¯ 1s</p><p>ä¾‹å¦‚ï¼Œè¿è¡Œä¸€æ¡åŠ æ³•æŒ‡ä»¤ä¸€èˆ¬éœ€è¦ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸæ—¶é—´</p><p><strong>CPI</strong></p><p>æœ‰çš„æŒ‡ä»¤éœ€è¦æ›´å¤šçš„æ—¶é’Ÿå‘¨æœŸæ—¶é—´ï¼Œæ‰€ä»¥å¼•å‡ºäº† CPI ï¼ˆCycles Per Instructionï¼‰æŒ‡ä»¤å¹³å‡æ—¶é’Ÿå‘¨æœŸæ•°</p><p><strong>IPC</strong></p><p>IPCï¼ˆInstruction Per Clock Cycleï¼‰ å³ CPI çš„å€’æ•°ï¼Œè¡¨ç¤ºæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸèƒ½å¤Ÿè¿è¡Œçš„æŒ‡ä»¤æ•°</p><p><strong>CPU æ‰§è¡Œæ—¶é—´</strong></p><p>ç¨‹åºçš„ CPU æ‰§è¡Œæ—¶é—´ï¼Œå³æˆ‘ä»¬å‰é¢æåˆ°çš„ user + system æ—¶é—´ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å…¬å¼æ¥è¡¨ç¤º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-241-1><a class=lnlinks href=#hl-241-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ç¨‹åº</span><span class=w> </span><span class=n>CPU</span><span class=w> </span><span class=n>æ‰§è¡Œæ—¶é—´</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>æŒ‡ä»¤æ•°</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>CPI</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>Clock</span><span class=w> </span><span class=n>Cycle</span><span class=w> </span><span class=n>Time</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=æŒ‡ä»¤é‡æ’åºä¼˜åŒ–><a href=#%e6%8c%87%e4%bb%a4%e9%87%8d%e6%8e%92%e5%ba%8f%e4%bc%98%e5%8c%96 class=header-anchor>#</a>
æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</h5><p>äº‹å®ä¸Šï¼Œç°ä»£å¤„ç†å™¨ä¼šè®¾è®¡ä¸ºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå®Œæˆä¸€æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„ CPU æŒ‡ä»¤ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿå¯ä»¥æƒ³åˆ°æŒ‡ä»¤ è¿˜å¯ä»¥å†åˆ’åˆ†æˆä¸€ä¸ªä¸ªæ›´å°çš„é˜¶æ®µï¼Œä¾‹å¦‚ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥åˆ†ä¸ºï¼š <code>å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›</code> è¿™ 5 ä¸ªé˜¶æ®µ</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306122605032.png width=900 height=600 loading=lazy decoding=async alt=image-20220306122605032 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><blockquote><p><strong>æœ¯è¯­å‚è€ƒ</strong>ï¼š</p><ul><li>instruction fetch (IF)</li><li>instruction decode (ID)</li><li>execute (EX)</li><li>memory access (MEM)</li><li>register write back (WB)</li></ul></blockquote><p>åœ¨ä¸æ”¹å˜ç¨‹åºç»“æœçš„å‰æä¸‹ï¼Œè¿™äº›æŒ‡ä»¤çš„å„ä¸ªé˜¶æ®µå¯ä»¥é€šè¿‡<strong>é‡æ’åº</strong>å’Œ<strong>ç»„åˆ</strong>æ¥å®ç°æŒ‡ä»¤çº§å¹¶è¡Œï¼Œè¿™ä¸€æŠ€æœ¯åœ¨ 80&rsquo;s ä¸­ å¶åˆ° 90&rsquo;s ä¸­å¶å æ®äº†è®¡ç®—æ¶æ„çš„é‡è¦åœ°ä½ã€‚</p><blockquote><p><strong>æç¤º</strong>ï¼š</p><p>åˆ†é˜¶æ®µï¼Œåˆ†å·¥æ˜¯æå‡æ•ˆç‡çš„å…³é”®ï¼</p></blockquote><p>æŒ‡ä»¤é‡æ’çš„å‰ææ˜¯ï¼Œé‡æ’æŒ‡ä»¤ä¸èƒ½å½±å“ç»“æœï¼Œä¾‹å¦‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-242-1><a class=lnlinks href=#hl-242-1>1</a>
</span><span class=lnt id=hl-242-2><a class=lnlinks href=#hl-242-2>2</a>
</span><span class=lnt id=hl-242-3><a class=lnlinks href=#hl-242-3>3</a>
</span><span class=lnt id=hl-242-4><a class=lnlinks href=#hl-242-4>4</a>
</span><span class=lnt id=hl-242-5><a class=lnlinks href=#hl-242-5>5</a>
</span><span class=lnt id=hl-242-6><a class=lnlinks href=#hl-242-6>6</a>
</span><span class=lnt id=hl-242-7><a class=lnlinks href=#hl-242-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å¯ä»¥é‡æ’çš„ä¾‹å­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=c1>// æŒ‡ä»¤1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w> </span><span class=c1>// æŒ‡ä»¤2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä¸èƒ½é‡æ’çš„ä¾‹å­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=c1>// æŒ‡ä»¤1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=c1>// æŒ‡ä»¤2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>å‚è€ƒ</strong>ï¼š</p><p><a class=link href=https://en.wikipedia.org/wiki/Scoreboarding target=_blank rel=noopener>Scoreboarding
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>and the <a class=link href=https://en.wikipedia.org/wiki/Tomasulo_algorithm target=_blank rel=noopener>Tomasulo algorithm
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>(which is similar to scoreboarding but makes use of <a class=link href=https://en.wikipedia.org/wiki/Register_renaming target=_blank rel=noopener>register renaming
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>)are two of the most common techniques for implementing out-of-order execution and instruction-level parallelism.</p></blockquote><h5 id=æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨><a href=#%e6%94%af%e6%8c%81%e6%b5%81%e6%b0%b4%e7%ba%bf%e7%9a%84%e5%a4%84%e7%90%86%e5%99%a8 class=header-anchor>#</a>
æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨</h5><p>ç°ä»£ CPU æ”¯æŒ<strong>å¤šçº§æŒ‡ä»¤æµæ°´çº¿</strong>ï¼Œä¾‹å¦‚æ”¯æŒåŒæ—¶æ‰§è¡Œ <code>å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›</code> çš„å¤„ç† å™¨ï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸º<strong>äº”çº§æŒ‡ä»¤æµæ°´çº¿</strong>ã€‚è¿™æ—¶ CPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶è¿è¡Œäº”æ¡æŒ‡ä»¤çš„ä¸åŒé˜¶æ®µï¼ˆç›¸å½“äºä¸€ æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„å¤æ‚æŒ‡ä»¤ï¼‰ï¼ŒIPC = 1ï¼Œæœ¬è´¨ä¸Šï¼Œæµæ°´çº¿æŠ€æœ¯å¹¶ä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†å®ƒå˜ç›¸åœ°æé«˜äº† æŒ‡ä»¤åœ°ååç‡ã€‚</p><blockquote><p><strong>æç¤º</strong>ï¼š</p><p>å¥”è…¾å››ï¼ˆPentium 4ï¼‰æ”¯æŒé«˜è¾¾ 35 çº§æµæ°´çº¿ï¼Œä½†ç”±äºåŠŸè€—å¤ªé«˜è¢«åºŸå¼ƒ</p></blockquote><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306123819512.png width=900 height=600 loading=lazy decoding=async alt=image-20220306123819512 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=superscalar-å¤„ç†å™¨><a href=#superscalar-%e5%a4%84%e7%90%86%e5%99%a8 class=header-anchor>#</a>
SuperScalar å¤„ç†å™¨</h5><p>å¤§å¤šæ•°å¤„ç†å™¨åŒ…å«å¤šä¸ªæ‰§è¡Œå•å…ƒï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰è®¡ç®—åŠŸèƒ½éƒ½é›†ä¸­åœ¨ä¸€èµ·ï¼Œå¯ä»¥å†ç»†åˆ†ä¸ºæ•´æ•°è¿ç®—å•å…ƒã€æµ®ç‚¹æ•°è¿ç®—å• å…ƒç­‰ï¼Œè¿™æ ·å¯ä»¥æŠŠå¤šæ¡æŒ‡ä»¤ä¹Ÿå¯ä»¥åšåˆ°å¹¶è¡Œè·å–ã€è¯‘ç ç­‰ï¼ŒCPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼Œæ‰§è¡Œå¤šäºä¸€æ¡æŒ‡ä»¤ï¼ŒIPC > 1</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306123933327.png width=900 height=600 loading=lazy decoding=async alt=image-20220306123933327 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=è¯¡å¼‚çš„ç»“æœ><a href=#%e8%af%a1%e5%bc%82%e7%9a%84%e7%bb%93%e6%9e%9c class=header-anchor>#</a>
è¯¡å¼‚çš„ç»“æœ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-243-1><a class=lnlinks href=#hl-243-1> 1</a>
</span><span class=lnt id=hl-243-2><a class=lnlinks href=#hl-243-2> 2</a>
</span><span class=lnt id=hl-243-3><a class=lnlinks href=#hl-243-3> 3</a>
</span><span class=lnt id=hl-243-4><a class=lnlinks href=#hl-243-4> 4</a>
</span><span class=lnt id=hl-243-5><a class=lnlinks href=#hl-243-5> 5</a>
</span><span class=lnt id=hl-243-6><a class=lnlinks href=#hl-243-6> 6</a>
</span><span class=lnt id=hl-243-7><a class=lnlinks href=#hl-243-7> 7</a>
</span><span class=lnt id=hl-243-8><a class=lnlinks href=#hl-243-8> 8</a>
</span><span class=lnt id=hl-243-9><a class=lnlinks href=#hl-243-9> 9</a>
</span><span class=lnt id=hl-243-10><a class=lnlinks href=#hl-243-10>10</a>
</span><span class=lnt id=hl-243-11><a class=lnlinks href=#hl-243-11>11</a>
</span><span class=lnt id=hl-243-12><a class=lnlinks href=#hl-243-12>12</a>
</span><span class=lnt id=hl-243-13><a class=lnlinks href=#hl-243-13>13</a>
</span><span class=lnt id=hl-243-14><a class=lnlinks href=#hl-243-14>14</a>
</span><span class=lnt id=hl-243-15><a class=lnlinks href=#hl-243-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor1</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ready</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor2</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§ r1 ç”¨æ¥ä¿å­˜ç»“æœï¼Œé—®ï¼Œå¯èƒ½çš„ç»“æœæœ‰å‡ ç§ï¼Ÿ</p><p>æœ‰åŒå­¦è¿™ä¹ˆåˆ†æ</p><p>æƒ…å†µ1ï¼šçº¿ç¨‹1 å…ˆæ‰§è¡Œï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1</p><p>æƒ…å†µ2ï¼šçº¿ç¨‹2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥ else åˆ†æ”¯ï¼Œç»“æœä¸º1</p><p>æƒ…å†µ3ï¼šçº¿ç¨‹2 æ‰§è¡Œåˆ° ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ï¼ˆå› ä¸º num å·²ç»æ‰§è¡Œè¿‡äº†ï¼‰</p><p>ä½†æˆ‘å‘Šè¯‰ä½ ï¼Œç»“æœè¿˜æœ‰å¯èƒ½æ˜¯ 0 ğŸ˜ğŸ˜ğŸ˜ï¼Œä¿¡ä¸ä¿¡å§ï¼</p><p>è¿™ç§æƒ…å†µä¸‹æ˜¯ï¼šçº¿ç¨‹2 æ‰§è¡Œ ready = trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹1ï¼Œè¿›å…¥ if åˆ†æ”¯ï¼Œç›¸åŠ ä¸º 0ï¼Œå†åˆ‡å›çº¿ç¨‹2 æ‰§è¡Œ num = 2</p><p>ç›¸ä¿¡å¾ˆå¤šäººå·²ç»æ™•äº† ğŸ˜µğŸ˜µğŸ˜µ</p><p>è¿™ç§ç°è±¡å«åšæŒ‡ä»¤é‡æ’ï¼Œæ˜¯ JIT ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªç°è±¡éœ€è¦é€šè¿‡å¤§é‡æµ‹è¯•æ‰èƒ½å¤ç°ï¼š</p><p>å€ŸåŠ© java å¹¶å‘å‹æµ‹å·¥å…· jcstress <a class=link href=https://wiki.openjdk.java.net/display/CodeTools/jcstress target=_blank rel=noopener>https://wiki.openjdk.java.net/display/CodeTools/jcstress
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-244-1><a class=lnlinks href=#hl-244-1>1</a>
</span><span class=lnt id=hl-244-2><a class=lnlinks href=#hl-244-2>2</a>
</span><span class=lnt id=hl-244-3><a class=lnlinks href=#hl-244-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mvn archetype:generate -DinteractiveMode<span class=o>=</span><span class=nb>false</span> -DarchetypeGroupId<span class=o>=</span>org.openjdk.jcstress -
</span></span><span class=line><span class=cl><span class=nv>DarchetypeArtifactId</span><span class=o>=</span>jcstress-java-test-archetype -DarchetypeVersion<span class=o>=</span>0.5 -DgroupId<span class=o>=</span>cn.itcast -
</span></span><span class=line><span class=cl><span class=nv>DartifactId</span><span class=o>=</span>ordering -Dversion<span class=o>=</span>1.0 
</span></span></code></pre></td></tr></table></div></div><p>åˆ›å»º maven é¡¹ç›®ï¼Œæä¾›å¦‚ä¸‹æµ‹è¯•ç±»</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-245-1><a class=lnlinks href=#hl-245-1> 1</a>
</span><span class=lnt id=hl-245-2><a class=lnlinks href=#hl-245-2> 2</a>
</span><span class=lnt id=hl-245-3><a class=lnlinks href=#hl-245-3> 3</a>
</span><span class=lnt id=hl-245-4><a class=lnlinks href=#hl-245-4> 4</a>
</span><span class=lnt id=hl-245-5><a class=lnlinks href=#hl-245-5> 5</a>
</span><span class=lnt id=hl-245-6><a class=lnlinks href=#hl-245-6> 6</a>
</span><span class=lnt id=hl-245-7><a class=lnlinks href=#hl-245-7> 7</a>
</span><span class=lnt id=hl-245-8><a class=lnlinks href=#hl-245-8> 8</a>
</span><span class=lnt id=hl-245-9><a class=lnlinks href=#hl-245-9> 9</a>
</span><span class=lnt id=hl-245-10><a class=lnlinks href=#hl-245-10>10</a>
</span><span class=lnt id=hl-245-11><a class=lnlinks href=#hl-245-11>11</a>
</span><span class=lnt id=hl-245-12><a class=lnlinks href=#hl-245-12>12</a>
</span><span class=lnt id=hl-245-13><a class=lnlinks href=#hl-245-13>13</a>
</span><span class=lnt id=hl-245-14><a class=lnlinks href=#hl-245-14>14</a>
</span><span class=lnt id=hl-245-15><a class=lnlinks href=#hl-245-15>15</a>
</span><span class=lnt id=hl-245-16><a class=lnlinks href=#hl-245-16>16</a>
</span><span class=lnt id=hl-245-17><a class=lnlinks href=#hl-245-17>17</a>
</span><span class=lnt id=hl-245-18><a class=lnlinks href=#hl-245-18>18</a>
</span><span class=lnt id=hl-245-19><a class=lnlinks href=#hl-245-19>19</a>
</span><span class=lnt id=hl-245-20><a class=lnlinks href=#hl-245-20>20</a>
</span><span class=lnt id=hl-245-21><a class=lnlinks href=#hl-245-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@JCStressTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Outcome</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;4&#34;</span><span class=p>},</span><span class=w> </span><span class=n>expect</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Expect</span><span class=p>.</span><span class=na>ACCEPTABLE</span><span class=p>,</span><span class=w> </span><span class=n>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ok&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Outcome</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;0&#34;</span><span class=p>,</span><span class=w> </span><span class=n>expect</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Expect</span><span class=p>.</span><span class=na>ACCEPTABLE_INTERESTING</span><span class=p>,</span><span class=w> </span><span class=n>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;!!!!&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@State</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ConcurrencyTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Actor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor1</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>ready</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Actor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor2</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-246-1><a class=lnlinks href=#hl-246-1>1</a>
</span><span class=lnt id=hl-246-2><a class=lnlinks href=#hl-246-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mvn clean install 
</span></span><span class=line><span class=cl>java -jar target/jcstress.jar 
</span></span></code></pre></td></tr></table></div></div><p>ä¼šè¾“å‡ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„ç»“æœï¼Œæ‘˜å½•å…¶ä¸­ä¸€æ¬¡ç»“æœï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-247-1><a class=lnlinks href=#hl-247-1> 1</a>
</span><span class=lnt id=hl-247-2><a class=lnlinks href=#hl-247-2> 2</a>
</span><span class=lnt id=hl-247-3><a class=lnlinks href=#hl-247-3> 3</a>
</span><span class=lnt id=hl-247-4><a class=lnlinks href=#hl-247-4> 4</a>
</span><span class=lnt id=hl-247-5><a class=lnlinks href=#hl-247-5> 5</a>
</span><span class=lnt id=hl-247-6><a class=lnlinks href=#hl-247-6> 6</a>
</span><span class=lnt id=hl-247-7><a class=lnlinks href=#hl-247-7> 7</a>
</span><span class=lnt id=hl-247-8><a class=lnlinks href=#hl-247-8> 8</a>
</span><span class=lnt id=hl-247-9><a class=lnlinks href=#hl-247-9> 9</a>
</span><span class=lnt id=hl-247-10><a class=lnlinks href=#hl-247-10>10</a>
</span><span class=lnt id=hl-247-11><a class=lnlinks href=#hl-247-11>11</a>
</span><span class=lnt id=hl-247-12><a class=lnlinks href=#hl-247-12>12</a>
</span><span class=lnt id=hl-247-13><a class=lnlinks href=#hl-247-13>13</a>
</span><span class=lnt id=hl-247-14><a class=lnlinks href=#hl-247-14>14</a>
</span><span class=lnt id=hl-247-15><a class=lnlinks href=#hl-247-15>15</a>
</span><span class=lnt id=hl-247-16><a class=lnlinks href=#hl-247-16>16</a>
</span><span class=lnt id=hl-247-17><a class=lnlinks href=#hl-247-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>*** INTERESTING tests 
</span></span><span class=line><span class=cl> Some interesting behaviors observed. This is <span class=k>for</span> the plain curiosity. 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=m>2</span> matching <span class=nb>test</span> results. 
</span></span><span class=line><span class=cl> 	<span class=o>[</span>OK<span class=o>]</span> test.ConcurrencyTest 
</span></span><span class=line><span class=cl> 	<span class=o>(</span>JVM args: <span class=o>[</span>-XX:-TieredCompilation<span class=o>])</span> 
</span></span><span class=line><span class=cl>    Observed state 	Occurrences 	Expectation Interpretation 
</span></span><span class=line><span class=cl>    <span class=m>0</span> 				1,729 			ACCEPTABLE_INTERESTING !!!! 
</span></span><span class=line><span class=cl> 	<span class=m>1</span> 				42,617,915 		ACCEPTABLE ok 
</span></span><span class=line><span class=cl> 	<span class=m>4</span> 				5,146,627 		ACCEPTABLE ok 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 	<span class=o>[</span>OK<span class=o>]</span> test.ConcurrencyTest 
</span></span><span class=line><span class=cl> 	<span class=o>(</span>JVM args: <span class=o>[])</span> 
</span></span><span class=line><span class=cl> 	Observed state 	Occurrences 	Expectation Interpretation 
</span></span><span class=line><span class=cl> 	<span class=m>0</span> 				1,652 			ACCEPTABLE_INTERESTING !!!! 
</span></span><span class=line><span class=cl> 	<span class=m>1</span> 				46,460,657 		ACCEPTABLE ok 
</span></span><span class=line><span class=cl> 	<span class=m>4</span> 				4,571,072 		ACCEPTABLE ok 
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå‡ºç°ç»“æœä¸º 0 çš„æƒ…å†µæœ‰ 638 æ¬¡ï¼Œè™½ç„¶æ¬¡æ•°ç›¸å¯¹å¾ˆå°‘ï¼Œä½†æ¯•ç«Ÿæ˜¯å‡ºç°äº†ã€‚</p><h4 id=è§£å†³æ–¹æ³•-1><a href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-1 class=header-anchor>#</a>
è§£å†³æ–¹æ³•</h4><p>volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-248-1><a class=lnlinks href=#hl-248-1> 1</a>
</span><span class=lnt id=hl-248-2><a class=lnlinks href=#hl-248-2> 2</a>
</span><span class=lnt id=hl-248-3><a class=lnlinks href=#hl-248-3> 3</a>
</span><span class=lnt id=hl-248-4><a class=lnlinks href=#hl-248-4> 4</a>
</span><span class=lnt id=hl-248-5><a class=lnlinks href=#hl-248-5> 5</a>
</span><span class=lnt id=hl-248-6><a class=lnlinks href=#hl-248-6> 6</a>
</span><span class=lnt id=hl-248-7><a class=lnlinks href=#hl-248-7> 7</a>
</span><span class=lnt id=hl-248-8><a class=lnlinks href=#hl-248-8> 8</a>
</span><span class=lnt id=hl-248-9><a class=lnlinks href=#hl-248-9> 9</a>
</span><span class=lnt id=hl-248-10><a class=lnlinks href=#hl-248-10>10</a>
</span><span class=lnt id=hl-248-11><a class=lnlinks href=#hl-248-11>11</a>
</span><span class=lnt id=hl-248-12><a class=lnlinks href=#hl-248-12>12</a>
</span><span class=lnt id=hl-248-13><a class=lnlinks href=#hl-248-13>13</a>
</span><span class=lnt id=hl-248-14><a class=lnlinks href=#hl-248-14>14</a>
</span><span class=lnt id=hl-248-15><a class=lnlinks href=#hl-248-15>15</a>
</span><span class=lnt id=hl-248-16><a class=lnlinks href=#hl-248-16>16</a>
</span><span class=lnt id=hl-248-17><a class=lnlinks href=#hl-248-17>17</a>
</span><span class=lnt id=hl-248-18><a class=lnlinks href=#hl-248-18>18</a>
</span><span class=lnt id=hl-248-19><a class=lnlinks href=#hl-248-19>19</a>
</span><span class=lnt id=hl-248-20><a class=lnlinks href=#hl-248-20>20</a>
</span><span class=lnt id=hl-248-21><a class=lnlinks href=#hl-248-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@JCStressTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Outcome</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;4&#34;</span><span class=p>},</span><span class=w> </span><span class=n>expect</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Expect</span><span class=p>.</span><span class=na>ACCEPTABLE</span><span class=p>,</span><span class=w> </span><span class=n>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ok&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Outcome</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;0&#34;</span><span class=p>,</span><span class=w> </span><span class=n>expect</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Expect</span><span class=p>.</span><span class=na>ACCEPTABLE_INTERESTING</span><span class=p>,</span><span class=w> </span><span class=n>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;!!!!&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@State</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ConcurrencyTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Actor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor1</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>ready</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Actor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor2</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœä¸ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-249-1><a class=lnlinks href=#hl-249-1>1</a>
</span><span class=lnt id=hl-249-2><a class=lnlinks href=#hl-249-2>2</a>
</span><span class=lnt id=hl-249-3><a class=lnlinks href=#hl-249-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>*** INTERESTING tests 
</span></span><span class=line><span class=cl> Some interesting behaviors observed. This is <span class=k>for</span> the plain curiosity. 
</span></span><span class=line><span class=cl> <span class=m>0</span> matching <span class=nb>test</span> results. 
</span></span></code></pre></td></tr></table></div></div><h4 id=font-colorblue-åŸç†ä¹‹-volatilefont><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-volatilefont class=header-anchor>#</a>
<font color=blue>* åŸç†ä¹‹ volatile</font></h4><p>volatile çš„åº•å±‚å®ç°åŸç†æ˜¯å†…å­˜å±éšœï¼ŒMemory Barrierï¼ˆMemory Fenceï¼‰</p><ul><li>å¯¹ volatile å˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥å†™å±éšœ</li><li>å¯¹ volatile å˜é‡çš„è¯»æŒ‡ä»¤å‰ä¼šåŠ å…¥è¯»å±éšœ</li></ul><h5 id=å¦‚ä½•ä¿è¯å¯è§æ€§><a href=#%e5%a6%82%e4%bd%95%e4%bf%9d%e8%af%81%e5%8f%af%e8%a7%81%e6%80%a7 class=header-anchor>#</a>
å¦‚ä½•ä¿è¯å¯è§æ€§</h5><ul><li><p>å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</p></li><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-250-1><a class=lnlinks href=#hl-250-1>1</a>
</span><span class=lnt id=hl-250-2><a class=lnlinks href=#hl-250-2>2</a>
</span><span class=lnt id=hl-250-3><a class=lnlinks href=#hl-250-3>3</a>
</span><span class=lnt id=hl-250-4><a class=lnlinks href=#hl-250-4>4</a>
</span><span class=lnt id=hl-250-5><a class=lnlinks href=#hl-250-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor2</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=c1>// ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å†™å±éšœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>è€Œè¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</p></li><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-251-1><a class=lnlinks href=#hl-251-1>1</a>
</span><span class=lnt id=hl-251-2><a class=lnlinks href=#hl-251-2>2</a>
</span><span class=lnt id=hl-251-3><a class=lnlinks href=#hl-251-3>3</a>
</span><span class=lnt id=hl-251-4><a class=lnlinks href=#hl-251-4>4</a>
</span><span class=lnt id=hl-251-5><a class=lnlinks href=#hl-251-5>5</a>
</span><span class=lnt id=hl-251-6><a class=lnlinks href=#hl-251-6>6</a>
</span><span class=lnt id=hl-251-7><a class=lnlinks href=#hl-251-7>7</a>
</span><span class=lnt id=hl-251-8><a class=lnlinks href=#hl-251-8>8</a>
</span><span class=lnt id=hl-251-9><a class=lnlinks href=#hl-251-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor1</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¯»å±éšœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ready</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306125622336.png width=900 height=600 loading=lazy decoding=async alt=image-20220306125622336 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li></ul><h5 id=å¦‚ä½•ä¿è¯æœ‰åºæ€§><a href=#%e5%a6%82%e4%bd%95%e4%bf%9d%e8%af%81%e6%9c%89%e5%ba%8f%e6%80%a7 class=header-anchor>#</a>
å¦‚ä½•ä¿è¯æœ‰åºæ€§</h5><ul><li><p>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</p></li><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-252-1><a class=lnlinks href=#hl-252-1>1</a>
</span><span class=lnt id=hl-252-2><a class=lnlinks href=#hl-252-2>2</a>
</span><span class=lnt id=hl-252-3><a class=lnlinks href=#hl-252-3>3</a>
</span><span class=lnt id=hl-252-4><a class=lnlinks href=#hl-252-4>4</a>
</span><span class=lnt id=hl-252-5><a class=lnlinks href=#hl-252-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor2</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ready</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w> </span><span class=c1>// ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å†™å±éšœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</p></li><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-253-1><a class=lnlinks href=#hl-253-1>1</a>
</span><span class=lnt id=hl-253-2><a class=lnlinks href=#hl-253-2>2</a>
</span><span class=lnt id=hl-253-3><a class=lnlinks href=#hl-253-3>3</a>
</span><span class=lnt id=hl-253-4><a class=lnlinks href=#hl-253-4>4</a>
</span><span class=lnt id=hl-253-5><a class=lnlinks href=#hl-253-5>5</a>
</span><span class=lnt id=hl-253-6><a class=lnlinks href=#hl-253-6>6</a>
</span><span class=lnt id=hl-253-7><a class=lnlinks href=#hl-253-7>7</a>
</span><span class=lnt id=hl-253-8><a class=lnlinks href=#hl-253-8>8</a>
</span><span class=lnt id=hl-253-9><a class=lnlinks href=#hl-253-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actor1</span><span class=p>(</span><span class=n>I_Result</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¯»å±éšœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ready</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306130348150.png width=900 height=600 loading=lazy decoding=async alt=image-20220306130348150 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li></ul><p>è¿˜æ˜¯é‚£å¥è¯ï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™ï¼š</p><ul><li>å†™å±éšœä»…ä»…æ˜¯ä¿è¯ä¹‹åçš„è¯»èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœï¼Œä½†ä¸èƒ½ä¿è¯è¯»è·‘åˆ°å®ƒå‰é¢å»</li><li>è€Œæœ‰åºæ€§çš„ä¿è¯ä¹Ÿåªæ˜¯ä¿è¯äº†æœ¬çº¿ç¨‹å†…ç›¸å…³ä»£ç ä¸è¢«é‡æ’åº</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220306130731767.png width=900 height=600 loading=lazy decoding=async alt=image-20220306130731767 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=double-checked-locking-é—®é¢˜><a href=#double-checked-locking-%e9%97%ae%e9%a2%98 class=header-anchor>#</a>
double-checked locking é—®é¢˜</h5><p>ä»¥è‘—åçš„ double-checked locking å•ä¾‹æ¨¡å¼ä¸ºä¾‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-254-1><a class=lnlinks href=#hl-254-1> 1</a>
</span><span class=lnt id=hl-254-2><a class=lnlinks href=#hl-254-2> 2</a>
</span><span class=lnt id=hl-254-3><a class=lnlinks href=#hl-254-3> 3</a>
</span><span class=lnt id=hl-254-4><a class=lnlinks href=#hl-254-4> 4</a>
</span><span class=lnt id=hl-254-5><a class=lnlinks href=#hl-254-5> 5</a>
</span><span class=lnt id=hl-254-6><a class=lnlinks href=#hl-254-6> 6</a>
</span><span class=lnt id=hl-254-7><a class=lnlinks href=#hl-254-7> 7</a>
</span><span class=lnt id=hl-254-8><a class=lnlinks href=#hl-254-8> 8</a>
</span><span class=lnt id=hl-254-9><a class=lnlinks href=#hl-254-9> 9</a>
</span><span class=lnt id=hl-254-10><a class=lnlinks href=#hl-254-10>10</a>
</span><span class=lnt id=hl-254-11><a class=lnlinks href=#hl-254-11>11</a>
</span><span class=lnt id=hl-254-12><a class=lnlinks href=#hl-254-12>12</a>
</span><span class=lnt id=hl-254-13><a class=lnlinks href=#hl-254-13>13</a>
</span><span class=lnt id=hl-254-14><a class=lnlinks href=#hl-254-14>14</a>
</span><span class=lnt id=hl-254-15><a class=lnlinks href=#hl-254-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// t2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// é¦–æ¬¡è®¿é—®ä¼šåŒæ­¥ï¼Œè€Œä¹‹åçš„ä½¿ç”¨æ²¡æœ‰ synchronized</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>Singleton</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä»¥ä¸Šçš„å®ç°ç‰¹ç‚¹æ˜¯ï¼š</p><ul><li>æ‡’æƒ°å®ä¾‹åŒ–</li><li>é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”</li><li>æœ‰éšå«çš„ï¼Œä½†å¾ˆå…³é”®çš„ä¸€ç‚¹ï¼šç¬¬ä¸€ä¸ª if ä½¿ç”¨äº† INSTANCE å˜é‡ï¼Œæ˜¯åœ¨åŒæ­¥å—ä¹‹å¤–</li></ul><p>ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼ŒgetInstance æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-255-1><a class=lnlinks href=#hl-255-1> 1</a>
</span><span class=lnt id=hl-255-2><a class=lnlinks href=#hl-255-2> 2</a>
</span><span class=lnt id=hl-255-3><a class=lnlinks href=#hl-255-3> 3</a>
</span><span class=lnt id=hl-255-4><a class=lnlinks href=#hl-255-4> 4</a>
</span><span class=lnt id=hl-255-5><a class=lnlinks href=#hl-255-5> 5</a>
</span><span class=lnt id=hl-255-6><a class=lnlinks href=#hl-255-6> 6</a>
</span><span class=lnt id=hl-255-7><a class=lnlinks href=#hl-255-7> 7</a>
</span><span class=lnt id=hl-255-8><a class=lnlinks href=#hl-255-8> 8</a>
</span><span class=lnt id=hl-255-9><a class=lnlinks href=#hl-255-9> 9</a>
</span><span class=lnt id=hl-255-10><a class=lnlinks href=#hl-255-10>10</a>
</span><span class=lnt id=hl-255-11><a class=lnlinks href=#hl-255-11>11</a>
</span><span class=lnt id=hl-255-12><a class=lnlinks href=#hl-255-12>12</a>
</span><span class=lnt id=hl-255-13><a class=lnlinks href=#hl-255-13>13</a>
</span><span class=lnt id=hl-255-14><a class=lnlinks href=#hl-255-14>14</a>
</span><span class=lnt id=hl-255-15><a class=lnlinks href=#hl-255-15>15</a>
</span><span class=lnt id=hl-255-16><a class=lnlinks href=#hl-255-16>16</a>
</span><span class=lnt id=hl-255-17><a class=lnlinks href=#hl-255-17>17</a>
</span><span class=lnt id=hl-255-18><a class=lnlinks href=#hl-255-18>18</a>
</span><span class=lnt id=hl-255-19><a class=lnlinks href=#hl-255-19>19</a>
</span><span class=lnt id=hl-255-20><a class=lnlinks href=#hl-255-20>20</a>
</span><span class=lnt id=hl-255-21><a class=lnlinks href=#hl-255-21>21</a>
</span><span class=lnt id=hl-255-22><a class=lnlinks href=#hl-255-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>0: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>3: ifnonnull <span class=m>37</span>
</span></span><span class=line><span class=cl>6: ldc <span class=c1>#3 // class cn/itcast/n5/Singleton</span>
</span></span><span class=line><span class=cl>8: dup
</span></span><span class=line><span class=cl>9: astore_0
</span></span><span class=line><span class=cl>10: monitorenter
</span></span><span class=line><span class=cl>11: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>14: ifnonnull <span class=m>27</span>
</span></span><span class=line><span class=cl>17: new <span class=c1>#3 // class cn/itcast/n5/Singleton</span>
</span></span><span class=line><span class=cl>20: dup
</span></span><span class=line><span class=cl>21: invokespecial <span class=c1>#4 // Method &#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class=line><span class=cl>24: putstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>27: aload_0
</span></span><span class=line><span class=cl>28: monitorexit
</span></span><span class=line><span class=cl>29: goto <span class=m>37</span>
</span></span><span class=line><span class=cl>32: astore_1
</span></span><span class=line><span class=cl>33: aload_0
</span></span><span class=line><span class=cl>34: monitorexit
</span></span><span class=line><span class=cl>35: aload_1
</span></span><span class=line><span class=cl>36: athrow
</span></span><span class=line><span class=cl>37: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>40: areturn
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­</p><ul><li>17 è¡¨ç¤ºåˆ›å»ºå¯¹è±¡ï¼Œå°†å¯¹è±¡å¼•ç”¨å…¥æ ˆ // new Singleton</li><li>20 è¡¨ç¤ºå¤åˆ¶ä¸€ä»½å¯¹è±¡å¼•ç”¨ // å¼•ç”¨åœ°å€</li><li>21 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œè°ƒç”¨æ„é€ æ–¹æ³•</li><li>24 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œèµ‹å€¼ç»™ static INSTANCE</li></ul><p>ä¹Ÿè®¸ jvm ä¼šä¼˜åŒ–ä¸ºï¼šå…ˆæ‰§è¡Œ 24ï¼Œå†æ‰§è¡Œ 21ã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹ t1ï¼Œt2 æŒ‰å¦‚ä¸‹æ—¶é—´åºåˆ—æ‰§è¡Œï¼š</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220307202619811.png width=900 height=600 loading=lazy decoding=async alt=image-20220307202619811 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å…³é”®åœ¨äº 0: getstatic è¿™è¡Œä»£ç åœ¨ monitor æ§åˆ¶ä¹‹å¤–ï¼Œå®ƒå°±åƒä¹‹å‰ä¸¾ä¾‹ä¸­ä¸å®ˆè§„åˆ™çš„äººï¼Œå¯ä»¥è¶Šè¿‡ monitor è¯»å– INSTANCE å˜é‡çš„å€¼</p><p>è¿™æ—¶ t1 è¿˜æœªå®Œå…¨å°†æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­è¦æ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„æ˜¯å°†æ˜¯ä¸€ä¸ªæœªåˆ å§‹åŒ–å®Œæ¯•çš„å•ä¾‹</p><p>å¯¹ INSTANCE ä½¿ç”¨ volatile ä¿®é¥°å³å¯ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ï¼Œä½†è¦æ³¨æ„åœ¨ JDK 5 ä»¥ä¸Šçš„ç‰ˆæœ¬çš„ volatile æ‰ä¼šçœŸæ­£æœ‰æ•ˆ</p><h5 id=double-checked-locking-è§£å†³><a href=#double-checked-locking-%e8%a7%a3%e5%86%b3 class=header-anchor>#</a>
double-checked locking è§£å†³</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-256-1><a class=lnlinks href=#hl-256-1> 1</a>
</span><span class=lnt id=hl-256-2><a class=lnlinks href=#hl-256-2> 2</a>
</span><span class=lnt id=hl-256-3><a class=lnlinks href=#hl-256-3> 3</a>
</span><span class=lnt id=hl-256-4><a class=lnlinks href=#hl-256-4> 4</a>
</span><span class=lnt id=hl-256-5><a class=lnlinks href=#hl-256-5> 5</a>
</span><span class=lnt id=hl-256-6><a class=lnlinks href=#hl-256-6> 6</a>
</span><span class=lnt id=hl-256-7><a class=lnlinks href=#hl-256-7> 7</a>
</span><span class=lnt id=hl-256-8><a class=lnlinks href=#hl-256-8> 8</a>
</span><span class=lnt id=hl-256-9><a class=lnlinks href=#hl-256-9> 9</a>
</span><span class=lnt id=hl-256-10><a class=lnlinks href=#hl-256-10>10</a>
</span><span class=lnt id=hl-256-11><a class=lnlinks href=#hl-256-11>11</a>
</span><span class=lnt id=hl-256-12><a class=lnlinks href=#hl-256-12>12</a>
</span><span class=lnt id=hl-256-13><a class=lnlinks href=#hl-256-13>13</a>
</span><span class=lnt id=hl-256-14><a class=lnlinks href=#hl-256-14>14</a>
</span><span class=lnt id=hl-256-15><a class=lnlinks href=#hl-256-15>15</a>
</span><span class=lnt id=hl-256-16><a class=lnlinks href=#hl-256-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å®ä¾‹æ²¡åˆ›å»ºï¼Œæ‰ä¼šè¿›å…¥å†…éƒ¨çš„ synchronizedä»£ç å—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>Singleton</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// t2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ä¹Ÿè®¸æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»åˆ›å»ºå®ä¾‹ï¼Œæ‰€ä»¥å†åˆ¤æ–­ä¸€æ¬¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å­—èŠ‚ç ä¸Šçœ‹ä¸å‡ºæ¥ volatile æŒ‡ä»¤çš„æ•ˆæœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-257-1><a class=lnlinks href=#hl-257-1> 1</a>
</span><span class=lnt id=hl-257-2><a class=lnlinks href=#hl-257-2> 2</a>
</span><span class=lnt id=hl-257-3><a class=lnlinks href=#hl-257-3> 3</a>
</span><span class=lnt id=hl-257-4><a class=lnlinks href=#hl-257-4> 4</a>
</span><span class=lnt id=hl-257-5><a class=lnlinks href=#hl-257-5> 5</a>
</span><span class=lnt id=hl-257-6><a class=lnlinks href=#hl-257-6> 6</a>
</span><span class=lnt id=hl-257-7><a class=lnlinks href=#hl-257-7> 7</a>
</span><span class=lnt id=hl-257-8><a class=lnlinks href=#hl-257-8> 8</a>
</span><span class=lnt id=hl-257-9><a class=lnlinks href=#hl-257-9> 9</a>
</span><span class=lnt id=hl-257-10><a class=lnlinks href=#hl-257-10>10</a>
</span><span class=lnt id=hl-257-11><a class=lnlinks href=#hl-257-11>11</a>
</span><span class=lnt id=hl-257-12><a class=lnlinks href=#hl-257-12>12</a>
</span><span class=lnt id=hl-257-13><a class=lnlinks href=#hl-257-13>13</a>
</span><span class=lnt id=hl-257-14><a class=lnlinks href=#hl-257-14>14</a>
</span><span class=lnt id=hl-257-15><a class=lnlinks href=#hl-257-15>15</a>
</span><span class=lnt id=hl-257-16><a class=lnlinks href=#hl-257-16>16</a>
</span><span class=lnt id=hl-257-17><a class=lnlinks href=#hl-257-17>17</a>
</span><span class=lnt id=hl-257-18><a class=lnlinks href=#hl-257-18>18</a>
</span><span class=lnt id=hl-257-19><a class=lnlinks href=#hl-257-19>19</a>
</span><span class=lnt id=hl-257-20><a class=lnlinks href=#hl-257-20>20</a>
</span><span class=lnt id=hl-257-21><a class=lnlinks href=#hl-257-21>21</a>
</span><span class=lnt id=hl-257-22><a class=lnlinks href=#hl-257-22>22</a>
</span><span class=lnt id=hl-257-23><a class=lnlinks href=#hl-257-23>23</a>
</span><span class=lnt id=hl-257-24><a class=lnlinks href=#hl-257-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>// -------------------------------------&gt; åŠ å…¥å¯¹ INSTANCE å˜é‡çš„è¯»å±éšœ
</span></span><span class=line><span class=cl>0: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>3: ifnonnull <span class=m>37</span>
</span></span><span class=line><span class=cl>6: ldc <span class=c1>#3 // class cn/itcast/n5/Singleton</span>
</span></span><span class=line><span class=cl>8: dup
</span></span><span class=line><span class=cl>9: astore_0
</span></span><span class=line><span class=cl>10: monitorenter -----------------------&gt; ä¿è¯åŸå­æ€§ã€å¯è§æ€§
</span></span><span class=line><span class=cl>11: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>14: ifnonnull <span class=m>27</span>
</span></span><span class=line><span class=cl>17: new <span class=c1>#3 // class cn/itcast/n5/Singleton</span>
</span></span><span class=line><span class=cl>20: dup
</span></span><span class=line><span class=cl>21: invokespecial <span class=c1>#4 // Method &#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class=line><span class=cl>24: putstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>// -------------------------------------&gt; åŠ å…¥å¯¹ INSTANCE å˜é‡çš„å†™å±éšœ
</span></span><span class=line><span class=cl>27: aload_0
</span></span><span class=line><span class=cl>28: monitorexit ------------------------&gt; ä¿è¯åŸå­æ€§ã€å¯è§æ€§
</span></span><span class=line><span class=cl>29: goto <span class=m>37</span>
</span></span><span class=line><span class=cl>32: astore_1
</span></span><span class=line><span class=cl>33: aload_0
</span></span><span class=line><span class=cl>34: monitorexit
</span></span><span class=line><span class=cl>35: aload_1
</span></span><span class=line><span class=cl>36: athrow
</span></span><span class=line><span class=cl>37: getstatic <span class=c1>#2 // Field INSTANCE:Lcn/itcast/n5/Singleton;</span>
</span></span><span class=line><span class=cl>40: areturn
</span></span></code></pre></td></tr></table></div></div><p>å¦‚ä¸Šé¢çš„æ³¨é‡Šå†…å®¹æ‰€ç¤ºï¼Œè¯»å†™ volatile å˜é‡æ—¶ä¼šåŠ å…¥å†…å­˜å±éšœï¼ˆMemory Barrierï¼ˆMemory Fenceï¼‰ï¼‰ï¼Œä¿è¯ä¸‹é¢ ä¸¤ç‚¹ï¼š</p><ul><li>å¯è§æ€§<ul><li>å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ t1 å¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</li><li>è€Œè¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å t2 å¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</li></ul></li><li>æœ‰åºæ€§<ul><li>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</li><li>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</li></ul></li><li>æ›´åº•å±‚æ˜¯è¯»å†™å˜é‡æ—¶ä½¿ç”¨ lock æŒ‡ä»¤æ¥å¤šæ ¸ CPU ä¹‹é—´çš„å¯è§æ€§ä¸æœ‰åºæ€§</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220307204740517.png width=900 height=600 loading=lazy decoding=async alt=image-20220307204740517 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=happens-before><a href=#happens-before class=header-anchor>#</a>
happens-before</h4><p>happens-before è§„å®šäº†å¯¹å…±äº«å˜é‡çš„å†™æ“ä½œå¯¹å…¶å®ƒçº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼ŒæŠ› å¼€ä»¥ä¸‹ happens-before è§„åˆ™ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶å®ƒçº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§</p><ul><li><p>çº¿ç¨‹è§£é” m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§(synchronizedå…³é”®å­—çš„å¯è§æ€§ã€ç›‘è§†å™¨è§„åˆ™)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-258-1><a class=lnlinks href=#hl-258-1> 1</a>
</span><span class=lnt id=hl-258-2><a class=lnlinks href=#hl-258-2> 2</a>
</span><span class=lnt id=hl-258-3><a class=lnlinks href=#hl-258-3> 3</a>
</span><span class=lnt id=hl-258-4><a class=lnlinks href=#hl-258-4> 4</a>
</span><span class=lnt id=hl-258-5><a class=lnlinks href=#hl-258-5> 5</a>
</span><span class=lnt id=hl-258-6><a class=lnlinks href=#hl-258-6> 6</a>
</span><span class=lnt id=hl-258-7><a class=lnlinks href=#hl-258-7> 7</a>
</span><span class=lnt id=hl-258-8><a class=lnlinks href=#hl-258-8> 8</a>
</span><span class=lnt id=hl-258-9><a class=lnlinks href=#hl-258-9> 9</a>
</span><span class=lnt id=hl-258-10><a class=lnlinks href=#hl-258-10>10</a>
</span><span class=lnt id=hl-258-11><a class=lnlinks href=#hl-258-11>11</a>
</span><span class=lnt id=hl-258-12><a class=lnlinks href=#hl-258-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>çº¿ç¨‹å¯¹ volatile å˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§(volatileå…³é”®å­—çš„å¯è§æ€§ã€volatileè§„åˆ™)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-259-1><a class=lnlinks href=#hl-259-1>1</a>
</span><span class=lnt id=hl-259-2><a class=lnlinks href=#hl-259-2>2</a>
</span><span class=lnt id=hl-259-3><a class=lnlinks href=#hl-259-3>3</a>
</span><span class=lnt id=hl-259-4><a class=lnlinks href=#hl-259-4>4</a>
</span><span class=lnt id=hl-259-5><a class=lnlinks href=#hl-259-5>5</a>
</span><span class=lnt id=hl-259-6><a class=lnlinks href=#hl-259-6>6</a>
</span><span class=lnt id=hl-259-7><a class=lnlinks href=#hl-259-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>volatile</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>çº¿ç¨‹ start å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§(ç¨‹åºé¡ºåºè§„åˆ™+çº¿ç¨‹å¯åŠ¨è§„åˆ™)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-260-1><a class=lnlinks href=#hl-260-1>1</a>
</span><span class=lnt id=hl-260-2><a class=lnlinks href=#hl-260-2>2</a>
</span><span class=lnt id=hl-260-3><a class=lnlinks href=#hl-260-3>3</a>
</span><span class=lnt id=hl-260-4><a class=lnlinks href=#hl-260-4>4</a>
</span><span class=lnt id=hl-260-5><a class=lnlinks href=#hl-260-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§ï¼ˆæ¯”å¦‚å…¶å®ƒçº¿ç¨‹è°ƒç”¨ t1.isAlive() æˆ– t1.join()ç­‰å¾… å®ƒç»“æŸï¼‰(çº¿ç¨‹ç»ˆæ­¢è§„åˆ™)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-261-1><a class=lnlinks href=#hl-261-1>1</a>
</span><span class=lnt id=hl-261-2><a class=lnlinks href=#hl-261-2>2</a>
</span><span class=lnt id=hl-261-3><a class=lnlinks href=#hl-261-3>3</a>
</span><span class=lnt id=hl-261-4><a class=lnlinks href=#hl-261-4>4</a>
</span><span class=lnt id=hl-261-5><a class=lnlinks href=#hl-261-5>5</a>
</span><span class=lnt id=hl-261-6><a class=lnlinks href=#hl-261-6>6</a>
</span><span class=lnt id=hl-261-7><a class=lnlinks href=#hl-261-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>çº¿ç¨‹ t1 æ‰“æ–­ t2ï¼ˆinterruptï¼‰å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥ t2 è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§ï¼ˆé€šè¿‡ t2.interrupted æˆ– t2.isInterruptedï¼‰ï¼ˆçº¿ç¨‹ä¸­æ–­æœºåˆ¶ï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-262-1><a class=lnlinks href=#hl-262-1> 1</a>
</span><span class=lnt id=hl-262-2><a class=lnlinks href=#hl-262-2> 2</a>
</span><span class=lnt id=hl-262-3><a class=lnlinks href=#hl-262-3> 3</a>
</span><span class=lnt id=hl-262-4><a class=lnlinks href=#hl-262-4> 4</a>
</span><span class=lnt id=hl-262-5><a class=lnlinks href=#hl-262-5> 5</a>
</span><span class=lnt id=hl-262-6><a class=lnlinks href=#hl-262-6> 6</a>
</span><span class=lnt id=hl-262-7><a class=lnlinks href=#hl-262-7> 7</a>
</span><span class=lnt id=hl-262-8><a class=lnlinks href=#hl-262-8> 8</a>
</span><span class=lnt id=hl-262-9><a class=lnlinks href=#hl-262-9> 9</a>
</span><span class=lnt id=hl-262-10><a class=lnlinks href=#hl-262-10>10</a>
</span><span class=lnt id=hl-262-11><a class=lnlinks href=#hl-262-11>11</a>
</span><span class=lnt id=hl-262-12><a class=lnlinks href=#hl-262-12>12</a>
</span><span class=lnt id=hl-262-13><a class=lnlinks href=#hl-262-13>13</a>
</span><span class=lnt id=hl-262-14><a class=lnlinks href=#hl-262-14>14</a>
</span><span class=lnt id=hl-262-15><a class=lnlinks href=#hl-262-15>15</a>
</span><span class=lnt id=hl-262-16><a class=lnlinks href=#hl-262-16>16</a>
</span><span class=lnt id=hl-262-17><a class=lnlinks href=#hl-262-17>17</a>
</span><span class=lnt id=hl-262-18><a class=lnlinks href=#hl-262-18>18</a>
</span><span class=lnt id=hl-262-19><a class=lnlinks href=#hl-262-19>19</a>
</span><span class=lnt id=hl-262-20><a class=lnlinks href=#hl-262-20>20</a>
</span><span class=lnt id=hl-262-21><a class=lnlinks href=#hl-262-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>isInterrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=n>t2</span><span class=p>.</span><span class=na>isInterrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>yield</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>å¯¹å˜é‡é»˜è®¤å€¼ï¼ˆ0ï¼Œfalseï¼Œnullï¼‰çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</p></li><li><p>å…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœ <code>x hb-> y</code> å¹¶ä¸” <code>y hb-> z</code> é‚£ä¹ˆæœ‰ <code>x hb-> z</code> ï¼Œé…åˆ volatile çš„é˜²æŒ‡ä»¤é‡æ’ï¼Œæœ‰ä¸‹é¢çš„ä¾‹å­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-263-1><a class=lnlinks href=#hl-263-1> 1</a>
</span><span class=lnt id=hl-263-2><a class=lnlinks href=#hl-263-2> 2</a>
</span><span class=lnt id=hl-263-3><a class=lnlinks href=#hl-263-3> 3</a>
</span><span class=lnt id=hl-263-4><a class=lnlinks href=#hl-263-4> 4</a>
</span><span class=lnt id=hl-263-5><a class=lnlinks href=#hl-263-5> 5</a>
</span><span class=lnt id=hl-263-6><a class=lnlinks href=#hl-263-6> 6</a>
</span><span class=lnt id=hl-263-7><a class=lnlinks href=#hl-263-7> 7</a>
</span><span class=lnt id=hl-263-8><a class=lnlinks href=#hl-263-8> 8</a>
</span><span class=lnt id=hl-263-9><a class=lnlinks href=#hl-263-9> 9</a>
</span><span class=lnt id=hl-263-10><a class=lnlinks href=#hl-263-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>volatile</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// x=20 å¯¹ t2 å¯è§, åŒæ—¶ y=10 ä¹Ÿå¯¹ t2 å¯è§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>å˜é‡éƒ½æ˜¯æŒ‡æˆå‘˜å˜é‡æˆ–é™æ€æˆå‘˜å˜é‡</p><p>å‚è€ƒï¼š ç¬¬17é¡µ</p><p>åœ¨JMMä¸­æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå¯¹äºæˆ‘ä»¬äº†è§£JMMæœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œé‚£å°±æ˜¯happens-beforeè§„åˆ™ã€‚happens-beforeè§„åˆ™éå¸¸é‡è¦ï¼Œå®ƒæ˜¯åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ç«äº‰ã€çº¿ç¨‹æ˜¯å¦å®‰å…¨çš„ä¸»è¦ä¾æ®ã€‚JSR-133Sä½¿ç”¨happens-beforeæ¦‚å¿µé˜è¿°äº†ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚åœ¨JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œåˆ™å­˜åœ¨happens-beforeå…³ç³»ã€‚</p><p>é‚£ä»€ä¹ˆæ˜¯happens-beforeå‘¢ï¼Ÿåœ¨JSR-133ä¸­ï¼Œhappens-beforeå…³ç³»å®šä¹‰å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœä¸€ä¸ªæ“ä½œhappens-beforeå¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆæ„å‘³ç€ç¬¬ä¸€ä¸ªæ“ä½œçš„ç»“æœå¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºå°†æ’åœ¨ç¬¬äºŒä¸ªæ“ä½œçš„å‰é¢ã€‚</li><li>ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€Javaå¹³å°çš„å…·ä½“å®ç°å¿…é¡»æŒ‰ç…§happens-beforeå…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æœé‡æ’åºä¹‹åçš„ç»“æœï¼Œä¸æŒ‰ç…§happens-beforeå…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼ŒJMMå…è®¸è¿™ç§é‡æ’åºï¼‰</li></ol><p>happens-beforeè§„åˆ™å¦‚ä¸‹ï¼š</p><ol><li>ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚</li><li>ç›‘è§†å™¨è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚</li><li>volatileè§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ã€‚</li><li>ä¼ é€’æ€§ï¼šè‹¥æœA happens-before Bï¼ŒB happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚</li><li>çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThreadå¯¹è±¡çš„start()æ–¹æ³•ï¼Œhappens-beforeäºè¿™ä¸ªçº¿ç¨‹çš„ä»»æ„åç»­æ“ä½œã€‚</li><li>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼šçº¿ç¨‹ä¸­çš„ä»»æ„æ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹çš„ç»ˆæ­¢ç›‘æµ‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡Thread.join()æ–¹æ³•ç»“æŸã€Thread.isAlive()çš„è¿”å›å€¼ç­‰æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œã€‚</li><li>çº¿ç¨‹ä¸­æ–­æ“ä½œï¼šå¯¹çº¿ç¨‹interrupt()æ–¹æ³•çš„è°ƒç”¨ï¼Œhappens-beforeäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡Thread.interrupted()æ–¹æ³•æ£€æµ‹åˆ°çº¿ç¨‹æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚</li><li>å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼Œhappens-beforeäºè¿™ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•çš„å¼€å§‹ã€‚</li></ol><p>å‚è€ƒé“¾æ¥ï¼š<a class=link href=https://zhuanlan.zhihu.com/p/77157725 target=_blank rel=noopener>happens-beforeè§„åˆ™è§£æ - çŸ¥ä¹ (zhihu.com)
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></blockquote></li></ul><h4 id=ä¹ é¢˜><a href=#%e4%b9%a0%e9%a2%98 class=header-anchor>#</a>
ä¹ é¢˜</h4><h5 id=balking-æ¨¡å¼ä¹ é¢˜><a href=#balking-%e6%a8%a1%e5%bc%8f%e4%b9%a0%e9%a2%98 class=header-anchor>#</a>
balking æ¨¡å¼ä¹ é¢˜</h5><p>å¸Œæœ› doInit() æ–¹æ³•ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹é¢çš„å®ç°æ˜¯å¦æœ‰é—®é¢˜ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-264-1><a class=lnlinks href=#hl-264-1> 1</a>
</span><span class=lnt id=hl-264-2><a class=lnlinks href=#hl-264-2> 2</a>
</span><span class=lnt id=hl-264-3><a class=lnlinks href=#hl-264-3> 3</a>
</span><span class=lnt id=hl-264-4><a class=lnlinks href=#hl-264-4> 4</a>
</span><span class=lnt id=hl-264-5><a class=lnlinks href=#hl-264-5> 5</a>
</span><span class=lnt id=hl-264-6><a class=lnlinks href=#hl-264-6> 6</a>
</span><span class=lnt id=hl-264-7><a class=lnlinks href=#hl-264-7> 7</a>
</span><span class=lnt id=hl-264-8><a class=lnlinks href=#hl-264-8> 8</a>
</span><span class=lnt id=hl-264-9><a class=lnlinks href=#hl-264-9> 9</a>
</span><span class=lnt id=hl-264-10><a class=lnlinks href=#hl-264-10>10</a>
</span><span class=lnt id=hl-264-11><a class=lnlinks href=#hl-264-11>11</a>
</span><span class=lnt id=hl-264-12><a class=lnlinks href=#hl-264-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestVolatile</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>initialized</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>initialized</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>doInit</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>initialized</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doInit</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><h5 id=çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜><a href=#%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e5%8d%95%e4%be%8b%e4%b9%a0%e9%a2%98 class=header-anchor>#</a>
çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜</h5><p>å•ä¾‹æ¨¡å¼æœ‰å¾ˆå¤šå®ç°æ–¹æ³•ï¼Œé¥¿æ±‰ã€æ‡’æ±‰ã€é™æ€å†…éƒ¨ç±»ã€æšä¸¾ç±»ï¼Œè¯•åˆ†ææ¯ç§å®ç°ä¸‹è·å–å•ä¾‹å¯¹è±¡ï¼ˆå³è°ƒç”¨ getInstanceï¼‰æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Œå¹¶æ€è€ƒæ³¨é‡Šä¸­çš„é—®é¢˜</p><blockquote><p>é¥¿æ±‰å¼ï¼šç±»åŠ è½½å°±ä¼šå¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»º</p><p>æ‡’æ±‰å¼ï¼šç±»åŠ è½½ä¸ä¼šå¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»ºï¼Œè€Œæ˜¯é¦–æ¬¡ä½¿ç”¨è¯¥å¯¹è±¡æ—¶æ‰ä¼šåˆ›å»º</p></blockquote><p><strong>å®ç°1(é¥¿æ±‰å¼)ï¼š</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-265-1><a class=lnlinks href=#hl-265-1> 1</a>
</span><span class=lnt id=hl-265-2><a class=lnlinks href=#hl-265-2> 2</a>
</span><span class=lnt id=hl-265-3><a class=lnlinks href=#hl-265-3> 3</a>
</span><span class=lnt id=hl-265-4><a class=lnlinks href=#hl-265-4> 4</a>
</span><span class=lnt id=hl-265-5><a class=lnlinks href=#hl-265-5> 5</a>
</span><span class=lnt id=hl-265-6><a class=lnlinks href=#hl-265-6> 6</a>
</span><span class=lnt id=hl-265-7><a class=lnlinks href=#hl-265-7> 7</a>
</span><span class=lnt id=hl-265-8><a class=lnlinks href=#hl-265-8> 8</a>
</span><span class=lnt id=hl-265-9><a class=lnlinks href=#hl-265-9> 9</a>
</span><span class=lnt id=hl-265-10><a class=lnlinks href=#hl-265-10>10</a>
</span><span class=lnt id=hl-265-11><a class=lnlinks href=#hl-265-11>11</a>
</span><span class=lnt id=hl-265-12><a class=lnlinks href=#hl-265-12>12</a>
</span><span class=lnt id=hl-265-13><a class=lnlinks href=#hl-265-13>13</a>
</span><span class=lnt id=hl-265-14><a class=lnlinks href=#hl-265-14>14</a>
</span><span class=lnt id=hl-265-15><a class=lnlinks href=#hl-265-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// é—®é¢˜1ï¼šä¸ºä»€ä¹ˆåŠ  final(é˜²æ­¢è¢«å­ç±»ç»§æ‰¿ä»è€Œé‡å†™æ–¹æ³•æ”¹å†™å•ä¾‹)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// é—®é¢˜2ï¼šå¦‚æœå®ç°äº†åºåˆ—åŒ–æ¥å£, è¿˜è¦åšä»€ä¹ˆæ¥é˜²æ­¢ååºåˆ—åŒ–ç ´åå•ä¾‹(é‡å†™readResolveæ–¹æ³•)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é—®é¢˜3ï¼šä¸ºä»€ä¹ˆè®¾ç½®ä¸ºç§æœ‰? æ˜¯å¦èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹?(é˜²æ­¢å¤–éƒ¨è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºå¤šä¸ªå®ä¾‹ï¼›ä¸èƒ½)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é—®é¢˜4ï¼šè¿™æ ·åˆå§‹åŒ–æ˜¯å¦èƒ½ä¿è¯å•ä¾‹å¯¹è±¡åˆ›å»ºæ—¶çš„çº¿ç¨‹å®‰å…¨?(èƒ½ï¼Œçº¿ç¨‹å®‰å…¨æ€§ç”±ç±»åŠ è½½å™¨ä¿éšœ)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é—®é¢˜5ï¼šä¸ºä»€ä¹ˆæä¾›é™æ€æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥å°† INSTANCE è®¾ç½®ä¸º public, è¯´å‡ºä½ çŸ¥é“çš„ç†ç”±(å¯ä»¥ä¿è¯instanceçš„å®‰å…¨æ€§ï¼Œä¹Ÿèƒ½æ–¹ä¾¿å®ç°ä¸€äº›é™„åŠ é€»è¾‘)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>readResolve</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>å®ç°2(æšä¸¾ç±»)ï¼š</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-266-1><a class=lnlinks href=#hl-266-1>1</a>
</span><span class=lnt id=hl-266-2><a class=lnlinks href=#hl-266-2>2</a>
</span><span class=lnt id=hl-266-3><a class=lnlinks href=#hl-266-3>3</a>
</span><span class=lnt id=hl-266-4><a class=lnlinks href=#hl-266-4>4</a>
</span><span class=lnt id=hl-266-5><a class=lnlinks href=#hl-266-5>5</a>
</span><span class=lnt id=hl-266-6><a class=lnlinks href=#hl-266-6>6</a>
</span><span class=lnt id=hl-266-7><a class=lnlinks href=#hl-266-7>7</a>
</span><span class=lnt id=hl-266-8><a class=lnlinks href=#hl-266-8>8</a>
</span><span class=lnt id=hl-266-9><a class=lnlinks href=#hl-266-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// é—®é¢˜1ï¼šæšä¸¾å•ä¾‹æ˜¯å¦‚ä½•é™åˆ¶å®ä¾‹ä¸ªæ•°çš„ (æšä¸¾ç±»ä¼šæŒ‰ç…§å£°æ˜çš„ä¸ªæ•°åœ¨ç±»åŠ è½½æ—¶å®ä¾‹åŒ–å¯¹è±¡)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// é—®é¢˜2ï¼šæšä¸¾å•ä¾‹åœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜(æ²¡æœ‰ï¼Œç”±ç±»åŠ è½½å™¨ä¿éšœå®‰å…¨æ€§)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// é—®é¢˜3ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«åå°„ç ´åå•ä¾‹(ä¸èƒ½)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// é—®é¢˜4ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«ååºåˆ—åŒ–ç ´åå•ä¾‹(ä¸èƒ½)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// é—®é¢˜5ï¼šæšä¸¾å•ä¾‹å±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±‰å¼(é¥¿æ±‰)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// é—®é¢˜6ï¼šæšä¸¾å•ä¾‹å¦‚æœå¸Œæœ›åŠ å…¥ä¸€äº›å•ä¾‹åˆ›å»ºæ—¶çš„åˆå§‹åŒ–é€»è¾‘è¯¥å¦‚ä½•åš(å†™æ„é€ æ–¹æ³•)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>enum</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>å®ç°3(synchronizedæ–¹æ³•)ï¼š</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-267-1><a class=lnlinks href=#hl-267-1> 1</a>
</span><span class=lnt id=hl-267-2><a class=lnlinks href=#hl-267-2> 2</a>
</span><span class=lnt id=hl-267-3><a class=lnlinks href=#hl-267-3> 3</a>
</span><span class=lnt id=hl-267-4><a class=lnlinks href=#hl-267-4> 4</a>
</span><span class=lnt id=hl-267-5><a class=lnlinks href=#hl-267-5> 5</a>
</span><span class=lnt id=hl-267-6><a class=lnlinks href=#hl-267-6> 6</a>
</span><span class=lnt id=hl-267-7><a class=lnlinks href=#hl-267-7> 7</a>
</span><span class=lnt id=hl-267-8><a class=lnlinks href=#hl-267-8> 8</a>
</span><span class=lnt id=hl-267-9><a class=lnlinks href=#hl-267-9> 9</a>
</span><span class=lnt id=hl-267-10><a class=lnlinks href=#hl-267-10>10</a>
</span><span class=lnt id=hl-267-11><a class=lnlinks href=#hl-267-11>11</a>
</span><span class=lnt id=hl-267-12><a class=lnlinks href=#hl-267-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ†æè¿™é‡Œçš„çº¿ç¨‹å®‰å…¨, å¹¶è¯´æ˜æœ‰ä»€ä¹ˆç¼ºç‚¹(æ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ­¥ä»£ç å—ç²’åº¦å¤ªå¤§ï¼Œæ€§èƒ½å·®)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>å®ç°4ï¼šDCL+volatile</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-268-1><a class=lnlinks href=#hl-268-1> 1</a>
</span><span class=lnt id=hl-268-2><a class=lnlinks href=#hl-268-2> 2</a>
</span><span class=lnt id=hl-268-3><a class=lnlinks href=#hl-268-3> 3</a>
</span><span class=lnt id=hl-268-4><a class=lnlinks href=#hl-268-4> 4</a>
</span><span class=lnt id=hl-268-5><a class=lnlinks href=#hl-268-5> 5</a>
</span><span class=lnt id=hl-268-6><a class=lnlinks href=#hl-268-6> 6</a>
</span><span class=lnt id=hl-268-7><a class=lnlinks href=#hl-268-7> 7</a>
</span><span class=lnt id=hl-268-8><a class=lnlinks href=#hl-268-8> 8</a>
</span><span class=lnt id=hl-268-9><a class=lnlinks href=#hl-268-9> 9</a>
</span><span class=lnt id=hl-268-10><a class=lnlinks href=#hl-268-10>10</a>
</span><span class=lnt id=hl-268-11><a class=lnlinks href=#hl-268-11>11</a>
</span><span class=lnt id=hl-268-12><a class=lnlinks href=#hl-268-12>12</a>
</span><span class=lnt id=hl-268-13><a class=lnlinks href=#hl-268-13>13</a>
</span><span class=lnt id=hl-268-14><a class=lnlinks href=#hl-268-14>14</a>
</span><span class=lnt id=hl-268-15><a class=lnlinks href=#hl-268-15>15</a>
</span><span class=lnt id=hl-268-16><a class=lnlinks href=#hl-268-16>16</a>
</span><span class=lnt id=hl-268-17><a class=lnlinks href=#hl-268-17>17</a>
</span><span class=lnt id=hl-268-18><a class=lnlinks href=#hl-268-18>18</a>
</span><span class=lnt id=hl-268-19><a class=lnlinks href=#hl-268-19>19</a>
</span><span class=lnt id=hl-268-20><a class=lnlinks href=#hl-268-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é—®é¢˜1ï¼šè§£é‡Šä¸ºä»€ä¹ˆè¦åŠ  volatile ?(é˜²æ­¢putstaticå’Œinvokespecialé‡æ’å¯¼è‡´çš„å¼‚å¸¸)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é—®é¢˜2ï¼šå¯¹æ¯”å®ç°3, è¯´å‡ºè¿™æ ·åšçš„æ„ä¹‰ (ç¼©å°äº†é”çš„ç²’åº¦ï¼Œæé«˜äº†æ€§èƒ½)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>Singleton</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// é—®é¢˜3ï¼šä¸ºä»€ä¹ˆè¿˜è¦åœ¨è¿™é‡ŒåŠ ä¸ºç©ºåˆ¤æ–­, ä¹‹å‰ä¸æ˜¯åˆ¤æ–­è¿‡äº†å—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>INSTANCE</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// t2 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>å®ç°5(å†…éƒ¨ç±»åˆå§‹åŒ–)ï¼š</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-269-1><a class=lnlinks href=#hl-269-1> 1</a>
</span><span class=lnt id=hl-269-2><a class=lnlinks href=#hl-269-2> 2</a>
</span><span class=lnt id=hl-269-3><a class=lnlinks href=#hl-269-3> 3</a>
</span><span class=lnt id=hl-269-4><a class=lnlinks href=#hl-269-4> 4</a>
</span><span class=lnt id=hl-269-5><a class=lnlinks href=#hl-269-5> 5</a>
</span><span class=lnt id=hl-269-6><a class=lnlinks href=#hl-269-6> 6</a>
</span><span class=lnt id=hl-269-7><a class=lnlinks href=#hl-269-7> 7</a>
</span><span class=lnt id=hl-269-8><a class=lnlinks href=#hl-269-8> 8</a>
</span><span class=lnt id=hl-269-9><a class=lnlinks href=#hl-269-9> 9</a>
</span><span class=lnt id=hl-269-10><a class=lnlinks href=#hl-269-10>10</a>
</span><span class=lnt id=hl-269-11><a class=lnlinks href=#hl-269-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Singleton</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Singleton</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é—®é¢˜1ï¼šå±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±‰å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>LazyHolder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é—®é¢˜2ï¼šåœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Singleton</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>LazyHolder</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=æœ¬ç« å°ç»“-2><a href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-2 class=header-anchor>#</a>
æœ¬ç« å°ç»“</h2><p>æœ¬ç« é‡ç‚¹è®²è§£äº† JMM ä¸­çš„</p><ul><li>å¯è§æ€§ - ç”± JVM ç¼“å­˜ä¼˜åŒ–å¼•èµ·</li><li>æœ‰åºæ€§ - ç”± JVM æŒ‡ä»¤é‡æ’åºä¼˜åŒ–å¼•èµ·</li><li>happens-before è§„åˆ™</li><li><font color=blue>åŸç†æ–¹é¢</font><ul><li>CPU æŒ‡ä»¤å¹¶è¡Œ</li><li>volatile</li></ul></li><li><font color=orange>æ¨¡å¼æ–¹é¢</font><ul><li>ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼çš„ volatile æ”¹è¿›</li><li>åŒæ­¥æ¨¡å¼ä¹‹ balking</li></ul></li></ul><h1 id=6å…±äº«æ¨¡å‹ä¹‹æ— é”><a href=#6%e5%85%b1%e4%ba%ab%e6%a8%a1%e5%9e%8b%e4%b9%8b%e6%97%a0%e9%94%81 class=header-anchor>#</a>
6.å…±äº«æ¨¡å‹ä¹‹æ— é”</h1><h2 id=61-é—®é¢˜æå‡º-åº”ç”¨ä¹‹äº’æ–¥><a href=#61-%e9%97%ae%e9%a2%98%e6%8f%90%e5%87%ba-%e5%ba%94%e7%94%a8%e4%b9%8b%e4%ba%92%e6%96%a5 class=header-anchor>#</a>
6.1 é—®é¢˜æå‡º (åº”ç”¨ä¹‹äº’æ–¥)</h2><p>æœ‰å¦‚ä¸‹éœ€æ±‚ï¼Œä¿è¯ account.withdraw å–æ¬¾æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-270-1><a class=lnlinks href=#hl-270-1> 1</a>
</span><span class=lnt id=hl-270-2><a class=lnlinks href=#hl-270-2> 2</a>
</span><span class=lnt id=hl-270-3><a class=lnlinks href=#hl-270-3> 3</a>
</span><span class=lnt id=hl-270-4><a class=lnlinks href=#hl-270-4> 4</a>
</span><span class=lnt id=hl-270-5><a class=lnlinks href=#hl-270-5> 5</a>
</span><span class=lnt id=hl-270-6><a class=lnlinks href=#hl-270-6> 6</a>
</span><span class=lnt id=hl-270-7><a class=lnlinks href=#hl-270-7> 7</a>
</span><span class=lnt id=hl-270-8><a class=lnlinks href=#hl-270-8> 8</a>
</span><span class=lnt id=hl-270-9><a class=lnlinks href=#hl-270-9> 9</a>
</span><span class=lnt id=hl-270-10><a class=lnlinks href=#hl-270-10>10</a>
</span><span class=lnt id=hl-270-11><a class=lnlinks href=#hl-270-11>11</a>
</span><span class=lnt id=hl-270-12><a class=lnlinks href=#hl-270-12>12</a>
</span><span class=lnt id=hl-270-13><a class=lnlinks href=#hl-270-13>13</a>
</span><span class=lnt id=hl-270-14><a class=lnlinks href=#hl-270-14>14</a>
</span><span class=lnt id=hl-270-15><a class=lnlinks href=#hl-270-15>15</a>
</span><span class=lnt id=hl-270-16><a class=lnlinks href=#hl-270-16>16</a>
</span><span class=lnt id=hl-270-17><a class=lnlinks href=#hl-270-17>17</a>
</span><span class=lnt id=hl-270-18><a class=lnlinks href=#hl-270-18>18</a>
</span><span class=lnt id=hl-270-19><a class=lnlinks href=#hl-270-19>19</a>
</span><span class=lnt id=hl-270-20><a class=lnlinks href=#hl-270-20>20</a>
</span><span class=lnt id=hl-270-21><a class=lnlinks href=#hl-270-21>21</a>
</span><span class=lnt id=hl-270-22><a class=lnlinks href=#hl-270-22>22</a>
</span><span class=lnt id=hl-270-23><a class=lnlinks href=#hl-270-23>23</a>
</span><span class=lnt id=hl-270-24><a class=lnlinks href=#hl-270-24>24</a>
</span><span class=lnt id=hl-270-25><a class=lnlinks href=#hl-270-25>25</a>
</span><span class=lnt id=hl-270-26><a class=lnlinks href=#hl-270-26>26</a>
</span><span class=lnt id=hl-270-27><a class=lnlinks href=#hl-270-27>27</a>
</span><span class=lnt id=hl-270-28><a class=lnlinks href=#hl-270-28>28</a>
</span><span class=lnt id=hl-270-29><a class=lnlinks href=#hl-270-29>29</a>
</span><span class=lnt id=hl-270-30><a class=lnlinks href=#hl-270-30>30</a>
</span><span class=lnt id=hl-270-31><a class=lnlinks href=#hl-270-31>31</a>
</span><span class=lnt id=hl-270-32><a class=lnlinks href=#hl-270-32>32</a>
</span><span class=lnt id=hl-270-33><a class=lnlinks href=#hl-270-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>cn.itcast</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.ArrayList</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>interface</span> <span class=nc>Account</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–ä½™é¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Integer</span><span class=w> </span><span class=nf>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å–æ¬¾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ
</span></span></span><span class=line><span class=cl><span class=cm> * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo</span><span class=p>(</span><span class=n>Account</span><span class=w> </span><span class=n>account</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ts</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>account</span><span class=p>.</span><span class=na>withdraw</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>Thread</span><span class=p>::</span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>()</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=o>+</span><span class=w> </span><span class=s>&#34; cost: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=o>-</span><span class=n>start</span><span class=p>)</span><span class=o>/</span><span class=n>1000_000</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; ms&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åŸæœ‰å®ç°å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-271-1><a class=lnlinks href=#hl-271-1> 1</a>
</span><span class=lnt id=hl-271-2><a class=lnlinks href=#hl-271-2> 2</a>
</span><span class=lnt id=hl-271-3><a class=lnlinks href=#hl-271-3> 3</a>
</span><span class=lnt id=hl-271-4><a class=lnlinks href=#hl-271-4> 4</a>
</span><span class=lnt id=hl-271-5><a class=lnlinks href=#hl-271-5> 5</a>
</span><span class=lnt id=hl-271-6><a class=lnlinks href=#hl-271-6> 6</a>
</span><span class=lnt id=hl-271-7><a class=lnlinks href=#hl-271-7> 7</a>
</span><span class=lnt id=hl-271-8><a class=lnlinks href=#hl-271-8> 8</a>
</span><span class=lnt id=hl-271-9><a class=lnlinks href=#hl-271-9> 9</a>
</span><span class=lnt id=hl-271-10><a class=lnlinks href=#hl-271-10>10</a>
</span><span class=lnt id=hl-271-11><a class=lnlinks href=#hl-271-11>11</a>
</span><span class=lnt id=hl-271-12><a class=lnlinks href=#hl-271-12>12</a>
</span><span class=lnt id=hl-271-13><a class=lnlinks href=#hl-271-13>13</a>
</span><span class=lnt id=hl-271-14><a class=lnlinks href=#hl-271-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AccountUnsafe</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Account</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AccountUnsafe</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>balance</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œæµ‹è¯•ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-272-1><a class=lnlinks href=#hl-272-1>1</a>
</span><span class=lnt id=hl-272-2><a class=lnlinks href=#hl-272-2>2</a>
</span><span class=lnt id=hl-272-3><a class=lnlinks href=#hl-272-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Account</span><span class=p>.</span><span class=na>demo</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AccountUnsafe</span><span class=p>(</span><span class=n>10000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æŸæ¬¡çš„æ‰§è¡Œç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-273-1><a class=lnlinks href=#hl-273-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>330</span> cost: <span class=m>306</span> ms
</span></span></code></pre></td></tr></table></div></div><h5 id=ä¸ºä»€ä¹ˆä¸å®‰å…¨><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e5%ae%89%e5%85%a8 class=header-anchor>#</a>
<strong>ä¸ºä»€ä¹ˆä¸å®‰å…¨</strong></h5><p><code>withdraw</code> æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-274-1><a class=lnlinks href=#hl-274-1>1</a>
</span><span class=lnt id=hl-274-2><a class=lnlinks href=#hl-274-2>2</a>
</span><span class=lnt id=hl-274-3><a class=lnlinks href=#hl-274-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>balance</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯¹åº”çš„å­—èŠ‚ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-275-1><a class=lnlinks href=#hl-275-1>1</a>
</span><span class=lnt id=hl-275-2><a class=lnlinks href=#hl-275-2>2</a>
</span><span class=lnt id=hl-275-3><a class=lnlinks href=#hl-275-3>3</a>
</span><span class=lnt id=hl-275-4><a class=lnlinks href=#hl-275-4>4</a>
</span><span class=lnt id=hl-275-5><a class=lnlinks href=#hl-275-5>5</a>
</span><span class=lnt id=hl-275-6><a class=lnlinks href=#hl-275-6>6</a>
</span><span class=lnt id=hl-275-7><a class=lnlinks href=#hl-275-7>7</a>
</span><span class=lnt id=hl-275-8><a class=lnlinks href=#hl-275-8>8</a>
</span><span class=lnt id=hl-275-9><a class=lnlinks href=#hl-275-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=c1>// &lt;- this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>GETFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>;</span><span class=w> </span><span class=c1>// &lt;- this.balance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=p>()</span><span class=n>I</span><span class=w> </span><span class=c1>// æ‹†ç®±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=c1>// &lt;- amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=p>()</span><span class=n>I</span><span class=w> </span><span class=c1>// æ‹†ç®±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ISUB</span><span class=w> </span><span class=c1>// å‡æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKESTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>valueOf</span><span class=w> </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>;</span><span class=w> </span><span class=c1>// ç»“æœè£…ç®±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PUTFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>;</span><span class=w> </span><span class=c1>// -&gt; this.balance</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¤šçº¿ç¨‹æ‰§è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-276-1><a class=lnlinks href=#hl-276-1> 1</a>
</span><span class=lnt id=hl-276-2><a class=lnlinks href=#hl-276-2> 2</a>
</span><span class=lnt id=hl-276-3><a class=lnlinks href=#hl-276-3> 3</a>
</span><span class=lnt id=hl-276-4><a class=lnlinks href=#hl-276-4> 4</a>
</span><span class=lnt id=hl-276-5><a class=lnlinks href=#hl-276-5> 5</a>
</span><span class=lnt id=hl-276-6><a class=lnlinks href=#hl-276-6> 6</a>
</span><span class=lnt id=hl-276-7><a class=lnlinks href=#hl-276-7> 7</a>
</span><span class=lnt id=hl-276-8><a class=lnlinks href=#hl-276-8> 8</a>
</span><span class=lnt id=hl-276-9><a class=lnlinks href=#hl-276-9> 9</a>
</span><span class=lnt id=hl-276-10><a class=lnlinks href=#hl-276-10>10</a>
</span><span class=lnt id=hl-276-11><a class=lnlinks href=#hl-276-11>11</a>
</span><span class=lnt id=hl-276-12><a class=lnlinks href=#hl-276-12>12</a>
</span><span class=lnt id=hl-276-13><a class=lnlinks href=#hl-276-13>13</a>
</span><span class=lnt id=hl-276-14><a class=lnlinks href=#hl-276-14>14</a>
</span><span class=lnt id=hl-276-15><a class=lnlinks href=#hl-276-15>15</a>
</span><span class=lnt id=hl-276-16><a class=lnlinks href=#hl-276-16>16</a>
</span><span class=lnt id=hl-276-17><a class=lnlinks href=#hl-276-17>17</a>
</span><span class=lnt id=hl-276-18><a class=lnlinks href=#hl-276-18>18</a>
</span><span class=lnt id=hl-276-19><a class=lnlinks href=#hl-276-19>19</a>
</span><span class=lnt id=hl-276-20><a class=lnlinks href=#hl-276-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=c1>// thread-0 &lt;- this </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>GETFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=c1>// thread-0 &lt;- this.balance </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=c1>// thread-0 æ‹†ç®±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=c1>// thread-0 &lt;- amount </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=c1>// thread-0 æ‹†ç®±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ISUB</span><span class=w> </span><span class=c1>// thread-0 å‡æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKESTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>valueOf</span><span class=w> </span><span class=c1>// thread-0 ç»“æœè£…ç®±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PUTFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=c1>// thread-0 -&gt; this.balance </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=c1>// thread-1 &lt;- this </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>0</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>GETFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=c1>// thread-1 &lt;- this.balance </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=c1>// thread-1 æ‹†ç®±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ALOAD</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=c1>// thread-1 &lt;- amount </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>intValue</span><span class=w> </span><span class=c1>// thread-1 æ‹†ç®±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ISUB</span><span class=w> </span><span class=c1>// thread-1 å‡æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>INVOKESTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Integer</span><span class=p>.</span><span class=na>valueOf</span><span class=w> </span><span class=c1>// thread-1 ç»“æœè£…ç®±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PUTFIELD</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>AccountUnsafe</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=c1>// thread-1 -&gt; this.balance</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åŸå› ï¼šIntegerè™½ç„¶æ˜¯ä¸å¯å˜ç±»ï¼Œå…¶æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯ä»¥ä¸Šæ“ä½œæ¶‰åŠåˆ°äº†å¤šä¸ªæ–¹æ³•çš„ç»„åˆï¼Œç­‰ä»·äºä»¥ä¸‹ä»£ç ï¼š</p><p>balance = new Integer(Integer.valueOf(balance) - amount);</p><p>å‰ä¸€ä¸ªæ–¹æ³•(valueOf)çš„ç»“æœå†³å®šåä¸€ä¸ªæ–¹æ³•(æ„é€ æ–¹æ³•)ï¼Œè¿™ç§ç»„åˆåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çº¿ç¨‹ä¸å®‰å…¨ã€‚</p><h5 id=è§£å†³æ€è·¯-é”æ‚²è§‚äº’æ–¥><a href=#%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-%e9%94%81%e6%82%b2%e8%a7%82%e4%ba%92%e6%96%a5 class=header-anchor>#</a>
<strong>è§£å†³æ€è·¯-é”</strong>ï¼ˆæ‚²è§‚äº’æ–¥ï¼‰</h5><p>é¦–å…ˆæƒ³åˆ°çš„æ˜¯ç»™ Account å¯¹è±¡åŠ é”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-277-1><a class=lnlinks href=#hl-277-1> 1</a>
</span><span class=lnt id=hl-277-2><a class=lnlinks href=#hl-277-2> 2</a>
</span><span class=lnt id=hl-277-3><a class=lnlinks href=#hl-277-3> 3</a>
</span><span class=lnt id=hl-277-4><a class=lnlinks href=#hl-277-4> 4</a>
</span><span class=lnt id=hl-277-5><a class=lnlinks href=#hl-277-5> 5</a>
</span><span class=lnt id=hl-277-6><a class=lnlinks href=#hl-277-6> 6</a>
</span><span class=lnt id=hl-277-7><a class=lnlinks href=#hl-277-7> 7</a>
</span><span class=lnt id=hl-277-8><a class=lnlinks href=#hl-277-8> 8</a>
</span><span class=lnt id=hl-277-9><a class=lnlinks href=#hl-277-9> 9</a>
</span><span class=lnt id=hl-277-10><a class=lnlinks href=#hl-277-10>10</a>
</span><span class=lnt id=hl-277-11><a class=lnlinks href=#hl-277-11>11</a>
</span><span class=lnt id=hl-277-12><a class=lnlinks href=#hl-277-12>12</a>
</span><span class=lnt id=hl-277-13><a class=lnlinks href=#hl-277-13>13</a>
</span><span class=lnt id=hl-277-14><a class=lnlinks href=#hl-277-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AccountUnsafe</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Account</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AccountUnsafe</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>balance</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœä¸º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-278-1><a class=lnlinks href=#hl-278-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>0</span> cost: <span class=m>399</span> ms 
</span></span></code></pre></td></tr></table></div></div><h5 id=è§£å†³æ€è·¯-æ— é”ä¹è§‚é‡è¯•><a href=#%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-%e6%97%a0%e9%94%81%e4%b9%90%e8%a7%82%e9%87%8d%e8%af%95 class=header-anchor>#</a>
<strong>è§£å†³æ€è·¯-æ— é”</strong>ï¼ˆä¹è§‚é‡è¯•ï¼‰</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-279-1><a class=lnlinks href=#hl-279-1> 1</a>
</span><span class=lnt id=hl-279-2><a class=lnlinks href=#hl-279-2> 2</a>
</span><span class=lnt id=hl-279-3><a class=lnlinks href=#hl-279-3> 3</a>
</span><span class=lnt id=hl-279-4><a class=lnlinks href=#hl-279-4> 4</a>
</span><span class=lnt id=hl-279-5><a class=lnlinks href=#hl-279-5> 5</a>
</span><span class=lnt id=hl-279-6><a class=lnlinks href=#hl-279-6> 6</a>
</span><span class=lnt id=hl-279-7><a class=lnlinks href=#hl-279-7> 7</a>
</span><span class=lnt id=hl-279-8><a class=lnlinks href=#hl-279-8> 8</a>
</span><span class=lnt id=hl-279-9><a class=lnlinks href=#hl-279-9> 9</a>
</span><span class=lnt id=hl-279-10><a class=lnlinks href=#hl-279-10>10</a>
</span><span class=lnt id=hl-279-11><a class=lnlinks href=#hl-279-11>11</a>
</span><span class=lnt id=hl-279-12><a class=lnlinks href=#hl-279-12>12</a>
</span><span class=lnt id=hl-279-13><a class=lnlinks href=#hl-279-13>13</a>
</span><span class=lnt id=hl-279-14><a class=lnlinks href=#hl-279-14>14</a>
</span><span class=lnt id=hl-279-15><a class=lnlinks href=#hl-279-15>15</a>
</span><span class=lnt id=hl-279-16><a class=lnlinks href=#hl-279-16>16</a>
</span><span class=lnt id=hl-279-17><a class=lnlinks href=#hl-279-17>17</a>
</span><span class=lnt id=hl-279-18><a class=lnlinks href=#hl-279-18>18</a>
</span><span class=lnt id=hl-279-19><a class=lnlinks href=#hl-279-19>19</a>
</span><span class=lnt id=hl-279-20><a class=lnlinks href=#hl-279-20>20</a>
</span><span class=lnt id=hl-279-21><a class=lnlinks href=#hl-279-21>21</a>
</span><span class=lnt id=hl-279-22><a class=lnlinks href=#hl-279-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AccountSafe</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Account</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AccountSafe</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>balance</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¯ä»¥ç®€åŒ–ä¸ºä¸‹é¢çš„æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// balance.addAndGet(-1 * amount);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œæµ‹è¯•ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-280-1><a class=lnlinks href=#hl-280-1>1</a>
</span><span class=lnt id=hl-280-2><a class=lnlinks href=#hl-280-2>2</a>
</span><span class=lnt id=hl-280-3><a class=lnlinks href=#hl-280-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Account</span><span class=p>.</span><span class=na>demo</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AccountSafe</span><span class=p>(</span><span class=n>10000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æŸæ¬¡çš„æ‰§è¡Œç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-281-1><a class=lnlinks href=#hl-281-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>0</span> cost: <span class=m>302</span> ms
</span></span></code></pre></td></tr></table></div></div><h2 id=62-cas-ä¸-volatile><a href=#62-cas-%e4%b8%8e-volatile class=header-anchor>#</a>
6.2 CAS ä¸ volatile</h2><p>å‰é¢çœ‹åˆ°çš„ AtomicInteger çš„è§£å†³æ–¹æ³•ï¼Œå†…éƒ¨å¹¶æ²¡æœ‰ç”¨é”æ¥ä¿æŠ¤å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-282-1><a class=lnlinks href=#hl-282-1> 1</a>
</span><span class=lnt id=hl-282-2><a class=lnlinks href=#hl-282-2> 2</a>
</span><span class=lnt id=hl-282-3><a class=lnlinks href=#hl-282-3> 3</a>
</span><span class=lnt id=hl-282-4><a class=lnlinks href=#hl-282-4> 4</a>
</span><span class=lnt id=hl-282-5><a class=lnlinks href=#hl-282-5> 5</a>
</span><span class=lnt id=hl-282-6><a class=lnlinks href=#hl-282-6> 6</a>
</span><span class=lnt id=hl-282-7><a class=lnlinks href=#hl-282-7> 7</a>
</span><span class=lnt id=hl-282-8><a class=lnlinks href=#hl-282-8> 8</a>
</span><span class=lnt id=hl-282-9><a class=lnlinks href=#hl-282-9> 9</a>
</span><span class=lnt id=hl-282-10><a class=lnlinks href=#hl-282-10>10</a>
</span><span class=lnt id=hl-282-11><a class=lnlinks href=#hl-282-11>11</a>
</span><span class=lnt id=hl-282-12><a class=lnlinks href=#hl-282-12>12</a>
</span><span class=lnt id=hl-282-13><a class=lnlinks href=#hl-282-13>13</a>
</span><span class=lnt id=hl-282-14><a class=lnlinks href=#hl-282-14>14</a>
</span><span class=lnt id=hl-282-15><a class=lnlinks href=#hl-282-15>15</a>
</span><span class=lnt id=hl-282-16><a class=lnlinks href=#hl-282-16>16</a>
</span><span class=lnt id=hl-282-17><a class=lnlinks href=#hl-282-17>17</a>
</span><span class=lnt id=hl-282-18><a class=lnlinks href=#hl-282-18>18</a>
</span><span class=lnt id=hl-282-19><a class=lnlinks href=#hl-282-19>19</a>
</span><span class=lnt id=hl-282-20><a class=lnlinks href=#hl-282-20>20</a>
</span><span class=lnt id=hl-282-21><a class=lnlinks href=#hl-282-21>21</a>
</span><span class=lnt id=hl-282-22><a class=lnlinks href=#hl-282-22>22</a>
</span><span class=lnt id=hl-282-23><a class=lnlinks href=#hl-282-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// éœ€è¦ä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ¯”å¦‚æ‹¿åˆ°äº†æ—§å€¼ 1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// åœ¨è¿™ä¸ªåŸºç¡€ä¸Š 1000-10 = 990</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>             compareAndSet æ­£æ˜¯åšè¿™ä¸ªæ£€æŸ¥ï¼Œåœ¨ set å‰ï¼Œå…ˆæ¯”è¾ƒ prev ä¸å½“å‰å€¼
</span></span></span><span class=line><span class=cl><span class=cm>             - ä¸ä¸€è‡´äº†ï¼Œnext ä½œåºŸï¼Œè¿”å› false è¡¨ç¤ºå¤±è´¥
</span></span></span><span class=line><span class=cl><span class=cm>             æ¯”å¦‚ï¼Œåˆ«çš„çº¿ç¨‹å·²ç»åšäº†å‡æ³•ï¼Œå½“å‰å€¼å·²ç»è¢«å‡æˆäº† 990
</span></span></span><span class=line><span class=cl><span class=cm>             é‚£ä¹ˆæœ¬çº¿ç¨‹çš„è¿™æ¬¡ 990 å°±ä½œåºŸäº†ï¼Œè¿›å…¥ while ä¸‹æ¬¡å¾ªç¯é‡è¯•
</span></span></span><span class=line><span class=cl><span class=cm>             - ä¸€è‡´ï¼Œä»¥ next è®¾ç½®ä¸ºæ–°å€¼ï¼Œè¿”å› true è¡¨ç¤ºæˆåŠŸ
</span></span></span><span class=line><span class=cl><span class=cm>             */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>balance</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//æˆ–è€…ç®€æ´ä¸€ç‚¹ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//balance.getAndAdd(-1 * amount);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­çš„å…³é”®æ˜¯ compareAndSetï¼Œå®ƒçš„ç®€ç§°å°±æ˜¯ CAS ï¼ˆä¹Ÿæœ‰ Compare And Swap çš„è¯´æ³•ï¼‰ï¼Œå®ƒå¿…é¡»æ˜¯åŸå­æ“ä½œã€‚</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220308180039801.png width=900 height=600 loading=lazy decoding=async alt=image-20220308180039801 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><blockquote><p><strong>æ³¨æ„</strong></p><p>å…¶å® CAS çš„åº•å±‚æ˜¯ lock cmpxchg æŒ‡ä»¤ï¼ˆX86 æ¶æ„ï¼‰ï¼Œåœ¨å•æ ¸ CPU å’Œå¤šæ ¸ CPU ä¸‹éƒ½èƒ½å¤Ÿä¿è¯ã€æ¯”è¾ƒ-äº¤ æ¢ã€‘çš„åŸå­æ€§ã€‚</p><p>åœ¨å¤šæ ¸çŠ¶æ€ä¸‹ï¼ŒæŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šè®©æ€»çº¿é”ä½ï¼Œå½“è¿™ä¸ªæ ¸æŠŠæ­¤æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œå† å¼€å¯æ€»çº¿ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„å‡†ç¡®æ€§ï¼Œæ˜¯åŸå­ çš„ã€‚</p></blockquote><h5 id=æ…¢åŠ¨ä½œåˆ†æ><a href=#%e6%85%a2%e5%8a%a8%e4%bd%9c%e5%88%86%e6%9e%90 class=header-anchor>#</a>
æ…¢åŠ¨ä½œåˆ†æ</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-283-1><a class=lnlinks href=#hl-283-1> 1</a>
</span><span class=lnt id=hl-283-2><a class=lnlinks href=#hl-283-2> 2</a>
</span><span class=lnt id=hl-283-3><a class=lnlinks href=#hl-283-3> 3</a>
</span><span class=lnt id=hl-283-4><a class=lnlinks href=#hl-283-4> 4</a>
</span><span class=lnt id=hl-283-5><a class=lnlinks href=#hl-283-5> 5</a>
</span><span class=lnt id=hl-283-6><a class=lnlinks href=#hl-283-6> 6</a>
</span><span class=lnt id=hl-283-7><a class=lnlinks href=#hl-283-7> 7</a>
</span><span class=lnt id=hl-283-8><a class=lnlinks href=#hl-283-8> 8</a>
</span><span class=lnt id=hl-283-9><a class=lnlinks href=#hl-283-9> 9</a>
</span><span class=lnt id=hl-283-10><a class=lnlinks href=#hl-283-10>10</a>
</span><span class=lnt id=hl-283-11><a class=lnlinks href=#hl-283-11>11</a>
</span><span class=lnt id=hl-283-12><a class=lnlinks href=#hl-283-12>12</a>
</span><span class=lnt id=hl-283-13><a class=lnlinks href=#hl-283-13>13</a>
</span><span class=lnt id=hl-283-14><a class=lnlinks href=#hl-283-14>14</a>
</span><span class=lnt id=hl-283-15><a class=lnlinks href=#hl-283-15>15</a>
</span><span class=lnt id=hl-283-16><a class=lnlinks href=#hl-283-16>16</a>
</span><span class=lnt id=hl-283-17><a class=lnlinks href=#hl-283-17>17</a>
</span><span class=lnt id=hl-283-18><a class=lnlinks href=#hl-283-18>18</a>
</span><span class=lnt id=hl-283-19><a class=lnlinks href=#hl-283-19>19</a>
</span><span class=lnt id=hl-283-20><a class=lnlinks href=#hl-283-20>20</a>
</span><span class=lnt id=hl-283-21><a class=lnlinks href=#hl-283-21>21</a>
</span><span class=lnt id=hl-283-22><a class=lnlinks href=#hl-283-22>22</a>
</span><span class=lnt id=hl-283-23><a class=lnlinks href=#hl-283-23>23</a>
</span><span class=lnt id=hl-283-24><a class=lnlinks href=#hl-283-24>24</a>
</span><span class=lnt id=hl-283-25><a class=lnlinks href=#hl-283-25>25</a>
</span><span class=lnt id=hl-283-26><a class=lnlinks href=#hl-283-26>26</a>
</span><span class=lnt id=hl-283-27><a class=lnlinks href=#hl-283-27>27</a>
</span><span class=lnt id=hl-283-28><a class=lnlinks href=#hl-283-28>28</a>
</span><span class=lnt id=hl-283-29><a class=lnlinks href=#hl-283-29>29</a>
</span><span class=lnt id=hl-283-30><a class=lnlinks href=#hl-283-30>30</a>
</span><span class=lnt id=hl-283-31><a class=lnlinks href=#hl-283-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SlowMotion</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>10000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>mainPrev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;try get {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>mainPrev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>balance</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>9000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>balance</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;try set 8000...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>isSuccess</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>mainPrev</span><span class=p>,</span><span class=w> </span><span class=n>8000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;is success ? {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>isSuccess</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>isSuccess</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mainPrev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;try set 8000...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>isSuccess</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>mainPrev</span><span class=p>,</span><span class=w> </span><span class=n>8000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;is success ? {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>isSuccess</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sleep</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>millis</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>millis</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-284-1><a class=lnlinks href=#hl-284-1>1</a>
</span><span class=lnt id=hl-284-2><a class=lnlinks href=#hl-284-2>2</a>
</span><span class=lnt id=hl-284-3><a class=lnlinks href=#hl-284-3>3</a>
</span><span class=lnt id=hl-284-4><a class=lnlinks href=#hl-284-4>4</a>
</span><span class=lnt id=hl-284-5><a class=lnlinks href=#hl-284-5>5</a>
</span><span class=lnt id=hl-284-6><a class=lnlinks href=#hl-284-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>2019-10-13 11:28:37.134 <span class=o>[</span>main<span class=o>]</span> try get <span class=m>10000</span> 
</span></span><span class=line><span class=cl>2019-10-13 11:28:38.154 <span class=o>[</span>t1<span class=o>]</span> <span class=m>9000</span> 
</span></span><span class=line><span class=cl>2019-10-13 11:28:39.154 <span class=o>[</span>main<span class=o>]</span> try <span class=nb>set</span> 8000... 
</span></span><span class=line><span class=cl>2019-10-13 11:28:39.154 <span class=o>[</span>main<span class=o>]</span> is success ? <span class=nb>false</span> 
</span></span><span class=line><span class=cl>2019-10-13 11:28:39.154 <span class=o>[</span>main<span class=o>]</span> try <span class=nb>set</span> 8000... 
</span></span><span class=line><span class=cl>2019-10-13 11:28:39.154 <span class=o>[</span>main<span class=o>]</span> is success ? <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=volatile><a href=#volatile class=header-anchor>#</a>
volatile</h5><p>è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨ volatile ä¿®é¥°ã€‚</p><p>å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å– å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜ã€‚å³ä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹ï¼Œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚</p><blockquote><p><strong>æ³¨æ„</strong></p><p>volatile ä»…ä»…ä¿è¯äº†å…±äº«å˜é‡çš„å¯è§æ€§ï¼Œè®©å…¶å®ƒçº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°æœ€æ–°å€¼ï¼Œä½†ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™é—®é¢˜ï¼ˆä¸èƒ½ä¿è¯åŸ å­æ€§ï¼‰</p></blockquote><p>CAS å¿…é¡»å€ŸåŠ© volatile æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°ã€æ¯”è¾ƒå¹¶äº¤æ¢ã€‘çš„æ•ˆæœã€‚</p><p><strong>ä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜</strong></p><ul><li>æ— é”æƒ…å†µä¸‹ï¼Œå³ä½¿é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œï¼Œæ²¡æœ‰åœæ­‡ï¼Œç±»ä¼¼äºè‡ªæ—‹ã€‚è€Œ synchronized ä¼šè®©çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶å€™ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡ã€‚çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯è´¹æ—¶çš„ï¼Œåœ¨é‡è¯•æ¬¡æ•°ä¸æ˜¯å¤ªå¤šæ—¶ï¼Œæ— é”çš„æ•ˆç‡é«˜äºæœ‰é”ã€‚</li><li>çº¿ç¨‹å°±å¥½åƒé«˜é€Ÿè·‘é“ä¸Šçš„èµ›è½¦ï¼Œé«˜é€Ÿè¿è¡Œæ—¶ï¼Œé€Ÿåº¦è¶…å¿«ï¼Œä¸€æ—¦å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°±å¥½æ¯”èµ›è½¦è¦å‡é€Ÿã€ç†„ç«ï¼Œ ç­‰è¢«å”¤é†’åˆå¾—é‡æ–°æ‰“ç«ã€å¯åŠ¨ã€åŠ é€Ÿ&mldr; æ¢å¤åˆ°é«˜é€Ÿè¿è¡Œï¼Œä»£ä»·æ¯”è¾ƒå¤§</li><li>ä½†æ— é”æƒ…å†µä¸‹ï¼Œå› ä¸ºçº¿ç¨‹è¦ä¿æŒè¿è¡Œï¼Œéœ€è¦é¢å¤– CPU çš„æ”¯æŒï¼ŒCPU åœ¨è¿™é‡Œå°±å¥½æ¯”é«˜é€Ÿè·‘é“ï¼Œæ²¡æœ‰é¢å¤–çš„è·‘ é“ï¼Œçº¿ç¨‹æƒ³é«˜é€Ÿè¿è¡Œä¹Ÿæ— ä»è°ˆèµ·ï¼Œè™½ç„¶ä¸ä¼šè¿›å…¥é˜»å¡ï¼Œä½†ç”±äºæ²¡æœ‰åˆ†åˆ°æ—¶é—´ç‰‡ï¼Œä»ç„¶ä¼šè¿›å…¥å¯è¿è¡ŒçŠ¶æ€ï¼Œè¿˜ æ˜¯ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œå½“çº¿ç¨‹æ•°å°äºç­‰äºcpuæ ¸å¿ƒæ•°æ—¶ï¼Œä½¿ç”¨æ— é”æ–¹æ¡ˆæ˜¯å¾ˆåˆé€‚çš„ï¼Œå› ä¸ºæœ‰è¶³å¤Ÿå¤šçš„cpuè®©çº¿ç¨‹è¿è¡Œã€‚å½“çº¿ç¨‹æ•°è¿œå¤šäºcpuæ ¸å¿ƒæ•°æ—¶ï¼Œæ— é”æ•ˆç‡ç›¸æ¯”äºæœ‰é”å°±æ²¡æœ‰å¤ªå¤§ä¼˜åŠ¿ï¼Œå› ä¸ºä¾æ—§ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220308200536875.png width=900 height=600 loading=lazy decoding=async alt=image-20220308200536875 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=cas-çš„ç‰¹ç‚¹><a href=#cas-%e7%9a%84%e7%89%b9%e7%82%b9 class=header-anchor>#</a>
CAS çš„ç‰¹ç‚¹</h5><p>ç»“åˆ CAS å’Œ volatile å¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºçº¿ç¨‹æ•°å°‘ã€å¤šæ ¸ CPU çš„åœºæ™¯ä¸‹ã€‚</p><ul><li>CAS æ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³ï¼šæœ€ä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘åƒäºç‚¹å† é‡è¯•å‘—ã€‚</li><li>synchronized æ˜¯åŸºäºæ‚²è§‚é”çš„æ€æƒ³ï¼šæœ€æ‚²è§‚çš„ä¼°è®¡ï¼Œå¾—é˜²ç€å…¶å®ƒçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œæˆ‘ä¸Šäº†é”ä½ ä»¬éƒ½åˆ«æƒ³ æ”¹ï¼Œæˆ‘æ”¹å®Œäº†è§£å¼€é”ï¼Œä½ ä»¬æ‰æœ‰æœºä¼šã€‚</li><li>CAS ä½“ç°çš„æ˜¯æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘ï¼Œè¯·ä»”ç»†ä½“ä¼šè¿™ä¸¤å¥è¯çš„æ„æ€<ul><li>å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€</li><li>ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“</li></ul></li></ul><h2 id=63-åŸå­æ•´æ•°><a href=#63-%e5%8e%9f%e5%ad%90%e6%95%b4%e6%95%b0 class=header-anchor>#</a>
6.3 åŸå­æ•´æ•°</h2><p>J.U.C å¹¶å‘åŒ…æä¾›äº†ï¼š</p><ul><li>AtomicBoolean</li><li>AtomicInteger</li><li>AtomicLong</li></ul><p>ä»¥ AtomicInteger ä¸ºä¾‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-285-1><a class=lnlinks href=#hl-285-1> 1</a>
</span><span class=lnt id=hl-285-2><a class=lnlinks href=#hl-285-2> 2</a>
</span><span class=lnt id=hl-285-3><a class=lnlinks href=#hl-285-3> 3</a>
</span><span class=lnt id=hl-285-4><a class=lnlinks href=#hl-285-4> 4</a>
</span><span class=lnt id=hl-285-5><a class=lnlinks href=#hl-285-5> 5</a>
</span><span class=lnt id=hl-285-6><a class=lnlinks href=#hl-285-6> 6</a>
</span><span class=lnt id=hl-285-7><a class=lnlinks href=#hl-285-7> 7</a>
</span><span class=lnt id=hl-285-8><a class=lnlinks href=#hl-285-8> 8</a>
</span><span class=lnt id=hl-285-9><a class=lnlinks href=#hl-285-9> 9</a>
</span><span class=lnt id=hl-285-10><a class=lnlinks href=#hl-285-10>10</a>
</span><span class=lnt id=hl-285-11><a class=lnlinks href=#hl-285-11>11</a>
</span><span class=lnt id=hl-285-12><a class=lnlinks href=#hl-285-12>12</a>
</span><span class=lnt id=hl-285-13><a class=lnlinks href=#hl-285-13>13</a>
</span><span class=lnt id=hl-285-14><a class=lnlinks href=#hl-285-14>14</a>
</span><span class=lnt id=hl-285-15><a class=lnlinks href=#hl-285-15>15</a>
</span><span class=lnt id=hl-285-16><a class=lnlinks href=#hl-285-16>16</a>
</span><span class=lnt id=hl-285-17><a class=lnlinks href=#hl-285-17>17</a>
</span><span class=lnt id=hl-285-18><a class=lnlinks href=#hl-285-18>18</a>
</span><span class=lnt id=hl-285-19><a class=lnlinks href=#hl-285-19>19</a>
</span><span class=lnt id=hl-285-20><a class=lnlinks href=#hl-285-20>20</a>
</span><span class=lnt id=hl-285-21><a class=lnlinks href=#hl-285-21>21</a>
</span><span class=lnt id=hl-285-22><a class=lnlinks href=#hl-285-22>22</a>
</span><span class=lnt id=hl-285-23><a class=lnlinks href=#hl-285-23>23</a>
</span><span class=lnt id=hl-285-24><a class=lnlinks href=#hl-285-24>24</a>
</span><span class=lnt id=hl-285-25><a class=lnlinks href=#hl-285-25>25</a>
</span><span class=lnt id=hl-285-26><a class=lnlinks href=#hl-285-26>26</a>
</span><span class=lnt id=hl-285-27><a class=lnlinks href=#hl-285-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>AtomicInteger</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–å¹¶è‡ªå¢ï¼ˆi = 0, ç»“æœ i = 1, è¿”å› 0ï¼‰ï¼Œç±»ä¼¼äº i++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è‡ªå¢å¹¶è·å–ï¼ˆi = 1, ç»“æœ i = 2, è¿”å› 2ï¼‰ï¼Œç±»ä¼¼äº ++i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è‡ªå‡å¹¶è·å–ï¼ˆi = 2, ç»“æœ i = 1, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº --i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–å¹¶è‡ªå‡ï¼ˆi = 1, ç»“æœ i = 0, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº i--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>getAndDecrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–å¹¶åŠ å€¼ï¼ˆi = 0, ç»“æœ i = 5, è¿”å› 0ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>getAndAdd</span><span class=p>(</span><span class=n>5</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// åŠ å€¼å¹¶è·å–ï¼ˆi = 5, ç»“æœ i = 0, è¿”å› 0ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>addAndGet</span><span class=p>(</span><span class=o>-</span><span class=n>5</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–å¹¶æ›´æ–°ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = -2, è¿”å› 0ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>getAndUpdate</span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>2</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æ›´æ–°å¹¶è·å–ï¼ˆi = -2, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = 0, è¿”å› 0ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>updateAndGet</span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>2</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–å¹¶è®¡ç®—ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 10, è¿”å› 0ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// getAndUpdate å¦‚æœåœ¨ lambda ä¸­å¼•ç”¨äº†å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¦ä¿è¯è¯¥å±€éƒ¨å˜é‡æ˜¯ final çš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// getAndAccumulate å¯ä»¥é€šè¿‡ å‚æ•°1 æ¥å¼•ç”¨å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œä½†å› ä¸ºå…¶ä¸åœ¨ lambda ä¸­å› æ­¤ä¸å¿…æ˜¯ final</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>getAndAccumulate</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è®¡ç®—å¹¶è·å–ï¼ˆi = 10, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 0, è¿”å› 0ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>accumulateAndGet</span><span class=p>(</span><span class=o>-</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯´æ˜ï¼š</p><ul><li><p>ä»¥ä¸Šæ–¹æ³•éƒ½æ˜¯ä»¥CASä¸ºåŸºç¡€è¿›è¡Œäº†å°è£…ï¼Œä¿è¯äº†æ–¹æ³•çš„åŸå­æ€§å’Œå˜é‡çš„å¯è§æ€§ã€‚</p></li><li><p>updateAndGetæ–¹æ³•çš„æ‰‹åŠ¨å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-286-1><a class=lnlinks href=#hl-286-1>1</a>
</span><span class=lnt id=hl-286-2><a class=lnlinks href=#hl-286-2>2</a>
</span><span class=lnt id=hl-286-3><a class=lnlinks href=#hl-286-3>3</a>
</span><span class=lnt id=hl-286-4><a class=lnlinks href=#hl-286-4>4</a>
</span><span class=lnt id=hl-286-5><a class=lnlinks href=#hl-286-5>5</a>
</span><span class=lnt id=hl-286-6><a class=lnlinks href=#hl-286-6>6</a>
</span><span class=lnt id=hl-286-7><a class=lnlinks href=#hl-286-7>7</a>
</span><span class=lnt id=hl-286-8><a class=lnlinks href=#hl-286-8>8</a>
</span><span class=lnt id=hl-286-9><a class=lnlinks href=#hl-286-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>updateAndGet</span><span class=p>(</span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>IntUnaryOperator</span><span class=w> </span><span class=n>operator</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operator</span><span class=p>.</span><span class=na>applyAsInt</span><span class=p>(</span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=n>next</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=64-åŸå­å¼•ç”¨><a href=#64-%e5%8e%9f%e5%ad%90%e5%bc%95%e7%94%a8 class=header-anchor>#</a>
6.4 åŸå­å¼•ç”¨</h2><p>ä¸ºä»€ä¹ˆéœ€è¦åŸå­å¼•ç”¨ç±»å‹ï¼Ÿ</p><ul><li>AtomicReference</li><li>AtomicMarkableReference</li><li>AtomicStampedReference</li></ul><p>å®é™…å¼€å‘çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä½¿ç”¨çš„ä¸ä¸€å®šæ˜¯intã€longç­‰åŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¹Ÿæœ‰å¯èƒ½æ—¶BigDecimalè¿™æ ·çš„ç±»å‹ï¼Œè¿™æ—¶å°±éœ€è¦ç”¨åˆ°åŸå­å¼•ç”¨ä½œä¸ºå®¹å™¨ã€‚åŸå­å¼•ç”¨è®¾ç½®å€¼ä½¿ç”¨çš„æ˜¯<code>unsafe.compareAndSwapObject()</code>æ–¹æ³•ã€‚åŸå­å¼•ç”¨ä¸­è¡¨ç¤ºæ•°æ®çš„ç±»å‹éœ€è¦é‡å†™<code>equals()</code>æ–¹æ³•ã€‚</p><p>æœ‰å¦‚ä¸‹æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-287-1><a class=lnlinks href=#hl-287-1> 1</a>
</span><span class=lnt id=hl-287-2><a class=lnlinks href=#hl-287-2> 2</a>
</span><span class=lnt id=hl-287-3><a class=lnlinks href=#hl-287-3> 3</a>
</span><span class=lnt id=hl-287-4><a class=lnlinks href=#hl-287-4> 4</a>
</span><span class=lnt id=hl-287-5><a class=lnlinks href=#hl-287-5> 5</a>
</span><span class=lnt id=hl-287-6><a class=lnlinks href=#hl-287-6> 6</a>
</span><span class=lnt id=hl-287-7><a class=lnlinks href=#hl-287-7> 7</a>
</span><span class=lnt id=hl-287-8><a class=lnlinks href=#hl-287-8> 8</a>
</span><span class=lnt id=hl-287-9><a class=lnlinks href=#hl-287-9> 9</a>
</span><span class=lnt id=hl-287-10><a class=lnlinks href=#hl-287-10>10</a>
</span><span class=lnt id=hl-287-11><a class=lnlinks href=#hl-287-11>11</a>
</span><span class=lnt id=hl-287-12><a class=lnlinks href=#hl-287-12>12</a>
</span><span class=lnt id=hl-287-13><a class=lnlinks href=#hl-287-13>13</a>
</span><span class=lnt id=hl-287-14><a class=lnlinks href=#hl-287-14>14</a>
</span><span class=lnt id=hl-287-15><a class=lnlinks href=#hl-287-15>15</a>
</span><span class=lnt id=hl-287-16><a class=lnlinks href=#hl-287-16>16</a>
</span><span class=lnt id=hl-287-17><a class=lnlinks href=#hl-287-17>17</a>
</span><span class=lnt id=hl-287-18><a class=lnlinks href=#hl-287-18>18</a>
</span><span class=lnt id=hl-287-19><a class=lnlinks href=#hl-287-19>19</a>
</span><span class=lnt id=hl-287-20><a class=lnlinks href=#hl-287-20>20</a>
</span><span class=lnt id=hl-287-21><a class=lnlinks href=#hl-287-21>21</a>
</span><span class=lnt id=hl-287-22><a class=lnlinks href=#hl-287-22>22</a>
</span><span class=lnt id=hl-287-23><a class=lnlinks href=#hl-287-23>23</a>
</span><span class=lnt id=hl-287-24><a class=lnlinks href=#hl-287-24>24</a>
</span><span class=lnt id=hl-287-25><a class=lnlinks href=#hl-287-25>25</a>
</span><span class=lnt id=hl-287-26><a class=lnlinks href=#hl-287-26>26</a>
</span><span class=lnt id=hl-287-27><a class=lnlinks href=#hl-287-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>DecimalAccount</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–ä½™é¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BigDecimal</span><span class=w> </span><span class=nf>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å–æ¬¾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ
</span></span></span><span class=line><span class=cl><span class=cm> * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo</span><span class=p>(</span><span class=n>DecimalAccount</span><span class=w> </span><span class=n>account</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ts</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>account</span><span class=p>.</span><span class=na>withdraw</span><span class=p>(</span><span class=n>BigDecimal</span><span class=p>.</span><span class=na>TEN</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>Thread</span><span class=p>::</span><span class=n>start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯•ç€æä¾›ä¸åŒçš„ DecimalAccount å®ç°ï¼Œå®ç°å®‰å…¨çš„å–æ¬¾æ“ä½œ</p><h5 id=ä¸å®‰å…¨å®ç°><a href=#%e4%b8%8d%e5%ae%89%e5%85%a8%e5%ae%9e%e7%8e%b0 class=header-anchor>#</a>
<strong>ä¸å®‰å…¨å®ç°</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-288-1><a class=lnlinks href=#hl-288-1> 1</a>
</span><span class=lnt id=hl-288-2><a class=lnlinks href=#hl-288-2> 2</a>
</span><span class=lnt id=hl-288-3><a class=lnlinks href=#hl-288-3> 3</a>
</span><span class=lnt id=hl-288-4><a class=lnlinks href=#hl-288-4> 4</a>
</span><span class=lnt id=hl-288-5><a class=lnlinks href=#hl-288-5> 5</a>
</span><span class=lnt id=hl-288-6><a class=lnlinks href=#hl-288-6> 6</a>
</span><span class=lnt id=hl-288-7><a class=lnlinks href=#hl-288-7> 7</a>
</span><span class=lnt id=hl-288-8><a class=lnlinks href=#hl-288-8> 8</a>
</span><span class=lnt id=hl-288-9><a class=lnlinks href=#hl-288-9> 9</a>
</span><span class=lnt id=hl-288-10><a class=lnlinks href=#hl-288-10>10</a>
</span><span class=lnt id=hl-288-11><a class=lnlinks href=#hl-288-11>11</a>
</span><span class=lnt id=hl-288-12><a class=lnlinks href=#hl-288-12>12</a>
</span><span class=lnt id=hl-288-13><a class=lnlinks href=#hl-288-13>13</a>
</span><span class=lnt id=hl-288-14><a class=lnlinks href=#hl-288-14>14</a>
</span><span class=lnt id=hl-288-15><a class=lnlinks href=#hl-288-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DecimalAccountUnsafe</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DecimalAccount</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DecimalAccountUnsafe</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>subtract</span><span class=p>(</span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=å®‰å…¨å®ç°-ä½¿ç”¨é”><a href=#%e5%ae%89%e5%85%a8%e5%ae%9e%e7%8e%b0-%e4%bd%bf%e7%94%a8%e9%94%81 class=header-anchor>#</a>
<strong>å®‰å…¨å®ç°-ä½¿ç”¨é”</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-289-1><a class=lnlinks href=#hl-289-1> 1</a>
</span><span class=lnt id=hl-289-2><a class=lnlinks href=#hl-289-2> 2</a>
</span><span class=lnt id=hl-289-3><a class=lnlinks href=#hl-289-3> 3</a>
</span><span class=lnt id=hl-289-4><a class=lnlinks href=#hl-289-4> 4</a>
</span><span class=lnt id=hl-289-5><a class=lnlinks href=#hl-289-5> 5</a>
</span><span class=lnt id=hl-289-6><a class=lnlinks href=#hl-289-6> 6</a>
</span><span class=lnt id=hl-289-7><a class=lnlinks href=#hl-289-7> 7</a>
</span><span class=lnt id=hl-289-8><a class=lnlinks href=#hl-289-8> 8</a>
</span><span class=lnt id=hl-289-9><a class=lnlinks href=#hl-289-9> 9</a>
</span><span class=lnt id=hl-289-10><a class=lnlinks href=#hl-289-10>10</a>
</span><span class=lnt id=hl-289-11><a class=lnlinks href=#hl-289-11>11</a>
</span><span class=lnt id=hl-289-12><a class=lnlinks href=#hl-289-12>12</a>
</span><span class=lnt id=hl-289-13><a class=lnlinks href=#hl-289-13>13</a>
</span><span class=lnt id=hl-289-14><a class=lnlinks href=#hl-289-14>14</a>
</span><span class=lnt id=hl-289-15><a class=lnlinks href=#hl-289-15>15</a>
</span><span class=lnt id=hl-289-16><a class=lnlinks href=#hl-289-16>16</a>
</span><span class=lnt id=hl-289-17><a class=lnlinks href=#hl-289-17>17</a>
</span><span class=lnt id=hl-289-18><a class=lnlinks href=#hl-289-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DecimalAccountSafeLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DecimalAccount</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DecimalAccountSafeLock</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>subtract</span><span class=p>(</span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=å®‰å…¨å®ç°-ä½¿ç”¨-cas><a href=#%e5%ae%89%e5%85%a8%e5%ae%9e%e7%8e%b0-%e4%bd%bf%e7%94%a8-cas class=header-anchor>#</a>
<strong>å®‰å…¨å®ç°-ä½¿ç”¨ CAS</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-290-1><a class=lnlinks href=#hl-290-1> 1</a>
</span><span class=lnt id=hl-290-2><a class=lnlinks href=#hl-290-2> 2</a>
</span><span class=lnt id=hl-290-3><a class=lnlinks href=#hl-290-3> 3</a>
</span><span class=lnt id=hl-290-4><a class=lnlinks href=#hl-290-4> 4</a>
</span><span class=lnt id=hl-290-5><a class=lnlinks href=#hl-290-5> 5</a>
</span><span class=lnt id=hl-290-6><a class=lnlinks href=#hl-290-6> 6</a>
</span><span class=lnt id=hl-290-7><a class=lnlinks href=#hl-290-7> 7</a>
</span><span class=lnt id=hl-290-8><a class=lnlinks href=#hl-290-8> 8</a>
</span><span class=lnt id=hl-290-9><a class=lnlinks href=#hl-290-9> 9</a>
</span><span class=lnt id=hl-290-10><a class=lnlinks href=#hl-290-10>10</a>
</span><span class=lnt id=hl-290-11><a class=lnlinks href=#hl-290-11>11</a>
</span><span class=lnt id=hl-290-12><a class=lnlinks href=#hl-290-12>12</a>
</span><span class=lnt id=hl-290-13><a class=lnlinks href=#hl-290-13>13</a>
</span><span class=lnt id=hl-290-14><a class=lnlinks href=#hl-290-14>14</a>
</span><span class=lnt id=hl-290-15><a class=lnlinks href=#hl-290-15>15</a>
</span><span class=lnt id=hl-290-16><a class=lnlinks href=#hl-290-16>16</a>
</span><span class=lnt id=hl-290-17><a class=lnlinks href=#hl-290-17>17</a>
</span><span class=lnt id=hl-290-18><a class=lnlinks href=#hl-290-18>18</a>
</span><span class=lnt id=hl-290-19><a class=lnlinks href=#hl-290-19>19</a>
</span><span class=lnt id=hl-290-20><a class=lnlinks href=#hl-290-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DecimalAccountSafeCas</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DecimalAccount</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>BigDecimal</span><span class=o>&gt;</span><span class=w> </span><span class=n>ref</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DecimalAccountSafeCas</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BigDecimal</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prev</span><span class=p>.</span><span class=na>subtract</span><span class=p>(</span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-291-1><a class=lnlinks href=#hl-291-1>1</a>
</span><span class=lnt id=hl-291-2><a class=lnlinks href=#hl-291-2>2</a>
</span><span class=lnt id=hl-291-3><a class=lnlinks href=#hl-291-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>DecimalAccount.demo<span class=o>(</span>new DecimalAccountUnsafe<span class=o>(</span>new BigDecimal<span class=o>(</span><span class=s2>&#34;10000&#34;</span><span class=o>)))</span><span class=p>;</span>
</span></span><span class=line><span class=cl>DecimalAccount.demo<span class=o>(</span>new DecimalAccountSafeLock<span class=o>(</span>new BigDecimal<span class=o>(</span><span class=s2>&#34;10000&#34;</span><span class=o>)))</span><span class=p>;</span>
</span></span><span class=line><span class=cl>DecimalAccount.demo<span class=o>(</span>new DecimalAccountSafeCas<span class=o>(</span>new BigDecimal<span class=o>(</span><span class=s2>&#34;10000&#34;</span><span class=o>)))</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿è¡Œç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-292-1><a class=lnlinks href=#hl-292-1>1</a>
</span><span class=lnt id=hl-292-2><a class=lnlinks href=#hl-292-2>2</a>
</span><span class=lnt id=hl-292-3><a class=lnlinks href=#hl-292-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>4310</span> cost: <span class=m>425</span> ms 
</span></span><span class=line><span class=cl><span class=m>0</span> cost: <span class=m>285</span> ms 
</span></span><span class=line><span class=cl><span class=m>0</span> cost: <span class=m>274</span> ms
</span></span></code></pre></td></tr></table></div></div><h5 id=aba-é—®é¢˜åŠè§£å†³><a href=#aba-%e9%97%ae%e9%a2%98%e5%8f%8a%e8%a7%a3%e5%86%b3 class=header-anchor>#</a>
ABA é—®é¢˜åŠè§£å†³</h5><p><strong>ABA é—®é¢˜</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-293-1><a class=lnlinks href=#hl-293-1> 1</a>
</span><span class=lnt id=hl-293-2><a class=lnlinks href=#hl-293-2> 2</a>
</span><span class=lnt id=hl-293-3><a class=lnlinks href=#hl-293-3> 3</a>
</span><span class=lnt id=hl-293-4><a class=lnlinks href=#hl-293-4> 4</a>
</span><span class=lnt id=hl-293-5><a class=lnlinks href=#hl-293-5> 5</a>
</span><span class=lnt id=hl-293-6><a class=lnlinks href=#hl-293-6> 6</a>
</span><span class=lnt id=hl-293-7><a class=lnlinks href=#hl-293-7> 7</a>
</span><span class=lnt id=hl-293-8><a class=lnlinks href=#hl-293-8> 8</a>
</span><span class=lnt id=hl-293-9><a class=lnlinks href=#hl-293-9> 9</a>
</span><span class=lnt id=hl-293-10><a class=lnlinks href=#hl-293-10>10</a>
</span><span class=lnt id=hl-293-11><a class=lnlinks href=#hl-293-11>11</a>
</span><span class=lnt id=hl-293-12><a class=lnlinks href=#hl-293-12>12</a>
</span><span class=lnt id=hl-293-13><a class=lnlinks href=#hl-293-13>13</a>
</span><span class=lnt id=hl-293-14><a class=lnlinks href=#hl-293-14>14</a>
</span><span class=lnt id=hl-293-15><a class=lnlinks href=#hl-293-15>15</a>
</span><span class=lnt id=hl-293-16><a class=lnlinks href=#hl-293-16>16</a>
</span><span class=lnt id=hl-293-17><a class=lnlinks href=#hl-293-17>17</a>
</span><span class=lnt id=hl-293-18><a class=lnlinks href=#hl-293-18>18</a>
</span><span class=lnt id=hl-293-19><a class=lnlinks href=#hl-293-19>19</a>
</span><span class=lnt id=hl-293-20><a class=lnlinks href=#hl-293-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=s>&#34;A&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;main start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–å€¼ A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿™ä¸ªå…±äº«å˜é‡è¢«å®ƒçº¿ç¨‹ä¿®æ”¹è¿‡ï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>other</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°è¯•æ”¹ä¸º C</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change A-&gt;C {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>other</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change A-&gt;B {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;B&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change B-&gt;A {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;A&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-294-1><a class=lnlinks href=#hl-294-1>1</a>
</span><span class=lnt id=hl-294-2><a class=lnlinks href=#hl-294-2>2</a>
</span><span class=lnt id=hl-294-3><a class=lnlinks href=#hl-294-3>3</a>
</span><span class=lnt id=hl-294-4><a class=lnlinks href=#hl-294-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:29:52.325 c.Test36 <span class=o>[</span>main<span class=o>]</span> - main start... 
</span></span><span class=line><span class=cl>11:29:52.379 c.Test36 <span class=o>[</span>t1<span class=o>]</span> - change A-&gt;B <span class=nb>true</span> 
</span></span><span class=line><span class=cl>11:29:52.879 c.Test36 <span class=o>[</span>t2<span class=o>]</span> - change B-&gt;A <span class=nb>true</span> 
</span></span><span class=line><span class=cl>11:29:53.880 c.Test36 <span class=o>[</span>main<span class=o>]</span> - change A-&gt;C <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸»çº¿ç¨‹ä»…èƒ½åˆ¤æ–­å‡ºå…±äº«å˜é‡çš„å€¼ä¸æœ€åˆå€¼ A æ˜¯å¦ç›¸åŒï¼Œä¸èƒ½æ„ŸçŸ¥åˆ°è¿™ç§ä» A æ”¹ä¸º B åˆ æ”¹å› A çš„æƒ…å†µï¼Œå¦‚æœä¸»çº¿ç¨‹ å¸Œæœ›ï¼š</p><p>åªè¦æœ‰å…¶å®ƒçº¿ç¨‹ã€åŠ¨è¿‡äº†ã€‘å…±äº«å˜é‡ï¼Œé‚£ä¹ˆè‡ªå·±çš„ cas å°±ç®—å¤±è´¥ï¼Œè¿™æ—¶ï¼Œä»…æ¯”è¾ƒå€¼æ˜¯ä¸å¤Ÿçš„ï¼Œéœ€è¦å†åŠ ä¸€ä¸ªç‰ˆæœ¬å·</p><p><strong>AtomicStampedReference</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-295-1><a class=lnlinks href=#hl-295-1> 1</a>
</span><span class=lnt id=hl-295-2><a class=lnlinks href=#hl-295-2> 2</a>
</span><span class=lnt id=hl-295-3><a class=lnlinks href=#hl-295-3> 3</a>
</span><span class=lnt id=hl-295-4><a class=lnlinks href=#hl-295-4> 4</a>
</span><span class=lnt id=hl-295-5><a class=lnlinks href=#hl-295-5> 5</a>
</span><span class=lnt id=hl-295-6><a class=lnlinks href=#hl-295-6> 6</a>
</span><span class=lnt id=hl-295-7><a class=lnlinks href=#hl-295-7> 7</a>
</span><span class=lnt id=hl-295-8><a class=lnlinks href=#hl-295-8> 8</a>
</span><span class=lnt id=hl-295-9><a class=lnlinks href=#hl-295-9> 9</a>
</span><span class=lnt id=hl-295-10><a class=lnlinks href=#hl-295-10>10</a>
</span><span class=lnt id=hl-295-11><a class=lnlinks href=#hl-295-11>11</a>
</span><span class=lnt id=hl-295-12><a class=lnlinks href=#hl-295-12>12</a>
</span><span class=lnt id=hl-295-13><a class=lnlinks href=#hl-295-13>13</a>
</span><span class=lnt id=hl-295-14><a class=lnlinks href=#hl-295-14>14</a>
</span><span class=lnt id=hl-295-15><a class=lnlinks href=#hl-295-15>15</a>
</span><span class=lnt id=hl-295-16><a class=lnlinks href=#hl-295-16>16</a>
</span><span class=lnt id=hl-295-17><a class=lnlinks href=#hl-295-17>17</a>
</span><span class=lnt id=hl-295-18><a class=lnlinks href=#hl-295-18>18</a>
</span><span class=lnt id=hl-295-19><a class=lnlinks href=#hl-295-19>19</a>
</span><span class=lnt id=hl-295-20><a class=lnlinks href=#hl-295-20>20</a>
</span><span class=lnt id=hl-295-21><a class=lnlinks href=#hl-295-21>21</a>
</span><span class=lnt id=hl-295-22><a class=lnlinks href=#hl-295-22>22</a>
</span><span class=lnt id=hl-295-23><a class=lnlinks href=#hl-295-23>23</a>
</span><span class=lnt id=hl-295-24><a class=lnlinks href=#hl-295-24>24</a>
</span><span class=lnt id=hl-295-25><a class=lnlinks href=#hl-295-25>25</a>
</span><span class=lnt id=hl-295-26><a class=lnlinks href=#hl-295-26>26</a>
</span><span class=lnt id=hl-295-27><a class=lnlinks href=#hl-295-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>AtomicStampedReference</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicStampedReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=s>&#34;A&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;main start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–å€¼ A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getReference</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–ç‰ˆæœ¬å·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ç‰ˆæœ¬ {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœä¸­é—´æœ‰å…¶å®ƒçº¿ç¨‹å¹²æ‰°ï¼Œå‘ç”Ÿäº† ABA ç°è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>other</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°è¯•æ”¹ä¸º C</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change A-&gt;C {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>other</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change A-&gt;B {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>getReference</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;B&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                                      </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>(),</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ›´æ–°ç‰ˆæœ¬ä¸º {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;change B-&gt;A {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>getReference</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;A&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                                      </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>(),</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ›´æ–°ç‰ˆæœ¬ä¸º {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getStamp</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºä¸º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-296-1><a class=lnlinks href=#hl-296-1>1</a>
</span><span class=lnt id=hl-296-2><a class=lnlinks href=#hl-296-2>2</a>
</span><span class=lnt id=hl-296-3><a class=lnlinks href=#hl-296-3>3</a>
</span><span class=lnt id=hl-296-4><a class=lnlinks href=#hl-296-4>4</a>
</span><span class=lnt id=hl-296-5><a class=lnlinks href=#hl-296-5>5</a>
</span><span class=lnt id=hl-296-6><a class=lnlinks href=#hl-296-6>6</a>
</span><span class=lnt id=hl-296-7><a class=lnlinks href=#hl-296-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>15:41:34.891 c.Test36 <span class=o>[</span>main<span class=o>]</span> - main start... 
</span></span><span class=line><span class=cl>15:41:34.894 c.Test36 <span class=o>[</span>main<span class=o>]</span> - ç‰ˆæœ¬ <span class=m>0</span> 
</span></span><span class=line><span class=cl>15:41:34.956 c.Test36 <span class=o>[</span>t1<span class=o>]</span> - change A-&gt;B <span class=nb>true</span> 
</span></span><span class=line><span class=cl>15:41:34.956 c.Test36 <span class=o>[</span>t1<span class=o>]</span> - æ›´æ–°ç‰ˆæœ¬ä¸º <span class=m>1</span> 
</span></span><span class=line><span class=cl>15:41:35.457 c.Test36 <span class=o>[</span>t2<span class=o>]</span> - change B-&gt;A <span class=nb>true</span> 
</span></span><span class=line><span class=cl>15:41:35.457 c.Test36 <span class=o>[</span>t2<span class=o>]</span> - æ›´æ–°ç‰ˆæœ¬ä¸º <span class=m>2</span> 
</span></span><span class=line><span class=cl>15:41:36.457 c.Test36 <span class=o>[</span>main<span class=o>]</span> - change A-&gt;C <span class=nb>false</span> 
</span></span></code></pre></td></tr></table></div></div><p>AtomicStampedReference å¯ä»¥ç»™åŸå­å¼•ç”¨åŠ ä¸Šç‰ˆæœ¬å·ï¼Œè¿½è¸ªåŸå­å¼•ç”¨æ•´ä¸ªçš„å˜åŒ–è¿‡ç¨‹ï¼Œå¦‚ï¼š <code>A -> B -> A -> C</code> ï¼Œé€šè¿‡AtomicStampedReferenceï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¼•ç”¨å˜é‡ä¸­é€”è¢«æ›´æ”¹äº†å‡ æ¬¡ã€‚</p><p>ä½†æ˜¯æœ‰æ—¶å€™ï¼Œå¹¶ä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹äº†å‡ æ¬¡ï¼Œåªæ˜¯å•çº¯çš„å…³å¿ƒæ˜¯å¦æ›´æ”¹è¿‡ï¼Œæ‰€ä»¥å°±æœ‰äº† AtomicMarkableReference</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-297-1><a class=lnlinks href=#hl-297-1> 1</a>
</span><span class=lnt id=hl-297-2><a class=lnlinks href=#hl-297-2> 2</a>
</span><span class=lnt id=hl-297-3><a class=lnlinks href=#hl-297-3> 3</a>
</span><span class=lnt id=hl-297-4><a class=lnlinks href=#hl-297-4> 4</a>
</span><span class=lnt id=hl-297-5><a class=lnlinks href=#hl-297-5> 5</a>
</span><span class=lnt id=hl-297-6><a class=lnlinks href=#hl-297-6> 6</a>
</span><span class=lnt id=hl-297-7><a class=lnlinks href=#hl-297-7> 7</a>
</span><span class=lnt id=hl-297-8><a class=lnlinks href=#hl-297-8> 8</a>
</span><span class=lnt id=hl-297-9><a class=lnlinks href=#hl-297-9> 9</a>
</span><span class=lnt id=hl-297-10><a class=lnlinks href=#hl-297-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph TD
</span></span><span class=line><span class=cl>s(ä¿æ´é˜¿å§¨)
</span></span><span class=line><span class=cl>m(ä¸»äºº)
</span></span><span class=line><span class=cl>g1(åƒåœ¾è¢‹)
</span></span><span class=line><span class=cl>g2(æ–°åƒåœ¾è¢‹)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>s -. å€’ç©º .-&gt; g1
</span></span><span class=line><span class=cl>m -- æ£€æŸ¥ --&gt; g1
</span></span><span class=line><span class=cl>g1 -- å·²æ»¡ --&gt; g2
</span></span><span class=line><span class=cl>g1 -- è¿˜ç©º --&gt; g1
</span></span></code></pre></td></tr></table></div></div><p><strong>AtomicMarkableReference</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-298-1><a class=lnlinks href=#hl-298-1> 1</a>
</span><span class=lnt id=hl-298-2><a class=lnlinks href=#hl-298-2> 2</a>
</span><span class=lnt id=hl-298-3><a class=lnlinks href=#hl-298-3> 3</a>
</span><span class=lnt id=hl-298-4><a class=lnlinks href=#hl-298-4> 4</a>
</span><span class=lnt id=hl-298-5><a class=lnlinks href=#hl-298-5> 5</a>
</span><span class=lnt id=hl-298-6><a class=lnlinks href=#hl-298-6> 6</a>
</span><span class=lnt id=hl-298-7><a class=lnlinks href=#hl-298-7> 7</a>
</span><span class=lnt id=hl-298-8><a class=lnlinks href=#hl-298-8> 8</a>
</span><span class=lnt id=hl-298-9><a class=lnlinks href=#hl-298-9> 9</a>
</span><span class=lnt id=hl-298-10><a class=lnlinks href=#hl-298-10>10</a>
</span><span class=lnt id=hl-298-11><a class=lnlinks href=#hl-298-11>11</a>
</span><span class=lnt id=hl-298-12><a class=lnlinks href=#hl-298-12>12</a>
</span><span class=lnt id=hl-298-13><a class=lnlinks href=#hl-298-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>GarbageBag</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>desc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>GarbageBag</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>desc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>desc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setDesc</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>desc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>desc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>desc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>desc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-299-1><a class=lnlinks href=#hl-299-1> 1</a>
</span><span class=lnt id=hl-299-2><a class=lnlinks href=#hl-299-2> 2</a>
</span><span class=lnt id=hl-299-3><a class=lnlinks href=#hl-299-3> 3</a>
</span><span class=lnt id=hl-299-4><a class=lnlinks href=#hl-299-4> 4</a>
</span><span class=lnt id=hl-299-5><a class=lnlinks href=#hl-299-5> 5</a>
</span><span class=lnt id=hl-299-6><a class=lnlinks href=#hl-299-6> 6</a>
</span><span class=lnt id=hl-299-7><a class=lnlinks href=#hl-299-7> 7</a>
</span><span class=lnt id=hl-299-8><a class=lnlinks href=#hl-299-8> 8</a>
</span><span class=lnt id=hl-299-9><a class=lnlinks href=#hl-299-9> 9</a>
</span><span class=lnt id=hl-299-10><a class=lnlinks href=#hl-299-10>10</a>
</span><span class=lnt id=hl-299-11><a class=lnlinks href=#hl-299-11>11</a>
</span><span class=lnt id=hl-299-12><a class=lnlinks href=#hl-299-12>12</a>
</span><span class=lnt id=hl-299-13><a class=lnlinks href=#hl-299-13>13</a>
</span><span class=lnt id=hl-299-14><a class=lnlinks href=#hl-299-14>14</a>
</span><span class=lnt id=hl-299-15><a class=lnlinks href=#hl-299-15>15</a>
</span><span class=lnt id=hl-299-16><a class=lnlinks href=#hl-299-16>16</a>
</span><span class=lnt id=hl-299-17><a class=lnlinks href=#hl-299-17>17</a>
</span><span class=lnt id=hl-299-18><a class=lnlinks href=#hl-299-18>18</a>
</span><span class=lnt id=hl-299-19><a class=lnlinks href=#hl-299-19>19</a>
</span><span class=lnt id=hl-299-20><a class=lnlinks href=#hl-299-20>20</a>
</span><span class=lnt id=hl-299-21><a class=lnlinks href=#hl-299-21>21</a>
</span><span class=lnt id=hl-299-22><a class=lnlinks href=#hl-299-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestABAAtomicMarkableReference</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GarbageBag</span><span class=w> </span><span class=n>bag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GarbageBag</span><span class=p>(</span><span class=s>&#34;è£…æ»¡äº†åƒåœ¾&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å‚æ•°2 mark å¯ä»¥çœ‹ä½œä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºåƒåœ¾è¢‹æ»¡äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AtomicMarkableReference</span><span class=o>&lt;</span><span class=n>GarbageBag</span><span class=o>&gt;</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicMarkableReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>bag</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ä¸»çº¿ç¨‹ start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GarbageBag</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getReference</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>prev</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‰“æ‰«å«ç”Ÿçš„çº¿ç¨‹ start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bag</span><span class=p>.</span><span class=na>setDesc</span><span class=p>(</span><span class=s>&#34;ç©ºåƒåœ¾è¢‹&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>bag</span><span class=p>,</span><span class=w> </span><span class=n>bag</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>))</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>bag</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ä¸»çº¿ç¨‹æƒ³æ¢ä¸€åªæ–°åƒåœ¾è¢‹ï¼Ÿ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>success</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GarbageBag</span><span class=p>(</span><span class=s>&#34;ç©ºåƒåœ¾è¢‹&#34;</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ¢äº†ä¹ˆï¼Ÿ&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>success</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>getReference</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-300-1><a class=lnlinks href=#hl-300-1>1</a>
</span><span class=lnt id=hl-300-2><a class=lnlinks href=#hl-300-2>2</a>
</span><span class=lnt id=hl-300-3><a class=lnlinks href=#hl-300-3>3</a>
</span><span class=lnt id=hl-300-4><a class=lnlinks href=#hl-300-4>4</a>
</span><span class=lnt id=hl-300-5><a class=lnlinks href=#hl-300-5>5</a>
</span><span class=lnt id=hl-300-6><a class=lnlinks href=#hl-300-6>6</a>
</span><span class=lnt id=hl-300-7><a class=lnlinks href=#hl-300-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>2019-10-13 15:30:09.264 <span class=o>[</span>main<span class=o>]</span> ä¸»çº¿ç¨‹ start... 
</span></span><span class=line><span class=cl>2019-10-13 15:30:09.270 <span class=o>[</span>main<span class=o>]</span> cn.itcast.GarbageBag@5f0fd5a0 è£…æ»¡äº†åƒåœ¾
</span></span><span class=line><span class=cl>2019-10-13 15:30:09.293 <span class=o>[</span>Thread-1<span class=o>]</span> æ‰“æ‰«å«ç”Ÿçš„çº¿ç¨‹ start... 
</span></span><span class=line><span class=cl>2019-10-13 15:30:09.294 <span class=o>[</span>Thread-1<span class=o>]</span> cn.itcast.GarbageBag@5f0fd5a0 ç©ºåƒåœ¾è¢‹
</span></span><span class=line><span class=cl>2019-10-13 15:30:10.294 <span class=o>[</span>main<span class=o>]</span> ä¸»çº¿ç¨‹æƒ³æ¢ä¸€åªæ–°åƒåœ¾è¢‹ï¼Ÿ
</span></span><span class=line><span class=cl>2019-10-13 15:30:10.294 <span class=o>[</span>main<span class=o>]</span> æ¢äº†ä¹ˆï¼Ÿfalse 
</span></span><span class=line><span class=cl>2019-10-13 15:30:10.294 <span class=o>[</span>main<span class=o>]</span> cn.itcast.GarbageBag@5f0fd5a0 ç©ºåƒåœ¾è¢‹
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥æ³¨é‡Šæ‰æ‰“æ‰«å«ç”Ÿçº¿ç¨‹ä»£ç ï¼Œå†è§‚å¯Ÿè¾“å‡º</p><h2 id=65-åŸå­æ•°ç»„><a href=#65-%e5%8e%9f%e5%ad%90%e6%95%b0%e7%bb%84 class=header-anchor>#</a>
6.5 åŸå­æ•°ç»„</h2><ul><li>AtomicIntegerArray</li><li>AtomicLongArray</li><li>AtomicReferenceArray</li></ul><p>æœ‰å¦‚ä¸‹æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-301-1><a class=lnlinks href=#hl-301-1> 1</a>
</span><span class=lnt id=hl-301-2><a class=lnlinks href=#hl-301-2> 2</a>
</span><span class=lnt id=hl-301-3><a class=lnlinks href=#hl-301-3> 3</a>
</span><span class=lnt id=hl-301-4><a class=lnlinks href=#hl-301-4> 4</a>
</span><span class=lnt id=hl-301-5><a class=lnlinks href=#hl-301-5> 5</a>
</span><span class=lnt id=hl-301-6><a class=lnlinks href=#hl-301-6> 6</a>
</span><span class=lnt id=hl-301-7><a class=lnlinks href=#hl-301-7> 7</a>
</span><span class=lnt id=hl-301-8><a class=lnlinks href=#hl-301-8> 8</a>
</span><span class=lnt id=hl-301-9><a class=lnlinks href=#hl-301-9> 9</a>
</span><span class=lnt id=hl-301-10><a class=lnlinks href=#hl-301-10>10</a>
</span><span class=lnt id=hl-301-11><a class=lnlinks href=#hl-301-11>11</a>
</span><span class=lnt id=hl-301-12><a class=lnlinks href=#hl-301-12>12</a>
</span><span class=lnt id=hl-301-13><a class=lnlinks href=#hl-301-13>13</a>
</span><span class=lnt id=hl-301-14><a class=lnlinks href=#hl-301-14>14</a>
</span><span class=lnt id=hl-301-15><a class=lnlinks href=#hl-301-15>15</a>
</span><span class=lnt id=hl-301-16><a class=lnlinks href=#hl-301-16>16</a>
</span><span class=lnt id=hl-301-17><a class=lnlinks href=#hl-301-17>17</a>
</span><span class=lnt id=hl-301-18><a class=lnlinks href=#hl-301-18>18</a>
</span><span class=lnt id=hl-301-19><a class=lnlinks href=#hl-301-19>19</a>
</span><span class=lnt id=hl-301-20><a class=lnlinks href=#hl-301-20>20</a>
</span><span class=lnt id=hl-301-21><a class=lnlinks href=#hl-301-21>21</a>
</span><span class=lnt id=hl-301-22><a class=lnlinks href=#hl-301-22>22</a>
</span><span class=lnt id=hl-301-23><a class=lnlinks href=#hl-301-23>23</a>
</span><span class=lnt id=hl-301-24><a class=lnlinks href=#hl-301-24>24</a>
</span><span class=lnt id=hl-301-25><a class=lnlinks href=#hl-301-25>25</a>
</span><span class=lnt id=hl-301-26><a class=lnlinks href=#hl-301-26>26</a>
</span><span class=lnt id=hl-301-27><a class=lnlinks href=#hl-301-27>27</a>
</span><span class=lnt id=hl-301-28><a class=lnlinks href=#hl-301-28>28</a>
</span><span class=lnt id=hl-301-29><a class=lnlinks href=#hl-301-29>29</a>
</span><span class=lnt id=hl-301-30><a class=lnlinks href=#hl-301-30>30</a>
</span><span class=lnt id=hl-301-31><a class=lnlinks href=#hl-301-31>31</a>
</span><span class=lnt id=hl-301-32><a class=lnlinks href=#hl-301-32>32</a>
</span><span class=lnt id=hl-301-33><a class=lnlinks href=#hl-301-33>33</a>
</span><span class=lnt id=hl-301-34><a class=lnlinks href=#hl-301-34>34</a>
</span><span class=lnt id=hl-301-35><a class=lnlinks href=#hl-301-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> å‚æ•°1ï¼Œæä¾›æ•°ç»„ã€å¯ä»¥æ˜¯çº¿ç¨‹ä¸å®‰å…¨æ•°ç»„æˆ–çº¿ç¨‹å®‰å…¨æ•°ç»„
</span></span></span><span class=line><span class=cl><span class=cm> å‚æ•°2ï¼Œè·å–æ•°ç»„é•¿åº¦çš„æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=cm> å‚æ•°3ï¼Œè‡ªå¢æ–¹æ³•ï¼Œå›ä¼  array, index
</span></span></span><span class=line><span class=cl><span class=cm> å‚æ•°4ï¼Œæ‰“å°æ•°ç»„çš„æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// supplier æä¾›è€… æ— ä¸­ç”Ÿæœ‰ ()-&gt;ç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// function å‡½æ•° ä¸€ä¸ªå‚æ•°ä¸€ä¸ªç»“æœ (å‚æ•°)-&gt;ç»“æœ , BiFunction (å‚æ•°1,å‚æ•°2)-&gt;ç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// consumer æ¶ˆè´¹è€… ä¸€ä¸ªå‚æ•°æ²¡ç»“æœ (å‚æ•°)-&gt;void, BiConsumer (å‚æ•°1,å‚æ•°2)-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>arraySupplier</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Function</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>lengthFun</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BiConsumer</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>putConsumer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Consumer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>printConsumer</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>T</span><span class=w> </span><span class=n>array</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arraySupplier</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lengthFun</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>array</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ¯ä¸ªçº¿ç¨‹å¯¹æ•°ç»„ä½œ 10000 æ¬¡æ“ä½œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10000</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>putConsumer</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>array</span><span class=p>,</span><span class=w> </span><span class=n>j</span><span class=o>%</span><span class=n>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>());</span><span class=w> </span><span class=c1>// å¯åŠ¨æ‰€æœ‰çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w> </span><span class=c1>// ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>printConsumer</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>array</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>ä¸å®‰å…¨çš„æ•°ç»„</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-302-1><a class=lnlinks href=#hl-302-1>1</a>
</span><span class=lnt id=hl-302-2><a class=lnlinks href=#hl-302-2>2</a>
</span><span class=lnt id=hl-302-3><a class=lnlinks href=#hl-302-3>3</a>
</span><span class=lnt id=hl-302-4><a class=lnlinks href=#hl-302-4>4</a>
</span><span class=lnt id=hl-302-5><a class=lnlinks href=#hl-302-5>5</a>
</span><span class=lnt id=hl-302-6><a class=lnlinks href=#hl-302-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>()</span><span class=o>-&gt;</span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>10</span><span class=o>]</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>array</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>array</span><span class=p>.</span><span class=na>length</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>array</span><span class=p>,</span><span class=w> </span><span class=n>index</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>array</span><span class=o>[</span><span class=n>index</span><span class=o>]++</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>array</span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>array</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-303-1><a class=lnlinks href=#hl-303-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>9870, 9862, 9774, 9697, 9683, 9678, 9679, 9668, 9680, 9698<span class=o>]</span> 
</span></span></code></pre></td></tr></table></div></div><p><strong>å®‰å…¨çš„æ•°ç»„</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-304-1><a class=lnlinks href=#hl-304-1>1</a>
</span><span class=lnt id=hl-304-2><a class=lnlinks href=#hl-304-2>2</a>
</span><span class=lnt id=hl-304-3><a class=lnlinks href=#hl-304-3>3</a>
</span><span class=lnt id=hl-304-4><a class=lnlinks href=#hl-304-4>4</a>
</span><span class=lnt id=hl-304-5><a class=lnlinks href=#hl-304-5>5</a>
</span><span class=lnt id=hl-304-6><a class=lnlinks href=#hl-304-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>()</span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicIntegerArray</span><span class=p>(</span><span class=n>10</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>array</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>array</span><span class=p>.</span><span class=na>length</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>array</span><span class=p>,</span><span class=w> </span><span class=n>index</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>array</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>(</span><span class=n>index</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>array</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>array</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-305-1><a class=lnlinks href=#hl-305-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000<span class=o>]</span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=66-å­—æ®µæ›´æ–°å™¨><a href=#66-%e5%ad%97%e6%ae%b5%e6%9b%b4%e6%96%b0%e5%99%a8 class=header-anchor>#</a>
6.6 å­—æ®µæ›´æ–°å™¨</h2><ul><li>AtomicReferenceFieldUpdater // åŸŸ å­—æ®µ</li><li>AtomicIntegerFieldUpdater</li><li>AtomicLongFieldUpdater åˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆ volatile ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç° å¼‚å¸¸</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-306-1><a class=lnlinks href=#hl-306-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Exception in thread <span class=s2>&#34;main&#34;</span> java.lang.IllegalArgumentException: Must be volatile <span class=nb>type</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-307-1><a class=lnlinks href=#hl-307-1> 1</a>
</span><span class=lnt id=hl-307-2><a class=lnlinks href=#hl-307-2> 2</a>
</span><span class=lnt id=hl-307-3><a class=lnlinks href=#hl-307-3> 3</a>
</span><span class=lnt id=hl-307-4><a class=lnlinks href=#hl-307-4> 4</a>
</span><span class=lnt id=hl-307-5><a class=lnlinks href=#hl-307-5> 5</a>
</span><span class=lnt id=hl-307-6><a class=lnlinks href=#hl-307-6> 6</a>
</span><span class=lnt id=hl-307-7><a class=lnlinks href=#hl-307-7> 7</a>
</span><span class=lnt id=hl-307-8><a class=lnlinks href=#hl-307-8> 8</a>
</span><span class=lnt id=hl-307-9><a class=lnlinks href=#hl-307-9> 9</a>
</span><span class=lnt id=hl-307-10><a class=lnlinks href=#hl-307-10>10</a>
</span><span class=lnt id=hl-307-11><a class=lnlinks href=#hl-307-11>11</a>
</span><span class=lnt id=hl-307-12><a class=lnlinks href=#hl-307-12>12</a>
</span><span class=lnt id=hl-307-13><a class=lnlinks href=#hl-307-13>13</a>
</span><span class=lnt id=hl-307-14><a class=lnlinks href=#hl-307-14>14</a>
</span><span class=lnt id=hl-307-15><a class=lnlinks href=#hl-307-15>15</a>
</span><span class=lnt id=hl-307-16><a class=lnlinks href=#hl-307-16>16</a>
</span><span class=lnt id=hl-307-17><a class=lnlinks href=#hl-307-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test5</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AtomicIntegerFieldUpdater</span><span class=w> </span><span class=n>fieldUpdater</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AtomicIntegerFieldUpdater</span><span class=p>.</span><span class=na>newUpdater</span><span class=p>(</span><span class=n>Test5</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=s>&#34;field&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Test5</span><span class=w> </span><span class=n>test5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Test5</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fieldUpdater</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>test5</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¿®æ”¹æˆåŠŸ field = 10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>test5</span><span class=p>.</span><span class=na>field</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¿®æ”¹æˆåŠŸ field = 20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fieldUpdater</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>test5</span><span class=p>,</span><span class=w> </span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>20</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>test5</span><span class=p>.</span><span class=na>field</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¿®æ”¹å¤±è´¥ field = 20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fieldUpdater</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>test5</span><span class=p>,</span><span class=w> </span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>30</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>test5</span><span class=p>.</span><span class=na>field</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-308-1><a class=lnlinks href=#hl-308-1>1</a>
</span><span class=lnt id=hl-308-2><a class=lnlinks href=#hl-308-2>2</a>
</span><span class=lnt id=hl-308-3><a class=lnlinks href=#hl-308-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>10</span> 
</span></span><span class=line><span class=cl><span class=m>20</span> 
</span></span><span class=line><span class=cl><span class=m>20</span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=67-åŸå­ç´¯åŠ å™¨><a href=#67-%e5%8e%9f%e5%ad%90%e7%b4%af%e5%8a%a0%e5%99%a8 class=header-anchor>#</a>
6.7 åŸå­ç´¯åŠ å™¨</h2><h4 id=ç´¯åŠ å™¨æ€§èƒ½æ¯”è¾ƒ><a href=#%e7%b4%af%e5%8a%a0%e5%99%a8%e6%80%a7%e8%83%bd%e6%af%94%e8%be%83 class=header-anchor>#</a>
ç´¯åŠ å™¨æ€§èƒ½æ¯”è¾ƒ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-309-1><a class=lnlinks href=#hl-309-1> 1</a>
</span><span class=lnt id=hl-309-2><a class=lnlinks href=#hl-309-2> 2</a>
</span><span class=lnt id=hl-309-3><a class=lnlinks href=#hl-309-3> 3</a>
</span><span class=lnt id=hl-309-4><a class=lnlinks href=#hl-309-4> 4</a>
</span><span class=lnt id=hl-309-5><a class=lnlinks href=#hl-309-5> 5</a>
</span><span class=lnt id=hl-309-6><a class=lnlinks href=#hl-309-6> 6</a>
</span><span class=lnt id=hl-309-7><a class=lnlinks href=#hl-309-7> 7</a>
</span><span class=lnt id=hl-309-8><a class=lnlinks href=#hl-309-8> 8</a>
</span><span class=lnt id=hl-309-9><a class=lnlinks href=#hl-309-9> 9</a>
</span><span class=lnt id=hl-309-10><a class=lnlinks href=#hl-309-10>10</a>
</span><span class=lnt id=hl-309-11><a class=lnlinks href=#hl-309-11>11</a>
</span><span class=lnt id=hl-309-12><a class=lnlinks href=#hl-309-12>12</a>
</span><span class=lnt id=hl-309-13><a class=lnlinks href=#hl-309-13>13</a>
</span><span class=lnt id=hl-309-14><a class=lnlinks href=#hl-309-14>14</a>
</span><span class=lnt id=hl-309-15><a class=lnlinks href=#hl-309-15>15</a>
</span><span class=lnt id=hl-309-16><a class=lnlinks href=#hl-309-16>16</a>
</span><span class=lnt id=hl-309-17><a class=lnlinks href=#hl-309-17>17</a>
</span><span class=lnt id=hl-309-18><a class=lnlinks href=#hl-309-18>18</a>
</span><span class=lnt id=hl-309-19><a class=lnlinks href=#hl-309-19>19</a>
</span><span class=lnt id=hl-309-20><a class=lnlinks href=#hl-309-20>20</a>
</span><span class=lnt id=hl-309-21><a class=lnlinks href=#hl-309-21>21</a>
</span><span class=lnt id=hl-309-22><a class=lnlinks href=#hl-309-22>22</a>
</span><span class=lnt id=hl-309-23><a class=lnlinks href=#hl-309-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo</span><span class=p>(</span><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>adderSupplier</span><span class=p>,</span><span class=w> </span><span class=n>Consumer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>action</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>T</span><span class=w> </span><span class=n>adder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adderSupplier</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 4 ä¸ªçº¿ç¨‹ï¼Œæ¯äººç´¯åŠ  50 ä¸‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>40</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>500000</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>action</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>adder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ts</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>adder</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; cost:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=p>)</span><span class=o>/</span><span class=n>1000_000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ¯”è¾ƒ AtomicLong ä¸ LongAdder</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-310-1><a class=lnlinks href=#hl-310-1>1</a>
</span><span class=lnt id=hl-310-2><a class=lnlinks href=#hl-310-2>2</a>
</span><span class=lnt id=hl-310-3><a class=lnlinks href=#hl-310-3>3</a>
</span><span class=lnt id=hl-310-4><a class=lnlinks href=#hl-310-4>4</a>
</span><span class=lnt id=hl-310-5><a class=lnlinks href=#hl-310-5>5</a>
</span><span class=lnt id=hl-310-6><a class=lnlinks href=#hl-310-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>demo</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LongAdder</span><span class=p>(),</span><span class=w> </span><span class=n>adder</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>adder</span><span class=p>.</span><span class=na>increment</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>demo</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicLong</span><span class=p>(),</span><span class=w> </span><span class=n>adder</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>adder</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-311-1><a class=lnlinks href=#hl-311-1> 1</a>
</span><span class=lnt id=hl-311-2><a class=lnlinks href=#hl-311-2> 2</a>
</span><span class=lnt id=hl-311-3><a class=lnlinks href=#hl-311-3> 3</a>
</span><span class=lnt id=hl-311-4><a class=lnlinks href=#hl-311-4> 4</a>
</span><span class=lnt id=hl-311-5><a class=lnlinks href=#hl-311-5> 5</a>
</span><span class=lnt id=hl-311-6><a class=lnlinks href=#hl-311-6> 6</a>
</span><span class=lnt id=hl-311-7><a class=lnlinks href=#hl-311-7> 7</a>
</span><span class=lnt id=hl-311-8><a class=lnlinks href=#hl-311-8> 8</a>
</span><span class=lnt id=hl-311-9><a class=lnlinks href=#hl-311-9> 9</a>
</span><span class=lnt id=hl-311-10><a class=lnlinks href=#hl-311-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>1000000</span> cost:43 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:9 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:7 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:7 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:7 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:31 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:27 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:28 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:24 
</span></span><span class=line><span class=cl><span class=m>1000000</span> cost:22 
</span></span></code></pre></td></tr></table></div></div><p>æ€§èƒ½æå‡çš„åŸå› å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æœ‰ç«äº‰æ—¶ï¼Œè®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒï¼ŒTherad-0 ç´¯åŠ  Cell[0]ï¼Œè€Œ Thread-1 ç´¯åŠ  Cell[1]&mldr; æœ€åå°†ç»“æœæ±‡æ€»ã€‚è¿™æ ·å®ƒä»¬åœ¨ç´¯åŠ æ—¶æ“ä½œçš„ä¸åŒçš„ Cell å˜é‡ï¼Œå› æ­¤å‡å°‘äº† CAS é‡è¯•å¤±è´¥ï¼Œä»è€Œæé«˜æ€§ èƒ½ã€‚</p><h4 id=font-colorblue-åŸç†ä¹‹ä¼ªå…±äº«cpu-ç¼“å­˜ç»“æ„font><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b%e4%bc%aa%e5%85%b1%e4%ba%abcpu-%e7%bc%93%e5%ad%98%e7%bb%93%e6%9e%84font class=header-anchor>#</a>
<font color=blue>* åŸç†ä¹‹ä¼ªå…±äº«(CPU ç¼“å­˜ç»“æ„)</font></h4><h5 id=cpu-ç¼“å­˜ç»“æ„><a href=#cpu-%e7%bc%93%e5%ad%98%e7%bb%93%e6%9e%84 class=header-anchor>#</a>
<strong>CPU ç¼“å­˜ç»“æ„</strong></h5><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317203911517.png width=900 height=600 loading=lazy decoding=async alt=image-20220317203911517 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æŸ¥çœ‹ cpu ç¼“å­˜</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-312-1><a class=lnlinks href=#hl-312-1> 1</a>
</span><span class=lnt id=hl-312-2><a class=lnlinks href=#hl-312-2> 2</a>
</span><span class=lnt id=hl-312-3><a class=lnlinks href=#hl-312-3> 3</a>
</span><span class=lnt id=hl-312-4><a class=lnlinks href=#hl-312-4> 4</a>
</span><span class=lnt id=hl-312-5><a class=lnlinks href=#hl-312-5> 5</a>
</span><span class=lnt id=hl-312-6><a class=lnlinks href=#hl-312-6> 6</a>
</span><span class=lnt id=hl-312-7><a class=lnlinks href=#hl-312-7> 7</a>
</span><span class=lnt id=hl-312-8><a class=lnlinks href=#hl-312-8> 8</a>
</span><span class=lnt id=hl-312-9><a class=lnlinks href=#hl-312-9> 9</a>
</span><span class=lnt id=hl-312-10><a class=lnlinks href=#hl-312-10>10</a>
</span><span class=lnt id=hl-312-11><a class=lnlinks href=#hl-312-11>11</a>
</span><span class=lnt id=hl-312-12><a class=lnlinks href=#hl-312-12>12</a>
</span><span class=lnt id=hl-312-13><a class=lnlinks href=#hl-312-13>13</a>
</span><span class=lnt id=hl-312-14><a class=lnlinks href=#hl-312-14>14</a>
</span><span class=lnt id=hl-312-15><a class=lnlinks href=#hl-312-15>15</a>
</span><span class=lnt id=hl-312-16><a class=lnlinks href=#hl-312-16>16</a>
</span><span class=lnt id=hl-312-17><a class=lnlinks href=#hl-312-17>17</a>
</span><span class=lnt id=hl-312-18><a class=lnlinks href=#hl-312-18>18</a>
</span><span class=lnt id=hl-312-19><a class=lnlinks href=#hl-312-19>19</a>
</span><span class=lnt id=hl-312-20><a class=lnlinks href=#hl-312-20>20</a>
</span><span class=lnt id=hl-312-21><a class=lnlinks href=#hl-312-21>21</a>
</span><span class=lnt id=hl-312-22><a class=lnlinks href=#hl-312-22>22</a>
</span><span class=lnt id=hl-312-23><a class=lnlinks href=#hl-312-23>23</a>
</span><span class=lnt id=hl-312-24><a class=lnlinks href=#hl-312-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>âš¡ root@yihang01 ~ lscpu
</span></span><span class=line><span class=cl>Architecture: x86_64
</span></span><span class=line><span class=cl>CPU op-mode<span class=o>(</span>s<span class=o>)</span>: 32-bit, 64-bit
</span></span><span class=line><span class=cl>Byte Order: Little Endian
</span></span><span class=line><span class=cl>CPU<span class=o>(</span>s<span class=o>)</span>: <span class=m>1</span>
</span></span><span class=line><span class=cl>On-line CPU<span class=o>(</span>s<span class=o>)</span> list: <span class=m>0</span>
</span></span><span class=line><span class=cl>Thread<span class=o>(</span>s<span class=o>)</span> per core: <span class=m>1</span>
</span></span><span class=line><span class=cl>Core<span class=o>(</span>s<span class=o>)</span> per socket: <span class=m>1</span>
</span></span><span class=line><span class=cl>Socket<span class=o>(</span>s<span class=o>)</span>: <span class=m>1</span>
</span></span><span class=line><span class=cl>NUMA node<span class=o>(</span>s<span class=o>)</span>: <span class=m>1</span>
</span></span><span class=line><span class=cl>Vendor ID: GenuineIntel
</span></span><span class=line><span class=cl>CPU family: <span class=m>6</span>
</span></span><span class=line><span class=cl>Model: <span class=m>142</span>
</span></span><span class=line><span class=cl>Model name: Intel<span class=o>(</span>R<span class=o>)</span> Core<span class=o>(</span>TM<span class=o>)</span> i7-8565U CPU @ 1.80GHz
</span></span><span class=line><span class=cl>Stepping: <span class=m>11</span>
</span></span><span class=line><span class=cl>CPU MHz: 1992.002
</span></span><span class=line><span class=cl>BogoMIPS: 3984.00
</span></span><span class=line><span class=cl>Hypervisor vendor: VMware
</span></span><span class=line><span class=cl>Virtualization type: full
</span></span><span class=line><span class=cl>L1d cache: 32K
</span></span><span class=line><span class=cl>L1i cache: 32K
</span></span><span class=line><span class=cl>L2 cache: 256K
</span></span><span class=line><span class=cl>L3 cache: 8192K
</span></span><span class=line><span class=cl>NUMA node0 CPU<span class=o>(</span>s<span class=o>)</span>: <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>é€Ÿåº¦æ¯”è¾ƒ</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>ä»cpuåˆ°</th><th style=text-align:center>å¤§çº¦éœ€è¦çš„æ—¶é’Ÿå‘¨æœŸ</th></tr></thead><tbody><tr><td style=text-align:center>å¯„å­˜å™¨</td><td style=text-align:center>1 cycle</td></tr><tr><td style=text-align:center>L1</td><td style=text-align:center>3~4 cycle</td></tr><tr><td style=text-align:center>L2</td><td style=text-align:center>10~20 cycle</td></tr><tr><td style=text-align:center>L3</td><td style=text-align:center>40~45 cycle</td></tr><tr><td style=text-align:center>å†…å­˜</td><td style=text-align:center>120~240 cycle</td></tr></tbody></table></div><p>æŸ¥çœ‹ cpu ç¼“å­˜è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-313-1><a class=lnlinks href=#hl-313-1>1</a>
</span><span class=lnt id=hl-313-2><a class=lnlinks href=#hl-313-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>âš¡ root@yihang01 ~ cat /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size
</span></span><span class=line><span class=cl><span class=m>64</span>
</span></span></code></pre></td></tr></table></div></div><p>cpu æ‹¿åˆ°çš„å†…å­˜åœ°å€æ ¼å¼æ˜¯è¿™æ ·çš„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-314-1><a class=lnlinks href=#hl-314-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>é«˜ä½ç»„æ ‡è®°<span class=o>][</span>ä½ä½ç´¢å¼•<span class=o>][</span>åç§»é‡<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317204208269.png width=900 height=600 loading=lazy decoding=async alt=image-20220317204208269 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=cpu-ç¼“å­˜è¯»><a href=#cpu-%e7%bc%93%e5%ad%98%e8%af%bb class=header-anchor>#</a>
<strong>CPU ç¼“å­˜è¯»</strong></h5><p>è¯»å–æ•°æ®æµç¨‹å¦‚ä¸‹</p><ul><li>æ ¹æ®ä½ä½ï¼Œè®¡ç®—åœ¨ç¼“å­˜ä¸­çš„ç´¢å¼•</li><li>åˆ¤æ–­æ˜¯å¦æœ‰æ•ˆ<ul><li>0 å»å†…å­˜è¯»å–æ–°æ•°æ®æ›´æ–°ç¼“å­˜è¡Œ</li><li>1 å†å¯¹æ¯”é«˜ä½ç»„æ ‡è®°æ˜¯å¦ä¸€è‡´<ul><li>ä¸€è‡´ï¼Œæ ¹æ®åç§»é‡è¿”å›ç¼“å­˜æ•°æ®</li><li>ä¸ä¸€è‡´ï¼Œå»å†…å­˜è¯»å–æ–°æ•°æ®æ›´æ–°ç¼“å­˜è¡Œ</li></ul></li></ul></li></ul><h5 id=cpu-ç¼“å­˜ä¸€è‡´æ€§><a href=#cpu-%e7%bc%93%e5%ad%98%e4%b8%80%e8%87%b4%e6%80%a7 class=header-anchor>#</a>
<strong>CPU ç¼“å­˜ä¸€è‡´æ€§</strong></h5><p>MESI åè®®</p><ol><li>Eã€Sã€M çŠ¶æ€çš„ç¼“å­˜è¡Œéƒ½å¯ä»¥æ»¡è¶³ CPU çš„è¯»è¯·æ±‚</li><li>E çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œæœ‰å†™è¯·æ±‚ï¼Œä¼šå°†çŠ¶æ€æ”¹ä¸º Mï¼Œè¿™æ—¶å¹¶ä¸è§¦å‘å‘ä¸»å­˜çš„å†™</li><li>E çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¿…é¡»ç›‘å¬è¯¥ç¼“å­˜è¡Œçš„è¯»æ“ä½œï¼Œå¦‚æœæœ‰ï¼Œè¦å˜ä¸º S çŠ¶æ€</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317204411550.png width=900 height=600 loading=lazy decoding=async alt=image-20220317204411550 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><pre><code>4. M çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¿…é¡»ç›‘å¬è¯¥ç¼“å­˜è¡Œçš„è¯»æ“ä½œï¼Œå¦‚æœæœ‰ï¼Œå…ˆå°†å…¶å®ƒç¼“å­˜ï¼ˆS çŠ¶æ€ï¼‰ä¸­è¯¥ç¼“å­˜è¡Œå˜æˆ I çŠ¶æ€ï¼ˆå³ 6. çš„æµç¨‹ï¼‰ï¼Œå†™å…¥ä¸»å­˜ï¼Œè‡ªå·±å˜ä¸º S çŠ¶æ€ 
5. S çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œæœ‰å†™è¯·æ±‚ï¼Œèµ° 4. çš„æµç¨‹ 
6. S çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œå¿…é¡»ç›‘å¬è¯¥ç¼“å­˜è¡Œçš„å¤±æ•ˆæ“ä½œï¼Œå¦‚æœæœ‰ï¼Œè‡ªå·±å˜ä¸º I çŠ¶æ€ 
7. I çŠ¶æ€çš„ç¼“å­˜è¡Œï¼Œæœ‰è¯»è¯·æ±‚ï¼Œå¿…é¡»ä»ä¸»å­˜è¯»å–
</code></pre><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317204507325.png width=900 height=600 loading=lazy decoding=async alt=image-20220317204507325 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=å†…å­˜å±éšœ><a href=#%e5%86%85%e5%ad%98%e5%b1%8f%e9%9a%9c class=header-anchor>#</a>
<strong>å†…å­˜å±éšœ</strong></h5><p>Memory Barrierï¼ˆMemory Fenceï¼‰</p><p>å¯è§æ€§</p><ul><li>å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</li><li>è€Œè¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</li></ul><p>æœ‰åºæ€§</p><ul><li>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</li><li>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317204610541.png width=900 height=600 loading=lazy decoding=async alt=image-20220317204610541 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=font-colorblue-æºç ä¹‹-longadderfont><a href=#font-colorblue-%e6%ba%90%e7%a0%81%e4%b9%8b-longadderfont class=header-anchor>#</a>
<font color=blue>* æºç ä¹‹ LongAdder</font></h4><p>LongAdder æ˜¯å¹¶å‘å¤§å¸ˆ @author Doug Lea ï¼ˆå¤§å“¥æï¼‰çš„ä½œå“ï¼Œè®¾è®¡çš„éå¸¸ç²¾å·§</p><p>LongAdder ç±»æœ‰å‡ ä¸ªå…³é”®åŸŸ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-315-1><a class=lnlinks href=#hl-315-1>1</a>
</span><span class=lnt id=hl-315-2><a class=lnlinks href=#hl-315-2>2</a>
</span><span class=lnt id=hl-315-3><a class=lnlinks href=#hl-315-3>3</a>
</span><span class=lnt id=hl-315-4><a class=lnlinks href=#hl-315-4>4</a>
</span><span class=lnt id=hl-315-5><a class=lnlinks href=#hl-315-5>5</a>
</span><span class=lnt id=hl-315-6><a class=lnlinks href=#hl-315-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ç´¯åŠ å•å…ƒæ•°ç»„, æ‡’æƒ°åˆå§‹åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>cells</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// åŸºç¡€å€¼, å¦‚æœæ²¡æœ‰ç«äº‰, åˆ™ç”¨ cas ç´¯åŠ è¿™ä¸ªåŸŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>base</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// åœ¨ cells åˆ›å»ºæˆ–æ‰©å®¹æ—¶, ç½®ä¸º 1, è¡¨ç¤ºåŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>cellsBusy</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ Cell å³ä¸ºç´¯åŠ å•å…ƒ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-316-1><a class=lnlinks href=#hl-316-1> 1</a>
</span><span class=lnt id=hl-316-2><a class=lnlinks href=#hl-316-2> 2</a>
</span><span class=lnt id=hl-316-3><a class=lnlinks href=#hl-316-3> 3</a>
</span><span class=lnt id=hl-316-4><a class=lnlinks href=#hl-316-4> 4</a>
</span><span class=lnt id=hl-316-5><a class=lnlinks href=#hl-316-5> 5</a>
</span><span class=lnt id=hl-316-6><a class=lnlinks href=#hl-316-6> 6</a>
</span><span class=lnt id=hl-316-7><a class=lnlinks href=#hl-316-7> 7</a>
</span><span class=lnt id=hl-316-8><a class=lnlinks href=#hl-316-8> 8</a>
</span><span class=lnt id=hl-316-9><a class=lnlinks href=#hl-316-9> 9</a>
</span><span class=lnt id=hl-316-10><a class=lnlinks href=#hl-316-10>10</a>
</span><span class=lnt id=hl-316-11><a class=lnlinks href=#hl-316-11>11</a>
</span><span class=lnt id=hl-316-12><a class=lnlinks href=#hl-316-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// é˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@sun.misc.Contended</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Cell</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Cell</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æœ€é‡è¦çš„æ–¹æ³•, ç”¨æ¥ cas æ–¹å¼è¿›è¡Œç´¯åŠ , prev è¡¨ç¤ºæ—§å€¼, next è¡¨ç¤ºæ–°å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>cas</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>compareAndSwapLong</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>valueOffset</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// çœç•¥ä¸é‡è¦ä»£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¾—ä»ç¼“å­˜è¯´èµ·</p><p>ç¼“å­˜ä¸å†…å­˜çš„é€Ÿåº¦æ¯”è¾ƒ</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205054803.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205054803 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å› ä¸º CPU ä¸ å†…å­˜çš„é€Ÿåº¦å·®å¼‚å¾ˆå¤§ï¼Œéœ€è¦é é¢„è¯»æ•°æ®è‡³ç¼“å­˜æ¥æå‡æ•ˆç‡ã€‚</p><p>è€Œç¼“å­˜ä»¥ç¼“å­˜è¡Œä¸ºå•ä½ï¼Œæ¯ä¸ªç¼“å­˜è¡Œå¯¹åº”ç€ä¸€å—å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ 64 byteï¼ˆ8 ä¸ª longï¼‰</p><p>ç¼“å­˜çš„åŠ å…¥ä¼šé€ æˆæ•°æ®å‰¯æœ¬çš„äº§ç”Ÿï¼Œå³åŒä¸€ä»½æ•°æ®ä¼šç¼“å­˜åœ¨ä¸åŒæ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­</p><p>CPU è¦ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¦‚æœæŸä¸ª CPU æ ¸å¿ƒæ›´æ”¹äº†æ•°æ®ï¼Œå…¶å®ƒ CPU æ ¸å¿ƒå¯¹åº”çš„æ•´ä¸ªç¼“å­˜è¡Œå¿…é¡»å¤±æ•ˆ</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205206297.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205206297 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å› ä¸º Cell æ˜¯æ•°ç»„å½¢å¼ï¼Œåœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œä¸€ä¸ª Cell ä¸º 24 å­—èŠ‚ï¼ˆ16 å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ 8 å­—èŠ‚çš„ valueï¼‰ï¼Œå›  æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹ 2 ä¸ªçš„ Cell å¯¹è±¡ã€‚è¿™æ ·é—®é¢˜æ¥äº†ï¼š</p><ul><li>Core-0 è¦ä¿®æ”¹ Cell[0]</li><li>Core-1 è¦ä¿®æ”¹ Cell[1]</li></ul><p>æ— è®ºè°ä¿®æ”¹æˆåŠŸï¼Œéƒ½ä¼šå¯¼è‡´å¯¹æ–¹ Core çš„ç¼“å­˜è¡Œå¤±æ•ˆï¼Œæ¯”å¦‚Core-0 ä¸­<code>Cell[0]=6000, Cell[1]=8000</code>è¦ç´¯åŠ <code>Cell[0]=6001, Cell[1]=8000</code> ï¼Œè¿™æ—¶ä¼šè®© Core-1 çš„ç¼“å­˜è¡Œå¤±æ•ˆ</p><p>@sun.misc.Contended ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„åŸç†æ˜¯åœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„å‰åå„å¢åŠ  128 å­—èŠ‚å¤§å°çš„ paddingï¼Œä»è€Œè®© CPU å°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œï¼Œè¿™æ ·ï¼Œä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆ</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205321951.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205321951 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>ç´¯åŠ ä¸»è¦è°ƒç”¨ä¸‹é¢çš„æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-317-1><a class=lnlinks href=#hl-317-1> 1</a>
</span><span class=lnt id=hl-317-2><a class=lnlinks href=#hl-317-2> 2</a>
</span><span class=lnt id=hl-317-3><a class=lnlinks href=#hl-317-3> 3</a>
</span><span class=lnt id=hl-317-4><a class=lnlinks href=#hl-317-4> 4</a>
</span><span class=lnt id=hl-317-5><a class=lnlinks href=#hl-317-5> 5</a>
</span><span class=lnt id=hl-317-6><a class=lnlinks href=#hl-317-6> 6</a>
</span><span class=lnt id=hl-317-7><a class=lnlinks href=#hl-317-7> 7</a>
</span><span class=lnt id=hl-317-8><a class=lnlinks href=#hl-317-8> 8</a>
</span><span class=lnt id=hl-317-9><a class=lnlinks href=#hl-317-9> 9</a>
</span><span class=lnt id=hl-317-10><a class=lnlinks href=#hl-317-10>10</a>
</span><span class=lnt id=hl-317-11><a class=lnlinks href=#hl-317-11>11</a>
</span><span class=lnt id=hl-317-12><a class=lnlinks href=#hl-317-12>12</a>
</span><span class=lnt id=hl-317-13><a class=lnlinks href=#hl-317-13>13</a>
</span><span class=lnt id=hl-317-14><a class=lnlinks href=#hl-317-14>14</a>
</span><span class=lnt id=hl-317-15><a class=lnlinks href=#hl-317-15>15</a>
</span><span class=lnt id=hl-317-16><a class=lnlinks href=#hl-317-16>16</a>
</span><span class=lnt id=hl-317-17><a class=lnlinks href=#hl-317-17>17</a>
</span><span class=lnt id=hl-317-18><a class=lnlinks href=#hl-317-18>18</a>
</span><span class=lnt id=hl-317-19><a class=lnlinks href=#hl-317-19>19</a>
</span><span class=lnt id=hl-317-20><a class=lnlinks href=#hl-317-20>20</a>
</span><span class=lnt id=hl-317-21><a class=lnlinks href=#hl-317-21>21</a>
</span><span class=lnt id=hl-317-22><a class=lnlinks href=#hl-317-22>22</a>
</span><span class=lnt id=hl-317-23><a class=lnlinks href=#hl-317-23>23</a>
</span><span class=lnt id=hl-317-24><a class=lnlinks href=#hl-317-24>24</a>
</span><span class=lnt id=hl-317-25><a class=lnlinks href=#hl-317-25>25</a>
</span><span class=lnt id=hl-317-26><a class=lnlinks href=#hl-317-26>26</a>
</span><span class=lnt id=hl-317-27><a class=lnlinks href=#hl-317-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// as ä¸ºç´¯åŠ å•å…ƒæ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// b ä¸ºåŸºç¡€å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// x ä¸ºç´¯åŠ å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>as</span><span class=p>;</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>m</span><span class=p>;</span><span class=w> </span><span class=n>Cell</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿›å…¥ if çš„ä¸¤ä¸ªæ¡ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1. as æœ‰å€¼, è¡¨ç¤ºå·²ç»å‘ç”Ÿè¿‡ç«äº‰, è¿›å…¥ if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2. cas ç»™ base ç´¯åŠ æ—¶å¤±è´¥äº†, è¡¨ç¤º base å‘ç”Ÿäº†ç«äº‰, è¿›å…¥ if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cells</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>casBase</span><span class=p>(</span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>base</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// uncontended è¡¨ç¤º cell æ²¡æœ‰ç«äº‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>uncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// as è¿˜æ²¡æœ‰åˆ›å»º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>as</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å½“å‰çº¿ç¨‹å¯¹åº”çš„ cell è¿˜æ²¡æœ‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// getProbe()æ–¹æ³•è¿”å›çš„æ˜¯çº¿ç¨‹ä¸­çš„threadLocalRandomProbeå­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å®ƒæ˜¯é€šè¿‡éšæœºæ•°ç”Ÿæˆçš„ä¸€ä¸ªå€¼ï¼Œå¯¹äºä¸€ä¸ªç¡®å®šçš„çº¿ç¨‹è¿™ä¸ªå€¼æ˜¯å›ºå®šçš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// é™¤éåˆ»æ„ä¿®æ”¹å®ƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=o>[</span><span class=n>getProbe</span><span class=p>()</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>m</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// cas ç»™å½“å‰çº¿ç¨‹çš„ cell ç´¯åŠ å¤±è´¥ uncontended=false ( a ä¸ºå½“å‰çº¿ç¨‹çš„ cell )</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=p>(</span><span class=n>uncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>cas</span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>value</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è¿›å…¥ cell æ•°ç»„åˆ›å»ºã€cell åˆ›å»ºçš„æµç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>longAccumulate</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>uncontended</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“ ï¼š</p><ul><li>å¦‚æœå·²ç»<code>æœ‰äº†ç´¯åŠ æ•°ç»„</code>æˆ–<code>ç»™baseç´¯åŠ å‘ç”Ÿäº†ç«äº‰å¯¼è‡´å¤±è´¥</code><ul><li>å¦‚æœ<code>ç´¯åŠ æ•°ç»„æ²¡æœ‰åˆ›å»º</code>æˆ–è€…<code>ç´¯åŠ æ•°ç»„é•¿åº¦ä¸º1</code>æˆ–è€…<code>å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„cell</code>æˆ–è€…<code>ç´¯åŠ cellå¤±è´¥</code><ul><li>è¿›å…¥ç´¯åŠ æ•°ç»„çš„åˆ›å»ºæµç¨‹</li></ul></li><li>å¦è€…è¯´æ˜ç´¯åŠ æˆåŠŸï¼Œé€€å‡ºã€‚</li></ul></li><li>å¦åˆ™ç´¯åŠ æˆåŠŸ</li></ul><p>add æµç¨‹å›¾</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205409166.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205409166 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-318-1><a class=lnlinks href=#hl-318-1> 1</a>
</span><span class=lnt id=hl-318-2><a class=lnlinks href=#hl-318-2> 2</a>
</span><span class=lnt id=hl-318-3><a class=lnlinks href=#hl-318-3> 3</a>
</span><span class=lnt id=hl-318-4><a class=lnlinks href=#hl-318-4> 4</a>
</span><span class=lnt id=hl-318-5><a class=lnlinks href=#hl-318-5> 5</a>
</span><span class=lnt id=hl-318-6><a class=lnlinks href=#hl-318-6> 6</a>
</span><span class=lnt id=hl-318-7><a class=lnlinks href=#hl-318-7> 7</a>
</span><span class=lnt id=hl-318-8><a class=lnlinks href=#hl-318-8> 8</a>
</span><span class=lnt id=hl-318-9><a class=lnlinks href=#hl-318-9> 9</a>
</span><span class=lnt id=hl-318-10><a class=lnlinks href=#hl-318-10>10</a>
</span><span class=lnt id=hl-318-11><a class=lnlinks href=#hl-318-11>11</a>
</span><span class=lnt id=hl-318-12><a class=lnlinks href=#hl-318-12>12</a>
</span><span class=lnt id=hl-318-13><a class=lnlinks href=#hl-318-13>13</a>
</span><span class=lnt id=hl-318-14><a class=lnlinks href=#hl-318-14>14</a>
</span><span class=lnt id=hl-318-15><a class=lnlinks href=#hl-318-15>15</a>
</span><span class=lnt id=hl-318-16><a class=lnlinks href=#hl-318-16>16</a>
</span><span class=lnt id=hl-318-17><a class=lnlinks href=#hl-318-17>17</a>
</span><span class=lnt id=hl-318-18><a class=lnlinks href=#hl-318-18>18</a>
</span><span class=lnt id=hl-318-19><a class=lnlinks href=#hl-318-19>19</a>
</span><span class=lnt id=hl-318-20><a class=lnlinks href=#hl-318-20>20</a>
</span><span class=lnt id=hl-318-21><a class=lnlinks href=#hl-318-21>21</a>
</span><span class=lnt id=hl-318-22><a class=lnlinks href=#hl-318-22>22</a>
</span><span class=lnt id=hl-318-23><a class=lnlinks href=#hl-318-23>23</a>
</span><span class=lnt id=hl-318-24><a class=lnlinks href=#hl-318-24>24</a>
</span><span class=lnt id=hl-318-25><a class=lnlinks href=#hl-318-25>25</a>
</span><span class=lnt id=hl-318-26><a class=lnlinks href=#hl-318-26>26</a>
</span><span class=lnt id=hl-318-27><a class=lnlinks href=#hl-318-27>27</a>
</span><span class=lnt id=hl-318-28><a class=lnlinks href=#hl-318-28>28</a>
</span><span class=lnt id=hl-318-29><a class=lnlinks href=#hl-318-29>29</a>
</span><span class=lnt id=hl-318-30><a class=lnlinks href=#hl-318-30>30</a>
</span><span class=lnt id=hl-318-31><a class=lnlinks href=#hl-318-31>31</a>
</span><span class=lnt id=hl-318-32><a class=lnlinks href=#hl-318-32>32</a>
</span><span class=lnt id=hl-318-33><a class=lnlinks href=#hl-318-33>33</a>
</span><span class=lnt id=hl-318-34><a class=lnlinks href=#hl-318-34>34</a>
</span><span class=lnt id=hl-318-35><a class=lnlinks href=#hl-318-35>35</a>
</span><span class=lnt id=hl-318-36><a class=lnlinks href=#hl-318-36>36</a>
</span><span class=lnt id=hl-318-37><a class=lnlinks href=#hl-318-37>37</a>
</span><span class=lnt id=hl-318-38><a class=lnlinks href=#hl-318-38>38</a>
</span><span class=lnt id=hl-318-39><a class=lnlinks href=#hl-318-39>39</a>
</span><span class=lnt id=hl-318-40><a class=lnlinks href=#hl-318-40>40</a>
</span><span class=lnt id=hl-318-41><a class=lnlinks href=#hl-318-41>41</a>
</span><span class=lnt id=hl-318-42><a class=lnlinks href=#hl-318-42>42</a>
</span><span class=lnt id=hl-318-43><a class=lnlinks href=#hl-318-43>43</a>
</span><span class=lnt id=hl-318-44><a class=lnlinks href=#hl-318-44>44</a>
</span><span class=lnt id=hl-318-45><a class=lnlinks href=#hl-318-45>45</a>
</span><span class=lnt id=hl-318-46><a class=lnlinks href=#hl-318-46>46</a>
</span><span class=lnt id=hl-318-47><a class=lnlinks href=#hl-318-47>47</a>
</span><span class=lnt id=hl-318-48><a class=lnlinks href=#hl-318-48>48</a>
</span><span class=lnt id=hl-318-49><a class=lnlinks href=#hl-318-49>49</a>
</span><span class=lnt id=hl-318-50><a class=lnlinks href=#hl-318-50>50</a>
</span><span class=lnt id=hl-318-51><a class=lnlinks href=#hl-318-51>51</a>
</span><span class=lnt id=hl-318-52><a class=lnlinks href=#hl-318-52>52</a>
</span><span class=lnt id=hl-318-53><a class=lnlinks href=#hl-318-53>53</a>
</span><span class=lnt id=hl-318-54><a class=lnlinks href=#hl-318-54>54</a>
</span><span class=lnt id=hl-318-55><a class=lnlinks href=#hl-318-55>55</a>
</span><span class=lnt id=hl-318-56><a class=lnlinks href=#hl-318-56>56</a>
</span><span class=lnt id=hl-318-57><a class=lnlinks href=#hl-318-57>57</a>
</span><span class=lnt id=hl-318-58><a class=lnlinks href=#hl-318-58>58</a>
</span><span class=lnt id=hl-318-59><a class=lnlinks href=#hl-318-59>59</a>
</span><span class=lnt id=hl-318-60><a class=lnlinks href=#hl-318-60>60</a>
</span><span class=lnt id=hl-318-61><a class=lnlinks href=#hl-318-61>61</a>
</span><span class=lnt id=hl-318-62><a class=lnlinks href=#hl-318-62>62</a>
</span><span class=lnt id=hl-318-63><a class=lnlinks href=#hl-318-63>63</a>
</span><span class=lnt id=hl-318-64><a class=lnlinks href=#hl-318-64>64</a>
</span><span class=lnt id=hl-318-65><a class=lnlinks href=#hl-318-65>65</a>
</span><span class=lnt id=hl-318-66><a class=lnlinks href=#hl-318-66>66</a>
</span><span class=lnt id=hl-318-67><a class=lnlinks href=#hl-318-67>67</a>
</span><span class=lnt id=hl-318-68><a class=lnlinks href=#hl-318-68>68</a>
</span><span class=lnt id=hl-318-69><a class=lnlinks href=#hl-318-69>69</a>
</span><span class=lnt id=hl-318-70><a class=lnlinks href=#hl-318-70>70</a>
</span><span class=lnt id=hl-318-71><a class=lnlinks href=#hl-318-71>71</a>
</span><span class=lnt id=hl-318-72><a class=lnlinks href=#hl-318-72>72</a>
</span><span class=lnt id=hl-318-73><a class=lnlinks href=#hl-318-73>73</a>
</span><span class=lnt id=hl-318-74><a class=lnlinks href=#hl-318-74>74</a>
</span><span class=lnt id=hl-318-75><a class=lnlinks href=#hl-318-75>75</a>
</span><span class=lnt id=hl-318-76><a class=lnlinks href=#hl-318-76>76</a>
</span><span class=lnt id=hl-318-77><a class=lnlinks href=#hl-318-77>77</a>
</span><span class=lnt id=hl-318-78><a class=lnlinks href=#hl-318-78>78</a>
</span><span class=lnt id=hl-318-79><a class=lnlinks href=#hl-318-79>79</a>
</span><span class=lnt id=hl-318-80><a class=lnlinks href=#hl-318-80>80</a>
</span><span class=lnt id=hl-318-81><a class=lnlinks href=#hl-318-81>81</a>
</span><span class=lnt id=hl-318-82><a class=lnlinks href=#hl-318-82>82</a>
</span><span class=lnt id=hl-318-83><a class=lnlinks href=#hl-318-83>83</a>
</span><span class=lnt id=hl-318-84><a class=lnlinks href=#hl-318-84>84</a>
</span><span class=lnt id=hl-318-85><a class=lnlinks href=#hl-318-85>85</a>
</span><span class=lnt id=hl-318-86><a class=lnlinks href=#hl-318-86>86</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>longAccumulate</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>LongBinaryOperator</span><span class=w> </span><span class=n>fn</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=kt>boolean</span><span class=w> </span><span class=n>wasUncontended</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„ cell, éœ€è¦éšæœºç”Ÿæˆä¸€ä¸ª h å€¼ç”¨æ¥å°†å½“å‰çº¿ç¨‹ç»‘å®šåˆ° cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getProbe</span><span class=p>())</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åˆå§‹åŒ– probe</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ThreadLocalRandom</span><span class=p>.</span><span class=na>current</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// h å¯¹åº”æ–°çš„ probe å€¼, ç”¨æ¥å¯¹åº” cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getProbe</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>wasUncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// collide ä¸º true è¡¨ç¤ºæœ€åä¸€ä¸ªæ§½éç©ºï¼Œéœ€è¦æ‰©å®¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>collide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>as</span><span class=p>;</span><span class=w> </span><span class=n>Cell</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å·²ç»æœ‰äº† cells</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cells</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è¿˜æ²¡æœ‰ cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=o>[</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>h</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ä¸º cellsBusy åŠ é”, åˆ›å»º cell, cell çš„åˆå§‹ç´¯åŠ å€¼ä¸º x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æˆåŠŸåˆ™ break, å¦åˆ™ç»§ç»­ continue å¾ªç¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cellsBusy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>       </span><span class=c1>// Try to attach new Cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Cell</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cell</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>   </span><span class=c1>// Optimistically create</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cellsBusy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>casCellsBusy</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kt>boolean</span><span class=w> </span><span class=n>created</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>               </span><span class=c1>// Recheck under lock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>rs</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>rs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cells</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>rs</span><span class=o>[</span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>h</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>rs</span><span class=o>[</span><span class=n>j</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>created</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>cellsBusy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>created</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w>           </span><span class=c1>// Slot is now non-empty</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>collide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æœ‰ç«äº‰, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>wasUncontended</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>wasUncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// cas å°è¯•ç´¯åŠ , fn é…åˆ LongAccumulator ä¸ä¸º null, é…åˆ LongAdder ä¸º null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=na>cas</span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>value</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=n>fn</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>fn</span><span class=p>.</span><span class=na>applyAsLong</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>))))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœ cells é•¿åº¦å·²ç»è¶…è¿‡äº†æœ€å¤§é•¿åº¦, æˆ–è€…å·²ç»æ‰©å®¹, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>NCPU</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>cells</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>as</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>collide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ç¡®ä¿ collide ä¸º false è¿›å…¥æ­¤åˆ†æ”¯, å°±ä¸ä¼šè¿›å…¥ä¸‹é¢çš„ else if è¿›è¡Œæ‰©å®¹äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>collide</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>collide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// åŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cellsBusy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>casCellsBusy</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// åŠ é”æˆåŠŸ, æ‰©å®¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>advanceProbe</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¿˜æ²¡æœ‰ cells, å°è¯•ç»™ cellsBusy åŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cellsBusy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>cells</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>as</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>casCellsBusy</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// åŠ é”æˆåŠŸ, åˆå§‹åŒ– cells, æœ€å¼€å§‹é•¿åº¦ä¸º 2, å¹¶å¡«å……ä¸€ä¸ª cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æˆåŠŸåˆ™ break;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>init</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>                           </span><span class=c1>// Initialize table</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cells</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>as</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cell</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>rs</span><span class=o>[</span><span class=n>h</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Cell</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>cells</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>init</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cellsBusy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>init</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¸Šä¸¤ç§æƒ…å†µå¤±è´¥, å°è¯•ç»™ base ç´¯åŠ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>casBase</span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>base</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=n>fn</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>fn</span><span class=p>.</span><span class=na>applyAsLong</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>))))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“ï¼š</p><ul><li><p>å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æœ‰æ²¡æœ‰å¯¹åº”çš„Cell</p><ul><li>å¦‚æœæ²¡æœ‰ï¼Œéšæœºç”Ÿæˆä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼ä¸å½“å‰çº¿ç¨‹ç»‘å®šï¼Œé€šè¿‡è¿™ä¸ªå€¼çš„å–æ¨¡è¿ç®—å®šä½å½“å‰çº¿ç¨‹Cellçš„ä½ç½®ã€‚</li></ul></li><li><p>è¿›å…¥forå¾ªç¯</p><ul><li><p>if æœ‰Cellsç´¯åŠ æ•°ç»„ä¸”é•¿åº¦å¤§äº0</p><ul><li><p>if å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰cell</p><ul><li>å‡†å¤‡æ‰©å®¹ï¼Œå¦‚æœå‰ç´¯åŠ æ•°ç»„ä¸ç¹å¿™ï¼ˆæ­£åœ¨æ‰©å®¹ä¹‹ç±»ï¼‰<ul><li>å°†æ–°å»ºçš„cellæ”¾å…¥å¯¹åº”çš„æ§½ä½ä¸­ï¼Œæ–°å»ºCellæˆåŠŸï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå°è¯•casç´¯åŠ ã€‚</li></ul></li><li>å°†collideç½®ä¸ºfalseï¼Œè¡¨ç¤ºæ— éœ€æ‰©å®¹ã€‚</li></ul></li><li><p>else if æœ‰ç«äº‰</p><ul><li>å°†wasUncontendedç½®ä¸ºtueï¼Œè¿›å…¥åˆ†æ”¯åº•éƒ¨ï¼Œæ”¹å˜çº¿ç¨‹å¯¹åº”çš„cellæ¥casé‡è¯•</li></ul></li><li><p>else if casé‡è¯•ç´¯åŠ æˆåŠŸ</p><ul><li>é€€å‡ºå¾ªç¯ã€‚</li></ul></li><li><p>else if cells é•¿åº¦å·²ç»è¶…è¿‡äº†æœ€å¤§é•¿åº¦, æˆ–è€…å·²ç»æ‰©å®¹,</p><ul><li>collideç½®ä¸ºfalseï¼Œè¿›å…¥åˆ†æ”¯åº•éƒ¨ï¼Œæ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</li></ul></li><li><p>else if collideä¸ºfalse</p><ul><li>å°†collideç½®ä¸ºtrueï¼ˆç¡®ä¿ collide ä¸º false è¿›å…¥æ­¤åˆ†æ”¯, å°±ä¸ä¼šè¿›å…¥ä¸‹é¢çš„ else if è¿›è¡Œæ‰©å®¹äº†ï¼‰</li></ul></li><li><p>else if ç´¯åŠ æ•°ç»„ä¸ç¹å¿™ä¸”åŠ é”æˆåŠŸ</p><ul><li>é€€å‡ºæœ¬æ¬¡å¾ªç¯ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼ˆæ‰©å®¹ï¼‰</li></ul></li><li><p>æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</p></li></ul></li><li><p>else if æ•°ç»„ä¸ç¹å¿™ä¸”æ•°ç»„ä¸ºnullä¸”åŠ é”æˆåŠŸ</p><ul><li>æ–°å»ºæ•°ç»„ï¼Œåœ¨æ§½ä½å¤„æ–°å»ºcellï¼Œé‡Šæ”¾é”ï¼Œé€€å‡ºå¾ªç¯ã€‚</li></ul></li><li><p>else if å°è¯•ç»™baseç´¯åŠ æˆåŠŸ</p><ul><li>é€€å‡ºå¾ªç¯</li></ul></li></ul></li></ul><p>longAccumulate æµç¨‹å›¾</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205457078.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205457078 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205515695.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205515695 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æ¯ä¸ªçº¿ç¨‹åˆšè¿›å…¥ longAccumulate æ—¶ï¼Œä¼šå°è¯•å¯¹åº”ä¸€ä¸ª cell å¯¹è±¡ï¼ˆæ‰¾åˆ°ä¸€ä¸ªå‘ä½ï¼‰</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317205530752.png width=900 height=600 loading=lazy decoding=async alt=image-20220317205530752 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>è·å–æœ€ç»ˆç»“æœé€šè¿‡ sum æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-319-1><a class=lnlinks href=#hl-319-1> 1</a>
</span><span class=lnt id=hl-319-2><a class=lnlinks href=#hl-319-2> 2</a>
</span><span class=lnt id=hl-319-3><a class=lnlinks href=#hl-319-3> 3</a>
</span><span class=lnt id=hl-319-4><a class=lnlinks href=#hl-319-4> 4</a>
</span><span class=lnt id=hl-319-5><a class=lnlinks href=#hl-319-5> 5</a>
</span><span class=lnt id=hl-319-6><a class=lnlinks href=#hl-319-6> 6</a>
</span><span class=lnt id=hl-319-7><a class=lnlinks href=#hl-319-7> 7</a>
</span><span class=lnt id=hl-319-8><a class=lnlinks href=#hl-319-8> 8</a>
</span><span class=lnt id=hl-319-9><a class=lnlinks href=#hl-319-9> 9</a>
</span><span class=lnt id=hl-319-10><a class=lnlinks href=#hl-319-10>10</a>
</span><span class=lnt id=hl-319-11><a class=lnlinks href=#hl-319-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>sum</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Cell</span><span class=o>[]</span><span class=w> </span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cells</span><span class=p>;</span><span class=w> </span><span class=n>Cell</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>base</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>as</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=ä¸è¿ç®—å’Œå–æ¨¡çš„å…³ç³»><a href=#%e4%b8%8e%e8%bf%90%e7%ae%97%e5%92%8c%e5%8f%96%e6%a8%a1%e7%9a%84%e5%85%b3%e7%b3%bb class=header-anchor>#</a>
ä¸è¿ç®—å’Œå–æ¨¡çš„å…³ç³»</h4><blockquote><p><strong>å‚è€ƒé“¾æ¥</strong>ï¼šhttps://www.cnblogs.com/thrillerz/p/4530108.html</p></blockquote><h2 id=68-unsafe><a href=#68-unsafe class=header-anchor>#</a>
6.8 Unsafe</h2><h4 id=æ¦‚è¿°><a href=#%e6%a6%82%e8%bf%b0 class=header-anchor>#</a>
æ¦‚è¿°</h4><p>Unsafe å¯¹è±¡æä¾›äº†éå¸¸åº•å±‚çš„ï¼Œæ“ä½œå†…å­˜ã€çº¿ç¨‹çš„æ–¹æ³•ï¼ŒUnsafe å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾—ã€‚jdk8ç›´æ¥è°ƒç”¨<code>Unsafe.getUnsafe()</code>è·å¾—çš„unsafeä¸èƒ½ç”¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-320-1><a class=lnlinks href=#hl-320-1> 1</a>
</span><span class=lnt id=hl-320-2><a class=lnlinks href=#hl-320-2> 2</a>
</span><span class=lnt id=hl-320-3><a class=lnlinks href=#hl-320-3> 3</a>
</span><span class=lnt id=hl-320-4><a class=lnlinks href=#hl-320-4> 4</a>
</span><span class=lnt id=hl-320-5><a class=lnlinks href=#hl-320-5> 5</a>
</span><span class=lnt id=hl-320-6><a class=lnlinks href=#hl-320-6> 6</a>
</span><span class=lnt id=hl-320-7><a class=lnlinks href=#hl-320-7> 7</a>
</span><span class=lnt id=hl-320-8><a class=lnlinks href=#hl-320-8> 8</a>
</span><span class=lnt id=hl-320-9><a class=lnlinks href=#hl-320-9> 9</a>
</span><span class=lnt id=hl-320-10><a class=lnlinks href=#hl-320-10>10</a>
</span><span class=lnt id=hl-320-11><a class=lnlinks href=#hl-320-11>11</a>
</span><span class=lnt id=hl-320-12><a class=lnlinks href=#hl-320-12>12</a>
</span><span class=lnt id=hl-320-13><a class=lnlinks href=#hl-320-13>13</a>
</span><span class=lnt id=hl-320-14><a class=lnlinks href=#hl-320-14>14</a>
</span><span class=lnt id=hl-320-15><a class=lnlinks href=#hl-320-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UnsafeAccessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Unsafe</span><span class=w> </span><span class=n>unsafe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Field</span><span class=w> </span><span class=n>theUnsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Unsafe</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;theUnsafe&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>theUnsafe</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Unsafe</span><span class=p>)</span><span class=w> </span><span class=n>theUnsafe</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchFieldException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>IllegalAccessException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Unsafe</span><span class=w> </span><span class=nf>getUnsafe</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unsafe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-321-1><a class=lnlinks href=#hl-321-1> 1</a>
</span><span class=lnt id=hl-321-2><a class=lnlinks href=#hl-321-2> 2</a>
</span><span class=lnt id=hl-321-3><a class=lnlinks href=#hl-321-3> 3</a>
</span><span class=lnt id=hl-321-4><a class=lnlinks href=#hl-321-4> 4</a>
</span><span class=lnt id=hl-321-5><a class=lnlinks href=#hl-321-5> 5</a>
</span><span class=lnt id=hl-321-6><a class=lnlinks href=#hl-321-6> 6</a>
</span><span class=lnt id=hl-321-7><a class=lnlinks href=#hl-321-7> 7</a>
</span><span class=lnt id=hl-321-8><a class=lnlinks href=#hl-321-8> 8</a>
</span><span class=lnt id=hl-321-9><a class=lnlinks href=#hl-321-9> 9</a>
</span><span class=lnt id=hl-321-10><a class=lnlinks href=#hl-321-10>10</a>
</span><span class=lnt id=hl-321-11><a class=lnlinks href=#hl-321-11>11</a>
</span><span class=lnt id=hl-321-12><a class=lnlinks href=#hl-321-12>12</a>
</span><span class=lnt id=hl-321-13><a class=lnlinks href=#hl-321-13>13</a>
</span><span class=lnt id=hl-321-14><a class=lnlinks href=#hl-321-14>14</a>
</span><span class=lnt id=hl-321-15><a class=lnlinks href=#hl-321-15>15</a>
</span><span class=lnt id=hl-321-16><a class=lnlinks href=#hl-321-16>16</a>
</span><span class=lnt id=hl-321-17><a class=lnlinks href=#hl-321-17>17</a>
</span><span class=lnt id=hl-321-18><a class=lnlinks href=#hl-321-18>18</a>
</span><span class=lnt id=hl-321-19><a class=lnlinks href=#hl-321-19>19</a>
</span><span class=lnt id=hl-321-20><a class=lnlinks href=#hl-321-20>20</a>
</span><span class=lnt id=hl-321-21><a class=lnlinks href=#hl-321-21>21</a>
</span><span class=lnt id=hl-321-22><a class=lnlinks href=#hl-321-22>22</a>
</span><span class=lnt id=hl-321-23><a class=lnlinks href=#hl-321-23>23</a>
</span><span class=lnt id=hl-321-24><a class=lnlinks href=#hl-321-24>24</a>
</span><span class=lnt id=hl-321-25><a class=lnlinks href=#hl-321-25>25</a>
</span><span class=lnt id=hl-321-26><a class=lnlinks href=#hl-321-26>26</a>
</span><span class=lnt id=hl-321-27><a class=lnlinks href=#hl-321-27>27</a>
</span><span class=lnt id=hl-321-28><a class=lnlinks href=#hl-321-28>28</a>
</span><span class=lnt id=hl-321-29><a class=lnlinks href=#hl-321-29>29</a>
</span><span class=lnt id=hl-321-30><a class=lnlinks href=#hl-321-30>30</a>
</span><span class=lnt id=hl-321-31><a class=lnlinks href=#hl-321-31>31</a>
</span><span class=lnt id=hl-321-32><a class=lnlinks href=#hl-321-32>32</a>
</span><span class=lnt id=hl-321-33><a class=lnlinks href=#hl-321-33>33</a>
</span><span class=lnt id=hl-321-34><a class=lnlinks href=#hl-321-34>34</a>
</span><span class=lnt id=hl-321-35><a class=lnlinks href=#hl-321-35>35</a>
</span><span class=lnt id=hl-321-36><a class=lnlinks href=#hl-321-36>36</a>
</span><span class=lnt id=hl-321-37><a class=lnlinks href=#hl-321-37>37</a>
</span><span class=lnt id=hl-321-38><a class=lnlinks href=#hl-321-38>38</a>
</span><span class=lnt id=hl-321-39><a class=lnlinks href=#hl-321-39>39</a>
</span><span class=lnt id=hl-321-40><a class=lnlinks href=#hl-321-40>40</a>
</span><span class=lnt id=hl-321-41><a class=lnlinks href=#hl-321-41>41</a>
</span><span class=lnt id=hl-321-42><a class=lnlinks href=#hl-321-42>42</a>
</span><span class=lnt id=hl-321-43><a class=lnlinks href=#hl-321-43>43</a>
</span><span class=lnt id=hl-321-44><a class=lnlinks href=#hl-321-44>44</a>
</span><span class=lnt id=hl-321-45><a class=lnlinks href=#hl-321-45>45</a>
</span><span class=lnt id=hl-321-46><a class=lnlinks href=#hl-321-46>46</a>
</span><span class=lnt id=hl-321-47><a class=lnlinks href=#hl-321-47>47</a>
</span><span class=lnt id=hl-321-48><a class=lnlinks href=#hl-321-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œä¸æˆåŠŸè¿”å›false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>native</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>compareAndSwapObject</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>var4</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>var5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>native</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>compareAndSwapInt</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var4</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>native</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>compareAndSwapLong</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var4</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var6</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//ä»¥ä¸‹æ–¹æ³•éƒ½æ˜¯åœ¨ä»¥ä¸Šä¸‰ä¸ªæ–¹æ³•çš„åŸºç¡€ä¸Šè¿›è¡Œå°è£…ï¼Œä¼šå¾ªç¯ç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndAddInt</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>var5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getIntVolatile</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>var5</span><span class=p>,</span><span class=w> </span><span class=n>var5</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>var4</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>var5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>getAndAddLong</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>var6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getLongVolatile</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSwapLong</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>var6</span><span class=p>,</span><span class=w> </span><span class=n>var6</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>var4</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>var6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndSetInt</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>var5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getIntVolatile</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>var5</span><span class=p>,</span><span class=w> </span><span class=n>var4</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>var5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>getAndSetLong</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>var6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getLongVolatile</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSwapLong</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>var6</span><span class=p>,</span><span class=w> </span><span class=n>var4</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>var6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getAndSetObject</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>var5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getObjectVolatile</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSwapObject</span><span class=p>(</span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>var5</span><span class=p>,</span><span class=w> </span><span class=n>var4</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=unsafe-cas-æ“ä½œ><a href=#unsafe-cas-%e6%93%8d%e4%bd%9c class=header-anchor>#</a>
Unsafe CAS æ“ä½œ</h4><h5 id=unsafeå®ç°å­—æ®µæ›´æ–°><a href=#unsafe%e5%ae%9e%e7%8e%b0%e5%ad%97%e6%ae%b5%e6%9b%b4%e6%96%b0 class=header-anchor>#</a>
unsafeå®ç°å­—æ®µæ›´æ–°</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-322-1><a class=lnlinks href=#hl-322-1>1</a>
</span><span class=lnt id=hl-322-2><a class=lnlinks href=#hl-322-2>2</a>
</span><span class=lnt id=hl-322-3><a class=lnlinks href=#hl-322-3>3</a>
</span><span class=lnt id=hl-322-4><a class=lnlinks href=#hl-322-4>4</a>
</span><span class=lnt id=hl-322-5><a class=lnlinks href=#hl-322-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Student</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-323-1><a class=lnlinks href=#hl-323-1> 1</a>
</span><span class=lnt id=hl-323-2><a class=lnlinks href=#hl-323-2> 2</a>
</span><span class=lnt id=hl-323-3><a class=lnlinks href=#hl-323-3> 3</a>
</span><span class=lnt id=hl-323-4><a class=lnlinks href=#hl-323-4> 4</a>
</span><span class=lnt id=hl-323-5><a class=lnlinks href=#hl-323-5> 5</a>
</span><span class=lnt id=hl-323-6><a class=lnlinks href=#hl-323-6> 6</a>
</span><span class=lnt id=hl-323-7><a class=lnlinks href=#hl-323-7> 7</a>
</span><span class=lnt id=hl-323-8><a class=lnlinks href=#hl-323-8> 8</a>
</span><span class=lnt id=hl-323-9><a class=lnlinks href=#hl-323-9> 9</a>
</span><span class=lnt id=hl-323-10><a class=lnlinks href=#hl-323-10>10</a>
</span><span class=lnt id=hl-323-11><a class=lnlinks href=#hl-323-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Unsafe</span><span class=w> </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>getUnsafe</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Field</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Student</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Field</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Student</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å¾—æˆå‘˜å˜é‡çš„åç§»é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>long</span><span class=w> </span><span class=n>idOffset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>unsafe</span><span class=p>.</span><span class=na>objectFieldOffset</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>long</span><span class=w> </span><span class=n>nameOffset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>unsafe</span><span class=p>.</span><span class=na>objectFieldOffset</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Student</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Student</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä½¿ç”¨ cas æ–¹æ³•æ›¿æ¢æˆå‘˜å˜é‡çš„å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=n>student</span><span class=p>,</span><span class=w> </span><span class=n>idOffset</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>20</span><span class=p>);</span><span class=w> </span><span class=c1>// è¿”å› true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>unsafe</span><span class=p>.</span><span class=na>compareAndSwapObject</span><span class=p>(</span><span class=n>student</span><span class=p>,</span><span class=w> </span><span class=n>nameOffset</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=s>&#34;å¼ ä¸‰&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// è¿”å› true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>student</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-324-1><a class=lnlinks href=#hl-324-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Student<span class=o>(</span><span class=nv>id</span><span class=o>=</span>20, <span class=nv>name</span><span class=o>=</span>å¼ ä¸‰<span class=o>)</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=unsafeå®ç°åŸå­æ•´æ•°><a href=#unsafe%e5%ae%9e%e7%8e%b0%e5%8e%9f%e5%ad%90%e6%95%b4%e6%95%b0 class=header-anchor>#</a>
unsafeå®ç°åŸå­æ•´æ•°</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-325-1><a class=lnlinks href=#hl-325-1> 1</a>
</span><span class=lnt id=hl-325-2><a class=lnlinks href=#hl-325-2> 2</a>
</span><span class=lnt id=hl-325-3><a class=lnlinks href=#hl-325-3> 3</a>
</span><span class=lnt id=hl-325-4><a class=lnlinks href=#hl-325-4> 4</a>
</span><span class=lnt id=hl-325-5><a class=lnlinks href=#hl-325-5> 5</a>
</span><span class=lnt id=hl-325-6><a class=lnlinks href=#hl-325-6> 6</a>
</span><span class=lnt id=hl-325-7><a class=lnlinks href=#hl-325-7> 7</a>
</span><span class=lnt id=hl-325-8><a class=lnlinks href=#hl-325-8> 8</a>
</span><span class=lnt id=hl-325-9><a class=lnlinks href=#hl-325-9> 9</a>
</span><span class=lnt id=hl-325-10><a class=lnlinks href=#hl-325-10>10</a>
</span><span class=lnt id=hl-325-11><a class=lnlinks href=#hl-325-11>11</a>
</span><span class=lnt id=hl-325-12><a class=lnlinks href=#hl-325-12>12</a>
</span><span class=lnt id=hl-325-13><a class=lnlinks href=#hl-325-13>13</a>
</span><span class=lnt id=hl-325-14><a class=lnlinks href=#hl-325-14>14</a>
</span><span class=lnt id=hl-325-15><a class=lnlinks href=#hl-325-15>15</a>
</span><span class=lnt id=hl-325-16><a class=lnlinks href=#hl-325-16>16</a>
</span><span class=lnt id=hl-325-17><a class=lnlinks href=#hl-325-17>17</a>
</span><span class=lnt id=hl-325-18><a class=lnlinks href=#hl-325-18>18</a>
</span><span class=lnt id=hl-325-19><a class=lnlinks href=#hl-325-19>19</a>
</span><span class=lnt id=hl-325-20><a class=lnlinks href=#hl-325-20>20</a>
</span><span class=lnt id=hl-325-21><a class=lnlinks href=#hl-325-21>21</a>
</span><span class=lnt id=hl-325-22><a class=lnlinks href=#hl-325-22>22</a>
</span><span class=lnt id=hl-325-23><a class=lnlinks href=#hl-325-23>23</a>
</span><span class=lnt id=hl-325-24><a class=lnlinks href=#hl-325-24>24</a>
</span><span class=lnt id=hl-325-25><a class=lnlinks href=#hl-325-25>25</a>
</span><span class=lnt id=hl-325-26><a class=lnlinks href=#hl-325-26>26</a>
</span><span class=lnt id=hl-325-27><a class=lnlinks href=#hl-325-27>27</a>
</span><span class=lnt id=hl-325-28><a class=lnlinks href=#hl-325-28>28</a>
</span><span class=lnt id=hl-325-29><a class=lnlinks href=#hl-325-29>29</a>
</span><span class=lnt id=hl-325-30><a class=lnlinks href=#hl-325-30>30</a>
</span><span class=lnt id=hl-325-31><a class=lnlinks href=#hl-325-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AtomicData</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Unsafe</span><span class=w> </span><span class=n>unsafe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>DATA_OFFSET</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>getUnsafe</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// data å±æ€§åœ¨ DataContainer å¯¹è±¡ä¸­çš„åç§»é‡ï¼Œç”¨äº Unsafe ç›´æ¥è®¿é—®è¯¥å±æ€§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DATA_OFFSET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unsafe</span><span class=p>.</span><span class=na>objectFieldOffset</span><span class=p>(</span><span class=n>AtomicData</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;data&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchFieldException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AtomicData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decrease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è·å–å…±äº«å˜é‡æ—§å€¼ï¼Œå¯ä»¥åœ¨è¿™ä¸€è¡ŒåŠ å…¥æ–­ç‚¹ï¼Œä¿®æ”¹ data è°ƒè¯•æ¥åŠ æ·±ç†è§£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// cas å°è¯•ä¿®æ”¹ data ä¸º æ—§å€¼ + amountï¼Œå¦‚æœæœŸé—´æ—§å€¼è¢«åˆ«çš„çº¿ç¨‹æ”¹äº†ï¼Œè¿”å› false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>DATA_OFFSET</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Account å®ç°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-326-1><a class=lnlinks href=#hl-326-1> 1</a>
</span><span class=lnt id=hl-326-2><a class=lnlinks href=#hl-326-2> 2</a>
</span><span class=lnt id=hl-326-3><a class=lnlinks href=#hl-326-3> 3</a>
</span><span class=lnt id=hl-326-4><a class=lnlinks href=#hl-326-4> 4</a>
</span><span class=lnt id=hl-326-5><a class=lnlinks href=#hl-326-5> 5</a>
</span><span class=lnt id=hl-326-6><a class=lnlinks href=#hl-326-6> 6</a>
</span><span class=lnt id=hl-326-7><a class=lnlinks href=#hl-326-7> 7</a>
</span><span class=lnt id=hl-326-8><a class=lnlinks href=#hl-326-8> 8</a>
</span><span class=lnt id=hl-326-9><a class=lnlinks href=#hl-326-9> 9</a>
</span><span class=lnt id=hl-326-10><a class=lnlinks href=#hl-326-10>10</a>
</span><span class=lnt id=hl-326-11><a class=lnlinks href=#hl-326-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Account</span><span class=p>.</span><span class=na>demo</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Account</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AtomicData</span><span class=w> </span><span class=n>atomicData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicData</span><span class=p>(</span><span class=n>10000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>atomicData</span><span class=p>.</span><span class=na>getData</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>withdraw</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>atomicData</span><span class=p>.</span><span class=na>decrease</span><span class=p>(</span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=æ‰‹åŠ¨å®ç°åŸå­æ•´æ•°å®Œæ•´ç‰ˆæµ‹è¯•><a href=#%e6%89%8b%e5%8a%a8%e5%ae%9e%e7%8e%b0%e5%8e%9f%e5%ad%90%e6%95%b4%e6%95%b0%e5%ae%8c%e6%95%b4%e7%89%88%e6%b5%8b%e8%af%95 class=header-anchor>#</a>
æ‰‹åŠ¨å®ç°åŸå­æ•´æ•°å®Œæ•´ç‰ˆ+æµ‹è¯•</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-327-1><a class=lnlinks href=#hl-327-1>  1</a>
</span><span class=lnt id=hl-327-2><a class=lnlinks href=#hl-327-2>  2</a>
</span><span class=lnt id=hl-327-3><a class=lnlinks href=#hl-327-3>  3</a>
</span><span class=lnt id=hl-327-4><a class=lnlinks href=#hl-327-4>  4</a>
</span><span class=lnt id=hl-327-5><a class=lnlinks href=#hl-327-5>  5</a>
</span><span class=lnt id=hl-327-6><a class=lnlinks href=#hl-327-6>  6</a>
</span><span class=lnt id=hl-327-7><a class=lnlinks href=#hl-327-7>  7</a>
</span><span class=lnt id=hl-327-8><a class=lnlinks href=#hl-327-8>  8</a>
</span><span class=lnt id=hl-327-9><a class=lnlinks href=#hl-327-9>  9</a>
</span><span class=lnt id=hl-327-10><a class=lnlinks href=#hl-327-10> 10</a>
</span><span class=lnt id=hl-327-11><a class=lnlinks href=#hl-327-11> 11</a>
</span><span class=lnt id=hl-327-12><a class=lnlinks href=#hl-327-12> 12</a>
</span><span class=lnt id=hl-327-13><a class=lnlinks href=#hl-327-13> 13</a>
</span><span class=lnt id=hl-327-14><a class=lnlinks href=#hl-327-14> 14</a>
</span><span class=lnt id=hl-327-15><a class=lnlinks href=#hl-327-15> 15</a>
</span><span class=lnt id=hl-327-16><a class=lnlinks href=#hl-327-16> 16</a>
</span><span class=lnt id=hl-327-17><a class=lnlinks href=#hl-327-17> 17</a>
</span><span class=lnt id=hl-327-18><a class=lnlinks href=#hl-327-18> 18</a>
</span><span class=lnt id=hl-327-19><a class=lnlinks href=#hl-327-19> 19</a>
</span><span class=lnt id=hl-327-20><a class=lnlinks href=#hl-327-20> 20</a>
</span><span class=lnt id=hl-327-21><a class=lnlinks href=#hl-327-21> 21</a>
</span><span class=lnt id=hl-327-22><a class=lnlinks href=#hl-327-22> 22</a>
</span><span class=lnt id=hl-327-23><a class=lnlinks href=#hl-327-23> 23</a>
</span><span class=lnt id=hl-327-24><a class=lnlinks href=#hl-327-24> 24</a>
</span><span class=lnt id=hl-327-25><a class=lnlinks href=#hl-327-25> 25</a>
</span><span class=lnt id=hl-327-26><a class=lnlinks href=#hl-327-26> 26</a>
</span><span class=lnt id=hl-327-27><a class=lnlinks href=#hl-327-27> 27</a>
</span><span class=lnt id=hl-327-28><a class=lnlinks href=#hl-327-28> 28</a>
</span><span class=lnt id=hl-327-29><a class=lnlinks href=#hl-327-29> 29</a>
</span><span class=lnt id=hl-327-30><a class=lnlinks href=#hl-327-30> 30</a>
</span><span class=lnt id=hl-327-31><a class=lnlinks href=#hl-327-31> 31</a>
</span><span class=lnt id=hl-327-32><a class=lnlinks href=#hl-327-32> 32</a>
</span><span class=lnt id=hl-327-33><a class=lnlinks href=#hl-327-33> 33</a>
</span><span class=lnt id=hl-327-34><a class=lnlinks href=#hl-327-34> 34</a>
</span><span class=lnt id=hl-327-35><a class=lnlinks href=#hl-327-35> 35</a>
</span><span class=lnt id=hl-327-36><a class=lnlinks href=#hl-327-36> 36</a>
</span><span class=lnt id=hl-327-37><a class=lnlinks href=#hl-327-37> 37</a>
</span><span class=lnt id=hl-327-38><a class=lnlinks href=#hl-327-38> 38</a>
</span><span class=lnt id=hl-327-39><a class=lnlinks href=#hl-327-39> 39</a>
</span><span class=lnt id=hl-327-40><a class=lnlinks href=#hl-327-40> 40</a>
</span><span class=lnt id=hl-327-41><a class=lnlinks href=#hl-327-41> 41</a>
</span><span class=lnt id=hl-327-42><a class=lnlinks href=#hl-327-42> 42</a>
</span><span class=lnt id=hl-327-43><a class=lnlinks href=#hl-327-43> 43</a>
</span><span class=lnt id=hl-327-44><a class=lnlinks href=#hl-327-44> 44</a>
</span><span class=lnt id=hl-327-45><a class=lnlinks href=#hl-327-45> 45</a>
</span><span class=lnt id=hl-327-46><a class=lnlinks href=#hl-327-46> 46</a>
</span><span class=lnt id=hl-327-47><a class=lnlinks href=#hl-327-47> 47</a>
</span><span class=lnt id=hl-327-48><a class=lnlinks href=#hl-327-48> 48</a>
</span><span class=lnt id=hl-327-49><a class=lnlinks href=#hl-327-49> 49</a>
</span><span class=lnt id=hl-327-50><a class=lnlinks href=#hl-327-50> 50</a>
</span><span class=lnt id=hl-327-51><a class=lnlinks href=#hl-327-51> 51</a>
</span><span class=lnt id=hl-327-52><a class=lnlinks href=#hl-327-52> 52</a>
</span><span class=lnt id=hl-327-53><a class=lnlinks href=#hl-327-53> 53</a>
</span><span class=lnt id=hl-327-54><a class=lnlinks href=#hl-327-54> 54</a>
</span><span class=lnt id=hl-327-55><a class=lnlinks href=#hl-327-55> 55</a>
</span><span class=lnt id=hl-327-56><a class=lnlinks href=#hl-327-56> 56</a>
</span><span class=lnt id=hl-327-57><a class=lnlinks href=#hl-327-57> 57</a>
</span><span class=lnt id=hl-327-58><a class=lnlinks href=#hl-327-58> 58</a>
</span><span class=lnt id=hl-327-59><a class=lnlinks href=#hl-327-59> 59</a>
</span><span class=lnt id=hl-327-60><a class=lnlinks href=#hl-327-60> 60</a>
</span><span class=lnt id=hl-327-61><a class=lnlinks href=#hl-327-61> 61</a>
</span><span class=lnt id=hl-327-62><a class=lnlinks href=#hl-327-62> 62</a>
</span><span class=lnt id=hl-327-63><a class=lnlinks href=#hl-327-63> 63</a>
</span><span class=lnt id=hl-327-64><a class=lnlinks href=#hl-327-64> 64</a>
</span><span class=lnt id=hl-327-65><a class=lnlinks href=#hl-327-65> 65</a>
</span><span class=lnt id=hl-327-66><a class=lnlinks href=#hl-327-66> 66</a>
</span><span class=lnt id=hl-327-67><a class=lnlinks href=#hl-327-67> 67</a>
</span><span class=lnt id=hl-327-68><a class=lnlinks href=#hl-327-68> 68</a>
</span><span class=lnt id=hl-327-69><a class=lnlinks href=#hl-327-69> 69</a>
</span><span class=lnt id=hl-327-70><a class=lnlinks href=#hl-327-70> 70</a>
</span><span class=lnt id=hl-327-71><a class=lnlinks href=#hl-327-71> 71</a>
</span><span class=lnt id=hl-327-72><a class=lnlinks href=#hl-327-72> 72</a>
</span><span class=lnt id=hl-327-73><a class=lnlinks href=#hl-327-73> 73</a>
</span><span class=lnt id=hl-327-74><a class=lnlinks href=#hl-327-74> 74</a>
</span><span class=lnt id=hl-327-75><a class=lnlinks href=#hl-327-75> 75</a>
</span><span class=lnt id=hl-327-76><a class=lnlinks href=#hl-327-76> 76</a>
</span><span class=lnt id=hl-327-77><a class=lnlinks href=#hl-327-77> 77</a>
</span><span class=lnt id=hl-327-78><a class=lnlinks href=#hl-327-78> 78</a>
</span><span class=lnt id=hl-327-79><a class=lnlinks href=#hl-327-79> 79</a>
</span><span class=lnt id=hl-327-80><a class=lnlinks href=#hl-327-80> 80</a>
</span><span class=lnt id=hl-327-81><a class=lnlinks href=#hl-327-81> 81</a>
</span><span class=lnt id=hl-327-82><a class=lnlinks href=#hl-327-82> 82</a>
</span><span class=lnt id=hl-327-83><a class=lnlinks href=#hl-327-83> 83</a>
</span><span class=lnt id=hl-327-84><a class=lnlinks href=#hl-327-84> 84</a>
</span><span class=lnt id=hl-327-85><a class=lnlinks href=#hl-327-85> 85</a>
</span><span class=lnt id=hl-327-86><a class=lnlinks href=#hl-327-86> 86</a>
</span><span class=lnt id=hl-327-87><a class=lnlinks href=#hl-327-87> 87</a>
</span><span class=lnt id=hl-327-88><a class=lnlinks href=#hl-327-88> 88</a>
</span><span class=lnt id=hl-327-89><a class=lnlinks href=#hl-327-89> 89</a>
</span><span class=lnt id=hl-327-90><a class=lnlinks href=#hl-327-90> 90</a>
</span><span class=lnt id=hl-327-91><a class=lnlinks href=#hl-327-91> 91</a>
</span><span class=lnt id=hl-327-92><a class=lnlinks href=#hl-327-92> 92</a>
</span><span class=lnt id=hl-327-93><a class=lnlinks href=#hl-327-93> 93</a>
</span><span class=lnt id=hl-327-94><a class=lnlinks href=#hl-327-94> 94</a>
</span><span class=lnt id=hl-327-95><a class=lnlinks href=#hl-327-95> 95</a>
</span><span class=lnt id=hl-327-96><a class=lnlinks href=#hl-327-96> 96</a>
</span><span class=lnt id=hl-327-97><a class=lnlinks href=#hl-327-97> 97</a>
</span><span class=lnt id=hl-327-98><a class=lnlinks href=#hl-327-98> 98</a>
</span><span class=lnt id=hl-327-99><a class=lnlinks href=#hl-327-99> 99</a>
</span><span class=lnt id=hl-327-100><a class=lnlinks href=#hl-327-100>100</a>
</span><span class=lnt id=hl-327-101><a class=lnlinks href=#hl-327-101>101</a>
</span><span class=lnt id=hl-327-102><a class=lnlinks href=#hl-327-102>102</a>
</span><span class=lnt id=hl-327-103><a class=lnlinks href=#hl-327-103>103</a>
</span><span class=lnt id=hl-327-104><a class=lnlinks href=#hl-327-104>104</a>
</span><span class=lnt id=hl-327-105><a class=lnlinks href=#hl-327-105>105</a>
</span><span class=lnt id=hl-327-106><a class=lnlinks href=#hl-327-106>106</a>
</span><span class=lnt id=hl-327-107><a class=lnlinks href=#hl-327-107>107</a>
</span><span class=lnt id=hl-327-108><a class=lnlinks href=#hl-327-108>108</a>
</span><span class=lnt id=hl-327-109><a class=lnlinks href=#hl-327-109>109</a>
</span><span class=lnt id=hl-327-110><a class=lnlinks href=#hl-327-110>110</a>
</span><span class=lnt id=hl-327-111><a class=lnlinks href=#hl-327-111>111</a>
</span><span class=lnt id=hl-327-112><a class=lnlinks href=#hl-327-112>112</a>
</span><span class=lnt id=hl-327-113><a class=lnlinks href=#hl-327-113>113</a>
</span><span class=lnt id=hl-327-114><a class=lnlinks href=#hl-327-114>114</a>
</span><span class=lnt id=hl-327-115><a class=lnlinks href=#hl-327-115>115</a>
</span><span class=lnt id=hl-327-116><a class=lnlinks href=#hl-327-116>116</a>
</span><span class=lnt id=hl-327-117><a class=lnlinks href=#hl-327-117>117</a>
</span><span class=lnt id=hl-327-118><a class=lnlinks href=#hl-327-118>118</a>
</span><span class=lnt id=hl-327-119><a class=lnlinks href=#hl-327-119>119</a>
</span><span class=lnt id=hl-327-120><a class=lnlinks href=#hl-327-120>120</a>
</span><span class=lnt id=hl-327-121><a class=lnlinks href=#hl-327-121>121</a>
</span><span class=lnt id=hl-327-122><a class=lnlinks href=#hl-327-122>122</a>
</span><span class=lnt id=hl-327-123><a class=lnlinks href=#hl-327-123>123</a>
</span><span class=lnt id=hl-327-124><a class=lnlinks href=#hl-327-124>124</a>
</span><span class=lnt id=hl-327-125><a class=lnlinks href=#hl-327-125>125</a>
</span><span class=lnt id=hl-327-126><a class=lnlinks href=#hl-327-126>126</a>
</span><span class=lnt id=hl-327-127><a class=lnlinks href=#hl-327-127>127</a>
</span><span class=lnt id=hl-327-128><a class=lnlinks href=#hl-327-128>128</a>
</span><span class=lnt id=hl-327-129><a class=lnlinks href=#hl-327-129>129</a>
</span><span class=lnt id=hl-327-130><a class=lnlinks href=#hl-327-130>130</a>
</span><span class=lnt id=hl-327-131><a class=lnlinks href=#hl-327-131>131</a>
</span><span class=lnt id=hl-327-132><a class=lnlinks href=#hl-327-132>132</a>
</span><span class=lnt id=hl-327-133><a class=lnlinks href=#hl-327-133>133</a>
</span><span class=lnt id=hl-327-134><a class=lnlinks href=#hl-327-134>134</a>
</span><span class=lnt id=hl-327-135><a class=lnlinks href=#hl-327-135>135</a>
</span><span class=lnt id=hl-327-136><a class=lnlinks href=#hl-327-136>136</a>
</span><span class=lnt id=hl-327-137><a class=lnlinks href=#hl-327-137>137</a>
</span><span class=lnt id=hl-327-138><a class=lnlinks href=#hl-327-138>138</a>
</span><span class=lnt id=hl-327-139><a class=lnlinks href=#hl-327-139>139</a>
</span><span class=lnt id=hl-327-140><a class=lnlinks href=#hl-327-140>140</a>
</span><span class=lnt id=hl-327-141><a class=lnlinks href=#hl-327-141>141</a>
</span><span class=lnt id=hl-327-142><a class=lnlinks href=#hl-327-142>142</a>
</span><span class=lnt id=hl-327-143><a class=lnlinks href=#hl-327-143>143</a>
</span><span class=lnt id=hl-327-144><a class=lnlinks href=#hl-327-144>144</a>
</span><span class=lnt id=hl-327-145><a class=lnlinks href=#hl-327-145>145</a>
</span><span class=lnt id=hl-327-146><a class=lnlinks href=#hl-327-146>146</a>
</span><span class=lnt id=hl-327-147><a class=lnlinks href=#hl-327-147>147</a>
</span><span class=lnt id=hl-327-148><a class=lnlinks href=#hl-327-148>148</a>
</span><span class=lnt id=hl-327-149><a class=lnlinks href=#hl-327-149>149</a>
</span><span class=lnt id=hl-327-150><a class=lnlinks href=#hl-327-150>150</a>
</span><span class=lnt id=hl-327-151><a class=lnlinks href=#hl-327-151>151</a>
</span><span class=lnt id=hl-327-152><a class=lnlinks href=#hl-327-152>152</a>
</span><span class=lnt id=hl-327-153><a class=lnlinks href=#hl-327-153>153</a>
</span><span class=lnt id=hl-327-154><a class=lnlinks href=#hl-327-154>154</a>
</span><span class=lnt id=hl-327-155><a class=lnlinks href=#hl-327-155>155</a>
</span><span class=lnt id=hl-327-156><a class=lnlinks href=#hl-327-156>156</a>
</span><span class=lnt id=hl-327-157><a class=lnlinks href=#hl-327-157>157</a>
</span><span class=lnt id=hl-327-158><a class=lnlinks href=#hl-327-158>158</a>
</span><span class=lnt id=hl-327-159><a class=lnlinks href=#hl-327-159>159</a>
</span><span class=lnt id=hl-327-160><a class=lnlinks href=#hl-327-160>160</a>
</span><span class=lnt id=hl-327-161><a class=lnlinks href=#hl-327-161>161</a>
</span><span class=lnt id=hl-327-162><a class=lnlinks href=#hl-327-162>162</a>
</span><span class=lnt id=hl-327-163><a class=lnlinks href=#hl-327-163>163</a>
</span><span class=lnt id=hl-327-164><a class=lnlinks href=#hl-327-164>164</a>
</span><span class=lnt id=hl-327-165><a class=lnlinks href=#hl-327-165>165</a>
</span><span class=lnt id=hl-327-166><a class=lnlinks href=#hl-327-166>166</a>
</span><span class=lnt id=hl-327-167><a class=lnlinks href=#hl-327-167>167</a>
</span><span class=lnt id=hl-327-168><a class=lnlinks href=#hl-327-168>168</a>
</span><span class=lnt id=hl-327-169><a class=lnlinks href=#hl-327-169>169</a>
</span><span class=lnt id=hl-327-170><a class=lnlinks href=#hl-327-170>170</a>
</span><span class=lnt id=hl-327-171><a class=lnlinks href=#hl-327-171>171</a>
</span><span class=lnt id=hl-327-172><a class=lnlinks href=#hl-327-172>172</a>
</span><span class=lnt id=hl-327-173><a class=lnlinks href=#hl-327-173>173</a>
</span><span class=lnt id=hl-327-174><a class=lnlinks href=#hl-327-174>174</a>
</span><span class=lnt id=hl-327-175><a class=lnlinks href=#hl-327-175>175</a>
</span><span class=lnt id=hl-327-176><a class=lnlinks href=#hl-327-176>176</a>
</span><span class=lnt id=hl-327-177><a class=lnlinks href=#hl-327-177>177</a>
</span><span class=lnt id=hl-327-178><a class=lnlinks href=#hl-327-178>178</a>
</span><span class=lnt id=hl-327-179><a class=lnlinks href=#hl-327-179>179</a>
</span><span class=lnt id=hl-327-180><a class=lnlinks href=#hl-327-180>180</a>
</span><span class=lnt id=hl-327-181><a class=lnlinks href=#hl-327-181>181</a>
</span><span class=lnt id=hl-327-182><a class=lnlinks href=#hl-327-182>182</a>
</span><span class=lnt id=hl-327-183><a class=lnlinks href=#hl-327-183>183</a>
</span><span class=lnt id=hl-327-184><a class=lnlinks href=#hl-327-184>184</a>
</span><span class=lnt id=hl-327-185><a class=lnlinks href=#hl-327-185>185</a>
</span><span class=lnt id=hl-327-186><a class=lnlinks href=#hl-327-186>186</a>
</span><span class=lnt id=hl-327-187><a class=lnlinks href=#hl-327-187>187</a>
</span><span class=lnt id=hl-327-188><a class=lnlinks href=#hl-327-188>188</a>
</span><span class=lnt id=hl-327-189><a class=lnlinks href=#hl-327-189>189</a>
</span><span class=lnt id=hl-327-190><a class=lnlinks href=#hl-327-190>190</a>
</span><span class=lnt id=hl-327-191><a class=lnlinks href=#hl-327-191>191</a>
</span><span class=lnt id=hl-327-192><a class=lnlinks href=#hl-327-192>192</a>
</span><span class=lnt id=hl-327-193><a class=lnlinks href=#hl-327-193>193</a>
</span><span class=lnt id=hl-327-194><a class=lnlinks href=#hl-327-194>194</a>
</span><span class=lnt id=hl-327-195><a class=lnlinks href=#hl-327-195>195</a>
</span><span class=lnt id=hl-327-196><a class=lnlinks href=#hl-327-196>196</a>
</span><span class=lnt id=hl-327-197><a class=lnlinks href=#hl-327-197>197</a>
</span><span class=lnt id=hl-327-198><a class=lnlinks href=#hl-327-198>198</a>
</span><span class=lnt id=hl-327-199><a class=lnlinks href=#hl-327-199>199</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UnsafeAtomicTest</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//èµ‹åˆå§‹å€¼10000ï¼Œè°ƒç”¨demoåæ­£ç¡®çš„è¾“å‡ºç»“æœä¸º0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AccountImpl</span><span class=w> </span><span class=n>account</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AccountImpl</span><span class=p>(</span><span class=n>10000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ç»“æœæ­£ç¡®åœ°è¾“å‡º0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>account</span><span class=p>.</span><span class=na>demo</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>interface</span> <span class=nc>Account</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//è·å–balanceçš„æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å–æ¬¾çš„æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>decrease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//æ¼”ç¤ºå¤šçº¿ç¨‹å–æ¬¾ï¼Œæ£€æŸ¥å®‰å…¨æ€§ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>default</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ts</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>decrease</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=p>:</span><span class=n>ts</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=p>:</span><span class=n>ts</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>t</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>getBalance</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//å®ç°è´¦æˆ·ç±»ï¼Œä½¿ç”¨æ‰‹åŠ¨å®ç°çš„åŸå­æ•´æ•°ä½œä¸ºä½™é¢ç±»å‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>AccountImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Account</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>UnsafeAtomicInteger</span><span class=w> </span><span class=n>balance</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AccountImpl</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>balance</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnsafeAtomicInteger</span><span class=p>(</span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getBalance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>balance</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decrease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>balance</span><span class=p>.</span><span class=na>getAndAccumulate</span><span class=p>(</span><span class=n>amount</span><span class=p>,(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//æ‰‹åŠ¨å®ç°åŸå­æ•´æ•°ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UnsafeAtomicInteger</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å°†valueå£°æ˜ä¸ºvolatileï¼Œå› ä¸ºä¹è§‚é”éœ€è¦å¯è§æ€§ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//éœ€è¦Unsafeçš„casæœ¬åœ°æ–¹æ³•å®ç°æ“ä½œã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Unsafe</span><span class=w> </span><span class=n>unsafe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//åç§»é‡ï¼Œè¿™ä¸¤ä¸ªå˜é‡å¾ˆé‡è¦ä¸”é€šç”¨ã€ä¸å¯å˜ï¼Œæ‰€ä»¥å‡å£°æ˜ä¸ºprivate static final</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>offset</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//é™æ€ä»£ç å—åˆå§‹åŒ–unsafe</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UnsafeAccessor</span><span class=p>.</span><span class=na>getUnsafe</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//è·å–valueåœ¨å½“å‰ç±»ä¸­çš„åç§»é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unsafe</span><span class=p>.</span><span class=na>objectFieldOffset</span><span class=p>(</span><span class=n>UnsafeAtomicInteger</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchFieldException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//å¾…ç ”ç©¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>UnsafeAtomicInteger</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>UnsafeAtomicInteger</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>get</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>compareAndSet</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>expext</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>update</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>expext</span><span class=p>,</span><span class=w> </span><span class=n>update</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndIncrement</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//å±€éƒ¨å˜é‡æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºå¤šæ¬¡ä»ä¸»å­˜ä¸­è¯»å–valueçš„å€¼ä¸å¯é ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=n>offset</span><span class=p>,</span><span class=n>oldValue</span><span class=p>,</span><span class=n>oldValue</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>incrementAndGet</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndDecrement</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>decrementAndGet</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndUpdate</span><span class=p>(</span><span class=n>IntUnaryOperator</span><span class=w> </span><span class=n>operator</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operator</span><span class=p>.</span><span class=na>applyAsInt</span><span class=p>(</span><span class=n>oldValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>newValue</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>updateAndGet</span><span class=p>(</span><span class=n>IntUnaryOperator</span><span class=w> </span><span class=n>operator</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operator</span><span class=p>.</span><span class=na>applyAsInt</span><span class=p>(</span><span class=n>oldValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>newValue</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getAndAccumulate</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>IntBinaryOperator</span><span class=w> </span><span class=n>operator</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operator</span><span class=p>.</span><span class=na>applyAsInt</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>oldValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>newValue</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>accumulateAndGet</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>IntBinaryOperator</span><span class=w> </span><span class=n>operator</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>newValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operator</span><span class=p>.</span><span class=na>applyAsInt</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>oldValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unsafe</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>oldValue</span><span class=p>,</span><span class=w> </span><span class=n>newValue</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UnsafeAccessor</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Unsafe</span><span class=w> </span><span class=nf>getUnsafe</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Unsafe</span><span class=w> </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>field</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>Unsafe</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;theUnsafe&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Unsafe</span><span class=p>)</span><span class=n>field</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unsafe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=69-è‡ªå®šä¹‰casé”><a href=#69-%e8%87%aa%e5%ae%9a%e4%b9%89cas%e9%94%81 class=header-anchor>#</a>
<strong>6.9 è‡ªå®šä¹‰casé”</strong></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-328-1><a class=lnlinks href=#hl-328-1> 1</a>
</span><span class=lnt id=hl-328-2><a class=lnlinks href=#hl-328-2> 2</a>
</span><span class=lnt id=hl-328-3><a class=lnlinks href=#hl-328-3> 3</a>
</span><span class=lnt id=hl-328-4><a class=lnlinks href=#hl-328-4> 4</a>
</span><span class=lnt id=hl-328-5><a class=lnlinks href=#hl-328-5> 5</a>
</span><span class=lnt id=hl-328-6><a class=lnlinks href=#hl-328-6> 6</a>
</span><span class=lnt id=hl-328-7><a class=lnlinks href=#hl-328-7> 7</a>
</span><span class=lnt id=hl-328-8><a class=lnlinks href=#hl-328-8> 8</a>
</span><span class=lnt id=hl-328-9><a class=lnlinks href=#hl-328-9> 9</a>
</span><span class=lnt id=hl-328-10><a class=lnlinks href=#hl-328-10>10</a>
</span><span class=lnt id=hl-328-11><a class=lnlinks href=#hl-328-11>11</a>
</span><span class=lnt id=hl-328-12><a class=lnlinks href=#hl-328-12>12</a>
</span><span class=lnt id=hl-328-13><a class=lnlinks href=#hl-328-13>13</a>
</span><span class=lnt id=hl-328-14><a class=lnlinks href=#hl-328-14>14</a>
</span><span class=lnt id=hl-328-15><a class=lnlinks href=#hl-328-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ä¸è¦ç”¨äºå®è·µï¼ï¼ï¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LockCas</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unlock...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>state</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-329-1><a class=lnlinks href=#hl-329-1> 1</a>
</span><span class=lnt id=hl-329-2><a class=lnlinks href=#hl-329-2> 2</a>
</span><span class=lnt id=hl-329-3><a class=lnlinks href=#hl-329-3> 3</a>
</span><span class=lnt id=hl-329-4><a class=lnlinks href=#hl-329-4> 4</a>
</span><span class=lnt id=hl-329-5><a class=lnlinks href=#hl-329-5> 5</a>
</span><span class=lnt id=hl-329-6><a class=lnlinks href=#hl-329-6> 6</a>
</span><span class=lnt id=hl-329-7><a class=lnlinks href=#hl-329-7> 7</a>
</span><span class=lnt id=hl-329-8><a class=lnlinks href=#hl-329-8> 8</a>
</span><span class=lnt id=hl-329-9><a class=lnlinks href=#hl-329-9> 9</a>
</span><span class=lnt id=hl-329-10><a class=lnlinks href=#hl-329-10>10</a>
</span><span class=lnt id=hl-329-11><a class=lnlinks href=#hl-329-11>11</a>
</span><span class=lnt id=hl-329-12><a class=lnlinks href=#hl-329-12>12</a>
</span><span class=lnt id=hl-329-13><a class=lnlinks href=#hl-329-13>13</a>
</span><span class=lnt id=hl-329-14><a class=lnlinks href=#hl-329-14>14</a>
</span><span class=lnt id=hl-329-15><a class=lnlinks href=#hl-329-15>15</a>
</span><span class=lnt id=hl-329-16><a class=lnlinks href=#hl-329-16>16</a>
</span><span class=lnt id=hl-329-17><a class=lnlinks href=#hl-329-17>17</a>
</span><span class=lnt id=hl-329-18><a class=lnlinks href=#hl-329-18>18</a>
</span><span class=lnt id=hl-329-19><a class=lnlinks href=#hl-329-19>19</a>
</span><span class=lnt id=hl-329-20><a class=lnlinks href=#hl-329-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LockCas</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LockCas</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;lock...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-330-1><a class=lnlinks href=#hl-330-1>1</a>
</span><span class=lnt id=hl-330-2><a class=lnlinks href=#hl-330-2>2</a>
</span><span class=lnt id=hl-330-3><a class=lnlinks href=#hl-330-3>3</a>
</span><span class=lnt id=hl-330-4><a class=lnlinks href=#hl-330-4>4</a>
</span><span class=lnt id=hl-330-5><a class=lnlinks href=#hl-330-5>5</a>
</span><span class=lnt id=hl-330-6><a class=lnlinks href=#hl-330-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:27:07.198 c.Test42 <span class=o>[</span>Thread-0<span class=o>]</span> - begin... 
</span></span><span class=line><span class=cl>18:27:07.202 c.Test42 <span class=o>[</span>Thread-0<span class=o>]</span> - lock... 
</span></span><span class=line><span class=cl>18:27:07.198 c.Test42 <span class=o>[</span>Thread-1<span class=o>]</span> - begin... 
</span></span><span class=line><span class=cl>18:27:08.204 c.Test42 <span class=o>[</span>Thread-0<span class=o>]</span> - unlock... 
</span></span><span class=line><span class=cl>18:27:08.204 c.Test42 <span class=o>[</span>Thread-1<span class=o>]</span> - lock... 
</span></span><span class=line><span class=cl>18:27:08.204 c.Test42 <span class=o>[</span>Thread-1<span class=o>]</span> - unlock... 
</span></span></code></pre></td></tr></table></div></div><h2 id=æœ¬ç« å°ç»“-3><a href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-3 class=header-anchor>#</a>
æœ¬ç« å°ç»“</h2><ul><li>CAS ä¸ volatile</li><li>API<ul><li>åŸå­æ•´æ•°</li><li>åŸå­å¼•ç”¨</li><li>åŸå­æ•°ç»„</li><li>å­—æ®µæ›´æ–°å™¨</li><li>åŸå­ç´¯åŠ å™¨</li></ul></li><li>Unsafe</li><li><font color=blue>*åŸç†æ–¹é¢</font><ul><li>LongAdder æºç </li><li>ä¼ªå…±äº«</li></ul></li></ul><h1 id=7å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜><a href=#7%e5%85%b1%e4%ba%ab%e6%a8%a1%e5%9e%8b%e4%b9%8b%e4%b8%8d%e5%8f%af%e5%8f%98 class=header-anchor>#</a>
7.å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜</h1><h2 id=71-æ—¥æœŸè½¬æ¢çš„é—®é¢˜><a href=#71-%e6%97%a5%e6%9c%9f%e8%bd%ac%e6%8d%a2%e7%9a%84%e9%97%ae%e9%a2%98 class=header-anchor>#</a>
7.1 æ—¥æœŸè½¬æ¢çš„é—®é¢˜</h2><h5 id=é—®é¢˜æå‡º><a href=#%e9%97%ae%e9%a2%98%e6%8f%90%e5%87%ba class=header-anchor>#</a>
é—®é¢˜æå‡º</h5><p>ä¸‹é¢çš„ä»£ç åœ¨è¿è¡Œæ—¶ï¼Œç”±äº SimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-331-1><a class=lnlinks href=#hl-331-1> 1</a>
</span><span class=lnt id=hl-331-2><a class=lnlinks href=#hl-331-2> 2</a>
</span><span class=lnt id=hl-331-3><a class=lnlinks href=#hl-331-3> 3</a>
</span><span class=lnt id=hl-331-4><a class=lnlinks href=#hl-331-4> 4</a>
</span><span class=lnt id=hl-331-5><a class=lnlinks href=#hl-331-5> 5</a>
</span><span class=lnt id=hl-331-6><a class=lnlinks href=#hl-331-6> 6</a>
</span><span class=lnt id=hl-331-7><a class=lnlinks href=#hl-331-7> 7</a>
</span><span class=lnt id=hl-331-8><a class=lnlinks href=#hl-331-8> 8</a>
</span><span class=lnt id=hl-331-9><a class=lnlinks href=#hl-331-9> 9</a>
</span><span class=lnt id=hl-331-10><a class=lnlinks href=#hl-331-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>sdf</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=s>&#34;1951-04-21&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æœ‰å¾ˆå¤§å‡ ç‡å‡ºç° java.lang.NumberFormatException æˆ–è€…å‡ºç°ä¸æ­£ç¡®çš„æ—¥æœŸè§£æç»“æœï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-332-1><a class=lnlinks href=#hl-332-1> 1</a>
</span><span class=lnt id=hl-332-2><a class=lnlinks href=#hl-332-2> 2</a>
</span><span class=lnt id=hl-332-3><a class=lnlinks href=#hl-332-3> 3</a>
</span><span class=lnt id=hl-332-4><a class=lnlinks href=#hl-332-4> 4</a>
</span><span class=lnt id=hl-332-5><a class=lnlinks href=#hl-332-5> 5</a>
</span><span class=lnt id=hl-332-6><a class=lnlinks href=#hl-332-6> 6</a>
</span><span class=lnt id=hl-332-7><a class=lnlinks href=#hl-332-7> 7</a>
</span><span class=lnt id=hl-332-8><a class=lnlinks href=#hl-332-8> 8</a>
</span><span class=lnt id=hl-332-9><a class=lnlinks href=#hl-332-9> 9</a>
</span><span class=lnt id=hl-332-10><a class=lnlinks href=#hl-332-10>10</a>
</span><span class=lnt id=hl-332-11><a class=lnlinks href=#hl-332-11>11</a>
</span><span class=lnt id=hl-332-12><a class=lnlinks href=#hl-332-12>12</a>
</span><span class=lnt id=hl-332-13><a class=lnlinks href=#hl-332-13>13</a>
</span><span class=lnt id=hl-332-14><a class=lnlinks href=#hl-332-14>14</a>
</span><span class=lnt id=hl-332-15><a class=lnlinks href=#hl-332-15>15</a>
</span><span class=lnt id=hl-332-16><a class=lnlinks href=#hl-332-16>16</a>
</span><span class=lnt id=hl-332-17><a class=lnlinks href=#hl-332-17>17</a>
</span><span class=lnt id=hl-332-18><a class=lnlinks href=#hl-332-18>18</a>
</span><span class=lnt id=hl-332-19><a class=lnlinks href=#hl-332-19>19</a>
</span><span class=lnt id=hl-332-20><a class=lnlinks href=#hl-332-20>20</a>
</span><span class=lnt id=hl-332-21><a class=lnlinks href=#hl-332-21>21</a>
</span><span class=lnt id=hl-332-22><a class=lnlinks href=#hl-332-22>22</a>
</span><span class=lnt id=hl-332-23><a class=lnlinks href=#hl-332-23>23</a>
</span><span class=lnt id=hl-332-24><a class=lnlinks href=#hl-332-24>24</a>
</span><span class=lnt id=hl-332-25><a class=lnlinks href=#hl-332-25>25</a>
</span><span class=lnt id=hl-332-26><a class=lnlinks href=#hl-332-26>26</a>
</span><span class=lnt id=hl-332-27><a class=lnlinks href=#hl-332-27>27</a>
</span><span class=lnt id=hl-332-28><a class=lnlinks href=#hl-332-28>28</a>
</span><span class=lnt id=hl-332-29><a class=lnlinks href=#hl-332-29>29</a>
</span><span class=lnt id=hl-332-30><a class=lnlinks href=#hl-332-30>30</a>
</span><span class=lnt id=hl-332-31><a class=lnlinks href=#hl-332-31>31</a>
</span><span class=lnt id=hl-332-32><a class=lnlinks href=#hl-332-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:10:40.859 <span class=o>[</span>Thread-2<span class=o>]</span> c.TestDateParse - <span class=o>{}</span> 
</span></span><span class=line><span class=cl>java.lang.NumberFormatException: For input string: <span class=s2>&#34;&#34;</span> 
</span></span><span class=line><span class=cl> at java.lang.NumberFormatException.forInputString<span class=o>(</span>NumberFormatException.java:65<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Long.parseLong<span class=o>(</span>Long.java:601<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Long.parseLong<span class=o>(</span>Long.java:631<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DigitList.getLong<span class=o>(</span>DigitList.java:195<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DecimalFormat.parse<span class=o>(</span>DecimalFormat.java:2084<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.SimpleDateFormat.subParse<span class=o>(</span>SimpleDateFormat.java:2162<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.SimpleDateFormat.parse<span class=o>(</span>SimpleDateFormat.java:1514<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DateFormat.parse<span class=o>(</span>DateFormat.java:364<span class=o>)</span> 
</span></span><span class=line><span class=cl> at cn.itcast.n7.TestDateParse.lambda<span class=nv>$test1$0</span><span class=o>(</span>TestDateParse.java:18<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Thread.run<span class=o>(</span>Thread.java:748<span class=o>)</span> 
</span></span><span class=line><span class=cl>19:10:40.859 <span class=o>[</span>Thread-1<span class=o>]</span> c.TestDateParse - <span class=o>{}</span> 
</span></span><span class=line><span class=cl>java.lang.NumberFormatException: empty String 
</span></span><span class=line><span class=cl> at sun.misc.FloatingDecimal.readJavaFormatString<span class=o>(</span>FloatingDecimal.java:1842<span class=o>)</span> 
</span></span><span class=line><span class=cl> at sun.misc.FloatingDecimal.parseDouble<span class=o>(</span>FloatingDecimal.java:110<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Double.parseDouble<span class=o>(</span>Double.java:538<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DigitList.getDouble<span class=o>(</span>DigitList.java:169<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DecimalFormat.parse<span class=o>(</span>DecimalFormat.java:2089<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.SimpleDateFormat.subParse<span class=o>(</span>SimpleDateFormat.java:2162<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.SimpleDateFormat.parse<span class=o>(</span>SimpleDateFormat.java:1514<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.text.DateFormat.parse<span class=o>(</span>DateFormat.java:364<span class=o>)</span> 
</span></span><span class=line><span class=cl> at cn.itcast.n7.TestDateParse.lambda<span class=nv>$test1$0</span><span class=o>(</span>TestDateParse.java:18<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Thread.run<span class=o>(</span>Thread.java:748<span class=o>)</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-8<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-9<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-6<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-4<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-5<span class=o>]</span> c.TestDateParse - Mon Apr <span class=m>21</span> 00:00:00 CST <span class=m>178960645</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-0<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-7<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span> 
</span></span><span class=line><span class=cl>19:10:40.857 <span class=o>[</span>Thread-3<span class=o>]</span> c.TestDateParse - Sat Apr <span class=m>21</span> 00:00:00 CST <span class=m>1951</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=æ€è·¯---åŒæ­¥é”><a href=#%e6%80%9d%e8%b7%af---%e5%90%8c%e6%ad%a5%e9%94%81 class=header-anchor>#</a>
æ€è·¯ - åŒæ­¥é”</h5><p>è¿™æ ·è™½èƒ½è§£å†³é—®é¢˜ï¼Œä½†å¸¦æ¥çš„æ˜¯æ€§èƒ½ä¸Šçš„æŸå¤±ï¼Œå¹¶ä¸ç®—å¾ˆå¥½ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-333-1><a class=lnlinks href=#hl-333-1> 1</a>
</span><span class=lnt id=hl-333-2><a class=lnlinks href=#hl-333-2> 2</a>
</span><span class=lnt id=hl-333-3><a class=lnlinks href=#hl-333-3> 3</a>
</span><span class=lnt id=hl-333-4><a class=lnlinks href=#hl-333-4> 4</a>
</span><span class=lnt id=hl-333-5><a class=lnlinks href=#hl-333-5> 5</a>
</span><span class=lnt id=hl-333-6><a class=lnlinks href=#hl-333-6> 6</a>
</span><span class=lnt id=hl-333-7><a class=lnlinks href=#hl-333-7> 7</a>
</span><span class=lnt id=hl-333-8><a class=lnlinks href=#hl-333-8> 8</a>
</span><span class=lnt id=hl-333-9><a class=lnlinks href=#hl-333-9> 9</a>
</span><span class=lnt id=hl-333-10><a class=lnlinks href=#hl-333-10>10</a>
</span><span class=lnt id=hl-333-11><a class=lnlinks href=#hl-333-11>11</a>
</span><span class=lnt id=hl-333-12><a class=lnlinks href=#hl-333-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>50</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>sdf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>sdf</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=s>&#34;1951-04-21&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=æ€è·¯---ä¸å¯å˜><a href=#%e6%80%9d%e8%b7%af---%e4%b8%8d%e5%8f%af%e5%8f%98 class=header-anchor>#</a>
æ€è·¯ - ä¸å¯å˜</h5><p>å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨ä¸èƒ½å¤Ÿä¿®æ”¹å…¶å†…éƒ¨çŠ¶æ€ï¼ˆå±æ€§ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºä¸å­˜åœ¨å¹¶å‘ä¿®æ”¹å•Šï¼è¿™æ ·çš„å¯¹è±¡åœ¨ Java ä¸­æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚åœ¨ Java 8 åï¼Œæä¾›äº†ä¸€ä¸ªæ–°çš„æ—¥æœŸæ ¼å¼åŒ–ç±»ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-334-1><a class=lnlinks href=#hl-334-1>1</a>
</span><span class=lnt id=hl-334-2><a class=lnlinks href=#hl-334-2>2</a>
</span><span class=lnt id=hl-334-3><a class=lnlinks href=#hl-334-3>3</a>
</span><span class=lnt id=hl-334-4><a class=lnlinks href=#hl-334-4>4</a>
</span><span class=lnt id=hl-334-5><a class=lnlinks href=#hl-334-5>5</a>
</span><span class=lnt id=hl-334-6><a class=lnlinks href=#hl-334-6>6</a>
</span><span class=lnt id=hl-334-7><a class=lnlinks href=#hl-334-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DateTimeFormatter</span><span class=w> </span><span class=n>dtf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DateTimeFormatter</span><span class=p>.</span><span class=na>ofPattern</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LocalDate</span><span class=w> </span><span class=n>date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dtf</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=s>&#34;2018-10-01&#34;</span><span class=p>,</span><span class=w> </span><span class=n>LocalDate</span><span class=p>::</span><span class=n>from</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>date</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹ DateTimeFormatter çš„æ–‡æ¡£ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-335-1><a class=lnlinks href=#hl-335-1>1</a>
</span><span class=lnt id=hl-335-2><a class=lnlinks href=#hl-335-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@implSpec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//This class is immutable and thread-safe.</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸å¯å˜å¯¹è±¡ï¼Œå®é™…æ˜¯å¦ä¸€ç§é¿å…ç«äº‰çš„æ–¹å¼ã€‚</p><h2 id=72-ä¸å¯å˜è®¾è®¡><a href=#72-%e4%b8%8d%e5%8f%af%e5%8f%98%e8%ae%be%e8%ae%a1 class=header-anchor>#</a>
7.2 ä¸å¯å˜è®¾è®¡</h2><h4 id=stringç±»çš„è®¾è®¡><a href=#string%e7%b1%bb%e7%9a%84%e8%ae%be%e8%ae%a1 class=header-anchor>#</a>
Stringç±»çš„è®¾è®¡</h4><p>å¦ä¸€ä¸ªå¤§å®¶æ›´ä¸ºç†Ÿæ‚‰çš„ String ç±»ä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œä»¥å®ƒä¸ºä¾‹ï¼Œè¯´æ˜ä¸€ä¸‹ä¸å¯å˜è®¾è®¡çš„è¦ç´ </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-336-1><a class=lnlinks href=#hl-336-1> 1</a>
</span><span class=lnt id=hl-336-2><a class=lnlinks href=#hl-336-2> 2</a>
</span><span class=lnt id=hl-336-3><a class=lnlinks href=#hl-336-3> 3</a>
</span><span class=lnt id=hl-336-4><a class=lnlinks href=#hl-336-4> 4</a>
</span><span class=lnt id=hl-336-5><a class=lnlinks href=#hl-336-5> 5</a>
</span><span class=lnt id=hl-336-6><a class=lnlinks href=#hl-336-6> 6</a>
</span><span class=lnt id=hl-336-7><a class=lnlinks href=#hl-336-7> 7</a>
</span><span class=lnt id=hl-336-8><a class=lnlinks href=#hl-336-8> 8</a>
</span><span class=lnt id=hl-336-9><a class=lnlinks href=#hl-336-9> 9</a>
</span><span class=lnt id=hl-336-10><a class=lnlinks href=#hl-336-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>String</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>implements</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>Serializable</span><span class=p>,</span><span class=w> </span><span class=n>Comparable</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>CharSequence</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** The value is used for character storage. */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>value</span><span class=o>[]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** Cache the hash code for the string */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=p>;</span><span class=w> </span><span class=c1>// Default to 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯´æ˜ï¼š</p><ul><li>å°†ç±»å£°æ˜ä¸ºfinalï¼Œé¿å…è¢«å¸¦å¤–æ˜Ÿæ–¹æ³•çš„å­ç±»ç»§æ‰¿ï¼Œä»è€Œç ´åäº†ä¸å¯å˜æ€§ã€‚</li><li>å°†å­—ç¬¦æ•°ç»„å£°æ˜ä¸ºfinalï¼Œé¿å…è¢«ä¿®æ”¹</li><li>hashè™½ç„¶ä¸æ˜¯finalçš„ï¼Œä½†æ˜¯å…¶åªæœ‰åœ¨è°ƒç”¨<code>hash()</code>æ–¹æ³•çš„æ—¶å€™æ‰è¢«èµ‹å€¼ï¼Œé™¤æ­¤ä¹‹å¤–å†æ— åˆ«çš„æ–¹æ³•ä¿®æ”¹ã€‚</li></ul><h4 id=final-çš„ä½¿ç”¨><a href=#final-%e7%9a%84%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
final çš„ä½¿ç”¨</h4><p>å‘ç°è¯¥ç±»ã€ç±»ä¸­æ‰€æœ‰å±æ€§éƒ½æ˜¯ final çš„</p><ul><li>å±æ€§ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ä¿®æ”¹</li><li>ç±»ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥ç±»ä¸­çš„æ–¹æ³•ä¸èƒ½è¢«è¦†ç›–ï¼Œé˜²æ­¢å­ç±»æ— æ„é—´ç ´åä¸å¯å˜æ€§</li></ul><h4 id=ä¿æŠ¤æ€§æ‹·è´><a href=#%e4%bf%9d%e6%8a%a4%e6%80%a7%e6%8b%b7%e8%b4%9d class=header-anchor>#</a>
ä¿æŠ¤æ€§æ‹·è´</h4><p>ä½†æœ‰åŒå­¦ä¼šè¯´ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ—¶ï¼Œä¹Ÿæœ‰ä¸€äº›è·Ÿä¿®æ”¹ç›¸å…³çš„æ–¹æ³•å•Šï¼Œæ¯”å¦‚ substring ç­‰ï¼Œé‚£ä¹ˆä¸‹é¢å°±çœ‹ä¸€çœ‹è¿™äº›æ–¹æ³•æ˜¯ å¦‚ä½•å®ç°çš„ï¼Œå°±ä»¥ substring ä¸ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-337-1><a class=lnlinks href=#hl-337-1> 1</a>
</span><span class=lnt id=hl-337-2><a class=lnlinks href=#hl-337-2> 2</a>
</span><span class=lnt id=hl-337-3><a class=lnlinks href=#hl-337-3> 3</a>
</span><span class=lnt id=hl-337-4><a class=lnlinks href=#hl-337-4> 4</a>
</span><span class=lnt id=hl-337-5><a class=lnlinks href=#hl-337-5> 5</a>
</span><span class=lnt id=hl-337-6><a class=lnlinks href=#hl-337-6> 6</a>
</span><span class=lnt id=hl-337-7><a class=lnlinks href=#hl-337-7> 7</a>
</span><span class=lnt id=hl-337-8><a class=lnlinks href=#hl-337-8> 8</a>
</span><span class=lnt id=hl-337-9><a class=lnlinks href=#hl-337-9> 9</a>
</span><span class=lnt id=hl-337-10><a class=lnlinks href=#hl-337-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>substring</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>beginIndex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>beginIndex</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringIndexOutOfBoundsException</span><span class=p>(</span><span class=n>beginIndex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>subLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>beginIndex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>subLen</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringIndexOutOfBoundsException</span><span class=p>(</span><span class=n>subLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>beginIndex</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=k>this</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>beginIndex</span><span class=p>,</span><span class=w> </span><span class=n>subLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å‘ç°å…¶å†…éƒ¨æ˜¯è°ƒç”¨ String çš„æ„é€ æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°å­—ç¬¦ä¸²ï¼Œå†è¿›å…¥è¿™ä¸ªæ„é€ çœ‹çœ‹ï¼Œæ˜¯å¦å¯¹ final char[] value åšå‡º äº†ä¿®æ”¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-338-1><a class=lnlinks href=#hl-338-1> 1</a>
</span><span class=lnt id=hl-338-2><a class=lnlinks href=#hl-338-2> 2</a>
</span><span class=lnt id=hl-338-3><a class=lnlinks href=#hl-338-3> 3</a>
</span><span class=lnt id=hl-338-4><a class=lnlinks href=#hl-338-4> 4</a>
</span><span class=lnt id=hl-338-5><a class=lnlinks href=#hl-338-5> 5</a>
</span><span class=lnt id=hl-338-6><a class=lnlinks href=#hl-338-6> 6</a>
</span><span class=lnt id=hl-338-7><a class=lnlinks href=#hl-338-7> 7</a>
</span><span class=lnt id=hl-338-8><a class=lnlinks href=#hl-338-8> 8</a>
</span><span class=lnt id=hl-338-9><a class=lnlinks href=#hl-338-9> 9</a>
</span><span class=lnt id=hl-338-10><a class=lnlinks href=#hl-338-10>10</a>
</span><span class=lnt id=hl-338-11><a class=lnlinks href=#hl-338-11>11</a>
</span><span class=lnt id=hl-338-12><a class=lnlinks href=#hl-338-12>12</a>
</span><span class=lnt id=hl-338-13><a class=lnlinks href=#hl-338-13>13</a>
</span><span class=lnt id=hl-338-14><a class=lnlinks href=#hl-338-14>14</a>
</span><span class=lnt id=hl-338-15><a class=lnlinks href=#hl-338-15>15</a>
</span><span class=lnt id=hl-338-16><a class=lnlinks href=#hl-338-16>16</a>
</span><span class=lnt id=hl-338-17><a class=lnlinks href=#hl-338-17>17</a>
</span><span class=lnt id=hl-338-18><a class=lnlinks href=#hl-338-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>String</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=n>value</span><span class=o>[]</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>offset</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringIndexOutOfBoundsException</span><span class=p>(</span><span class=n>offset</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringIndexOutOfBoundsException</span><span class=p>(</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>offset</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>offset</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringIndexOutOfBoundsException</span><span class=p>(</span><span class=n>offset</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>copyOfRange</span><span class=p>(</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=o>+</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœå‘ç°ä¹Ÿæ²¡æœ‰ï¼Œæ„é€ æ–°å­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼Œä¼šç”Ÿæˆæ–°çš„ char[] valueï¼Œå¯¹å†…å®¹è¿›è¡Œå¤åˆ¶ ã€‚è¿™ç§é€šè¿‡åˆ›å»ºå‰¯æœ¬å¯¹è±¡æ¥é¿ å…å…±äº«çš„æ‰‹æ®µç§°ä¹‹ä¸ºã€ä¿æŠ¤æ€§æ‹·è´ï¼ˆdefensive copyï¼‰ã€‘</p><h4 id=font-colororangeæ¨¡å¼ä¹‹äº«å…ƒfont><a href=#font-colororange%e6%a8%a1%e5%bc%8f%e4%b9%8b%e4%ba%ab%e5%85%83font class=header-anchor>#</a>
<font color=orange>*æ¨¡å¼ä¹‹äº«å…ƒ</font></h4><h5 id=ç®€ä»‹><a href=#%e7%ae%80%e4%bb%8b class=header-anchor>#</a>
ç®€ä»‹</h5><p><strong>å®šä¹‰</strong> è‹±æ–‡åç§°ï¼šFlyweight pattern. å½“éœ€è¦é‡ç”¨æ•°é‡æœ‰é™çš„åŒä¸€ç±»å¯¹è±¡æ—¶</p><blockquote><p>wikipediaï¼š A flyweight is an object that minimizes memory usage by sharing as much data as possible with other similar objects</p></blockquote><p><strong>å‡ºè‡ª</strong> &ldquo;Gang of Four&rdquo; design patterns</p><p><strong>å½’ç±»</strong> Structual patterns</p><h5 id=ä½“ç°><a href=#%e4%bd%93%e7%8e%b0 class=header-anchor>#</a>
ä½“ç°</h5><p><strong>åŒ…è£…ç±»</strong></p><p>åœ¨JDKä¸­ Booleanï¼ŒByteï¼ŒShortï¼ŒIntegerï¼ŒLongï¼ŒCharacter ç­‰åŒ…è£…ç±»æä¾›äº† valueOf æ–¹æ³•ï¼Œä¾‹å¦‚ Long çš„ valueOf ä¼šç¼“å­˜ -128~127 ä¹‹é—´çš„ Long å¯¹è±¡ï¼Œåœ¨è¿™ä¸ªèŒƒå›´ä¹‹é—´ä¼šé‡ç”¨å¯¹è±¡ï¼Œå¤§äºè¿™ä¸ªèŒƒå›´ï¼Œæ‰ä¼šæ–°å»º Long å¯¹ è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-339-1><a class=lnlinks href=#hl-339-1>1</a>
</span><span class=lnt id=hl-339-2><a class=lnlinks href=#hl-339-2>2</a>
</span><span class=lnt id=hl-339-3><a class=lnlinks href=#hl-339-3>3</a>
</span><span class=lnt id=hl-339-4><a class=lnlinks href=#hl-339-4>4</a>
</span><span class=lnt id=hl-339-5><a class=lnlinks href=#hl-339-5>5</a>
</span><span class=lnt id=hl-339-6><a class=lnlinks href=#hl-339-6>6</a>
</span><span class=lnt id=hl-339-7><a class=lnlinks href=#hl-339-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>valueOf</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>l</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>128</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>l</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=o>-</span><span class=n>128</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>127</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// will cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>LongCache</span><span class=p>.</span><span class=na>cache</span><span class=o>[</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>l</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>offset</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Long</span><span class=p>(</span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong>ï¼š</p><ul><li>Byte, Short, Long ç¼“å­˜çš„èŒƒå›´éƒ½æ˜¯ -128~127</li><li>Character ç¼“å­˜çš„èŒƒå›´æ˜¯ 0~127</li><li>Integerçš„é»˜è®¤èŒƒå›´æ˜¯ -128~127<ul><li>æœ€å°å€¼ä¸èƒ½å˜</li><li>ä½†æœ€å¤§å€¼å¯ä»¥é€šè¿‡è°ƒæ•´è™šæ‹Ÿæœºå‚æ•° <code>-Djava.lang.Integer.IntegerCache.high</code> æ¥æ”¹å˜</li></ul></li><li>Boolean ç¼“å­˜äº† TRUE å’Œ FALSE</li></ul></blockquote><p><strong>String ä¸²æ± </strong>ï¼ˆä¸å¯å˜ã€çº¿ç¨‹å®‰å…¨ï¼‰</p><p>è¯¦è§jvm</p><p><strong>BigDecimal BigInteger</strong>(ä¸å¯å˜ã€çº¿ç¨‹å®‰å…¨)</p><p>ä¸€éƒ¨åˆ†æ•°å­—ä½¿ç”¨äº†äº«å…ƒæ¨¡å¼è¿›è¡Œäº†ç¼“å­˜ã€‚</p><h5 id=æ‰‹åŠ¨å®ç°ä¸€ä¸ªè¿æ¥æ± ><a href=#%e6%89%8b%e5%8a%a8%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e8%bf%9e%e6%8e%a5%e6%b1%a0 class=header-anchor>#</a>
æ‰‹åŠ¨å®ç°ä¸€ä¸ªè¿æ¥æ± </h5><p>ä¾‹å¦‚ï¼šä¸€ä¸ªçº¿ä¸Šå•†åŸåº”ç”¨ï¼ŒQPS è¾¾åˆ°æ•°åƒï¼Œå¦‚æœæ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºå’Œå…³é—­æ•°æ®åº“è¿æ¥ï¼Œæ€§èƒ½ä¼šå—åˆ°æå¤§å½±å“ã€‚ è¿™æ—¶ é¢„å…ˆåˆ›å»ºå¥½ä¸€æ‰¹è¿æ¥ï¼Œæ”¾å…¥è¿æ¥æ± ã€‚ä¸€æ¬¡è¯·æ±‚åˆ°è¾¾åï¼Œä»è¿æ¥æ± è·å–è¿æ¥ï¼Œä½¿ç”¨å®Œæ¯•åå†è¿˜å›è¿æ¥æ± ï¼Œè¿™æ ·æ—¢èŠ‚çº¦ äº†è¿æ¥çš„åˆ›å»ºå’Œå…³é—­æ—¶é—´ï¼Œä¹Ÿå®ç°äº†è¿æ¥çš„é‡ç”¨ï¼Œä¸è‡³äºè®©åºå¤§çš„è¿æ¥æ•°å‹å®æ•°æ®åº“ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-340-1><a class=lnlinks href=#hl-340-1> 1</a>
</span><span class=lnt id=hl-340-2><a class=lnlinks href=#hl-340-2> 2</a>
</span><span class=lnt id=hl-340-3><a class=lnlinks href=#hl-340-3> 3</a>
</span><span class=lnt id=hl-340-4><a class=lnlinks href=#hl-340-4> 4</a>
</span><span class=lnt id=hl-340-5><a class=lnlinks href=#hl-340-5> 5</a>
</span><span class=lnt id=hl-340-6><a class=lnlinks href=#hl-340-6> 6</a>
</span><span class=lnt id=hl-340-7><a class=lnlinks href=#hl-340-7> 7</a>
</span><span class=lnt id=hl-340-8><a class=lnlinks href=#hl-340-8> 8</a>
</span><span class=lnt id=hl-340-9><a class=lnlinks href=#hl-340-9> 9</a>
</span><span class=lnt id=hl-340-10><a class=lnlinks href=#hl-340-10>10</a>
</span><span class=lnt id=hl-340-11><a class=lnlinks href=#hl-340-11>11</a>
</span><span class=lnt id=hl-340-12><a class=lnlinks href=#hl-340-12>12</a>
</span><span class=lnt id=hl-340-13><a class=lnlinks href=#hl-340-13>13</a>
</span><span class=lnt id=hl-340-14><a class=lnlinks href=#hl-340-14>14</a>
</span><span class=lnt id=hl-340-15><a class=lnlinks href=#hl-340-15>15</a>
</span><span class=lnt id=hl-340-16><a class=lnlinks href=#hl-340-16>16</a>
</span><span class=lnt id=hl-340-17><a class=lnlinks href=#hl-340-17>17</a>
</span><span class=lnt id=hl-340-18><a class=lnlinks href=#hl-340-18>18</a>
</span><span class=lnt id=hl-340-19><a class=lnlinks href=#hl-340-19>19</a>
</span><span class=lnt id=hl-340-20><a class=lnlinks href=#hl-340-20>20</a>
</span><span class=lnt id=hl-340-21><a class=lnlinks href=#hl-340-21>21</a>
</span><span class=lnt id=hl-340-22><a class=lnlinks href=#hl-340-22>22</a>
</span><span class=lnt id=hl-340-23><a class=lnlinks href=#hl-340-23>23</a>
</span><span class=lnt id=hl-340-24><a class=lnlinks href=#hl-340-24>24</a>
</span><span class=lnt id=hl-340-25><a class=lnlinks href=#hl-340-25>25</a>
</span><span class=lnt id=hl-340-26><a class=lnlinks href=#hl-340-26>26</a>
</span><span class=lnt id=hl-340-27><a class=lnlinks href=#hl-340-27>27</a>
</span><span class=lnt id=hl-340-28><a class=lnlinks href=#hl-340-28>28</a>
</span><span class=lnt id=hl-340-29><a class=lnlinks href=#hl-340-29>29</a>
</span><span class=lnt id=hl-340-30><a class=lnlinks href=#hl-340-30>30</a>
</span><span class=lnt id=hl-340-31><a class=lnlinks href=#hl-340-31>31</a>
</span><span class=lnt id=hl-340-32><a class=lnlinks href=#hl-340-32>32</a>
</span><span class=lnt id=hl-340-33><a class=lnlinks href=#hl-340-33>33</a>
</span><span class=lnt id=hl-340-34><a class=lnlinks href=#hl-340-34>34</a>
</span><span class=lnt id=hl-340-35><a class=lnlinks href=#hl-340-35>35</a>
</span><span class=lnt id=hl-340-36><a class=lnlinks href=#hl-340-36>36</a>
</span><span class=lnt id=hl-340-37><a class=lnlinks href=#hl-340-37>37</a>
</span><span class=lnt id=hl-340-38><a class=lnlinks href=#hl-340-38>38</a>
</span><span class=lnt id=hl-340-39><a class=lnlinks href=#hl-340-39>39</a>
</span><span class=lnt id=hl-340-40><a class=lnlinks href=#hl-340-40>40</a>
</span><span class=lnt id=hl-340-41><a class=lnlinks href=#hl-340-41>41</a>
</span><span class=lnt id=hl-340-42><a class=lnlinks href=#hl-340-42>42</a>
</span><span class=lnt id=hl-340-43><a class=lnlinks href=#hl-340-43>43</a>
</span><span class=lnt id=hl-340-44><a class=lnlinks href=#hl-340-44>44</a>
</span><span class=lnt id=hl-340-45><a class=lnlinks href=#hl-340-45>45</a>
</span><span class=lnt id=hl-340-46><a class=lnlinks href=#hl-340-46>46</a>
</span><span class=lnt id=hl-340-47><a class=lnlinks href=#hl-340-47>47</a>
</span><span class=lnt id=hl-340-48><a class=lnlinks href=#hl-340-48>48</a>
</span><span class=lnt id=hl-340-49><a class=lnlinks href=#hl-340-49>49</a>
</span><span class=lnt id=hl-340-50><a class=lnlinks href=#hl-340-50>50</a>
</span><span class=lnt id=hl-340-51><a class=lnlinks href=#hl-340-51>51</a>
</span><span class=lnt id=hl-340-52><a class=lnlinks href=#hl-340-52>52</a>
</span><span class=lnt id=hl-340-53><a class=lnlinks href=#hl-340-53>53</a>
</span><span class=lnt id=hl-340-54><a class=lnlinks href=#hl-340-54>54</a>
</span><span class=lnt id=hl-340-55><a class=lnlinks href=#hl-340-55>55</a>
</span><span class=lnt id=hl-340-56><a class=lnlinks href=#hl-340-56>56</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Pool</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1. è¿æ¥æ± å¤§å°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2. è¿æ¥å¯¹è±¡æ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Connection</span><span class=o>[]</span><span class=w> </span><span class=n>connections</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 3. è¿æ¥çŠ¶æ€æ•°ç»„ 0 è¡¨ç¤ºç©ºé—²ï¼Œ 1 è¡¨ç¤ºç¹å¿™</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AtomicIntegerArray</span><span class=w> </span><span class=n>states</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 4. æ„é€ æ–¹æ³•åˆå§‹åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Pool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>poolSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>poolSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>connections</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Connection</span><span class=o>[</span><span class=n>poolSize</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>states</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicIntegerArray</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>poolSize</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MockConnection</span><span class=p>(</span><span class=s>&#34;è¿æ¥&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 5. å€Ÿè¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=nf>borrow</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è·å–ç©ºé—²è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>states</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>states</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;borrow {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;wait...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>this</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 6. å½’è¿˜è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>free</span><span class=p>(</span><span class=n>Connection</span><span class=w> </span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>states</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;free {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>this</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>MockConnection</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å®ç°ç•¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨è¿æ¥æ± ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-341-1><a class=lnlinks href=#hl-341-1> 1</a>
</span><span class=lnt id=hl-341-2><a class=lnlinks href=#hl-341-2> 2</a>
</span><span class=lnt id=hl-341-3><a class=lnlinks href=#hl-341-3> 3</a>
</span><span class=lnt id=hl-341-4><a class=lnlinks href=#hl-341-4> 4</a>
</span><span class=lnt id=hl-341-5><a class=lnlinks href=#hl-341-5> 5</a>
</span><span class=lnt id=hl-341-6><a class=lnlinks href=#hl-341-6> 6</a>
</span><span class=lnt id=hl-341-7><a class=lnlinks href=#hl-341-7> 7</a>
</span><span class=lnt id=hl-341-8><a class=lnlinks href=#hl-341-8> 8</a>
</span><span class=lnt id=hl-341-9><a class=lnlinks href=#hl-341-9> 9</a>
</span><span class=lnt id=hl-341-10><a class=lnlinks href=#hl-341-10>10</a>
</span><span class=lnt id=hl-341-11><a class=lnlinks href=#hl-341-11>11</a>
</span><span class=lnt id=hl-341-12><a class=lnlinks href=#hl-341-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Pool</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Pool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Connection</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>borrow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>1000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pool</span><span class=p>.</span><span class=na>free</span><span class=p>(</span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä»¥ä¸Šå®ç°æ²¡æœ‰è€ƒè™‘ï¼š</p><ul><li>è¿æ¥çš„åŠ¨æ€å¢é•¿ä¸æ”¶ç¼©</li><li>è¿æ¥ä¿æ´»ï¼ˆå¯ç”¨æ€§æ£€æµ‹ï¼‰</li><li>ç­‰å¾…è¶…æ—¶å¤„ç†</li><li>åˆ†å¸ƒå¼ hash</li></ul><p>å¯¹äºå…³ç³»å‹æ•°æ®åº“ï¼Œæœ‰æ¯”è¾ƒæˆç†Ÿçš„è¿æ¥æ± å®ç°ï¼Œä¾‹å¦‚c3p0, druidç­‰ å¯¹äºæ›´é€šç”¨çš„å¯¹è±¡æ± ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨apache commons poolï¼Œä¾‹å¦‚redisè¿æ¥æ± å¯ä»¥å‚è€ƒjedisä¸­å…³äºè¿æ¥æ± çš„å®ç°</p><h4 id=font-colorblue-åŸç†ä¹‹-finalfont><a href=#font-colorblue-%e5%8e%9f%e7%90%86%e4%b9%8b-finalfont class=header-anchor>#</a>
<font color=blue>* åŸç†ä¹‹ final</font></h4><h5 id=è®¾ç½®-final-å˜é‡çš„åŸç†><a href=#%e8%ae%be%e7%bd%ae-final-%e5%8f%98%e9%87%8f%e7%9a%84%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
è®¾ç½® final å˜é‡çš„åŸç†</h5><p>ç†è§£äº† volatile åŸç†ï¼Œå†å¯¹æ¯” final çš„å®ç°å°±æ¯”è¾ƒç®€å•äº†</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-342-1><a class=lnlinks href=#hl-342-1>1</a>
</span><span class=lnt id=hl-342-2><a class=lnlinks href=#hl-342-2>2</a>
</span><span class=lnt id=hl-342-3><a class=lnlinks href=#hl-342-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestFinal</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å­—èŠ‚ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-343-1><a class=lnlinks href=#hl-343-1>1</a>
</span><span class=lnt id=hl-343-2><a class=lnlinks href=#hl-343-2>2</a>
</span><span class=lnt id=hl-343-3><a class=lnlinks href=#hl-343-3>3</a>
</span><span class=lnt id=hl-343-4><a class=lnlinks href=#hl-343-4>4</a>
</span><span class=lnt id=hl-343-5><a class=lnlinks href=#hl-343-5>5</a>
</span><span class=lnt id=hl-343-6><a class=lnlinks href=#hl-343-6>6</a>
</span><span class=lnt id=hl-343-7><a class=lnlinks href=#hl-343-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>0: aload_0
</span></span><span class=line><span class=cl>1: invokespecial <span class=c1>#1 // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class=line><span class=cl>4: aload_0
</span></span><span class=line><span class=cl>5: bipush <span class=m>20</span>
</span></span><span class=line><span class=cl>7: putfield <span class=c1>#2 // Field a:I</span>
</span></span><span class=line><span class=cl> &lt;-- å†™å±éšœ
</span></span><span class=line><span class=cl>10: <span class=k>return</span>
</span></span></code></pre></td></tr></table></div></div><p>å‘ç° final å˜é‡çš„èµ‹å€¼ä¹Ÿä¼šé€šè¿‡ putfield æŒ‡ä»¤æ¥å®Œæˆï¼ŒåŒæ ·åœ¨è¿™æ¡æŒ‡ä»¤ä¹‹åä¹Ÿä¼šåŠ å…¥å†™å±éšœï¼Œè¿™æ ·å¯¹finalå˜é‡çš„å†™å…¥ä¸ä¼šé‡æ’åºåˆ°æ„é€ æ–¹æ³•ä¹‹å¤–ï¼Œä¿è¯åœ¨å…¶å®ƒçº¿ç¨‹è¯»åˆ° å®ƒçš„å€¼æ—¶ä¸ä¼šå‡ºç°ä¸º 0 çš„æƒ…å†µã€‚æ™®é€šå˜é‡ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹äº†ã€‚</p><h5 id=è¯»å–finalå˜é‡åŸç†><a href=#%e8%af%bb%e5%8f%96final%e5%8f%98%e9%87%8f%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
è¯»å–finalå˜é‡åŸç†</h5><p>æœ‰ä»¥ä¸‹ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-344-1><a class=lnlinks href=#hl-344-1> 1</a>
</span><span class=lnt id=hl-344-2><a class=lnlinks href=#hl-344-2> 2</a>
</span><span class=lnt id=hl-344-3><a class=lnlinks href=#hl-344-3> 3</a>
</span><span class=lnt id=hl-344-4><a class=lnlinks href=#hl-344-4> 4</a>
</span><span class=lnt id=hl-344-5><a class=lnlinks href=#hl-344-5> 5</a>
</span><span class=lnt id=hl-344-6><a class=lnlinks href=#hl-344-6> 6</a>
</span><span class=lnt id=hl-344-7><a class=lnlinks href=#hl-344-7> 7</a>
</span><span class=lnt id=hl-344-8><a class=lnlinks href=#hl-344-8> 8</a>
</span><span class=lnt id=hl-344-9><a class=lnlinks href=#hl-344-9> 9</a>
</span><span class=lnt id=hl-344-10><a class=lnlinks href=#hl-344-10>10</a>
</span><span class=lnt id=hl-344-11><a class=lnlinks href=#hl-344-11>11</a>
</span><span class=lnt id=hl-344-12><a class=lnlinks href=#hl-344-12>12</a>
</span><span class=lnt id=hl-344-13><a class=lnlinks href=#hl-344-13>13</a>
</span><span class=lnt id=hl-344-14><a class=lnlinks href=#hl-344-14>14</a>
</span><span class=lnt id=hl-344-15><a class=lnlinks href=#hl-344-15>15</a>
</span><span class=lnt id=hl-344-16><a class=lnlinks href=#hl-344-16>16</a>
</span><span class=lnt id=hl-344-17><a class=lnlinks href=#hl-344-17>17</a>
</span><span class=lnt id=hl-344-18><a class=lnlinks href=#hl-344-18>18</a>
</span><span class=lnt id=hl-344-19><a class=lnlinks href=#hl-344-19>19</a>
</span><span class=lnt id=hl-344-20><a class=lnlinks href=#hl-344-20>20</a>
</span><span class=lnt id=hl-344-21><a class=lnlinks href=#hl-344-21>21</a>
</span><span class=lnt id=hl-344-22><a class=lnlinks href=#hl-344-22>22</a>
</span><span class=lnt id=hl-344-23><a class=lnlinks href=#hl-344-23>23</a>
</span><span class=lnt id=hl-344-24><a class=lnlinks href=#hl-344-24>24</a>
</span><span class=lnt id=hl-344-25><a class=lnlinks href=#hl-344-25>25</a>
</span><span class=lnt id=hl-344-26><a class=lnlinks href=#hl-344-26>26</a>
</span><span class=lnt id=hl-344-27><a class=lnlinks href=#hl-344-27>27</a>
</span><span class=lnt id=hl-344-28><a class=lnlinks href=#hl-344-28>28</a>
</span><span class=lnt id=hl-344-29><a class=lnlinks href=#hl-344-29>29</a>
</span><span class=lnt id=hl-344-30><a class=lnlinks href=#hl-344-30>30</a>
</span><span class=lnt id=hl-344-31><a class=lnlinks href=#hl-344-31>31</a>
</span><span class=lnt id=hl-344-32><a class=lnlinks href=#hl-344-32>32</a>
</span><span class=lnt id=hl-344-33><a class=lnlinks href=#hl-344-33>33</a>
</span><span class=lnt id=hl-344-34><a class=lnlinks href=#hl-344-34>34</a>
</span><span class=lnt id=hl-344-35><a class=lnlinks href=#hl-344-35>35</a>
</span><span class=lnt id=hl-344-36><a class=lnlinks href=#hl-344-36>36</a>
</span><span class=lnt id=hl-344-37><a class=lnlinks href=#hl-344-37>37</a>
</span><span class=lnt id=hl-344-38><a class=lnlinks href=#hl-344-38>38</a>
</span><span class=lnt id=hl-344-39><a class=lnlinks href=#hl-344-39>39</a>
</span><span class=lnt id=hl-344-40><a class=lnlinks href=#hl-344-40>40</a>
</span><span class=lnt id=hl-344-41><a class=lnlinks href=#hl-344-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestFinal</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>A</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>B</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Short</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=o>+</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>30</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>30</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>class</span> <span class=nc>Task</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>d</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Task</span><span class=p>()).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UseFinal1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>TestFinal</span><span class=p>.</span><span class=na>A</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>TestFinal</span><span class=p>.</span><span class=na>B</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TestFinal</span><span class=p>().</span><span class=na>a</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TestFinal</span><span class=p>().</span><span class=na>b</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>TestFinal</span><span class=p>().</span><span class=na>test1</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>UseFinal2</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>TestFinal</span><span class=p>.</span><span class=na>A</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åç¼–è¯‘UseFinal1ä¸­çš„testæ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-345-1><a class=lnlinks href=#hl-345-1> 1</a>
</span><span class=lnt id=hl-345-2><a class=lnlinks href=#hl-345-2> 2</a>
</span><span class=lnt id=hl-345-3><a class=lnlinks href=#hl-345-3> 3</a>
</span><span class=lnt id=hl-345-4><a class=lnlinks href=#hl-345-4> 4</a>
</span><span class=lnt id=hl-345-5><a class=lnlinks href=#hl-345-5> 5</a>
</span><span class=lnt id=hl-345-6><a class=lnlinks href=#hl-345-6> 6</a>
</span><span class=lnt id=hl-345-7><a class=lnlinks href=#hl-345-7> 7</a>
</span><span class=lnt id=hl-345-8><a class=lnlinks href=#hl-345-8> 8</a>
</span><span class=lnt id=hl-345-9><a class=lnlinks href=#hl-345-9> 9</a>
</span><span class=lnt id=hl-345-10><a class=lnlinks href=#hl-345-10>10</a>
</span><span class=lnt id=hl-345-11><a class=lnlinks href=#hl-345-11>11</a>
</span><span class=lnt id=hl-345-12><a class=lnlinks href=#hl-345-12>12</a>
</span><span class=lnt id=hl-345-13><a class=lnlinks href=#hl-345-13>13</a>
</span><span class=lnt id=hl-345-14><a class=lnlinks href=#hl-345-14>14</a>
</span><span class=lnt id=hl-345-15><a class=lnlinks href=#hl-345-15>15</a>
</span><span class=lnt id=hl-345-16><a class=lnlinks href=#hl-345-16>16</a>
</span><span class=lnt id=hl-345-17><a class=lnlinks href=#hl-345-17>17</a>
</span><span class=lnt id=hl-345-18><a class=lnlinks href=#hl-345-18>18</a>
</span><span class=lnt id=hl-345-19><a class=lnlinks href=#hl-345-19>19</a>
</span><span class=lnt id=hl-345-20><a class=lnlinks href=#hl-345-20>20</a>
</span><span class=lnt id=hl-345-21><a class=lnlinks href=#hl-345-21>21</a>
</span><span class=lnt id=hl-345-22><a class=lnlinks href=#hl-345-22>22</a>
</span><span class=lnt id=hl-345-23><a class=lnlinks href=#hl-345-23>23</a>
</span><span class=lnt id=hl-345-24><a class=lnlinks href=#hl-345-24>24</a>
</span><span class=lnt id=hl-345-25><a class=lnlinks href=#hl-345-25>25</a>
</span><span class=lnt id=hl-345-26><a class=lnlinks href=#hl-345-26>26</a>
</span><span class=lnt id=hl-345-27><a class=lnlinks href=#hl-345-27>27</a>
</span><span class=lnt id=hl-345-28><a class=lnlinks href=#hl-345-28>28</a>
</span><span class=lnt id=hl-345-29><a class=lnlinks href=#hl-345-29>29</a>
</span><span class=lnt id=hl-345-30><a class=lnlinks href=#hl-345-30>30</a>
</span><span class=lnt id=hl-345-31><a class=lnlinks href=#hl-345-31>31</a>
</span><span class=lnt id=hl-345-32><a class=lnlinks href=#hl-345-32>32</a>
</span><span class=lnt id=hl-345-33><a class=lnlinks href=#hl-345-33>33</a>
</span><span class=lnt id=hl-345-34><a class=lnlinks href=#hl-345-34>34</a>
</span><span class=lnt id=hl-345-35><a class=lnlinks href=#hl-345-35>35</a>
</span><span class=lnt id=hl-345-36><a class=lnlinks href=#hl-345-36>36</a>
</span><span class=lnt id=hl-345-37><a class=lnlinks href=#hl-345-37>37</a>
</span><span class=lnt id=hl-345-38><a class=lnlinks href=#hl-345-38>38</a>
</span><span class=lnt id=hl-345-39><a class=lnlinks href=#hl-345-39>39</a>
</span><span class=lnt id=hl-345-40><a class=lnlinks href=#hl-345-40>40</a>
</span><span class=lnt id=hl-345-41><a class=lnlinks href=#hl-345-41>41</a>
</span><span class=lnt id=hl-345-42><a class=lnlinks href=#hl-345-42>42</a>
</span><span class=lnt id=hl-345-43><a class=lnlinks href=#hl-345-43>43</a>
</span><span class=lnt id=hl-345-44><a class=lnlinks href=#hl-345-44>44</a>
</span><span class=lnt id=hl-345-45><a class=lnlinks href=#hl-345-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>31</span><span class=w> </span><span class=n>L0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GETSTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BIPUSH</span><span class=w> </span><span class=n>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>.</span><span class=na>println</span><span class=w> </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>32</span><span class=w> </span><span class=n>L1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GETSTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LDC</span><span class=w> </span><span class=n>32768</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>.</span><span class=na>println</span><span class=w> </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>33</span><span class=w> </span><span class=n>L2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GETSTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NEW</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DUP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKESPECIAL</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=p>.</span><span class=o>&lt;</span><span class=n>init</span><span class=o>&gt;</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Object</span><span class=p>.</span><span class=na>getClass</span><span class=w> </span><span class=p>()</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Class</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>POP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BIPUSH</span><span class=w> </span><span class=n>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>.</span><span class=na>println</span><span class=w> </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>34</span><span class=w> </span><span class=n>L3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GETSTATIC</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Ljava</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NEW</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DUP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKESPECIAL</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=p>.</span><span class=o>&lt;</span><span class=n>init</span><span class=o>&gt;</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Object</span><span class=p>.</span><span class=na>getClass</span><span class=w> </span><span class=p>()</span><span class=n>Ljava</span><span class=o>/</span><span class=n>lang</span><span class=o>/</span><span class=n>Class</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>POP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LDC</span><span class=w> </span><span class=n>2147483647</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>java</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>PrintStream</span><span class=p>.</span><span class=na>println</span><span class=w> </span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>35</span><span class=w> </span><span class=n>L4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NEW</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DUP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKESPECIAL</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=p>.</span><span class=o>&lt;</span><span class=n>init</span><span class=o>&gt;</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INVOKEVIRTUAL</span><span class=w> </span><span class=n>cn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>TestFinal</span><span class=p>.</span><span class=na>test1</span><span class=w> </span><span class=p>()</span><span class=n>V</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LINENUMBER</span><span class=w> </span><span class=n>36</span><span class=w> </span><span class=n>L5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RETURN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>L6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LOCALVARIABLE</span><span class=w> </span><span class=k>this</span><span class=w> </span><span class=n>Lcn</span><span class=o>/</span><span class=n>itcast</span><span class=o>/</span><span class=n>n5</span><span class=o>/</span><span class=n>UseFinal1</span><span class=p>;</span><span class=w> </span><span class=n>L0</span><span class=w> </span><span class=n>L6</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MAXSTACK</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MAXLOCALS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹è§ï¼Œjvmå¯¹finalå˜é‡çš„è®¿é—®åšå‡ºäº†ä¼˜åŒ–ï¼šå¦ä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•è°ƒç”¨finalå˜é‡æ˜¯ï¼Œä¸æ˜¯ä»finalå˜é‡æ‰€åœ¨ç±»ä¸­è·å–ï¼ˆå…±äº«å†…å­˜ï¼‰ï¼Œè€Œæ˜¯ç›´æ¥å¤åˆ¶ä¸€ä»½åˆ°æ–¹æ³•æ ˆæ ˆå¸§ä¸­çš„æ“ä½œæ•°æ ˆä¸­ï¼ˆå·¥ä½œå†…å­˜ï¼‰ï¼Œè¿™æ ·å¯ä»¥æå‡æ•ˆç‡ï¼Œæ˜¯ä¸€ç§ä¼˜åŒ–ã€‚</p><p>æ€»ç»“ï¼š</p><ul><li>å¯¹äºè¾ƒå°çš„static finalå˜é‡ï¼šå¤åˆ¶ä¸€ä»½åˆ°æ“ä½œæ•°æ ˆä¸­</li><li>å¯¹äºè¾ƒå¤§çš„static finalå˜é‡ï¼šå¤åˆ¶ä¸€ä»½åˆ°å½“å‰ç±»çš„å¸¸é‡æ± ä¸­</li><li>å¯¹äºéé™æ€finalå˜é‡ï¼Œä¼˜åŒ–åŒä¸Šã€‚</li></ul><h5 id=finalæ€»ç»“><a href=#final%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
finalæ€»ç»“</h5><p><strong>finalå…³é”®å­—çš„å¥½å¤„ï¼š</strong></p><p>ï¼ˆ1ï¼‰finalå…³é”®å­—æé«˜äº†æ€§èƒ½ã€‚JVMå’ŒJavaåº”ç”¨éƒ½ä¼šç¼“å­˜finalå˜é‡ã€‚</p><p>ï¼ˆ2ï¼‰finalå˜é‡å¯ä»¥å®‰å…¨çš„åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¿›è¡Œå…±äº«ï¼Œè€Œä¸éœ€è¦é¢å¤–çš„åŒæ­¥å¼€é”€ã€‚</p><p>ï¼ˆ3ï¼‰ä½¿ç”¨finalå…³é”®å­—ï¼ŒJVMä¼šå¯¹æ–¹æ³•ã€å˜é‡åŠç±»è¿›è¡Œä¼˜åŒ–ã€‚</p><p><strong>å…³äºfinalçš„é‡è¦çŸ¥è¯†ç‚¹</strong></p><p>1ã€finalå…³é”®å­—å¯ä»¥ç”¨äºæˆå‘˜å˜é‡ã€æœ¬åœ°å˜é‡ã€æ–¹æ³•ä»¥åŠç±»ã€‚</p><p>2ã€finalæˆå‘˜å˜é‡å¿…é¡»åœ¨å£°æ˜çš„æ—¶å€™åˆå§‹åŒ–æˆ–è€…åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–ï¼Œå¦åˆ™å°±ä¼šæŠ¥ç¼–è¯‘é”™è¯¯ã€‚</p><p>3ã€ä½ ä¸èƒ½å¤Ÿå¯¹finalå˜é‡å†æ¬¡èµ‹å€¼ã€‚</p><p>4ã€æœ¬åœ°å˜é‡å¿…é¡»åœ¨å£°æ˜æ—¶èµ‹å€¼ã€‚</p><p>5ã€åœ¨åŒ¿åç±»ä¸­æ‰€æœ‰å˜é‡éƒ½å¿…é¡»æ˜¯finalå˜é‡ã€‚</p><p>6ã€finalæ–¹æ³•ä¸èƒ½è¢«é‡å†™ã€‚</p><p>7ã€finalç±»ä¸èƒ½è¢«ç»§æ‰¿ã€‚</p><p>8ã€finalå…³é”®å­—ä¸åŒäºfinallyå…³é”®å­—ï¼Œåè€…ç”¨äºå¼‚å¸¸å¤„ç†ã€‚</p><p>9ã€finalå…³é”®å­—å®¹æ˜“ä¸finalize()æ–¹æ³•ææ··ï¼Œåè€…æ˜¯åœ¨Objectç±»ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œæ˜¯åœ¨åƒåœ¾å›æ”¶ä¹‹å‰è¢«JVMè°ƒç”¨çš„æ–¹æ³•ã€‚</p><p>10ã€æ¥å£ä¸­å£°æ˜çš„æ‰€æœ‰å˜é‡æœ¬èº«æ˜¯finalçš„ã€‚</p><p>11ã€finalå’Œabstractè¿™ä¸¤ä¸ªå…³é”®å­—æ˜¯åç›¸å…³çš„ï¼Œfinalç±»å°±ä¸å¯èƒ½æ˜¯abstractçš„ã€‚</p><p>12ã€finalæ–¹æ³•åœ¨ç¼–è¯‘é˜¶æ®µç»‘å®šï¼Œç§°ä¸ºé™æ€ç»‘å®š(static binding)ã€‚</p><p>13ã€æ²¡æœ‰åœ¨å£°æ˜æ—¶åˆå§‹åŒ–finalå˜é‡çš„ç§°ä¸ºç©ºç™½finalå˜é‡(blank final variable)ï¼Œå®ƒä»¬å¿…é¡»åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–ï¼Œæˆ–è€…è°ƒç”¨this()åˆå§‹åŒ–ã€‚ä¸è¿™ä¹ˆåšçš„è¯ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™â€œfinalå˜é‡(å˜é‡å)éœ€è¦è¿›è¡Œåˆå§‹åŒ–â€ã€‚</p><p>14ã€å°†ç±»ã€æ–¹æ³•ã€å˜é‡å£°æ˜ä¸ºfinalèƒ½å¤Ÿæé«˜æ€§èƒ½ï¼Œè¿™æ ·JVMå°±æœ‰æœºä¼šè¿›è¡Œä¼°è®¡ï¼Œç„¶åä¼˜åŒ–ã€‚</p><p>15ã€æŒ‰ç…§Javaä»£ç æƒ¯ä¾‹ï¼Œfinalå˜é‡å°±æ˜¯å¸¸é‡ï¼Œè€Œä¸”é€šå¸¸å¸¸é‡åè¦å¤§å†™ã€‚</p><p>16ã€å¯¹äºé›†åˆå¯¹è±¡å£°æ˜ä¸ºfinalæŒ‡çš„æ˜¯å¼•ç”¨ä¸èƒ½è¢«æ›´æ”¹ï¼Œä½†æ˜¯ä½ å¯ä»¥å‘å…¶ä¸­å¢åŠ ï¼Œåˆ é™¤æˆ–è€…æ”¹å˜å†…å®¹ã€‚</p><blockquote><p>å‚è€ƒé“¾æ¥ï¼š<a class=link href=https://www.php.cn/java-article-413390.html target=_blank rel=noopener>Javaä¸­finalå®ç°åŸç†çš„æ·±å…¥åˆ†æï¼ˆé™„ç¤ºä¾‹ï¼‰-javaæ•™ç¨‹-PHPä¸­æ–‡ç½‘
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></blockquote><h2 id=73-æ— çŠ¶æ€><a href=#73-%e6%97%a0%e7%8a%b6%e6%80%81 class=header-anchor>#</a>
7.3 æ— çŠ¶æ€</h2><p>åœ¨ web é˜¶æ®µå­¦ä¹ æ—¶ï¼Œè®¾è®¡ Servlet æ—¶ä¸ºäº†ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ï¼Œéƒ½ä¼šæœ‰è¿™æ ·çš„å»ºè®®ï¼Œä¸è¦ä¸º Servlet è®¾ç½®æˆå‘˜å˜é‡ï¼Œè¿™ ç§æ²¡æœ‰ä»»ä½•æˆå‘˜å˜é‡çš„ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ ã€‚</p><blockquote><p>å› ä¸ºæˆå‘˜å˜é‡ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥ç§°ä¸ºçŠ¶æ€ä¿¡æ¯ï¼Œå› æ­¤æ²¡æœ‰æˆå‘˜å˜é‡å°±ç§°ä¹‹ä¸ºã€æ— çŠ¶æ€ã€‘</p></blockquote><h1 id=8å…±äº«æ¨¡å‹ä¹‹å·¥å…·><a href=#8%e5%85%b1%e4%ba%ab%e6%a8%a1%e5%9e%8b%e4%b9%8b%e5%b7%a5%e5%85%b7 class=header-anchor>#</a>
8.å…±äº«æ¨¡å‹ä¹‹å·¥å…·</h1><h2 id=çº¿ç¨‹æ± ><a href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0 class=header-anchor>#</a>
çº¿ç¨‹æ± </h2><h4 id=è‡ªå®šä¹‰çº¿ç¨‹æ± ><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e7%ba%bf%e7%a8%8b%e6%b1%a0 class=header-anchor>#</a>
è‡ªå®šä¹‰çº¿ç¨‹æ± </h4><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220311170716250.png width=900 height=600 loading=lazy decoding=async alt=image-20220311170716250 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æ­¥éª¤1ï¼šè‡ªå®šä¹‰æ‹’ç»ç­–ç•¥æ¥å£</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-346-1><a class=lnlinks href=#hl-346-1>1</a>
</span><span class=lnt id=hl-346-2><a class=lnlinks href=#hl-346-2>2</a>
</span><span class=lnt id=hl-346-3><a class=lnlinks href=#hl-346-3>3</a>
</span><span class=lnt id=hl-346-4><a class=lnlinks href=#hl-346-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@FunctionalInterface</span><span class=w> </span><span class=c1>//æ‹’ç»ç­–ç•¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>interface</span> <span class=nc>RejectPolicy</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>reject</span><span class=p>(</span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=p>,</span><span class=n>T</span><span class=w> </span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ­¥éª¤2ï¼šè‡ªå®šä¹‰ä»»åŠ¡é˜Ÿåˆ—</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-347-1><a class=lnlinks href=#hl-347-1>  1</a>
</span><span class=lnt id=hl-347-2><a class=lnlinks href=#hl-347-2>  2</a>
</span><span class=lnt id=hl-347-3><a class=lnlinks href=#hl-347-3>  3</a>
</span><span class=lnt id=hl-347-4><a class=lnlinks href=#hl-347-4>  4</a>
</span><span class=lnt id=hl-347-5><a class=lnlinks href=#hl-347-5>  5</a>
</span><span class=lnt id=hl-347-6><a class=lnlinks href=#hl-347-6>  6</a>
</span><span class=lnt id=hl-347-7><a class=lnlinks href=#hl-347-7>  7</a>
</span><span class=lnt id=hl-347-8><a class=lnlinks href=#hl-347-8>  8</a>
</span><span class=lnt id=hl-347-9><a class=lnlinks href=#hl-347-9>  9</a>
</span><span class=lnt id=hl-347-10><a class=lnlinks href=#hl-347-10> 10</a>
</span><span class=lnt id=hl-347-11><a class=lnlinks href=#hl-347-11> 11</a>
</span><span class=lnt id=hl-347-12><a class=lnlinks href=#hl-347-12> 12</a>
</span><span class=lnt id=hl-347-13><a class=lnlinks href=#hl-347-13> 13</a>
</span><span class=lnt id=hl-347-14><a class=lnlinks href=#hl-347-14> 14</a>
</span><span class=lnt id=hl-347-15><a class=lnlinks href=#hl-347-15> 15</a>
</span><span class=lnt id=hl-347-16><a class=lnlinks href=#hl-347-16> 16</a>
</span><span class=lnt id=hl-347-17><a class=lnlinks href=#hl-347-17> 17</a>
</span><span class=lnt id=hl-347-18><a class=lnlinks href=#hl-347-18> 18</a>
</span><span class=lnt id=hl-347-19><a class=lnlinks href=#hl-347-19> 19</a>
</span><span class=lnt id=hl-347-20><a class=lnlinks href=#hl-347-20> 20</a>
</span><span class=lnt id=hl-347-21><a class=lnlinks href=#hl-347-21> 21</a>
</span><span class=lnt id=hl-347-22><a class=lnlinks href=#hl-347-22> 22</a>
</span><span class=lnt id=hl-347-23><a class=lnlinks href=#hl-347-23> 23</a>
</span><span class=lnt id=hl-347-24><a class=lnlinks href=#hl-347-24> 24</a>
</span><span class=lnt id=hl-347-25><a class=lnlinks href=#hl-347-25> 25</a>
</span><span class=lnt id=hl-347-26><a class=lnlinks href=#hl-347-26> 26</a>
</span><span class=lnt id=hl-347-27><a class=lnlinks href=#hl-347-27> 27</a>
</span><span class=lnt id=hl-347-28><a class=lnlinks href=#hl-347-28> 28</a>
</span><span class=lnt id=hl-347-29><a class=lnlinks href=#hl-347-29> 29</a>
</span><span class=lnt id=hl-347-30><a class=lnlinks href=#hl-347-30> 30</a>
</span><span class=lnt id=hl-347-31><a class=lnlinks href=#hl-347-31> 31</a>
</span><span class=lnt id=hl-347-32><a class=lnlinks href=#hl-347-32> 32</a>
</span><span class=lnt id=hl-347-33><a class=lnlinks href=#hl-347-33> 33</a>
</span><span class=lnt id=hl-347-34><a class=lnlinks href=#hl-347-34> 34</a>
</span><span class=lnt id=hl-347-35><a class=lnlinks href=#hl-347-35> 35</a>
</span><span class=lnt id=hl-347-36><a class=lnlinks href=#hl-347-36> 36</a>
</span><span class=lnt id=hl-347-37><a class=lnlinks href=#hl-347-37> 37</a>
</span><span class=lnt id=hl-347-38><a class=lnlinks href=#hl-347-38> 38</a>
</span><span class=lnt id=hl-347-39><a class=lnlinks href=#hl-347-39> 39</a>
</span><span class=lnt id=hl-347-40><a class=lnlinks href=#hl-347-40> 40</a>
</span><span class=lnt id=hl-347-41><a class=lnlinks href=#hl-347-41> 41</a>
</span><span class=lnt id=hl-347-42><a class=lnlinks href=#hl-347-42> 42</a>
</span><span class=lnt id=hl-347-43><a class=lnlinks href=#hl-347-43> 43</a>
</span><span class=lnt id=hl-347-44><a class=lnlinks href=#hl-347-44> 44</a>
</span><span class=lnt id=hl-347-45><a class=lnlinks href=#hl-347-45> 45</a>
</span><span class=lnt id=hl-347-46><a class=lnlinks href=#hl-347-46> 46</a>
</span><span class=lnt id=hl-347-47><a class=lnlinks href=#hl-347-47> 47</a>
</span><span class=lnt id=hl-347-48><a class=lnlinks href=#hl-347-48> 48</a>
</span><span class=lnt id=hl-347-49><a class=lnlinks href=#hl-347-49> 49</a>
</span><span class=lnt id=hl-347-50><a class=lnlinks href=#hl-347-50> 50</a>
</span><span class=lnt id=hl-347-51><a class=lnlinks href=#hl-347-51> 51</a>
</span><span class=lnt id=hl-347-52><a class=lnlinks href=#hl-347-52> 52</a>
</span><span class=lnt id=hl-347-53><a class=lnlinks href=#hl-347-53> 53</a>
</span><span class=lnt id=hl-347-54><a class=lnlinks href=#hl-347-54> 54</a>
</span><span class=lnt id=hl-347-55><a class=lnlinks href=#hl-347-55> 55</a>
</span><span class=lnt id=hl-347-56><a class=lnlinks href=#hl-347-56> 56</a>
</span><span class=lnt id=hl-347-57><a class=lnlinks href=#hl-347-57> 57</a>
</span><span class=lnt id=hl-347-58><a class=lnlinks href=#hl-347-58> 58</a>
</span><span class=lnt id=hl-347-59><a class=lnlinks href=#hl-347-59> 59</a>
</span><span class=lnt id=hl-347-60><a class=lnlinks href=#hl-347-60> 60</a>
</span><span class=lnt id=hl-347-61><a class=lnlinks href=#hl-347-61> 61</a>
</span><span class=lnt id=hl-347-62><a class=lnlinks href=#hl-347-62> 62</a>
</span><span class=lnt id=hl-347-63><a class=lnlinks href=#hl-347-63> 63</a>
</span><span class=lnt id=hl-347-64><a class=lnlinks href=#hl-347-64> 64</a>
</span><span class=lnt id=hl-347-65><a class=lnlinks href=#hl-347-65> 65</a>
</span><span class=lnt id=hl-347-66><a class=lnlinks href=#hl-347-66> 66</a>
</span><span class=lnt id=hl-347-67><a class=lnlinks href=#hl-347-67> 67</a>
</span><span class=lnt id=hl-347-68><a class=lnlinks href=#hl-347-68> 68</a>
</span><span class=lnt id=hl-347-69><a class=lnlinks href=#hl-347-69> 69</a>
</span><span class=lnt id=hl-347-70><a class=lnlinks href=#hl-347-70> 70</a>
</span><span class=lnt id=hl-347-71><a class=lnlinks href=#hl-347-71> 71</a>
</span><span class=lnt id=hl-347-72><a class=lnlinks href=#hl-347-72> 72</a>
</span><span class=lnt id=hl-347-73><a class=lnlinks href=#hl-347-73> 73</a>
</span><span class=lnt id=hl-347-74><a class=lnlinks href=#hl-347-74> 74</a>
</span><span class=lnt id=hl-347-75><a class=lnlinks href=#hl-347-75> 75</a>
</span><span class=lnt id=hl-347-76><a class=lnlinks href=#hl-347-76> 76</a>
</span><span class=lnt id=hl-347-77><a class=lnlinks href=#hl-347-77> 77</a>
</span><span class=lnt id=hl-347-78><a class=lnlinks href=#hl-347-78> 78</a>
</span><span class=lnt id=hl-347-79><a class=lnlinks href=#hl-347-79> 79</a>
</span><span class=lnt id=hl-347-80><a class=lnlinks href=#hl-347-80> 80</a>
</span><span class=lnt id=hl-347-81><a class=lnlinks href=#hl-347-81> 81</a>
</span><span class=lnt id=hl-347-82><a class=lnlinks href=#hl-347-82> 82</a>
</span><span class=lnt id=hl-347-83><a class=lnlinks href=#hl-347-83> 83</a>
</span><span class=lnt id=hl-347-84><a class=lnlinks href=#hl-347-84> 84</a>
</span><span class=lnt id=hl-347-85><a class=lnlinks href=#hl-347-85> 85</a>
</span><span class=lnt id=hl-347-86><a class=lnlinks href=#hl-347-86> 86</a>
</span><span class=lnt id=hl-347-87><a class=lnlinks href=#hl-347-87> 87</a>
</span><span class=lnt id=hl-347-88><a class=lnlinks href=#hl-347-88> 88</a>
</span><span class=lnt id=hl-347-89><a class=lnlinks href=#hl-347-89> 89</a>
</span><span class=lnt id=hl-347-90><a class=lnlinks href=#hl-347-90> 90</a>
</span><span class=lnt id=hl-347-91><a class=lnlinks href=#hl-347-91> 91</a>
</span><span class=lnt id=hl-347-92><a class=lnlinks href=#hl-347-92> 92</a>
</span><span class=lnt id=hl-347-93><a class=lnlinks href=#hl-347-93> 93</a>
</span><span class=lnt id=hl-347-94><a class=lnlinks href=#hl-347-94> 94</a>
</span><span class=lnt id=hl-347-95><a class=lnlinks href=#hl-347-95> 95</a>
</span><span class=lnt id=hl-347-96><a class=lnlinks href=#hl-347-96> 96</a>
</span><span class=lnt id=hl-347-97><a class=lnlinks href=#hl-347-97> 97</a>
</span><span class=lnt id=hl-347-98><a class=lnlinks href=#hl-347-98> 98</a>
</span><span class=lnt id=hl-347-99><a class=lnlinks href=#hl-347-99> 99</a>
</span><span class=lnt id=hl-347-100><a class=lnlinks href=#hl-347-100>100</a>
</span><span class=lnt id=hl-347-101><a class=lnlinks href=#hl-347-101>101</a>
</span><span class=lnt id=hl-347-102><a class=lnlinks href=#hl-347-102>102</a>
</span><span class=lnt id=hl-347-103><a class=lnlinks href=#hl-347-103>103</a>
</span><span class=lnt id=hl-347-104><a class=lnlinks href=#hl-347-104>104</a>
</span><span class=lnt id=hl-347-105><a class=lnlinks href=#hl-347-105>105</a>
</span><span class=lnt id=hl-347-106><a class=lnlinks href=#hl-347-106>106</a>
</span><span class=lnt id=hl-347-107><a class=lnlinks href=#hl-347-107>107</a>
</span><span class=lnt id=hl-347-108><a class=lnlinks href=#hl-347-108>108</a>
</span><span class=lnt id=hl-347-109><a class=lnlinks href=#hl-347-109>109</a>
</span><span class=lnt id=hl-347-110><a class=lnlinks href=#hl-347-110>110</a>
</span><span class=lnt id=hl-347-111><a class=lnlinks href=#hl-347-111>111</a>
</span><span class=lnt id=hl-347-112><a class=lnlinks href=#hl-347-112>112</a>
</span><span class=lnt id=hl-347-113><a class=lnlinks href=#hl-347-113>113</a>
</span><span class=lnt id=hl-347-114><a class=lnlinks href=#hl-347-114>114</a>
</span><span class=lnt id=hl-347-115><a class=lnlinks href=#hl-347-115>115</a>
</span><span class=lnt id=hl-347-116><a class=lnlinks href=#hl-347-116>116</a>
</span><span class=lnt id=hl-347-117><a class=lnlinks href=#hl-347-117>117</a>
</span><span class=lnt id=hl-347-118><a class=lnlinks href=#hl-347-118>118</a>
</span><span class=lnt id=hl-347-119><a class=lnlinks href=#hl-347-119>119</a>
</span><span class=lnt id=hl-347-120><a class=lnlinks href=#hl-347-120>120</a>
</span><span class=lnt id=hl-347-121><a class=lnlinks href=#hl-347-121>121</a>
</span><span class=lnt id=hl-347-122><a class=lnlinks href=#hl-347-122>122</a>
</span><span class=lnt id=hl-347-123><a class=lnlinks href=#hl-347-123>123</a>
</span><span class=lnt id=hl-347-124><a class=lnlinks href=#hl-347-124>124</a>
</span><span class=lnt id=hl-347-125><a class=lnlinks href=#hl-347-125>125</a>
</span><span class=lnt id=hl-347-126><a class=lnlinks href=#hl-347-126>126</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>BlockingQueue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//é˜»å¡é˜Ÿåˆ—ï¼Œå­˜æ”¾ä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Deque</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayDeque</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//ç”Ÿäº§è€…æ¡ä»¶å˜é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>fullWaitSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//æ¶ˆè´¹è€…æ¡ä»¶å˜é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>emptyWaitSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//æ„é€ æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>BlockingQueue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>capacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>capacity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//è¶…æ—¶é˜»å¡è·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>poll</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//å°†æ—¶é—´è½¬æ¢ä¸ºçº³ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>nanoTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unit</span><span class=p>.</span><span class=na>toNanos</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//ç­‰å¾…è¶…æ—¶ä¾æ—§æ²¡æœ‰è·å–ï¼Œè¿”å›null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>nanoTime</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//è¯¥æ–¹æ³•è¿”å›çš„æ˜¯å‰©ä½™æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>nanoTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>emptyWaitSet</span><span class=p>.</span><span class=na>awaitNanos</span><span class=p>(</span><span class=n>nanoTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>T</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>pollFirst</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fullWaitSet</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//é˜»å¡è·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>take</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>emptyWaitSet</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>T</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>pollFirst</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fullWaitSet</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//é˜»å¡æ·»åŠ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>t</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>fullWaitSet</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>emptyWaitSet</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//è¶…æ—¶é˜»å¡æ·»åŠ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>offer</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=n>TimeUnit</span><span class=w> </span><span class=n>timeUnit</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>nanoTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeUnit</span><span class=p>.</span><span class=na>toNanos</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>nanoTime</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ç­‰å¾…è¶…æ—¶ï¼ŒåŠ å…¥å¤±è´¥ï¼š&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>nanoTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullWaitSet</span><span class=p>.</span><span class=na>awaitNanos</span><span class=p>(</span><span class=n>nanoTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>emptyWaitSet</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>size</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//ä»å½¢å‚æ¥æ”¶æ‹’ç»ç­–ç•¥çš„putæ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>tryPut</span><span class=p>(</span><span class=n>RejectPolicy</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>rejectPolicy</span><span class=p>,</span><span class=n>T</span><span class=w> </span><span class=n>task</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>queue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>rejectPolicy</span><span class=p>.</span><span class=na>reject</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=k>else</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼š&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>queue</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>emptyWaitSet</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ­¥éª¤3ï¼šè‡ªå®šä¹‰çº¿ç¨‹æ± </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-348-1><a class=lnlinks href=#hl-348-1> 1</a>
</span><span class=lnt id=hl-348-2><a class=lnlinks href=#hl-348-2> 2</a>
</span><span class=lnt id=hl-348-3><a class=lnlinks href=#hl-348-3> 3</a>
</span><span class=lnt id=hl-348-4><a class=lnlinks href=#hl-348-4> 4</a>
</span><span class=lnt id=hl-348-5><a class=lnlinks href=#hl-348-5> 5</a>
</span><span class=lnt id=hl-348-6><a class=lnlinks href=#hl-348-6> 6</a>
</span><span class=lnt id=hl-348-7><a class=lnlinks href=#hl-348-7> 7</a>
</span><span class=lnt id=hl-348-8><a class=lnlinks href=#hl-348-8> 8</a>
</span><span class=lnt id=hl-348-9><a class=lnlinks href=#hl-348-9> 9</a>
</span><span class=lnt id=hl-348-10><a class=lnlinks href=#hl-348-10>10</a>
</span><span class=lnt id=hl-348-11><a class=lnlinks href=#hl-348-11>11</a>
</span><span class=lnt id=hl-348-12><a class=lnlinks href=#hl-348-12>12</a>
</span><span class=lnt id=hl-348-13><a class=lnlinks href=#hl-348-13>13</a>
</span><span class=lnt id=hl-348-14><a class=lnlinks href=#hl-348-14>14</a>
</span><span class=lnt id=hl-348-15><a class=lnlinks href=#hl-348-15>15</a>
</span><span class=lnt id=hl-348-16><a class=lnlinks href=#hl-348-16>16</a>
</span><span class=lnt id=hl-348-17><a class=lnlinks href=#hl-348-17>17</a>
</span><span class=lnt id=hl-348-18><a class=lnlinks href=#hl-348-18>18</a>
</span><span class=lnt id=hl-348-19><a class=lnlinks href=#hl-348-19>19</a>
</span><span class=lnt id=hl-348-20><a class=lnlinks href=#hl-348-20>20</a>
</span><span class=lnt id=hl-348-21><a class=lnlinks href=#hl-348-21>21</a>
</span><span class=lnt id=hl-348-22><a class=lnlinks href=#hl-348-22>22</a>
</span><span class=lnt id=hl-348-23><a class=lnlinks href=#hl-348-23>23</a>
</span><span class=lnt id=hl-348-24><a class=lnlinks href=#hl-348-24>24</a>
</span><span class=lnt id=hl-348-25><a class=lnlinks href=#hl-348-25>25</a>
</span><span class=lnt id=hl-348-26><a class=lnlinks href=#hl-348-26>26</a>
</span><span class=lnt id=hl-348-27><a class=lnlinks href=#hl-348-27>27</a>
</span><span class=lnt id=hl-348-28><a class=lnlinks href=#hl-348-28>28</a>
</span><span class=lnt id=hl-348-29><a class=lnlinks href=#hl-348-29>29</a>
</span><span class=lnt id=hl-348-30><a class=lnlinks href=#hl-348-30>30</a>
</span><span class=lnt id=hl-348-31><a class=lnlinks href=#hl-348-31>31</a>
</span><span class=lnt id=hl-348-32><a class=lnlinks href=#hl-348-32>32</a>
</span><span class=lnt id=hl-348-33><a class=lnlinks href=#hl-348-33>33</a>
</span><span class=lnt id=hl-348-34><a class=lnlinks href=#hl-348-34>34</a>
</span><span class=lnt id=hl-348-35><a class=lnlinks href=#hl-348-35>35</a>
</span><span class=lnt id=hl-348-36><a class=lnlinks href=#hl-348-36>36</a>
</span><span class=lnt id=hl-348-37><a class=lnlinks href=#hl-348-37>37</a>
</span><span class=lnt id=hl-348-38><a class=lnlinks href=#hl-348-38>38</a>
</span><span class=lnt id=hl-348-39><a class=lnlinks href=#hl-348-39>39</a>
</span><span class=lnt id=hl-348-40><a class=lnlinks href=#hl-348-40>40</a>
</span><span class=lnt id=hl-348-41><a class=lnlinks href=#hl-348-41>41</a>
</span><span class=lnt id=hl-348-42><a class=lnlinks href=#hl-348-42>42</a>
</span><span class=lnt id=hl-348-43><a class=lnlinks href=#hl-348-43>43</a>
</span><span class=lnt id=hl-348-44><a class=lnlinks href=#hl-348-44>44</a>
</span><span class=lnt id=hl-348-45><a class=lnlinks href=#hl-348-45>45</a>
</span><span class=lnt id=hl-348-46><a class=lnlinks href=#hl-348-46>46</a>
</span><span class=lnt id=hl-348-47><a class=lnlinks href=#hl-348-47>47</a>
</span><span class=lnt id=hl-348-48><a class=lnlinks href=#hl-348-48>48</a>
</span><span class=lnt id=hl-348-49><a class=lnlinks href=#hl-348-49>49</a>
</span><span class=lnt id=hl-348-50><a class=lnlinks href=#hl-348-50>50</a>
</span><span class=lnt id=hl-348-51><a class=lnlinks href=#hl-348-51>51</a>
</span><span class=lnt id=hl-348-52><a class=lnlinks href=#hl-348-52>52</a>
</span><span class=lnt id=hl-348-53><a class=lnlinks href=#hl-348-53>53</a>
</span><span class=lnt id=hl-348-54><a class=lnlinks href=#hl-348-54>54</a>
</span><span class=lnt id=hl-348-55><a class=lnlinks href=#hl-348-55>55</a>
</span><span class=lnt id=hl-348-56><a class=lnlinks href=#hl-348-56>56</a>
</span><span class=lnt id=hl-348-57><a class=lnlinks href=#hl-348-57>57</a>
</span><span class=lnt id=hl-348-58><a class=lnlinks href=#hl-348-58>58</a>
</span><span class=lnt id=hl-348-59><a class=lnlinks href=#hl-348-59>59</a>
</span><span class=lnt id=hl-348-60><a class=lnlinks href=#hl-348-60>60</a>
</span><span class=lnt id=hl-348-61><a class=lnlinks href=#hl-348-61>61</a>
</span><span class=lnt id=hl-348-62><a class=lnlinks href=#hl-348-62>62</a>
</span><span class=lnt id=hl-348-63><a class=lnlinks href=#hl-348-63>63</a>
</span><span class=lnt id=hl-348-64><a class=lnlinks href=#hl-348-64>64</a>
</span><span class=lnt id=hl-348-65><a class=lnlinks href=#hl-348-65>65</a>
</span><span class=lnt id=hl-348-66><a class=lnlinks href=#hl-348-66>66</a>
</span><span class=lnt id=hl-348-67><a class=lnlinks href=#hl-348-67>67</a>
</span><span class=lnt id=hl-348-68><a class=lnlinks href=#hl-348-68>68</a>
</span><span class=lnt id=hl-348-69><a class=lnlinks href=#hl-348-69>69</a>
</span><span class=lnt id=hl-348-70><a class=lnlinks href=#hl-348-70>70</a>
</span><span class=lnt id=hl-348-71><a class=lnlinks href=#hl-348-71>71</a>
</span><span class=lnt id=hl-348-72><a class=lnlinks href=#hl-348-72>72</a>
</span><span class=lnt id=hl-348-73><a class=lnlinks href=#hl-348-73>73</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ThreadPool</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//é˜»å¡é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>taskQue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//çº¿ç¨‹é›†åˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashSet</span><span class=o>&lt;</span><span class=n>Worker</span><span class=o>&gt;</span><span class=w> </span><span class=n>workers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//æ‹’ç»ç­–ç•¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RejectPolicy</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>rejectPolicy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//æ„é€ æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ThreadPool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>coreSize</span><span class=p>,</span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=n>TimeUnit</span><span class=w> </span><span class=n>timeUnit</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>queueCapacity</span><span class=p>,</span><span class=n>RejectPolicy</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>rejectPolicy</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>coreSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coreSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeout</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>timeUnit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>rejectPolicy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rejectPolicy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>taskQue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>(</span><span class=n>queueCapacity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//çº¿ç¨‹æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>coreSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//ä»»åŠ¡è¶…æ—¶æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//æ—¶é—´å•å…ƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>timeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//çº¿ç¨‹æ± çš„æ‰§è¡Œæ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>task</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//å½“çº¿ç¨‹æ•°å¤§äºç­‰äºcoreSizeçš„æ—¶å€™ï¼Œå°†ä»»åŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//å½“çº¿ç¨‹æ•°å°äºcoreSizeçš„æ—¶å€™ï¼Œæ–°å»ºä¸€ä¸ªWorkeræ”¾å…¥workers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//æ³¨æ„workersç±»ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ éœ€è¦åŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>workers</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>workers</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>coreSize</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                taskQue.put(task);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//æ­»ç­‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//å¸¦è¶…æ—¶ç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//è®©è°ƒç”¨è€…æ”¾å¼ƒæ‰§è¡Œä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//è®©è°ƒç”¨è€…æŠ›å‡ºå¼‚å¸¸</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//è®©è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>taskQue</span><span class=p>.</span><span class=na>tryPut</span><span class=p>(</span><span class=n>rejectPolicy</span><span class=p>,</span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Worker</span><span class=w> </span><span class=n>worker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Worker</span><span class=p>(</span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;æ–°å¢worker:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>worker</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;,task:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>workers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>worker</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>worker</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å·¥ä½œç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>class</span> <span class=nc>Worker</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Thread</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>Worker</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>task</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//å·§å¦™çš„åˆ¤æ–­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=n>task</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>taskQue</span><span class=p>.</span><span class=na>poll</span><span class=p>(</span><span class=n>timeout</span><span class=p>,</span><span class=n>timeUnit</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;æ­£åœ¨æ‰§è¡Œ:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>task</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>workers</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;workerè¢«ç§»é™¤:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>workers</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ­¥éª¤4ï¼šç¼–å†™æµ‹è¯•ç±»</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-349-1><a class=lnlinks href=#hl-349-1> 1</a>
</span><span class=lnt id=hl-349-2><a class=lnlinks href=#hl-349-2> 2</a>
</span><span class=lnt id=hl-349-3><a class=lnlinks href=#hl-349-3> 3</a>
</span><span class=lnt id=hl-349-4><a class=lnlinks href=#hl-349-4> 4</a>
</span><span class=lnt id=hl-349-5><a class=lnlinks href=#hl-349-5> 5</a>
</span><span class=lnt id=hl-349-6><a class=lnlinks href=#hl-349-6> 6</a>
</span><span class=lnt id=hl-349-7><a class=lnlinks href=#hl-349-7> 7</a>
</span><span class=lnt id=hl-349-8><a class=lnlinks href=#hl-349-8> 8</a>
</span><span class=lnt id=hl-349-9><a class=lnlinks href=#hl-349-9> 9</a>
</span><span class=lnt id=hl-349-10><a class=lnlinks href=#hl-349-10>10</a>
</span><span class=lnt id=hl-349-11><a class=lnlinks href=#hl-349-11>11</a>
</span><span class=lnt id=hl-349-12><a class=lnlinks href=#hl-349-12>12</a>
</span><span class=lnt id=hl-349-13><a class=lnlinks href=#hl-349-13>13</a>
</span><span class=lnt id=hl-349-14><a class=lnlinks href=#hl-349-14>14</a>
</span><span class=lnt id=hl-349-15><a class=lnlinks href=#hl-349-15>15</a>
</span><span class=lnt id=hl-349-16><a class=lnlinks href=#hl-349-16>16</a>
</span><span class=lnt id=hl-349-17><a class=lnlinks href=#hl-349-17>17</a>
</span><span class=lnt id=hl-349-18><a class=lnlinks href=#hl-349-18>18</a>
</span><span class=lnt id=hl-349-19><a class=lnlinks href=#hl-349-19>19</a>
</span><span class=lnt id=hl-349-20><a class=lnlinks href=#hl-349-20>20</a>
</span><span class=lnt id=hl-349-21><a class=lnlinks href=#hl-349-21>21</a>
</span><span class=lnt id=hl-349-22><a class=lnlinks href=#hl-349-22>22</a>
</span><span class=lnt id=hl-349-23><a class=lnlinks href=#hl-349-23>23</a>
</span><span class=lnt id=hl-349-24><a class=lnlinks href=#hl-349-24>24</a>
</span><span class=lnt id=hl-349-25><a class=lnlinks href=#hl-349-25>25</a>
</span><span class=lnt id=hl-349-26><a class=lnlinks href=#hl-349-26>26</a>
</span><span class=lnt id=hl-349-27><a class=lnlinks href=#hl-349-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ThreadPoolTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ThreadPool</span><span class=w> </span><span class=n>threadPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1000</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=n>task</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//æ­»ç­‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                    queue.put(task);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//å¸¦è¶…æ—¶ç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            queue.offer(task, 1500, TimeUnit.MILLISECONDS);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//è®©è°ƒç”¨è€…æ”¾å¼ƒä»»åŠ¡æ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            System.out.println(&#34;æ”¾å¼ƒï¼š&#34; + task);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//è®©è°ƒç”¨è€…æŠ›å‡ºå¼‚å¸¸</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            throw new RuntimeException(&#34;ä»»åŠ¡æ‰§è¡Œå¤±è´¥&#34; + task);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//è®©è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>task</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=n>3</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>threadPool</span><span class=p>.</span><span class=na>execute</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;æ‰§è¡Œä»»åŠ¡ï¼š&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>j</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=threadpoolexecutor><a href=#threadpoolexecutor class=header-anchor>#</a>
ThreadPoolExecutor</h4><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220311171237519.png width=900 height=600 loading=lazy decoding=async alt=image-20220311171237519 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>è¯´æ˜ï¼š</p><ul><li>ScheduledThreadPoolExecutoræ˜¯å¸¦è°ƒåº¦çš„çº¿ç¨‹æ± </li><li>ThreadPoolExecutoræ˜¯ä¸å¸¦è°ƒåº¦çš„çº¿ç¨‹æ± </li></ul><h5 id=çº¿ç¨‹æ± çŠ¶æ€><a href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0%e7%8a%b6%e6%80%81 class=header-anchor>#</a>
çº¿ç¨‹æ± çŠ¶æ€</h5><p>ThreadPoolExecutor ä½¿ç”¨ int çš„é«˜ 3 ä½æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½ 29 ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>çŠ¶æ€å</th><th style=text-align:center>é«˜3ä½</th><th style=text-align:center>æ¥æ”¶æ–°ä»»åŠ¡</th><th style=text-align:center>å¤„ç†é˜»å¡é˜Ÿåˆ—ä»»åŠ¡</th><th style=text-align:center>è¯´æ˜</th></tr></thead><tbody><tr><td style=text-align:center>RUNNING</td><td style=text-align:center>111</td><td style=text-align:center>Y</td><td style=text-align:center>Y</td><td style=text-align:center></td></tr><tr><td style=text-align:center>SHUTDOWN</td><td style=text-align:center>000</td><td style=text-align:center>N</td><td style=text-align:center>Y</td><td style=text-align:center>ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†ä¼šå¤„ç†é˜»å¡é˜Ÿåˆ—å‰©ä½™ ä»»åŠ¡</td></tr><tr><td style=text-align:center>STOP</td><td style=text-align:center>001</td><td style=text-align:center>N</td><td style=text-align:center>N</td><td style=text-align:center>ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å¼ƒé˜»å¡é˜Ÿåˆ— ä»»åŠ¡</td></tr><tr><td style=text-align:center>TIDYING</td><td style=text-align:center>010</td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center>ä»»åŠ¡å…¨æ‰§è¡Œå®Œæ¯•ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸º 0 å³å°†è¿›å…¥ ç»ˆç»“</td></tr><tr><td style=text-align:center>TERMINATED</td><td style=text-align:center>011</td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center>ç»ˆç»“çŠ¶æ€</td></tr></tbody></table></div><p>ä»æ•°å­—ä¸Šæ¯”è¾ƒï¼ŒTERMINATED > TIDYING > STOP > SHUTDOWN > RUNNING</p><p>è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåŸå­å˜é‡ ctl ä¸­ï¼Œç›®çš„æ˜¯å°†çº¿ç¨‹æ± çŠ¶æ€ä¸çº¿ç¨‹ä¸ªæ•°åˆäºŒä¸ºä¸€ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸€æ¬¡ cas åŸå­æ“ä½œ è¿›è¡Œèµ‹å€¼</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-350-1><a class=lnlinks href=#hl-350-1>1</a>
</span><span class=lnt id=hl-350-2><a class=lnlinks href=#hl-350-2>2</a>
</span><span class=lnt id=hl-350-3><a class=lnlinks href=#hl-350-3>3</a>
</span><span class=lnt id=hl-350-4><a class=lnlinks href=#hl-350-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// c ä¸ºæ—§å€¼ï¼Œ ctlOf è¿”å›ç»“æœä¸ºæ–°å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ctl</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>ctlOf</span><span class=p>(</span><span class=n>targetState</span><span class=p>,</span><span class=w> </span><span class=n>workerCountOf</span><span class=p>(</span><span class=n>c</span><span class=p>))));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// rs ä¸ºé«˜ 3 ä½ä»£è¡¨çº¿ç¨‹æ± çŠ¶æ€ï¼Œ wc ä¸ºä½ 29 ä½ä»£è¡¨çº¿ç¨‹ä¸ªæ•°ï¼Œctl æ˜¯åˆå¹¶å®ƒä»¬</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>ctlOf</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>rs</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>wc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>wc</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=æ„é€ æ–¹æ³•><a href=#%e6%9e%84%e9%80%a0%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
æ„é€ æ–¹æ³•</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-351-1><a class=lnlinks href=#hl-351-1>1</a>
</span><span class=lnt id=hl-351-2><a class=lnlinks href=#hl-351-2>2</a>
</span><span class=lnt id=hl-351-3><a class=lnlinks href=#hl-351-3>3</a>
</span><span class=lnt id=hl-351-4><a class=lnlinks href=#hl-351-4>4</a>
</span><span class=lnt id=hl-351-5><a class=lnlinks href=#hl-351-5>5</a>
</span><span class=lnt id=hl-351-6><a class=lnlinks href=#hl-351-6>6</a>
</span><span class=lnt id=hl-351-7><a class=lnlinks href=#hl-351-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ThreadPoolExecutor</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>corePoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=kt>int</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=kt>long</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>workQueue</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>ThreadFactory</span><span class=w> </span><span class=n>threadFactory</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>RejectedExecutionHandler</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°ç›® (æœ€å¤šä¿ç•™çš„çº¿ç¨‹æ•°)</li><li>maximumPoolSize æœ€å¤§çº¿ç¨‹æ•°ç›®</li><li>keepAliveTime ç”Ÿå­˜æ—¶é—´ - é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹</li><li>unit æ—¶é—´å•ä½ - é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹</li><li>workQueue é˜»å¡é˜Ÿåˆ—</li><li>threadFactory çº¿ç¨‹å·¥å‚ - å¯ä»¥ä¸ºçº¿ç¨‹åˆ›å»ºæ—¶èµ·ä¸ªå¥½åå­—</li><li>handler æ‹’ç»ç­–ç•¥</li></ul><h5 id=å·¥ä½œæ–¹å¼><a href=#%e5%b7%a5%e4%bd%9c%e6%96%b9%e5%bc%8f class=header-anchor>#</a>
å·¥ä½œæ–¹å¼</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-352-1><a class=lnlinks href=#hl-352-1> 1</a>
</span><span class=lnt id=hl-352-2><a class=lnlinks href=#hl-352-2> 2</a>
</span><span class=lnt id=hl-352-3><a class=lnlinks href=#hl-352-3> 3</a>
</span><span class=lnt id=hl-352-4><a class=lnlinks href=#hl-352-4> 4</a>
</span><span class=lnt id=hl-352-5><a class=lnlinks href=#hl-352-5> 5</a>
</span><span class=lnt id=hl-352-6><a class=lnlinks href=#hl-352-6> 6</a>
</span><span class=lnt id=hl-352-7><a class=lnlinks href=#hl-352-7> 7</a>
</span><span class=lnt id=hl-352-8><a class=lnlinks href=#hl-352-8> 8</a>
</span><span class=lnt id=hl-352-9><a class=lnlinks href=#hl-352-9> 9</a>
</span><span class=lnt id=hl-352-10><a class=lnlinks href=#hl-352-10>10</a>
</span><span class=lnt id=hl-352-11><a class=lnlinks href=#hl-352-11>11</a>
</span><span class=lnt id=hl-352-12><a class=lnlinks href=#hl-352-12>12</a>
</span><span class=lnt id=hl-352-13><a class=lnlinks href=#hl-352-13>13</a>
</span><span class=lnt id=hl-352-14><a class=lnlinks href=#hl-352-14>14</a>
</span><span class=lnt id=hl-352-15><a class=lnlinks href=#hl-352-15>15</a>
</span><span class=lnt id=hl-352-16><a class=lnlinks href=#hl-352-16>16</a>
</span><span class=lnt id=hl-352-17><a class=lnlinks href=#hl-352-17>17</a>
</span><span class=lnt id=hl-352-18><a class=lnlinks href=#hl-352-18>18</a>
</span><span class=lnt id=hl-352-19><a class=lnlinks href=#hl-352-19>19</a>
</span><span class=lnt id=hl-352-20><a class=lnlinks href=#hl-352-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph LR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>subgraph é˜»å¡é˜Ÿåˆ—
</span></span><span class=line><span class=cl>size=2
</span></span><span class=line><span class=cl>t3(ä»»åŠ¡3)
</span></span><span class=line><span class=cl>t4(ä»»åŠ¡4)
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>subgraph çº¿ç¨‹æ± c-2,m=3
</span></span><span class=line><span class=cl>ct1(æ ¸å¿ƒçº¿ç¨‹1)
</span></span><span class=line><span class=cl>ct2(æ ¸å¿ƒçº¿ç¨‹2)
</span></span><span class=line><span class=cl>mt1(æ•‘æ€¥çº¿ç¨‹1)
</span></span><span class=line><span class=cl>ct1 --&gt; t1(ä»»åŠ¡1)
</span></span><span class=line><span class=cl>ct2 --&gt; t2(ä»»åŠ¡2)
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>t1(ä»»åŠ¡1)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>style ct1 fill:#ccf,stroke:#f66,stroke-width:2px
</span></span><span class=line><span class=cl>style ct2 fill:#ccf,stroke:#f66,stroke-width:2px
</span></span><span class=line><span class=cl>style mt1 fill:#ccf,stroke:#f66,stroke-width:2px,stroke-dasharray:5,5
</span></span></code></pre></td></tr></table></div></div><ul><li><p>çº¿ç¨‹æ± ä¸­åˆšå¼€å§‹æ²¡æœ‰çº¿ç¨‹ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p></li><li><p>å½“çº¿ç¨‹æ•°è¾¾åˆ° corePoolSize å¹¶æ²¡æœ‰çº¿ç¨‹ç©ºé—²ï¼Œè¿™æ—¶å†åŠ å…¥ä»»åŠ¡ï¼Œæ–°åŠ çš„ä»»åŠ¡ä¼šè¢«åŠ å…¥workQueue é˜Ÿåˆ—æ’ é˜Ÿï¼Œç›´åˆ°æœ‰ç©ºé—²çš„çº¿ç¨‹ã€‚</p></li><li><p>å¦‚æœé˜Ÿåˆ—é€‰æ‹©äº†æœ‰ç•Œé˜Ÿåˆ—ï¼Œé‚£ä¹ˆä»»åŠ¡è¶…è¿‡äº†é˜Ÿåˆ—å¤§å°æ—¶ï¼Œä¼šåˆ›å»º maximumPoolSize - corePoolSize æ•°ç›®çš„çº¿ç¨‹æ¥æ•‘æ€¥ã€‚</p></li><li><p>å¦‚æœçº¿ç¨‹åˆ°è¾¾ maximumPoolSize ä»ç„¶æœ‰æ–°ä»»åŠ¡è¿™æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚æ‹’ç»ç­–ç•¥ jdk æä¾›äº† 4 ç§å®ç°ï¼Œå…¶å®ƒ è‘—åæ¡†æ¶ä¹Ÿæä¾›äº†å®ç°</p><ul><li>AbortPolicy è®©è°ƒç”¨è€…æŠ›å‡º RejectedExecutionException å¼‚å¸¸ï¼Œè¿™æ˜¯é»˜è®¤ç­–ç•¥</li><li>CallerRunsPolicy è®©è°ƒç”¨è€…è¿è¡Œä»»åŠ¡</li><li>DiscardPolicy æ”¾å¼ƒæœ¬æ¬¡ä»»åŠ¡</li><li>DiscardOldestPolicy æ”¾å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—©çš„ä»»åŠ¡ï¼Œæœ¬ä»»åŠ¡å–è€Œä»£ä¹‹</li><li>Dubbo çš„å®ç°ï¼Œåœ¨æŠ›å‡º RejectedExecutionException å¼‚å¸¸ä¹‹å‰ä¼šè®°å½•æ—¥å¿—ï¼Œå¹¶ dump çº¿ç¨‹æ ˆä¿¡æ¯ï¼Œæ–¹ ä¾¿å®šä½é—®é¢˜</li><li>Netty çš„å®ç°ï¼Œæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</li><li>ActiveMQ çš„å®ç°ï¼Œå¸¦è¶…æ—¶ç­‰å¾…ï¼ˆ60sï¼‰å°è¯•æ”¾å…¥é˜Ÿåˆ—ï¼Œç±»ä¼¼æˆ‘ä»¬ä¹‹å‰è‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥</li><li>PinPoint çš„å®ç°ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªæ‹’ç»ç­–ç•¥é“¾ï¼Œä¼šé€ä¸€å°è¯•ç­–ç•¥é“¾ä¸­æ¯ç§æ‹’ç»ç­–ç•¥</li></ul></li><li><p>å½“é«˜å³°è¿‡å»åï¼Œè¶…è¿‡corePoolSize çš„æ•‘æ€¥çº¿ç¨‹å¦‚æœä¸€æ®µæ—¶é—´æ²¡æœ‰ä»»åŠ¡åšï¼Œéœ€è¦ç»“æŸèŠ‚çœèµ„æºï¼Œè¿™ä¸ªæ—¶é—´ç”± keepAliveTime å’Œ unit æ¥æ§åˆ¶ã€‚</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220311174119508.png width=900 height=600 loading=lazy decoding=async alt=image-20220311174119508 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p></li></ul><p>æ ¹æ®è¿™ä¸ªæ„é€ æ–¹æ³•ï¼ŒJDK Executors ç±»ä¸­æä¾›äº†ä¼—å¤šå·¥å‚æ–¹æ³•æ¥åˆ›å»ºå„ç§ç”¨é€”çš„çº¿ç¨‹æ± ã€‚</p><h5 id=newfixedthreadpool><a href=#newfixedthreadpool class=header-anchor>#</a>
newFixedThreadPool</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-353-1><a class=lnlinks href=#hl-353-1>1</a>
</span><span class=lnt id=hl-353-2><a class=lnlinks href=#hl-353-2>2</a>
</span><span class=lnt id=hl-353-3><a class=lnlinks href=#hl-353-3>3</a>
</span><span class=lnt id=hl-353-4><a class=lnlinks href=#hl-353-4>4</a>
</span><span class=lnt id=hl-353-5><a class=lnlinks href=#hl-353-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ExecutorService</span><span class=w> </span><span class=nf>newFixedThreadPool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>nThreads</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>nThreads</span><span class=p>,</span><span class=w> </span><span class=n>nThreads</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=n>0L</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=k>new</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å†…éƒ¨è°ƒç”¨äº†ï¼šThreadPoolExecutorçš„ä¸€ä¸ªæ„é€ æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-354-1><a class=lnlinks href=#hl-354-1>1</a>
</span><span class=lnt id=hl-354-2><a class=lnlinks href=#hl-354-2>2</a>
</span><span class=lnt id=hl-354-3><a class=lnlinks href=#hl-354-3>3</a>
</span><span class=lnt id=hl-354-4><a class=lnlinks href=#hl-354-4>4</a>
</span><span class=lnt id=hl-354-5><a class=lnlinks href=#hl-354-5>5</a>
</span><span class=lnt id=hl-354-6><a class=lnlinks href=#hl-354-6>6</a>
</span><span class=lnt id=hl-354-7><a class=lnlinks href=#hl-354-7>7</a>
</span><span class=lnt id=hl-354-8><a class=lnlinks href=#hl-354-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ThreadPoolExecutor</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>corePoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=kt>int</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=kt>long</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>workQueue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>(</span><span class=n>corePoolSize</span><span class=p>,</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>,</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>,</span><span class=w> </span><span class=n>workQueue</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>Executors</span><span class=p>.</span><span class=na>defaultThreadFactory</span><span class=p>(),</span><span class=w> </span><span class=n>defaultHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é»˜è®¤å·¥å‚ä»¥åŠé»˜è®¤æ„é€ çº¿ç¨‹çš„æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-355-1><a class=lnlinks href=#hl-355-1> 1</a>
</span><span class=lnt id=hl-355-2><a class=lnlinks href=#hl-355-2> 2</a>
</span><span class=lnt id=hl-355-3><a class=lnlinks href=#hl-355-3> 3</a>
</span><span class=lnt id=hl-355-4><a class=lnlinks href=#hl-355-4> 4</a>
</span><span class=lnt id=hl-355-5><a class=lnlinks href=#hl-355-5> 5</a>
</span><span class=lnt id=hl-355-6><a class=lnlinks href=#hl-355-6> 6</a>
</span><span class=lnt id=hl-355-7><a class=lnlinks href=#hl-355-7> 7</a>
</span><span class=lnt id=hl-355-8><a class=lnlinks href=#hl-355-8> 8</a>
</span><span class=lnt id=hl-355-9><a class=lnlinks href=#hl-355-9> 9</a>
</span><span class=lnt id=hl-355-10><a class=lnlinks href=#hl-355-10>10</a>
</span><span class=lnt id=hl-355-11><a class=lnlinks href=#hl-355-11>11</a>
</span><span class=lnt id=hl-355-12><a class=lnlinks href=#hl-355-12>12</a>
</span><span class=lnt id=hl-355-13><a class=lnlinks href=#hl-355-13>13</a>
</span><span class=lnt id=hl-355-14><a class=lnlinks href=#hl-355-14>14</a>
</span><span class=lnt id=hl-355-15><a class=lnlinks href=#hl-355-15>15</a>
</span><span class=lnt id=hl-355-16><a class=lnlinks href=#hl-355-16>16</a>
</span><span class=lnt id=hl-355-17><a class=lnlinks href=#hl-355-17>17</a>
</span><span class=lnt id=hl-355-18><a class=lnlinks href=#hl-355-18>18</a>
</span><span class=lnt id=hl-355-19><a class=lnlinks href=#hl-355-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DefaultThreadFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SecurityManager</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>getSecurityManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>group</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>getThreadGroup</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getThreadGroup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>namePrefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;pool-&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>poolNumber</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;-thread-&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=nf>newThread</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>group</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>namePrefix</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>threadNumber</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=na>isDaemon</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=p>.</span><span class=na>setDaemon</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=na>getPriority</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>NORM_PRIORITY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=p>.</span><span class=na>setPriority</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>NORM_PRIORITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é»˜è®¤æ‹’ç»ç­–ç•¥ï¼šæŠ›å‡ºå¼‚å¸¸</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-356-1><a class=lnlinks href=#hl-356-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>RejectedExecutionHandler</span><span class=w> </span><span class=n>defaultHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AbortPolicy</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç‰¹ç‚¹</p><ul><li>æ ¸å¿ƒçº¿ç¨‹æ•° == æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹è¢«åˆ›å»ºï¼‰ï¼Œå› æ­¤ä¹Ÿæ— éœ€è¶…æ—¶æ—¶é—´</li><li>é˜»å¡é˜Ÿåˆ—æ˜¯æ— ç•Œçš„ï¼Œå¯ä»¥æ”¾ä»»æ„æ•°é‡çš„ä»»åŠ¡</li></ul><blockquote><p><strong>è¯„ä»·</strong> é€‚ç”¨äºä»»åŠ¡é‡å·²çŸ¥ï¼Œç›¸å¯¹è€—æ—¶çš„ä»»åŠ¡</p></blockquote><h5 id=newcachedthreadpool><a href=#newcachedthreadpool class=header-anchor>#</a>
newCachedThreadPool</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-357-1><a class=lnlinks href=#hl-357-1>1</a>
</span><span class=lnt id=hl-357-2><a class=lnlinks href=#hl-357-2>2</a>
</span><span class=lnt id=hl-357-3><a class=lnlinks href=#hl-357-3>3</a>
</span><span class=lnt id=hl-357-4><a class=lnlinks href=#hl-357-4>4</a>
</span><span class=lnt id=hl-357-5><a class=lnlinks href=#hl-357-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ExecutorService</span><span class=w> </span><span class=nf>newCachedThreadPool</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=n>60L</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=k>new</span><span class=w> </span><span class=n>SynchronousQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç‰¹ç‚¹</p><ul><li>æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ 0ï¼Œ æœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX_VALUEï¼Œæ•‘æ€¥çº¿ç¨‹çš„ç©ºé—²ç”Ÿå­˜æ—¶é—´æ˜¯ 60sï¼Œ<ul><li>æ„å‘³ç€å…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼ˆ60s åå¯ä»¥å›æ”¶ï¼‰</li><li>æ•‘æ€¥çº¿ç¨‹å¯ä»¥æ— é™åˆ›å»º</li></ul></li><li>é˜Ÿåˆ—é‡‡ç”¨äº† SynchronousQueue å®ç°ç‰¹ç‚¹æ˜¯ï¼Œå®ƒæ²¡æœ‰å®¹é‡ï¼Œæ²¡æœ‰çº¿ç¨‹æ¥å–æ˜¯æ”¾ä¸è¿›å»çš„ï¼ˆä¸€æ‰‹äº¤é’±ã€ä¸€æ‰‹äº¤è´§ï¼‰</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-358-1><a class=lnlinks href=#hl-358-1> 1</a>
</span><span class=lnt id=hl-358-2><a class=lnlinks href=#hl-358-2> 2</a>
</span><span class=lnt id=hl-358-3><a class=lnlinks href=#hl-358-3> 3</a>
</span><span class=lnt id=hl-358-4><a class=lnlinks href=#hl-358-4> 4</a>
</span><span class=lnt id=hl-358-5><a class=lnlinks href=#hl-358-5> 5</a>
</span><span class=lnt id=hl-358-6><a class=lnlinks href=#hl-358-6> 6</a>
</span><span class=lnt id=hl-358-7><a class=lnlinks href=#hl-358-7> 7</a>
</span><span class=lnt id=hl-358-8><a class=lnlinks href=#hl-358-8> 8</a>
</span><span class=lnt id=hl-358-9><a class=lnlinks href=#hl-358-9> 9</a>
</span><span class=lnt id=hl-358-10><a class=lnlinks href=#hl-358-10>10</a>
</span><span class=lnt id=hl-358-11><a class=lnlinks href=#hl-358-11>11</a>
</span><span class=lnt id=hl-358-12><a class=lnlinks href=#hl-358-12>12</a>
</span><span class=lnt id=hl-358-13><a class=lnlinks href=#hl-358-13>13</a>
</span><span class=lnt id=hl-358-14><a class=lnlinks href=#hl-358-14>14</a>
</span><span class=lnt id=hl-358-15><a class=lnlinks href=#hl-358-15>15</a>
</span><span class=lnt id=hl-358-16><a class=lnlinks href=#hl-358-16>16</a>
</span><span class=lnt id=hl-358-17><a class=lnlinks href=#hl-358-17>17</a>
</span><span class=lnt id=hl-358-18><a class=lnlinks href=#hl-358-18>18</a>
</span><span class=lnt id=hl-358-19><a class=lnlinks href=#hl-358-19>19</a>
</span><span class=lnt id=hl-358-20><a class=lnlinks href=#hl-358-20>20</a>
</span><span class=lnt id=hl-358-21><a class=lnlinks href=#hl-358-21>21</a>
</span><span class=lnt id=hl-358-22><a class=lnlinks href=#hl-358-22>22</a>
</span><span class=lnt id=hl-358-23><a class=lnlinks href=#hl-358-23>23</a>
</span><span class=lnt id=hl-358-24><a class=lnlinks href=#hl-358-24>24</a>
</span><span class=lnt id=hl-358-25><a class=lnlinks href=#hl-358-25>25</a>
</span><span class=lnt id=hl-358-26><a class=lnlinks href=#hl-358-26>26</a>
</span><span class=lnt id=hl-358-27><a class=lnlinks href=#hl-358-27>27</a>
</span><span class=lnt id=hl-358-28><a class=lnlinks href=#hl-358-28>28</a>
</span><span class=lnt id=hl-358-29><a class=lnlinks href=#hl-358-29>29</a>
</span><span class=lnt id=hl-358-30><a class=lnlinks href=#hl-358-30>30</a>
</span><span class=lnt id=hl-358-31><a class=lnlinks href=#hl-358-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SynchronousQueue</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>integers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SynchronousQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;putting {} &#34;</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>integers</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{} putted...&#34;</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;putting...{} &#34;</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>integers</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{} putted...&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;taking {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>integers</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;taking {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>integers</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t3&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-359-1><a class=lnlinks href=#hl-359-1>1</a>
</span><span class=lnt id=hl-359-2><a class=lnlinks href=#hl-359-2>2</a>
</span><span class=lnt id=hl-359-3><a class=lnlinks href=#hl-359-3>3</a>
</span><span class=lnt id=hl-359-4><a class=lnlinks href=#hl-359-4>4</a>
</span><span class=lnt id=hl-359-5><a class=lnlinks href=#hl-359-5>5</a>
</span><span class=lnt id=hl-359-6><a class=lnlinks href=#hl-359-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>11:48:15.500 c.TestSynchronousQueue <span class=o>[</span>t1<span class=o>]</span> - putting <span class=m>1</span> 
</span></span><span class=line><span class=cl>11:48:16.500 c.TestSynchronousQueue <span class=o>[</span>t2<span class=o>]</span> - taking <span class=m>1</span> 
</span></span><span class=line><span class=cl>11:48:16.500 c.TestSynchronousQueue <span class=o>[</span>t1<span class=o>]</span> - <span class=m>1</span> putted... 
</span></span><span class=line><span class=cl>11:48:16.500 c.TestSynchronousQueue <span class=o>[</span>t1<span class=o>]</span> - putting...2 
</span></span><span class=line><span class=cl>11:48:17.502 c.TestSynchronousQueue <span class=o>[</span>t3<span class=o>]</span> - taking <span class=m>2</span> 
</span></span><span class=line><span class=cl>11:48:17.503 c.TestSynchronousQueue <span class=o>[</span>t1<span class=o>]</span> - <span class=m>2</span> putted... 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>è¯„ä»·</strong> æ•´ä¸ªçº¿ç¨‹æ± è¡¨ç°ä¸ºçº¿ç¨‹æ•°ä¼šæ ¹æ®ä»»åŠ¡é‡ä¸æ–­å¢é•¿ï¼Œæ²¡æœ‰ä¸Šé™ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç©ºé—² 1åˆ†é’Ÿåé‡Šæ”¾çº¿ ç¨‹ã€‚ é€‚åˆä»»åŠ¡æ•°æ¯”è¾ƒå¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µ</p></blockquote><h5 id=newsinglethreadexecutor><a href=#newsinglethreadexecutor class=header-anchor>#</a>
newSingleThreadExecutor</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-360-1><a class=lnlinks href=#hl-360-1>1</a>
</span><span class=lnt id=hl-360-2><a class=lnlinks href=#hl-360-2>2</a>
</span><span class=lnt id=hl-360-3><a class=lnlinks href=#hl-360-3>3</a>
</span><span class=lnt id=hl-360-4><a class=lnlinks href=#hl-360-4>4</a>
</span><span class=lnt id=hl-360-5><a class=lnlinks href=#hl-360-5>5</a>
</span><span class=lnt id=hl-360-6><a class=lnlinks href=#hl-360-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ExecutorService</span><span class=w> </span><span class=nf>newSingleThreadExecutor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FinalizableDelegatedExecutorService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>0L</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>new</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨åœºæ™¯ï¼š</p><p>å¸Œæœ›å¤šä¸ªä»»åŠ¡æ’é˜Ÿæ‰§è¡Œã€‚çº¿ç¨‹æ•°å›ºå®šä¸º 1ï¼Œä»»åŠ¡æ•°å¤šäº 1 æ—¶ï¼Œä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿã€‚ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å”¯ä¸€çš„çº¿ç¨‹ ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚</p><p>åŒºåˆ«ï¼š</p><ul><li>è‡ªå·±åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥è€Œç»ˆæ­¢é‚£ä¹ˆæ²¡æœ‰ä»»ä½•è¡¥æ•‘æªæ–½ï¼Œè€Œçº¿ç¨‹æ± è¿˜ä¼šæ–°å»ºä¸€ ä¸ªçº¿ç¨‹ï¼Œä¿è¯æ± çš„æ­£å¸¸å·¥ä½œ</li><li>Executors.newSingleThreadExecutor() çº¿ç¨‹ä¸ªæ•°å§‹ç»ˆä¸º1ï¼Œä¸èƒ½ä¿®æ”¹<ul><li>FinalizableDelegatedExecutorService åº”ç”¨çš„æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåœ¨è°ƒç”¨æ„é€ æ–¹æ³•æ—¶å°†ThreadPoolExecutorå¯¹è±¡ä¼ ç»™äº†å†…éƒ¨çš„ExecutorServiceæ¥å£ã€‚åªå¯¹å¤–æš´éœ²äº† ExecutorService æ¥å£ï¼Œå› æ­¤ä¸èƒ½è°ƒç”¨ ThreadPoolExecutor ä¸­ç‰¹æœ‰çš„æ–¹æ³•ï¼Œä¹Ÿä¸èƒ½é‡æ–°è®¾ç½®çº¿ç¨‹æ± çš„å¤§å°ã€‚</li></ul></li><li>Executors.newFixedThreadPool(1) åˆå§‹æ—¶ä¸º1ï¼Œä»¥åè¿˜å¯ä»¥ä¿®æ”¹<ul><li>å¯¹å¤–æš´éœ²çš„æ˜¯ ThreadPoolExecutor å¯¹è±¡ï¼Œå¯ä»¥å¼ºè½¬åè°ƒç”¨ setCorePoolSize ç­‰æ–¹æ³•è¿›è¡Œä¿®æ”¹</li></ul></li></ul><h5 id=æäº¤ä»»åŠ¡><a href=#%e6%8f%90%e4%ba%a4%e4%bb%bb%e5%8a%a1 class=header-anchor>#</a>
æäº¤ä»»åŠ¡</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-361-1><a class=lnlinks href=#hl-361-1> 1</a>
</span><span class=lnt id=hl-361-2><a class=lnlinks href=#hl-361-2> 2</a>
</span><span class=lnt id=hl-361-3><a class=lnlinks href=#hl-361-3> 3</a>
</span><span class=lnt id=hl-361-4><a class=lnlinks href=#hl-361-4> 4</a>
</span><span class=lnt id=hl-361-5><a class=lnlinks href=#hl-361-5> 5</a>
</span><span class=lnt id=hl-361-6><a class=lnlinks href=#hl-361-6> 6</a>
</span><span class=lnt id=hl-361-7><a class=lnlinks href=#hl-361-7> 7</a>
</span><span class=lnt id=hl-361-8><a class=lnlinks href=#hl-361-8> 8</a>
</span><span class=lnt id=hl-361-9><a class=lnlinks href=#hl-361-9> 9</a>
</span><span class=lnt id=hl-361-10><a class=lnlinks href=#hl-361-10>10</a>
</span><span class=lnt id=hl-361-11><a class=lnlinks href=#hl-361-11>11</a>
</span><span class=lnt id=hl-361-12><a class=lnlinks href=#hl-361-12>12</a>
</span><span class=lnt id=hl-361-13><a class=lnlinks href=#hl-361-13>13</a>
</span><span class=lnt id=hl-361-14><a class=lnlinks href=#hl-361-14>14</a>
</span><span class=lnt id=hl-361-15><a class=lnlinks href=#hl-361-15>15</a>
</span><span class=lnt id=hl-361-16><a class=lnlinks href=#hl-361-16>16</a>
</span><span class=lnt id=hl-361-17><a class=lnlinks href=#hl-361-17>17</a>
</span><span class=lnt id=hl-361-18><a class=lnlinks href=#hl-361-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æ‰§è¡Œä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>command</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æäº¤ä»»åŠ¡ taskï¼Œç”¨è¿”å›å€¼ Future è·å¾—ä»»åŠ¡æ‰§è¡Œç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>submit</span><span class=p>(</span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>invokeAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå¸¦è¶…æ—¶æ—¶é—´ï¼Œæ—¶é—´è¶…æ—¶åï¼Œä¼šæ”¾å¼ƒæ‰§è¡Œåé¢çš„ä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>invokeAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                              </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>invokeAny</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆï¼Œå¸¦è¶…æ—¶æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>invokeAny</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>,</span><span class=w> </span><span class=n>TimeoutException</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•submit</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-362-1><a class=lnlinks href=#hl-362-1> 1</a>
</span><span class=lnt id=hl-362-2><a class=lnlinks href=#hl-362-2> 2</a>
</span><span class=lnt id=hl-362-3><a class=lnlinks href=#hl-362-3> 3</a>
</span><span class=lnt id=hl-362-4><a class=lnlinks href=#hl-362-4> 4</a>
</span><span class=lnt id=hl-362-5><a class=lnlinks href=#hl-362-5> 5</a>
</span><span class=lnt id=hl-362-6><a class=lnlinks href=#hl-362-6> 6</a>
</span><span class=lnt id=hl-362-7><a class=lnlinks href=#hl-362-7> 7</a>
</span><span class=lnt id=hl-362-8><a class=lnlinks href=#hl-362-8> 8</a>
</span><span class=lnt id=hl-362-9><a class=lnlinks href=#hl-362-9> 9</a>
</span><span class=lnt id=hl-362-10><a class=lnlinks href=#hl-362-10>10</a>
</span><span class=lnt id=hl-362-11><a class=lnlinks href=#hl-362-11>11</a>
</span><span class=lnt id=hl-362-12><a class=lnlinks href=#hl-362-12>12</a>
</span><span class=lnt id=hl-362-13><a class=lnlinks href=#hl-362-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method1</span><span class=p>(</span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;ok&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>future</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>method1</span><span class=p>(</span><span class=n>pool</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-363-1><a class=lnlinks href=#hl-363-1>1</a>
</span><span class=lnt id=hl-363-2><a class=lnlinks href=#hl-363-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:36:58.033 c.TestSubmit <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running
</span></span><span class=line><span class=cl>18:36:59.034 c.TestSubmit <span class=o>[</span>main<span class=o>]</span> - ok
</span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•invokeAll</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-364-1><a class=lnlinks href=#hl-364-1> 1</a>
</span><span class=lnt id=hl-364-2><a class=lnlinks href=#hl-364-2> 2</a>
</span><span class=lnt id=hl-364-3><a class=lnlinks href=#hl-364-3> 3</a>
</span><span class=lnt id=hl-364-4><a class=lnlinks href=#hl-364-4> 4</a>
</span><span class=lnt id=hl-364-5><a class=lnlinks href=#hl-364-5> 5</a>
</span><span class=lnt id=hl-364-6><a class=lnlinks href=#hl-364-6> 6</a>
</span><span class=lnt id=hl-364-7><a class=lnlinks href=#hl-364-7> 7</a>
</span><span class=lnt id=hl-364-8><a class=lnlinks href=#hl-364-8> 8</a>
</span><span class=lnt id=hl-364-9><a class=lnlinks href=#hl-364-9> 9</a>
</span><span class=lnt id=hl-364-10><a class=lnlinks href=#hl-364-10>10</a>
</span><span class=lnt id=hl-364-11><a class=lnlinks href=#hl-364-11>11</a>
</span><span class=lnt id=hl-364-12><a class=lnlinks href=#hl-364-12>12</a>
</span><span class=lnt id=hl-364-13><a class=lnlinks href=#hl-364-13>13</a>
</span><span class=lnt id=hl-364-14><a class=lnlinks href=#hl-364-14>14</a>
</span><span class=lnt id=hl-364-15><a class=lnlinks href=#hl-364-15>15</a>
</span><span class=lnt id=hl-364-16><a class=lnlinks href=#hl-364-16>16</a>
</span><span class=lnt id=hl-364-17><a class=lnlinks href=#hl-364-17>17</a>
</span><span class=lnt id=hl-364-18><a class=lnlinks href=#hl-364-18>18</a>
</span><span class=lnt id=hl-364-19><a class=lnlinks href=#hl-364-19>19</a>
</span><span class=lnt id=hl-364-20><a class=lnlinks href=#hl-364-20>20</a>
</span><span class=lnt id=hl-364-21><a class=lnlinks href=#hl-364-21>21</a>
</span><span class=lnt id=hl-364-22><a class=lnlinks href=#hl-364-22>22</a>
</span><span class=lnt id=hl-364-23><a class=lnlinks href=#hl-364-23>23</a>
</span><span class=lnt id=hl-364-24><a class=lnlinks href=#hl-364-24>24</a>
</span><span class=lnt id=hl-364-25><a class=lnlinks href=#hl-364-25>25</a>
</span><span class=lnt id=hl-364-26><a class=lnlinks href=#hl-364-26>26</a>
</span><span class=lnt id=hl-364-27><a class=lnlinks href=#hl-364-27>27</a>
</span><span class=lnt id=hl-364-28><a class=lnlinks href=#hl-364-28>28</a>
</span><span class=lnt id=hl-364-29><a class=lnlinks href=#hl-364-29>29</a>
</span><span class=lnt id=hl-364-30><a class=lnlinks href=#hl-364-30>30</a>
</span><span class=lnt id=hl-364-31><a class=lnlinks href=#hl-364-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method2</span><span class=p>(</span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>futures</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>invokeAll</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;1&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;2&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;3&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>futures</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>-&gt;</span><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>method2</span><span class=p>(</span><span class=n>pool</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-365-1><a class=lnlinks href=#hl-365-1>1</a>
</span><span class=lnt id=hl-365-2><a class=lnlinks href=#hl-365-2>2</a>
</span><span class=lnt id=hl-365-3><a class=lnlinks href=#hl-365-3>3</a>
</span><span class=lnt id=hl-365-4><a class=lnlinks href=#hl-365-4>4</a>
</span><span class=lnt id=hl-365-5><a class=lnlinks href=#hl-365-5>5</a>
</span><span class=lnt id=hl-365-6><a class=lnlinks href=#hl-365-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>16</span><span class=p>.</span><span class=na>530</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>pool</span><span class=o>-</span><span class=n>1</span><span class=o>-</span><span class=n>thread</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>17</span><span class=p>.</span><span class=na>530</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>pool</span><span class=o>-</span><span class=n>1</span><span class=o>-</span><span class=n>thread</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>18</span><span class=p>.</span><span class=na>040</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>pool</span><span class=o>-</span><span class=n>1</span><span class=o>-</span><span class=n>thread</span><span class=o>-</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>20</span><span class=p>.</span><span class=na>051</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>20</span><span class=p>.</span><span class=na>051</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>19</span><span class=p>:</span><span class=n>33</span><span class=p>:</span><span class=n>20</span><span class=p>.</span><span class=na>051</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>TestSubmit</span><span class=w> </span><span class=o>[</span><span class=n>main</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•invokeAny</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-366-1><a class=lnlinks href=#hl-366-1> 1</a>
</span><span class=lnt id=hl-366-2><a class=lnlinks href=#hl-366-2> 2</a>
</span><span class=lnt id=hl-366-3><a class=lnlinks href=#hl-366-3> 3</a>
</span><span class=lnt id=hl-366-4><a class=lnlinks href=#hl-366-4> 4</a>
</span><span class=lnt id=hl-366-5><a class=lnlinks href=#hl-366-5> 5</a>
</span><span class=lnt id=hl-366-6><a class=lnlinks href=#hl-366-6> 6</a>
</span><span class=lnt id=hl-366-7><a class=lnlinks href=#hl-366-7> 7</a>
</span><span class=lnt id=hl-366-8><a class=lnlinks href=#hl-366-8> 8</a>
</span><span class=lnt id=hl-366-9><a class=lnlinks href=#hl-366-9> 9</a>
</span><span class=lnt id=hl-366-10><a class=lnlinks href=#hl-366-10>10</a>
</span><span class=lnt id=hl-366-11><a class=lnlinks href=#hl-366-11>11</a>
</span><span class=lnt id=hl-366-12><a class=lnlinks href=#hl-366-12>12</a>
</span><span class=lnt id=hl-366-13><a class=lnlinks href=#hl-366-13>13</a>
</span><span class=lnt id=hl-366-14><a class=lnlinks href=#hl-366-14>14</a>
</span><span class=lnt id=hl-366-15><a class=lnlinks href=#hl-366-15>15</a>
</span><span class=lnt id=hl-366-16><a class=lnlinks href=#hl-366-16>16</a>
</span><span class=lnt id=hl-366-17><a class=lnlinks href=#hl-366-17>17</a>
</span><span class=lnt id=hl-366-18><a class=lnlinks href=#hl-366-18>18</a>
</span><span class=lnt id=hl-366-19><a class=lnlinks href=#hl-366-19>19</a>
</span><span class=lnt id=hl-366-20><a class=lnlinks href=#hl-366-20>20</a>
</span><span class=lnt id=hl-366-21><a class=lnlinks href=#hl-366-21>21</a>
</span><span class=lnt id=hl-366-22><a class=lnlinks href=#hl-366-22>22</a>
</span><span class=lnt id=hl-366-23><a class=lnlinks href=#hl-366-23>23</a>
</span><span class=lnt id=hl-366-24><a class=lnlinks href=#hl-366-24>24</a>
</span><span class=lnt id=hl-366-25><a class=lnlinks href=#hl-366-25>25</a>
</span><span class=lnt id=hl-366-26><a class=lnlinks href=#hl-366-26>26</a>
</span><span class=lnt id=hl-366-27><a class=lnlinks href=#hl-366-27>27</a>
</span><span class=lnt id=hl-366-28><a class=lnlinks href=#hl-366-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>method3</span><span class=p>(</span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>invokeAny</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin 1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end 1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;1&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin 2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end 2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;2&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin 3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end 3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;3&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//ExecutorService pool = Executors.newFixedThreadPool(1);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>method3</span><span class=p>(</span><span class=n>pool</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-367-1><a class=lnlinks href=#hl-367-1> 1</a>
</span><span class=lnt id=hl-367-2><a class=lnlinks href=#hl-367-2> 2</a>
</span><span class=lnt id=hl-367-3><a class=lnlinks href=#hl-367-3> 3</a>
</span><span class=lnt id=hl-367-4><a class=lnlinks href=#hl-367-4> 4</a>
</span><span class=lnt id=hl-367-5><a class=lnlinks href=#hl-367-5> 5</a>
</span><span class=lnt id=hl-367-6><a class=lnlinks href=#hl-367-6> 6</a>
</span><span class=lnt id=hl-367-7><a class=lnlinks href=#hl-367-7> 7</a>
</span><span class=lnt id=hl-367-8><a class=lnlinks href=#hl-367-8> 8</a>
</span><span class=lnt id=hl-367-9><a class=lnlinks href=#hl-367-9> 9</a>
</span><span class=lnt id=hl-367-10><a class=lnlinks href=#hl-367-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:44:46.314 c.TestSubmit <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - begin <span class=m>1</span>
</span></span><span class=line><span class=cl>19:44:46.314 c.TestSubmit <span class=o>[</span>pool-1-thread-3<span class=o>]</span> - begin <span class=m>3</span>
</span></span><span class=line><span class=cl>19:44:46.314 c.TestSubmit <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - begin <span class=m>2</span>
</span></span><span class=line><span class=cl>19:44:46.817 c.TestSubmit <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - end <span class=m>2</span>
</span></span><span class=line><span class=cl>19:44:46.817 c.TestSubmit <span class=o>[</span>main<span class=o>]</span> - <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>19:47:16.063 c.TestSubmit <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - begin <span class=m>1</span>
</span></span><span class=line><span class=cl>19:47:17.063 c.TestSubmit <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - end <span class=m>1</span>
</span></span><span class=line><span class=cl>19:47:17.063 c.TestSubmit <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - begin <span class=m>2</span>
</span></span><span class=line><span class=cl>19:47:17.063 c.TestSubmit <span class=o>[</span>main<span class=o>]</span> - <span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=å…³é—­çº¿ç¨‹æ± ><a href=#%e5%85%b3%e9%97%ad%e7%ba%bf%e7%a8%8b%e6%b1%a0 class=header-anchor>#</a>
å…³é—­çº¿ç¨‹æ± </h5><p><strong>shutdown</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-368-1><a class=lnlinks href=#hl-368-1>1</a>
</span><span class=lnt id=hl-368-2><a class=lnlinks href=#hl-368-2>2</a>
</span><span class=lnt id=hl-368-3><a class=lnlinks href=#hl-368-3>3</a>
</span><span class=lnt id=hl-368-4><a class=lnlinks href=#hl-368-4>4</a>
</span><span class=lnt id=hl-368-5><a class=lnlinks href=#hl-368-5>5</a>
</span><span class=lnt id=hl-368-6><a class=lnlinks href=#hl-368-6>6</a>
</span><span class=lnt id=hl-368-7><a class=lnlinks href=#hl-368-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º SHUTDOWN
</span></span></span><span class=line><span class=cl><span class=cm>- ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡
</span></span></span><span class=line><span class=cl><span class=cm>- ä½†å·²æäº¤ä»»åŠ¡ä¼šæ‰§è¡Œå®Œ
</span></span></span><span class=line><span class=cl><span class=cm>- æ­¤æ–¹æ³•ä¸ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹çš„æ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>shutdown</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-369-1><a class=lnlinks href=#hl-369-1> 1</a>
</span><span class=lnt id=hl-369-2><a class=lnlinks href=#hl-369-2> 2</a>
</span><span class=lnt id=hl-369-3><a class=lnlinks href=#hl-369-3> 3</a>
</span><span class=lnt id=hl-369-4><a class=lnlinks href=#hl-369-4> 4</a>
</span><span class=lnt id=hl-369-5><a class=lnlinks href=#hl-369-5> 5</a>
</span><span class=lnt id=hl-369-6><a class=lnlinks href=#hl-369-6> 6</a>
</span><span class=lnt id=hl-369-7><a class=lnlinks href=#hl-369-7> 7</a>
</span><span class=lnt id=hl-369-8><a class=lnlinks href=#hl-369-8> 8</a>
</span><span class=lnt id=hl-369-9><a class=lnlinks href=#hl-369-9> 9</a>
</span><span class=lnt id=hl-369-10><a class=lnlinks href=#hl-369-10>10</a>
</span><span class=lnt id=hl-369-11><a class=lnlinks href=#hl-369-11>11</a>
</span><span class=lnt id=hl-369-12><a class=lnlinks href=#hl-369-12>12</a>
</span><span class=lnt id=hl-369-13><a class=lnlinks href=#hl-369-13>13</a>
</span><span class=lnt id=hl-369-14><a class=lnlinks href=#hl-369-14>14</a>
</span><span class=lnt id=hl-369-15><a class=lnlinks href=#hl-369-15>15</a>
</span><span class=lnt id=hl-369-16><a class=lnlinks href=#hl-369-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>shutdown</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>mainLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>mainLock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mainLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkShutdownAccess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>advanceRunState</span><span class=p>(</span><span class=n>SHUTDOWN</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä»…ä¼šæ‰“æ–­ç©ºé—²çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>interruptIdleWorkers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>onShutdown</span><span class=p>();</span><span class=w> </span><span class=c1>// æ‰©å±•ç‚¹ ScheduledThreadPoolExecutor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mainLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°è¯•ç»ˆç»“(æ²¡æœ‰è¿è¡Œçš„çº¿ç¨‹å¯ä»¥ç«‹åˆ»ç»ˆç»“ï¼Œå¦‚æœè¿˜æœ‰è¿è¡Œçš„çº¿ç¨‹ä¹Ÿä¸ä¼šç­‰)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tryTerminate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>shutdownNow</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-370-1><a class=lnlinks href=#hl-370-1>1</a>
</span><span class=lnt id=hl-370-2><a class=lnlinks href=#hl-370-2>2</a>
</span><span class=lnt id=hl-370-3><a class=lnlinks href=#hl-370-3>3</a>
</span><span class=lnt id=hl-370-4><a class=lnlinks href=#hl-370-4>4</a>
</span><span class=lnt id=hl-370-5><a class=lnlinks href=#hl-370-5>5</a>
</span><span class=lnt id=hl-370-6><a class=lnlinks href=#hl-370-6>6</a>
</span><span class=lnt id=hl-370-7><a class=lnlinks href=#hl-370-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º STOP
</span></span></span><span class=line><span class=cl><span class=cm>- ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡
</span></span></span><span class=line><span class=cl><span class=cm>- ä¼šå°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿”å›
</span></span></span><span class=line><span class=cl><span class=cm>- å¹¶ç”¨ interrupt çš„æ–¹å¼ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>shutdownNow</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-371-1><a class=lnlinks href=#hl-371-1> 1</a>
</span><span class=lnt id=hl-371-2><a class=lnlinks href=#hl-371-2> 2</a>
</span><span class=lnt id=hl-371-3><a class=lnlinks href=#hl-371-3> 3</a>
</span><span class=lnt id=hl-371-4><a class=lnlinks href=#hl-371-4> 4</a>
</span><span class=lnt id=hl-371-5><a class=lnlinks href=#hl-371-5> 5</a>
</span><span class=lnt id=hl-371-6><a class=lnlinks href=#hl-371-6> 6</a>
</span><span class=lnt id=hl-371-7><a class=lnlinks href=#hl-371-7> 7</a>
</span><span class=lnt id=hl-371-8><a class=lnlinks href=#hl-371-8> 8</a>
</span><span class=lnt id=hl-371-9><a class=lnlinks href=#hl-371-9> 9</a>
</span><span class=lnt id=hl-371-10><a class=lnlinks href=#hl-371-10>10</a>
</span><span class=lnt id=hl-371-11><a class=lnlinks href=#hl-371-11>11</a>
</span><span class=lnt id=hl-371-12><a class=lnlinks href=#hl-371-12>12</a>
</span><span class=lnt id=hl-371-13><a class=lnlinks href=#hl-371-13>13</a>
</span><span class=lnt id=hl-371-14><a class=lnlinks href=#hl-371-14>14</a>
</span><span class=lnt id=hl-371-15><a class=lnlinks href=#hl-371-15>15</a>
</span><span class=lnt id=hl-371-16><a class=lnlinks href=#hl-371-16>16</a>
</span><span class=lnt id=hl-371-17><a class=lnlinks href=#hl-371-17>17</a>
</span><span class=lnt id=hl-371-18><a class=lnlinks href=#hl-371-18>18</a>
</span><span class=lnt id=hl-371-19><a class=lnlinks href=#hl-371-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>shutdownNow</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>mainLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>mainLock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mainLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkShutdownAccess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>advanceRunState</span><span class=p>(</span><span class=n>STOP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‰“æ–­æ‰€æœ‰çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>interruptWorkers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å–é˜Ÿåˆ—ä¸­å‰©ä½™ä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tasks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>drainQueue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mainLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°è¯•ç»ˆç»“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tryTerminate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>tasks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>å…¶ä»–æ–¹æ³•</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-372-1><a class=lnlinks href=#hl-372-1>1</a>
</span><span class=lnt id=hl-372-2><a class=lnlinks href=#hl-372-2>2</a>
</span><span class=lnt id=hl-372-3><a class=lnlinks href=#hl-372-3>3</a>
</span><span class=lnt id=hl-372-4><a class=lnlinks href=#hl-372-4>4</a>
</span><span class=lnt id=hl-372-5><a class=lnlinks href=#hl-372-5>5</a>
</span><span class=lnt id=hl-372-6><a class=lnlinks href=#hl-372-6>6</a>
</span><span class=lnt id=hl-372-7><a class=lnlinks href=#hl-372-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ä¸åœ¨ RUNNING çŠ¶æ€çš„çº¿ç¨‹æ± ï¼Œæ­¤æ–¹æ³•å°±è¿”å› true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=nf>isShutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯ TERMINATED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=nf>isTerminated</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è°ƒç”¨ shutdown åï¼Œç”±äºè°ƒç”¨çº¿ç¨‹å¹¶ä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡è¿è¡Œç»“æŸï¼Œå› æ­¤å¦‚æœå®ƒæƒ³åœ¨çº¿ç¨‹æ±  TERMINATED ååšäº›äº‹æƒ…ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ–¹æ³•ç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä¸€èˆ¬taskæ˜¯Callableç±»å‹çš„æ—¶å€™ä¸ç”¨æ­¤æ–¹æ³•ï¼Œå› ä¸ºfutureTask.getæ–¹æ³•è‡ªå¸¦ç­‰å¾…åŠŸèƒ½ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=nf>awaitTermination</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>æµ‹è¯•shutdownã€shutdownNowã€awaitTermination</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-373-1><a class=lnlinks href=#hl-373-1> 1</a>
</span><span class=lnt id=hl-373-2><a class=lnlinks href=#hl-373-2> 2</a>
</span><span class=lnt id=hl-373-3><a class=lnlinks href=#hl-373-3> 3</a>
</span><span class=lnt id=hl-373-4><a class=lnlinks href=#hl-373-4> 4</a>
</span><span class=lnt id=hl-373-5><a class=lnlinks href=#hl-373-5> 5</a>
</span><span class=lnt id=hl-373-6><a class=lnlinks href=#hl-373-6> 6</a>
</span><span class=lnt id=hl-373-7><a class=lnlinks href=#hl-373-7> 7</a>
</span><span class=lnt id=hl-373-8><a class=lnlinks href=#hl-373-8> 8</a>
</span><span class=lnt id=hl-373-9><a class=lnlinks href=#hl-373-9> 9</a>
</span><span class=lnt id=hl-373-10><a class=lnlinks href=#hl-373-10>10</a>
</span><span class=lnt id=hl-373-11><a class=lnlinks href=#hl-373-11>11</a>
</span><span class=lnt id=hl-373-12><a class=lnlinks href=#hl-373-12>12</a>
</span><span class=lnt id=hl-373-13><a class=lnlinks href=#hl-373-13>13</a>
</span><span class=lnt id=hl-373-14><a class=lnlinks href=#hl-373-14>14</a>
</span><span class=lnt id=hl-373-15><a class=lnlinks href=#hl-373-15>15</a>
</span><span class=lnt id=hl-373-16><a class=lnlinks href=#hl-373-16>16</a>
</span><span class=lnt id=hl-373-17><a class=lnlinks href=#hl-373-17>17</a>
</span><span class=lnt id=hl-373-18><a class=lnlinks href=#hl-373-18>18</a>
</span><span class=lnt id=hl-373-19><a class=lnlinks href=#hl-373-19>19</a>
</span><span class=lnt id=hl-373-20><a class=lnlinks href=#hl-373-20>20</a>
</span><span class=lnt id=hl-373-21><a class=lnlinks href=#hl-373-21>21</a>
</span><span class=lnt id=hl-373-22><a class=lnlinks href=#hl-373-22>22</a>
</span><span class=lnt id=hl-373-23><a class=lnlinks href=#hl-373-23>23</a>
</span><span class=lnt id=hl-373-24><a class=lnlinks href=#hl-373-24>24</a>
</span><span class=lnt id=hl-373-25><a class=lnlinks href=#hl-373-25>25</a>
</span><span class=lnt id=hl-373-26><a class=lnlinks href=#hl-373-26>26</a>
</span><span class=lnt id=hl-373-27><a class=lnlinks href=#hl-373-27>27</a>
</span><span class=lnt id=hl-373-28><a class=lnlinks href=#hl-373-28>28</a>
</span><span class=lnt id=hl-373-29><a class=lnlinks href=#hl-373-29>29</a>
</span><span class=lnt id=hl-373-30><a class=lnlinks href=#hl-373-30>30</a>
</span><span class=lnt id=hl-373-31><a class=lnlinks href=#hl-373-31>31</a>
</span><span class=lnt id=hl-373-32><a class=lnlinks href=#hl-373-32>32</a>
</span><span class=lnt id=hl-373-33><a class=lnlinks href=#hl-373-33>33</a>
</span><span class=lnt id=hl-373-34><a class=lnlinks href=#hl-373-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.TestShutDown&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestShutDown</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ExecutionException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>result1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 1 running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 1 finish...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>result2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 2 running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 2 finish...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>result3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 3 running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 3 finish...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;shutdown&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pool</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//        pool.awaitTermination(3, TimeUnit.SECONDS);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//        List&lt;Runnable&gt; runnables = pool.shutdownNow();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//        log.debug(&#34;other.... {}&#34; , runnables);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-374-1><a class=lnlinks href=#hl-374-1> 1</a>
</span><span class=lnt id=hl-374-2><a class=lnlinks href=#hl-374-2> 2</a>
</span><span class=lnt id=hl-374-3><a class=lnlinks href=#hl-374-3> 3</a>
</span><span class=lnt id=hl-374-4><a class=lnlinks href=#hl-374-4> 4</a>
</span><span class=lnt id=hl-374-5><a class=lnlinks href=#hl-374-5> 5</a>
</span><span class=lnt id=hl-374-6><a class=lnlinks href=#hl-374-6> 6</a>
</span><span class=lnt id=hl-374-7><a class=lnlinks href=#hl-374-7> 7</a>
</span><span class=lnt id=hl-374-8><a class=lnlinks href=#hl-374-8> 8</a>
</span><span class=lnt id=hl-374-9><a class=lnlinks href=#hl-374-9> 9</a>
</span><span class=lnt id=hl-374-10><a class=lnlinks href=#hl-374-10>10</a>
</span><span class=lnt id=hl-374-11><a class=lnlinks href=#hl-374-11>11</a>
</span><span class=lnt id=hl-374-12><a class=lnlinks href=#hl-374-12>12</a>
</span><span class=lnt id=hl-374-13><a class=lnlinks href=#hl-374-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1>#shutdownä¾æ—§ä¼šæ‰§è¡Œå‰©ä¸‹çš„ä»»åŠ¡</span>
</span></span><span class=line><span class=cl>20:09:13.285 c.TestShutDown <span class=o>[</span>main<span class=o>]</span> - shutdown
</span></span><span class=line><span class=cl>20:09:13.285 c.TestShutDown <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - task <span class=m>1</span> running...
</span></span><span class=line><span class=cl>20:09:13.285 c.TestShutDown <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - task <span class=m>2</span> running...
</span></span><span class=line><span class=cl>20:09:14.293 c.TestShutDown <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - task <span class=m>2</span> finish...
</span></span><span class=line><span class=cl>20:09:14.293 c.TestShutDown <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - task <span class=m>1</span> finish...
</span></span><span class=line><span class=cl>20:09:14.293 c.TestShutDown <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - task <span class=m>3</span> running...
</span></span><span class=line><span class=cl>20:09:15.303 c.TestShutDown <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - task <span class=m>3</span> finish...
</span></span><span class=line><span class=cl><span class=c1>#shutdownNowç«‹åˆ»åœæ­¢æ‰€æœ‰ä»»åŠ¡</span>
</span></span><span class=line><span class=cl>20:11:11.750 c.TestShutDown <span class=o>[</span>main<span class=o>]</span> - shutdown
</span></span><span class=line><span class=cl>20:11:11.750 c.TestShutDown <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - task <span class=m>1</span> running...
</span></span><span class=line><span class=cl>20:11:11.750 c.TestShutDown <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - task <span class=m>2</span> running...
</span></span><span class=line><span class=cl>20:11:11.750 c.TestShutDown <span class=o>[</span>main<span class=o>]</span> - other.... <span class=o>[</span>java.util.concurrent.FutureTask@66d33a<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=font-colororangeæ¨¡å¼ä¹‹-worker-threadfont><a href=#font-colororange%e6%a8%a1%e5%bc%8f%e4%b9%8b-worker-threadfont class=header-anchor>#</a>
<font color=orange>*æ¨¡å¼ä¹‹ Worker Thread</font></h5><p><strong>å®šä¹‰</strong></p><p>è®©æœ‰é™çš„å·¥ä½œçº¿ç¨‹ï¼ˆWorker Threadï¼‰æ¥è½®æµå¼‚æ­¥å¤„ç†æ— é™å¤šçš„ä»»åŠ¡ã€‚ä¹Ÿå¯ä»¥å°†å…¶å½’ç±»ä¸ºåˆ†å·¥æ¨¡å¼ï¼Œå®ƒçš„å…¸å‹å®ç° å°±æ˜¯çº¿ç¨‹æ± ï¼Œä¹Ÿä½“ç°äº†ç»å…¸è®¾è®¡æ¨¡å¼ä¸­çš„äº«å…ƒæ¨¡å¼ã€‚</p><p>ä¾‹å¦‚ï¼Œæµ·åº•æçš„æœåŠ¡å‘˜ï¼ˆçº¿ç¨‹ï¼‰ï¼Œè½®æµå¤„ç†æ¯ä½å®¢äººçš„ç‚¹é¤ï¼ˆä»»åŠ¡ï¼‰ï¼Œå¦‚æœä¸ºæ¯ä½å®¢äººéƒ½é…ä¸€åä¸“å±çš„æœåŠ¡å‘˜ï¼Œé‚£ ä¹ˆæˆæœ¬å°±å¤ªé«˜äº†ï¼ˆå¯¹æ¯”å¦ä¸€ç§å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼ï¼šThread-Per-Messageï¼‰</p><p>æ³¨æ„ï¼Œä¸åŒä»»åŠ¡ç±»å‹åº”è¯¥ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼Œè¿™æ ·èƒ½å¤Ÿé¿å…é¥¥é¥¿ï¼Œå¹¶èƒ½æå‡æ•ˆç‡</p><p>ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªé¤é¦†çš„å·¥äººæ—¢è¦æ‹›å‘¼å®¢äººï¼ˆä»»åŠ¡ç±»å‹Aï¼‰ï¼Œåˆè¦åˆ°åå¨åšèœï¼ˆä»»åŠ¡ç±»å‹Bï¼‰æ˜¾ç„¶æ•ˆç‡ä¸å’‹åœ°ï¼Œåˆ†æˆ æœåŠ¡å‘˜ï¼ˆçº¿ç¨‹æ± Aï¼‰ä¸å¨å¸ˆï¼ˆçº¿ç¨‹æ± Bï¼‰æ›´ä¸ºåˆç†ï¼Œå½“ç„¶ä½ èƒ½æƒ³åˆ°æ›´ç»†è‡´çš„åˆ†å·¥</p><p><strong>é¥¥é¥¿</strong></p><p>å›ºå®šå¤§å°çº¿ç¨‹æ± ä¼šæœ‰é¥¥é¥¿ç°è±¡</p><ul><li><p>ä¸¤ä¸ªå·¥äººæ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„ä¸¤ä¸ªçº¿ç¨‹</p></li><li><p>ä»–ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šä¸ºå®¢äººç‚¹é¤å’Œåˆ°åå¨åšèœï¼Œè¿™æ˜¯ä¸¤ä¸ªé˜¶æ®µçš„å·¥ä½œ</p><ul><li>å®¢äººç‚¹é¤ï¼šå¿…é¡»å…ˆç‚¹å®Œé¤ï¼Œç­‰èœåšå¥½ï¼Œä¸Šèœï¼Œåœ¨æ­¤æœŸé—´å¤„ç†ç‚¹é¤çš„å·¥äººå¿…é¡»ç­‰å¾…</li><li>åå¨åšèœï¼šæ²¡å•¥è¯´çš„ï¼Œåšå°±æ˜¯äº†</li></ul></li><li><p>æ¯”å¦‚å·¥äººA å¤„ç†äº†ç‚¹é¤ä»»åŠ¡ï¼Œæ¥ä¸‹æ¥å®ƒè¦ç­‰ç€ å·¥äººB æŠŠèœåšå¥½ï¼Œç„¶åä¸Šèœï¼Œä»–ä¿©ä¹Ÿé…åˆçš„è›®å¥½</p></li><li><p>ä½†ç°åœ¨åŒæ—¶æ¥äº†ä¸¤ä¸ªå®¢äººï¼Œè¿™ä¸ªæ—¶å€™å·¥äººA å’Œå·¥äººB éƒ½å»å¤„ç†ç‚¹é¤äº†ï¼Œè¿™æ—¶æ²¡äººåšé¥­äº†ï¼Œé¥¥é¥¿</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-375-1><a class=lnlinks href=#hl-375-1> 1</a>
</span><span class=lnt id=hl-375-2><a class=lnlinks href=#hl-375-2> 2</a>
</span><span class=lnt id=hl-375-3><a class=lnlinks href=#hl-375-3> 3</a>
</span><span class=lnt id=hl-375-4><a class=lnlinks href=#hl-375-4> 4</a>
</span><span class=lnt id=hl-375-5><a class=lnlinks href=#hl-375-5> 5</a>
</span><span class=lnt id=hl-375-6><a class=lnlinks href=#hl-375-6> 6</a>
</span><span class=lnt id=hl-375-7><a class=lnlinks href=#hl-375-7> 7</a>
</span><span class=lnt id=hl-375-8><a class=lnlinks href=#hl-375-8> 8</a>
</span><span class=lnt id=hl-375-9><a class=lnlinks href=#hl-375-9> 9</a>
</span><span class=lnt id=hl-375-10><a class=lnlinks href=#hl-375-10>10</a>
</span><span class=lnt id=hl-375-11><a class=lnlinks href=#hl-375-11>11</a>
</span><span class=lnt id=hl-375-12><a class=lnlinks href=#hl-375-12>12</a>
</span><span class=lnt id=hl-375-13><a class=lnlinks href=#hl-375-13>13</a>
</span><span class=lnt id=hl-375-14><a class=lnlinks href=#hl-375-14>14</a>
</span><span class=lnt id=hl-375-15><a class=lnlinks href=#hl-375-15>15</a>
</span><span class=lnt id=hl-375-16><a class=lnlinks href=#hl-375-16>16</a>
</span><span class=lnt id=hl-375-17><a class=lnlinks href=#hl-375-17>17</a>
</span><span class=lnt id=hl-375-18><a class=lnlinks href=#hl-375-18>18</a>
</span><span class=lnt id=hl-375-19><a class=lnlinks href=#hl-375-19>19</a>
</span><span class=lnt id=hl-375-20><a class=lnlinks href=#hl-375-20>20</a>
</span><span class=lnt id=hl-375-21><a class=lnlinks href=#hl-375-21>21</a>
</span><span class=lnt id=hl-375-22><a class=lnlinks href=#hl-375-22>22</a>
</span><span class=lnt id=hl-375-23><a class=lnlinks href=#hl-375-23>23</a>
</span><span class=lnt id=hl-375-24><a class=lnlinks href=#hl-375-24>24</a>
</span><span class=lnt id=hl-375-25><a class=lnlinks href=#hl-375-25>25</a>
</span><span class=lnt id=hl-375-26><a class=lnlinks href=#hl-375-26>26</a>
</span><span class=lnt id=hl-375-27><a class=lnlinks href=#hl-375-27>27</a>
</span><span class=lnt id=hl-375-28><a class=lnlinks href=#hl-375-28>28</a>
</span><span class=lnt id=hl-375-29><a class=lnlinks href=#hl-375-29>29</a>
</span><span class=lnt id=hl-375-30><a class=lnlinks href=#hl-375-30>30</a>
</span><span class=lnt id=hl-375-31><a class=lnlinks href=#hl-375-31>31</a>
</span><span class=lnt id=hl-375-32><a class=lnlinks href=#hl-375-32>32</a>
</span><span class=lnt id=hl-375-33><a class=lnlinks href=#hl-375-33>33</a>
</span><span class=lnt id=hl-375-34><a class=lnlinks href=#hl-375-34>34</a>
</span><span class=lnt id=hl-375-35><a class=lnlinks href=#hl-375-35>35</a>
</span><span class=lnt id=hl-375-36><a class=lnlinks href=#hl-375-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestDeadLock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>MENU</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=s>&#34;åœ°ä¸‰é²œ&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;å®«ä¿é¸¡ä¸&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;è¾£å­é¸¡ä¸&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;çƒ¤é¸¡ç¿…&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Random</span><span class=w> </span><span class=n>RANDOM</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>cooking</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>MENU</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>RANDOM</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>MENU</span><span class=p>.</span><span class=na>size</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>executorService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>executorService</span><span class=p>.</span><span class=na>execute</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¤„ç†ç‚¹é¤...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>executorService</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;åšèœ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>cooking</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ä¸Šèœ: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>        executorService.execute(() -&gt; {
</span></span></span><span class=line><span class=cl><span class=cm>            log.debug(&#34;å¤„ç†ç‚¹é¤...&#34;);
</span></span></span><span class=line><span class=cl><span class=cm>            Future&lt;String&gt; f = executorService.submit(() -&gt; {
</span></span></span><span class=line><span class=cl><span class=cm>                log.debug(&#34;åšèœ&#34;);
</span></span></span><span class=line><span class=cl><span class=cm>                return cooking();
</span></span></span><span class=line><span class=cl><span class=cm>            });
</span></span></span><span class=line><span class=cl><span class=cm>            try {
</span></span></span><span class=line><span class=cl><span class=cm>                log.debug(&#34;ä¸Šèœ: {}&#34;, f.get());
</span></span></span><span class=line><span class=cl><span class=cm>            } catch (InterruptedException | ExecutionException e) {
</span></span></span><span class=line><span class=cl><span class=cm>                e.printStackTrace();
</span></span></span><span class=line><span class=cl><span class=cm>            }
</span></span></span><span class=line><span class=cl><span class=cm>        });
</span></span></span><span class=line><span class=cl><span class=cm>        */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-376-1><a class=lnlinks href=#hl-376-1>1</a>
</span><span class=lnt id=hl-376-2><a class=lnlinks href=#hl-376-2>2</a>
</span><span class=lnt id=hl-376-3><a class=lnlinks href=#hl-376-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>17:21:27.883 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - å¤„ç†ç‚¹é¤...
</span></span><span class=line><span class=cl>17:21:27.891 c.TestDeadLock <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - åšèœ
</span></span><span class=line><span class=cl>17:21:27.891 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - ä¸Šèœ: çƒ¤é¸¡ç¿…
</span></span></code></pre></td></tr></table></div></div><p>å½“æ³¨é‡Šå–æ¶ˆåï¼Œå¯èƒ½çš„è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-377-1><a class=lnlinks href=#hl-377-1>1</a>
</span><span class=lnt id=hl-377-2><a class=lnlinks href=#hl-377-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>17:08:41.339 c.TestDeadLock <span class=o>[</span>pool-1-thread-2<span class=o>]</span> - å¤„ç†ç‚¹é¤...  
</span></span><span class=line><span class=cl>17:08:41.339 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - å¤„ç†ç‚¹é¤... 
</span></span></code></pre></td></tr></table></div></div><p>è§£å†³æ–¹æ³•å¯ä»¥å¢åŠ çº¿ç¨‹æ± çš„å¤§å°ï¼Œä¸è¿‡ä¸æ˜¯æ ¹æœ¬è§£å†³æ–¹æ¡ˆï¼Œè¿˜æ˜¯å‰é¢æåˆ°çš„ï¼Œä¸åŒçš„ä»»åŠ¡ç±»å‹ï¼Œé‡‡ç”¨ä¸åŒçš„çº¿ç¨‹ æ± ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-378-1><a class=lnlinks href=#hl-378-1> 1</a>
</span><span class=lnt id=hl-378-2><a class=lnlinks href=#hl-378-2> 2</a>
</span><span class=lnt id=hl-378-3><a class=lnlinks href=#hl-378-3> 3</a>
</span><span class=lnt id=hl-378-4><a class=lnlinks href=#hl-378-4> 4</a>
</span><span class=lnt id=hl-378-5><a class=lnlinks href=#hl-378-5> 5</a>
</span><span class=lnt id=hl-378-6><a class=lnlinks href=#hl-378-6> 6</a>
</span><span class=lnt id=hl-378-7><a class=lnlinks href=#hl-378-7> 7</a>
</span><span class=lnt id=hl-378-8><a class=lnlinks href=#hl-378-8> 8</a>
</span><span class=lnt id=hl-378-9><a class=lnlinks href=#hl-378-9> 9</a>
</span><span class=lnt id=hl-378-10><a class=lnlinks href=#hl-378-10>10</a>
</span><span class=lnt id=hl-378-11><a class=lnlinks href=#hl-378-11>11</a>
</span><span class=lnt id=hl-378-12><a class=lnlinks href=#hl-378-12>12</a>
</span><span class=lnt id=hl-378-13><a class=lnlinks href=#hl-378-13>13</a>
</span><span class=lnt id=hl-378-14><a class=lnlinks href=#hl-378-14>14</a>
</span><span class=lnt id=hl-378-15><a class=lnlinks href=#hl-378-15>15</a>
</span><span class=lnt id=hl-378-16><a class=lnlinks href=#hl-378-16>16</a>
</span><span class=lnt id=hl-378-17><a class=lnlinks href=#hl-378-17>17</a>
</span><span class=lnt id=hl-378-18><a class=lnlinks href=#hl-378-18>18</a>
</span><span class=lnt id=hl-378-19><a class=lnlinks href=#hl-378-19>19</a>
</span><span class=lnt id=hl-378-20><a class=lnlinks href=#hl-378-20>20</a>
</span><span class=lnt id=hl-378-21><a class=lnlinks href=#hl-378-21>21</a>
</span><span class=lnt id=hl-378-22><a class=lnlinks href=#hl-378-22>22</a>
</span><span class=lnt id=hl-378-23><a class=lnlinks href=#hl-378-23>23</a>
</span><span class=lnt id=hl-378-24><a class=lnlinks href=#hl-378-24>24</a>
</span><span class=lnt id=hl-378-25><a class=lnlinks href=#hl-378-25>25</a>
</span><span class=lnt id=hl-378-26><a class=lnlinks href=#hl-378-26>26</a>
</span><span class=lnt id=hl-378-27><a class=lnlinks href=#hl-378-27>27</a>
</span><span class=lnt id=hl-378-28><a class=lnlinks href=#hl-378-28>28</a>
</span><span class=lnt id=hl-378-29><a class=lnlinks href=#hl-378-29>29</a>
</span><span class=lnt id=hl-378-30><a class=lnlinks href=#hl-378-30>30</a>
</span><span class=lnt id=hl-378-31><a class=lnlinks href=#hl-378-31>31</a>
</span><span class=lnt id=hl-378-32><a class=lnlinks href=#hl-378-32>32</a>
</span><span class=lnt id=hl-378-33><a class=lnlinks href=#hl-378-33>33</a>
</span><span class=lnt id=hl-378-34><a class=lnlinks href=#hl-378-34>34</a>
</span><span class=lnt id=hl-378-35><a class=lnlinks href=#hl-378-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestDeadLock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>MENU</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=s>&#34;åœ°ä¸‰é²œ&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;å®«ä¿é¸¡ä¸&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;è¾£å­é¸¡ä¸&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;çƒ¤é¸¡ç¿…&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>Random</span><span class=w> </span><span class=n>RANDOM</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>cooking</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>MENU</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>RANDOM</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>MENU</span><span class=p>.</span><span class=na>size</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>waiterPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>cookPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>waiterPool</span><span class=p>.</span><span class=na>execute</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¤„ç†ç‚¹é¤...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cookPool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;åšèœ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>cooking</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ä¸Šèœ: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>waiterPool</span><span class=p>.</span><span class=na>execute</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å¤„ç†ç‚¹é¤...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cookPool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;åšèœ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>cooking</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ä¸Šèœ: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-379-1><a class=lnlinks href=#hl-379-1>1</a>
</span><span class=lnt id=hl-379-2><a class=lnlinks href=#hl-379-2>2</a>
</span><span class=lnt id=hl-379-3><a class=lnlinks href=#hl-379-3>3</a>
</span><span class=lnt id=hl-379-4><a class=lnlinks href=#hl-379-4>4</a>
</span><span class=lnt id=hl-379-5><a class=lnlinks href=#hl-379-5>5</a>
</span><span class=lnt id=hl-379-6><a class=lnlinks href=#hl-379-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>17:25:14.626 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - å¤„ç†ç‚¹é¤... 
</span></span><span class=line><span class=cl>17:25:14.630 c.TestDeadLock <span class=o>[</span>pool-2-thread-1<span class=o>]</span> - åšèœ
</span></span><span class=line><span class=cl>17:25:14.631 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - ä¸Šèœ: åœ°ä¸‰é²œ
</span></span><span class=line><span class=cl>17:25:14.632 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - å¤„ç†ç‚¹é¤... 
</span></span><span class=line><span class=cl>17:25:14.632 c.TestDeadLock <span class=o>[</span>pool-2-thread-1<span class=o>]</span> - åšèœ
</span></span><span class=line><span class=cl>17:25:14.632 c.TestDeadLock <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - ä¸Šèœ: è¾£å­é¸¡ä¸
</span></span></code></pre></td></tr></table></div></div><p><strong>åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚</strong></p><ul><li>è¿‡å°ä¼šå¯¼è‡´ç¨‹åºä¸èƒ½å……åˆ†åœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºã€å®¹æ˜“å¯¼è‡´é¥¥é¥¿</li><li>è¿‡å¤§ä¼šå¯¼è‡´æ›´å¤šçš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå ç”¨æ›´å¤šå†…å­˜</li></ul><p><strong>CPU å¯†é›†å‹è¿ç®—</strong></p><p>é€šå¸¸é‡‡ç”¨ <code>cpu æ ¸æ•° + 1</code> èƒ½å¤Ÿå®ç°æœ€ä¼˜çš„ CPU åˆ©ç”¨ç‡ï¼Œ+1 æ˜¯ä¿è¯å½“çº¿ç¨‹ç”±äºé¡µç¼ºå¤±æ•…éšœï¼ˆæ“ä½œç³»ç»Ÿï¼‰æˆ–å…¶å®ƒåŸå›  å¯¼è‡´æš‚åœæ—¶ï¼Œé¢å¤–çš„è¿™ä¸ªçº¿ç¨‹å°±èƒ½é¡¶ä¸Šå»ï¼Œä¿è¯ CPU æ—¶é’Ÿå‘¨æœŸä¸è¢«æµªè´¹</p><p><strong>I/O å¯†é›†å‹è¿ç®—</strong></p><p>CPU ä¸æ€»æ˜¯å¤„äºç¹å¿™çŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œå½“ä½ æ‰§è¡Œä¸šåŠ¡è®¡ç®—æ—¶ï¼Œè¿™æ—¶å€™ä¼šä½¿ç”¨ CPU èµ„æºï¼Œä½†å½“ä½ æ‰§è¡Œ I/O æ“ä½œæ—¶ã€è¿œç¨‹ RPC è°ƒç”¨æ—¶ï¼ŒåŒ…æ‹¬è¿›è¡Œæ•°æ®åº“æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ CPU å°±é—²ä¸‹æ¥äº†ï¼Œä½ å¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æé«˜å®ƒçš„åˆ©ç”¨ç‡ã€‚</p><p>ç»éªŒå…¬å¼å¦‚ä¸‹</p><p><code>çº¿ç¨‹æ•° = æ ¸æ•° * æœŸæœ› CPU åˆ©ç”¨ç‡ * æ€»æ—¶é—´(CPUè®¡ç®—æ—¶é—´+ç­‰å¾…æ—¶é—´) / CPU è®¡ç®—æ—¶é—´</code></p><p>ä¾‹å¦‚ 4 æ ¸ CPU è®¡ç®—æ—¶é—´æ˜¯ 50% ï¼Œå…¶å®ƒç­‰å¾…æ—¶é—´æ˜¯ 50%ï¼ŒæœŸæœ› cpu è¢« 100% åˆ©ç”¨ï¼Œå¥—ç”¨å…¬å¼</p><p><code>4 * 100% * 100% / 50% = 8</code></p><p>ä¾‹å¦‚ 4 æ ¸ CPU è®¡ç®—æ—¶é—´æ˜¯ 10% ï¼Œå…¶å®ƒç­‰å¾…æ—¶é—´æ˜¯ 90%ï¼ŒæœŸæœ› cpu è¢« 100% åˆ©ç”¨ï¼Œå¥—ç”¨å…¬å¼</p><p><code>4 * 100% * 100% / 10% = 40</code></p><h5 id=ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ><a href=#%e4%bb%bb%e5%8a%a1%e8%b0%83%e5%ba%a6%e7%ba%bf%e7%a8%8b%e6%b1%a0 class=header-anchor>#</a>
ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </h5><p>åœ¨ã€ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ã€åŠŸèƒ½åŠ å…¥ä¹‹å‰(JDK1.3)ï¼Œå¯ä»¥ä½¿ç”¨ java.util.Timer æ¥å®ç°å®šæ—¶åŠŸèƒ½ï¼ŒTimer çš„ä¼˜ç‚¹åœ¨äºç®€å•æ˜“ç”¨ï¼Œä½† ç”±äºæ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è°ƒåº¦ï¼Œå› æ­¤æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œå‰ä¸€ä¸ª ä»»åŠ¡çš„å»¶è¿Ÿæˆ–å¼‚å¸¸éƒ½å°†ä¼šå½±å“åˆ°ä¹‹åçš„ä»»åŠ¡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-380-1><a class=lnlinks href=#hl-380-1> 1</a>
</span><span class=lnt id=hl-380-2><a class=lnlinks href=#hl-380-2> 2</a>
</span><span class=lnt id=hl-380-3><a class=lnlinks href=#hl-380-3> 3</a>
</span><span class=lnt id=hl-380-4><a class=lnlinks href=#hl-380-4> 4</a>
</span><span class=lnt id=hl-380-5><a class=lnlinks href=#hl-380-5> 5</a>
</span><span class=lnt id=hl-380-6><a class=lnlinks href=#hl-380-6> 6</a>
</span><span class=lnt id=hl-380-7><a class=lnlinks href=#hl-380-7> 7</a>
</span><span class=lnt id=hl-380-8><a class=lnlinks href=#hl-380-8> 8</a>
</span><span class=lnt id=hl-380-9><a class=lnlinks href=#hl-380-9> 9</a>
</span><span class=lnt id=hl-380-10><a class=lnlinks href=#hl-380-10>10</a>
</span><span class=lnt id=hl-380-11><a class=lnlinks href=#hl-380-11>11</a>
</span><span class=lnt id=hl-380-12><a class=lnlinks href=#hl-380-12>12</a>
</span><span class=lnt id=hl-380-13><a class=lnlinks href=#hl-380-13>13</a>
</span><span class=lnt id=hl-380-14><a class=lnlinks href=#hl-380-14>14</a>
</span><span class=lnt id=hl-380-15><a class=lnlinks href=#hl-380-15>15</a>
</span><span class=lnt id=hl-380-16><a class=lnlinks href=#hl-380-16>16</a>
</span><span class=lnt id=hl-380-17><a class=lnlinks href=#hl-380-17>17</a>
</span><span class=lnt id=hl-380-18><a class=lnlinks href=#hl-380-18>18</a>
</span><span class=lnt id=hl-380-19><a class=lnlinks href=#hl-380-19>19</a>
</span><span class=lnt id=hl-380-20><a class=lnlinks href=#hl-380-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Timer</span><span class=w> </span><span class=n>timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Timer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TimerTask</span><span class=w> </span><span class=n>task1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TimerTask</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TimerTask</span><span class=w> </span><span class=n>task2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TimerTask</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task 2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä½¿ç”¨ timer æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä½†ç”±äº timer å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå› æ­¤ã€ä»»åŠ¡1ã€çš„å»¶æ—¶ï¼Œå½±å“äº†ã€ä»»åŠ¡2ã€çš„æ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timer</span><span class=p>.</span><span class=na>schedule</span><span class=p>(</span><span class=n>task1</span><span class=p>,</span><span class=w> </span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timer</span><span class=p>.</span><span class=na>schedule</span><span class=p>(</span><span class=n>task2</span><span class=p>,</span><span class=w> </span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-381-1><a class=lnlinks href=#hl-381-1>1</a>
</span><span class=lnt id=hl-381-2><a class=lnlinks href=#hl-381-2>2</a>
</span><span class=lnt id=hl-381-3><a class=lnlinks href=#hl-381-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>20:46:09.444 c.TestTimer <span class=o>[</span>main<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>20:46:10.447 c.TestTimer <span class=o>[</span>Timer-0<span class=o>]</span> - task <span class=m>1</span> 
</span></span><span class=line><span class=cl>20:46:12.448 c.TestTimer <span class=o>[</span>Timer-0<span class=o>]</span> - task <span class=m>2</span> 
</span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨ ScheduledExecutorService æ”¹å†™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-382-1><a class=lnlinks href=#hl-382-1>1</a>
</span><span class=lnt id=hl-382-2><a class=lnlinks href=#hl-382-2>2</a>
</span><span class=lnt id=hl-382-3><a class=lnlinks href=#hl-382-3>3</a>
</span><span class=lnt id=hl-382-4><a class=lnlinks href=#hl-382-4>4</a>
</span><span class=lnt id=hl-382-5><a class=lnlinks href=#hl-382-5>5</a>
</span><span class=lnt id=hl-382-6><a class=lnlinks href=#hl-382-6>6</a>
</span><span class=lnt id=hl-382-7><a class=lnlinks href=#hl-382-7>7</a>
</span><span class=lnt id=hl-382-8><a class=lnlinks href=#hl-382-8>8</a>
</span><span class=lnt id=hl-382-9><a class=lnlinks href=#hl-382-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>executor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>executor</span><span class=p>.</span><span class=na>schedule</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>1000</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>executor</span><span class=p>.</span><span class=na>schedule</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>1000</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-383-1><a class=lnlinks href=#hl-383-1>1</a>
</span><span class=lnt id=hl-383-2><a class=lnlinks href=#hl-383-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼šThu Jan <span class=m>03</span> 12:45:17 CST <span class=m>2019</span> 
</span></span><span class=line><span class=cl>ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼šThu Jan <span class=m>03</span> 12:45:17 CST <span class=m>2019</span> 
</span></span></code></pre></td></tr></table></div></div><p>scheduleAtFixedRate ä¾‹å­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-384-1><a class=lnlinks href=#hl-384-1>1</a>
</span><span class=lnt id=hl-384-2><a class=lnlinks href=#hl-384-2>2</a>
</span><span class=lnt id=hl-384-3><a class=lnlinks href=#hl-384-3>3</a>
</span><span class=lnt id=hl-384-4><a class=lnlinks href=#hl-384-4>4</a>
</span><span class=lnt id=hl-384-5><a class=lnlinks href=#hl-384-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pool</span><span class=p>.</span><span class=na>scheduleAtFixedRate</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-385-1><a class=lnlinks href=#hl-385-1>1</a>
</span><span class=lnt id=hl-385-2><a class=lnlinks href=#hl-385-2>2</a>
</span><span class=lnt id=hl-385-3><a class=lnlinks href=#hl-385-3>3</a>
</span><span class=lnt id=hl-385-4><a class=lnlinks href=#hl-385-4>4</a>
</span><span class=lnt id=hl-385-5><a class=lnlinks href=#hl-385-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:45:43.167 c.TestTimer <span class=o>[</span>main<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>21:45:44.215 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:45:45.215 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:45:46.215 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:45:47.215 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span></code></pre></td></tr></table></div></div><p>scheduleAtFixedRate ä¾‹å­ï¼ˆä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡äº†é—´éš”æ—¶é—´ï¼‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-386-1><a class=lnlinks href=#hl-386-1>1</a>
</span><span class=lnt id=hl-386-2><a class=lnlinks href=#hl-386-2>2</a>
</span><span class=lnt id=hl-386-3><a class=lnlinks href=#hl-386-3>3</a>
</span><span class=lnt id=hl-386-4><a class=lnlinks href=#hl-386-4>4</a>
</span><span class=lnt id=hl-386-5><a class=lnlinks href=#hl-386-5>5</a>
</span><span class=lnt id=hl-386-6><a class=lnlinks href=#hl-386-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pool</span><span class=p>.</span><span class=na>scheduleAtFixedRate</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºåˆ†æï¼šä¸€å¼€å§‹ï¼Œå»¶æ—¶ 1sï¼Œæ¥ä¸‹æ¥ï¼Œç”±äºä»»åŠ¡æ‰§è¡Œæ—¶é—´ > é—´éš”æ—¶é—´ï¼Œé—´éš”è¢«ã€æ’‘ã€åˆ°äº† 2s</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-387-1><a class=lnlinks href=#hl-387-1>1</a>
</span><span class=lnt id=hl-387-2><a class=lnlinks href=#hl-387-2>2</a>
</span><span class=lnt id=hl-387-3><a class=lnlinks href=#hl-387-3>3</a>
</span><span class=lnt id=hl-387-4><a class=lnlinks href=#hl-387-4>4</a>
</span><span class=lnt id=hl-387-5><a class=lnlinks href=#hl-387-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:44:30.311 c.TestTimer <span class=o>[</span>main<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>21:44:31.360 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:44:33.361 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:44:35.362 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:44:37.362 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running...
</span></span></code></pre></td></tr></table></div></div><p>scheduleWithFixedDelay ä¾‹å­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-388-1><a class=lnlinks href=#hl-388-1>1</a>
</span><span class=lnt id=hl-388-2><a class=lnlinks href=#hl-388-2>2</a>
</span><span class=lnt id=hl-388-3><a class=lnlinks href=#hl-388-3>3</a>
</span><span class=lnt id=hl-388-4><a class=lnlinks href=#hl-388-4>4</a>
</span><span class=lnt id=hl-388-5><a class=lnlinks href=#hl-388-5>5</a>
</span><span class=lnt id=hl-388-6><a class=lnlinks href=#hl-388-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pool</span><span class=p>.</span><span class=na>scheduleWithFixedDelay</span><span class=p>(()</span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºåˆ†æï¼šä¸€å¼€å§‹ï¼Œå»¶æ—¶ 1sï¼ŒscheduleWithFixedDelay çš„é—´éš”æ˜¯ ä¸Šä¸€ä¸ªä»»åŠ¡ç»“æŸ &lt;-> å»¶æ—¶ &lt;-> ä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹ æ‰€ ä»¥é—´éš”éƒ½æ˜¯ 3s</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-389-1><a class=lnlinks href=#hl-389-1>1</a>
</span><span class=lnt id=hl-389-2><a class=lnlinks href=#hl-389-2>2</a>
</span><span class=lnt id=hl-389-3><a class=lnlinks href=#hl-389-3>3</a>
</span><span class=lnt id=hl-389-4><a class=lnlinks href=#hl-389-4>4</a>
</span><span class=lnt id=hl-389-5><a class=lnlinks href=#hl-389-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:40:55.078 c.TestTimer <span class=o>[</span>main<span class=o>]</span> - start... 
</span></span><span class=line><span class=cl>21:40:56.140 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:40:59.143 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:41:02.145 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>21:41:05.147 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - running... 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>è¯„ä»·</strong> æ•´ä¸ªçº¿ç¨‹æ± è¡¨ç°ä¸ºï¼šçº¿ç¨‹æ•°å›ºå®šï¼Œä»»åŠ¡æ•°å¤šäºçº¿ç¨‹æ•°æ—¶ï¼Œä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿã€‚ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™äº›çº¿ ç¨‹ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚ç”¨æ¥æ‰§è¡Œå»¶è¿Ÿæˆ–åå¤æ‰§è¡Œçš„ä»»åŠ¡</p></blockquote><h5 id=æ­£ç¡®å¤„ç†æ‰§è¡Œä»»åŠ¡å¼‚å¸¸><a href=#%e6%ad%a3%e7%a1%ae%e5%a4%84%e7%90%86%e6%89%a7%e8%a1%8c%e4%bb%bb%e5%8a%a1%e5%bc%82%e5%b8%b8 class=header-anchor>#</a>
æ­£ç¡®å¤„ç†æ‰§è¡Œä»»åŠ¡å¼‚å¸¸</h5><p>ä¸è®ºæ˜¯å“ªä¸ªçº¿ç¨‹æ± ï¼Œåœ¨çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡å‘ç”Ÿå¼‚å¸¸åæ—¢ä¸ä¼šæŠ›å‡ºï¼Œä¹Ÿä¸ä¼šæ•è·ï¼Œè¿™æ—¶å°±éœ€è¦æˆ‘ä»¬åšä¸€å®šçš„å¤„ç†ã€‚</p><p><strong>æ–¹æ³•1ï¼šä¸»åŠ¨æ‰å¼‚å¸¸</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-390-1><a class=lnlinks href=#hl-390-1>1</a>
</span><span class=lnt id=hl-390-2><a class=lnlinks href=#hl-390-2>2</a>
</span><span class=lnt id=hl-390-3><a class=lnlinks href=#hl-390-3>3</a>
</span><span class=lnt id=hl-390-4><a class=lnlinks href=#hl-390-4>4</a>
</span><span class=lnt id=hl-390-5><a class=lnlinks href=#hl-390-5>5</a>
</span><span class=lnt id=hl-390-6><a class=lnlinks href=#hl-390-6>6</a>
</span><span class=lnt id=hl-390-7><a class=lnlinks href=#hl-390-7>7</a>
</span><span class=lnt id=hl-390-8><a class=lnlinks href=#hl-390-8>8</a>
</span><span class=lnt id=hl-390-9><a class=lnlinks href=#hl-390-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;error:&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-391-1><a class=lnlinks href=#hl-391-1>1</a>
</span><span class=lnt id=hl-391-2><a class=lnlinks href=#hl-391-2>2</a>
</span><span class=lnt id=hl-391-3><a class=lnlinks href=#hl-391-3>3</a>
</span><span class=lnt id=hl-391-4><a class=lnlinks href=#hl-391-4>4</a>
</span><span class=lnt id=hl-391-5><a class=lnlinks href=#hl-391-5>5</a>
</span><span class=lnt id=hl-391-6><a class=lnlinks href=#hl-391-6>6</a>
</span><span class=lnt id=hl-391-7><a class=lnlinks href=#hl-391-7>7</a>
</span><span class=lnt id=hl-391-8><a class=lnlinks href=#hl-391-8>8</a>
</span><span class=lnt id=hl-391-9><a class=lnlinks href=#hl-391-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:59:04.558 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - task1 
</span></span><span class=line><span class=cl>21:59:04.562 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - error: 
</span></span><span class=line><span class=cl>java.lang.ArithmeticException: / by zero 
</span></span><span class=line><span class=cl> at cn.itcast.n8.TestTimer.lambda<span class=nv>$main$0</span><span class=o>(</span>TestTimer.java:28<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.Executors<span class=nv>$RunnableAdapter</span>.call<span class=o>(</span>Executors.java:511<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.FutureTask.run<span class=o>(</span>FutureTask.java:266<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.ThreadPoolExecutor.runWorker<span class=o>(</span>ThreadPoolExecutor.java:1149<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.ThreadPoolExecutor<span class=nv>$Worker</span>.run<span class=o>(</span>ThreadPoolExecutor.java:624<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Thread.run<span class=o>(</span>Thread.java:748<span class=o>)</span> 
</span></span></code></pre></td></tr></table></div></div><p><strong>æ–¹æ³•2ï¼šä½¿ç”¨ Future</strong></p><p>è¯´æ˜ï¼š</p><ul><li>lambdaè¡¨è¾¾å¼å†…è¦æœ‰è¿”å›å€¼ï¼Œç¼–è¯‘å™¨æ‰èƒ½å°†å…¶è¯†åˆ«ä¸ºCallableï¼Œå¦åˆ™å°†è¯†åˆ«ä¸ºRunnableï¼Œä¹Ÿå°±ä¸èƒ½ç”¨FutureTask</li><li>æ–¹æ³•ä¸­å¦‚æœå‡ºå¼‚å¸¸ï¼Œ<code>futuretask.get</code>ä¼šè¿”å›è¿™ä¸ªå¼‚å¸¸ï¼Œå¦è€…æ­£å¸¸è¿”å›ã€‚</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-392-1><a class=lnlinks href=#hl-392-1>1</a>
</span><span class=lnt id=hl-392-2><a class=lnlinks href=#hl-392-2>2</a>
</span><span class=lnt id=hl-392-3><a class=lnlinks href=#hl-392-3>3</a>
</span><span class=lnt id=hl-392-4><a class=lnlinks href=#hl-392-4>4</a>
</span><span class=lnt id=hl-392-5><a class=lnlinks href=#hl-392-5>5</a>
</span><span class=lnt id=hl-392-6><a class=lnlinks href=#hl-392-6>6</a>
</span><span class=lnt id=hl-392-7><a class=lnlinks href=#hl-392-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ExecutorService</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Boolean</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;result:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-393-1><a class=lnlinks href=#hl-393-1> 1</a>
</span><span class=lnt id=hl-393-2><a class=lnlinks href=#hl-393-2> 2</a>
</span><span class=lnt id=hl-393-3><a class=lnlinks href=#hl-393-3> 3</a>
</span><span class=lnt id=hl-393-4><a class=lnlinks href=#hl-393-4> 4</a>
</span><span class=lnt id=hl-393-5><a class=lnlinks href=#hl-393-5> 5</a>
</span><span class=lnt id=hl-393-6><a class=lnlinks href=#hl-393-6> 6</a>
</span><span class=lnt id=hl-393-7><a class=lnlinks href=#hl-393-7> 7</a>
</span><span class=lnt id=hl-393-8><a class=lnlinks href=#hl-393-8> 8</a>
</span><span class=lnt id=hl-393-9><a class=lnlinks href=#hl-393-9> 9</a>
</span><span class=lnt id=hl-393-10><a class=lnlinks href=#hl-393-10>10</a>
</span><span class=lnt id=hl-393-11><a class=lnlinks href=#hl-393-11>11</a>
</span><span class=lnt id=hl-393-12><a class=lnlinks href=#hl-393-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>21:54:58.208 c.TestTimer <span class=o>[</span>pool-1-thread-1<span class=o>]</span> - task1 
</span></span><span class=line><span class=cl>Exception in thread <span class=s2>&#34;main&#34;</span> java.util.concurrent.ExecutionException: 
</span></span><span class=line><span class=cl>java.lang.ArithmeticException: / by zero 
</span></span><span class=line><span class=cl> at java.util.concurrent.FutureTask.report<span class=o>(</span>FutureTask.java:122<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.FutureTask.get<span class=o>(</span>FutureTask.java:192<span class=o>)</span> 
</span></span><span class=line><span class=cl> at cn.itcast.n8.TestTimer.main<span class=o>(</span>TestTimer.java:31<span class=o>)</span> 
</span></span><span class=line><span class=cl>Caused by: java.lang.ArithmeticException: / by zero 
</span></span><span class=line><span class=cl> at cn.itcast.n8.TestTimer.lambda<span class=nv>$main$0</span><span class=o>(</span>TestTimer.java:28<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.FutureTask.run<span class=o>(</span>FutureTask.java:266<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.ThreadPoolExecutor.runWorker<span class=o>(</span>ThreadPoolExecutor.java:1149<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.util.concurrent.ThreadPoolExecutor<span class=nv>$Worker</span>.run<span class=o>(</span>ThreadPoolExecutor.java:624<span class=o>)</span> 
</span></span><span class=line><span class=cl> at java.lang.Thread.run<span class=o>(</span>Thread.java:748<span class=o>)</span> 
</span></span></code></pre></td></tr></table></div></div><h5 id=font-colorgreen-åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡font><a href=#font-colorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1font class=header-anchor>#</a>
<font color=green>* åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡</font></h5><p>å¦‚ä½•è®©æ¯å‘¨å›› 18:00:00 å®šæ—¶æ‰§è¡Œä»»åŠ¡ï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-394-1><a class=lnlinks href=#hl-394-1> 1</a>
</span><span class=lnt id=hl-394-2><a class=lnlinks href=#hl-394-2> 2</a>
</span><span class=lnt id=hl-394-3><a class=lnlinks href=#hl-394-3> 3</a>
</span><span class=lnt id=hl-394-4><a class=lnlinks href=#hl-394-4> 4</a>
</span><span class=lnt id=hl-394-5><a class=lnlinks href=#hl-394-5> 5</a>
</span><span class=lnt id=hl-394-6><a class=lnlinks href=#hl-394-6> 6</a>
</span><span class=lnt id=hl-394-7><a class=lnlinks href=#hl-394-7> 7</a>
</span><span class=lnt id=hl-394-8><a class=lnlinks href=#hl-394-8> 8</a>
</span><span class=lnt id=hl-394-9><a class=lnlinks href=#hl-394-9> 9</a>
</span><span class=lnt id=hl-394-10><a class=lnlinks href=#hl-394-10>10</a>
</span><span class=lnt id=hl-394-11><a class=lnlinks href=#hl-394-11>11</a>
</span><span class=lnt id=hl-394-12><a class=lnlinks href=#hl-394-12>12</a>
</span><span class=lnt id=hl-394-13><a class=lnlinks href=#hl-394-13>13</a>
</span><span class=lnt id=hl-394-14><a class=lnlinks href=#hl-394-14>14</a>
</span><span class=lnt id=hl-394-15><a class=lnlinks href=#hl-394-15>15</a>
</span><span class=lnt id=hl-394-16><a class=lnlinks href=#hl-394-16>16</a>
</span><span class=lnt id=hl-394-17><a class=lnlinks href=#hl-394-17>17</a>
</span><span class=lnt id=hl-394-18><a class=lnlinks href=#hl-394-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// è·å¾—å½“å‰æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–æœ¬å‘¨å›› 18:00:00.000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>thursday</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>now</span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=n>DayOfWeek</span><span class=p>.</span><span class=na>THURSDAY</span><span class=p>).</span><span class=na>withHour</span><span class=p>(</span><span class=n>18</span><span class=p>).</span><span class=na>withMinute</span><span class=p>(</span><span class=n>0</span><span class=p>).</span><span class=na>withSecond</span><span class=p>(</span><span class=n>0</span><span class=p>).</span><span class=na>withNano</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å¦‚æœå½“å‰æ—¶é—´å·²ç»è¶…è¿‡ æœ¬å‘¨å›› 18:00:00.000ï¼Œ é‚£ä¹ˆæ‰¾ä¸‹å‘¨å›› 18:00:00.000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=p>(</span><span class=n>now</span><span class=p>.</span><span class=na>compareTo</span><span class=p>(</span><span class=n>thursday</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thursday</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thursday</span><span class=p>.</span><span class=na>plusWeeks</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è®¡ç®—æ—¶é—´å·®ï¼Œå³å»¶æ—¶æ‰§è¡Œæ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>long</span><span class=w> </span><span class=n>initialDelay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Duration</span><span class=p>.</span><span class=na>between</span><span class=p>(</span><span class=n>now</span><span class=p>,</span><span class=w> </span><span class=n>thursday</span><span class=p>).</span><span class=na>toMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è®¡ç®—é—´éš”æ—¶é—´ï¼Œå³ 1 å‘¨çš„æ¯«ç§’å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>long</span><span class=w> </span><span class=n>oneWeek</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>7</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>3600</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>executor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å¼€å§‹æ—¶é—´ï¼š&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>executor</span><span class=p>.</span><span class=na>scheduleAtFixedRate</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰§è¡Œæ—¶é—´ï¼š&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=n>initialDelay</span><span class=p>,</span><span class=w> </span><span class=n>oneWeek</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=tomcat-çº¿ç¨‹æ± ><a href=#tomcat-%e7%ba%bf%e7%a8%8b%e6%b1%a0 class=header-anchor>#</a>
Tomcat çº¿ç¨‹æ± </h5><p>Tomcat åœ¨å“ªé‡Œç”¨åˆ°äº†çº¿ç¨‹æ± å‘¢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-395-1><a class=lnlinks href=#hl-395-1> 1</a>
</span><span class=lnt id=hl-395-2><a class=lnlinks href=#hl-395-2> 2</a>
</span><span class=lnt id=hl-395-3><a class=lnlinks href=#hl-395-3> 3</a>
</span><span class=lnt id=hl-395-4><a class=lnlinks href=#hl-395-4> 4</a>
</span><span class=lnt id=hl-395-5><a class=lnlinks href=#hl-395-5> 5</a>
</span><span class=lnt id=hl-395-6><a class=lnlinks href=#hl-395-6> 6</a>
</span><span class=lnt id=hl-395-7><a class=lnlinks href=#hl-395-7> 7</a>
</span><span class=lnt id=hl-395-8><a class=lnlinks href=#hl-395-8> 8</a>
</span><span class=lnt id=hl-395-9><a class=lnlinks href=#hl-395-9> 9</a>
</span><span class=lnt id=hl-395-10><a class=lnlinks href=#hl-395-10>10</a>
</span><span class=lnt id=hl-395-11><a class=lnlinks href=#hl-395-11>11</a>
</span><span class=lnt id=hl-395-12><a class=lnlinks href=#hl-395-12>12</a>
</span><span class=lnt id=hl-395-13><a class=lnlinks href=#hl-395-13>13</a>
</span><span class=lnt id=hl-395-14><a class=lnlinks href=#hl-395-14>14</a>
</span><span class=lnt id=hl-395-15><a class=lnlinks href=#hl-395-15>15</a>
</span><span class=lnt id=hl-395-16><a class=lnlinks href=#hl-395-16>16</a>
</span><span class=lnt id=hl-395-17><a class=lnlinks href=#hl-395-17>17</a>
</span><span class=lnt id=hl-395-18><a class=lnlinks href=#hl-395-18>18</a>
</span><span class=lnt id=hl-395-19><a class=lnlinks href=#hl-395-19>19</a>
</span><span class=lnt id=hl-395-20><a class=lnlinks href=#hl-395-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph LR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>subgraph Connector-&gt;NIO EndPoint
</span></span><span class=line><span class=cl>t1(LimitLatch)
</span></span><span class=line><span class=cl>t2(Acceptor)
</span></span><span class=line><span class=cl>t3(SocketChannel 1)
</span></span><span class=line><span class=cl>t4(SocketChannel 2)
</span></span><span class=line><span class=cl>t5(Poller)
</span></span><span class=line><span class=cl>subgraph Executor
</span></span><span class=line><span class=cl>t7(worker1)
</span></span><span class=line><span class=cl>t8(worker2)
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>t1 --&gt; t2
</span></span><span class=line><span class=cl>t2 --&gt; t3
</span></span><span class=line><span class=cl>t2 --&gt; t4
</span></span><span class=line><span class=cl>t3 --æœ‰è¯»--&gt; t5
</span></span><span class=line><span class=cl>t4 --æœ‰è¯»--&gt; t5
</span></span><span class=line><span class=cl>t5 --socketProcessor--&gt; t7
</span></span><span class=line><span class=cl>t5 --socketProcessor--&gt; t8
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><ul><li>LimitLatch ç”¨æ¥é™æµï¼Œå¯ä»¥æ§åˆ¶æœ€å¤§è¿æ¥ä¸ªæ•°ï¼Œç±»ä¼¼ J.U.C ä¸­çš„ Semaphore åé¢å†è®²</li><li>Acceptor åªè´Ÿè´£ã€æ¥æ”¶æ–°çš„ socket è¿æ¥ã€‘</li><li>Poller åªè´Ÿè´£ç›‘å¬ socket channel æ˜¯å¦æœ‰ã€å¯è¯»çš„ I/O äº‹ä»¶ã€‘</li><li>ä¸€æ—¦å¯è¯»ï¼Œå°è£…ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼ˆsocketProcessorï¼‰ï¼Œæäº¤ç»™ Executor çº¿ç¨‹æ± å¤„ç†</li><li>Executor çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æœ€ç»ˆè´Ÿè´£ã€å¤„ç†è¯·æ±‚ã€‘</li></ul><p>Tomcat çº¿ç¨‹æ± æ‰©å±•äº† ThreadPoolExecutorï¼Œè¡Œä¸ºç¨æœ‰ä¸åŒ</p><ul><li>å¦‚æœæ€»çº¿ç¨‹æ•°è¾¾åˆ° maximumPoolSize<ul><li>è¿™æ—¶ä¸ä¼šç«‹åˆ»æŠ› RejectedExecutionException å¼‚å¸¸</li><li>è€Œæ˜¯å†æ¬¡å°è¯•å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œå¦‚æœè¿˜å¤±è´¥ï¼Œæ‰æŠ›å‡º RejectedExecutionException å¼‚å¸¸</li></ul></li></ul><p>æºç  tomcat-7.0.42</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-396-1><a class=lnlinks href=#hl-396-1> 1</a>
</span><span class=lnt id=hl-396-2><a class=lnlinks href=#hl-396-2> 2</a>
</span><span class=lnt id=hl-396-3><a class=lnlinks href=#hl-396-3> 3</a>
</span><span class=lnt id=hl-396-4><a class=lnlinks href=#hl-396-4> 4</a>
</span><span class=lnt id=hl-396-5><a class=lnlinks href=#hl-396-5> 5</a>
</span><span class=lnt id=hl-396-6><a class=lnlinks href=#hl-396-6> 6</a>
</span><span class=lnt id=hl-396-7><a class=lnlinks href=#hl-396-7> 7</a>
</span><span class=lnt id=hl-396-8><a class=lnlinks href=#hl-396-8> 8</a>
</span><span class=lnt id=hl-396-9><a class=lnlinks href=#hl-396-9> 9</a>
</span><span class=lnt id=hl-396-10><a class=lnlinks href=#hl-396-10>10</a>
</span><span class=lnt id=hl-396-11><a class=lnlinks href=#hl-396-11>11</a>
</span><span class=lnt id=hl-396-12><a class=lnlinks href=#hl-396-12>12</a>
</span><span class=lnt id=hl-396-13><a class=lnlinks href=#hl-396-13>13</a>
</span><span class=lnt id=hl-396-14><a class=lnlinks href=#hl-396-14>14</a>
</span><span class=lnt id=hl-396-15><a class=lnlinks href=#hl-396-15>15</a>
</span><span class=lnt id=hl-396-16><a class=lnlinks href=#hl-396-16>16</a>
</span><span class=lnt id=hl-396-17><a class=lnlinks href=#hl-396-17>17</a>
</span><span class=lnt id=hl-396-18><a class=lnlinks href=#hl-396-18>18</a>
</span><span class=lnt id=hl-396-19><a class=lnlinks href=#hl-396-19>19</a>
</span><span class=lnt id=hl-396-20><a class=lnlinks href=#hl-396-20>20</a>
</span><span class=lnt id=hl-396-21><a class=lnlinks href=#hl-396-21>21</a>
</span><span class=lnt id=hl-396-22><a class=lnlinks href=#hl-396-22>22</a>
</span><span class=lnt id=hl-396-23><a class=lnlinks href=#hl-396-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>command</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>submittedCount</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>command</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RejectedExecutionException</span><span class=w> </span><span class=n>rx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kd>super</span><span class=p>.</span><span class=na>getQueue</span><span class=p>()</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>TaskQueue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>TaskQueue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>TaskQueue</span><span class=p>)</span><span class=kd>super</span><span class=p>.</span><span class=na>getQueue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>queue</span><span class=p>.</span><span class=na>force</span><span class=p>(</span><span class=n>command</span><span class=p>,</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>submittedCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RejectedExecutionException</span><span class=p>(</span><span class=s>&#34;Queue capacity is full.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>submittedCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RejectedExecutionException</span><span class=p>(</span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>submittedCount</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>rx</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>TaskQueue.java</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-397-1><a class=lnlinks href=#hl-397-1>1</a>
</span><span class=lnt id=hl-397-2><a class=lnlinks href=#hl-397-2>2</a>
</span><span class=lnt id=hl-397-3><a class=lnlinks href=#hl-397-3>3</a>
</span><span class=lnt id=hl-397-4><a class=lnlinks href=#hl-397-4>4</a>
</span><span class=lnt id=hl-397-5><a class=lnlinks href=#hl-397-5>5</a>
</span><span class=lnt id=hl-397-6><a class=lnlinks href=#hl-397-6>6</a>
</span><span class=lnt id=hl-397-7><a class=lnlinks href=#hl-397-7>7</a>
</span><span class=lnt id=hl-397-8><a class=lnlinks href=#hl-397-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>force</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>o</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>parent</span><span class=p>.</span><span class=na>isShutdown</span><span class=p>()</span><span class=w> </span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RejectedExecutionException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;Executor not running, can&#39;t force a command into the queue&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=n>o</span><span class=p>,</span><span class=n>timeout</span><span class=p>,</span><span class=n>unit</span><span class=p>);</span><span class=w> </span><span class=c1>//forces the item onto the queue, to be used if the task </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>is</span><span class=w> </span><span class=n>rejected</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Connector é…ç½®</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>é…ç½®é¡¹</th><th style=text-align:center>é»˜è®¤å€¼</th><th style=text-align:center>è¯´æ˜</th></tr></thead><tbody><tr><td style=text-align:center><code>acceptorThreadCount</code></td><td style=text-align:center>1</td><td style=text-align:center>acceptor çº¿ç¨‹æ•°é‡</td></tr><tr><td style=text-align:center><code>pollerThreadCount</code></td><td style=text-align:center>1</td><td style=text-align:center>poller çº¿ç¨‹æ•°é‡</td></tr><tr><td style=text-align:center><code>minSpareThreads</code></td><td style=text-align:center>10</td><td style=text-align:center>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³ corePoolSize</td></tr><tr><td style=text-align:center><code>maxThreads</code></td><td style=text-align:center>200</td><td style=text-align:center>æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³ maximumPoolSize</td></tr><tr><td style=text-align:center><code>executor</code></td><td style=text-align:center>-</td><td style=text-align:center>Executor åç§°ï¼Œç”¨æ¥å¼•ç”¨ä¸‹é¢çš„ Executor</td></tr></tbody></table></div><p>Executor çº¿ç¨‹é…ç½®</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>é…ç½®é¡¹</th><th style=text-align:center>é»˜è®¤å€¼</th><th style=text-align:center>è¯´æ˜</th></tr></thead><tbody><tr><td style=text-align:center><code>threadPriority</code></td><td style=text-align:center>5</td><td style=text-align:center>çº¿ç¨‹ä¼˜å…ˆçº§</td></tr><tr><td style=text-align:center><code>deamon</code></td><td style=text-align:center>true</td><td style=text-align:center>æ˜¯å¦å®ˆæŠ¤çº¿ç¨‹</td></tr><tr><td style=text-align:center><code>minSpareThreads</code></td><td style=text-align:center>25</td><td style=text-align:center>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³corePoolSize</td></tr><tr><td style=text-align:center><code>maxThreads</code></td><td style=text-align:center>200</td><td style=text-align:center>æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³ maximumPoolSize</td></tr><tr><td style=text-align:center><code>maxIdleTime</code></td><td style=text-align:center>60000</td><td style=text-align:center>çº¿ç¨‹ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œé»˜è®¤å€¼å³ 1 åˆ†é’Ÿ</td></tr><tr><td style=text-align:center><code>maxQueueSize</code></td><td style=text-align:center>Integer.MAX_VALUE</td><td style=text-align:center>é˜Ÿåˆ—é•¿åº¦</td></tr><tr><td style=text-align:center><code>prestartminSpareThreads</code></td><td style=text-align:center>false</td><td style=text-align:center>æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å¯åŠ¨</td></tr></tbody></table></div><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312104017979.png width=900 height=600 loading=lazy decoding=async alt=image-20220312104017979 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=forkjoin><a href=#forkjoin class=header-anchor>#</a>
Fork/Join</h4><h5 id=æ¦‚å¿µ><a href=#%e6%a6%82%e5%bf%b5 class=header-anchor>#</a>
æ¦‚å¿µ</h5><p>Fork/Join æ˜¯ JDK 1.7 åŠ å…¥çš„æ–°çš„çº¿ç¨‹æ± å®ç°ï¼Œå®ƒä½“ç°çš„æ˜¯ä¸€ç§åˆ†æ²»æ€æƒ³ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„ cpu å¯†é›†å‹ è¿ç®—</p><p>æ‰€è°“çš„ä»»åŠ¡æ‹†åˆ†ï¼Œæ˜¯å°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºç®—æ³•ä¸Šç›¸åŒçš„å°ä»»åŠ¡ï¼Œç›´è‡³ä¸èƒ½æ‹†åˆ†å¯ä»¥ç›´æ¥æ±‚è§£ã€‚è·Ÿé€’å½’ç›¸å…³çš„ä¸€äº›è®¡ ç®—ï¼Œå¦‚å½’å¹¶æ’åºã€æ–æ³¢é‚£å¥‘æ•°åˆ—ã€éƒ½å¯ä»¥ç”¨åˆ†æ²»æ€æƒ³è¿›è¡Œæ±‚è§£</p><p>Fork/Join åœ¨åˆ†æ²»çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å¤šçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæ¯ä¸ªä»»åŠ¡çš„åˆ†è§£å’Œåˆå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥å®Œæˆï¼Œè¿›ä¸€æ­¥æå‡äº†è¿ ç®—æ•ˆç‡</p><p>Fork/Join é»˜è®¤ä¼šåˆ›å»ºä¸ cpu æ ¸å¿ƒæ•°å¤§å°ç›¸åŒçš„çº¿ç¨‹æ± </p><h5 id=font-colorgreenåº”ç”¨ä¹‹æ±‚å’Œfont><a href=#font-colorgreen%e5%ba%94%e7%94%a8%e4%b9%8b%e6%b1%82%e5%92%8cfont class=header-anchor>#</a>
<font color=green>åº”ç”¨ä¹‹æ±‚å’Œ</font></h5><p>æäº¤ç»™ Fork/Join çº¿ç¨‹æ± çš„ä»»åŠ¡éœ€è¦ç»§æ‰¿ RecursiveTaskï¼ˆæœ‰è¿”å›å€¼ï¼‰æˆ– RecursiveActionï¼ˆæ²¡æœ‰è¿”å›å€¼ï¼‰ï¼Œä¾‹å¦‚ä¸‹ é¢å®šä¹‰äº†ä¸€ä¸ªå¯¹ 1~n ä¹‹é—´çš„æ•´æ•°æ±‚å’Œçš„ä»»åŠ¡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-398-1><a class=lnlinks href=#hl-398-1> 1</a>
</span><span class=lnt id=hl-398-2><a class=lnlinks href=#hl-398-2> 2</a>
</span><span class=lnt id=hl-398-3><a class=lnlinks href=#hl-398-3> 3</a>
</span><span class=lnt id=hl-398-4><a class=lnlinks href=#hl-398-4> 4</a>
</span><span class=lnt id=hl-398-5><a class=lnlinks href=#hl-398-5> 5</a>
</span><span class=lnt id=hl-398-6><a class=lnlinks href=#hl-398-6> 6</a>
</span><span class=lnt id=hl-398-7><a class=lnlinks href=#hl-398-7> 7</a>
</span><span class=lnt id=hl-398-8><a class=lnlinks href=#hl-398-8> 8</a>
</span><span class=lnt id=hl-398-9><a class=lnlinks href=#hl-398-9> 9</a>
</span><span class=lnt id=hl-398-10><a class=lnlinks href=#hl-398-10>10</a>
</span><span class=lnt id=hl-398-11><a class=lnlinks href=#hl-398-11>11</a>
</span><span class=lnt id=hl-398-12><a class=lnlinks href=#hl-398-12>12</a>
</span><span class=lnt id=hl-398-13><a class=lnlinks href=#hl-398-13>13</a>
</span><span class=lnt id=hl-398-14><a class=lnlinks href=#hl-398-14>14</a>
</span><span class=lnt id=hl-398-15><a class=lnlinks href=#hl-398-15>15</a>
</span><span class=lnt id=hl-398-16><a class=lnlinks href=#hl-398-16>16</a>
</span><span class=lnt id=hl-398-17><a class=lnlinks href=#hl-398-17>17</a>
</span><span class=lnt id=hl-398-18><a class=lnlinks href=#hl-398-18>18</a>
</span><span class=lnt id=hl-398-19><a class=lnlinks href=#hl-398-19>19</a>
</span><span class=lnt id=hl-398-20><a class=lnlinks href=#hl-398-20>20</a>
</span><span class=lnt id=hl-398-21><a class=lnlinks href=#hl-398-21>21</a>
</span><span class=lnt id=hl-398-22><a class=lnlinks href=#hl-398-22>22</a>
</span><span class=lnt id=hl-398-23><a class=lnlinks href=#hl-398-23>23</a>
</span><span class=lnt id=hl-398-24><a class=lnlinks href=#hl-398-24>24</a>
</span><span class=lnt id=hl-398-25><a class=lnlinks href=#hl-398-25>25</a>
</span><span class=lnt id=hl-398-26><a class=lnlinks href=#hl-398-26>26</a>
</span><span class=lnt id=hl-398-27><a class=lnlinks href=#hl-398-27>27</a>
</span><span class=lnt id=hl-398-28><a class=lnlinks href=#hl-398-28>28</a>
</span><span class=lnt id=hl-398-29><a class=lnlinks href=#hl-398-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.AddTask&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>AddTask1</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>RecursiveTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AddTask1</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;{&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=sc>&#39;}&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>compute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœ n å·²ç»ä¸º 1ï¼Œå¯ä»¥æ±‚å¾—ç»“æœäº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;join() {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°†ä»»åŠ¡è¿›è¡Œæ‹†åˆ†(fork)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AddTask1</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AddTask1</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>fork</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;fork() {} + {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åˆå¹¶(join)ç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;join() {} + {} = {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç„¶åæäº¤ç»™ ForkJoinPool æ¥æ‰§è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-399-1><a class=lnlinks href=#hl-399-1>1</a>
</span><span class=lnt id=hl-399-2><a class=lnlinks href=#hl-399-2>2</a>
</span><span class=lnt id=hl-399-3><a class=lnlinks href=#hl-399-3>3</a>
</span><span class=lnt id=hl-399-4><a class=lnlinks href=#hl-399-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ForkJoinPool</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ForkJoinPool</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>pool</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AddTask1</span><span class=p>(</span><span class=n>5</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-400-1><a class=lnlinks href=#hl-400-1> 1</a>
</span><span class=lnt id=hl-400-2><a class=lnlinks href=#hl-400-2> 2</a>
</span><span class=lnt id=hl-400-3><a class=lnlinks href=#hl-400-3> 3</a>
</span><span class=lnt id=hl-400-4><a class=lnlinks href=#hl-400-4> 4</a>
</span><span class=lnt id=hl-400-5><a class=lnlinks href=#hl-400-5> 5</a>
</span><span class=lnt id=hl-400-6><a class=lnlinks href=#hl-400-6> 6</a>
</span><span class=lnt id=hl-400-7><a class=lnlinks href=#hl-400-7> 7</a>
</span><span class=lnt id=hl-400-8><a class=lnlinks href=#hl-400-8> 8</a>
</span><span class=lnt id=hl-400-9><a class=lnlinks href=#hl-400-9> 9</a>
</span><span class=lnt id=hl-400-10><a class=lnlinks href=#hl-400-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-0<span class=o>]</span> - fork<span class=o>()</span> <span class=m>2</span> + <span class=o>{</span>1<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-1<span class=o>]</span> - fork<span class=o>()</span> <span class=m>5</span> + <span class=o>{</span>4<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-0<span class=o>]</span> - join<span class=o>()</span> <span class=m>1</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-0<span class=o>]</span> - join<span class=o>()</span> <span class=m>2</span> + <span class=o>{</span>1<span class=o>}</span> <span class=o>=</span> <span class=m>3</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-2<span class=o>]</span> - fork<span class=o>()</span> <span class=m>4</span> + <span class=o>{</span>3<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-3<span class=o>]</span> - fork<span class=o>()</span> <span class=m>3</span> + <span class=o>{</span>2<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-3<span class=o>]</span> - join<span class=o>()</span> <span class=m>3</span> + <span class=o>{</span>2<span class=o>}</span> <span class=o>=</span> <span class=m>6</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-2<span class=o>]</span> - join<span class=o>()</span> <span class=m>4</span> + <span class=o>{</span>3<span class=o>}</span> <span class=o>=</span> <span class=m>10</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-1<span class=o>]</span> - join<span class=o>()</span> <span class=m>5</span> + <span class=o>{</span>4<span class=o>}</span> <span class=o>=</span> <span class=m>15</span> 
</span></span><span class=line><span class=cl><span class=m>15</span> 
</span></span></code></pre></td></tr></table></div></div><p>ç”¨å›¾æ¥è¡¨ç¤º</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312104252674.png width=900 height=600 loading=lazy decoding=async alt=image-20220312104252674 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æ”¹è¿›</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-401-1><a class=lnlinks href=#hl-401-1> 1</a>
</span><span class=lnt id=hl-401-2><a class=lnlinks href=#hl-401-2> 2</a>
</span><span class=lnt id=hl-401-3><a class=lnlinks href=#hl-401-3> 3</a>
</span><span class=lnt id=hl-401-4><a class=lnlinks href=#hl-401-4> 4</a>
</span><span class=lnt id=hl-401-5><a class=lnlinks href=#hl-401-5> 5</a>
</span><span class=lnt id=hl-401-6><a class=lnlinks href=#hl-401-6> 6</a>
</span><span class=lnt id=hl-401-7><a class=lnlinks href=#hl-401-7> 7</a>
</span><span class=lnt id=hl-401-8><a class=lnlinks href=#hl-401-8> 8</a>
</span><span class=lnt id=hl-401-9><a class=lnlinks href=#hl-401-9> 9</a>
</span><span class=lnt id=hl-401-10><a class=lnlinks href=#hl-401-10>10</a>
</span><span class=lnt id=hl-401-11><a class=lnlinks href=#hl-401-11>11</a>
</span><span class=lnt id=hl-401-12><a class=lnlinks href=#hl-401-12>12</a>
</span><span class=lnt id=hl-401-13><a class=lnlinks href=#hl-401-13>13</a>
</span><span class=lnt id=hl-401-14><a class=lnlinks href=#hl-401-14>14</a>
</span><span class=lnt id=hl-401-15><a class=lnlinks href=#hl-401-15>15</a>
</span><span class=lnt id=hl-401-16><a class=lnlinks href=#hl-401-16>16</a>
</span><span class=lnt id=hl-401-17><a class=lnlinks href=#hl-401-17>17</a>
</span><span class=lnt id=hl-401-18><a class=lnlinks href=#hl-401-18>18</a>
</span><span class=lnt id=hl-401-19><a class=lnlinks href=#hl-401-19>19</a>
</span><span class=lnt id=hl-401-20><a class=lnlinks href=#hl-401-20>20</a>
</span><span class=lnt id=hl-401-21><a class=lnlinks href=#hl-401-21>21</a>
</span><span class=lnt id=hl-401-22><a class=lnlinks href=#hl-401-22>22</a>
</span><span class=lnt id=hl-401-23><a class=lnlinks href=#hl-401-23>23</a>
</span><span class=lnt id=hl-401-24><a class=lnlinks href=#hl-401-24>24</a>
</span><span class=lnt id=hl-401-25><a class=lnlinks href=#hl-401-25>25</a>
</span><span class=lnt id=hl-401-26><a class=lnlinks href=#hl-401-26>26</a>
</span><span class=lnt id=hl-401-27><a class=lnlinks href=#hl-401-27>27</a>
</span><span class=lnt id=hl-401-28><a class=lnlinks href=#hl-401-28>28</a>
</span><span class=lnt id=hl-401-29><a class=lnlinks href=#hl-401-29>29</a>
</span><span class=lnt id=hl-401-30><a class=lnlinks href=#hl-401-30>30</a>
</span><span class=lnt id=hl-401-31><a class=lnlinks href=#hl-401-31>31</a>
</span><span class=lnt id=hl-401-32><a class=lnlinks href=#hl-401-32>32</a>
</span><span class=lnt id=hl-401-33><a class=lnlinks href=#hl-401-33>33</a>
</span><span class=lnt id=hl-401-34><a class=lnlinks href=#hl-401-34>34</a>
</span><span class=lnt id=hl-401-35><a class=lnlinks href=#hl-401-35>35</a>
</span><span class=lnt id=hl-401-36><a class=lnlinks href=#hl-401-36>36</a>
</span><span class=lnt id=hl-401-37><a class=lnlinks href=#hl-401-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AddTask3</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>RecursiveTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AddTask3</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>begin</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>end</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>begin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;{&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>begin</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;,&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=sc>&#39;}&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>compute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 5, 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>begin</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>end</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;join() {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>begin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 4, 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>begin</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;join() {} + {} = {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>begin</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>begin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>mid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>begin</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w> </span><span class=c1>// 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AddTask3</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AddTask3</span><span class=p>(</span><span class=n>begin</span><span class=p>,</span><span class=w> </span><span class=n>mid</span><span class=p>);</span><span class=w> </span><span class=c1>// 1,3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=na>fork</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AddTask3</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AddTask3</span><span class=p>(</span><span class=n>mid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=p>);</span><span class=w> </span><span class=c1>// 4,5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=na>fork</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;fork() {} + {} = ?&#34;</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>,</span><span class=w> </span><span class=n>t2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>t2</span><span class=p>.</span><span class=na>join</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;join() {} + {} = {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>,</span><span class=w> </span><span class=n>t2</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç„¶åæäº¤ç»™ ForkJoinPool æ¥æ‰§è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-402-1><a class=lnlinks href=#hl-402-1>1</a>
</span><span class=lnt id=hl-402-2><a class=lnlinks href=#hl-402-2>2</a>
</span><span class=lnt id=hl-402-3><a class=lnlinks href=#hl-402-3>3</a>
</span><span class=lnt id=hl-402-4><a class=lnlinks href=#hl-402-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ForkJoinPool</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ForkJoinPool</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>pool</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AddTask3</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>10</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-403-1><a class=lnlinks href=#hl-403-1>1</a>
</span><span class=lnt id=hl-403-2><a class=lnlinks href=#hl-403-2>2</a>
</span><span class=lnt id=hl-403-3><a class=lnlinks href=#hl-403-3>3</a>
</span><span class=lnt id=hl-403-4><a class=lnlinks href=#hl-403-4>4</a>
</span><span class=lnt id=hl-403-5><a class=lnlinks href=#hl-403-5>5</a>
</span><span class=lnt id=hl-403-6><a class=lnlinks href=#hl-403-6>6</a>
</span><span class=lnt id=hl-403-7><a class=lnlinks href=#hl-403-7>7</a>
</span><span class=lnt id=hl-403-8><a class=lnlinks href=#hl-403-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-0<span class=o>]</span> - join<span class=o>()</span> <span class=m>1</span> + <span class=nv>2</span> <span class=o>=</span> <span class=m>3</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-3<span class=o>]</span> - join<span class=o>()</span> <span class=m>4</span> + <span class=nv>5</span> <span class=o>=</span> <span class=m>9</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-0<span class=o>]</span> - join<span class=o>()</span> <span class=m>3</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-1<span class=o>]</span> - fork<span class=o>()</span> <span class=o>{</span>1,3<span class=o>}</span> + <span class=o>{</span>4,5<span class=o>}</span> <span class=o>=</span> ? 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-2<span class=o>]</span> - fork<span class=o>()</span> <span class=o>{</span>1,2<span class=o>}</span> + <span class=o>{</span>3,3<span class=o>}</span> <span class=o>=</span> ? 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-2<span class=o>]</span> - join<span class=o>()</span> <span class=o>{</span>1,2<span class=o>}</span> + <span class=o>{</span>3,3<span class=o>}</span> <span class=o>=</span> <span class=m>6</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>ForkJoinPool-1-worker-1<span class=o>]</span> - join<span class=o>()</span> <span class=o>{</span>1,3<span class=o>}</span> + <span class=o>{</span>4,5<span class=o>}</span> <span class=o>=</span> <span class=m>15</span> 
</span></span><span class=line><span class=cl><span class=m>15</span> 
</span></span></code></pre></td></tr></table></div></div><p>ç”¨å›¾æ¥è¡¨ç¤º</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312104428504.png width=900 height=600 loading=lazy decoding=async alt=image-20220312104428504 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=font-colorblueaqs-åŸç†font><a href=#font-colorblueaqs-%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>*AQS åŸç†</font></h2><h3 id=æ¦‚è¿°-1><a href=#%e6%a6%82%e8%bf%b0-1 class=header-anchor>#</a>
æ¦‚è¿°</h3><p>å…¨ç§°æ˜¯ AbstractQueuedSynchronizerï¼Œæ˜¯é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶</p><p>ç‰¹ç‚¹ï¼š</p><ul><li>ç”¨ state å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å– é”å’Œé‡Šæ”¾é”<ul><li>getState - è·å– state çŠ¶æ€</li><li>setState - è®¾ç½® state çŠ¶æ€</li><li>compareAndSetState - cas æœºåˆ¶è®¾ç½® state çŠ¶æ€</li><li>ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œè€Œå…±äº«æ¨¡å¼å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æº</li></ul></li><li>æä¾›äº†åŸºäº FIFO çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œç±»ä¼¼äº Monitor çš„ EntryList</li><li>æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ã€å”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼äº Monitor çš„ WaitSet</li></ul><p>å­ç±»ä¸»è¦å®ç°è¿™æ ·ä¸€äº›æ–¹æ³•ï¼ˆé»˜è®¤æŠ›å‡º UnsupportedOperationExceptionï¼‰</p><ul><li>tryAcquire</li><li>tryRelease</li><li>tryAcquireShared</li><li>tryReleaseShared</li><li>isHeldExclusively</li></ul><p>è·å–é”çš„å§¿åŠ¿</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-404-1><a class=lnlinks href=#hl-404-1>1</a>
</span><span class=lnt id=hl-404-2><a class=lnlinks href=#hl-404-2>2</a>
</span><span class=lnt id=hl-404-3><a class=lnlinks href=#hl-404-3>3</a>
</span><span class=lnt id=hl-404-4><a class=lnlinks href=#hl-404-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å¦‚æœè·å–é”å¤±è´¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å…¥é˜Ÿ, å¯ä»¥é€‰æ‹©é˜»å¡å½“å‰çº¿ç¨‹ park unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é‡Šæ”¾é”çš„å§¿åŠ¿</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-405-1><a class=lnlinks href=#hl-405-1>1</a>
</span><span class=lnt id=hl-405-2><a class=lnlinks href=#hl-405-2>2</a>
</span><span class=lnt id=hl-405-3><a class=lnlinks href=#hl-405-3>3</a>
</span><span class=lnt id=hl-405-4><a class=lnlinks href=#hl-405-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å¦‚æœé‡Šæ”¾é”æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryRelease</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è®©é˜»å¡çº¿ç¨‹æ¢å¤è¿è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=å®ç°ä¸å¯é‡å…¥é”><a href=#%e5%ae%9e%e7%8e%b0%e4%b8%8d%e5%8f%af%e9%87%8d%e5%85%a5%e9%94%81 class=header-anchor>#</a>
å®ç°ä¸å¯é‡å…¥é”</h3><h5 id=è‡ªå®šä¹‰åŒæ­¥å™¨><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%90%8c%e6%ad%a5%e5%99%a8 class=header-anchor>#</a>
<strong>è‡ªå®šä¹‰åŒæ­¥å™¨</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-406-1><a class=lnlinks href=#hl-406-1> 1</a>
</span><span class=lnt id=hl-406-2><a class=lnlinks href=#hl-406-2> 2</a>
</span><span class=lnt id=hl-406-3><a class=lnlinks href=#hl-406-3> 3</a>
</span><span class=lnt id=hl-406-4><a class=lnlinks href=#hl-406-4> 4</a>
</span><span class=lnt id=hl-406-5><a class=lnlinks href=#hl-406-5> 5</a>
</span><span class=lnt id=hl-406-6><a class=lnlinks href=#hl-406-6> 6</a>
</span><span class=lnt id=hl-406-7><a class=lnlinks href=#hl-406-7> 7</a>
</span><span class=lnt id=hl-406-8><a class=lnlinks href=#hl-406-8> 8</a>
</span><span class=lnt id=hl-406-9><a class=lnlinks href=#hl-406-9> 9</a>
</span><span class=lnt id=hl-406-10><a class=lnlinks href=#hl-406-10>10</a>
</span><span class=lnt id=hl-406-11><a class=lnlinks href=#hl-406-11>11</a>
</span><span class=lnt id=hl-406-12><a class=lnlinks href=#hl-406-12>12</a>
</span><span class=lnt id=hl-406-13><a class=lnlinks href=#hl-406-13>13</a>
</span><span class=lnt id=hl-406-14><a class=lnlinks href=#hl-406-14>14</a>
</span><span class=lnt id=hl-406-15><a class=lnlinks href=#hl-406-15>15</a>
</span><span class=lnt id=hl-406-16><a class=lnlinks href=#hl-406-16>16</a>
</span><span class=lnt id=hl-406-17><a class=lnlinks href=#hl-406-17>17</a>
</span><span class=lnt id=hl-406-18><a class=lnlinks href=#hl-406-18>18</a>
</span><span class=lnt id=hl-406-19><a class=lnlinks href=#hl-406-19>19</a>
</span><span class=lnt id=hl-406-20><a class=lnlinks href=#hl-406-20>20</a>
</span><span class=lnt id=hl-406-21><a class=lnlinks href=#hl-406-21>21</a>
</span><span class=lnt id=hl-406-22><a class=lnlinks href=#hl-406-22>22</a>
</span><span class=lnt id=hl-406-23><a class=lnlinks href=#hl-406-23>23</a>
</span><span class=lnt id=hl-406-24><a class=lnlinks href=#hl-406-24>24</a>
</span><span class=lnt id=hl-406-25><a class=lnlinks href=#hl-406-25>25</a>
</span><span class=lnt id=hl-406-26><a class=lnlinks href=#hl-406-26>26</a>
</span><span class=lnt id=hl-406-27><a class=lnlinks href=#hl-406-27>27</a>
</span><span class=lnt id=hl-406-28><a class=lnlinks href=#hl-406-28>28</a>
</span><span class=lnt id=hl-406-29><a class=lnlinks href=#hl-406-29>29</a>
</span><span class=lnt id=hl-406-30><a class=lnlinks href=#hl-406-30>30</a>
</span><span class=lnt id=hl-406-31><a class=lnlinks href=#hl-406-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>MySync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractQueuedSynchronizer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquires</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryRelease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>acquires</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>getState</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setState</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=nf>newCondition</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConditionObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isHeldExclusively</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getState</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=è‡ªå®šä¹‰é”><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e9%94%81 class=header-anchor>#</a>
<strong>è‡ªå®šä¹‰é”</strong></h5><p>æœ‰äº†è‡ªå®šä¹‰åŒæ­¥å™¨ï¼Œå¾ˆå®¹æ˜“å¤ç”¨ AQS ï¼Œå®ç°ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„è‡ªå®šä¹‰é”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-407-1><a class=lnlinks href=#hl-407-1> 1</a>
</span><span class=lnt id=hl-407-2><a class=lnlinks href=#hl-407-2> 2</a>
</span><span class=lnt id=hl-407-3><a class=lnlinks href=#hl-407-3> 3</a>
</span><span class=lnt id=hl-407-4><a class=lnlinks href=#hl-407-4> 4</a>
</span><span class=lnt id=hl-407-5><a class=lnlinks href=#hl-407-5> 5</a>
</span><span class=lnt id=hl-407-6><a class=lnlinks href=#hl-407-6> 6</a>
</span><span class=lnt id=hl-407-7><a class=lnlinks href=#hl-407-7> 7</a>
</span><span class=lnt id=hl-407-8><a class=lnlinks href=#hl-407-8> 8</a>
</span><span class=lnt id=hl-407-9><a class=lnlinks href=#hl-407-9> 9</a>
</span><span class=lnt id=hl-407-10><a class=lnlinks href=#hl-407-10>10</a>
</span><span class=lnt id=hl-407-11><a class=lnlinks href=#hl-407-11>11</a>
</span><span class=lnt id=hl-407-12><a class=lnlinks href=#hl-407-12>12</a>
</span><span class=lnt id=hl-407-13><a class=lnlinks href=#hl-407-13>13</a>
</span><span class=lnt id=hl-407-14><a class=lnlinks href=#hl-407-14>14</a>
</span><span class=lnt id=hl-407-15><a class=lnlinks href=#hl-407-15>15</a>
</span><span class=lnt id=hl-407-16><a class=lnlinks href=#hl-407-16>16</a>
</span><span class=lnt id=hl-407-17><a class=lnlinks href=#hl-407-17>17</a>
</span><span class=lnt id=hl-407-18><a class=lnlinks href=#hl-407-18>18</a>
</span><span class=lnt id=hl-407-19><a class=lnlinks href=#hl-407-19>19</a>
</span><span class=lnt id=hl-407-20><a class=lnlinks href=#hl-407-20>20</a>
</span><span class=lnt id=hl-407-21><a class=lnlinks href=#hl-407-21>21</a>
</span><span class=lnt id=hl-407-22><a class=lnlinks href=#hl-407-22>22</a>
</span><span class=lnt id=hl-407-23><a class=lnlinks href=#hl-407-23>23</a>
</span><span class=lnt id=hl-407-24><a class=lnlinks href=#hl-407-24>24</a>
</span><span class=lnt id=hl-407-25><a class=lnlinks href=#hl-407-25>25</a>
</span><span class=lnt id=hl-407-26><a class=lnlinks href=#hl-407-26>26</a>
</span><span class=lnt id=hl-407-27><a class=lnlinks href=#hl-407-27>27</a>
</span><span class=lnt id=hl-407-28><a class=lnlinks href=#hl-407-28>28</a>
</span><span class=lnt id=hl-407-29><a class=lnlinks href=#hl-407-29>29</a>
</span><span class=lnt id=hl-407-30><a class=lnlinks href=#hl-407-30>30</a>
</span><span class=lnt id=hl-407-31><a class=lnlinks href=#hl-407-31>31</a>
</span><span class=lnt id=hl-407-32><a class=lnlinks href=#hl-407-32>32</a>
</span><span class=lnt id=hl-407-33><a class=lnlinks href=#hl-407-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>MyLock</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>MySync</span><span class=w> </span><span class=n>sync</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MySync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>acquire</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¯æ‰“æ–­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lockInterruptibly</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>acquireInterruptibly</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°è¯•ä¸€æ¬¡ï¼Œä¸æˆåŠŸè¿”å›ï¼Œä¸è¿›å…¥é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryLock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sync</span><span class=p>.</span><span class=na>tryAcquire</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæœ‰æ—¶é™</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryLock</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sync</span><span class=p>.</span><span class=na>tryAcquireNanos</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>unit</span><span class=p>.</span><span class=na>toNanos</span><span class=p>(</span><span class=n>time</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é‡Šæ”¾é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç”Ÿæˆæ¡ä»¶å˜é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=nf>newCondition</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sync</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•ä¸€ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-408-1><a class=lnlinks href=#hl-408-1> 1</a>
</span><span class=lnt id=hl-408-2><a class=lnlinks href=#hl-408-2> 2</a>
</span><span class=lnt id=hl-408-3><a class=lnlinks href=#hl-408-3> 3</a>
</span><span class=lnt id=hl-408-4><a class=lnlinks href=#hl-408-4> 4</a>
</span><span class=lnt id=hl-408-5><a class=lnlinks href=#hl-408-5> 5</a>
</span><span class=lnt id=hl-408-6><a class=lnlinks href=#hl-408-6> 6</a>
</span><span class=lnt id=hl-408-7><a class=lnlinks href=#hl-408-7> 7</a>
</span><span class=lnt id=hl-408-8><a class=lnlinks href=#hl-408-8> 8</a>
</span><span class=lnt id=hl-408-9><a class=lnlinks href=#hl-408-9> 9</a>
</span><span class=lnt id=hl-408-10><a class=lnlinks href=#hl-408-10>10</a>
</span><span class=lnt id=hl-408-11><a class=lnlinks href=#hl-408-11>11</a>
</span><span class=lnt id=hl-408-12><a class=lnlinks href=#hl-408-12>12</a>
</span><span class=lnt id=hl-408-13><a class=lnlinks href=#hl-408-13>13</a>
</span><span class=lnt id=hl-408-14><a class=lnlinks href=#hl-408-14>14</a>
</span><span class=lnt id=hl-408-15><a class=lnlinks href=#hl-408-15>15</a>
</span><span class=lnt id=hl-408-16><a class=lnlinks href=#hl-408-16>16</a>
</span><span class=lnt id=hl-408-17><a class=lnlinks href=#hl-408-17>17</a>
</span><span class=lnt id=hl-408-18><a class=lnlinks href=#hl-408-18>18</a>
</span><span class=lnt id=hl-408-19><a class=lnlinks href=#hl-408-19>19</a>
</span><span class=lnt id=hl-408-20><a class=lnlinks href=#hl-408-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>MyLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MyLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;locking...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unlocking...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;locking...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;unlocking...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-409-1><a class=lnlinks href=#hl-409-1>1</a>
</span><span class=lnt id=hl-409-2><a class=lnlinks href=#hl-409-2>2</a>
</span><span class=lnt id=hl-409-3><a class=lnlinks href=#hl-409-3>3</a>
</span><span class=lnt id=hl-409-4><a class=lnlinks href=#hl-409-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>22:29:28.727 c.TestAqs <span class=o>[</span>t1<span class=o>]</span> - locking... 
</span></span><span class=line><span class=cl>22:29:29.732 c.TestAqs <span class=o>[</span>t1<span class=o>]</span> - unlocking... 
</span></span><span class=line><span class=cl>22:29:29.732 c.TestAqs <span class=o>[</span>t2<span class=o>]</span> - locking... 
</span></span><span class=line><span class=cl>22:29:29.732 c.TestAqs <span class=o>[</span>t2<span class=o>]</span> - unlocking... 
</span></span></code></pre></td></tr></table></div></div><p>ä¸å¯é‡å…¥æµ‹è¯•</p><p>å¦‚æœæ”¹ä¸ºä¸‹é¢ä»£ç ï¼Œä¼šå‘ç°è‡ªå·±ä¹Ÿä¼šè¢«æŒ¡ä½ï¼ˆåªä¼šæ‰“å°ä¸€æ¬¡ lockingï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-410-1><a class=lnlinks href=#hl-410-1>1</a>
</span><span class=lnt id=hl-410-2><a class=lnlinks href=#hl-410-2>2</a>
</span><span class=lnt id=hl-410-3><a class=lnlinks href=#hl-410-3>3</a>
</span><span class=lnt id=hl-410-4><a class=lnlinks href=#hl-410-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>lock.lock<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>log.debug<span class=o>(</span><span class=s2>&#34;locking...&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>lock.lock<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>log.debug<span class=o>(</span><span class=s2>&#34;locking...&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å¿ƒå¾—><a href=#%e5%bf%83%e5%be%97 class=header-anchor>#</a>
å¿ƒå¾—</h3><h5 id=èµ·æº><a href=#%e8%b5%b7%e6%ba%90 class=header-anchor>#</a>
<strong>èµ·æº</strong></h5><p>æ—©æœŸç¨‹åºå‘˜ä¼šè‡ªå·±é€šè¿‡ä¸€ç§åŒæ­¥å™¨å»å®ç°å¦ä¸€ç§ç›¸è¿‘çš„åŒæ­¥å™¨ï¼Œä¾‹å¦‚ç”¨å¯é‡å…¥é”å»å®ç°ä¿¡å·é‡ï¼Œæˆ–åä¹‹ã€‚è¿™æ˜¾ç„¶ä¸ å¤Ÿä¼˜é›…ï¼Œäºæ˜¯åœ¨ JSR166ï¼ˆjava è§„èŒƒææ¡ˆï¼‰ä¸­åˆ›å»ºäº† AQSï¼Œæä¾›äº†è¿™ç§é€šç”¨çš„åŒæ­¥å™¨æœºåˆ¶ã€‚</p><h5 id=ç›®æ ‡><a href=#%e7%9b%ae%e6%a0%87 class=header-anchor>#</a>
<strong>ç›®æ ‡</strong></h5><p>AQS è¦å®ç°çš„åŠŸèƒ½ç›®æ ‡</p><ul><li>é˜»å¡ç‰ˆæœ¬è·å–é” acquire å’Œéé˜»å¡çš„ç‰ˆæœ¬å°è¯•è·å–é” tryAcquire</li><li>è·å–é”è¶…æ—¶æœºåˆ¶</li><li>é€šè¿‡æ‰“æ–­å–æ¶ˆæœºåˆ¶</li><li>ç‹¬å æœºåˆ¶åŠå…±äº«æœºåˆ¶</li><li>æ¡ä»¶ä¸æ»¡è¶³æ—¶çš„ç­‰å¾…æœºåˆ¶</li></ul><p>è¦å®ç°çš„æ€§èƒ½ç›®æ ‡</p><blockquote><p>Instead, the primary performance goal here is scalability: to predictably maintain efficiency even, or especially, when synchronizers are contended.</p></blockquote><h5 id=è®¾è®¡><a href=#%e8%ae%be%e8%ae%a1 class=header-anchor>#</a>
<strong>è®¾è®¡</strong></h5><p>AQS çš„åŸºæœ¬æ€æƒ³å…¶å®å¾ˆç®€å•</p><p>è·å–é”çš„é€»è¾‘</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-411-1><a class=lnlinks href=#hl-411-1>1</a>
</span><span class=lnt id=hl-411-2><a class=lnlinks href=#hl-411-2>2</a>
</span><span class=lnt id=hl-411-3><a class=lnlinks href=#hl-411-3>3</a>
</span><span class=lnt id=hl-411-4><a class=lnlinks href=#hl-411-4>4</a>
</span><span class=lnt id=hl-411-5><a class=lnlinks href=#hl-411-5>5</a>
</span><span class=lnt id=hl-411-6><a class=lnlinks href=#hl-411-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>while</span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=n>çŠ¶æ€ä¸å…è®¸è·å–</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰æ­¤çº¿ç¨‹</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>å…¥é˜Ÿå¹¶é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>å½“å‰çº¿ç¨‹å‡ºé˜Ÿ</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é‡Šæ”¾é”çš„é€»è¾‘</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-412-1><a class=lnlinks href=#hl-412-1>1</a>
</span><span class=lnt id=hl-412-2><a class=lnlinks href=#hl-412-2>2</a>
</span><span class=lnt id=hl-412-3><a class=lnlinks href=#hl-412-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=n>çŠ¶æ€å…è®¸äº†</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>æ¢å¤é˜»å¡çš„çº¿ç¨‹</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¦ç‚¹</p><ul><li>åŸå­ç»´æŠ¤ state çŠ¶æ€</li><li>é˜»å¡åŠæ¢å¤çº¿ç¨‹</li><li>ç»´æŠ¤é˜Ÿåˆ—</li></ul><ol><li>state è®¾è®¡<ul><li>state ä½¿ç”¨ volatile é…åˆ cas ä¿è¯å…¶ä¿®æ”¹æ—¶çš„åŸå­æ€§</li><li>state ä½¿ç”¨äº† 32bit int æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ï¼Œå› ä¸ºå½“æ—¶ä½¿ç”¨ long åœ¨å¾ˆå¤šå¹³å°ä¸‹æµ‹è¯•çš„ç»“æœå¹¶ä¸ç†æƒ³</li></ul></li></ol><ol start=2><li>é˜»å¡æ¢å¤è®¾è®¡<ul><li>æ—©æœŸçš„æ§åˆ¶çº¿ç¨‹æš‚åœå’Œæ¢å¤çš„ api æœ‰ suspend å’Œ resumeï¼Œä½†å®ƒä»¬æ˜¯ä¸å¯ç”¨çš„ï¼Œå› ä¸ºå¦‚æœå…ˆè°ƒç”¨çš„ resume é‚£ä¹ˆ suspend å°†æ„ŸçŸ¥ä¸åˆ°</li><li>è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨ park & unpark æ¥å®ç°çº¿ç¨‹çš„æš‚åœå’Œæ¢å¤ï¼Œå…·ä½“åŸç†åœ¨ä¹‹å‰è®²è¿‡äº†ï¼Œå…ˆ unpark å† park ä¹Ÿæ²¡ é—®é¢˜</li><li>park & unpark æ˜¯é’ˆå¯¹çº¿ç¨‹çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹åŒæ­¥å™¨çš„ï¼Œå› æ­¤æ§åˆ¶ç²’åº¦æ›´ä¸ºç²¾ç»†</li><li>park çº¿ç¨‹è¿˜å¯ä»¥é€šè¿‡ interrupt æ‰“æ–­</li></ul></li><li>é˜Ÿåˆ—è®¾è®¡<ul><li>ä½¿ç”¨äº† FIFO å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ï¼Œå¹¶ä¸æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—</li><li>è®¾è®¡æ—¶å€Ÿé‰´äº† CLH é˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸€ç§å•å‘æ— é”é˜Ÿåˆ—</li></ul></li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312234238685.png width=900 height=600 loading=lazy decoding=async alt=image-20220312234238685 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>é˜Ÿåˆ—ä¸­æœ‰ head å’Œ tail ä¸¤ä¸ªæŒ‡é’ˆèŠ‚ç‚¹ï¼Œéƒ½ç”¨ volatile ä¿®é¥°é…åˆ cas ä½¿ç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰ state ç»´æŠ¤èŠ‚ç‚¹çŠ¶æ€ å…¥é˜Ÿä¼ªä»£ç ï¼Œåªéœ€è¦è€ƒè™‘ tail èµ‹å€¼çš„åŸå­æ€§</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-413-1><a class=lnlinks href=#hl-413-1>1</a>
</span><span class=lnt id=hl-413-2><a class=lnlinks href=#hl-413-2>2</a>
</span><span class=lnt id=hl-413-3><a class=lnlinks href=#hl-413-3>3</a>
</span><span class=lnt id=hl-413-4><a class=lnlinks href=#hl-413-4>4</a>
</span><span class=lnt id=hl-413-5><a class=lnlinks href=#hl-413-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åŸæ¥çš„ tail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç”¨ cas åœ¨åŸæ¥ tail çš„åŸºç¡€ä¸Šæ”¹ä¸º node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=n>tail</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>))</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å‡ºé˜Ÿä¼ªä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-414-1><a class=lnlinks href=#hl-414-1>1</a>
</span><span class=lnt id=hl-414-2><a class=lnlinks href=#hl-414-2>2</a>
</span><span class=lnt id=hl-414-3><a class=lnlinks href=#hl-414-3>3</a>
</span><span class=lnt id=hl-414-4><a class=lnlinks href=#hl-414-4>4</a>
</span><span class=lnt id=hl-414-5><a class=lnlinks href=#hl-414-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// prev æ˜¯ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>while</span><span class=p>((</span><span class=n>Node</span><span class=w> </span><span class=n>prev</span><span class=o>=</span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=p>).</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>å”¤é†’çŠ¶æ€</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è®¾ç½®å¤´èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>CLH å¥½å¤„ï¼š</p><ul><li>æ— é”ï¼Œä½¿ç”¨è‡ªæ—‹</li><li>å¿«é€Ÿï¼Œæ— é˜»å¡</li></ul><p>AQS åœ¨ä¸€äº›æ–¹é¢æ”¹è¿›äº† CLH</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-415-1><a class=lnlinks href=#hl-415-1> 1</a>
</span><span class=lnt id=hl-415-2><a class=lnlinks href=#hl-415-2> 2</a>
</span><span class=lnt id=hl-415-3><a class=lnlinks href=#hl-415-3> 3</a>
</span><span class=lnt id=hl-415-4><a class=lnlinks href=#hl-415-4> 4</a>
</span><span class=lnt id=hl-415-5><a class=lnlinks href=#hl-415-5> 5</a>
</span><span class=lnt id=hl-415-6><a class=lnlinks href=#hl-415-6> 6</a>
</span><span class=lnt id=hl-415-7><a class=lnlinks href=#hl-415-7> 7</a>
</span><span class=lnt id=hl-415-8><a class=lnlinks href=#hl-415-8> 8</a>
</span><span class=lnt id=hl-415-9><a class=lnlinks href=#hl-415-9> 9</a>
</span><span class=lnt id=hl-415-10><a class=lnlinks href=#hl-415-10>10</a>
</span><span class=lnt id=hl-415-11><a class=lnlinks href=#hl-415-11>11</a>
</span><span class=lnt id=hl-415-12><a class=lnlinks href=#hl-415-12>12</a>
</span><span class=lnt id=hl-415-13><a class=lnlinks href=#hl-415-13>13</a>
</span><span class=lnt id=hl-415-14><a class=lnlinks href=#hl-415-14>14</a>
</span><span class=lnt id=hl-415-15><a class=lnlinks href=#hl-415-15>15</a>
</span><span class=lnt id=hl-415-16><a class=lnlinks href=#hl-415-16>16</a>
</span><span class=lnt id=hl-415-17><a class=lnlinks href=#hl-415-17>17</a>
</span><span class=lnt id=hl-415-18><a class=lnlinks href=#hl-415-18>18</a>
</span><span class=lnt id=hl-415-19><a class=lnlinks href=#hl-415-19>19</a>
</span><span class=lnt id=hl-415-20><a class=lnlinks href=#hl-415-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=nf>enq</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰å…ƒç´  tail ä¸º null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°† head ä» null -&gt; dummy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetHead</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°† node çš„ prev è®¾ç½®ä¸ºåŸæ¥çš„ tail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°† tail ä»åŸæ¥çš„ tail è®¾ç½®ä¸º node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetTail</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// åŸæ¥ tail çš„ next è®¾ç½®ä¸º node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>t</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=ä¸»è¦ç”¨åˆ°-aqs-çš„å¹¶å‘å·¥å…·ç±»><a href=#%e4%b8%bb%e8%a6%81%e7%94%a8%e5%88%b0-aqs-%e7%9a%84%e5%b9%b6%e5%8f%91%e5%b7%a5%e5%85%b7%e7%b1%bb class=header-anchor>#</a>
ä¸»è¦ç”¨åˆ° AQS çš„å¹¶å‘å·¥å…·ç±»</h5><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312235232687.png width=900 height=600 loading=lazy decoding=async alt=image-20220312235232687 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h2 id=reentrantlock-åŸç†><a href=#reentrantlock-%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
ReentrantLock åŸç†</h2><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220312235320716.png width=900 height=600 loading=lazy decoding=async alt=image-20220312235320716 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h3 id=éå…¬å¹³é”å®ç°åŸç†><a href=#%e9%9d%9e%e5%85%ac%e5%b9%b3%e9%94%81%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
éå…¬å¹³é”å®ç°åŸç†</h3><h5 id=åŠ é”è§£é”æµç¨‹><a href=#%e5%8a%a0%e9%94%81%e8%a7%a3%e9%94%81%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
åŠ é”è§£é”æµç¨‹</h5><p>å…ˆä»æ„é€ å™¨å¼€å§‹çœ‹ï¼Œé»˜è®¤ä¸ºéå…¬å¹³é”å®ç°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-416-1><a class=lnlinks href=#hl-416-1>1</a>
</span><span class=lnt id=hl-416-2><a class=lnlinks href=#hl-416-2>2</a>
</span><span class=lnt id=hl-416-3><a class=lnlinks href=#hl-416-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ReentrantLock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sync</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NonfairSync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>NonfairSync ç»§æ‰¿è‡ª AQS æ²¡æœ‰ç«äº‰æ—¶</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153311208.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153311208 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°æ—¶</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153333551.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153333551 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>Thread-1 æ‰§è¡Œäº†</p><ol><li>CAS å°è¯•å°† state ç”± 0 æ”¹ä¸º 1ï¼Œç»“æœå¤±è´¥</li><li>è¿›å…¥ tryAcquire é€»è¾‘ï¼Œè¿™æ—¶ state å·²ç»æ˜¯1ï¼Œç»“æœä»ç„¶å¤±è´¥</li><li>æ¥ä¸‹æ¥è¿›å…¥ addWaiter é€»è¾‘ï¼Œæ„é€  Node é˜Ÿåˆ—<ul><li>å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥ Node çš„ waitStatus çŠ¶æ€ï¼Œå…¶ä¸­ 0 ä¸ºé»˜è®¤æ­£å¸¸çŠ¶æ€</li><li>Node çš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„</li><li>å…¶ä¸­ç¬¬ä¸€ä¸ª Node ç§°ä¸º Dummyï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹</li></ul></li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153434087.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153434087 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å½“å‰çº¿ç¨‹è¿›å…¥ acquireQueued é€»è¾‘</p><ol><li>acquireQueued ä¼šåœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥ park é˜»å¡</li><li>å¦‚æœè‡ªå·±æ˜¯ç´§é‚»ç€ headï¼ˆæ’ç¬¬äºŒä½ï¼‰ï¼Œé‚£ä¹ˆå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶ state ä»ä¸º 1ï¼Œå¤±è´¥</li><li>è¿›å…¥ shouldParkAfterFailedAcquire é€»è¾‘ï¼Œå°†å‰é©± nodeï¼Œå³ head çš„ waitStatus æ”¹ä¸º -1ï¼Œè¿™æ¬¡è¿”å› false
<img src=https://logan.1357810.xyz/notgit/juc/image-20220314153526384.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153526384 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></li><li>shouldParkAfterFailedAcquire æ‰§è¡Œå®Œæ¯•å›åˆ° acquireQueued ï¼Œå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶ state ä»ä¸º 1ï¼Œå¤±è´¥</li><li>å½“å†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquire æ—¶ï¼Œè¿™æ—¶å› ä¸ºå…¶å‰é©± node çš„ waitStatus å·²ç»æ˜¯ -1ï¼Œè¿™æ¬¡è¿”å› true</li><li>è¿›å…¥ parkAndCheckInterruptï¼Œ Thread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰</li></ol><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153708216.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153708216 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å†æ¬¡æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ä¸Šè¿°è¿‡ç¨‹ç«äº‰å¤±è´¥ï¼Œå˜æˆè¿™ä¸ªæ ·å­</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314154029099.png width=900 height=600 loading=lazy decoding=async alt=image-20220314154029099 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>Thread-0 é‡Šæ”¾é”ï¼Œè¿›å…¥ tryRelease æµç¨‹ï¼Œå¦‚æœæˆåŠŸ</p><ul><li>è®¾ç½® exclusiveOwnerThread ä¸º null</li><li>state = 0</li></ul><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153831407.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153831407 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å½“å‰é˜Ÿåˆ—ä¸ä¸º nullï¼Œå¹¶ä¸” head çš„ waitStatus = -1ï¼Œè¿›å…¥ unparkSuccessor æµç¨‹</p><p>æ‰¾åˆ°é˜Ÿåˆ—ä¸­ç¦» head æœ€è¿‘çš„ä¸€ä¸ª Nodeï¼ˆæ²¡å–æ¶ˆçš„ï¼‰ï¼Œunpark æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸º Thread-1</p><p>å›åˆ° Thread-1 çš„ acquireQueued æµç¨‹</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314153919958.png width=900 height=600 loading=lazy decoding=async alt=image-20220314153919958 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®</p><ul><li>exclusiveOwnerThread ä¸º Thread-1ï¼Œstate = 1</li><li>head æŒ‡å‘åˆšåˆš Thread-1 æ‰€åœ¨çš„ Nodeï¼Œè¯¥ Node æ¸…ç©º Thread</li><li>åŸæœ¬çš„ head å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œè€Œå¯è¢«åƒåœ¾å›æ”¶</li></ul><p>å¦‚æœè¿™æ—¶å€™æœ‰å…¶å®ƒçº¿ç¨‹æ¥ç«äº‰ï¼ˆéå…¬å¹³çš„ä½“ç°ï¼‰ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰ Thread-4 æ¥äº†</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314154048958.png width=900 height=600 loading=lazy decoding=async alt=image-20220314154048958 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å¦‚æœä¸å·§åˆè¢« Thread-4 å äº†å…ˆ</p><ul><li>Thread-4 è¢«è®¾ç½®ä¸º exclusiveOwnerThreadï¼Œstate = 1</li><li>Thread-1 å†æ¬¡è¿›å…¥ acquireQueued æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥ park é˜»å¡</li></ul><h5 id=åŠ é”æºç ><a href=#%e5%8a%a0%e9%94%81%e6%ba%90%e7%a0%81 class=header-anchor>#</a>
åŠ é”æºç </h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-417-1><a class=lnlinks href=#hl-417-1>  1</a>
</span><span class=lnt id=hl-417-2><a class=lnlinks href=#hl-417-2>  2</a>
</span><span class=lnt id=hl-417-3><a class=lnlinks href=#hl-417-3>  3</a>
</span><span class=lnt id=hl-417-4><a class=lnlinks href=#hl-417-4>  4</a>
</span><span class=lnt id=hl-417-5><a class=lnlinks href=#hl-417-5>  5</a>
</span><span class=lnt id=hl-417-6><a class=lnlinks href=#hl-417-6>  6</a>
</span><span class=lnt id=hl-417-7><a class=lnlinks href=#hl-417-7>  7</a>
</span><span class=lnt id=hl-417-8><a class=lnlinks href=#hl-417-8>  8</a>
</span><span class=lnt id=hl-417-9><a class=lnlinks href=#hl-417-9>  9</a>
</span><span class=lnt id=hl-417-10><a class=lnlinks href=#hl-417-10> 10</a>
</span><span class=lnt id=hl-417-11><a class=lnlinks href=#hl-417-11> 11</a>
</span><span class=lnt id=hl-417-12><a class=lnlinks href=#hl-417-12> 12</a>
</span><span class=lnt id=hl-417-13><a class=lnlinks href=#hl-417-13> 13</a>
</span><span class=lnt id=hl-417-14><a class=lnlinks href=#hl-417-14> 14</a>
</span><span class=lnt id=hl-417-15><a class=lnlinks href=#hl-417-15> 15</a>
</span><span class=lnt id=hl-417-16><a class=lnlinks href=#hl-417-16> 16</a>
</span><span class=lnt id=hl-417-17><a class=lnlinks href=#hl-417-17> 17</a>
</span><span class=lnt id=hl-417-18><a class=lnlinks href=#hl-417-18> 18</a>
</span><span class=lnt id=hl-417-19><a class=lnlinks href=#hl-417-19> 19</a>
</span><span class=lnt id=hl-417-20><a class=lnlinks href=#hl-417-20> 20</a>
</span><span class=lnt id=hl-417-21><a class=lnlinks href=#hl-417-21> 21</a>
</span><span class=lnt id=hl-417-22><a class=lnlinks href=#hl-417-22> 22</a>
</span><span class=lnt id=hl-417-23><a class=lnlinks href=#hl-417-23> 23</a>
</span><span class=lnt id=hl-417-24><a class=lnlinks href=#hl-417-24> 24</a>
</span><span class=lnt id=hl-417-25><a class=lnlinks href=#hl-417-25> 25</a>
</span><span class=lnt id=hl-417-26><a class=lnlinks href=#hl-417-26> 26</a>
</span><span class=lnt id=hl-417-27><a class=lnlinks href=#hl-417-27> 27</a>
</span><span class=lnt id=hl-417-28><a class=lnlinks href=#hl-417-28> 28</a>
</span><span class=lnt id=hl-417-29><a class=lnlinks href=#hl-417-29> 29</a>
</span><span class=lnt id=hl-417-30><a class=lnlinks href=#hl-417-30> 30</a>
</span><span class=lnt id=hl-417-31><a class=lnlinks href=#hl-417-31> 31</a>
</span><span class=lnt id=hl-417-32><a class=lnlinks href=#hl-417-32> 32</a>
</span><span class=lnt id=hl-417-33><a class=lnlinks href=#hl-417-33> 33</a>
</span><span class=lnt id=hl-417-34><a class=lnlinks href=#hl-417-34> 34</a>
</span><span class=lnt id=hl-417-35><a class=lnlinks href=#hl-417-35> 35</a>
</span><span class=lnt id=hl-417-36><a class=lnlinks href=#hl-417-36> 36</a>
</span><span class=lnt id=hl-417-37><a class=lnlinks href=#hl-417-37> 37</a>
</span><span class=lnt id=hl-417-38><a class=lnlinks href=#hl-417-38> 38</a>
</span><span class=lnt id=hl-417-39><a class=lnlinks href=#hl-417-39> 39</a>
</span><span class=lnt id=hl-417-40><a class=lnlinks href=#hl-417-40> 40</a>
</span><span class=lnt id=hl-417-41><a class=lnlinks href=#hl-417-41> 41</a>
</span><span class=lnt id=hl-417-42><a class=lnlinks href=#hl-417-42> 42</a>
</span><span class=lnt id=hl-417-43><a class=lnlinks href=#hl-417-43> 43</a>
</span><span class=lnt id=hl-417-44><a class=lnlinks href=#hl-417-44> 44</a>
</span><span class=lnt id=hl-417-45><a class=lnlinks href=#hl-417-45> 45</a>
</span><span class=lnt id=hl-417-46><a class=lnlinks href=#hl-417-46> 46</a>
</span><span class=lnt id=hl-417-47><a class=lnlinks href=#hl-417-47> 47</a>
</span><span class=lnt id=hl-417-48><a class=lnlinks href=#hl-417-48> 48</a>
</span><span class=lnt id=hl-417-49><a class=lnlinks href=#hl-417-49> 49</a>
</span><span class=lnt id=hl-417-50><a class=lnlinks href=#hl-417-50> 50</a>
</span><span class=lnt id=hl-417-51><a class=lnlinks href=#hl-417-51> 51</a>
</span><span class=lnt id=hl-417-52><a class=lnlinks href=#hl-417-52> 52</a>
</span><span class=lnt id=hl-417-53><a class=lnlinks href=#hl-417-53> 53</a>
</span><span class=lnt id=hl-417-54><a class=lnlinks href=#hl-417-54> 54</a>
</span><span class=lnt id=hl-417-55><a class=lnlinks href=#hl-417-55> 55</a>
</span><span class=lnt id=hl-417-56><a class=lnlinks href=#hl-417-56> 56</a>
</span><span class=lnt id=hl-417-57><a class=lnlinks href=#hl-417-57> 57</a>
</span><span class=lnt id=hl-417-58><a class=lnlinks href=#hl-417-58> 58</a>
</span><span class=lnt id=hl-417-59><a class=lnlinks href=#hl-417-59> 59</a>
</span><span class=lnt id=hl-417-60><a class=lnlinks href=#hl-417-60> 60</a>
</span><span class=lnt id=hl-417-61><a class=lnlinks href=#hl-417-61> 61</a>
</span><span class=lnt id=hl-417-62><a class=lnlinks href=#hl-417-62> 62</a>
</span><span class=lnt id=hl-417-63><a class=lnlinks href=#hl-417-63> 63</a>
</span><span class=lnt id=hl-417-64><a class=lnlinks href=#hl-417-64> 64</a>
</span><span class=lnt id=hl-417-65><a class=lnlinks href=#hl-417-65> 65</a>
</span><span class=lnt id=hl-417-66><a class=lnlinks href=#hl-417-66> 66</a>
</span><span class=lnt id=hl-417-67><a class=lnlinks href=#hl-417-67> 67</a>
</span><span class=lnt id=hl-417-68><a class=lnlinks href=#hl-417-68> 68</a>
</span><span class=lnt id=hl-417-69><a class=lnlinks href=#hl-417-69> 69</a>
</span><span class=lnt id=hl-417-70><a class=lnlinks href=#hl-417-70> 70</a>
</span><span class=lnt id=hl-417-71><a class=lnlinks href=#hl-417-71> 71</a>
</span><span class=lnt id=hl-417-72><a class=lnlinks href=#hl-417-72> 72</a>
</span><span class=lnt id=hl-417-73><a class=lnlinks href=#hl-417-73> 73</a>
</span><span class=lnt id=hl-417-74><a class=lnlinks href=#hl-417-74> 74</a>
</span><span class=lnt id=hl-417-75><a class=lnlinks href=#hl-417-75> 75</a>
</span><span class=lnt id=hl-417-76><a class=lnlinks href=#hl-417-76> 76</a>
</span><span class=lnt id=hl-417-77><a class=lnlinks href=#hl-417-77> 77</a>
</span><span class=lnt id=hl-417-78><a class=lnlinks href=#hl-417-78> 78</a>
</span><span class=lnt id=hl-417-79><a class=lnlinks href=#hl-417-79> 79</a>
</span><span class=lnt id=hl-417-80><a class=lnlinks href=#hl-417-80> 80</a>
</span><span class=lnt id=hl-417-81><a class=lnlinks href=#hl-417-81> 81</a>
</span><span class=lnt id=hl-417-82><a class=lnlinks href=#hl-417-82> 82</a>
</span><span class=lnt id=hl-417-83><a class=lnlinks href=#hl-417-83> 83</a>
</span><span class=lnt id=hl-417-84><a class=lnlinks href=#hl-417-84> 84</a>
</span><span class=lnt id=hl-417-85><a class=lnlinks href=#hl-417-85> 85</a>
</span><span class=lnt id=hl-417-86><a class=lnlinks href=#hl-417-86> 86</a>
</span><span class=lnt id=hl-417-87><a class=lnlinks href=#hl-417-87> 87</a>
</span><span class=lnt id=hl-417-88><a class=lnlinks href=#hl-417-88> 88</a>
</span><span class=lnt id=hl-417-89><a class=lnlinks href=#hl-417-89> 89</a>
</span><span class=lnt id=hl-417-90><a class=lnlinks href=#hl-417-90> 90</a>
</span><span class=lnt id=hl-417-91><a class=lnlinks href=#hl-417-91> 91</a>
</span><span class=lnt id=hl-417-92><a class=lnlinks href=#hl-417-92> 92</a>
</span><span class=lnt id=hl-417-93><a class=lnlinks href=#hl-417-93> 93</a>
</span><span class=lnt id=hl-417-94><a class=lnlinks href=#hl-417-94> 94</a>
</span><span class=lnt id=hl-417-95><a class=lnlinks href=#hl-417-95> 95</a>
</span><span class=lnt id=hl-417-96><a class=lnlinks href=#hl-417-96> 96</a>
</span><span class=lnt id=hl-417-97><a class=lnlinks href=#hl-417-97> 97</a>
</span><span class=lnt id=hl-417-98><a class=lnlinks href=#hl-417-98> 98</a>
</span><span class=lnt id=hl-417-99><a class=lnlinks href=#hl-417-99> 99</a>
</span><span class=lnt id=hl-417-100><a class=lnlinks href=#hl-417-100>100</a>
</span><span class=lnt id=hl-417-101><a class=lnlinks href=#hl-417-101>101</a>
</span><span class=lnt id=hl-417-102><a class=lnlinks href=#hl-417-102>102</a>
</span><span class=lnt id=hl-417-103><a class=lnlinks href=#hl-417-103>103</a>
</span><span class=lnt id=hl-417-104><a class=lnlinks href=#hl-417-104>104</a>
</span><span class=lnt id=hl-417-105><a class=lnlinks href=#hl-417-105>105</a>
</span><span class=lnt id=hl-417-106><a class=lnlinks href=#hl-417-106>106</a>
</span><span class=lnt id=hl-417-107><a class=lnlinks href=#hl-417-107>107</a>
</span><span class=lnt id=hl-417-108><a class=lnlinks href=#hl-417-108>108</a>
</span><span class=lnt id=hl-417-109><a class=lnlinks href=#hl-417-109>109</a>
</span><span class=lnt id=hl-417-110><a class=lnlinks href=#hl-417-110>110</a>
</span><span class=lnt id=hl-417-111><a class=lnlinks href=#hl-417-111>111</a>
</span><span class=lnt id=hl-417-112><a class=lnlinks href=#hl-417-112>112</a>
</span><span class=lnt id=hl-417-113><a class=lnlinks href=#hl-417-113>113</a>
</span><span class=lnt id=hl-417-114><a class=lnlinks href=#hl-417-114>114</a>
</span><span class=lnt id=hl-417-115><a class=lnlinks href=#hl-417-115>115</a>
</span><span class=lnt id=hl-417-116><a class=lnlinks href=#hl-417-116>116</a>
</span><span class=lnt id=hl-417-117><a class=lnlinks href=#hl-417-117>117</a>
</span><span class=lnt id=hl-417-118><a class=lnlinks href=#hl-417-118>118</a>
</span><span class=lnt id=hl-417-119><a class=lnlinks href=#hl-417-119>119</a>
</span><span class=lnt id=hl-417-120><a class=lnlinks href=#hl-417-120>120</a>
</span><span class=lnt id=hl-417-121><a class=lnlinks href=#hl-417-121>121</a>
</span><span class=lnt id=hl-417-122><a class=lnlinks href=#hl-417-122>122</a>
</span><span class=lnt id=hl-417-123><a class=lnlinks href=#hl-417-123>123</a>
</span><span class=lnt id=hl-417-124><a class=lnlinks href=#hl-417-124>124</a>
</span><span class=lnt id=hl-417-125><a class=lnlinks href=#hl-417-125>125</a>
</span><span class=lnt id=hl-417-126><a class=lnlinks href=#hl-417-126>126</a>
</span><span class=lnt id=hl-417-127><a class=lnlinks href=#hl-417-127>127</a>
</span><span class=lnt id=hl-417-128><a class=lnlinks href=#hl-417-128>128</a>
</span><span class=lnt id=hl-417-129><a class=lnlinks href=#hl-417-129>129</a>
</span><span class=lnt id=hl-417-130><a class=lnlinks href=#hl-417-130>130</a>
</span><span class=lnt id=hl-417-131><a class=lnlinks href=#hl-417-131>131</a>
</span><span class=lnt id=hl-417-132><a class=lnlinks href=#hl-417-132>132</a>
</span><span class=lnt id=hl-417-133><a class=lnlinks href=#hl-417-133>133</a>
</span><span class=lnt id=hl-417-134><a class=lnlinks href=#hl-417-134>134</a>
</span><span class=lnt id=hl-417-135><a class=lnlinks href=#hl-417-135>135</a>
</span><span class=lnt id=hl-417-136><a class=lnlinks href=#hl-417-136>136</a>
</span><span class=lnt id=hl-417-137><a class=lnlinks href=#hl-417-137>137</a>
</span><span class=lnt id=hl-417-138><a class=lnlinks href=#hl-417-138>138</a>
</span><span class=lnt id=hl-417-139><a class=lnlinks href=#hl-417-139>139</a>
</span><span class=lnt id=hl-417-140><a class=lnlinks href=#hl-417-140>140</a>
</span><span class=lnt id=hl-417-141><a class=lnlinks href=#hl-417-141>141</a>
</span><span class=lnt id=hl-417-142><a class=lnlinks href=#hl-417-142>142</a>
</span><span class=lnt id=hl-417-143><a class=lnlinks href=#hl-417-143>143</a>
</span><span class=lnt id=hl-417-144><a class=lnlinks href=#hl-417-144>144</a>
</span><span class=lnt id=hl-417-145><a class=lnlinks href=#hl-417-145>145</a>
</span><span class=lnt id=hl-417-146><a class=lnlinks href=#hl-417-146>146</a>
</span><span class=lnt id=hl-417-147><a class=lnlinks href=#hl-417-147>147</a>
</span><span class=lnt id=hl-417-148><a class=lnlinks href=#hl-417-148>148</a>
</span><span class=lnt id=hl-417-149><a class=lnlinks href=#hl-417-149>149</a>
</span><span class=lnt id=hl-417-150><a class=lnlinks href=#hl-417-150>150</a>
</span><span class=lnt id=hl-417-151><a class=lnlinks href=#hl-417-151>151</a>
</span><span class=lnt id=hl-417-152><a class=lnlinks href=#hl-417-152>152</a>
</span><span class=lnt id=hl-417-153><a class=lnlinks href=#hl-417-153>153</a>
</span><span class=lnt id=hl-417-154><a class=lnlinks href=#hl-417-154>154</a>
</span><span class=lnt id=hl-417-155><a class=lnlinks href=#hl-417-155>155</a>
</span><span class=lnt id=hl-417-156><a class=lnlinks href=#hl-417-156>156</a>
</span><span class=lnt id=hl-417-157><a class=lnlinks href=#hl-417-157>157</a>
</span><span class=lnt id=hl-417-158><a class=lnlinks href=#hl-417-158>158</a>
</span><span class=lnt id=hl-417-159><a class=lnlinks href=#hl-417-159>159</a>
</span><span class=lnt id=hl-417-160><a class=lnlinks href=#hl-417-160>160</a>
</span><span class=lnt id=hl-417-161><a class=lnlinks href=#hl-417-161>161</a>
</span><span class=lnt id=hl-417-162><a class=lnlinks href=#hl-417-162>162</a>
</span><span class=lnt id=hl-417-163><a class=lnlinks href=#hl-417-163>163</a>
</span><span class=lnt id=hl-417-164><a class=lnlinks href=#hl-417-164>164</a>
</span><span class=lnt id=hl-417-165><a class=lnlinks href=#hl-417-165>165</a>
</span><span class=lnt id=hl-417-166><a class=lnlinks href=#hl-417-166>166</a>
</span><span class=lnt id=hl-417-167><a class=lnlinks href=#hl-417-167>167</a>
</span><span class=lnt id=hl-417-168><a class=lnlinks href=#hl-417-168>168</a>
</span><span class=lnt id=hl-417-169><a class=lnlinks href=#hl-417-169>169</a>
</span><span class=lnt id=hl-417-170><a class=lnlinks href=#hl-417-170>170</a>
</span><span class=lnt id=hl-417-171><a class=lnlinks href=#hl-417-171>171</a>
</span><span class=lnt id=hl-417-172><a class=lnlinks href=#hl-417-172>172</a>
</span><span class=lnt id=hl-417-173><a class=lnlinks href=#hl-417-173>173</a>
</span><span class=lnt id=hl-417-174><a class=lnlinks href=#hl-417-174>174</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Sync ç»§æ‰¿è‡ª AQS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>7316153563782823691L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åŠ é”å®ç°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é¦–å…ˆç”¨ cas å°è¯•ï¼ˆä»…å°è¯•ä¸€æ¬¡ï¼‰å°† state ä» 0 æ”¹ä¸º 1, å¦‚æœæˆåŠŸè¡¨ç¤ºè·å¾—äº†ç‹¬å é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœå°è¯•å¤±è´¥ï¼Œè¿›å…¥ ãˆ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acquire</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ãˆ¡ tryAcquire </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å½“ tryAcquire è¿”å›ä¸º false æ—¶, å…ˆè°ƒç”¨ addWaiter ãˆ£, æ¥ç€ acquireQueued ãˆ¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>EXCLUSIVE</span><span class=p>),</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¡ è¿›å…¥ ãˆ¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>nonfairTryAcquire</span><span class=p>(</span><span class=n>acquires</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¢ Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>nonfairTryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœè¿˜æ²¡æœ‰è·å¾—é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°è¯•ç”¨ cas è·å¾—, è¿™é‡Œä½“ç°äº†éå…¬å¹³æ€§: ä¸å»æ£€æŸ¥ AQS é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>acquires</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>current</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœå·²ç»è·å¾—äº†é”, çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// state++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>acquires</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=c1>// overflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum lock count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setState</span><span class=p>(</span><span class=n>nextc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å–å¤±è´¥, å›åˆ°è°ƒç”¨å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ£ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å°†å½“å‰nodeåŠ å…¥ç­‰å¾…é˜Ÿåˆ—æœ«å°¾ç­‰å¾…ï¼Œå¹¶è¿”å›å½“å‰node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=nf>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>mode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>(),</span><span class=w> </span><span class=n>mode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//éå…¬å¹³åŒæ­¥å™¨ä¸­æœ‰headå’Œtailä¸¤ä¸ªå¼•ç”¨åˆ†åˆ«æŒ‡å‘äº†ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//predæŒ‡çš„æ˜¯nodeçš„å‰é©±ï¼Œä»é˜Ÿå°¾æ’å…¥ï¼Œæ‰€ä»¥predä¸ºtail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœ tail ä¸ä¸º null, è¯´æ˜å·²ç»æœ‰äº†ç­‰å¾…é˜Ÿåˆ—äº†ï¼Œcas å°è¯•å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pred</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//å°†nodeçš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºpred</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//å°è¯•å°†é˜Ÿåˆ—çš„tialä»å½“å‰çš„predä¿®æ”¹ä¸ºnode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetTail</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// åŒå‘é“¾è¡¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//å¦‚æœpredä¸ºnullï¼Œè¯´æ˜ç­‰å¾…é˜Ÿåˆ—è¿˜æœªåˆ›å»ºï¼Œè°ƒç”¨enqæ–¹æ³•åˆ›å»ºé˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°è¯•å°† Node åŠ å…¥ AQS, è¿›å…¥ ãˆ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enq</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¥ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//è¯¥æ–¹æ³•å°±æ˜¯åˆ›å»ºç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶å°†nodeæ’å…¥é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=nf>enq</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è¿˜æ²¡æœ‰, è®¾ç½® head ä¸ºå“¨å…µèŠ‚ç‚¹ï¼ˆä¸å¯¹åº”çº¿ç¨‹ï¼ŒçŠ¶æ€ä¸º 0ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetHead</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//å°†headèµ‹å€¼ç»™tailï¼Œheadå’ŒtailåŒæ—¶æŒ‡å‘å“¨å…µèŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// cas å°è¯•å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//è®¾ç½®nodeçš„å‰é©±èŠ‚ç‚¹ä¸ºé˜Ÿåˆ—çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//å°è¯•å°†é˜Ÿåˆ—çš„å°¾éƒ¨ä»å½“å‰çš„tailè®¾ç½®ä¸ºnode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetTail</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//å°†nodeè®¾ä¸ºä¸Šä¸€ä¸ªtailçš„åç»§èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>t</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¤ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//åœ¨é˜Ÿåˆ—ä¸­å¾ªç¯ç­‰å¾…ï¼Œåªæœ‰å½“æ’é˜Ÿæ’åˆ°ç¬¬ä¸€åå¹¶ä¸”è·å¾—äº†é”æ‰èƒ½å‡ºé˜Ÿå¹¶ä»æ–¹æ³•ä¸­é€€å‡ºã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//è¿”å›æ‰“æ–­çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>acquireQueued</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//æ‰¾åˆ°å½“å‰nodeçš„å‰é©±èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>predecessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ head, è¡¨ç¤ºè½®åˆ°è‡ªå·±ï¼ˆå½“å‰çº¿ç¨‹å¯¹åº”çš„ nodeï¼‰äº†, å°è¯•è·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// è·å–æˆåŠŸ, è®¾ç½®è‡ªå·±ï¼ˆå½“å‰çº¿ç¨‹å¯¹åº”çš„ nodeï¼‰ä¸º head</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setHead</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ä¸Šä¸€ä¸ªèŠ‚ç‚¹ help GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// è¿”å›ä¸­æ–­æ ‡è®° false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>interrupted</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// åˆ¤æ–­æ˜¯å¦åº”å½“ park, è¿›å…¥ ãˆ¦</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// park ç­‰å¾…, æ­¤æ—¶ Node çš„çŠ¶æ€è¢«ç½®ä¸º Node.SIGNAL ãˆ§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>parkAndCheckInterrupt</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cancelAcquire</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¦ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//åˆ¤æ–­acquireå¤±è´¥ä»¥åæ˜¯å¦åº”è¯¥é˜»å¡ç­‰å¾…ã€‚ä»è§„åˆ™ä¸Šæ¥è®²ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//1.å¦‚æœå‰é©±èŠ‚ç‚¹éƒ½é˜»å¡äº†ï¼Œé‚£ä¹ˆå½“å‰èŠ‚ç‚¹ä¹Ÿåº”è¯¥é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//2.å¦‚æœå‰é©±èŠ‚ç‚¹å–æ¶ˆï¼Œé‚£ä¹ˆåº”è¯¥å°†å‰é©±èŠ‚ç‚¹å‰ç§»ï¼Œç›´åˆ°å…¶çŠ¶æ€ä¸ä¸ºå–æ¶ˆä¸ºæ­¢ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//3.å¦‚æœå‰ä¸¤ç§æƒ…å†µéƒ½ä¸æ˜¯ï¼Œå°è¯•å°†å‰é©±èŠ‚ç‚¹çŠ¶æ€è®¾ä¸ºSIGNALï¼Œè¿”å›falseï¼ˆä¸ç”¨é˜»å¡ï¼Œç­‰åˆ°ä¸‹æ¬¡åœ¨é˜»å¡ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å–ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ä¸Šä¸€ä¸ªèŠ‚ç‚¹éƒ½åœ¨é˜»å¡, é‚£ä¹ˆè‡ªå·±ä¹Ÿé˜»å¡å¥½äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// &gt; 0 è¡¨ç¤ºå–æ¶ˆçŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ä¸Šä¸€ä¸ªèŠ‚ç‚¹å–æ¶ˆ, é‚£ä¹ˆé‡æ„åˆ é™¤å‰é¢æ‰€æœ‰å–æ¶ˆçš„èŠ‚ç‚¹, è¿”å›åˆ°å¤–å±‚å¾ªç¯é‡è¯•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred</span><span class=p>.</span><span class=na>prev</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>pred</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è¿™æ¬¡è¿˜æ²¡æœ‰é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ä½†ä¸‹æ¬¡å¦‚æœé‡è¯•ä¸æˆåŠŸ, åˆ™éœ€è¦é˜»å¡ï¼Œè¿™æ—¶éœ€è¦è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¸º Node.SIGNAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span><span class=w> </span><span class=n>ws</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ§ é˜»å¡å½“å‰çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>parkAndCheckInterrupt</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong></p><p>æ˜¯å¦éœ€è¦ unpark æ˜¯ç”±å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„ waitStatus == Node.SIGNAL æ¥å†³å®šï¼Œè€Œä¸æ˜¯æœ¬èŠ‚ç‚¹çš„ waitStatus å†³å®š</p></blockquote><p>æ€»ç»“ï¼š</p><ul><li>è°ƒç”¨<code>lock</code>ï¼Œå°è¯•å°†stateä»0ä¿®æ”¹ä¸º1<ul><li>æˆåŠŸï¼šå°†ownerè®¾ä¸ºå½“å‰çº¿ç¨‹</li><li>å¤±è´¥ï¼šè°ƒç”¨<code>acquire</code>-><code>tryAcquire</code>-><code>nonfairTryAcquire</code>ï¼Œåˆ¤æ–­state=0åˆ™è·å¾—é”ï¼Œæˆ–è€…stateä¸ä¸º0ä½†å½“å‰çº¿ç¨‹æŒæœ‰é”åˆ™é‡å…¥é”ï¼Œä»¥ä¸Šä¸¤ç§æƒ…å†µ<code>tryAcquire</code>è¿”å›trueï¼Œå‰©ä½™æƒ…å†µè¿”å›falseã€‚<ul><li>trueï¼šè·å¾—é”</li><li>falseï¼šè°ƒç”¨<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code>,å…¶ä¸­<code>addwiter</code>å°†å…³è”çº¿ç¨‹çš„èŠ‚ç‚¹æ’å…¥AQSé˜Ÿåˆ—å°¾éƒ¨ï¼Œè¿›å…¥<code>acquireQueued</code>ä¸­çš„forå¾ªç¯:<ul><li>å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œå¹¶å°è¯•è·å¾—é”æˆåŠŸï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºå¤´èŠ‚ç‚¹ï¼Œæ¸…é™¤æ­¤èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿”å›æ‰“æ–­æ ‡è®°ã€‚</li><li>è°ƒç”¨<code>shoudParkAfterFailure</code>,ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›falseï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ”¹ä¸º-1ï¼Œç¬¬äºŒæ¬¡å¾ªç¯å¦‚æœå†è¿›å…¥æ­¤æ–¹æ³•ï¼Œä¼šè¿›å…¥é˜»å¡å¹¶æ£€æŸ¥æ‰“æ–­çš„æ–¹æ³•ã€‚</li></ul></li></ul></li></ul></li></ul><h5 id=è§£é”æºç ><a href=#%e8%a7%a3%e9%94%81%e6%ba%90%e7%a0%81 class=header-anchor>#</a>
è§£é”æºç </h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-418-1><a class=lnlinks href=#hl-418-1> 1</a>
</span><span class=lnt id=hl-418-2><a class=lnlinks href=#hl-418-2> 2</a>
</span><span class=lnt id=hl-418-3><a class=lnlinks href=#hl-418-3> 3</a>
</span><span class=lnt id=hl-418-4><a class=lnlinks href=#hl-418-4> 4</a>
</span><span class=lnt id=hl-418-5><a class=lnlinks href=#hl-418-5> 5</a>
</span><span class=lnt id=hl-418-6><a class=lnlinks href=#hl-418-6> 6</a>
</span><span class=lnt id=hl-418-7><a class=lnlinks href=#hl-418-7> 7</a>
</span><span class=lnt id=hl-418-8><a class=lnlinks href=#hl-418-8> 8</a>
</span><span class=lnt id=hl-418-9><a class=lnlinks href=#hl-418-9> 9</a>
</span><span class=lnt id=hl-418-10><a class=lnlinks href=#hl-418-10>10</a>
</span><span class=lnt id=hl-418-11><a class=lnlinks href=#hl-418-11>11</a>
</span><span class=lnt id=hl-418-12><a class=lnlinks href=#hl-418-12>12</a>
</span><span class=lnt id=hl-418-13><a class=lnlinks href=#hl-418-13>13</a>
</span><span class=lnt id=hl-418-14><a class=lnlinks href=#hl-418-14>14</a>
</span><span class=lnt id=hl-418-15><a class=lnlinks href=#hl-418-15>15</a>
</span><span class=lnt id=hl-418-16><a class=lnlinks href=#hl-418-16>16</a>
</span><span class=lnt id=hl-418-17><a class=lnlinks href=#hl-418-17>17</a>
</span><span class=lnt id=hl-418-18><a class=lnlinks href=#hl-418-18>18</a>
</span><span class=lnt id=hl-418-19><a class=lnlinks href=#hl-418-19>19</a>
</span><span class=lnt id=hl-418-20><a class=lnlinks href=#hl-418-20>20</a>
</span><span class=lnt id=hl-418-21><a class=lnlinks href=#hl-418-21>21</a>
</span><span class=lnt id=hl-418-22><a class=lnlinks href=#hl-418-22>22</a>
</span><span class=lnt id=hl-418-23><a class=lnlinks href=#hl-418-23>23</a>
</span><span class=lnt id=hl-418-24><a class=lnlinks href=#hl-418-24>24</a>
</span><span class=lnt id=hl-418-25><a class=lnlinks href=#hl-418-25>25</a>
</span><span class=lnt id=hl-418-26><a class=lnlinks href=#hl-418-26>26</a>
</span><span class=lnt id=hl-418-27><a class=lnlinks href=#hl-418-27>27</a>
</span><span class=lnt id=hl-418-28><a class=lnlinks href=#hl-418-28>28</a>
</span><span class=lnt id=hl-418-29><a class=lnlinks href=#hl-418-29>29</a>
</span><span class=lnt id=hl-418-30><a class=lnlinks href=#hl-418-30>30</a>
</span><span class=lnt id=hl-418-31><a class=lnlinks href=#hl-418-31>31</a>
</span><span class=lnt id=hl-418-32><a class=lnlinks href=#hl-418-32>32</a>
</span><span class=lnt id=hl-418-33><a class=lnlinks href=#hl-418-33>33</a>
</span><span class=lnt id=hl-418-34><a class=lnlinks href=#hl-418-34>34</a>
</span><span class=lnt id=hl-418-35><a class=lnlinks href=#hl-418-35>35</a>
</span><span class=lnt id=hl-418-36><a class=lnlinks href=#hl-418-36>36</a>
</span><span class=lnt id=hl-418-37><a class=lnlinks href=#hl-418-37>37</a>
</span><span class=lnt id=hl-418-38><a class=lnlinks href=#hl-418-38>38</a>
</span><span class=lnt id=hl-418-39><a class=lnlinks href=#hl-418-39>39</a>
</span><span class=lnt id=hl-418-40><a class=lnlinks href=#hl-418-40>40</a>
</span><span class=lnt id=hl-418-41><a class=lnlinks href=#hl-418-41>41</a>
</span><span class=lnt id=hl-418-42><a class=lnlinks href=#hl-418-42>42</a>
</span><span class=lnt id=hl-418-43><a class=lnlinks href=#hl-418-43>43</a>
</span><span class=lnt id=hl-418-44><a class=lnlinks href=#hl-418-44>44</a>
</span><span class=lnt id=hl-418-45><a class=lnlinks href=#hl-418-45>45</a>
</span><span class=lnt id=hl-418-46><a class=lnlinks href=#hl-418-46>46</a>
</span><span class=lnt id=hl-418-47><a class=lnlinks href=#hl-418-47>47</a>
</span><span class=lnt id=hl-418-48><a class=lnlinks href=#hl-418-48>48</a>
</span><span class=lnt id=hl-418-49><a class=lnlinks href=#hl-418-49>49</a>
</span><span class=lnt id=hl-418-50><a class=lnlinks href=#hl-418-50>50</a>
</span><span class=lnt id=hl-418-51><a class=lnlinks href=#hl-418-51>51</a>
</span><span class=lnt id=hl-418-52><a class=lnlinks href=#hl-418-52>52</a>
</span><span class=lnt id=hl-418-53><a class=lnlinks href=#hl-418-53>53</a>
</span><span class=lnt id=hl-418-54><a class=lnlinks href=#hl-418-54>54</a>
</span><span class=lnt id=hl-418-55><a class=lnlinks href=#hl-418-55>55</a>
</span><span class=lnt id=hl-418-56><a class=lnlinks href=#hl-418-56>56</a>
</span><span class=lnt id=hl-418-57><a class=lnlinks href=#hl-418-57>57</a>
</span><span class=lnt id=hl-418-58><a class=lnlinks href=#hl-418-58>58</a>
</span><span class=lnt id=hl-418-59><a class=lnlinks href=#hl-418-59>59</a>
</span><span class=lnt id=hl-418-60><a class=lnlinks href=#hl-418-60>60</a>
</span><span class=lnt id=hl-418-61><a class=lnlinks href=#hl-418-61>61</a>
</span><span class=lnt id=hl-418-62><a class=lnlinks href=#hl-418-62>62</a>
</span><span class=lnt id=hl-418-63><a class=lnlinks href=#hl-418-63>63</a>
</span><span class=lnt id=hl-418-64><a class=lnlinks href=#hl-418-64>64</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Sync ç»§æ‰¿è‡ª AQS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è§£é”å®ç°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>release</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°è¯•é‡Šæ”¾é”, è¿›å…¥ ãˆ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryRelease</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// é˜Ÿåˆ—å¤´èŠ‚ç‚¹ unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// é˜Ÿåˆ—ä¸ä¸º null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// waitStatus == Node.SIGNAL æ‰éœ€è¦ unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// unpark AQS ä¸­ç­‰å¾…çš„çº¿ç¨‹, è¿›å…¥ ãˆ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ  Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryRelease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>releases</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// state--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>releases</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>free</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰é‡Šæ”¾æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>free</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setState</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>free</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¡ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unparkSuccessor</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœçŠ¶æ€ä¸º Node.SIGNAL å°è¯•é‡ç½®çŠ¶æ€ä¸º 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¸æˆåŠŸä¹Ÿå¯ä»¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>ws</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‰¾åˆ°éœ€è¦ unpark çš„èŠ‚ç‚¹, ä½†æœ¬èŠ‚ç‚¹ä» AQS é˜Ÿåˆ—ä¸­è„±ç¦», æ˜¯ç”±å”¤é†’èŠ‚ç‚¹å®Œæˆçš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¸è€ƒè™‘å·²å–æ¶ˆçš„èŠ‚ç‚¹, ä» AQS é˜Ÿåˆ—ä»åè‡³å‰æ‰¾åˆ°é˜Ÿåˆ—æœ€å‰é¢éœ€è¦ unpark çš„èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>prev</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>thread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“ï¼š</p><ul><li><code>unlock</code>-><code>syn.release</code>(1)-><code>tryRelease</code>(1),å¦‚æœå½“å‰çº¿ç¨‹å¹¶ä¸æŒæœ‰é”ï¼ŒæŠ›å¼‚å¸¸ã€‚stateå‡å»1,å¦‚æœä¹‹åstateä¸º0ï¼Œè§£é”æˆåŠŸï¼Œè¿”å›trueï¼›å¦‚æœä»å¤§äº0ï¼Œè¡¨ç¤ºè§£é”ä¸å®Œå…¨ï¼Œå½“å‰çº¿ç¨‹ä¾æ—§æŒæœ‰é”ï¼Œè¿”å›falseã€‚</li><li>è¿”å›trueï¼šæ£€æŸ¥AQSé˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€å›¾æ˜¯å¦ä¸º<code>SIGNAL</code>(æ„å‘³ç€æœ‰è´£ä»»å”¤é†’å…¶åè®°èŠ‚ç‚¹)ï¼Œå¦‚æœæœ‰ï¼Œè°ƒç”¨<code>unparkSuccessor</code>ã€‚<ul><li>å†<code>unparkSuccessor</code>ä¸­ï¼Œä¸è€ƒè™‘å·²å–æ¶ˆçš„èŠ‚ç‚¹, ä» AQS é˜Ÿåˆ—ä»åè‡³å‰æ‰¾åˆ°é˜Ÿåˆ—æœ€å‰é¢éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰ï¼Œå°†å…¶å”¤é†’ã€‚</li></ul></li><li>è¿”å›falseï¼š</li></ul><h3 id=å¯é‡å…¥åŸç†><a href=#%e5%8f%af%e9%87%8d%e5%85%a5%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
å¯é‡å…¥åŸç†</h3><p>å½“æŒæœ‰é”çš„çº¿ç¨‹å†æ¬¡å°è¯•è·å–é”æ—¶ï¼Œä¼šå°†stateçš„å€¼åŠ 1ï¼Œstateè¡¨ç¤ºé”çš„é‡å…¥é‡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-419-1><a class=lnlinks href=#hl-419-1> 1</a>
</span><span class=lnt id=hl-419-2><a class=lnlinks href=#hl-419-2> 2</a>
</span><span class=lnt id=hl-419-3><a class=lnlinks href=#hl-419-3> 3</a>
</span><span class=lnt id=hl-419-4><a class=lnlinks href=#hl-419-4> 4</a>
</span><span class=lnt id=hl-419-5><a class=lnlinks href=#hl-419-5> 5</a>
</span><span class=lnt id=hl-419-6><a class=lnlinks href=#hl-419-6> 6</a>
</span><span class=lnt id=hl-419-7><a class=lnlinks href=#hl-419-7> 7</a>
</span><span class=lnt id=hl-419-8><a class=lnlinks href=#hl-419-8> 8</a>
</span><span class=lnt id=hl-419-9><a class=lnlinks href=#hl-419-9> 9</a>
</span><span class=lnt id=hl-419-10><a class=lnlinks href=#hl-419-10>10</a>
</span><span class=lnt id=hl-419-11><a class=lnlinks href=#hl-419-11>11</a>
</span><span class=lnt id=hl-419-12><a class=lnlinks href=#hl-419-12>12</a>
</span><span class=lnt id=hl-419-13><a class=lnlinks href=#hl-419-13>13</a>
</span><span class=lnt id=hl-419-14><a class=lnlinks href=#hl-419-14>14</a>
</span><span class=lnt id=hl-419-15><a class=lnlinks href=#hl-419-15>15</a>
</span><span class=lnt id=hl-419-16><a class=lnlinks href=#hl-419-16>16</a>
</span><span class=lnt id=hl-419-17><a class=lnlinks href=#hl-419-17>17</a>
</span><span class=lnt id=hl-419-18><a class=lnlinks href=#hl-419-18>18</a>
</span><span class=lnt id=hl-419-19><a class=lnlinks href=#hl-419-19>19</a>
</span><span class=lnt id=hl-419-20><a class=lnlinks href=#hl-419-20>20</a>
</span><span class=lnt id=hl-419-21><a class=lnlinks href=#hl-419-21>21</a>
</span><span class=lnt id=hl-419-22><a class=lnlinks href=#hl-419-22>22</a>
</span><span class=lnt id=hl-419-23><a class=lnlinks href=#hl-419-23>23</a>
</span><span class=lnt id=hl-419-24><a class=lnlinks href=#hl-419-24>24</a>
</span><span class=lnt id=hl-419-25><a class=lnlinks href=#hl-419-25>25</a>
</span><span class=lnt id=hl-419-26><a class=lnlinks href=#hl-419-26>26</a>
</span><span class=lnt id=hl-419-27><a class=lnlinks href=#hl-419-27>27</a>
</span><span class=lnt id=hl-419-28><a class=lnlinks href=#hl-419-28>28</a>
</span><span class=lnt id=hl-419-29><a class=lnlinks href=#hl-419-29>29</a>
</span><span class=lnt id=hl-419-30><a class=lnlinks href=#hl-419-30>30</a>
</span><span class=lnt id=hl-419-31><a class=lnlinks href=#hl-419-31>31</a>
</span><span class=lnt id=hl-419-32><a class=lnlinks href=#hl-419-32>32</a>
</span><span class=lnt id=hl-419-33><a class=lnlinks href=#hl-419-33>33</a>
</span><span class=lnt id=hl-419-34><a class=lnlinks href=#hl-419-34>34</a>
</span><span class=lnt id=hl-419-35><a class=lnlinks href=#hl-419-35>35</a>
</span><span class=lnt id=hl-419-36><a class=lnlinks href=#hl-419-36>36</a>
</span><span class=lnt id=hl-419-37><a class=lnlinks href=#hl-419-37>37</a>
</span><span class=lnt id=hl-419-38><a class=lnlinks href=#hl-419-38>38</a>
</span><span class=lnt id=hl-419-39><a class=lnlinks href=#hl-419-39>39</a>
</span><span class=lnt id=hl-419-40><a class=lnlinks href=#hl-419-40>40</a>
</span><span class=lnt id=hl-419-41><a class=lnlinks href=#hl-419-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>nonfairTryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>acquires</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>current</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœå·²ç»è·å¾—äº†é”, çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// state++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>acquires</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=c1>// overflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum lock count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setState</span><span class=p>(</span><span class=n>nextc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryRelease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>releases</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// state-- </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>releases</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>free</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰é‡Šæ”¾æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>free</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setState</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>free</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=å¯æ‰“æ–­åŸç†><a href=#%e5%8f%af%e6%89%93%e6%96%ad%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
å¯æ‰“æ–­åŸç†</h3><p><strong>ä¸å¯æ‰“æ–­æ¨¡å¼</strong></p><p>åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œå³ä½¿å®ƒè¢«æ‰“æ–­ï¼Œä»ä¼šé©»ç•™åœ¨ AQS é˜Ÿåˆ—ä¸­ï¼Œå¹¶å°†æ‰“æ–­ä¿¡å·å­˜å‚¨åœ¨ä¸€ä¸ªinterruptå˜é‡ä¸­ã€‚ä¸€ç›´è¦ç­‰åˆ°è·å¾—é”åæ–¹èƒ½å¾—çŸ¥è‡ªå·±è¢«æ‰“æ–­äº†,å¹¶ä¸”è°ƒç”¨<code>selfInterrupt</code>æ–¹æ³•æ‰“æ–­è‡ªå·±ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-420-1><a class=lnlinks href=#hl-420-1> 1</a>
</span><span class=lnt id=hl-420-2><a class=lnlinks href=#hl-420-2> 2</a>
</span><span class=lnt id=hl-420-3><a class=lnlinks href=#hl-420-3> 3</a>
</span><span class=lnt id=hl-420-4><a class=lnlinks href=#hl-420-4> 4</a>
</span><span class=lnt id=hl-420-5><a class=lnlinks href=#hl-420-5> 5</a>
</span><span class=lnt id=hl-420-6><a class=lnlinks href=#hl-420-6> 6</a>
</span><span class=lnt id=hl-420-7><a class=lnlinks href=#hl-420-7> 7</a>
</span><span class=lnt id=hl-420-8><a class=lnlinks href=#hl-420-8> 8</a>
</span><span class=lnt id=hl-420-9><a class=lnlinks href=#hl-420-9> 9</a>
</span><span class=lnt id=hl-420-10><a class=lnlinks href=#hl-420-10>10</a>
</span><span class=lnt id=hl-420-11><a class=lnlinks href=#hl-420-11>11</a>
</span><span class=lnt id=hl-420-12><a class=lnlinks href=#hl-420-12>12</a>
</span><span class=lnt id=hl-420-13><a class=lnlinks href=#hl-420-13>13</a>
</span><span class=lnt id=hl-420-14><a class=lnlinks href=#hl-420-14>14</a>
</span><span class=lnt id=hl-420-15><a class=lnlinks href=#hl-420-15>15</a>
</span><span class=lnt id=hl-420-16><a class=lnlinks href=#hl-420-16>16</a>
</span><span class=lnt id=hl-420-17><a class=lnlinks href=#hl-420-17>17</a>
</span><span class=lnt id=hl-420-18><a class=lnlinks href=#hl-420-18>18</a>
</span><span class=lnt id=hl-420-19><a class=lnlinks href=#hl-420-19>19</a>
</span><span class=lnt id=hl-420-20><a class=lnlinks href=#hl-420-20>20</a>
</span><span class=lnt id=hl-420-21><a class=lnlinks href=#hl-420-21>21</a>
</span><span class=lnt id=hl-420-22><a class=lnlinks href=#hl-420-22>22</a>
</span><span class=lnt id=hl-420-23><a class=lnlinks href=#hl-420-23>23</a>
</span><span class=lnt id=hl-420-24><a class=lnlinks href=#hl-420-24>24</a>
</span><span class=lnt id=hl-420-25><a class=lnlinks href=#hl-420-25>25</a>
</span><span class=lnt id=hl-420-26><a class=lnlinks href=#hl-420-26>26</a>
</span><span class=lnt id=hl-420-27><a class=lnlinks href=#hl-420-27>27</a>
</span><span class=lnt id=hl-420-28><a class=lnlinks href=#hl-420-28>28</a>
</span><span class=lnt id=hl-420-29><a class=lnlinks href=#hl-420-29>29</a>
</span><span class=lnt id=hl-420-30><a class=lnlinks href=#hl-420-30>30</a>
</span><span class=lnt id=hl-420-31><a class=lnlinks href=#hl-420-31>31</a>
</span><span class=lnt id=hl-420-32><a class=lnlinks href=#hl-420-32>32</a>
</span><span class=lnt id=hl-420-33><a class=lnlinks href=#hl-420-33>33</a>
</span><span class=lnt id=hl-420-34><a class=lnlinks href=#hl-420-34>34</a>
</span><span class=lnt id=hl-420-35><a class=lnlinks href=#hl-420-35>35</a>
</span><span class=lnt id=hl-420-36><a class=lnlinks href=#hl-420-36>36</a>
</span><span class=lnt id=hl-420-37><a class=lnlinks href=#hl-420-37>37</a>
</span><span class=lnt id=hl-420-38><a class=lnlinks href=#hl-420-38>38</a>
</span><span class=lnt id=hl-420-39><a class=lnlinks href=#hl-420-39>39</a>
</span><span class=lnt id=hl-420-40><a class=lnlinks href=#hl-420-40>40</a>
</span><span class=lnt id=hl-420-41><a class=lnlinks href=#hl-420-41>41</a>
</span><span class=lnt id=hl-420-42><a class=lnlinks href=#hl-420-42>42</a>
</span><span class=lnt id=hl-420-43><a class=lnlinks href=#hl-420-43>43</a>
</span><span class=lnt id=hl-420-44><a class=lnlinks href=#hl-420-44>44</a>
</span><span class=lnt id=hl-420-45><a class=lnlinks href=#hl-420-45>45</a>
</span><span class=lnt id=hl-420-46><a class=lnlinks href=#hl-420-46>46</a>
</span><span class=lnt id=hl-420-47><a class=lnlinks href=#hl-420-47>47</a>
</span><span class=lnt id=hl-420-48><a class=lnlinks href=#hl-420-48>48</a>
</span><span class=lnt id=hl-420-49><a class=lnlinks href=#hl-420-49>49</a>
</span><span class=lnt id=hl-420-50><a class=lnlinks href=#hl-420-50>50</a>
</span><span class=lnt id=hl-420-51><a class=lnlinks href=#hl-420-51>51</a>
</span><span class=lnt id=hl-420-52><a class=lnlinks href=#hl-420-52>52</a>
</span><span class=lnt id=hl-420-53><a class=lnlinks href=#hl-420-53>53</a>
</span><span class=lnt id=hl-420-54><a class=lnlinks href=#hl-420-54>54</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Sync ç»§æ‰¿è‡ª AQS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>parkAndCheckInterrupt</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// interrupted ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>acquireQueued</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>predecessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setHead</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// è¿˜æ˜¯éœ€è¦è·å¾—é”å, æ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>interrupted</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>parkAndCheckInterrupt</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å¦‚æœæ˜¯å› ä¸º interrupt è¢«å”¤é†’, è¿”å›æ‰“æ–­çŠ¶æ€ä¸º true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cancelAcquire</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>EXCLUSIVE</span><span class=p>),</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœæ‰“æ–­çŠ¶æ€ä¸º true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å“åº”æ‰“æ–­æ ‡è®°ï¼Œæ‰“æ–­è‡ªå·±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>selfInterrupt</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>å¯æ‰“æ–­æ¨¡å¼</strong></p><p>æ­¤æ¨¡å¼ä¸‹å³ä½¿çº¿ç¨‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œä¸€æ—¦è¢«æ‰“æ–­ï¼Œå°±ä¼šç«‹åˆ»æŠ›å‡ºæ‰“æ–­å¼‚å¸¸ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-421-1><a class=lnlinks href=#hl-421-1> 1</a>
</span><span class=lnt id=hl-421-2><a class=lnlinks href=#hl-421-2> 2</a>
</span><span class=lnt id=hl-421-3><a class=lnlinks href=#hl-421-3> 3</a>
</span><span class=lnt id=hl-421-4><a class=lnlinks href=#hl-421-4> 4</a>
</span><span class=lnt id=hl-421-5><a class=lnlinks href=#hl-421-5> 5</a>
</span><span class=lnt id=hl-421-6><a class=lnlinks href=#hl-421-6> 6</a>
</span><span class=lnt id=hl-421-7><a class=lnlinks href=#hl-421-7> 7</a>
</span><span class=lnt id=hl-421-8><a class=lnlinks href=#hl-421-8> 8</a>
</span><span class=lnt id=hl-421-9><a class=lnlinks href=#hl-421-9> 9</a>
</span><span class=lnt id=hl-421-10><a class=lnlinks href=#hl-421-10>10</a>
</span><span class=lnt id=hl-421-11><a class=lnlinks href=#hl-421-11>11</a>
</span><span class=lnt id=hl-421-12><a class=lnlinks href=#hl-421-12>12</a>
</span><span class=lnt id=hl-421-13><a class=lnlinks href=#hl-421-13>13</a>
</span><span class=lnt id=hl-421-14><a class=lnlinks href=#hl-421-14>14</a>
</span><span class=lnt id=hl-421-15><a class=lnlinks href=#hl-421-15>15</a>
</span><span class=lnt id=hl-421-16><a class=lnlinks href=#hl-421-16>16</a>
</span><span class=lnt id=hl-421-17><a class=lnlinks href=#hl-421-17>17</a>
</span><span class=lnt id=hl-421-18><a class=lnlinks href=#hl-421-18>18</a>
</span><span class=lnt id=hl-421-19><a class=lnlinks href=#hl-421-19>19</a>
</span><span class=lnt id=hl-421-20><a class=lnlinks href=#hl-421-20>20</a>
</span><span class=lnt id=hl-421-21><a class=lnlinks href=#hl-421-21>21</a>
</span><span class=lnt id=hl-421-22><a class=lnlinks href=#hl-421-22>22</a>
</span><span class=lnt id=hl-421-23><a class=lnlinks href=#hl-421-23>23</a>
</span><span class=lnt id=hl-421-24><a class=lnlinks href=#hl-421-24>24</a>
</span><span class=lnt id=hl-421-25><a class=lnlinks href=#hl-421-25>25</a>
</span><span class=lnt id=hl-421-26><a class=lnlinks href=#hl-421-26>26</a>
</span><span class=lnt id=hl-421-27><a class=lnlinks href=#hl-421-27>27</a>
</span><span class=lnt id=hl-421-28><a class=lnlinks href=#hl-421-28>28</a>
</span><span class=lnt id=hl-421-29><a class=lnlinks href=#hl-421-29>29</a>
</span><span class=lnt id=hl-421-30><a class=lnlinks href=#hl-421-30>30</a>
</span><span class=lnt id=hl-421-31><a class=lnlinks href=#hl-421-31>31</a>
</span><span class=lnt id=hl-421-32><a class=lnlinks href=#hl-421-32>32</a>
</span><span class=lnt id=hl-421-33><a class=lnlinks href=#hl-421-33>33</a>
</span><span class=lnt id=hl-421-34><a class=lnlinks href=#hl-421-34>34</a>
</span><span class=lnt id=hl-421-35><a class=lnlinks href=#hl-421-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquireInterruptibly</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœæ²¡æœ‰è·å¾—åˆ°é”, è¿›å…¥ ãˆ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doAcquireInterruptibly</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ  å¯æ‰“æ–­çš„è·å–é”æµç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doAcquireInterruptibly</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>EXCLUSIVE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>predecessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setHead</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// help GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>parkAndCheckInterrupt</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// åœ¨ park è¿‡ç¨‹ä¸­å¦‚æœè¢« interrupt ä¼šè¿›å…¥æ­¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// è¿™æ—¶å€™æŠ›å‡ºå¼‚å¸¸, è€Œä¸ä¼šå†æ¬¡è¿›å…¥ for (;;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cancelAcquire</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=å…¬å¹³é”å®ç°åŸç†><a href=#%e5%85%ac%e5%b9%b3%e9%94%81%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
å…¬å¹³é”å®ç°åŸç†</h3><p>ç®€è€Œè¨€ä¹‹ï¼Œå…¬å¹³ä¸éå…¬å¹³çš„åŒºåˆ«åœ¨äºï¼Œå…¬å¹³é”ä¸­çš„tryAcquireæ–¹æ³•è¢«é‡å†™äº†ï¼Œæ–°æ¥çš„çº¿ç¨‹å³ä¾¿å¾—çŸ¥äº†é”çš„stateä¸º0ï¼Œä¹Ÿè¦å…ˆåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦è¿˜æœ‰çº¿ç¨‹ç­‰å¾…ï¼Œåªæœ‰å½“é˜Ÿåˆ—æ²¡æœ‰çº¿ç¨‹ç­‰å¾…å¼ï¼Œæ‰è·å¾—é”ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-422-1><a class=lnlinks href=#hl-422-1> 1</a>
</span><span class=lnt id=hl-422-2><a class=lnlinks href=#hl-422-2> 2</a>
</span><span class=lnt id=hl-422-3><a class=lnlinks href=#hl-422-3> 3</a>
</span><span class=lnt id=hl-422-4><a class=lnlinks href=#hl-422-4> 4</a>
</span><span class=lnt id=hl-422-5><a class=lnlinks href=#hl-422-5> 5</a>
</span><span class=lnt id=hl-422-6><a class=lnlinks href=#hl-422-6> 6</a>
</span><span class=lnt id=hl-422-7><a class=lnlinks href=#hl-422-7> 7</a>
</span><span class=lnt id=hl-422-8><a class=lnlinks href=#hl-422-8> 8</a>
</span><span class=lnt id=hl-422-9><a class=lnlinks href=#hl-422-9> 9</a>
</span><span class=lnt id=hl-422-10><a class=lnlinks href=#hl-422-10>10</a>
</span><span class=lnt id=hl-422-11><a class=lnlinks href=#hl-422-11>11</a>
</span><span class=lnt id=hl-422-12><a class=lnlinks href=#hl-422-12>12</a>
</span><span class=lnt id=hl-422-13><a class=lnlinks href=#hl-422-13>13</a>
</span><span class=lnt id=hl-422-14><a class=lnlinks href=#hl-422-14>14</a>
</span><span class=lnt id=hl-422-15><a class=lnlinks href=#hl-422-15>15</a>
</span><span class=lnt id=hl-422-16><a class=lnlinks href=#hl-422-16>16</a>
</span><span class=lnt id=hl-422-17><a class=lnlinks href=#hl-422-17>17</a>
</span><span class=lnt id=hl-422-18><a class=lnlinks href=#hl-422-18>18</a>
</span><span class=lnt id=hl-422-19><a class=lnlinks href=#hl-422-19>19</a>
</span><span class=lnt id=hl-422-20><a class=lnlinks href=#hl-422-20>20</a>
</span><span class=lnt id=hl-422-21><a class=lnlinks href=#hl-422-21>21</a>
</span><span class=lnt id=hl-422-22><a class=lnlinks href=#hl-422-22>22</a>
</span><span class=lnt id=hl-422-23><a class=lnlinks href=#hl-422-23>23</a>
</span><span class=lnt id=hl-422-24><a class=lnlinks href=#hl-422-24>24</a>
</span><span class=lnt id=hl-422-25><a class=lnlinks href=#hl-422-25>25</a>
</span><span class=lnt id=hl-422-26><a class=lnlinks href=#hl-422-26>26</a>
</span><span class=lnt id=hl-422-27><a class=lnlinks href=#hl-422-27>27</a>
</span><span class=lnt id=hl-422-28><a class=lnlinks href=#hl-422-28>28</a>
</span><span class=lnt id=hl-422-29><a class=lnlinks href=#hl-422-29>29</a>
</span><span class=lnt id=hl-422-30><a class=lnlinks href=#hl-422-30>30</a>
</span><span class=lnt id=hl-422-31><a class=lnlinks href=#hl-422-31>31</a>
</span><span class=lnt id=hl-422-32><a class=lnlinks href=#hl-422-32>32</a>
</span><span class=lnt id=hl-422-33><a class=lnlinks href=#hl-422-33>33</a>
</span><span class=lnt id=hl-422-34><a class=lnlinks href=#hl-422-34>34</a>
</span><span class=lnt id=hl-422-35><a class=lnlinks href=#hl-422-35>35</a>
</span><span class=lnt id=hl-422-36><a class=lnlinks href=#hl-422-36>36</a>
</span><span class=lnt id=hl-422-37><a class=lnlinks href=#hl-422-37>37</a>
</span><span class=lnt id=hl-422-38><a class=lnlinks href=#hl-422-38>38</a>
</span><span class=lnt id=hl-422-39><a class=lnlinks href=#hl-422-39>39</a>
</span><span class=lnt id=hl-422-40><a class=lnlinks href=#hl-422-40>40</a>
</span><span class=lnt id=hl-422-41><a class=lnlinks href=#hl-422-41>41</a>
</span><span class=lnt id=hl-422-42><a class=lnlinks href=#hl-422-42>42</a>
</span><span class=lnt id=hl-422-43><a class=lnlinks href=#hl-422-43>43</a>
</span><span class=lnt id=hl-422-44><a class=lnlinks href=#hl-422-44>44</a>
</span><span class=lnt id=hl-422-45><a class=lnlinks href=#hl-422-45>45</a>
</span><span class=lnt id=hl-422-46><a class=lnlinks href=#hl-422-46>46</a>
</span><span class=lnt id=hl-422-47><a class=lnlinks href=#hl-422-47>47</a>
</span><span class=lnt id=hl-422-48><a class=lnlinks href=#hl-422-48>48</a>
</span><span class=lnt id=hl-422-49><a class=lnlinks href=#hl-422-49>49</a>
</span><span class=lnt id=hl-422-50><a class=lnlinks href=#hl-422-50>50</a>
</span><span class=lnt id=hl-422-51><a class=lnlinks href=#hl-422-51>51</a>
</span><span class=lnt id=hl-422-52><a class=lnlinks href=#hl-422-52>52</a>
</span><span class=lnt id=hl-422-53><a class=lnlinks href=#hl-422-53>53</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>FairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>3000897897090466540L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>acquire</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>EXCLUSIVE</span><span class=p>),</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸éå…¬å¹³é”ä¸»è¦åŒºåˆ«åœ¨äº tryAcquire æ–¹æ³•çš„å®ç°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰æ‰å»ç«äº‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasQueuedPredecessors</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>acquires</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>current</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>acquires</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum lock count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setState</span><span class=p>(</span><span class=n>nextc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å­˜ç–‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>hasQueuedPredecessors</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// h != t æ—¶è¡¨ç¤ºé˜Ÿåˆ—ä¸­æœ‰ Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// (s = h.next) == null è¡¨ç¤ºé˜Ÿåˆ—ä¸­è¿˜æœ‰æ²¡æœ‰è€äºŒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æˆ–è€…é˜Ÿåˆ—ä¸­è€äºŒçº¿ç¨‹ä¸æ˜¯æ­¤çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>s</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=æ¡ä»¶å˜é‡å®ç°åŸç†><a href=#%e6%9d%a1%e4%bb%b6%e5%8f%98%e9%87%8f%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86 class=header-anchor>#</a>
æ¡ä»¶å˜é‡å®ç°åŸç†</h3><p>æ¯ä¸ªæ¡ä»¶å˜é‡å…¶å®å°±å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå…¶å®ç°ç±»æ˜¯ ConditionObject</p><h4 id=await-æµç¨‹><a href=#await-%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
await æµç¨‹</h4><p>å¼€å§‹ Thread-0 æŒæœ‰é”ï¼Œè°ƒç”¨ awaitï¼Œè¿›å…¥ ConditionObject çš„ addConditionWaiter æµç¨‹</p><p>åˆ›å»ºæ–°çš„ Node çŠ¶æ€ä¸º -2ï¼ˆNode.CONDITIONï¼‰ï¼Œå…³è” Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171543622.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171543622 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æ¥ä¸‹æ¥è¿›å…¥ AQS çš„ fullyRelease æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171600661.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171600661 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>unpark AQS é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç«äº‰é”ï¼Œå‡è®¾æ²¡æœ‰å…¶ä»–ç«äº‰çº¿ç¨‹ï¼Œé‚£ä¹ˆ Thread-1 ç«äº‰æˆåŠŸ</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171619415.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171619415 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>park é˜»å¡ Thread-0</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171637949.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171637949 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æ€»ç»“ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå…³è”å½“å‰çº¿ç¨‹ï¼Œå¹¶æ’å…¥åˆ°å½“å‰Conditioné˜Ÿåˆ—çš„å°¾éƒ¨</li><li>è°ƒç”¨<code>fullRelease</code>ï¼Œå®Œå…¨é‡Šæ”¾åŒæ­¥å™¨ä¸­çš„é”ï¼Œå¹¶è®°å½•å½“å‰çº¿ç¨‹çš„é”é‡å…¥æ•°</li><li>å”¤é†’(park)AQSé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹</li><li>è°ƒç”¨parkæ–¹æ³•ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ã€‚</li></ul><h4 id=signal-æµç¨‹><a href=#signal-%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
signal æµç¨‹</h4><p>å‡è®¾ Thread-1 è¦æ¥å”¤é†’ Thread-0</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171703144.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171703144 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>è¿›å…¥ ConditionObject çš„ doSignal æµç¨‹ï¼Œå–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Nodeï¼Œå³ Thread-0 æ‰€åœ¨ Node</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171727397.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171727397 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æ‰§è¡Œ transferForSignal æµç¨‹ï¼Œå°†è¯¥ Node åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨ï¼Œå°† Thread-0 çš„ waitStatus æ”¹ä¸º 0ï¼ŒThread-3 çš„ waitStatus æ”¹ä¸º -1</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314171749467.png width=900 height=600 loading=lazy decoding=async alt=image-20220314171749467 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>Thread-1 é‡Šæ”¾é”ï¼Œè¿›å…¥ unlock æµç¨‹ï¼Œç•¥</p><p>æ€»ç»“ï¼š</p><ul><li>å½“å‰æŒæœ‰é”çš„çº¿ç¨‹å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œè°ƒç”¨doSignalæˆ–doSignalAllæ–¹æ³•ï¼Œå°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªï¼ˆæˆ–å…¨éƒ¨ï¼‰èŠ‚ç‚¹æ’å…¥åˆ°AQSé˜Ÿåˆ—ä¸­çš„å°¾éƒ¨ã€‚</li><li>å°†æ’å…¥çš„èŠ‚ç‚¹çš„çŠ¶æ€ä»Conditionè®¾ç½®ä¸º0ï¼Œå°†æ’å…¥èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º-1ï¼ˆæ„å‘³ç€è¦æ‰¿æ‹…å”¤é†’åä¸€ä¸ªèŠ‚ç‚¹çš„è´£ä»»ï¼‰</li><li>å½“å‰çº¿ç¨‹é‡Šæ”¾é”ï¼ŒparkAQSé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çº¿ç¨‹ã€‚</li></ul><h4 id=æºç ><a href=#%e6%ba%90%e7%a0%81 class=header-anchor>#</a>
æºç </h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-423-1><a class=lnlinks href=#hl-423-1>  1</a>
</span><span class=lnt id=hl-423-2><a class=lnlinks href=#hl-423-2>  2</a>
</span><span class=lnt id=hl-423-3><a class=lnlinks href=#hl-423-3>  3</a>
</span><span class=lnt id=hl-423-4><a class=lnlinks href=#hl-423-4>  4</a>
</span><span class=lnt id=hl-423-5><a class=lnlinks href=#hl-423-5>  5</a>
</span><span class=lnt id=hl-423-6><a class=lnlinks href=#hl-423-6>  6</a>
</span><span class=lnt id=hl-423-7><a class=lnlinks href=#hl-423-7>  7</a>
</span><span class=lnt id=hl-423-8><a class=lnlinks href=#hl-423-8>  8</a>
</span><span class=lnt id=hl-423-9><a class=lnlinks href=#hl-423-9>  9</a>
</span><span class=lnt id=hl-423-10><a class=lnlinks href=#hl-423-10> 10</a>
</span><span class=lnt id=hl-423-11><a class=lnlinks href=#hl-423-11> 11</a>
</span><span class=lnt id=hl-423-12><a class=lnlinks href=#hl-423-12> 12</a>
</span><span class=lnt id=hl-423-13><a class=lnlinks href=#hl-423-13> 13</a>
</span><span class=lnt id=hl-423-14><a class=lnlinks href=#hl-423-14> 14</a>
</span><span class=lnt id=hl-423-15><a class=lnlinks href=#hl-423-15> 15</a>
</span><span class=lnt id=hl-423-16><a class=lnlinks href=#hl-423-16> 16</a>
</span><span class=lnt id=hl-423-17><a class=lnlinks href=#hl-423-17> 17</a>
</span><span class=lnt id=hl-423-18><a class=lnlinks href=#hl-423-18> 18</a>
</span><span class=lnt id=hl-423-19><a class=lnlinks href=#hl-423-19> 19</a>
</span><span class=lnt id=hl-423-20><a class=lnlinks href=#hl-423-20> 20</a>
</span><span class=lnt id=hl-423-21><a class=lnlinks href=#hl-423-21> 21</a>
</span><span class=lnt id=hl-423-22><a class=lnlinks href=#hl-423-22> 22</a>
</span><span class=lnt id=hl-423-23><a class=lnlinks href=#hl-423-23> 23</a>
</span><span class=lnt id=hl-423-24><a class=lnlinks href=#hl-423-24> 24</a>
</span><span class=lnt id=hl-423-25><a class=lnlinks href=#hl-423-25> 25</a>
</span><span class=lnt id=hl-423-26><a class=lnlinks href=#hl-423-26> 26</a>
</span><span class=lnt id=hl-423-27><a class=lnlinks href=#hl-423-27> 27</a>
</span><span class=lnt id=hl-423-28><a class=lnlinks href=#hl-423-28> 28</a>
</span><span class=lnt id=hl-423-29><a class=lnlinks href=#hl-423-29> 29</a>
</span><span class=lnt id=hl-423-30><a class=lnlinks href=#hl-423-30> 30</a>
</span><span class=lnt id=hl-423-31><a class=lnlinks href=#hl-423-31> 31</a>
</span><span class=lnt id=hl-423-32><a class=lnlinks href=#hl-423-32> 32</a>
</span><span class=lnt id=hl-423-33><a class=lnlinks href=#hl-423-33> 33</a>
</span><span class=lnt id=hl-423-34><a class=lnlinks href=#hl-423-34> 34</a>
</span><span class=lnt id=hl-423-35><a class=lnlinks href=#hl-423-35> 35</a>
</span><span class=lnt id=hl-423-36><a class=lnlinks href=#hl-423-36> 36</a>
</span><span class=lnt id=hl-423-37><a class=lnlinks href=#hl-423-37> 37</a>
</span><span class=lnt id=hl-423-38><a class=lnlinks href=#hl-423-38> 38</a>
</span><span class=lnt id=hl-423-39><a class=lnlinks href=#hl-423-39> 39</a>
</span><span class=lnt id=hl-423-40><a class=lnlinks href=#hl-423-40> 40</a>
</span><span class=lnt id=hl-423-41><a class=lnlinks href=#hl-423-41> 41</a>
</span><span class=lnt id=hl-423-42><a class=lnlinks href=#hl-423-42> 42</a>
</span><span class=lnt id=hl-423-43><a class=lnlinks href=#hl-423-43> 43</a>
</span><span class=lnt id=hl-423-44><a class=lnlinks href=#hl-423-44> 44</a>
</span><span class=lnt id=hl-423-45><a class=lnlinks href=#hl-423-45> 45</a>
</span><span class=lnt id=hl-423-46><a class=lnlinks href=#hl-423-46> 46</a>
</span><span class=lnt id=hl-423-47><a class=lnlinks href=#hl-423-47> 47</a>
</span><span class=lnt id=hl-423-48><a class=lnlinks href=#hl-423-48> 48</a>
</span><span class=lnt id=hl-423-49><a class=lnlinks href=#hl-423-49> 49</a>
</span><span class=lnt id=hl-423-50><a class=lnlinks href=#hl-423-50> 50</a>
</span><span class=lnt id=hl-423-51><a class=lnlinks href=#hl-423-51> 51</a>
</span><span class=lnt id=hl-423-52><a class=lnlinks href=#hl-423-52> 52</a>
</span><span class=lnt id=hl-423-53><a class=lnlinks href=#hl-423-53> 53</a>
</span><span class=lnt id=hl-423-54><a class=lnlinks href=#hl-423-54> 54</a>
</span><span class=lnt id=hl-423-55><a class=lnlinks href=#hl-423-55> 55</a>
</span><span class=lnt id=hl-423-56><a class=lnlinks href=#hl-423-56> 56</a>
</span><span class=lnt id=hl-423-57><a class=lnlinks href=#hl-423-57> 57</a>
</span><span class=lnt id=hl-423-58><a class=lnlinks href=#hl-423-58> 58</a>
</span><span class=lnt id=hl-423-59><a class=lnlinks href=#hl-423-59> 59</a>
</span><span class=lnt id=hl-423-60><a class=lnlinks href=#hl-423-60> 60</a>
</span><span class=lnt id=hl-423-61><a class=lnlinks href=#hl-423-61> 61</a>
</span><span class=lnt id=hl-423-62><a class=lnlinks href=#hl-423-62> 62</a>
</span><span class=lnt id=hl-423-63><a class=lnlinks href=#hl-423-63> 63</a>
</span><span class=lnt id=hl-423-64><a class=lnlinks href=#hl-423-64> 64</a>
</span><span class=lnt id=hl-423-65><a class=lnlinks href=#hl-423-65> 65</a>
</span><span class=lnt id=hl-423-66><a class=lnlinks href=#hl-423-66> 66</a>
</span><span class=lnt id=hl-423-67><a class=lnlinks href=#hl-423-67> 67</a>
</span><span class=lnt id=hl-423-68><a class=lnlinks href=#hl-423-68> 68</a>
</span><span class=lnt id=hl-423-69><a class=lnlinks href=#hl-423-69> 69</a>
</span><span class=lnt id=hl-423-70><a class=lnlinks href=#hl-423-70> 70</a>
</span><span class=lnt id=hl-423-71><a class=lnlinks href=#hl-423-71> 71</a>
</span><span class=lnt id=hl-423-72><a class=lnlinks href=#hl-423-72> 72</a>
</span><span class=lnt id=hl-423-73><a class=lnlinks href=#hl-423-73> 73</a>
</span><span class=lnt id=hl-423-74><a class=lnlinks href=#hl-423-74> 74</a>
</span><span class=lnt id=hl-423-75><a class=lnlinks href=#hl-423-75> 75</a>
</span><span class=lnt id=hl-423-76><a class=lnlinks href=#hl-423-76> 76</a>
</span><span class=lnt id=hl-423-77><a class=lnlinks href=#hl-423-77> 77</a>
</span><span class=lnt id=hl-423-78><a class=lnlinks href=#hl-423-78> 78</a>
</span><span class=lnt id=hl-423-79><a class=lnlinks href=#hl-423-79> 79</a>
</span><span class=lnt id=hl-423-80><a class=lnlinks href=#hl-423-80> 80</a>
</span><span class=lnt id=hl-423-81><a class=lnlinks href=#hl-423-81> 81</a>
</span><span class=lnt id=hl-423-82><a class=lnlinks href=#hl-423-82> 82</a>
</span><span class=lnt id=hl-423-83><a class=lnlinks href=#hl-423-83> 83</a>
</span><span class=lnt id=hl-423-84><a class=lnlinks href=#hl-423-84> 84</a>
</span><span class=lnt id=hl-423-85><a class=lnlinks href=#hl-423-85> 85</a>
</span><span class=lnt id=hl-423-86><a class=lnlinks href=#hl-423-86> 86</a>
</span><span class=lnt id=hl-423-87><a class=lnlinks href=#hl-423-87> 87</a>
</span><span class=lnt id=hl-423-88><a class=lnlinks href=#hl-423-88> 88</a>
</span><span class=lnt id=hl-423-89><a class=lnlinks href=#hl-423-89> 89</a>
</span><span class=lnt id=hl-423-90><a class=lnlinks href=#hl-423-90> 90</a>
</span><span class=lnt id=hl-423-91><a class=lnlinks href=#hl-423-91> 91</a>
</span><span class=lnt id=hl-423-92><a class=lnlinks href=#hl-423-92> 92</a>
</span><span class=lnt id=hl-423-93><a class=lnlinks href=#hl-423-93> 93</a>
</span><span class=lnt id=hl-423-94><a class=lnlinks href=#hl-423-94> 94</a>
</span><span class=lnt id=hl-423-95><a class=lnlinks href=#hl-423-95> 95</a>
</span><span class=lnt id=hl-423-96><a class=lnlinks href=#hl-423-96> 96</a>
</span><span class=lnt id=hl-423-97><a class=lnlinks href=#hl-423-97> 97</a>
</span><span class=lnt id=hl-423-98><a class=lnlinks href=#hl-423-98> 98</a>
</span><span class=lnt id=hl-423-99><a class=lnlinks href=#hl-423-99> 99</a>
</span><span class=lnt id=hl-423-100><a class=lnlinks href=#hl-423-100>100</a>
</span><span class=lnt id=hl-423-101><a class=lnlinks href=#hl-423-101>101</a>
</span><span class=lnt id=hl-423-102><a class=lnlinks href=#hl-423-102>102</a>
</span><span class=lnt id=hl-423-103><a class=lnlinks href=#hl-423-103>103</a>
</span><span class=lnt id=hl-423-104><a class=lnlinks href=#hl-423-104>104</a>
</span><span class=lnt id=hl-423-105><a class=lnlinks href=#hl-423-105>105</a>
</span><span class=lnt id=hl-423-106><a class=lnlinks href=#hl-423-106>106</a>
</span><span class=lnt id=hl-423-107><a class=lnlinks href=#hl-423-107>107</a>
</span><span class=lnt id=hl-423-108><a class=lnlinks href=#hl-423-108>108</a>
</span><span class=lnt id=hl-423-109><a class=lnlinks href=#hl-423-109>109</a>
</span><span class=lnt id=hl-423-110><a class=lnlinks href=#hl-423-110>110</a>
</span><span class=lnt id=hl-423-111><a class=lnlinks href=#hl-423-111>111</a>
</span><span class=lnt id=hl-423-112><a class=lnlinks href=#hl-423-112>112</a>
</span><span class=lnt id=hl-423-113><a class=lnlinks href=#hl-423-113>113</a>
</span><span class=lnt id=hl-423-114><a class=lnlinks href=#hl-423-114>114</a>
</span><span class=lnt id=hl-423-115><a class=lnlinks href=#hl-423-115>115</a>
</span><span class=lnt id=hl-423-116><a class=lnlinks href=#hl-423-116>116</a>
</span><span class=lnt id=hl-423-117><a class=lnlinks href=#hl-423-117>117</a>
</span><span class=lnt id=hl-423-118><a class=lnlinks href=#hl-423-118>118</a>
</span><span class=lnt id=hl-423-119><a class=lnlinks href=#hl-423-119>119</a>
</span><span class=lnt id=hl-423-120><a class=lnlinks href=#hl-423-120>120</a>
</span><span class=lnt id=hl-423-121><a class=lnlinks href=#hl-423-121>121</a>
</span><span class=lnt id=hl-423-122><a class=lnlinks href=#hl-423-122>122</a>
</span><span class=lnt id=hl-423-123><a class=lnlinks href=#hl-423-123>123</a>
</span><span class=lnt id=hl-423-124><a class=lnlinks href=#hl-423-124>124</a>
</span><span class=lnt id=hl-423-125><a class=lnlinks href=#hl-423-125>125</a>
</span><span class=lnt id=hl-423-126><a class=lnlinks href=#hl-423-126>126</a>
</span><span class=lnt id=hl-423-127><a class=lnlinks href=#hl-423-127>127</a>
</span><span class=lnt id=hl-423-128><a class=lnlinks href=#hl-423-128>128</a>
</span><span class=lnt id=hl-423-129><a class=lnlinks href=#hl-423-129>129</a>
</span><span class=lnt id=hl-423-130><a class=lnlinks href=#hl-423-130>130</a>
</span><span class=lnt id=hl-423-131><a class=lnlinks href=#hl-423-131>131</a>
</span><span class=lnt id=hl-423-132><a class=lnlinks href=#hl-423-132>132</a>
</span><span class=lnt id=hl-423-133><a class=lnlinks href=#hl-423-133>133</a>
</span><span class=lnt id=hl-423-134><a class=lnlinks href=#hl-423-134>134</a>
</span><span class=lnt id=hl-423-135><a class=lnlinks href=#hl-423-135>135</a>
</span><span class=lnt id=hl-423-136><a class=lnlinks href=#hl-423-136>136</a>
</span><span class=lnt id=hl-423-137><a class=lnlinks href=#hl-423-137>137</a>
</span><span class=lnt id=hl-423-138><a class=lnlinks href=#hl-423-138>138</a>
</span><span class=lnt id=hl-423-139><a class=lnlinks href=#hl-423-139>139</a>
</span><span class=lnt id=hl-423-140><a class=lnlinks href=#hl-423-140>140</a>
</span><span class=lnt id=hl-423-141><a class=lnlinks href=#hl-423-141>141</a>
</span><span class=lnt id=hl-423-142><a class=lnlinks href=#hl-423-142>142</a>
</span><span class=lnt id=hl-423-143><a class=lnlinks href=#hl-423-143>143</a>
</span><span class=lnt id=hl-423-144><a class=lnlinks href=#hl-423-144>144</a>
</span><span class=lnt id=hl-423-145><a class=lnlinks href=#hl-423-145>145</a>
</span><span class=lnt id=hl-423-146><a class=lnlinks href=#hl-423-146>146</a>
</span><span class=lnt id=hl-423-147><a class=lnlinks href=#hl-423-147>147</a>
</span><span class=lnt id=hl-423-148><a class=lnlinks href=#hl-423-148>148</a>
</span><span class=lnt id=hl-423-149><a class=lnlinks href=#hl-423-149>149</a>
</span><span class=lnt id=hl-423-150><a class=lnlinks href=#hl-423-150>150</a>
</span><span class=lnt id=hl-423-151><a class=lnlinks href=#hl-423-151>151</a>
</span><span class=lnt id=hl-423-152><a class=lnlinks href=#hl-423-152>152</a>
</span><span class=lnt id=hl-423-153><a class=lnlinks href=#hl-423-153>153</a>
</span><span class=lnt id=hl-423-154><a class=lnlinks href=#hl-423-154>154</a>
</span><span class=lnt id=hl-423-155><a class=lnlinks href=#hl-423-155>155</a>
</span><span class=lnt id=hl-423-156><a class=lnlinks href=#hl-423-156>156</a>
</span><span class=lnt id=hl-423-157><a class=lnlinks href=#hl-423-157>157</a>
</span><span class=lnt id=hl-423-158><a class=lnlinks href=#hl-423-158>158</a>
</span><span class=lnt id=hl-423-159><a class=lnlinks href=#hl-423-159>159</a>
</span><span class=lnt id=hl-423-160><a class=lnlinks href=#hl-423-160>160</a>
</span><span class=lnt id=hl-423-161><a class=lnlinks href=#hl-423-161>161</a>
</span><span class=lnt id=hl-423-162><a class=lnlinks href=#hl-423-162>162</a>
</span><span class=lnt id=hl-423-163><a class=lnlinks href=#hl-423-163>163</a>
</span><span class=lnt id=hl-423-164><a class=lnlinks href=#hl-423-164>164</a>
</span><span class=lnt id=hl-423-165><a class=lnlinks href=#hl-423-165>165</a>
</span><span class=lnt id=hl-423-166><a class=lnlinks href=#hl-423-166>166</a>
</span><span class=lnt id=hl-423-167><a class=lnlinks href=#hl-423-167>167</a>
</span><span class=lnt id=hl-423-168><a class=lnlinks href=#hl-423-168>168</a>
</span><span class=lnt id=hl-423-169><a class=lnlinks href=#hl-423-169>169</a>
</span><span class=lnt id=hl-423-170><a class=lnlinks href=#hl-423-170>170</a>
</span><span class=lnt id=hl-423-171><a class=lnlinks href=#hl-423-171>171</a>
</span><span class=lnt id=hl-423-172><a class=lnlinks href=#hl-423-172>172</a>
</span><span class=lnt id=hl-423-173><a class=lnlinks href=#hl-423-173>173</a>
</span><span class=lnt id=hl-423-174><a class=lnlinks href=#hl-423-174>174</a>
</span><span class=lnt id=hl-423-175><a class=lnlinks href=#hl-423-175>175</a>
</span><span class=lnt id=hl-423-176><a class=lnlinks href=#hl-423-176>176</a>
</span><span class=lnt id=hl-423-177><a class=lnlinks href=#hl-423-177>177</a>
</span><span class=lnt id=hl-423-178><a class=lnlinks href=#hl-423-178>178</a>
</span><span class=lnt id=hl-423-179><a class=lnlinks href=#hl-423-179>179</a>
</span><span class=lnt id=hl-423-180><a class=lnlinks href=#hl-423-180>180</a>
</span><span class=lnt id=hl-423-181><a class=lnlinks href=#hl-423-181>181</a>
</span><span class=lnt id=hl-423-182><a class=lnlinks href=#hl-423-182>182</a>
</span><span class=lnt id=hl-423-183><a class=lnlinks href=#hl-423-183>183</a>
</span><span class=lnt id=hl-423-184><a class=lnlinks href=#hl-423-184>184</a>
</span><span class=lnt id=hl-423-185><a class=lnlinks href=#hl-423-185>185</a>
</span><span class=lnt id=hl-423-186><a class=lnlinks href=#hl-423-186>186</a>
</span><span class=lnt id=hl-423-187><a class=lnlinks href=#hl-423-187>187</a>
</span><span class=lnt id=hl-423-188><a class=lnlinks href=#hl-423-188>188</a>
</span><span class=lnt id=hl-423-189><a class=lnlinks href=#hl-423-189>189</a>
</span><span class=lnt id=hl-423-190><a class=lnlinks href=#hl-423-190>190</a>
</span><span class=lnt id=hl-423-191><a class=lnlinks href=#hl-423-191>191</a>
</span><span class=lnt id=hl-423-192><a class=lnlinks href=#hl-423-192>192</a>
</span><span class=lnt id=hl-423-193><a class=lnlinks href=#hl-423-193>193</a>
</span><span class=lnt id=hl-423-194><a class=lnlinks href=#hl-423-194>194</a>
</span><span class=lnt id=hl-423-195><a class=lnlinks href=#hl-423-195>195</a>
</span><span class=lnt id=hl-423-196><a class=lnlinks href=#hl-423-196>196</a>
</span><span class=lnt id=hl-423-197><a class=lnlinks href=#hl-423-197>197</a>
</span><span class=lnt id=hl-423-198><a class=lnlinks href=#hl-423-198>198</a>
</span><span class=lnt id=hl-423-199><a class=lnlinks href=#hl-423-199>199</a>
</span><span class=lnt id=hl-423-200><a class=lnlinks href=#hl-423-200>200</a>
</span><span class=lnt id=hl-423-201><a class=lnlinks href=#hl-423-201>201</a>
</span><span class=lnt id=hl-423-202><a class=lnlinks href=#hl-423-202>202</a>
</span><span class=lnt id=hl-423-203><a class=lnlinks href=#hl-423-203>203</a>
</span><span class=lnt id=hl-423-204><a class=lnlinks href=#hl-423-204>204</a>
</span><span class=lnt id=hl-423-205><a class=lnlinks href=#hl-423-205>205</a>
</span><span class=lnt id=hl-423-206><a class=lnlinks href=#hl-423-206>206</a>
</span><span class=lnt id=hl-423-207><a class=lnlinks href=#hl-423-207>207</a>
</span><span class=lnt id=hl-423-208><a class=lnlinks href=#hl-423-208>208</a>
</span><span class=lnt id=hl-423-209><a class=lnlinks href=#hl-423-209>209</a>
</span><span class=lnt id=hl-423-210><a class=lnlinks href=#hl-423-210>210</a>
</span><span class=lnt id=hl-423-211><a class=lnlinks href=#hl-423-211>211</a>
</span><span class=lnt id=hl-423-212><a class=lnlinks href=#hl-423-212>212</a>
</span><span class=lnt id=hl-423-213><a class=lnlinks href=#hl-423-213>213</a>
</span><span class=lnt id=hl-423-214><a class=lnlinks href=#hl-423-214>214</a>
</span><span class=lnt id=hl-423-215><a class=lnlinks href=#hl-423-215>215</a>
</span><span class=lnt id=hl-423-216><a class=lnlinks href=#hl-423-216>216</a>
</span><span class=lnt id=hl-423-217><a class=lnlinks href=#hl-423-217>217</a>
</span><span class=lnt id=hl-423-218><a class=lnlinks href=#hl-423-218>218</a>
</span><span class=lnt id=hl-423-219><a class=lnlinks href=#hl-423-219>219</a>
</span><span class=lnt id=hl-423-220><a class=lnlinks href=#hl-423-220>220</a>
</span><span class=lnt id=hl-423-221><a class=lnlinks href=#hl-423-221>221</a>
</span><span class=lnt id=hl-423-222><a class=lnlinks href=#hl-423-222>222</a>
</span><span class=lnt id=hl-423-223><a class=lnlinks href=#hl-423-223>223</a>
</span><span class=lnt id=hl-423-224><a class=lnlinks href=#hl-423-224>224</a>
</span><span class=lnt id=hl-423-225><a class=lnlinks href=#hl-423-225>225</a>
</span><span class=lnt id=hl-423-226><a class=lnlinks href=#hl-423-226>226</a>
</span><span class=lnt id=hl-423-227><a class=lnlinks href=#hl-423-227>227</a>
</span><span class=lnt id=hl-423-228><a class=lnlinks href=#hl-423-228>228</a>
</span><span class=lnt id=hl-423-229><a class=lnlinks href=#hl-423-229>229</a>
</span><span class=lnt id=hl-423-230><a class=lnlinks href=#hl-423-230>230</a>
</span><span class=lnt id=hl-423-231><a class=lnlinks href=#hl-423-231>231</a>
</span><span class=lnt id=hl-423-232><a class=lnlinks href=#hl-423-232>232</a>
</span><span class=lnt id=hl-423-233><a class=lnlinks href=#hl-423-233>233</a>
</span><span class=lnt id=hl-423-234><a class=lnlinks href=#hl-423-234>234</a>
</span><span class=lnt id=hl-423-235><a class=lnlinks href=#hl-423-235>235</a>
</span><span class=lnt id=hl-423-236><a class=lnlinks href=#hl-423-236>236</a>
</span><span class=lnt id=hl-423-237><a class=lnlinks href=#hl-423-237>237</a>
</span><span class=lnt id=hl-423-238><a class=lnlinks href=#hl-423-238>238</a>
</span><span class=lnt id=hl-423-239><a class=lnlinks href=#hl-423-239>239</a>
</span><span class=lnt id=hl-423-240><a class=lnlinks href=#hl-423-240>240</a>
</span><span class=lnt id=hl-423-241><a class=lnlinks href=#hl-423-241>241</a>
</span><span class=lnt id=hl-423-242><a class=lnlinks href=#hl-423-242>242</a>
</span><span class=lnt id=hl-423-243><a class=lnlinks href=#hl-423-243>243</a>
</span><span class=lnt id=hl-423-244><a class=lnlinks href=#hl-423-244>244</a>
</span><span class=lnt id=hl-423-245><a class=lnlinks href=#hl-423-245>245</a>
</span><span class=lnt id=hl-423-246><a class=lnlinks href=#hl-423-246>246</a>
</span><span class=lnt id=hl-423-247><a class=lnlinks href=#hl-423-247>247</a>
</span><span class=lnt id=hl-423-248><a class=lnlinks href=#hl-423-248>248</a>
</span><span class=lnt id=hl-423-249><a class=lnlinks href=#hl-423-249>249</a>
</span><span class=lnt id=hl-423-250><a class=lnlinks href=#hl-423-250>250</a>
</span><span class=lnt id=hl-423-251><a class=lnlinks href=#hl-423-251>251</a>
</span><span class=lnt id=hl-423-252><a class=lnlinks href=#hl-423-252>252</a>
</span><span class=lnt id=hl-423-253><a class=lnlinks href=#hl-423-253>253</a>
</span><span class=lnt id=hl-423-254><a class=lnlinks href=#hl-423-254>254</a>
</span><span class=lnt id=hl-423-255><a class=lnlinks href=#hl-423-255>255</a>
</span><span class=lnt id=hl-423-256><a class=lnlinks href=#hl-423-256>256</a>
</span><span class=lnt id=hl-423-257><a class=lnlinks href=#hl-423-257>257</a>
</span><span class=lnt id=hl-423-258><a class=lnlinks href=#hl-423-258>258</a>
</span><span class=lnt id=hl-423-259><a class=lnlinks href=#hl-423-259>259</a>
</span><span class=lnt id=hl-423-260><a class=lnlinks href=#hl-423-260>260</a>
</span><span class=lnt id=hl-423-261><a class=lnlinks href=#hl-423-261>261</a>
</span><span class=lnt id=hl-423-262><a class=lnlinks href=#hl-423-262>262</a>
</span><span class=lnt id=hl-423-263><a class=lnlinks href=#hl-423-263>263</a>
</span><span class=lnt id=hl-423-264><a class=lnlinks href=#hl-423-264>264</a>
</span><span class=lnt id=hl-423-265><a class=lnlinks href=#hl-423-265>265</a>
</span><span class=lnt id=hl-423-266><a class=lnlinks href=#hl-423-266>266</a>
</span><span class=lnt id=hl-423-267><a class=lnlinks href=#hl-423-267>267</a>
</span><span class=lnt id=hl-423-268><a class=lnlinks href=#hl-423-268>268</a>
</span><span class=lnt id=hl-423-269><a class=lnlinks href=#hl-423-269>269</a>
</span><span class=lnt id=hl-423-270><a class=lnlinks href=#hl-423-270>270</a>
</span><span class=lnt id=hl-423-271><a class=lnlinks href=#hl-423-271>271</a>
</span><span class=lnt id=hl-423-272><a class=lnlinks href=#hl-423-272>272</a>
</span><span class=lnt id=hl-423-273><a class=lnlinks href=#hl-423-273>273</a>
</span><span class=lnt id=hl-423-274><a class=lnlinks href=#hl-423-274>274</a>
</span><span class=lnt id=hl-423-275><a class=lnlinks href=#hl-423-275>275</a>
</span><span class=lnt id=hl-423-276><a class=lnlinks href=#hl-423-276>276</a>
</span><span class=lnt id=hl-423-277><a class=lnlinks href=#hl-423-277>277</a>
</span><span class=lnt id=hl-423-278><a class=lnlinks href=#hl-423-278>278</a>
</span><span class=lnt id=hl-423-279><a class=lnlinks href=#hl-423-279>279</a>
</span><span class=lnt id=hl-423-280><a class=lnlinks href=#hl-423-280>280</a>
</span><span class=lnt id=hl-423-281><a class=lnlinks href=#hl-423-281>281</a>
</span><span class=lnt id=hl-423-282><a class=lnlinks href=#hl-423-282>282</a>
</span><span class=lnt id=hl-423-283><a class=lnlinks href=#hl-423-283>283</a>
</span><span class=lnt id=hl-423-284><a class=lnlinks href=#hl-423-284>284</a>
</span><span class=lnt id=hl-423-285><a class=lnlinks href=#hl-423-285>285</a>
</span><span class=lnt id=hl-423-286><a class=lnlinks href=#hl-423-286>286</a>
</span><span class=lnt id=hl-423-287><a class=lnlinks href=#hl-423-287>287</a>
</span><span class=lnt id=hl-423-288><a class=lnlinks href=#hl-423-288>288</a>
</span><span class=lnt id=hl-423-289><a class=lnlinks href=#hl-423-289>289</a>
</span><span class=lnt id=hl-423-290><a class=lnlinks href=#hl-423-290>290</a>
</span><span class=lnt id=hl-423-291><a class=lnlinks href=#hl-423-291>291</a>
</span><span class=lnt id=hl-423-292><a class=lnlinks href=#hl-423-292>292</a>
</span><span class=lnt id=hl-423-293><a class=lnlinks href=#hl-423-293>293</a>
</span><span class=lnt id=hl-423-294><a class=lnlinks href=#hl-423-294>294</a>
</span><span class=lnt id=hl-423-295><a class=lnlinks href=#hl-423-295>295</a>
</span><span class=lnt id=hl-423-296><a class=lnlinks href=#hl-423-296>296</a>
</span><span class=lnt id=hl-423-297><a class=lnlinks href=#hl-423-297>297</a>
</span><span class=lnt id=hl-423-298><a class=lnlinks href=#hl-423-298>298</a>
</span><span class=lnt id=hl-423-299><a class=lnlinks href=#hl-423-299>299</a>
</span><span class=lnt id=hl-423-300><a class=lnlinks href=#hl-423-300>300</a>
</span><span class=lnt id=hl-423-301><a class=lnlinks href=#hl-423-301>301</a>
</span><span class=lnt id=hl-423-302><a class=lnlinks href=#hl-423-302>302</a>
</span><span class=lnt id=hl-423-303><a class=lnlinks href=#hl-423-303>303</a>
</span><span class=lnt id=hl-423-304><a class=lnlinks href=#hl-423-304>304</a>
</span><span class=lnt id=hl-423-305><a class=lnlinks href=#hl-423-305>305</a>
</span><span class=lnt id=hl-423-306><a class=lnlinks href=#hl-423-306>306</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ConditionObject</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Condition</span><span class=p>,</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1173984872572414699L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>transient</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æœ€åä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>transient</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>lastWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ConditionObject</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ  æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=nf>addConditionWaiter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unlinkCancelledWaiters</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åˆ›å»ºä¸€ä¸ªå…³è”å½“å‰çº¿ç¨‹çš„æ–° Node, æ·»åŠ è‡³é˜Ÿåˆ—å°¾éƒ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>(),</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>firstWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lastWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å”¤é†’ - å°†æ²¡å–æ¶ˆçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doSignal</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å·²ç»æ˜¯å°¾èŠ‚ç‚¹äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=n>firstWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lastWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ Node è½¬ç§»è‡³ AQS é˜Ÿåˆ—, ä¸æˆåŠŸä¸”è¿˜æœ‰èŠ‚ç‚¹åˆ™ç»§ç»­å¾ªç¯ ãˆ¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>transferForSignal</span><span class=p>(</span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// é˜Ÿåˆ—è¿˜æœ‰èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¤–éƒ¨ç±»æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¢ å¦‚æœèŠ‚ç‚¹çŠ¶æ€æ˜¯å–æ¶ˆ, è¿”å› false è¡¨ç¤ºè½¬ç§»å¤±è´¥, å¦åˆ™è½¬ç§»æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>transferForSignal</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœçŠ¶æ€å·²ç»ä¸æ˜¯ Node.CONDITION, è¯´æ˜è¢«å–æ¶ˆäº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>enq</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ä¸Šä¸€ä¸ªèŠ‚ç‚¹è¢«å–æ¶ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ws</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ä¸Šä¸€ä¸ªèŠ‚ç‚¹ä¸èƒ½è®¾ç½®çŠ¶æ€ä¸º Node.SIGNAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>ws</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// unpark å–æ¶ˆé˜»å¡, è®©çº¿ç¨‹é‡æ–°åŒæ­¥çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>unpark</span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>thread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å…¨éƒ¨å”¤é†’ - ç­‰å¾…é˜Ÿåˆ—çš„æ‰€æœ‰èŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doSignalAll</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lastWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>transferForSignal</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlinkCancelledWaiters</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…æ— éœ€è€ƒè™‘åŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>signal</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHeldExclusively</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doSignal</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å…¨éƒ¨å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignalAll å†…æ— éœ€è€ƒè™‘åŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>signalAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHeldExclusively</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doSignalAll</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸å¯æ‰“æ–­ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>awaitUninterruptibly</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addConditionWaiter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”, è§ ãˆ£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullyRelease</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnSyncQueue</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// park é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœè¢«æ‰“æ–­, ä»…è®¾ç½®æ‰“æ–­çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å”¤é†’å, å°è¯•ç«äº‰é”, å¦‚æœå¤±è´¥è¿›å…¥ AQS é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>savedState</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>interrupted</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doSignalAll</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lastWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>transferForSignal</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlinkCancelledWaiters</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…æ— éœ€è€ƒè™‘åŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>signal</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHeldExclusively</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doSignal</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å…¨éƒ¨å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignalAll å†…æ— éœ€è€ƒè™‘åŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>signalAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHeldExclusively</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doSignalAll</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸å¯æ‰“æ–­ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>awaitUninterruptibly</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addConditionWaiter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”, è§ ãˆ£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullyRelease</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnSyncQueue</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// park é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœè¢«æ‰“æ–­, ä»…è®¾ç½®æ‰“æ–­çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å”¤é†’å, å°è¯•ç«äº‰é”, å¦‚æœå¤±è´¥è¿›å…¥ AQS é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>savedState</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>interrupted</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¤–éƒ¨ç±»æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ£ å› ä¸ºæŸçº¿ç¨‹å¯èƒ½é‡å…¥ï¼Œéœ€è¦å°† state å…¨éƒ¨é‡Šæ”¾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>fullyRelease</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>release</span><span class=p>(</span><span class=n>savedState</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>savedState</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>node</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CANCELLED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶é‡æ–°è®¾ç½®æ‰“æ–­çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶æŠ›å‡ºå¼‚å¸¸</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>THROW_IE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ¤æ–­æ‰“æ–­æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>checkInterruptWhileWaiting</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>transferAfterCancelledWait</span><span class=p>(</span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>THROW_IE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¤ åº”ç”¨æ‰“æ–­æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>reportInterruptAfterWait</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>interruptMode</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interruptMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>THROW_IE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interruptMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>await</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addConditionWaiter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullyRelease</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnSyncQueue</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// park é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœè¢«æ‰“æ–­, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>checkInterruptWhileWaiting</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é€€å‡ºç­‰å¾…é˜Ÿåˆ—å, è¿˜éœ€è¦è·å¾— AQS é˜Ÿåˆ—çš„é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>savedState</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>interruptMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>THROW_IE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unlinkCancelledWaiters</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åº”ç”¨æ‰“æ–­æ¨¡å¼, è§ ãˆ¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interruptMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>reportInterruptAfterWait</span><span class=p>(</span><span class=n>interruptMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å‘Conditionä¸­çš„ç­‰å¾…é˜Ÿåˆ—ä¸­æ–°å¢èŠ‚ç‚¹ï¼Œå¹¶å°†æ­¤èŠ‚ç‚¹è¿”å›</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=nf>addConditionWaiter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If lastWaiter is cancelled, clean out.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unlinkCancelledWaiters</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastWaiter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>(),</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>firstWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lastWaiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥å™¨ä¸­çš„é˜Ÿåˆ—ä¸­ç­‰å¾…é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isOnSyncQueue</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>CONDITION</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>prev</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=c1>// If has successor, it must be on queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>         * node.prev can be non-null, but not yet on queue because
</span></span></span><span class=line><span class=cl><span class=cm>         * the CAS to place it on queue can fail. So we have to
</span></span></span><span class=line><span class=cl><span class=cm>         * traverse from tail to make sure it actually made it.  It
</span></span></span><span class=line><span class=cl><span class=cm>         * will always be near the tail in calls to this method, and
</span></span></span><span class=line><span class=cl><span class=cm>         * unless the CAS failed (which is unlikely), it will be
</span></span></span><span class=line><span class=cl><span class=cm>         * there, so we hardly ever traverse much.
</span></span></span><span class=line><span class=cl><span class=cm>         */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>findNodeFromTail</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>awaitNanos</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>nanosTimeout</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addConditionWaiter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>savedState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fullyRelease</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å¾—æœ€åæœŸé™</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>deadline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>nanosTimeout</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnSyncQueue</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å·²è¶…æ—¶, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nanosTimeout</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0L</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>transferAfterCancelledWait</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// park é˜»å¡ä¸€å®šæ—¶é—´, spinForTimeoutThreshold ä¸º 1000 ns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nanosTimeout</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>spinForTimeoutThreshold</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LockSupport</span><span class=p>.</span><span class=na>parkNanos</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>nanosTimeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœè¢«æ‰“æ–­, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>checkInterruptWhileWaiting</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>nanosTimeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>deadline</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é€€å‡ºç­‰å¾…é˜Ÿåˆ—å, è¿˜éœ€è¦è·å¾— AQS é˜Ÿåˆ—çš„é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>savedState</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>interruptMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>THROW_IE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>interruptMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>REINTERRUPT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>.</span><span class=na>nextWaiter</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unlinkCancelledWaiters</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åº”ç”¨æ‰“æ–­æ¨¡å¼, è§ ãˆ¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interruptMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>reportInterruptAfterWait</span><span class=p>(</span><span class=n>interruptMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>deadline</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶, é€»è¾‘ç±»ä¼¼äº awaitNanos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>awaitUntil</span><span class=p>(</span><span class=n>Date</span><span class=w> </span><span class=n>deadline</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶, é€»è¾‘ç±»ä¼¼äº awaitNanos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>await</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å·¥å…·æ–¹æ³• çœç•¥ ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=è¯»å†™é”><a href=#%e8%af%bb%e5%86%99%e9%94%81 class=header-anchor>#</a>
è¯»å†™é”</h2><h3 id=reentrantreadwritelock><a href=#reentrantreadwritelock class=header-anchor>#</a>
ReentrantReadWriteLock</h3><p>å½“è¯»æ“ä½œè¿œè¿œé«˜äºå†™æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ä½¿ç”¨<code>è¯»å†™é”</code>è®©<code>è¯»-è¯»</code>å¯ä»¥å¹¶å‘ï¼Œæé«˜æ€§èƒ½ã€‚ ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„<code>select ... from ... lock in share mode</code></p><p>æä¾›ä¸€ä¸ª<code>æ•°æ®å®¹å™¨ç±»</code>å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„ write() æ–¹æ³•</p><p>æµ‹è¯•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-424-1><a class=lnlinks href=#hl-424-1> 1</a>
</span><span class=lnt id=hl-424-2><a class=lnlinks href=#hl-424-2> 2</a>
</span><span class=lnt id=hl-424-3><a class=lnlinks href=#hl-424-3> 3</a>
</span><span class=lnt id=hl-424-4><a class=lnlinks href=#hl-424-4> 4</a>
</span><span class=lnt id=hl-424-5><a class=lnlinks href=#hl-424-5> 5</a>
</span><span class=lnt id=hl-424-6><a class=lnlinks href=#hl-424-6> 6</a>
</span><span class=lnt id=hl-424-7><a class=lnlinks href=#hl-424-7> 7</a>
</span><span class=lnt id=hl-424-8><a class=lnlinks href=#hl-424-8> 8</a>
</span><span class=lnt id=hl-424-9><a class=lnlinks href=#hl-424-9> 9</a>
</span><span class=lnt id=hl-424-10><a class=lnlinks href=#hl-424-10>10</a>
</span><span class=lnt id=hl-424-11><a class=lnlinks href=#hl-424-11>11</a>
</span><span class=lnt id=hl-424-12><a class=lnlinks href=#hl-424-12>12</a>
</span><span class=lnt id=hl-424-13><a class=lnlinks href=#hl-424-13>13</a>
</span><span class=lnt id=hl-424-14><a class=lnlinks href=#hl-424-14>14</a>
</span><span class=lnt id=hl-424-15><a class=lnlinks href=#hl-424-15>15</a>
</span><span class=lnt id=hl-424-16><a class=lnlinks href=#hl-424-16>16</a>
</span><span class=lnt id=hl-424-17><a class=lnlinks href=#hl-424-17>17</a>
</span><span class=lnt id=hl-424-18><a class=lnlinks href=#hl-424-18>18</a>
</span><span class=lnt id=hl-424-19><a class=lnlinks href=#hl-424-19>19</a>
</span><span class=lnt id=hl-424-20><a class=lnlinks href=#hl-424-20>20</a>
</span><span class=lnt id=hl-424-21><a class=lnlinks href=#hl-424-21>21</a>
</span><span class=lnt id=hl-424-22><a class=lnlinks href=#hl-424-22>22</a>
</span><span class=lnt id=hl-424-23><a class=lnlinks href=#hl-424-23>23</a>
</span><span class=lnt id=hl-424-24><a class=lnlinks href=#hl-424-24>24</a>
</span><span class=lnt id=hl-424-25><a class=lnlinks href=#hl-424-25>25</a>
</span><span class=lnt id=hl-424-26><a class=lnlinks href=#hl-424-26>26</a>
</span><span class=lnt id=hl-424-27><a class=lnlinks href=#hl-424-27>27</a>
</span><span class=lnt id=hl-424-28><a class=lnlinks href=#hl-424-28>28</a>
</span><span class=lnt id=hl-424-29><a class=lnlinks href=#hl-424-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DataContainer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=w> </span><span class=n>rw</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>.</span><span class=na>ReadLock</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rw</span><span class=p>.</span><span class=na>readLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>.</span><span class=na>WriteLock</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rw</span><span class=p>.</span><span class=na>writeLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>read</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å–è¯»é”...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è¯»å–&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;é‡Šæ”¾è¯»é”...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>write</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;è·å–å†™é”...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>w</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;å†™å…¥&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;é‡Šæ”¾å†™é”...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>w</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•<code>è¯»é”-è¯»é”</code>å¯ä»¥å¹¶å‘</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-425-1><a class=lnlinks href=#hl-425-1>1</a>
</span><span class=lnt id=hl-425-2><a class=lnlinks href=#hl-425-2>2</a>
</span><span class=lnt id=hl-425-3><a class=lnlinks href=#hl-425-3>3</a>
</span><span class=lnt id=hl-425-4><a class=lnlinks href=#hl-425-4>4</a>
</span><span class=lnt id=hl-425-5><a class=lnlinks href=#hl-425-5>5</a>
</span><span class=lnt id=hl-425-6><a class=lnlinks href=#hl-425-6>6</a>
</span><span class=lnt id=hl-425-7><a class=lnlinks href=#hl-425-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DataContainer</span><span class=w> </span><span class=n>dataContainer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataContainer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºç»“æœï¼Œä»è¿™é‡Œå¯ä»¥çœ‹åˆ° Thread-0 é”å®šæœŸé—´ï¼ŒThread-1 çš„è¯»æ“ä½œä¸å—å½±å“</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-426-1><a class=lnlinks href=#hl-426-1>1</a>
</span><span class=lnt id=hl-426-2><a class=lnlinks href=#hl-426-2>2</a>
</span><span class=lnt id=hl-426-3><a class=lnlinks href=#hl-426-3>3</a>
</span><span class=lnt id=hl-426-4><a class=lnlinks href=#hl-426-4>4</a>
</span><span class=lnt id=hl-426-5><a class=lnlinks href=#hl-426-5>5</a>
</span><span class=lnt id=hl-426-6><a class=lnlinks href=#hl-426-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>14:05:14.341 c.DataContainer <span class=o>[</span>t2<span class=o>]</span> - è·å–è¯»é”... 
</span></span><span class=line><span class=cl>14:05:14.341 c.DataContainer <span class=o>[</span>t1<span class=o>]</span> - è·å–è¯»é”... 
</span></span><span class=line><span class=cl>14:05:14.345 c.DataContainer <span class=o>[</span>t1<span class=o>]</span> - è¯»å–
</span></span><span class=line><span class=cl>14:05:14.345 c.DataContainer <span class=o>[</span>t2<span class=o>]</span> - è¯»å–
</span></span><span class=line><span class=cl>14:05:15.365 c.DataContainer <span class=o>[</span>t2<span class=o>]</span> - é‡Šæ”¾è¯»é”... 
</span></span><span class=line><span class=cl>14:05:15.386 c.DataContainer <span class=o>[</span>t1<span class=o>]</span> - é‡Šæ”¾è¯»é”... 
</span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•<code>è¯»é”-å†™é”</code>ç›¸äº’é˜»å¡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-427-1><a class=lnlinks href=#hl-427-1>1</a>
</span><span class=lnt id=hl-427-2><a class=lnlinks href=#hl-427-2>2</a>
</span><span class=lnt id=hl-427-3><a class=lnlinks href=#hl-427-3>3</a>
</span><span class=lnt id=hl-427-4><a class=lnlinks href=#hl-427-4>4</a>
</span><span class=lnt id=hl-427-5><a class=lnlinks href=#hl-427-5>5</a>
</span><span class=lnt id=hl-427-6><a class=lnlinks href=#hl-427-6>6</a>
</span><span class=lnt id=hl-427-7><a class=lnlinks href=#hl-427-7>7</a>
</span><span class=lnt id=hl-427-8><a class=lnlinks href=#hl-427-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DataContainer</span><span class=w> </span><span class=n>dataContainer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataContainer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>write</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-428-1><a class=lnlinks href=#hl-428-1>1</a>
</span><span class=lnt id=hl-428-2><a class=lnlinks href=#hl-428-2>2</a>
</span><span class=lnt id=hl-428-3><a class=lnlinks href=#hl-428-3>3</a>
</span><span class=lnt id=hl-428-4><a class=lnlinks href=#hl-428-4>4</a>
</span><span class=lnt id=hl-428-5><a class=lnlinks href=#hl-428-5>5</a>
</span><span class=lnt id=hl-428-6><a class=lnlinks href=#hl-428-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>21</span><span class=p>.</span><span class=na>838</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>è·å–è¯»é”</span><span class=p>...</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>21</span><span class=p>.</span><span class=na>838</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t2</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>è·å–å†™é”</span><span class=p>...</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>21</span><span class=p>.</span><span class=na>841</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t2</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>å†™å…¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>22</span><span class=p>.</span><span class=na>843</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t2</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>é‡Šæ”¾å†™é”</span><span class=p>...</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>22</span><span class=p>.</span><span class=na>843</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>è¯»å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>14</span><span class=p>:</span><span class=n>04</span><span class=p>:</span><span class=n>23</span><span class=p>.</span><span class=na>843</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>DataContainer</span><span class=w> </span><span class=o>[</span><span class=n>t1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>é‡Šæ”¾è¯»é”</span><span class=p>...</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p><code>å†™é”-å†™é”</code>ä¹Ÿæ˜¯ç›¸äº’é˜»å¡çš„ï¼Œè¿™é‡Œå°±ä¸æµ‹è¯•äº†</p><p><strong>æ³¨æ„äº‹é¡¹</strong></p><ul><li>è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡</li><li>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒï¼šå³æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ï¼Œä¼šå¯¼è‡´è·å–å†™é”æ°¸ä¹…ç­‰å¾…</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-429-1><a class=lnlinks href=#hl-429-1> 1</a>
</span><span class=lnt id=hl-429-2><a class=lnlinks href=#hl-429-2> 2</a>
</span><span class=lnt id=hl-429-3><a class=lnlinks href=#hl-429-3> 3</a>
</span><span class=lnt id=hl-429-4><a class=lnlinks href=#hl-429-4> 4</a>
</span><span class=lnt id=hl-429-5><a class=lnlinks href=#hl-429-5> 5</a>
</span><span class=lnt id=hl-429-6><a class=lnlinks href=#hl-429-6> 6</a>
</span><span class=lnt id=hl-429-7><a class=lnlinks href=#hl-429-7> 7</a>
</span><span class=lnt id=hl-429-8><a class=lnlinks href=#hl-429-8> 8</a>
</span><span class=lnt id=hl-429-9><a class=lnlinks href=#hl-429-9> 9</a>
</span><span class=lnt id=hl-429-10><a class=lnlinks href=#hl-429-10>10</a>
</span><span class=lnt id=hl-429-11><a class=lnlinks href=#hl-429-11>11</a>
</span><span class=lnt id=hl-429-12><a class=lnlinks href=#hl-429-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>r</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>w</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>w</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>r</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>é‡å…¥æ—¶é™çº§æ”¯æŒï¼šå³æŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-430-1><a class=lnlinks href=#hl-430-1> 1</a>
</span><span class=lnt id=hl-430-2><a class=lnlinks href=#hl-430-2> 2</a>
</span><span class=lnt id=hl-430-3><a class=lnlinks href=#hl-430-3> 3</a>
</span><span class=lnt id=hl-430-4><a class=lnlinks href=#hl-430-4> 4</a>
</span><span class=lnt id=hl-430-5><a class=lnlinks href=#hl-430-5> 5</a>
</span><span class=lnt id=hl-430-6><a class=lnlinks href=#hl-430-6> 6</a>
</span><span class=lnt id=hl-430-7><a class=lnlinks href=#hl-430-7> 7</a>
</span><span class=lnt id=hl-430-8><a class=lnlinks href=#hl-430-8> 8</a>
</span><span class=lnt id=hl-430-9><a class=lnlinks href=#hl-430-9> 9</a>
</span><span class=lnt id=hl-430-10><a class=lnlinks href=#hl-430-10>10</a>
</span><span class=lnt id=hl-430-11><a class=lnlinks href=#hl-430-11>11</a>
</span><span class=lnt id=hl-430-12><a class=lnlinks href=#hl-430-12>12</a>
</span><span class=lnt id=hl-430-13><a class=lnlinks href=#hl-430-13>13</a>
</span><span class=lnt id=hl-430-14><a class=lnlinks href=#hl-430-14>14</a>
</span><span class=lnt id=hl-430-15><a class=lnlinks href=#hl-430-15>15</a>
</span><span class=lnt id=hl-430-16><a class=lnlinks href=#hl-430-16>16</a>
</span><span class=lnt id=hl-430-17><a class=lnlinks href=#hl-430-17>17</a>
</span><span class=lnt id=hl-430-18><a class=lnlinks href=#hl-430-18>18</a>
</span><span class=lnt id=hl-430-19><a class=lnlinks href=#hl-430-19>19</a>
</span><span class=lnt id=hl-430-20><a class=lnlinks href=#hl-430-20>20</a>
</span><span class=lnt id=hl-430-21><a class=lnlinks href=#hl-430-21>21</a>
</span><span class=lnt id=hl-430-22><a class=lnlinks href=#hl-430-22>22</a>
</span><span class=lnt id=hl-430-23><a class=lnlinks href=#hl-430-23>23</a>
</span><span class=lnt id=hl-430-24><a class=lnlinks href=#hl-430-24>24</a>
</span><span class=lnt id=hl-430-25><a class=lnlinks href=#hl-430-25>25</a>
</span><span class=lnt id=hl-430-26><a class=lnlinks href=#hl-430-26>26</a>
</span><span class=lnt id=hl-430-27><a class=lnlinks href=#hl-430-27>27</a>
</span><span class=lnt id=hl-430-28><a class=lnlinks href=#hl-430-28>28</a>
</span><span class=lnt id=hl-430-29><a class=lnlinks href=#hl-430-29>29</a>
</span><span class=lnt id=hl-430-30><a class=lnlinks href=#hl-430-30>30</a>
</span><span class=lnt id=hl-430-31><a class=lnlinks href=#hl-430-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>CachedData</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœå¤±æ•ˆï¼Œéœ€è¦é‡æ–°è®¡ç®— data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>cacheValid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=w> </span><span class=n>rwl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>processCachedData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>rwl</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cacheValid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è·å–å†™é”å‰å¿…é¡»é‡Šæ”¾è¯»é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rwl</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rwl</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// åˆ¤æ–­æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»è·å–äº†å†™é”ã€æ›´æ–°äº†ç¼“å­˜, é¿å…é‡å¤æ›´æ–°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cacheValid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>cacheValid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// é™çº§ä¸ºè¯»é”, é‡Šæ”¾å†™é”, è¿™æ ·èƒ½å¤Ÿè®©å…¶å®ƒçº¿ç¨‹è¯»å–ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>rwl</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>rwl</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è‡ªå·±ç”¨å®Œæ•°æ®, é‡Šæ”¾è¯»é” </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>use</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rwl</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=font-colorgreen-åº”ç”¨ä¹‹ç¼“å­˜font><a href=#font-colorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e7%bc%93%e5%ad%98font class=header-anchor>#</a>
<font color=green>* åº”ç”¨ä¹‹ç¼“å­˜</font></h3><h5 id=ç¼“å­˜æ›´æ–°ç­–ç•¥><a href=#%e7%bc%93%e5%ad%98%e6%9b%b4%e6%96%b0%e7%ad%96%e7%95%a5 class=header-anchor>#</a>
ç¼“å­˜æ›´æ–°ç­–ç•¥</h5><p>æ›´æ–°æ—¶ï¼Œæ˜¯å…ˆæ¸…ç¼“å­˜è¿˜æ˜¯å…ˆæ›´æ–°æ•°æ®åº“</p><p><strong>å…ˆæ¸…ç¼“å­˜</strong></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314184059810.png width=900 height=600 loading=lazy decoding=async alt=image-20220314184059810 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>å…ˆæ›´æ–°æ•°æ®åº“</strong></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314184117264.png width=900 height=600 loading=lazy decoding=async alt=image-20220314184117264 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>è¡¥å……ä¸€ç§æƒ…å†µï¼Œå‡è®¾æŸ¥è¯¢çº¿ç¨‹ A æŸ¥è¯¢æ•°æ®æ—¶æ°å¥½ç¼“å­˜æ•°æ®ç”±äºæ—¶é—´åˆ°æœŸå¤±æ•ˆï¼Œæˆ–æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è¯¢</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314184138172.png width=900 height=600 loading=lazy decoding=async alt=image-20220314184138172 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>è¿™ç§æƒ…å†µçš„å‡ºç°å‡ ç‡éå¸¸å°ï¼Œè§ facebook è®ºæ–‡</p><h5 id=è¯»å†™é”å®ç°ä¸€è‡´æ€§ç¼“å­˜><a href=#%e8%af%bb%e5%86%99%e9%94%81%e5%ae%9e%e7%8e%b0%e4%b8%80%e8%87%b4%e6%80%a7%e7%bc%93%e5%ad%98 class=header-anchor>#</a>
è¯»å†™é”å®ç°ä¸€è‡´æ€§ç¼“å­˜</h5><p>ä½¿ç”¨è¯»å†™é”å®ç°ä¸€ä¸ªç®€å•çš„æŒ‰éœ€åŠ è½½ç¼“å­˜</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-431-1><a class=lnlinks href=#hl-431-1> 1</a>
</span><span class=lnt id=hl-431-2><a class=lnlinks href=#hl-431-2> 2</a>
</span><span class=lnt id=hl-431-3><a class=lnlinks href=#hl-431-3> 3</a>
</span><span class=lnt id=hl-431-4><a class=lnlinks href=#hl-431-4> 4</a>
</span><span class=lnt id=hl-431-5><a class=lnlinks href=#hl-431-5> 5</a>
</span><span class=lnt id=hl-431-6><a class=lnlinks href=#hl-431-6> 6</a>
</span><span class=lnt id=hl-431-7><a class=lnlinks href=#hl-431-7> 7</a>
</span><span class=lnt id=hl-431-8><a class=lnlinks href=#hl-431-8> 8</a>
</span><span class=lnt id=hl-431-9><a class=lnlinks href=#hl-431-9> 9</a>
</span><span class=lnt id=hl-431-10><a class=lnlinks href=#hl-431-10>10</a>
</span><span class=lnt id=hl-431-11><a class=lnlinks href=#hl-431-11>11</a>
</span><span class=lnt id=hl-431-12><a class=lnlinks href=#hl-431-12>12</a>
</span><span class=lnt id=hl-431-13><a class=lnlinks href=#hl-431-13>13</a>
</span><span class=lnt id=hl-431-14><a class=lnlinks href=#hl-431-14>14</a>
</span><span class=lnt id=hl-431-15><a class=lnlinks href=#hl-431-15>15</a>
</span><span class=lnt id=hl-431-16><a class=lnlinks href=#hl-431-16>16</a>
</span><span class=lnt id=hl-431-17><a class=lnlinks href=#hl-431-17>17</a>
</span><span class=lnt id=hl-431-18><a class=lnlinks href=#hl-431-18>18</a>
</span><span class=lnt id=hl-431-19><a class=lnlinks href=#hl-431-19>19</a>
</span><span class=lnt id=hl-431-20><a class=lnlinks href=#hl-431-20>20</a>
</span><span class=lnt id=hl-431-21><a class=lnlinks href=#hl-431-21>21</a>
</span><span class=lnt id=hl-431-22><a class=lnlinks href=#hl-431-22>22</a>
</span><span class=lnt id=hl-431-23><a class=lnlinks href=#hl-431-23>23</a>
</span><span class=lnt id=hl-431-24><a class=lnlinks href=#hl-431-24>24</a>
</span><span class=lnt id=hl-431-25><a class=lnlinks href=#hl-431-25>25</a>
</span><span class=lnt id=hl-431-26><a class=lnlinks href=#hl-431-26>26</a>
</span><span class=lnt id=hl-431-27><a class=lnlinks href=#hl-431-27>27</a>
</span><span class=lnt id=hl-431-28><a class=lnlinks href=#hl-431-28>28</a>
</span><span class=lnt id=hl-431-29><a class=lnlinks href=#hl-431-29>29</a>
</span><span class=lnt id=hl-431-30><a class=lnlinks href=#hl-431-30>30</a>
</span><span class=lnt id=hl-431-31><a class=lnlinks href=#hl-431-31>31</a>
</span><span class=lnt id=hl-431-32><a class=lnlinks href=#hl-431-32>32</a>
</span><span class=lnt id=hl-431-33><a class=lnlinks href=#hl-431-33>33</a>
</span><span class=lnt id=hl-431-34><a class=lnlinks href=#hl-431-34>34</a>
</span><span class=lnt id=hl-431-35><a class=lnlinks href=#hl-431-35>35</a>
</span><span class=lnt id=hl-431-36><a class=lnlinks href=#hl-431-36>36</a>
</span><span class=lnt id=hl-431-37><a class=lnlinks href=#hl-431-37>37</a>
</span><span class=lnt id=hl-431-38><a class=lnlinks href=#hl-431-38>38</a>
</span><span class=lnt id=hl-431-39><a class=lnlinks href=#hl-431-39>39</a>
</span><span class=lnt id=hl-431-40><a class=lnlinks href=#hl-431-40>40</a>
</span><span class=lnt id=hl-431-41><a class=lnlinks href=#hl-431-41>41</a>
</span><span class=lnt id=hl-431-42><a class=lnlinks href=#hl-431-42>42</a>
</span><span class=lnt id=hl-431-43><a class=lnlinks href=#hl-431-43>43</a>
</span><span class=lnt id=hl-431-44><a class=lnlinks href=#hl-431-44>44</a>
</span><span class=lnt id=hl-431-45><a class=lnlinks href=#hl-431-45>45</a>
</span><span class=lnt id=hl-431-46><a class=lnlinks href=#hl-431-46>46</a>
</span><span class=lnt id=hl-431-47><a class=lnlinks href=#hl-431-47>47</a>
</span><span class=lnt id=hl-431-48><a class=lnlinks href=#hl-431-48>48</a>
</span><span class=lnt id=hl-431-49><a class=lnlinks href=#hl-431-49>49</a>
</span><span class=lnt id=hl-431-50><a class=lnlinks href=#hl-431-50>50</a>
</span><span class=lnt id=hl-431-51><a class=lnlinks href=#hl-431-51>51</a>
</span><span class=lnt id=hl-431-52><a class=lnlinks href=#hl-431-52>52</a>
</span><span class=lnt id=hl-431-53><a class=lnlinks href=#hl-431-53>53</a>
</span><span class=lnt id=hl-431-54><a class=lnlinks href=#hl-431-54>54</a>
</span><span class=lnt id=hl-431-55><a class=lnlinks href=#hl-431-55>55</a>
</span><span class=lnt id=hl-431-56><a class=lnlinks href=#hl-431-56>56</a>
</span><span class=lnt id=hl-431-57><a class=lnlinks href=#hl-431-57>57</a>
</span><span class=lnt id=hl-431-58><a class=lnlinks href=#hl-431-58>58</a>
</span><span class=lnt id=hl-431-59><a class=lnlinks href=#hl-431-59>59</a>
</span><span class=lnt id=hl-431-60><a class=lnlinks href=#hl-431-60>60</a>
</span><span class=lnt id=hl-431-61><a class=lnlinks href=#hl-431-61>61</a>
</span><span class=lnt id=hl-431-62><a class=lnlinks href=#hl-431-62>62</a>
</span><span class=lnt id=hl-431-63><a class=lnlinks href=#hl-431-63>63</a>
</span><span class=lnt id=hl-431-64><a class=lnlinks href=#hl-431-64>64</a>
</span><span class=lnt id=hl-431-65><a class=lnlinks href=#hl-431-65>65</a>
</span><span class=lnt id=hl-431-66><a class=lnlinks href=#hl-431-66>66</a>
</span><span class=lnt id=hl-431-67><a class=lnlinks href=#hl-431-67>67</a>
</span><span class=lnt id=hl-431-68><a class=lnlinks href=#hl-431-68>68</a>
</span><span class=lnt id=hl-431-69><a class=lnlinks href=#hl-431-69>69</a>
</span><span class=lnt id=hl-431-70><a class=lnlinks href=#hl-431-70>70</a>
</span><span class=lnt id=hl-431-71><a class=lnlinks href=#hl-431-71>71</a>
</span><span class=lnt id=hl-431-72><a class=lnlinks href=#hl-431-72>72</a>
</span><span class=lnt id=hl-431-73><a class=lnlinks href=#hl-431-73>73</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>GenericCachedDao</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// HashMap ä½œä¸ºç¼“å­˜éçº¿ç¨‹å®‰å…¨, éœ€è¦ä¿æŠ¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>SqlPair</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ReentrantReadWriteLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GenericDao</span><span class=w> </span><span class=n>genericDao</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GenericDao</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>update</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SqlPair</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SqlPair</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŠ å†™é”, é˜²æ­¢å…¶å®ƒçº¿ç¨‹å¯¹ç¼“å­˜è¯»å–å’Œæ›´æ”¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>rows</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>genericDao</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>rows</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>queryOne</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>beanClass</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SqlPair</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SqlPair</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŠ è¯»é”, é˜²æ­¢å…¶å®ƒçº¿ç¨‹å¯¹ç¼“å­˜æ›´æ”¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>readLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŠ å†™é”, é˜²æ­¢å…¶å®ƒçº¿ç¨‹å¯¹ç¼“å­˜è¯»å–å’Œæ›´æ”¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// get æ–¹æ³•ä¸Šé¢éƒ¨åˆ†æ˜¯å¯èƒ½å¤šä¸ªçº¿ç¨‹è¿›æ¥çš„, å¯èƒ½å·²ç»å‘ç¼“å­˜å¡«å……äº†æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ä¸ºé˜²æ­¢é‡å¤æŸ¥è¯¢æ•°æ®åº“, å†æ¬¡éªŒè¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å¦‚æœæ²¡æœ‰, æŸ¥è¯¢æ•°æ®åº“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>genericDao</span><span class=p>.</span><span class=na>queryOne</span><span class=p>(</span><span class=n>beanClass</span><span class=p>,</span><span class=w> </span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>().</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä½œä¸º key ä¿è¯å…¶æ˜¯ä¸å¯å˜çš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>class</span> <span class=nc>SqlPair</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>params</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>SqlPair</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>sql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>params</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>equals</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>getClass</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=na>getClass</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>SqlPair</span><span class=w> </span><span class=n>sqlPair</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>SqlPair</span><span class=p>)</span><span class=w> </span><span class=n>o</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>sql</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>sqlPair</span><span class=p>.</span><span class=na>sql</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Arrays</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>params</span><span class=p>,</span><span class=w> </span><span class=n>sqlPair</span><span class=p>.</span><span class=na>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hashCode</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Objects</span><span class=p>.</span><span class=na>hash</span><span class=p>(</span><span class=n>sql</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>31</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>hashCode</span><span class=p>(</span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong></p><ul><li><p>ä»¥ä¸Šå®ç°ä½“ç°çš„æ˜¯è¯»å†™é”çš„åº”ç”¨ï¼Œä¿è¯ç¼“å­˜å’Œæ•°æ®åº“çš„ä¸€è‡´æ€§ï¼Œä½†æœ‰ä¸‹é¢çš„é—®é¢˜æ²¡æœ‰è€ƒè™‘</p><ul><li><p>é€‚åˆè¯»å¤šå†™å°‘ï¼Œå¦‚æœå†™æ“ä½œæ¯”è¾ƒé¢‘ç¹ï¼Œä»¥ä¸Šå®ç°æ€§èƒ½ä½</p></li><li><p>æ²¡æœ‰è€ƒè™‘ç¼“å­˜å®¹é‡</p></li><li><p>æ²¡æœ‰è€ƒè™‘ç¼“å­˜è¿‡æœŸ</p></li><li><p>åªé€‚åˆå•æœº</p></li><li><p>å¹¶å‘æ€§è¿˜æ˜¯ä½ï¼Œç›®å‰åªä¼šç”¨ä¸€æŠŠé”</p></li><li><p>æ›´æ–°æ–¹æ³•å¤ªè¿‡ç®€å•ç²—æš´ï¼Œæ¸…ç©ºäº†æ‰€æœ‰ keyï¼ˆè€ƒè™‘æŒ‰ç±»å‹åˆ†åŒºæˆ–é‡æ–°è®¾è®¡ keyï¼‰</p></li></ul></li><li><p>ä¹è§‚é”å®ç°ï¼šç”¨ CAS å»æ›´æ–°</p></li></ul></blockquote><h3 id=font-colorblue-è¯»å†™é”åŸç†font><a href=#font-colorblue-%e8%af%bb%e5%86%99%e9%94%81%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>* è¯»å†™é”åŸç†</font></h3><h4 id=å›¾è§£æµç¨‹><a href=#%e5%9b%be%e8%a7%a3%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
å›¾è§£æµç¨‹</h4><p>è¯»å†™é”ç”¨çš„æ˜¯åŒä¸€ä¸ª Sycn åŒæ­¥å™¨ï¼Œå› æ­¤ç­‰å¾…é˜Ÿåˆ—ã€state ç­‰ä¹Ÿæ˜¯åŒä¸€ä¸ª</p><p><strong>t1 w.lockï¼Œt2 r.lock</strong></p><p>1ï¼‰ t1 æˆåŠŸä¸Šé”ï¼Œæµç¨‹ä¸ ReentrantLock åŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒæ˜¯å†™é”çŠ¶æ€å äº† state çš„ä½ 16 ä½ï¼Œè€Œè¯»é” ä½¿ç”¨çš„æ˜¯ state çš„é«˜ 16 ä½</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191716969.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191716969 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>2ï¼‰t2 æ‰§è¡Œ r.lockï¼Œè¿™æ—¶è¿›å…¥è¯»é”çš„ sync.acquireShared(1) æµç¨‹ï¼Œé¦–å…ˆä¼šè¿›å…¥ tryAcquireShared æµç¨‹ã€‚å¦‚æœæœ‰å†™ é”å æ®ï¼Œé‚£ä¹ˆ tryAcquireShared è¿”å› -1 è¡¨ç¤ºå¤±è´¥</p><blockquote><p>tryAcquireShared è¿”å›å€¼è¡¨ç¤º</p><ul><li>-1 è¡¨ç¤ºå¤±è´¥</li><li>0 è¡¨ç¤ºæˆåŠŸï¼Œä½†åç»§èŠ‚ç‚¹ä¸ä¼šç»§ç»­å”¤é†’</li><li>æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œè€Œä¸”æ•°å€¼æ˜¯è¿˜æœ‰å‡ ä¸ªåç»§èŠ‚ç‚¹éœ€è¦å”¤é†’ï¼Œè¯»å†™é”è¿”å› 1</li></ul></blockquote><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191820931.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191820931 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>3ï¼‰è¿™æ—¶ä¼šè¿›å…¥ sync.doAcquireShared(1) æµç¨‹ï¼Œé¦–å…ˆä¹Ÿæ˜¯è°ƒç”¨ addWaiter æ·»åŠ èŠ‚ç‚¹ï¼Œä¸åŒä¹‹å¤„åœ¨äºèŠ‚ç‚¹è¢«è®¾ç½®ä¸º Node.SHARED æ¨¡å¼è€Œé Node.EXCLUSIVE æ¨¡å¼ï¼Œæ³¨æ„æ­¤æ—¶ t2 ä»å¤„äºæ´»è·ƒçŠ¶æ€</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191835250.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191835250 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>4ï¼‰t2 ä¼šçœ‹çœ‹è‡ªå·±çš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯è€äºŒï¼Œå¦‚æœæ˜¯ï¼Œè¿˜ä¼šå†æ¬¡è°ƒç”¨ tryAcquireShared(1) æ¥å°è¯•è·å–é”</p><p>5ï¼‰å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåœ¨ doAcquireShared å†… for (;;) å¾ªç¯ä¸€æ¬¡ï¼ŒæŠŠå‰é©±èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º -1ï¼Œå† for (;;) å¾ªç¯ä¸€ æ¬¡å°è¯• tryAcquireShared(1) å¦‚æœè¿˜ä¸æˆåŠŸï¼Œé‚£ä¹ˆåœ¨ parkAndCheckInterrupt() å¤„ park</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191859644.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191859644 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>t3 r.lockï¼Œt4 w.lock</strong></p><p>è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰ t3 åŠ è¯»é”å’Œ t4 åŠ å†™é”ï¼Œè¿™æœŸé—´ t1 ä»ç„¶æŒæœ‰é”ï¼Œå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191927467.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191927467 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><strong>t1 w.unlock</strong></p><p>è¿™æ—¶ä¼šèµ°åˆ°å†™é”çš„ sync.release(1) æµç¨‹ï¼Œè°ƒç”¨ sync.tryRelease(1) æˆåŠŸï¼Œå˜æˆä¸‹é¢çš„æ ·å­</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314191953466.png width=900 height=600 loading=lazy decoding=async alt=image-20220314191953466 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æ¥ä¸‹æ¥æ‰§è¡Œå”¤é†’æµç¨‹ sync.unparkSuccessorï¼Œå³è®©è€äºŒæ¢å¤è¿è¡Œï¼Œè¿™æ—¶ t2 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œ</p><p>è¿™å›å†æ¥ä¸€æ¬¡ for (;;) æ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192033493.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192033493 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>è¿™æ—¶ t2 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t2 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192048242.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192048242 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>äº‹æƒ…è¿˜æ²¡å®Œï¼Œåœ¨ setHeadAndPropagate æ–¹æ³•å†…è¿˜ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ sharedï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ doReleaseShared() å°† head çš„çŠ¶æ€ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œè¿™æ—¶ t3 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œ</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192104962.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192104962 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>è¿™å›å†æ¥ä¸€æ¬¡ for (;;) æ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192123102.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192123102 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>è¿™æ—¶ t3 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t3 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192145552.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192145552 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ shared äº†ï¼Œå› æ­¤ä¸ä¼šç»§ç»­å”¤é†’ t4 æ‰€åœ¨èŠ‚ç‚¹</p><p><strong>t2 r.unlockï¼Œt3 r.unlock</strong></p><p>t2 è¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œä½†ç”±äºè®¡æ•°è¿˜ä¸ä¸ºé›¶</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192222303.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192222303 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>t3 è¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œè¿™å›è®¡æ•°ä¸ºé›¶äº†ï¼Œè¿›å…¥ doReleaseShared() å°†å¤´èŠ‚ç‚¹ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œå³</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192239120.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192239120 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>ä¹‹å t4 åœ¨ acquireQueued ä¸­ parkAndCheckInterrupt å¤„æ¢å¤è¿è¡Œï¼Œå†æ¬¡ for (;;) è¿™æ¬¡è‡ªå·±æ˜¯è€äºŒï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»– ç«äº‰ï¼ŒtryAcquire(1) æˆåŠŸï¼Œä¿®æ”¹å¤´ç»“ç‚¹ï¼Œæµç¨‹ç»“æŸ</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220314192254698.png width=900 height=600 loading=lazy decoding=async alt=image-20220314192254698 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=æºç åˆ†æ><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 class=header-anchor>#</a>
æºç åˆ†æ</h4><h5 id=å†™é”ä¸Šé”æµç¨‹><a href=#%e5%86%99%e9%94%81%e4%b8%8a%e9%94%81%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
<strong>å†™é”ä¸Šé”æµç¨‹</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-432-1><a class=lnlinks href=#hl-432-1> 1</a>
</span><span class=lnt id=hl-432-2><a class=lnlinks href=#hl-432-2> 2</a>
</span><span class=lnt id=hl-432-3><a class=lnlinks href=#hl-432-3> 3</a>
</span><span class=lnt id=hl-432-4><a class=lnlinks href=#hl-432-4> 4</a>
</span><span class=lnt id=hl-432-5><a class=lnlinks href=#hl-432-5> 5</a>
</span><span class=lnt id=hl-432-6><a class=lnlinks href=#hl-432-6> 6</a>
</span><span class=lnt id=hl-432-7><a class=lnlinks href=#hl-432-7> 7</a>
</span><span class=lnt id=hl-432-8><a class=lnlinks href=#hl-432-8> 8</a>
</span><span class=lnt id=hl-432-9><a class=lnlinks href=#hl-432-9> 9</a>
</span><span class=lnt id=hl-432-10><a class=lnlinks href=#hl-432-10>10</a>
</span><span class=lnt id=hl-432-11><a class=lnlinks href=#hl-432-11>11</a>
</span><span class=lnt id=hl-432-12><a class=lnlinks href=#hl-432-12>12</a>
</span><span class=lnt id=hl-432-13><a class=lnlinks href=#hl-432-13>13</a>
</span><span class=lnt id=hl-432-14><a class=lnlinks href=#hl-432-14>14</a>
</span><span class=lnt id=hl-432-15><a class=lnlinks href=#hl-432-15>15</a>
</span><span class=lnt id=hl-432-16><a class=lnlinks href=#hl-432-16>16</a>
</span><span class=lnt id=hl-432-17><a class=lnlinks href=#hl-432-17>17</a>
</span><span class=lnt id=hl-432-18><a class=lnlinks href=#hl-432-18>18</a>
</span><span class=lnt id=hl-432-19><a class=lnlinks href=#hl-432-19>19</a>
</span><span class=lnt id=hl-432-20><a class=lnlinks href=#hl-432-20>20</a>
</span><span class=lnt id=hl-432-21><a class=lnlinks href=#hl-432-21>21</a>
</span><span class=lnt id=hl-432-22><a class=lnlinks href=#hl-432-22>22</a>
</span><span class=lnt id=hl-432-23><a class=lnlinks href=#hl-432-23>23</a>
</span><span class=lnt id=hl-432-24><a class=lnlinks href=#hl-432-24>24</a>
</span><span class=lnt id=hl-432-25><a class=lnlinks href=#hl-432-25>25</a>
</span><span class=lnt id=hl-432-26><a class=lnlinks href=#hl-432-26>26</a>
</span><span class=lnt id=hl-432-27><a class=lnlinks href=#hl-432-27>27</a>
</span><span class=lnt id=hl-432-28><a class=lnlinks href=#hl-432-28>28</a>
</span><span class=lnt id=hl-432-29><a class=lnlinks href=#hl-432-29>29</a>
</span><span class=lnt id=hl-432-30><a class=lnlinks href=#hl-432-30>30</a>
</span><span class=lnt id=hl-432-31><a class=lnlinks href=#hl-432-31>31</a>
</span><span class=lnt id=hl-432-32><a class=lnlinks href=#hl-432-32>32</a>
</span><span class=lnt id=hl-432-33><a class=lnlinks href=#hl-432-33>33</a>
</span><span class=lnt id=hl-432-34><a class=lnlinks href=#hl-432-34>34</a>
</span><span class=lnt id=hl-432-35><a class=lnlinks href=#hl-432-35>35</a>
</span><span class=lnt id=hl-432-36><a class=lnlinks href=#hl-432-36>36</a>
</span><span class=lnt id=hl-432-37><a class=lnlinks href=#hl-432-37>37</a>
</span><span class=lnt id=hl-432-38><a class=lnlinks href=#hl-432-38>38</a>
</span><span class=lnt id=hl-432-39><a class=lnlinks href=#hl-432-39>39</a>
</span><span class=lnt id=hl-432-40><a class=lnlinks href=#hl-432-40>40</a>
</span><span class=lnt id=hl-432-41><a class=lnlinks href=#hl-432-41>41</a>
</span><span class=lnt id=hl-432-42><a class=lnlinks href=#hl-432-42>42</a>
</span><span class=lnt id=hl-432-43><a class=lnlinks href=#hl-432-43>43</a>
</span><span class=lnt id=hl-432-44><a class=lnlinks href=#hl-432-44>44</a>
</span><span class=lnt id=hl-432-45><a class=lnlinks href=#hl-432-45>45</a>
</span><span class=lnt id=hl-432-46><a class=lnlinks href=#hl-432-46>46</a>
</span><span class=lnt id=hl-432-47><a class=lnlinks href=#hl-432-47>47</a>
</span><span class=lnt id=hl-432-48><a class=lnlinks href=#hl-432-48>48</a>
</span><span class=lnt id=hl-432-49><a class=lnlinks href=#hl-432-49>49</a>
</span><span class=lnt id=hl-432-50><a class=lnlinks href=#hl-432-50>50</a>
</span><span class=lnt id=hl-432-51><a class=lnlinks href=#hl-432-51>51</a>
</span><span class=lnt id=hl-432-52><a class=lnlinks href=#hl-432-52>52</a>
</span><span class=lnt id=hl-432-53><a class=lnlinks href=#hl-432-53>53</a>
</span><span class=lnt id=hl-432-54><a class=lnlinks href=#hl-432-54>54</a>
</span><span class=lnt id=hl-432-55><a class=lnlinks href=#hl-432-55>55</a>
</span><span class=lnt id=hl-432-56><a class=lnlinks href=#hl-432-56>56</a>
</span><span class=lnt id=hl-432-57><a class=lnlinks href=#hl-432-57>57</a>
</span><span class=lnt id=hl-432-58><a class=lnlinks href=#hl-432-58>58</a>
</span><span class=lnt id=hl-432-59><a class=lnlinks href=#hl-432-59>59</a>
</span><span class=lnt id=hl-432-60><a class=lnlinks href=#hl-432-60>60</a>
</span><span class=lnt id=hl-432-61><a class=lnlinks href=#hl-432-61>61</a>
</span><span class=lnt id=hl-432-62><a class=lnlinks href=#hl-432-62>62</a>
</span><span class=lnt id=hl-432-63><a class=lnlinks href=#hl-432-63>63</a>
</span><span class=lnt id=hl-432-64><a class=lnlinks href=#hl-432-64>64</a>
</span><span class=lnt id=hl-432-65><a class=lnlinks href=#hl-432-65>65</a>
</span><span class=lnt id=hl-432-66><a class=lnlinks href=#hl-432-66>66</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ... çœç•¥æ— å…³ä»£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¤–éƒ¨ç±» WriteLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>acquire</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°è¯•è·å¾—å†™é”å¤±è´¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>tryAcquire</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è¿›å…¥ AQS é˜Ÿåˆ—é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acquireQueued</span><span class=p>(</span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>EXCLUSIVE</span><span class=p>),</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryAcquire</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å¾—ä½ 16 ä½, ä»£è¡¨å†™é”çš„ state è®¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exclusiveCount</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//è¡¨ç¤ºæœ‰å†™é”æˆ–è€…æœ‰è¯»é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// c != 0 and w == 0 è¡¨ç¤ºæœ‰è¯»é”, æˆ–è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>w</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å¦‚æœ exclusiveOwnerThread ä¸æ˜¯è‡ªå·±</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>current</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>getExclusiveOwnerThread</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è·å¾—é”å¤±è´¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å†™é”è®¡æ•°è¶…è¿‡ä½ 16 ä½, æŠ¥å¼‚å¸¸</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>w</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>exclusiveCount</span><span class=p>(</span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>MAX_COUNT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum lock count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å†™é”é‡å…¥, è·å¾—é”æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setState</span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>acquires</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// åˆ¤æ–­å†™é”æ˜¯å¦è¯¥é˜»å¡, æˆ–è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//éå…¬å¹³é”ä¸‹ï¼Œæ€»æ˜¯è¿”å›false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>writerShouldBlock</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°è¯•æ›´æ”¹è®¡æ•°å¤±è´¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è·å¾—é”å¤±è´¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å¾—é”æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=n>current</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// éå…¬å¹³é” writerShouldBlock æ€»æ˜¯è¿”å› false, æ— éœ€é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>writerShouldBlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“ï¼š</p><ul><li><code>lock</code> -> <code>syn.acquire</code> -><code>tryAquire</code><ul><li>å¦‚æœæœ‰é”ï¼š<ul><li>å¦‚æœæ˜¯å†™é”æˆ–è€…é”æŒæœ‰è€…ä¸ä¸ºè‡ªå·±ï¼Œè¿”å›false</li><li>å¦‚æœæ—¶å†™é”ä¸”ä¸ºè‡ªå·±æŒæœ‰ï¼Œåˆ™é‡å…¥</li></ul></li><li>å¦‚æœæ— é”ï¼š<ul><li>åˆ¤æ–­æ— åºé˜»å¡å¹¶è®¾ç½®stateæˆåŠŸåï¼Œå°†ownerè®¾ä¸ºè‡ªå·±ï¼Œè¿”å›true</li></ul></li></ul></li><li>æˆåŠŸï¼Œåˆ™è·å¾—äº†é”</li><li>å¤±è´¥ï¼š<ul><li>è°ƒç”¨<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code>è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå°†èŠ‚ç‚¹çŠ¶æ€è®¾ç½®ä¸ºEXCLUSIVEï¼Œä¹‹åçš„é€»è¾‘ä¸ä¹‹å‰çš„aquireQueuedç±»ä¼¼ã€‚</li></ul></li></ul><h5 id=å†™é”é‡Šæ”¾æµç¨‹><a href=#%e5%86%99%e9%94%81%e9%87%8a%e6%94%be%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
<strong>å†™é”é‡Šæ”¾æµç¨‹</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-433-1><a class=lnlinks href=#hl-433-1> 1</a>
</span><span class=lnt id=hl-433-2><a class=lnlinks href=#hl-433-2> 2</a>
</span><span class=lnt id=hl-433-3><a class=lnlinks href=#hl-433-3> 3</a>
</span><span class=lnt id=hl-433-4><a class=lnlinks href=#hl-433-4> 4</a>
</span><span class=lnt id=hl-433-5><a class=lnlinks href=#hl-433-5> 5</a>
</span><span class=lnt id=hl-433-6><a class=lnlinks href=#hl-433-6> 6</a>
</span><span class=lnt id=hl-433-7><a class=lnlinks href=#hl-433-7> 7</a>
</span><span class=lnt id=hl-433-8><a class=lnlinks href=#hl-433-8> 8</a>
</span><span class=lnt id=hl-433-9><a class=lnlinks href=#hl-433-9> 9</a>
</span><span class=lnt id=hl-433-10><a class=lnlinks href=#hl-433-10>10</a>
</span><span class=lnt id=hl-433-11><a class=lnlinks href=#hl-433-11>11</a>
</span><span class=lnt id=hl-433-12><a class=lnlinks href=#hl-433-12>12</a>
</span><span class=lnt id=hl-433-13><a class=lnlinks href=#hl-433-13>13</a>
</span><span class=lnt id=hl-433-14><a class=lnlinks href=#hl-433-14>14</a>
</span><span class=lnt id=hl-433-15><a class=lnlinks href=#hl-433-15>15</a>
</span><span class=lnt id=hl-433-16><a class=lnlinks href=#hl-433-16>16</a>
</span><span class=lnt id=hl-433-17><a class=lnlinks href=#hl-433-17>17</a>
</span><span class=lnt id=hl-433-18><a class=lnlinks href=#hl-433-18>18</a>
</span><span class=lnt id=hl-433-19><a class=lnlinks href=#hl-433-19>19</a>
</span><span class=lnt id=hl-433-20><a class=lnlinks href=#hl-433-20>20</a>
</span><span class=lnt id=hl-433-21><a class=lnlinks href=#hl-433-21>21</a>
</span><span class=lnt id=hl-433-22><a class=lnlinks href=#hl-433-22>22</a>
</span><span class=lnt id=hl-433-23><a class=lnlinks href=#hl-433-23>23</a>
</span><span class=lnt id=hl-433-24><a class=lnlinks href=#hl-433-24>24</a>
</span><span class=lnt id=hl-433-25><a class=lnlinks href=#hl-433-25>25</a>
</span><span class=lnt id=hl-433-26><a class=lnlinks href=#hl-433-26>26</a>
</span><span class=lnt id=hl-433-27><a class=lnlinks href=#hl-433-27>27</a>
</span><span class=lnt id=hl-433-28><a class=lnlinks href=#hl-433-28>28</a>
</span><span class=lnt id=hl-433-29><a class=lnlinks href=#hl-433-29>29</a>
</span><span class=lnt id=hl-433-30><a class=lnlinks href=#hl-433-30>30</a>
</span><span class=lnt id=hl-433-31><a class=lnlinks href=#hl-433-31>31</a>
</span><span class=lnt id=hl-433-32><a class=lnlinks href=#hl-433-32>32</a>
</span><span class=lnt id=hl-433-33><a class=lnlinks href=#hl-433-33>33</a>
</span><span class=lnt id=hl-433-34><a class=lnlinks href=#hl-433-34>34</a>
</span><span class=lnt id=hl-433-35><a class=lnlinks href=#hl-433-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ... çœç•¥æ— å…³ä»£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// WriteLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>release</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°è¯•é‡Šæ”¾å†™é”æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryRelease</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// unpark AQS ä¸­ç­‰å¾…çš„çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryRelease</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>releases</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHeldExclusively</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMonitorStateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>releases</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å› ä¸ºå¯é‡å…¥çš„åŸå› , å†™é”è®¡æ•°ä¸º 0, æ‰ç®—é‡Šæ”¾æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>free</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exclusiveCount</span><span class=p>(</span><span class=n>nextc</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>free</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setExclusiveOwnerThread</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setState</span><span class=p>(</span><span class=n>nextc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>free</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“ï¼š</p><ul><li><p><code>unlock</code>-><code>syn.release</code>-><code>tryRelease</code></p><ul><li>stateçŠ¶æ€å‡å°‘<ul><li>å¦‚æœå‡ä¸ºé›¶ï¼Œè¡¨ç¤ºè§£é”æˆåŠŸï¼Œè¿”å›true</li><li>æ²¡æœ‰å‡ä¸º0ï¼Œå½“å‰çº¿ç¨‹ä¾æ—§æŒæœ‰é”</li></ul></li></ul></li><li><p>æˆåŠŸï¼šè§£é”æˆåŠŸ</p><ul><li>å¦‚æœASQé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™å”¤é†’ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li></ul></li><li><p>å¤±è´¥ï¼šè§£é”å¤±è´¥ã€‚</p></li></ul><h5 id=è¯»é”ä¸Šé”æµç¨‹><a href=#%e8%af%bb%e9%94%81%e4%b8%8a%e9%94%81%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
<strong>è¯»é”ä¸Šé”æµç¨‹</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-434-1><a class=lnlinks href=#hl-434-1>  1</a>
</span><span class=lnt id=hl-434-2><a class=lnlinks href=#hl-434-2>  2</a>
</span><span class=lnt id=hl-434-3><a class=lnlinks href=#hl-434-3>  3</a>
</span><span class=lnt id=hl-434-4><a class=lnlinks href=#hl-434-4>  4</a>
</span><span class=lnt id=hl-434-5><a class=lnlinks href=#hl-434-5>  5</a>
</span><span class=lnt id=hl-434-6><a class=lnlinks href=#hl-434-6>  6</a>
</span><span class=lnt id=hl-434-7><a class=lnlinks href=#hl-434-7>  7</a>
</span><span class=lnt id=hl-434-8><a class=lnlinks href=#hl-434-8>  8</a>
</span><span class=lnt id=hl-434-9><a class=lnlinks href=#hl-434-9>  9</a>
</span><span class=lnt id=hl-434-10><a class=lnlinks href=#hl-434-10> 10</a>
</span><span class=lnt id=hl-434-11><a class=lnlinks href=#hl-434-11> 11</a>
</span><span class=lnt id=hl-434-12><a class=lnlinks href=#hl-434-12> 12</a>
</span><span class=lnt id=hl-434-13><a class=lnlinks href=#hl-434-13> 13</a>
</span><span class=lnt id=hl-434-14><a class=lnlinks href=#hl-434-14> 14</a>
</span><span class=lnt id=hl-434-15><a class=lnlinks href=#hl-434-15> 15</a>
</span><span class=lnt id=hl-434-16><a class=lnlinks href=#hl-434-16> 16</a>
</span><span class=lnt id=hl-434-17><a class=lnlinks href=#hl-434-17> 17</a>
</span><span class=lnt id=hl-434-18><a class=lnlinks href=#hl-434-18> 18</a>
</span><span class=lnt id=hl-434-19><a class=lnlinks href=#hl-434-19> 19</a>
</span><span class=lnt id=hl-434-20><a class=lnlinks href=#hl-434-20> 20</a>
</span><span class=lnt id=hl-434-21><a class=lnlinks href=#hl-434-21> 21</a>
</span><span class=lnt id=hl-434-22><a class=lnlinks href=#hl-434-22> 22</a>
</span><span class=lnt id=hl-434-23><a class=lnlinks href=#hl-434-23> 23</a>
</span><span class=lnt id=hl-434-24><a class=lnlinks href=#hl-434-24> 24</a>
</span><span class=lnt id=hl-434-25><a class=lnlinks href=#hl-434-25> 25</a>
</span><span class=lnt id=hl-434-26><a class=lnlinks href=#hl-434-26> 26</a>
</span><span class=lnt id=hl-434-27><a class=lnlinks href=#hl-434-27> 27</a>
</span><span class=lnt id=hl-434-28><a class=lnlinks href=#hl-434-28> 28</a>
</span><span class=lnt id=hl-434-29><a class=lnlinks href=#hl-434-29> 29</a>
</span><span class=lnt id=hl-434-30><a class=lnlinks href=#hl-434-30> 30</a>
</span><span class=lnt id=hl-434-31><a class=lnlinks href=#hl-434-31> 31</a>
</span><span class=lnt id=hl-434-32><a class=lnlinks href=#hl-434-32> 32</a>
</span><span class=lnt id=hl-434-33><a class=lnlinks href=#hl-434-33> 33</a>
</span><span class=lnt id=hl-434-34><a class=lnlinks href=#hl-434-34> 34</a>
</span><span class=lnt id=hl-434-35><a class=lnlinks href=#hl-434-35> 35</a>
</span><span class=lnt id=hl-434-36><a class=lnlinks href=#hl-434-36> 36</a>
</span><span class=lnt id=hl-434-37><a class=lnlinks href=#hl-434-37> 37</a>
</span><span class=lnt id=hl-434-38><a class=lnlinks href=#hl-434-38> 38</a>
</span><span class=lnt id=hl-434-39><a class=lnlinks href=#hl-434-39> 39</a>
</span><span class=lnt id=hl-434-40><a class=lnlinks href=#hl-434-40> 40</a>
</span><span class=lnt id=hl-434-41><a class=lnlinks href=#hl-434-41> 41</a>
</span><span class=lnt id=hl-434-42><a class=lnlinks href=#hl-434-42> 42</a>
</span><span class=lnt id=hl-434-43><a class=lnlinks href=#hl-434-43> 43</a>
</span><span class=lnt id=hl-434-44><a class=lnlinks href=#hl-434-44> 44</a>
</span><span class=lnt id=hl-434-45><a class=lnlinks href=#hl-434-45> 45</a>
</span><span class=lnt id=hl-434-46><a class=lnlinks href=#hl-434-46> 46</a>
</span><span class=lnt id=hl-434-47><a class=lnlinks href=#hl-434-47> 47</a>
</span><span class=lnt id=hl-434-48><a class=lnlinks href=#hl-434-48> 48</a>
</span><span class=lnt id=hl-434-49><a class=lnlinks href=#hl-434-49> 49</a>
</span><span class=lnt id=hl-434-50><a class=lnlinks href=#hl-434-50> 50</a>
</span><span class=lnt id=hl-434-51><a class=lnlinks href=#hl-434-51> 51</a>
</span><span class=lnt id=hl-434-52><a class=lnlinks href=#hl-434-52> 52</a>
</span><span class=lnt id=hl-434-53><a class=lnlinks href=#hl-434-53> 53</a>
</span><span class=lnt id=hl-434-54><a class=lnlinks href=#hl-434-54> 54</a>
</span><span class=lnt id=hl-434-55><a class=lnlinks href=#hl-434-55> 55</a>
</span><span class=lnt id=hl-434-56><a class=lnlinks href=#hl-434-56> 56</a>
</span><span class=lnt id=hl-434-57><a class=lnlinks href=#hl-434-57> 57</a>
</span><span class=lnt id=hl-434-58><a class=lnlinks href=#hl-434-58> 58</a>
</span><span class=lnt id=hl-434-59><a class=lnlinks href=#hl-434-59> 59</a>
</span><span class=lnt id=hl-434-60><a class=lnlinks href=#hl-434-60> 60</a>
</span><span class=lnt id=hl-434-61><a class=lnlinks href=#hl-434-61> 61</a>
</span><span class=lnt id=hl-434-62><a class=lnlinks href=#hl-434-62> 62</a>
</span><span class=lnt id=hl-434-63><a class=lnlinks href=#hl-434-63> 63</a>
</span><span class=lnt id=hl-434-64><a class=lnlinks href=#hl-434-64> 64</a>
</span><span class=lnt id=hl-434-65><a class=lnlinks href=#hl-434-65> 65</a>
</span><span class=lnt id=hl-434-66><a class=lnlinks href=#hl-434-66> 66</a>
</span><span class=lnt id=hl-434-67><a class=lnlinks href=#hl-434-67> 67</a>
</span><span class=lnt id=hl-434-68><a class=lnlinks href=#hl-434-68> 68</a>
</span><span class=lnt id=hl-434-69><a class=lnlinks href=#hl-434-69> 69</a>
</span><span class=lnt id=hl-434-70><a class=lnlinks href=#hl-434-70> 70</a>
</span><span class=lnt id=hl-434-71><a class=lnlinks href=#hl-434-71> 71</a>
</span><span class=lnt id=hl-434-72><a class=lnlinks href=#hl-434-72> 72</a>
</span><span class=lnt id=hl-434-73><a class=lnlinks href=#hl-434-73> 73</a>
</span><span class=lnt id=hl-434-74><a class=lnlinks href=#hl-434-74> 74</a>
</span><span class=lnt id=hl-434-75><a class=lnlinks href=#hl-434-75> 75</a>
</span><span class=lnt id=hl-434-76><a class=lnlinks href=#hl-434-76> 76</a>
</span><span class=lnt id=hl-434-77><a class=lnlinks href=#hl-434-77> 77</a>
</span><span class=lnt id=hl-434-78><a class=lnlinks href=#hl-434-78> 78</a>
</span><span class=lnt id=hl-434-79><a class=lnlinks href=#hl-434-79> 79</a>
</span><span class=lnt id=hl-434-80><a class=lnlinks href=#hl-434-80> 80</a>
</span><span class=lnt id=hl-434-81><a class=lnlinks href=#hl-434-81> 81</a>
</span><span class=lnt id=hl-434-82><a class=lnlinks href=#hl-434-82> 82</a>
</span><span class=lnt id=hl-434-83><a class=lnlinks href=#hl-434-83> 83</a>
</span><span class=lnt id=hl-434-84><a class=lnlinks href=#hl-434-84> 84</a>
</span><span class=lnt id=hl-434-85><a class=lnlinks href=#hl-434-85> 85</a>
</span><span class=lnt id=hl-434-86><a class=lnlinks href=#hl-434-86> 86</a>
</span><span class=lnt id=hl-434-87><a class=lnlinks href=#hl-434-87> 87</a>
</span><span class=lnt id=hl-434-88><a class=lnlinks href=#hl-434-88> 88</a>
</span><span class=lnt id=hl-434-89><a class=lnlinks href=#hl-434-89> 89</a>
</span><span class=lnt id=hl-434-90><a class=lnlinks href=#hl-434-90> 90</a>
</span><span class=lnt id=hl-434-91><a class=lnlinks href=#hl-434-91> 91</a>
</span><span class=lnt id=hl-434-92><a class=lnlinks href=#hl-434-92> 92</a>
</span><span class=lnt id=hl-434-93><a class=lnlinks href=#hl-434-93> 93</a>
</span><span class=lnt id=hl-434-94><a class=lnlinks href=#hl-434-94> 94</a>
</span><span class=lnt id=hl-434-95><a class=lnlinks href=#hl-434-95> 95</a>
</span><span class=lnt id=hl-434-96><a class=lnlinks href=#hl-434-96> 96</a>
</span><span class=lnt id=hl-434-97><a class=lnlinks href=#hl-434-97> 97</a>
</span><span class=lnt id=hl-434-98><a class=lnlinks href=#hl-434-98> 98</a>
</span><span class=lnt id=hl-434-99><a class=lnlinks href=#hl-434-99> 99</a>
</span><span class=lnt id=hl-434-100><a class=lnlinks href=#hl-434-100>100</a>
</span><span class=lnt id=hl-434-101><a class=lnlinks href=#hl-434-101>101</a>
</span><span class=lnt id=hl-434-102><a class=lnlinks href=#hl-434-102>102</a>
</span><span class=lnt id=hl-434-103><a class=lnlinks href=#hl-434-103>103</a>
</span><span class=lnt id=hl-434-104><a class=lnlinks href=#hl-434-104>104</a>
</span><span class=lnt id=hl-434-105><a class=lnlinks href=#hl-434-105>105</a>
</span><span class=lnt id=hl-434-106><a class=lnlinks href=#hl-434-106>106</a>
</span><span class=lnt id=hl-434-107><a class=lnlinks href=#hl-434-107>107</a>
</span><span class=lnt id=hl-434-108><a class=lnlinks href=#hl-434-108>108</a>
</span><span class=lnt id=hl-434-109><a class=lnlinks href=#hl-434-109>109</a>
</span><span class=lnt id=hl-434-110><a class=lnlinks href=#hl-434-110>110</a>
</span><span class=lnt id=hl-434-111><a class=lnlinks href=#hl-434-111>111</a>
</span><span class=lnt id=hl-434-112><a class=lnlinks href=#hl-434-112>112</a>
</span><span class=lnt id=hl-434-113><a class=lnlinks href=#hl-434-113>113</a>
</span><span class=lnt id=hl-434-114><a class=lnlinks href=#hl-434-114>114</a>
</span><span class=lnt id=hl-434-115><a class=lnlinks href=#hl-434-115>115</a>
</span><span class=lnt id=hl-434-116><a class=lnlinks href=#hl-434-116>116</a>
</span><span class=lnt id=hl-434-117><a class=lnlinks href=#hl-434-117>117</a>
</span><span class=lnt id=hl-434-118><a class=lnlinks href=#hl-434-118>118</a>
</span><span class=lnt id=hl-434-119><a class=lnlinks href=#hl-434-119>119</a>
</span><span class=lnt id=hl-434-120><a class=lnlinks href=#hl-434-120>120</a>
</span><span class=lnt id=hl-434-121><a class=lnlinks href=#hl-434-121>121</a>
</span><span class=lnt id=hl-434-122><a class=lnlinks href=#hl-434-122>122</a>
</span><span class=lnt id=hl-434-123><a class=lnlinks href=#hl-434-123>123</a>
</span><span class=lnt id=hl-434-124><a class=lnlinks href=#hl-434-124>124</a>
</span><span class=lnt id=hl-434-125><a class=lnlinks href=#hl-434-125>125</a>
</span><span class=lnt id=hl-434-126><a class=lnlinks href=#hl-434-126>126</a>
</span><span class=lnt id=hl-434-127><a class=lnlinks href=#hl-434-127>127</a>
</span><span class=lnt id=hl-434-128><a class=lnlinks href=#hl-434-128>128</a>
</span><span class=lnt id=hl-434-129><a class=lnlinks href=#hl-434-129>129</a>
</span><span class=lnt id=hl-434-130><a class=lnlinks href=#hl-434-130>130</a>
</span><span class=lnt id=hl-434-131><a class=lnlinks href=#hl-434-131>131</a>
</span><span class=lnt id=hl-434-132><a class=lnlinks href=#hl-434-132>132</a>
</span><span class=lnt id=hl-434-133><a class=lnlinks href=#hl-434-133>133</a>
</span><span class=lnt id=hl-434-134><a class=lnlinks href=#hl-434-134>134</a>
</span><span class=lnt id=hl-434-135><a class=lnlinks href=#hl-434-135>135</a>
</span><span class=lnt id=hl-434-136><a class=lnlinks href=#hl-434-136>136</a>
</span><span class=lnt id=hl-434-137><a class=lnlinks href=#hl-434-137>137</a>
</span><span class=lnt id=hl-434-138><a class=lnlinks href=#hl-434-138>138</a>
</span><span class=lnt id=hl-434-139><a class=lnlinks href=#hl-434-139>139</a>
</span><span class=lnt id=hl-434-140><a class=lnlinks href=#hl-434-140>140</a>
</span><span class=lnt id=hl-434-141><a class=lnlinks href=#hl-434-141>141</a>
</span><span class=lnt id=hl-434-142><a class=lnlinks href=#hl-434-142>142</a>
</span><span class=lnt id=hl-434-143><a class=lnlinks href=#hl-434-143>143</a>
</span><span class=lnt id=hl-434-144><a class=lnlinks href=#hl-434-144>144</a>
</span><span class=lnt id=hl-434-145><a class=lnlinks href=#hl-434-145>145</a>
</span><span class=lnt id=hl-434-146><a class=lnlinks href=#hl-434-146>146</a>
</span><span class=lnt id=hl-434-147><a class=lnlinks href=#hl-434-147>147</a>
</span><span class=lnt id=hl-434-148><a class=lnlinks href=#hl-434-148>148</a>
</span><span class=lnt id=hl-434-149><a class=lnlinks href=#hl-434-149>149</a>
</span><span class=lnt id=hl-434-150><a class=lnlinks href=#hl-434-150>150</a>
</span><span class=lnt id=hl-434-151><a class=lnlinks href=#hl-434-151>151</a>
</span><span class=lnt id=hl-434-152><a class=lnlinks href=#hl-434-152>152</a>
</span><span class=lnt id=hl-434-153><a class=lnlinks href=#hl-434-153>153</a>
</span><span class=lnt id=hl-434-154><a class=lnlinks href=#hl-434-154>154</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ReadLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>lock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>acquireShared</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquireShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// tryAcquireShared è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–è¯»é”å¤±è´¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//å¤§äº0çš„æƒ…å†µåœ¨è¯»å†™é”è¿™é‡Œæ— åŒºåˆ«ï¼Œåé¢ä¿¡å·é‡ä¼šåšè¿›ä¸€æ­¥å¤„ç†ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryAcquireShared</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doAcquireShared</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>tryAcquireShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>unused</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹æŒæœ‰å†™é”, è·å–è¯»é”å¤±è´¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>exclusiveCount</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>getExclusiveOwnerThread</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>current</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sharedCount</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è¯»é”ä¸è¯¥é˜»å¡(å¦‚æœè€äºŒæ˜¯å†™é”ï¼Œè¯»é”è¯¥é˜»å¡), å¹¶ä¸”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>readerShouldBlock</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°äºè¯»é”è®¡æ•°, å¹¶ä¸”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>MAX_COUNT</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°è¯•å¢åŠ è®¡æ•°æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>SHARED_UNIT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ... çœç•¥ä¸é‡è¦çš„ä»£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>fullTryAcquireShared</span><span class=p>(</span><span class=n>current</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// éå…¬å¹³é” readerShouldBlock çœ‹ AQS é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯å†™é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// true åˆ™è¯¥é˜»å¡, false åˆ™ä¸é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>readerShouldBlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>apparentlyFirstQueuedIsExclusive</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸ tryAcquireShared åŠŸèƒ½ç±»ä¼¼, ä½†ä¼šä¸æ–­å°è¯• for (;;) è·å–è¯»é”, æ‰§è¡Œè¿‡ç¨‹ä¸­æ— é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>fullTryAcquireShared</span><span class=p>(</span><span class=n>Thread</span><span class=w> </span><span class=n>current</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HoldCounter</span><span class=w> </span><span class=n>rh</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>exclusiveCount</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>getExclusiveOwnerThread</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>current</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>readerShouldBlock</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ... çœç•¥ä¸é‡è¦çš„ä»£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sharedCount</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAX_COUNT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum lock count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>SHARED_UNIT</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ... çœç•¥ä¸é‡è¦çš„ä»£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doAcquireShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºå…±äº«æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>SHARED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>predecessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å†ä¸€æ¬¡å°è¯•è·å–è¯»é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tryAcquireShared</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// ãˆ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// r è¡¨ç¤ºå¯ç”¨èµ„æºæ•°, åœ¨è¿™é‡Œæ€»æ˜¯ 1 å…è®¸ä¼ æ’­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//ï¼ˆå”¤é†’ AQS ä¸­ä¸‹ä¸€ä¸ª Share èŠ‚ç‚¹ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>setHeadAndPropagate</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// help GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interrupted</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>selfInterrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// æ˜¯å¦åœ¨è·å–è¯»é”å¤±è´¥æ—¶é˜»å¡ï¼ˆå‰ä¸€ä¸ªé˜¶æ®µ waitStatus == Node.SIGNALï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// park å½“å‰çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>parkAndCheckInterrupt</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>interrupted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cancelAcquire</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setHeadAndPropagate</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>propagate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w> </span><span class=c1>// Record old head for check below</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è®¾ç½®è‡ªå·±ä¸º head</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setHead</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// åŸ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ç°åœ¨ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>propagate</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>isShared</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è¿›å…¥ ãˆ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>doReleaseShared</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ãˆ¡ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doReleaseShared</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE, ä¸ºäº†è§£å†³ bug, è§åé¢åˆ†æ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// é˜Ÿåˆ—è¿˜æœ‰èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>tail</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w> </span><span class=c1>// loop to recheck cases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark å¦‚æœæˆåŠŸè·å–è¯»é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å¹¶ä¸”ä¸‹ä¸‹ä¸ªèŠ‚ç‚¹è¿˜æ˜¯ shared, ç»§ç»­ doReleaseShared</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>PROPAGATE</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w> </span><span class=c1>// loop on failed CAS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=c1>// loop if head changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“ï¼š</p><ul><li><code>lock</code>-><code>syn.acquireShare</code>-><code>tryAcquireShare</code><ul><li>å¦‚æœå…¶ä»–çº¿ç¨‹æŒæœ‰å†™é”ï¼šåˆ™å¤±è´¥ï¼Œè¿”å›-1</li><li>å¦åˆ™ï¼šåˆ¤æ–­æ— éœ€ç­‰å¾…åï¼Œå°†stateåŠ ä¸Šä¸€ä¸ªå†™é”çš„å•ä½ï¼Œè¿”å›1</li></ul></li><li>è¿”å›å€¼å¤§äºç­‰äº0ï¼šæˆåŠŸ</li><li>è¿”å›å€¼å°äº0ï¼š<ul><li>è°ƒç”¨doAcquireShareï¼Œç±»ä¼¼ä¹‹å‰çš„aquireQueued,å°†å½“å‰çº¿ç¨‹å…³è”èŠ‚ç‚¹ï¼ŒçŠ¶æ€è®¾ç½®ä¸ºSHAREï¼Œæ’å…¥AQSé˜Ÿåˆ—å°¾éƒ¨ã€‚åœ¨forå¾ªç¯ä¸­åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹<ul><li>æ˜¯ï¼šè°ƒç”¨<code>tryAcquireShare</code><ul><li>å¦‚æœè¿”å›å€¼å¤§äºç­‰äº0ï¼Œåˆ™è·å–é”æˆåŠŸï¼Œå¹¶è°ƒç”¨<code>setHeadAndPropagate</code>ï¼Œå‡ºé˜Ÿï¼Œå¹¶ä¸æ–­å”¤é†’AQSé˜Ÿåˆ—ä¸­çš„çŠ¶æ€ä¸ºSHAREçš„èŠ‚ç‚¹ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºEXCLUSIVEã€‚è®°å½•æ‰“æ–­æ ‡è®°ï¼Œä¹‹åé€€å‡ºæ–¹æ³•ï¼ˆä¸è¿”å›æ‰“æ–­æ ‡è®°ï¼‰</li></ul></li></ul></li><li>åˆ¤æ–­æ˜¯å¦åœ¨å¤±è´¥åé˜»å¡<ul><li>æ˜¯ï¼šé˜»å¡ä½ï¼Œå¹¶ç›‘æµ‹æ‰“æ–­ä¿¡å·ã€‚</li><li>å¦åˆ™ï¼šå°†å‰é©±èŠ‚ç‚¹çŠ¶æ€è®¾ä¸º-1ã€‚ï¼ˆä¸‹ä¸€æ¬¡å¾ªç¯å°±åˆè¦é˜»å¡äº†ï¼‰</li></ul></li></ul></li></ul><h5 id=è¯»é”é‡Šæ”¾æµç¨‹><a href=#%e8%af%bb%e9%94%81%e9%87%8a%e6%94%be%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
<strong>è¯»é”é‡Šæ”¾æµç¨‹</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-435-1><a class=lnlinks href=#hl-435-1> 1</a>
</span><span class=lnt id=hl-435-2><a class=lnlinks href=#hl-435-2> 2</a>
</span><span class=lnt id=hl-435-3><a class=lnlinks href=#hl-435-3> 3</a>
</span><span class=lnt id=hl-435-4><a class=lnlinks href=#hl-435-4> 4</a>
</span><span class=lnt id=hl-435-5><a class=lnlinks href=#hl-435-5> 5</a>
</span><span class=lnt id=hl-435-6><a class=lnlinks href=#hl-435-6> 6</a>
</span><span class=lnt id=hl-435-7><a class=lnlinks href=#hl-435-7> 7</a>
</span><span class=lnt id=hl-435-8><a class=lnlinks href=#hl-435-8> 8</a>
</span><span class=lnt id=hl-435-9><a class=lnlinks href=#hl-435-9> 9</a>
</span><span class=lnt id=hl-435-10><a class=lnlinks href=#hl-435-10>10</a>
</span><span class=lnt id=hl-435-11><a class=lnlinks href=#hl-435-11>11</a>
</span><span class=lnt id=hl-435-12><a class=lnlinks href=#hl-435-12>12</a>
</span><span class=lnt id=hl-435-13><a class=lnlinks href=#hl-435-13>13</a>
</span><span class=lnt id=hl-435-14><a class=lnlinks href=#hl-435-14>14</a>
</span><span class=lnt id=hl-435-15><a class=lnlinks href=#hl-435-15>15</a>
</span><span class=lnt id=hl-435-16><a class=lnlinks href=#hl-435-16>16</a>
</span><span class=lnt id=hl-435-17><a class=lnlinks href=#hl-435-17>17</a>
</span><span class=lnt id=hl-435-18><a class=lnlinks href=#hl-435-18>18</a>
</span><span class=lnt id=hl-435-19><a class=lnlinks href=#hl-435-19>19</a>
</span><span class=lnt id=hl-435-20><a class=lnlinks href=#hl-435-20>20</a>
</span><span class=lnt id=hl-435-21><a class=lnlinks href=#hl-435-21>21</a>
</span><span class=lnt id=hl-435-22><a class=lnlinks href=#hl-435-22>22</a>
</span><span class=lnt id=hl-435-23><a class=lnlinks href=#hl-435-23>23</a>
</span><span class=lnt id=hl-435-24><a class=lnlinks href=#hl-435-24>24</a>
</span><span class=lnt id=hl-435-25><a class=lnlinks href=#hl-435-25>25</a>
</span><span class=lnt id=hl-435-26><a class=lnlinks href=#hl-435-26>26</a>
</span><span class=lnt id=hl-435-27><a class=lnlinks href=#hl-435-27>27</a>
</span><span class=lnt id=hl-435-28><a class=lnlinks href=#hl-435-28>28</a>
</span><span class=lnt id=hl-435-29><a class=lnlinks href=#hl-435-29>29</a>
</span><span class=lnt id=hl-435-30><a class=lnlinks href=#hl-435-30>30</a>
</span><span class=lnt id=hl-435-31><a class=lnlinks href=#hl-435-31>31</a>
</span><span class=lnt id=hl-435-32><a class=lnlinks href=#hl-435-32>32</a>
</span><span class=lnt id=hl-435-33><a class=lnlinks href=#hl-435-33>33</a>
</span><span class=lnt id=hl-435-34><a class=lnlinks href=#hl-435-34>34</a>
</span><span class=lnt id=hl-435-35><a class=lnlinks href=#hl-435-35>35</a>
</span><span class=lnt id=hl-435-36><a class=lnlinks href=#hl-435-36>36</a>
</span><span class=lnt id=hl-435-37><a class=lnlinks href=#hl-435-37>37</a>
</span><span class=lnt id=hl-435-38><a class=lnlinks href=#hl-435-38>38</a>
</span><span class=lnt id=hl-435-39><a class=lnlinks href=#hl-435-39>39</a>
</span><span class=lnt id=hl-435-40><a class=lnlinks href=#hl-435-40>40</a>
</span><span class=lnt id=hl-435-41><a class=lnlinks href=#hl-435-41>41</a>
</span><span class=lnt id=hl-435-42><a class=lnlinks href=#hl-435-42>42</a>
</span><span class=lnt id=hl-435-43><a class=lnlinks href=#hl-435-43>43</a>
</span><span class=lnt id=hl-435-44><a class=lnlinks href=#hl-435-44>44</a>
</span><span class=lnt id=hl-435-45><a class=lnlinks href=#hl-435-45>45</a>
</span><span class=lnt id=hl-435-46><a class=lnlinks href=#hl-435-46>46</a>
</span><span class=lnt id=hl-435-47><a class=lnlinks href=#hl-435-47>47</a>
</span><span class=lnt id=hl-435-48><a class=lnlinks href=#hl-435-48>48</a>
</span><span class=lnt id=hl-435-49><a class=lnlinks href=#hl-435-49>49</a>
</span><span class=lnt id=hl-435-50><a class=lnlinks href=#hl-435-50>50</a>
</span><span class=lnt id=hl-435-51><a class=lnlinks href=#hl-435-51>51</a>
</span><span class=lnt id=hl-435-52><a class=lnlinks href=#hl-435-52>52</a>
</span><span class=lnt id=hl-435-53><a class=lnlinks href=#hl-435-53>53</a>
</span><span class=lnt id=hl-435-54><a class=lnlinks href=#hl-435-54>54</a>
</span><span class=lnt id=hl-435-55><a class=lnlinks href=#hl-435-55>55</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ReadLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unlock</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>releaseShared</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>releaseShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryReleaseShared</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doReleaseShared</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryReleaseShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>unused</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ... çœç•¥ä¸é‡è¦çš„ä»£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>SHARED_UNIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>nextc</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è¯»é”çš„è®¡æ•°ä¸ä¼šå½±å“å…¶å®ƒè·å–è¯»é”çº¿ç¨‹, ä½†ä¼šå½±å“å…¶å®ƒè·å–å†™é”çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è®¡æ•°ä¸º 0 æ‰æ˜¯çœŸæ­£é‡Šæ”¾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>nextc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doReleaseShared</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>tail</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨é‡Šæ”¾è¯»é”ï¼Œé‚£ä¹ˆéœ€è¦å°† waitStatus å…ˆæ”¹ä¸º 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w> </span><span class=c1>// loop to recheck cases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§ï¼Œè§åæ–‡ä¿¡å·é‡ bug åˆ†æ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>PROPAGATE</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w> </span><span class=c1>// loop on failed CAS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=c1>// loop if head changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“ï¼š</p><ul><li><code>unlock</code>-><code>releaseShared</code>-><code>tryReleaseShared</code>,å°†stateå‡å»ä¸€ä¸ªshareå•å…ƒï¼Œæœ€åstateä¸º0åˆ™è¿”å›trueï¼Œä¸ç„¶è¿”å›falseã€‚</li><li>è¿”å›tueï¼šè°ƒç”¨<code>doReleaseShare</code>,å”¤é†’é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ã€‚</li><li>è¿”å›falseï¼šè§£é”ä¸å®Œå…¨ã€‚</li></ul><h3 id=stampedlock><a href=#stampedlock class=header-anchor>#</a>
StampedLock</h3><p>è¯¥ç±»è‡ª JDK 8 åŠ å…¥ï¼Œæ˜¯ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–è¯»æ€§èƒ½ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½å¿…é¡»é…åˆã€æˆ³ã€‘ä½¿ç”¨ åŠ è§£è¯»é”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-436-1><a class=lnlinks href=#hl-436-1>1</a>
</span><span class=lnt id=hl-436-2><a class=lnlinks href=#hl-436-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>long</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>readLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>unlockRead</span><span class=p>(</span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åŠ è§£å†™é”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-437-1><a class=lnlinks href=#hl-437-1>1</a>
</span><span class=lnt id=hl-437-2><a class=lnlinks href=#hl-437-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>long</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>lock</span><span class=p>.</span><span class=na>unlockWrite</span><span class=p>(</span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¹è§‚è¯»ï¼ŒStampedLock æ”¯æŒ tryOptimisticRead() æ–¹æ³•ï¼ˆä¹è§‚è¯»ï¼‰ï¼Œè¯»å–å®Œæ¯•åéœ€è¦åšä¸€æ¬¡ æˆ³æ ¡éªŒ å¦‚æœæ ¡éªŒé€š è¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´ç¡®å®æ²¡æœ‰å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦‚æœæ ¡éªŒæ²¡é€šè¿‡ï¼Œéœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯æ•°æ®å®‰å…¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-438-1><a class=lnlinks href=#hl-438-1>1</a>
</span><span class=lnt id=hl-438-2><a class=lnlinks href=#hl-438-2>2</a>
</span><span class=lnt id=hl-438-3><a class=lnlinks href=#hl-438-3>3</a>
</span><span class=lnt id=hl-438-4><a class=lnlinks href=#hl-438-4>4</a>
</span><span class=lnt id=hl-438-5><a class=lnlinks href=#hl-438-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>long</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>tryOptimisticRead</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// éªŒæˆ³</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>lock</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>stamp</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é”å‡çº§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æä¾›ä¸€ä¸ª<code>æ•°æ®å®¹å™¨ç±»</code>å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„<code>read()</code>æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„<code>write()</code>æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-439-1><a class=lnlinks href=#hl-439-1> 1</a>
</span><span class=lnt id=hl-439-2><a class=lnlinks href=#hl-439-2> 2</a>
</span><span class=lnt id=hl-439-3><a class=lnlinks href=#hl-439-3> 3</a>
</span><span class=lnt id=hl-439-4><a class=lnlinks href=#hl-439-4> 4</a>
</span><span class=lnt id=hl-439-5><a class=lnlinks href=#hl-439-5> 5</a>
</span><span class=lnt id=hl-439-6><a class=lnlinks href=#hl-439-6> 6</a>
</span><span class=lnt id=hl-439-7><a class=lnlinks href=#hl-439-7> 7</a>
</span><span class=lnt id=hl-439-8><a class=lnlinks href=#hl-439-8> 8</a>
</span><span class=lnt id=hl-439-9><a class=lnlinks href=#hl-439-9> 9</a>
</span><span class=lnt id=hl-439-10><a class=lnlinks href=#hl-439-10>10</a>
</span><span class=lnt id=hl-439-11><a class=lnlinks href=#hl-439-11>11</a>
</span><span class=lnt id=hl-439-12><a class=lnlinks href=#hl-439-12>12</a>
</span><span class=lnt id=hl-439-13><a class=lnlinks href=#hl-439-13>13</a>
</span><span class=lnt id=hl-439-14><a class=lnlinks href=#hl-439-14>14</a>
</span><span class=lnt id=hl-439-15><a class=lnlinks href=#hl-439-15>15</a>
</span><span class=lnt id=hl-439-16><a class=lnlinks href=#hl-439-16>16</a>
</span><span class=lnt id=hl-439-17><a class=lnlinks href=#hl-439-17>17</a>
</span><span class=lnt id=hl-439-18><a class=lnlinks href=#hl-439-18>18</a>
</span><span class=lnt id=hl-439-19><a class=lnlinks href=#hl-439-19>19</a>
</span><span class=lnt id=hl-439-20><a class=lnlinks href=#hl-439-20>20</a>
</span><span class=lnt id=hl-439-21><a class=lnlinks href=#hl-439-21>21</a>
</span><span class=lnt id=hl-439-22><a class=lnlinks href=#hl-439-22>22</a>
</span><span class=lnt id=hl-439-23><a class=lnlinks href=#hl-439-23>23</a>
</span><span class=lnt id=hl-439-24><a class=lnlinks href=#hl-439-24>24</a>
</span><span class=lnt id=hl-439-25><a class=lnlinks href=#hl-439-25>25</a>
</span><span class=lnt id=hl-439-26><a class=lnlinks href=#hl-439-26>26</a>
</span><span class=lnt id=hl-439-27><a class=lnlinks href=#hl-439-27>27</a>
</span><span class=lnt id=hl-439-28><a class=lnlinks href=#hl-439-28>28</a>
</span><span class=lnt id=hl-439-29><a class=lnlinks href=#hl-439-29>29</a>
</span><span class=lnt id=hl-439-30><a class=lnlinks href=#hl-439-30>30</a>
</span><span class=lnt id=hl-439-31><a class=lnlinks href=#hl-439-31>31</a>
</span><span class=lnt id=hl-439-32><a class=lnlinks href=#hl-439-32>32</a>
</span><span class=lnt id=hl-439-33><a class=lnlinks href=#hl-439-33>33</a>
</span><span class=lnt id=hl-439-34><a class=lnlinks href=#hl-439-34>34</a>
</span><span class=lnt id=hl-439-35><a class=lnlinks href=#hl-439-35>35</a>
</span><span class=lnt id=hl-439-36><a class=lnlinks href=#hl-439-36>36</a>
</span><span class=lnt id=hl-439-37><a class=lnlinks href=#hl-439-37>37</a>
</span><span class=lnt id=hl-439-38><a class=lnlinks href=#hl-439-38>38</a>
</span><span class=lnt id=hl-439-39><a class=lnlinks href=#hl-439-39>39</a>
</span><span class=lnt id=hl-439-40><a class=lnlinks href=#hl-439-40>40</a>
</span><span class=lnt id=hl-439-41><a class=lnlinks href=#hl-439-41>41</a>
</span><span class=lnt id=hl-439-42><a class=lnlinks href=#hl-439-42>42</a>
</span><span class=lnt id=hl-439-43><a class=lnlinks href=#hl-439-43>43</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JAVA data-lang=JAVA><span class=line><span class=cl><span class=kd>class</span> <span class=nc>DataContainerStamped</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>StampedLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StampedLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DataContainerStamped</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>read</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>readTime</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//è·å–æˆ³</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>tryOptimisticRead</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;optimistic read locking...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//è¯»å–æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>readTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//è¯»å–æ•°æ®ä¹‹åå†éªŒæˆ³</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>.</span><span class=na>validate</span><span class=p>(</span><span class=n>stamp</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read finish...{}, data:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//å¦‚æœéªŒæˆ³å¤±è´¥ï¼Œè¯´æ˜å·²ç»æ•°æ®å·²ç»è¢«ä¿®æ”¹ï¼Œéœ€è¦å‡çº§é”é‡æ–°è¯»ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é”å‡çº§ - è¯»é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;updating to read lock... {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>readLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read lock {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>readTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read finish...{}, data:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;read unlock {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlockRead</span><span class=p>(</span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>write</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>newData</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>writeLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;write lock {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newData</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;write unlock {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlockWrite</span><span class=p>(</span><span class=n>stamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•<code>è¯»-è¯»</code>å¯ä»¥ä¼˜åŒ–</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-440-1><a class=lnlinks href=#hl-440-1> 1</a>
</span><span class=lnt id=hl-440-2><a class=lnlinks href=#hl-440-2> 2</a>
</span><span class=lnt id=hl-440-3><a class=lnlinks href=#hl-440-3> 3</a>
</span><span class=lnt id=hl-440-4><a class=lnlinks href=#hl-440-4> 4</a>
</span><span class=lnt id=hl-440-5><a class=lnlinks href=#hl-440-5> 5</a>
</span><span class=lnt id=hl-440-6><a class=lnlinks href=#hl-440-6> 6</a>
</span><span class=lnt id=hl-440-7><a class=lnlinks href=#hl-440-7> 7</a>
</span><span class=lnt id=hl-440-8><a class=lnlinks href=#hl-440-8> 8</a>
</span><span class=lnt id=hl-440-9><a class=lnlinks href=#hl-440-9> 9</a>
</span><span class=lnt id=hl-440-10><a class=lnlinks href=#hl-440-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JAVA data-lang=JAVA><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DataContainerStamped</span><span class=w> </span><span class=n>dataContainer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataContainerStamped</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°å®é™…æ²¡æœ‰åŠ è¯»é”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-441-1><a class=lnlinks href=#hl-441-1>1</a>
</span><span class=lnt id=hl-441-2><a class=lnlinks href=#hl-441-2>2</a>
</span><span class=lnt id=hl-441-3><a class=lnlinks href=#hl-441-3>3</a>
</span><span class=lnt id=hl-441-4><a class=lnlinks href=#hl-441-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SH data-lang=SH><span class=line><span class=cl>15:58:50.217 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - optimistic <span class=nb>read</span> locking...256 
</span></span><span class=line><span class=cl>15:58:50.717 c.DataContainerStamped <span class=o>[</span>t2<span class=o>]</span> - optimistic <span class=nb>read</span> locking...256 
</span></span><span class=line><span class=cl>15:58:50.717 c.DataContainerStamped <span class=o>[</span>t2<span class=o>]</span> - <span class=nb>read</span> finish...256, data:1 
</span></span><span class=line><span class=cl>15:58:51.220 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - <span class=nb>read</span> finish...256, data:1 
</span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•<code>è¯»-å†™</code>æ—¶ä¼˜åŒ–è¯»è¡¥åŠ è¯»é”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-442-1><a class=lnlinks href=#hl-442-1> 1</a>
</span><span class=lnt id=hl-442-2><a class=lnlinks href=#hl-442-2> 2</a>
</span><span class=lnt id=hl-442-3><a class=lnlinks href=#hl-442-3> 3</a>
</span><span class=lnt id=hl-442-4><a class=lnlinks href=#hl-442-4> 4</a>
</span><span class=lnt id=hl-442-5><a class=lnlinks href=#hl-442-5> 5</a>
</span><span class=lnt id=hl-442-6><a class=lnlinks href=#hl-442-6> 6</a>
</span><span class=lnt id=hl-442-7><a class=lnlinks href=#hl-442-7> 7</a>
</span><span class=lnt id=hl-442-8><a class=lnlinks href=#hl-442-8> 8</a>
</span><span class=lnt id=hl-442-9><a class=lnlinks href=#hl-442-9> 9</a>
</span><span class=lnt id=hl-442-10><a class=lnlinks href=#hl-442-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JAVA data-lang=JAVA><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DataContainerStamped</span><span class=w> </span><span class=n>dataContainer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataContainerStamped</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t1&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataContainer</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=s>&#34;t2&#34;</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-443-1><a class=lnlinks href=#hl-443-1>1</a>
</span><span class=lnt id=hl-443-2><a class=lnlinks href=#hl-443-2>2</a>
</span><span class=lnt id=hl-443-3><a class=lnlinks href=#hl-443-3>3</a>
</span><span class=lnt id=hl-443-4><a class=lnlinks href=#hl-443-4>4</a>
</span><span class=lnt id=hl-443-5><a class=lnlinks href=#hl-443-5>5</a>
</span><span class=lnt id=hl-443-6><a class=lnlinks href=#hl-443-6>6</a>
</span><span class=lnt id=hl-443-7><a class=lnlinks href=#hl-443-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SH data-lang=SH><span class=line><span class=cl>15:57:00.219 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - optimistic <span class=nb>read</span> locking...256 
</span></span><span class=line><span class=cl>15:57:00.717 c.DataContainerStamped <span class=o>[</span>t2<span class=o>]</span> - write lock <span class=m>384</span> 
</span></span><span class=line><span class=cl>15:57:01.225 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - updating to <span class=nb>read</span> lock... <span class=m>256</span> 
</span></span><span class=line><span class=cl>15:57:02.719 c.DataContainerStamped <span class=o>[</span>t2<span class=o>]</span> - write unlock <span class=m>384</span> 
</span></span><span class=line><span class=cl>15:57:02.719 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - <span class=nb>read</span> lock <span class=m>513</span> 
</span></span><span class=line><span class=cl>15:57:03.719 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - <span class=nb>read</span> finish...513, data:1000 
</span></span><span class=line><span class=cl>15:57:03.719 c.DataContainerStamped <span class=o>[</span>t1<span class=o>]</span> - <span class=nb>read</span> unlock <span class=m>513</span> 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong></p><ul><li>StampedLock ä¸æ”¯æŒæ¡ä»¶å˜é‡</li><li>StampedLock ä¸æ”¯æŒå¯é‡å…¥</li></ul></blockquote><h2 id=semaphore><a href=#semaphore class=header-anchor>#</a>
Semaphore</h2><h3 id=åŸºæœ¬ä½¿ç”¨-1><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8-1 class=header-anchor>#</a>
åŸºæœ¬ä½¿ç”¨</h3><p>[ËˆsÉ›mÉ™ËŒfÉ”r] ä¿¡å·é‡ï¼Œç”¨æ¥é™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-444-1><a class=lnlinks href=#hl-444-1> 1</a>
</span><span class=lnt id=hl-444-2><a class=lnlinks href=#hl-444-2> 2</a>
</span><span class=lnt id=hl-444-3><a class=lnlinks href=#hl-444-3> 3</a>
</span><span class=lnt id=hl-444-4><a class=lnlinks href=#hl-444-4> 4</a>
</span><span class=lnt id=hl-444-5><a class=lnlinks href=#hl-444-5> 5</a>
</span><span class=lnt id=hl-444-6><a class=lnlinks href=#hl-444-6> 6</a>
</span><span class=lnt id=hl-444-7><a class=lnlinks href=#hl-444-7> 7</a>
</span><span class=lnt id=hl-444-8><a class=lnlinks href=#hl-444-8> 8</a>
</span><span class=lnt id=hl-444-9><a class=lnlinks href=#hl-444-9> 9</a>
</span><span class=lnt id=hl-444-10><a class=lnlinks href=#hl-444-10>10</a>
</span><span class=lnt id=hl-444-11><a class=lnlinks href=#hl-444-11>11</a>
</span><span class=lnt id=hl-444-12><a class=lnlinks href=#hl-444-12>12</a>
</span><span class=lnt id=hl-444-13><a class=lnlinks href=#hl-444-13>13</a>
</span><span class=lnt id=hl-444-14><a class=lnlinks href=#hl-444-14>14</a>
</span><span class=lnt id=hl-444-15><a class=lnlinks href=#hl-444-15>15</a>
</span><span class=lnt id=hl-444-16><a class=lnlinks href=#hl-444-16>16</a>
</span><span class=lnt id=hl-444-17><a class=lnlinks href=#hl-444-17>17</a>
</span><span class=lnt id=hl-444-18><a class=lnlinks href=#hl-444-18>18</a>
</span><span class=lnt id=hl-444-19><a class=lnlinks href=#hl-444-19>19</a>
</span><span class=lnt id=hl-444-20><a class=lnlinks href=#hl-444-20>20</a>
</span><span class=lnt id=hl-444-21><a class=lnlinks href=#hl-444-21>21</a>
</span><span class=lnt id=hl-444-22><a class=lnlinks href=#hl-444-22>22</a>
</span><span class=lnt id=hl-444-23><a class=lnlinks href=#hl-444-23>23</a>
</span><span class=lnt id=hl-444-24><a class=lnlinks href=#hl-444-24>24</a>
</span><span class=lnt id=hl-444-25><a class=lnlinks href=#hl-444-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1. åˆ›å»º semaphore å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Semaphore</span><span class=w> </span><span class=n>semaphore</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Semaphore</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2. 10ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 3. è·å–è®¸å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>semaphore</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//å¯¹äºéæ‰“æ–­å¼è·å–ï¼Œå¦‚æœæ­¤è¿‡ç¨‹ä¸­è¢«æ‰“æ–­ï¼Œçº¿ç¨‹ä¾æ—§ä¼šç­‰åˆ°è·å–äº†ä¿¡å·é‡ä¹‹åæ‰è¿›å…¥catchå—ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//catchå—ä¸­çš„çº¿ç¨‹ä¾æ—§æŒæœ‰ä¿¡å·é‡ï¼Œæ•è·è¯¥å¼‚å¸¸åcatchå—å¯ä»¥ä¸åšä»»ä½•å¤„ç†ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;running...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 4. é‡Šæ”¾è®¸å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>semaphore</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-445-1><a class=lnlinks href=#hl-445-1> 1</a>
</span><span class=lnt id=hl-445-2><a class=lnlinks href=#hl-445-2> 2</a>
</span><span class=lnt id=hl-445-3><a class=lnlinks href=#hl-445-3> 3</a>
</span><span class=lnt id=hl-445-4><a class=lnlinks href=#hl-445-4> 4</a>
</span><span class=lnt id=hl-445-5><a class=lnlinks href=#hl-445-5> 5</a>
</span><span class=lnt id=hl-445-6><a class=lnlinks href=#hl-445-6> 6</a>
</span><span class=lnt id=hl-445-7><a class=lnlinks href=#hl-445-7> 7</a>
</span><span class=lnt id=hl-445-8><a class=lnlinks href=#hl-445-8> 8</a>
</span><span class=lnt id=hl-445-9><a class=lnlinks href=#hl-445-9> 9</a>
</span><span class=lnt id=hl-445-10><a class=lnlinks href=#hl-445-10>10</a>
</span><span class=lnt id=hl-445-11><a class=lnlinks href=#hl-445-11>11</a>
</span><span class=lnt id=hl-445-12><a class=lnlinks href=#hl-445-12>12</a>
</span><span class=lnt id=hl-445-13><a class=lnlinks href=#hl-445-13>13</a>
</span><span class=lnt id=hl-445-14><a class=lnlinks href=#hl-445-14>14</a>
</span><span class=lnt id=hl-445-15><a class=lnlinks href=#hl-445-15>15</a>
</span><span class=lnt id=hl-445-16><a class=lnlinks href=#hl-445-16>16</a>
</span><span class=lnt id=hl-445-17><a class=lnlinks href=#hl-445-17>17</a>
</span><span class=lnt id=hl-445-18><a class=lnlinks href=#hl-445-18>18</a>
</span><span class=lnt id=hl-445-19><a class=lnlinks href=#hl-445-19>19</a>
</span><span class=lnt id=hl-445-20><a class=lnlinks href=#hl-445-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>07:35:15.485 c.TestSemaphore <span class=o>[</span>Thread-2<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:15.485 c.TestSemaphore <span class=o>[</span>Thread-1<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:15.485 c.TestSemaphore <span class=o>[</span>Thread-0<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-2<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-0<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-1<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-3<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-5<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:16.490 c.TestSemaphore <span class=o>[</span>Thread-4<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-5<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-4<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-3<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-6<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-7<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:17.490 c.TestSemaphore <span class=o>[</span>Thread-9<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:18.491 c.TestSemaphore <span class=o>[</span>Thread-6<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:18.491 c.TestSemaphore <span class=o>[</span>Thread-7<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:18.491 c.TestSemaphore <span class=o>[</span>Thread-9<span class=o>]</span> - end... 
</span></span><span class=line><span class=cl>07:35:18.491 c.TestSemaphore <span class=o>[</span>Thread-8<span class=o>]</span> - running... 
</span></span><span class=line><span class=cl>07:35:19.492 c.TestSemaphore <span class=o>[</span>Thread-8<span class=o>]</span> - end... 
</span></span></code></pre></td></tr></table></div></div><p>è¯´æ˜ï¼š</p><ul><li>Semaphoreæœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼š<code>Semaphore(int permits)</code>å’Œ<code>Semaphore(int permits,boolean fair)</code></li><li>permitsè¡¨ç¤ºå…è®¸åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹æ•°ã€‚</li><li>fairè¡¨ç¤ºå…¬å¹³ä¸å¦ï¼Œä¸ä¹‹å‰çš„ReentrantLockä¸€æ ·ã€‚</li></ul><h3 id=font-colorgreen-semaphore-åº”ç”¨font><a href=#font-colorgreen-semaphore-%e5%ba%94%e7%94%a8font class=header-anchor>#</a>
<font color=green>* Semaphore åº”ç”¨</font></h3><p>semaphore é™åˆ¶å¯¹å…±äº«èµ„æºçš„ä½¿ç”¨</p><ul><li>ä½¿ç”¨ Semaphore é™æµï¼Œåœ¨è®¿é—®é«˜å³°æœŸæ—¶ï¼Œè®©è¯·æ±‚çº¿ç¨‹é˜»å¡ï¼Œé«˜å³°æœŸè¿‡å»å†é‡Šæ”¾è®¸å¯ï¼Œå½“ç„¶å®ƒåªé€‚åˆé™åˆ¶å•æœº çº¿ç¨‹æ•°é‡ï¼Œå¹¶ä¸”ä»…æ˜¯é™åˆ¶çº¿ç¨‹æ•°ï¼Œè€Œä¸æ˜¯é™åˆ¶èµ„æºæ•°ï¼ˆä¾‹å¦‚è¿æ¥æ•°ï¼Œè¯·å¯¹æ¯” Tomcat LimitLatch çš„å®ç°ï¼‰</li><li>ç”¨ Semaphore å®ç°ç®€å•è¿æ¥æ± ï¼Œå¯¹æ¯”ã€äº«å…ƒæ¨¡å¼ã€ä¸‹çš„å®ç°ï¼ˆç”¨wait notifyï¼‰ï¼Œæ€§èƒ½å’Œå¯è¯»æ€§æ˜¾ç„¶æ›´å¥½ï¼Œ æ³¨æ„ä¸‹é¢çš„å®ç°ä¸­çº¿ç¨‹æ•°å’Œæ•°æ®åº“è¿æ¥æ•°æ˜¯ç›¸ç­‰çš„</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-446-1><a class=lnlinks href=#hl-446-1> 1</a>
</span><span class=lnt id=hl-446-2><a class=lnlinks href=#hl-446-2> 2</a>
</span><span class=lnt id=hl-446-3><a class=lnlinks href=#hl-446-3> 3</a>
</span><span class=lnt id=hl-446-4><a class=lnlinks href=#hl-446-4> 4</a>
</span><span class=lnt id=hl-446-5><a class=lnlinks href=#hl-446-5> 5</a>
</span><span class=lnt id=hl-446-6><a class=lnlinks href=#hl-446-6> 6</a>
</span><span class=lnt id=hl-446-7><a class=lnlinks href=#hl-446-7> 7</a>
</span><span class=lnt id=hl-446-8><a class=lnlinks href=#hl-446-8> 8</a>
</span><span class=lnt id=hl-446-9><a class=lnlinks href=#hl-446-9> 9</a>
</span><span class=lnt id=hl-446-10><a class=lnlinks href=#hl-446-10>10</a>
</span><span class=lnt id=hl-446-11><a class=lnlinks href=#hl-446-11>11</a>
</span><span class=lnt id=hl-446-12><a class=lnlinks href=#hl-446-12>12</a>
</span><span class=lnt id=hl-446-13><a class=lnlinks href=#hl-446-13>13</a>
</span><span class=lnt id=hl-446-14><a class=lnlinks href=#hl-446-14>14</a>
</span><span class=lnt id=hl-446-15><a class=lnlinks href=#hl-446-15>15</a>
</span><span class=lnt id=hl-446-16><a class=lnlinks href=#hl-446-16>16</a>
</span><span class=lnt id=hl-446-17><a class=lnlinks href=#hl-446-17>17</a>
</span><span class=lnt id=hl-446-18><a class=lnlinks href=#hl-446-18>18</a>
</span><span class=lnt id=hl-446-19><a class=lnlinks href=#hl-446-19>19</a>
</span><span class=lnt id=hl-446-20><a class=lnlinks href=#hl-446-20>20</a>
</span><span class=lnt id=hl-446-21><a class=lnlinks href=#hl-446-21>21</a>
</span><span class=lnt id=hl-446-22><a class=lnlinks href=#hl-446-22>22</a>
</span><span class=lnt id=hl-446-23><a class=lnlinks href=#hl-446-23>23</a>
</span><span class=lnt id=hl-446-24><a class=lnlinks href=#hl-446-24>24</a>
</span><span class=lnt id=hl-446-25><a class=lnlinks href=#hl-446-25>25</a>
</span><span class=lnt id=hl-446-26><a class=lnlinks href=#hl-446-26>26</a>
</span><span class=lnt id=hl-446-27><a class=lnlinks href=#hl-446-27>27</a>
</span><span class=lnt id=hl-446-28><a class=lnlinks href=#hl-446-28>28</a>
</span><span class=lnt id=hl-446-29><a class=lnlinks href=#hl-446-29>29</a>
</span><span class=lnt id=hl-446-30><a class=lnlinks href=#hl-446-30>30</a>
</span><span class=lnt id=hl-446-31><a class=lnlinks href=#hl-446-31>31</a>
</span><span class=lnt id=hl-446-32><a class=lnlinks href=#hl-446-32>32</a>
</span><span class=lnt id=hl-446-33><a class=lnlinks href=#hl-446-33>33</a>
</span><span class=lnt id=hl-446-34><a class=lnlinks href=#hl-446-34>34</a>
</span><span class=lnt id=hl-446-35><a class=lnlinks href=#hl-446-35>35</a>
</span><span class=lnt id=hl-446-36><a class=lnlinks href=#hl-446-36>36</a>
</span><span class=lnt id=hl-446-37><a class=lnlinks href=#hl-446-37>37</a>
</span><span class=lnt id=hl-446-38><a class=lnlinks href=#hl-446-38>38</a>
</span><span class=lnt id=hl-446-39><a class=lnlinks href=#hl-446-39>39</a>
</span><span class=lnt id=hl-446-40><a class=lnlinks href=#hl-446-40>40</a>
</span><span class=lnt id=hl-446-41><a class=lnlinks href=#hl-446-41>41</a>
</span><span class=lnt id=hl-446-42><a class=lnlinks href=#hl-446-42>42</a>
</span><span class=lnt id=hl-446-43><a class=lnlinks href=#hl-446-43>43</a>
</span><span class=lnt id=hl-446-44><a class=lnlinks href=#hl-446-44>44</a>
</span><span class=lnt id=hl-446-45><a class=lnlinks href=#hl-446-45>45</a>
</span><span class=lnt id=hl-446-46><a class=lnlinks href=#hl-446-46>46</a>
</span><span class=lnt id=hl-446-47><a class=lnlinks href=#hl-446-47>47</a>
</span><span class=lnt id=hl-446-48><a class=lnlinks href=#hl-446-48>48</a>
</span><span class=lnt id=hl-446-49><a class=lnlinks href=#hl-446-49>49</a>
</span><span class=lnt id=hl-446-50><a class=lnlinks href=#hl-446-50>50</a>
</span><span class=lnt id=hl-446-51><a class=lnlinks href=#hl-446-51>51</a>
</span><span class=lnt id=hl-446-52><a class=lnlinks href=#hl-446-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=p>(</span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;c.Pool&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>Pool</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1. è¿æ¥æ± å¤§å°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2. è¿æ¥å¯¹è±¡æ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Connection</span><span class=o>[]</span><span class=w> </span><span class=n>connections</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 3. è¿æ¥çŠ¶æ€æ•°ç»„ 0 è¡¨ç¤ºç©ºé—²ï¼Œ 1 è¡¨ç¤ºç¹å¿™</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AtomicIntegerArray</span><span class=w> </span><span class=n>states</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Semaphore</span><span class=w> </span><span class=n>semaphore</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 4. æ„é€ æ–¹æ³•åˆå§‹åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Pool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>poolSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>poolSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è®©è®¸å¯æ•°ä¸èµ„æºæ•°ä¸€è‡´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>semaphore</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Semaphore</span><span class=p>(</span><span class=n>poolSize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>connections</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Connection</span><span class=o>[</span><span class=n>poolSize</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>states</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicIntegerArray</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>poolSize</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MockConnection</span><span class=p>(</span><span class=s>&#34;è¿æ¥&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 5. å€Ÿè¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=nf>borrow</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=c1>// t1, t2, t3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å–è®¸å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>semaphore</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w> </span><span class=c1>// æ²¡æœ‰è®¸å¯çš„çº¿ç¨‹ï¼Œåœ¨æ­¤ç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è·å–ç©ºé—²è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>states</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>states</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;borrow {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 6. å½’è¿˜è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>free</span><span class=p>(</span><span class=n>Connection</span><span class=w> </span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>poolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>connections</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>conn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>states</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;free {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>semaphore</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=font-colorblue-semaphore-åŸç†font><a href=#font-colorblue-semaphore-%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>* Semaphore åŸç†</font></h3><h4 id=åŠ é”è§£é”æµç¨‹-1><a href=#%e5%8a%a0%e9%94%81%e8%a7%a3%e9%94%81%e6%b5%81%e7%a8%8b-1 class=header-anchor>#</a>
åŠ é”è§£é”æµç¨‹</h4><p>Semaphoreæœ‰ç‚¹åƒä¸€ä¸ªåœè½¦åœºï¼Œpermitså°±å¥½åƒåœè½¦ä½æ•°é‡ï¼Œå½“çº¿ç¨‹è·å¾—äº†permitså°±åƒæ˜¯è·å¾—äº†åœè½¦ä½ï¼Œç„¶ååœè½¦åœºæ˜¾ç¤ºç©ºä½™è½¦ä½å‡ä¸€ã€‚</p><p>åˆšå¼€å§‹ï¼Œpermitsï¼ˆstateï¼‰ä¸º 3ï¼Œè¿™æ—¶ 5 ä¸ªçº¿ç¨‹æ¥è·å–èµ„æº</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220315211610470.png width=900 height=600 loading=lazy decoding=async alt=image-20220315211610470 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å‡è®¾å…¶ä¸­ Thread-1ï¼ŒThread-2ï¼ŒThread-4 cas ç«äº‰æˆåŠŸï¼Œè€Œ Thread-0 å’Œ Thread-3 ç«äº‰å¤±è´¥ï¼Œè¿›å…¥ AQS é˜Ÿåˆ— park é˜»å¡</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220315211646132.png width=900 height=600 loading=lazy decoding=async alt=image-20220315211646132 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>è¿™æ—¶ Thread-4 é‡Šæ”¾äº† permitsï¼ŒçŠ¶æ€å¦‚ä¸‹</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220315211712384.png width=900 height=600 loading=lazy decoding=async alt=image-20220315211712384 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>æ¥ä¸‹æ¥ Thread-0 ç«äº‰æˆåŠŸï¼Œpermits å†æ¬¡è®¾ç½®ä¸º 0ï¼Œè®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹ï¼Œæ–­å¼€åŸæ¥çš„ head èŠ‚ç‚¹ï¼Œunpark æ¥ ä¸‹æ¥çš„ Thread-3 èŠ‚ç‚¹ï¼Œä½†ç”±äº permits æ˜¯ 0ï¼Œå› æ­¤ Thread-3 åœ¨å°è¯•ä¸æˆåŠŸåå†æ¬¡è¿›å…¥ park çŠ¶æ€</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220315211741166.png width=900 height=600 loading=lazy decoding=async alt=image-20220315211741166 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=æºç åˆ†æ-1><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-1 class=header-anchor>#</a>
æºç åˆ†æ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-447-1><a class=lnlinks href=#hl-447-1>  1</a>
</span><span class=lnt id=hl-447-2><a class=lnlinks href=#hl-447-2>  2</a>
</span><span class=lnt id=hl-447-3><a class=lnlinks href=#hl-447-3>  3</a>
</span><span class=lnt id=hl-447-4><a class=lnlinks href=#hl-447-4>  4</a>
</span><span class=lnt id=hl-447-5><a class=lnlinks href=#hl-447-5>  5</a>
</span><span class=lnt id=hl-447-6><a class=lnlinks href=#hl-447-6>  6</a>
</span><span class=lnt id=hl-447-7><a class=lnlinks href=#hl-447-7>  7</a>
</span><span class=lnt id=hl-447-8><a class=lnlinks href=#hl-447-8>  8</a>
</span><span class=lnt id=hl-447-9><a class=lnlinks href=#hl-447-9>  9</a>
</span><span class=lnt id=hl-447-10><a class=lnlinks href=#hl-447-10> 10</a>
</span><span class=lnt id=hl-447-11><a class=lnlinks href=#hl-447-11> 11</a>
</span><span class=lnt id=hl-447-12><a class=lnlinks href=#hl-447-12> 12</a>
</span><span class=lnt id=hl-447-13><a class=lnlinks href=#hl-447-13> 13</a>
</span><span class=lnt id=hl-447-14><a class=lnlinks href=#hl-447-14> 14</a>
</span><span class=lnt id=hl-447-15><a class=lnlinks href=#hl-447-15> 15</a>
</span><span class=lnt id=hl-447-16><a class=lnlinks href=#hl-447-16> 16</a>
</span><span class=lnt id=hl-447-17><a class=lnlinks href=#hl-447-17> 17</a>
</span><span class=lnt id=hl-447-18><a class=lnlinks href=#hl-447-18> 18</a>
</span><span class=lnt id=hl-447-19><a class=lnlinks href=#hl-447-19> 19</a>
</span><span class=lnt id=hl-447-20><a class=lnlinks href=#hl-447-20> 20</a>
</span><span class=lnt id=hl-447-21><a class=lnlinks href=#hl-447-21> 21</a>
</span><span class=lnt id=hl-447-22><a class=lnlinks href=#hl-447-22> 22</a>
</span><span class=lnt id=hl-447-23><a class=lnlinks href=#hl-447-23> 23</a>
</span><span class=lnt id=hl-447-24><a class=lnlinks href=#hl-447-24> 24</a>
</span><span class=lnt id=hl-447-25><a class=lnlinks href=#hl-447-25> 25</a>
</span><span class=lnt id=hl-447-26><a class=lnlinks href=#hl-447-26> 26</a>
</span><span class=lnt id=hl-447-27><a class=lnlinks href=#hl-447-27> 27</a>
</span><span class=lnt id=hl-447-28><a class=lnlinks href=#hl-447-28> 28</a>
</span><span class=lnt id=hl-447-29><a class=lnlinks href=#hl-447-29> 29</a>
</span><span class=lnt id=hl-447-30><a class=lnlinks href=#hl-447-30> 30</a>
</span><span class=lnt id=hl-447-31><a class=lnlinks href=#hl-447-31> 31</a>
</span><span class=lnt id=hl-447-32><a class=lnlinks href=#hl-447-32> 32</a>
</span><span class=lnt id=hl-447-33><a class=lnlinks href=#hl-447-33> 33</a>
</span><span class=lnt id=hl-447-34><a class=lnlinks href=#hl-447-34> 34</a>
</span><span class=lnt id=hl-447-35><a class=lnlinks href=#hl-447-35> 35</a>
</span><span class=lnt id=hl-447-36><a class=lnlinks href=#hl-447-36> 36</a>
</span><span class=lnt id=hl-447-37><a class=lnlinks href=#hl-447-37> 37</a>
</span><span class=lnt id=hl-447-38><a class=lnlinks href=#hl-447-38> 38</a>
</span><span class=lnt id=hl-447-39><a class=lnlinks href=#hl-447-39> 39</a>
</span><span class=lnt id=hl-447-40><a class=lnlinks href=#hl-447-40> 40</a>
</span><span class=lnt id=hl-447-41><a class=lnlinks href=#hl-447-41> 41</a>
</span><span class=lnt id=hl-447-42><a class=lnlinks href=#hl-447-42> 42</a>
</span><span class=lnt id=hl-447-43><a class=lnlinks href=#hl-447-43> 43</a>
</span><span class=lnt id=hl-447-44><a class=lnlinks href=#hl-447-44> 44</a>
</span><span class=lnt id=hl-447-45><a class=lnlinks href=#hl-447-45> 45</a>
</span><span class=lnt id=hl-447-46><a class=lnlinks href=#hl-447-46> 46</a>
</span><span class=lnt id=hl-447-47><a class=lnlinks href=#hl-447-47> 47</a>
</span><span class=lnt id=hl-447-48><a class=lnlinks href=#hl-447-48> 48</a>
</span><span class=lnt id=hl-447-49><a class=lnlinks href=#hl-447-49> 49</a>
</span><span class=lnt id=hl-447-50><a class=lnlinks href=#hl-447-50> 50</a>
</span><span class=lnt id=hl-447-51><a class=lnlinks href=#hl-447-51> 51</a>
</span><span class=lnt id=hl-447-52><a class=lnlinks href=#hl-447-52> 52</a>
</span><span class=lnt id=hl-447-53><a class=lnlinks href=#hl-447-53> 53</a>
</span><span class=lnt id=hl-447-54><a class=lnlinks href=#hl-447-54> 54</a>
</span><span class=lnt id=hl-447-55><a class=lnlinks href=#hl-447-55> 55</a>
</span><span class=lnt id=hl-447-56><a class=lnlinks href=#hl-447-56> 56</a>
</span><span class=lnt id=hl-447-57><a class=lnlinks href=#hl-447-57> 57</a>
</span><span class=lnt id=hl-447-58><a class=lnlinks href=#hl-447-58> 58</a>
</span><span class=lnt id=hl-447-59><a class=lnlinks href=#hl-447-59> 59</a>
</span><span class=lnt id=hl-447-60><a class=lnlinks href=#hl-447-60> 60</a>
</span><span class=lnt id=hl-447-61><a class=lnlinks href=#hl-447-61> 61</a>
</span><span class=lnt id=hl-447-62><a class=lnlinks href=#hl-447-62> 62</a>
</span><span class=lnt id=hl-447-63><a class=lnlinks href=#hl-447-63> 63</a>
</span><span class=lnt id=hl-447-64><a class=lnlinks href=#hl-447-64> 64</a>
</span><span class=lnt id=hl-447-65><a class=lnlinks href=#hl-447-65> 65</a>
</span><span class=lnt id=hl-447-66><a class=lnlinks href=#hl-447-66> 66</a>
</span><span class=lnt id=hl-447-67><a class=lnlinks href=#hl-447-67> 67</a>
</span><span class=lnt id=hl-447-68><a class=lnlinks href=#hl-447-68> 68</a>
</span><span class=lnt id=hl-447-69><a class=lnlinks href=#hl-447-69> 69</a>
</span><span class=lnt id=hl-447-70><a class=lnlinks href=#hl-447-70> 70</a>
</span><span class=lnt id=hl-447-71><a class=lnlinks href=#hl-447-71> 71</a>
</span><span class=lnt id=hl-447-72><a class=lnlinks href=#hl-447-72> 72</a>
</span><span class=lnt id=hl-447-73><a class=lnlinks href=#hl-447-73> 73</a>
</span><span class=lnt id=hl-447-74><a class=lnlinks href=#hl-447-74> 74</a>
</span><span class=lnt id=hl-447-75><a class=lnlinks href=#hl-447-75> 75</a>
</span><span class=lnt id=hl-447-76><a class=lnlinks href=#hl-447-76> 76</a>
</span><span class=lnt id=hl-447-77><a class=lnlinks href=#hl-447-77> 77</a>
</span><span class=lnt id=hl-447-78><a class=lnlinks href=#hl-447-78> 78</a>
</span><span class=lnt id=hl-447-79><a class=lnlinks href=#hl-447-79> 79</a>
</span><span class=lnt id=hl-447-80><a class=lnlinks href=#hl-447-80> 80</a>
</span><span class=lnt id=hl-447-81><a class=lnlinks href=#hl-447-81> 81</a>
</span><span class=lnt id=hl-447-82><a class=lnlinks href=#hl-447-82> 82</a>
</span><span class=lnt id=hl-447-83><a class=lnlinks href=#hl-447-83> 83</a>
</span><span class=lnt id=hl-447-84><a class=lnlinks href=#hl-447-84> 84</a>
</span><span class=lnt id=hl-447-85><a class=lnlinks href=#hl-447-85> 85</a>
</span><span class=lnt id=hl-447-86><a class=lnlinks href=#hl-447-86> 86</a>
</span><span class=lnt id=hl-447-87><a class=lnlinks href=#hl-447-87> 87</a>
</span><span class=lnt id=hl-447-88><a class=lnlinks href=#hl-447-88> 88</a>
</span><span class=lnt id=hl-447-89><a class=lnlinks href=#hl-447-89> 89</a>
</span><span class=lnt id=hl-447-90><a class=lnlinks href=#hl-447-90> 90</a>
</span><span class=lnt id=hl-447-91><a class=lnlinks href=#hl-447-91> 91</a>
</span><span class=lnt id=hl-447-92><a class=lnlinks href=#hl-447-92> 92</a>
</span><span class=lnt id=hl-447-93><a class=lnlinks href=#hl-447-93> 93</a>
</span><span class=lnt id=hl-447-94><a class=lnlinks href=#hl-447-94> 94</a>
</span><span class=lnt id=hl-447-95><a class=lnlinks href=#hl-447-95> 95</a>
</span><span class=lnt id=hl-447-96><a class=lnlinks href=#hl-447-96> 96</a>
</span><span class=lnt id=hl-447-97><a class=lnlinks href=#hl-447-97> 97</a>
</span><span class=lnt id=hl-447-98><a class=lnlinks href=#hl-447-98> 98</a>
</span><span class=lnt id=hl-447-99><a class=lnlinks href=#hl-447-99> 99</a>
</span><span class=lnt id=hl-447-100><a class=lnlinks href=#hl-447-100>100</a>
</span><span class=lnt id=hl-447-101><a class=lnlinks href=#hl-447-101>101</a>
</span><span class=lnt id=hl-447-102><a class=lnlinks href=#hl-447-102>102</a>
</span><span class=lnt id=hl-447-103><a class=lnlinks href=#hl-447-103>103</a>
</span><span class=lnt id=hl-447-104><a class=lnlinks href=#hl-447-104>104</a>
</span><span class=lnt id=hl-447-105><a class=lnlinks href=#hl-447-105>105</a>
</span><span class=lnt id=hl-447-106><a class=lnlinks href=#hl-447-106>106</a>
</span><span class=lnt id=hl-447-107><a class=lnlinks href=#hl-447-107>107</a>
</span><span class=lnt id=hl-447-108><a class=lnlinks href=#hl-447-108>108</a>
</span><span class=lnt id=hl-447-109><a class=lnlinks href=#hl-447-109>109</a>
</span><span class=lnt id=hl-447-110><a class=lnlinks href=#hl-447-110>110</a>
</span><span class=lnt id=hl-447-111><a class=lnlinks href=#hl-447-111>111</a>
</span><span class=lnt id=hl-447-112><a class=lnlinks href=#hl-447-112>112</a>
</span><span class=lnt id=hl-447-113><a class=lnlinks href=#hl-447-113>113</a>
</span><span class=lnt id=hl-447-114><a class=lnlinks href=#hl-447-114>114</a>
</span><span class=lnt id=hl-447-115><a class=lnlinks href=#hl-447-115>115</a>
</span><span class=lnt id=hl-447-116><a class=lnlinks href=#hl-447-116>116</a>
</span><span class=lnt id=hl-447-117><a class=lnlinks href=#hl-447-117>117</a>
</span><span class=lnt id=hl-447-118><a class=lnlinks href=#hl-447-118>118</a>
</span><span class=lnt id=hl-447-119><a class=lnlinks href=#hl-447-119>119</a>
</span><span class=lnt id=hl-447-120><a class=lnlinks href=#hl-447-120>120</a>
</span><span class=lnt id=hl-447-121><a class=lnlinks href=#hl-447-121>121</a>
</span><span class=lnt id=hl-447-122><a class=lnlinks href=#hl-447-122>122</a>
</span><span class=lnt id=hl-447-123><a class=lnlinks href=#hl-447-123>123</a>
</span><span class=lnt id=hl-447-124><a class=lnlinks href=#hl-447-124>124</a>
</span><span class=lnt id=hl-447-125><a class=lnlinks href=#hl-447-125>125</a>
</span><span class=lnt id=hl-447-126><a class=lnlinks href=#hl-447-126>126</a>
</span><span class=lnt id=hl-447-127><a class=lnlinks href=#hl-447-127>127</a>
</span><span class=lnt id=hl-447-128><a class=lnlinks href=#hl-447-128>128</a>
</span><span class=lnt id=hl-447-129><a class=lnlinks href=#hl-447-129>129</a>
</span><span class=lnt id=hl-447-130><a class=lnlinks href=#hl-447-130>130</a>
</span><span class=lnt id=hl-447-131><a class=lnlinks href=#hl-447-131>131</a>
</span><span class=lnt id=hl-447-132><a class=lnlinks href=#hl-447-132>132</a>
</span><span class=lnt id=hl-447-133><a class=lnlinks href=#hl-447-133>133</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>NonfairSync</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>2694183684443567898L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NonfairSync</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>permits</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// permits å³ state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>permits</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Semaphore æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>acquireSharedInterruptibly</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquireSharedInterruptibly</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>interrupted</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryAcquireShared</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doAcquireSharedInterruptibly</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°è¯•è·å¾—å…±äº«é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>tryAcquireShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>nonfairTryAcquireShared</span><span class=p>(</span><span class=n>acquires</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>nonfairTryAcquireShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>acquires</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>available</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>remaining</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>available</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>acquires</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å¦‚æœè®¸å¯å·²ç»ç”¨å®Œ, è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–å¤±è´¥, è¿›å…¥ doAcquireSharedInterruptibly</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>remaining</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å¦‚æœ cas é‡è¯•æˆåŠŸ, è¿”å›æ­£æ•°, è¡¨ç¤ºè·å–æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>available</span><span class=p>,</span><span class=w> </span><span class=n>remaining</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>remaining</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doAcquireSharedInterruptibly</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addWaiter</span><span class=p>(</span><span class=n>Node</span><span class=p>.</span><span class=na>SHARED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>predecessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å†æ¬¡å°è¯•è·å–è®¸å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tryAcquireShared</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// æˆåŠŸåæœ¬çº¿ç¨‹å‡ºé˜Ÿï¼ˆAQSï¼‰, æ‰€åœ¨ Nodeè®¾ç½®ä¸º head</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// r è¡¨ç¤ºå¯ç”¨èµ„æºæ•°, ä¸º 0 åˆ™ä¸ä¼šç»§ç»­ä¼ æ’­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>setHeadAndPropagate</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// help GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>failed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ä¸æˆåŠŸ, è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹ waitStatus = Node.SIGNAL, ä¸‹è½®è¿›å…¥ park é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldParkAfterFailedAcquire</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>parkAndCheckInterrupt</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>failed</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cancelAcquire</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Semaphore æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>release</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sync</span><span class=p>.</span><span class=na>releaseShared</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>releaseShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tryReleaseShared</span><span class=p>(</span><span class=n>arg</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doReleaseShared</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>tryReleaseShared</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>releases</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>releases</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>current</span><span class=p>)</span><span class=w> </span><span class=c1>// overflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Error</span><span class=p>(</span><span class=s>&#34;Maximum permit count exceeded&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compareAndSetState</span><span class=p>(</span><span class=n>current</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setHeadAndPropagate</span><span class=p>(</span><span class=n>Node</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>propagate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w> </span><span class=c1>// Record old head for check below</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è®¾ç½®è‡ªå·±ä¸º head</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>setHead</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åŸ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç°åœ¨ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>propagate</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>isShared</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doReleaseShared</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doReleaseShared</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>tail</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>ws</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>waitStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>SIGNAL</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w>            </span><span class=c1>// loop to recheck cases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unparkSuccessor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ws</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=o>!</span><span class=n>compareAndSetWaitStatus</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=p>.</span><span class=na>PROPAGATE</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>continue</span><span class=p>;</span><span class=w>                </span><span class=c1>// loop on failed CAS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>head</span><span class=p>)</span><span class=w>                   </span><span class=c1>// loop if head changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=åŠ é”æµç¨‹æ€»ç»“><a href=#%e5%8a%a0%e9%94%81%e6%b5%81%e7%a8%8b%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
åŠ é”æµç¨‹æ€»ç»“ï¼š</h5><ul><li><code>acquire</code>-><code>acquireSharedInterruptibly(1)</code>-><code>tryAcquireShared(1)</code>-><code>nonfairTryAcquireShared(1)</code>,å¦‚æœèµ„æºç”¨å®Œäº†ï¼Œè¿”å›è´Ÿæ•°ï¼Œ<code>tryAcquireShared</code>è¿”å›è´Ÿæ•°ï¼Œè¡¨ç¤ºå¤±è´¥ã€‚å¦åˆ™è¿”å›æ­£æ•°ï¼Œ<code>tryAcquireShared</code>è¿”å›æ­£æ•°,è¡¨ç¤ºæˆåŠŸã€‚<ul><li>å¦‚æœæˆåŠŸï¼Œè·å–ä¿¡å·é‡æˆåŠŸã€‚</li><li>å¦‚æœå¤±è´¥ï¼Œè°ƒç”¨<code>doAcquireSharedInterruptibly</code>,è¿›å…¥forå¾ªç¯ï¼š<ul><li>å¦‚æœå½“å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ï¼Œè°ƒç”¨<code>tryAcquireShared</code>å°è¯•è·å–é”<ul><li>å¦‚æœç»“æœå¤§äºç­‰äº0ï¼Œè¡¨æ˜è·å–é”æˆåŠŸï¼Œè°ƒç”¨<code>setHeadAndPropagate</code>ï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºå¤´èŠ‚ç‚¹ï¼Œä¹‹ååˆè°ƒç”¨<code>doReleaseShared</code>ï¼Œå”¤é†’åç»§èŠ‚ç‚¹ã€‚</li></ul></li><li>è°ƒç”¨<code>shoudParkAfterFailure</code>,ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›falseï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ”¹ä¸º-1ï¼Œç¬¬äºŒæ¬¡å¾ªç¯å¦‚æœå†è¿›å…¥æ­¤æ–¹æ³•ï¼Œä¼šè¿›å…¥é˜»å¡å¹¶æ£€æŸ¥æ‰“æ–­çš„æ–¹æ³•ã€‚</li></ul></li></ul></li></ul><h5 id=è§£é”æµç¨‹æ€»ç»“><a href=#%e8%a7%a3%e9%94%81%e6%b5%81%e7%a8%8b%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
è§£é”æµç¨‹æ€»ç»“ï¼š</h5><ul><li><code>release</code>-><code>sync.releaseShared(1)</code>-><code>tryReleaseShared(1)</code>,åªè¦ä¸å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Œå°±è¿”å›true<ul><li>å¦‚æœè¿”å›trueï¼Œè°ƒç”¨<code>doReleaseShared</code>ï¼Œå”¤é†’åç»§èŠ‚ç‚¹ã€‚</li><li>å¦‚æœè¿”å›falseï¼Œè§£é”å¤±è´¥ã€‚</li></ul></li></ul><h4 id=ä¸ºä»€ä¹ˆè¦æœ‰-propagate><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e6%9c%89-propagate class=header-anchor>#</a>
ä¸ºä»€ä¹ˆè¦æœ‰ PROPAGATE</h4><h2 id=countdownlatch><a href=#countdownlatch class=header-anchor>#</a>
CountdownLatch</h2><p>ç”¨æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥åä½œï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆå€’è®¡æ—¶ã€‚</p><p>å…¶ä¸­æ„é€ å‚æ•°ç”¨æ¥åˆå§‹åŒ–ç­‰å¾…è®¡æ•°å€¼ï¼Œawait() ç”¨æ¥ç­‰å¾…è®¡æ•°å½’é›¶ï¼ŒcountDown() ç”¨æ¥è®©è®¡æ•°å‡ä¸€</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-448-1><a class=lnlinks href=#hl-448-1> 1</a>
</span><span class=lnt id=hl-448-2><a class=lnlinks href=#hl-448-2> 2</a>
</span><span class=lnt id=hl-448-3><a class=lnlinks href=#hl-448-3> 3</a>
</span><span class=lnt id=hl-448-4><a class=lnlinks href=#hl-448-4> 4</a>
</span><span class=lnt id=hl-448-5><a class=lnlinks href=#hl-448-5> 5</a>
</span><span class=lnt id=hl-448-6><a class=lnlinks href=#hl-448-6> 6</a>
</span><span class=lnt id=hl-448-7><a class=lnlinks href=#hl-448-7> 7</a>
</span><span class=lnt id=hl-448-8><a class=lnlinks href=#hl-448-8> 8</a>
</span><span class=lnt id=hl-448-9><a class=lnlinks href=#hl-448-9> 9</a>
</span><span class=lnt id=hl-448-10><a class=lnlinks href=#hl-448-10>10</a>
</span><span class=lnt id=hl-448-11><a class=lnlinks href=#hl-448-11>11</a>
</span><span class=lnt id=hl-448-12><a class=lnlinks href=#hl-448-12>12</a>
</span><span class=lnt id=hl-448-13><a class=lnlinks href=#hl-448-13>13</a>
</span><span class=lnt id=hl-448-14><a class=lnlinks href=#hl-448-14>14</a>
</span><span class=lnt id=hl-448-15><a class=lnlinks href=#hl-448-15>15</a>
</span><span class=lnt id=hl-448-16><a class=lnlinks href=#hl-448-16>16</a>
</span><span class=lnt id=hl-448-17><a class=lnlinks href=#hl-448-17>17</a>
</span><span class=lnt id=hl-448-18><a class=lnlinks href=#hl-448-18>18</a>
</span><span class=lnt id=hl-448-19><a class=lnlinks href=#hl-448-19>19</a>
</span><span class=lnt id=hl-448-20><a class=lnlinks href=#hl-448-20>20</a>
</span><span class=lnt id=hl-448-21><a class=lnlinks href=#hl-448-21>21</a>
</span><span class=lnt id=hl-448-22><a class=lnlinks href=#hl-448-22>22</a>
</span><span class=lnt id=hl-448-23><a class=lnlinks href=#hl-448-23>23</a>
</span><span class=lnt id=hl-448-24><a class=lnlinks href=#hl-448-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>latch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;waiting...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>latch</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;wait end...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-449-1><a class=lnlinks href=#hl-449-1>1</a>
</span><span class=lnt id=hl-449-2><a class=lnlinks href=#hl-449-2>2</a>
</span><span class=lnt id=hl-449-3><a class=lnlinks href=#hl-449-3>3</a>
</span><span class=lnt id=hl-449-4><a class=lnlinks href=#hl-449-4>4</a>
</span><span class=lnt id=hl-449-5><a class=lnlinks href=#hl-449-5>5</a>
</span><span class=lnt id=hl-449-6><a class=lnlinks href=#hl-449-6>6</a>
</span><span class=lnt id=hl-449-7><a class=lnlinks href=#hl-449-7>7</a>
</span><span class=lnt id=hl-449-8><a class=lnlinks href=#hl-449-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>18:44:00.778 c.TestCountDownLatch <span class=o>[</span>main<span class=o>]</span> - waiting... 
</span></span><span class=line><span class=cl>18:44:00.778 c.TestCountDownLatch <span class=o>[</span>Thread-2<span class=o>]</span> - begin... 
</span></span><span class=line><span class=cl>18:44:00.778 c.TestCountDownLatch <span class=o>[</span>Thread-0<span class=o>]</span> - begin... 
</span></span><span class=line><span class=cl>18:44:00.778 c.TestCountDownLatch <span class=o>[</span>Thread-1<span class=o>]</span> - begin... 
</span></span><span class=line><span class=cl>18:44:01.782 c.TestCountDownLatch <span class=o>[</span>Thread-0<span class=o>]</span> - end...2 
</span></span><span class=line><span class=cl>18:44:02.283 c.TestCountDownLatch <span class=o>[</span>Thread-2<span class=o>]</span> - end...1 
</span></span><span class=line><span class=cl>18:44:02.782 c.TestCountDownLatch <span class=o>[</span>Thread-1<span class=o>]</span> - end...0 
</span></span><span class=line><span class=cl>18:44:02.782 c.TestCountDownLatch <span class=o>[</span>main<span class=o>]</span> - <span class=nb>wait</span> end... 
</span></span></code></pre></td></tr></table></div></div><p>ç›¸æ¯”äºjoinï¼ŒCountDownLatchèƒ½é…åˆçº¿ç¨‹æ± ä½¿ç”¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-450-1><a class=lnlinks href=#hl-450-1> 1</a>
</span><span class=lnt id=hl-450-2><a class=lnlinks href=#hl-450-2> 2</a>
</span><span class=lnt id=hl-450-3><a class=lnlinks href=#hl-450-3> 3</a>
</span><span class=lnt id=hl-450-4><a class=lnlinks href=#hl-450-4> 4</a>
</span><span class=lnt id=hl-450-5><a class=lnlinks href=#hl-450-5> 5</a>
</span><span class=lnt id=hl-450-6><a class=lnlinks href=#hl-450-6> 6</a>
</span><span class=lnt id=hl-450-7><a class=lnlinks href=#hl-450-7> 7</a>
</span><span class=lnt id=hl-450-8><a class=lnlinks href=#hl-450-8> 8</a>
</span><span class=lnt id=hl-450-9><a class=lnlinks href=#hl-450-9> 9</a>
</span><span class=lnt id=hl-450-10><a class=lnlinks href=#hl-450-10>10</a>
</span><span class=lnt id=hl-450-11><a class=lnlinks href=#hl-450-11>11</a>
</span><span class=lnt id=hl-450-12><a class=lnlinks href=#hl-450-12>12</a>
</span><span class=lnt id=hl-450-13><a class=lnlinks href=#hl-450-13>13</a>
</span><span class=lnt id=hl-450-14><a class=lnlinks href=#hl-450-14>14</a>
</span><span class=lnt id=hl-450-15><a class=lnlinks href=#hl-450-15>15</a>
</span><span class=lnt id=hl-450-16><a class=lnlinks href=#hl-450-16>16</a>
</span><span class=lnt id=hl-450-17><a class=lnlinks href=#hl-450-17>17</a>
</span><span class=lnt id=hl-450-18><a class=lnlinks href=#hl-450-18>18</a>
</span><span class=lnt id=hl-450-19><a class=lnlinks href=#hl-450-19>19</a>
</span><span class=lnt id=hl-450-20><a class=lnlinks href=#hl-450-20>20</a>
</span><span class=lnt id=hl-450-21><a class=lnlinks href=#hl-450-21>21</a>
</span><span class=lnt id=hl-450-22><a class=lnlinks href=#hl-450-22>22</a>
</span><span class=lnt id=hl-450-23><a class=lnlinks href=#hl-450-23>23</a>
</span><span class=lnt id=hl-450-24><a class=lnlinks href=#hl-450-24>24</a>
</span><span class=lnt id=hl-450-25><a class=lnlinks href=#hl-450-25>25</a>
</span><span class=lnt id=hl-450-26><a class=lnlinks href=#hl-450-26>26</a>
</span><span class=lnt id=hl-450-27><a class=lnlinks href=#hl-450-27>27</a>
</span><span class=lnt id=hl-450-28><a class=lnlinks href=#hl-450-28>28</a>
</span><span class=lnt id=hl-450-29><a class=lnlinks href=#hl-450-29>29</a>
</span><span class=lnt id=hl-450-30><a class=lnlinks href=#hl-450-30>30</a>
</span><span class=lnt id=hl-450-31><a class=lnlinks href=#hl-450-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>latch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;end...{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>latch</span><span class=p>.</span><span class=na>getCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;waiting...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>latch</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;wait end...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=font-colorgreen-åº”ç”¨ä¹‹åŒæ­¥ç­‰å¾…å¤šçº¿ç¨‹å‡†å¤‡å®Œæ¯•font><a href=#font-colorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e5%90%8c%e6%ad%a5%e7%ad%89%e5%be%85%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%87%86%e5%a4%87%e5%ae%8c%e6%af%95font class=header-anchor>#</a>
<font color=green>* åº”ç”¨ä¹‹åŒæ­¥ç­‰å¾…å¤šçº¿ç¨‹å‡†å¤‡å®Œæ¯•</font></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-451-1><a class=lnlinks href=#hl-451-1> 1</a>
</span><span class=lnt id=hl-451-2><a class=lnlinks href=#hl-451-2> 2</a>
</span><span class=lnt id=hl-451-3><a class=lnlinks href=#hl-451-3> 3</a>
</span><span class=lnt id=hl-451-4><a class=lnlinks href=#hl-451-4> 4</a>
</span><span class=lnt id=hl-451-5><a class=lnlinks href=#hl-451-5> 5</a>
</span><span class=lnt id=hl-451-6><a class=lnlinks href=#hl-451-6> 6</a>
</span><span class=lnt id=hl-451-7><a class=lnlinks href=#hl-451-7> 7</a>
</span><span class=lnt id=hl-451-8><a class=lnlinks href=#hl-451-8> 8</a>
</span><span class=lnt id=hl-451-9><a class=lnlinks href=#hl-451-9> 9</a>
</span><span class=lnt id=hl-451-10><a class=lnlinks href=#hl-451-10>10</a>
</span><span class=lnt id=hl-451-11><a class=lnlinks href=#hl-451-11>11</a>
</span><span class=lnt id=hl-451-12><a class=lnlinks href=#hl-451-12>12</a>
</span><span class=lnt id=hl-451-13><a class=lnlinks href=#hl-451-13>13</a>
</span><span class=lnt id=hl-451-14><a class=lnlinks href=#hl-451-14>14</a>
</span><span class=lnt id=hl-451-15><a class=lnlinks href=#hl-451-15>15</a>
</span><span class=lnt id=hl-451-16><a class=lnlinks href=#hl-451-16>16</a>
</span><span class=lnt id=hl-451-17><a class=lnlinks href=#hl-451-17>17</a>
</span><span class=lnt id=hl-451-18><a class=lnlinks href=#hl-451-18>18</a>
</span><span class=lnt id=hl-451-19><a class=lnlinks href=#hl-451-19>19</a>
</span><span class=lnt id=hl-451-20><a class=lnlinks href=#hl-451-20>20</a>
</span><span class=lnt id=hl-451-21><a class=lnlinks href=#hl-451-21>21</a>
</span><span class=lnt id=hl-451-22><a class=lnlinks href=#hl-451-22>22</a>
</span><span class=lnt id=hl-451-23><a class=lnlinks href=#hl-451-23>23</a>
</span><span class=lnt id=hl-451-24><a class=lnlinks href=#hl-451-24>24</a>
</span><span class=lnt id=hl-451-25><a class=lnlinks href=#hl-451-25>25</a>
</span><span class=lnt id=hl-451-26><a class=lnlinks href=#hl-451-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>AtomicInteger</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=s>&#34;t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>num</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>latch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>all</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[</span><span class=n>10</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Random</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//éšæœºä¼‘çœ ï¼Œæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>100</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>all</span><span class=o>[</span><span class=n>x</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;(&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;%&#34;</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;)&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//\rå¯ä»¥è®©å½“å‰è¾“å‡ºè¦†ç›–ä¸Šä¸€æ¬¡çš„è¾“å‡ºã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>print</span><span class=p>(</span><span class=s>&#34;\r&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>all</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>latch</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;\næ¸¸æˆå¼€å§‹...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>service</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸­é—´è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-452-1><a class=lnlinks href=#hl-452-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>t0<span class=o>(</span>52%<span class=o>)</span>, t1<span class=o>(</span>47%<span class=o>)</span>, t2<span class=o>(</span>51%<span class=o>)</span>, t3<span class=o>(</span>40%<span class=o>)</span>, t4<span class=o>(</span>49%<span class=o>)</span>, t5<span class=o>(</span>44%<span class=o>)</span>, t6<span class=o>(</span>49%<span class=o>)</span>, t7<span class=o>(</span>52%<span class=o>)</span>, t8<span class=o>(</span>46%<span class=o>)</span>, t9<span class=o>(</span>46%<span class=o>)]</span> 
</span></span></code></pre></td></tr></table></div></div><p>æœ€åè¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-453-1><a class=lnlinks href=#hl-453-1>1</a>
</span><span class=lnt id=hl-453-2><a class=lnlinks href=#hl-453-2>2</a>
</span><span class=lnt id=hl-453-3><a class=lnlinks href=#hl-453-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>t0<span class=o>(</span>100%<span class=o>)</span>, t1<span class=o>(</span>100%<span class=o>)</span>, t2<span class=o>(</span>100%<span class=o>)</span>, t3<span class=o>(</span>100%<span class=o>)</span>, t4<span class=o>(</span>100%<span class=o>)</span>, t5<span class=o>(</span>100%<span class=o>)</span>, t6<span class=o>(</span>100%<span class=o>)</span>, t7<span class=o>(</span>100%<span class=o>)</span>, t8<span class=o>(</span>100%<span class=o>)</span>, 
</span></span><span class=line><span class=cl>t9<span class=o>(</span>100%<span class=o>)]</span> 
</span></span><span class=line><span class=cl>æ¸¸æˆå¼€å§‹... 
</span></span></code></pre></td></tr></table></div></div><h3 id=font-colorgreen-åº”ç”¨ä¹‹åŒæ­¥ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸfont><a href=#font-colorgreen-%e5%ba%94%e7%94%a8%e4%b9%8b%e5%90%8c%e6%ad%a5%e7%ad%89%e5%be%85%e5%a4%9a%e4%b8%aa%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8%e7%bb%93%e6%9d%9ffont class=header-anchor>#</a>
<font color=green>* åº”ç”¨ä¹‹åŒæ­¥ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸ</font></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-454-1><a class=lnlinks href=#hl-454-1> 1</a>
</span><span class=lnt id=hl-454-2><a class=lnlinks href=#hl-454-2> 2</a>
</span><span class=lnt id=hl-454-3><a class=lnlinks href=#hl-454-3> 3</a>
</span><span class=lnt id=hl-454-4><a class=lnlinks href=#hl-454-4> 4</a>
</span><span class=lnt id=hl-454-5><a class=lnlinks href=#hl-454-5> 5</a>
</span><span class=lnt id=hl-454-6><a class=lnlinks href=#hl-454-6> 6</a>
</span><span class=lnt id=hl-454-7><a class=lnlinks href=#hl-454-7> 7</a>
</span><span class=lnt id=hl-454-8><a class=lnlinks href=#hl-454-8> 8</a>
</span><span class=lnt id=hl-454-9><a class=lnlinks href=#hl-454-9> 9</a>
</span><span class=lnt id=hl-454-10><a class=lnlinks href=#hl-454-10>10</a>
</span><span class=lnt id=hl-454-11><a class=lnlinks href=#hl-454-11>11</a>
</span><span class=lnt id=hl-454-12><a class=lnlinks href=#hl-454-12>12</a>
</span><span class=lnt id=hl-454-13><a class=lnlinks href=#hl-454-13>13</a>
</span><span class=lnt id=hl-454-14><a class=lnlinks href=#hl-454-14>14</a>
</span><span class=lnt id=hl-454-15><a class=lnlinks href=#hl-454-15>15</a>
</span><span class=lnt id=hl-454-16><a class=lnlinks href=#hl-454-16>16</a>
</span><span class=lnt id=hl-454-17><a class=lnlinks href=#hl-454-17>17</a>
</span><span class=lnt id=hl-454-18><a class=lnlinks href=#hl-454-18>18</a>
</span><span class=lnt id=hl-454-19><a class=lnlinks href=#hl-454-19>19</a>
</span><span class=lnt id=hl-454-20><a class=lnlinks href=#hl-454-20>20</a>
</span><span class=lnt id=hl-454-21><a class=lnlinks href=#hl-454-21>21</a>
</span><span class=lnt id=hl-454-22><a class=lnlinks href=#hl-454-22>22</a>
</span><span class=lnt id=hl-454-23><a class=lnlinks href=#hl-454-23>23</a>
</span><span class=lnt id=hl-454-24><a class=lnlinks href=#hl-454-24>24</a>
</span><span class=lnt id=hl-454-25><a class=lnlinks href=#hl-454-25>25</a>
</span><span class=lnt id=hl-454-26><a class=lnlinks href=#hl-454-26>26</a>
</span><span class=lnt id=hl-454-27><a class=lnlinks href=#hl-454-27>27</a>
</span><span class=lnt id=hl-454-28><a class=lnlinks href=#hl-454-28>28</a>
</span><span class=lnt id=hl-454-29><a class=lnlinks href=#hl-454-29>29</a>
</span><span class=lnt id=hl-454-30><a class=lnlinks href=#hl-454-30>30</a>
</span><span class=lnt id=hl-454-31><a class=lnlinks href=#hl-454-31>31</a>
</span><span class=lnt id=hl-454-32><a class=lnlinks href=#hl-454-32>32</a>
</span><span class=lnt id=hl-454-33><a class=lnlinks href=#hl-454-33>33</a>
</span><span class=lnt id=hl-454-34><a class=lnlinks href=#hl-454-34>34</a>
</span><span class=lnt id=hl-454-35><a class=lnlinks href=#hl-454-35>35</a>
</span><span class=lnt id=hl-454-36><a class=lnlinks href=#hl-454-36>36</a>
</span><span class=lnt id=hl-454-37><a class=lnlinks href=#hl-454-37>37</a>
</span><span class=lnt id=hl-454-38><a class=lnlinks href=#hl-454-38>38</a>
</span><span class=lnt id=hl-454-39><a class=lnlinks href=#hl-454-39>39</a>
</span><span class=lnt id=hl-454-40><a class=lnlinks href=#hl-454-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestCountDownlatchController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/order/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>order</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;total&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;2300.00&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/product/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>product</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;å°çˆ±éŸ³ç®±&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;price&#34;</span><span class=p>,</span><span class=w> </span><span class=n>300</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;å°ç±³æ‰‹æœº&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;price&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/logistics/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>logistics</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;ä¸­é€šå¿«é€’&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>2500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sleep</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>millis</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>millis</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>restè¿œç¨‹è°ƒç”¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-455-1><a class=lnlinks href=#hl-455-1> 1</a>
</span><span class=lnt id=hl-455-2><a class=lnlinks href=#hl-455-2> 2</a>
</span><span class=lnt id=hl-455-3><a class=lnlinks href=#hl-455-3> 3</a>
</span><span class=lnt id=hl-455-4><a class=lnlinks href=#hl-455-4> 4</a>
</span><span class=lnt id=hl-455-5><a class=lnlinks href=#hl-455-5> 5</a>
</span><span class=lnt id=hl-455-6><a class=lnlinks href=#hl-455-6> 6</a>
</span><span class=lnt id=hl-455-7><a class=lnlinks href=#hl-455-7> 7</a>
</span><span class=lnt id=hl-455-8><a class=lnlinks href=#hl-455-8> 8</a>
</span><span class=lnt id=hl-455-9><a class=lnlinks href=#hl-455-9> 9</a>
</span><span class=lnt id=hl-455-10><a class=lnlinks href=#hl-455-10>10</a>
</span><span class=lnt id=hl-455-11><a class=lnlinks href=#hl-455-11>11</a>
</span><span class=lnt id=hl-455-12><a class=lnlinks href=#hl-455-12>12</a>
</span><span class=lnt id=hl-455-13><a class=lnlinks href=#hl-455-13>13</a>
</span><span class=lnt id=hl-455-14><a class=lnlinks href=#hl-455-14>14</a>
</span><span class=lnt id=hl-455-15><a class=lnlinks href=#hl-455-15>15</a>
</span><span class=lnt id=hl-455-16><a class=lnlinks href=#hl-455-16>16</a>
</span><span class=lnt id=hl-455-17><a class=lnlinks href=#hl-455-17>17</a>
</span><span class=lnt id=hl-455-18><a class=lnlinks href=#hl-455-18>18</a>
</span><span class=lnt id=hl-455-19><a class=lnlinks href=#hl-455-19>19</a>
</span><span class=lnt id=hl-455-20><a class=lnlinks href=#hl-455-20>20</a>
</span><span class=lnt id=hl-455-21><a class=lnlinks href=#hl-455-21>21</a>
</span><span class=lnt id=hl-455-22><a class=lnlinks href=#hl-455-22>22</a>
</span><span class=lnt id=hl-455-23><a class=lnlinks href=#hl-455-23>23</a>
</span><span class=lnt id=hl-455-24><a class=lnlinks href=#hl-455-24>24</a>
</span><span class=lnt id=hl-455-25><a class=lnlinks href=#hl-455-25>25</a>
</span><span class=lnt id=hl-455-26><a class=lnlinks href=#hl-455-26>26</a>
</span><span class=lnt id=hl-455-27><a class=lnlinks href=#hl-455-27>27</a>
</span><span class=lnt id=hl-455-28><a class=lnlinks href=#hl-455-28>28</a>
</span><span class=lnt id=hl-455-29><a class=lnlinks href=#hl-455-29>29</a>
</span><span class=lnt id=hl-455-30><a class=lnlinks href=#hl-455-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RestTemplate</span><span class=w> </span><span class=n>restTemplate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RestTemplate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;begin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newCachedThreadPool</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>latch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>f1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>restTemplate</span><span class=p>.</span><span class=na>getForObject</span><span class=p>(</span><span class=s>&#34;http://localhost:8080/order/{1}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>f2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>restTemplate</span><span class=p>.</span><span class=na>getForObject</span><span class=p>(</span><span class=s>&#34;http://localhost:8080/product/{1}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>f3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>restTemplate</span><span class=p>.</span><span class=na>getForObject</span><span class=p>(</span><span class=s>&#34;http://localhost:8080/product/{1}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>f4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>restTemplate</span><span class=p>.</span><span class=na>getForObject</span><span class=p>(</span><span class=s>&#34;http://localhost:8080/logistics/{1}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>f1</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>f2</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>f3</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>f4</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;æ‰§è¡Œå®Œæ¯•&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>service</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-456-1><a class=lnlinks href=#hl-456-1>1</a>
</span><span class=lnt id=hl-456-2><a class=lnlinks href=#hl-456-2>2</a>
</span><span class=lnt id=hl-456-3><a class=lnlinks href=#hl-456-3>3</a>
</span><span class=lnt id=hl-456-4><a class=lnlinks href=#hl-456-4>4</a>
</span><span class=lnt id=hl-456-5><a class=lnlinks href=#hl-456-5>5</a>
</span><span class=lnt id=hl-456-6><a class=lnlinks href=#hl-456-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>19:51:39.711 c.TestCountDownLatch <span class=o>[</span>main<span class=o>]</span> - begin 
</span></span><span class=line><span class=cl><span class=o>{</span><span class=nv>total</span><span class=o>=</span>2300.00, <span class=nv>id</span><span class=o>=</span>1<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>{</span><span class=nv>price</span><span class=o>=</span>300, <span class=nv>name</span><span class=o>=</span>å°çˆ±éŸ³ç®±, <span class=nv>id</span><span class=o>=</span>1<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>{</span><span class=nv>price</span><span class=o>=</span>2000, <span class=nv>name</span><span class=o>=</span>å°ç±³æ‰‹æœº, <span class=nv>id</span><span class=o>=</span>2<span class=o>}</span> 
</span></span><span class=line><span class=cl><span class=o>{</span><span class=nv>name</span><span class=o>=</span>ä¸­é€šå¿«é€’, <span class=nv>id</span><span class=o>=</span>1<span class=o>}</span> 
</span></span><span class=line><span class=cl>19:51:42.407 c.TestCountDownLatch <span class=o>[</span>main<span class=o>]</span> - æ‰§è¡Œå®Œæ¯•
</span></span></code></pre></td></tr></table></div></div><p>è¯´æ˜ï¼š</p><ul><li>è¿™ç§ç­‰å¾…å¤šä¸ªå¸¦æœ‰è¿”å›å€¼çš„ä»»åŠ¡çš„åœºæ™¯ï¼Œè¿˜æ˜¯ç”¨futureæ¯”è¾ƒåˆé€‚ï¼ŒCountdownLatché€‚åˆä»»åŠ¡æ²¡æœ‰è¿”å›å€¼çš„åœºæ™¯ã€‚</li></ul><h2 id=cyclicbarrier><a href=#cyclicbarrier class=header-anchor>#</a>
CyclicBarrier</h2><p>CountdownLatchçš„ç¼ºç‚¹åœ¨äºä¸èƒ½é‡ç”¨ï¼Œè§ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-457-1><a class=lnlinks href=#hl-457-1> 1</a>
</span><span class=lnt id=hl-457-2><a class=lnlinks href=#hl-457-2> 2</a>
</span><span class=lnt id=hl-457-3><a class=lnlinks href=#hl-457-3> 3</a>
</span><span class=lnt id=hl-457-4><a class=lnlinks href=#hl-457-4> 4</a>
</span><span class=lnt id=hl-457-5><a class=lnlinks href=#hl-457-5> 5</a>
</span><span class=lnt id=hl-457-6><a class=lnlinks href=#hl-457-6> 6</a>
</span><span class=lnt id=hl-457-7><a class=lnlinks href=#hl-457-7> 7</a>
</span><span class=lnt id=hl-457-8><a class=lnlinks href=#hl-457-8> 8</a>
</span><span class=lnt id=hl-457-9><a class=lnlinks href=#hl-457-9> 9</a>
</span><span class=lnt id=hl-457-10><a class=lnlinks href=#hl-457-10>10</a>
</span><span class=lnt id=hl-457-11><a class=lnlinks href=#hl-457-11>11</a>
</span><span class=lnt id=hl-457-12><a class=lnlinks href=#hl-457-12>12</a>
</span><span class=lnt id=hl-457-13><a class=lnlinks href=#hl-457-13>13</a>
</span><span class=lnt id=hl-457-14><a class=lnlinks href=#hl-457-14>14</a>
</span><span class=lnt id=hl-457-15><a class=lnlinks href=#hl-457-15>15</a>
</span><span class=lnt id=hl-457-16><a class=lnlinks href=#hl-457-16>16</a>
</span><span class=lnt id=hl-457-17><a class=lnlinks href=#hl-457-17>17</a>
</span><span class=lnt id=hl-457-18><a class=lnlinks href=#hl-457-18>18</a>
</span><span class=lnt id=hl-457-19><a class=lnlinks href=#hl-457-19>19</a>
</span><span class=lnt id=hl-457-20><a class=lnlinks href=#hl-457-20>20</a>
</span><span class=lnt id=hl-457-21><a class=lnlinks href=#hl-457-21>21</a>
</span><span class=lnt id=hl-457-22><a class=lnlinks href=#hl-457-22>22</a>
</span><span class=lnt id=hl-457-23><a class=lnlinks href=#hl-457-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>latch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task1 start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task2 start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>latch</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;task1 task2 finish...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>service</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æƒ³è¦é‡å¤ä½¿ç”¨CountdownLatchè¿›è¡ŒåŒæ­¥ï¼Œå¿…é¡»åˆ›å»ºå¤šä¸ªCountDownLatchå¯¹è±¡ã€‚</p><p>[ËˆsaÉªklÉªk ËˆbÃ¦riÉš] å¾ªç¯æ …æ ï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åä½œï¼Œç­‰å¾…çº¿ç¨‹æ»¡è¶³æŸä¸ªè®¡æ•°ã€‚æ„é€ æ—¶è®¾ç½®ã€è®¡æ•°ä¸ªæ•°ã€ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§ è¡Œåˆ°æŸä¸ªéœ€è¦â€œåŒæ­¥â€çš„æ—¶åˆ»è°ƒç”¨ await() æ–¹æ³•è¿›è¡Œç­‰å¾…ï¼Œå½“ç­‰å¾…çš„çº¿ç¨‹æ•°æ»¡è¶³ã€è®¡æ•°ä¸ªæ•°ã€æ—¶ï¼Œç»§ç»­æ‰§è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-458-1><a class=lnlinks href=#hl-458-1> 1</a>
</span><span class=lnt id=hl-458-2><a class=lnlinks href=#hl-458-2> 2</a>
</span><span class=lnt id=hl-458-3><a class=lnlinks href=#hl-458-3> 3</a>
</span><span class=lnt id=hl-458-4><a class=lnlinks href=#hl-458-4> 4</a>
</span><span class=lnt id=hl-458-5><a class=lnlinks href=#hl-458-5> 5</a>
</span><span class=lnt id=hl-458-6><a class=lnlinks href=#hl-458-6> 6</a>
</span><span class=lnt id=hl-458-7><a class=lnlinks href=#hl-458-7> 7</a>
</span><span class=lnt id=hl-458-8><a class=lnlinks href=#hl-458-8> 8</a>
</span><span class=lnt id=hl-458-9><a class=lnlinks href=#hl-458-9> 9</a>
</span><span class=lnt id=hl-458-10><a class=lnlinks href=#hl-458-10>10</a>
</span><span class=lnt id=hl-458-11><a class=lnlinks href=#hl-458-11>11</a>
</span><span class=lnt id=hl-458-12><a class=lnlinks href=#hl-458-12>12</a>
</span><span class=lnt id=hl-458-13><a class=lnlinks href=#hl-458-13>13</a>
</span><span class=lnt id=hl-458-14><a class=lnlinks href=#hl-458-14>14</a>
</span><span class=lnt id=hl-458-15><a class=lnlinks href=#hl-458-15>15</a>
</span><span class=lnt id=hl-458-16><a class=lnlinks href=#hl-458-16>16</a>
</span><span class=lnt id=hl-458-17><a class=lnlinks href=#hl-458-17>17</a>
</span><span class=lnt id=hl-458-18><a class=lnlinks href=#hl-458-18>18</a>
</span><span class=lnt id=hl-458-19><a class=lnlinks href=#hl-458-19>19</a>
</span><span class=lnt id=hl-458-20><a class=lnlinks href=#hl-458-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CyclicBarrier</span><span class=w> </span><span class=n>cb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CyclicBarrier</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w> </span><span class=c1>// ä¸ªæ•°ä¸º2æ—¶æ‰ä¼šç»§ç»­æ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;çº¿ç¨‹1å¼€å§‹..&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cb</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w> </span><span class=c1>// å½“ä¸ªæ•°ä¸è¶³æ—¶ï¼Œç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>BrokenBarrierException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;çº¿ç¨‹1ç»§ç»­å‘ä¸‹è¿è¡Œ...&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;çº¿ç¨‹2å¼€å§‹..&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cb</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w> </span><span class=c1>// 2 ç§’åï¼Œçº¿ç¨‹ä¸ªæ•°å¤Ÿ2ï¼Œç»§ç»­è¿è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>BrokenBarrierException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;çº¿ç¨‹2ç»§ç»­å‘ä¸‹è¿è¡Œ...&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong></p><ul><li>CyclicBarrier ä¸ CountDownLatch çš„ä¸»è¦åŒºåˆ«åœ¨äº CyclicBarrier æ˜¯å¯ä»¥é‡ç”¨çš„ CyclicBarrier å¯ä»¥è¢«æ¯” å–»ä¸ºã€äººæ»¡å‘è½¦ã€</li><li>CountDownLatchçš„è®¡æ•°å’Œé˜»å¡æ–¹æ³•æ˜¯åˆ†å¼€çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œè€ŒCyclicBarrieræ˜¯ä¸€ä¸ªæ–¹æ³•ã€‚</li><li>CyclicBarrierçš„æ„é€ å™¨è¿˜æœ‰ä¸€ä¸ªRunnableç±»å‹çš„å‚æ•°ï¼Œåœ¨è®¡æ•°ä¸º0æ—¶ä¼šæ‰§è¡Œå…¶ä¸­çš„runæ–¹æ³•ã€‚</li></ul></blockquote><h2 id=çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°><a href=#%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e9%9b%86%e5%90%88%e7%b1%bb%e6%a6%82%e8%bf%b0 class=header-anchor>#</a>
çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°</h2><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220316174115768.png width=900 height=600 loading=lazy decoding=async alt=image-20220316174115768 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>çº¿ç¨‹å®‰å…¨é›†åˆç±»å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»ï¼š</p><ul><li>é—ç•™çš„çº¿ç¨‹å®‰å…¨é›†åˆå¦‚<code>Hashtable</code>ï¼Œ<code>Vector</code></li><li>ä½¿ç”¨<code>Collections</code>è£…é¥°çš„çº¿ç¨‹å®‰å…¨é›†åˆï¼Œå¦‚ï¼š<ul><li><code>Collections.synchronizedCollection</code></li><li><code>Collections.synchronizedList</code></li><li><code>Collections.synchronizedMap</code></li><li><code>Collections.synchronizedSet</code></li><li><code>Collections.synchronizedNavigableMap</code></li><li><code>Collections.synchronizedNavigableSet</code></li><li><code>Collections.synchronizedSortedMap</code></li><li><code>Collections.synchronizedSortedSet</code></li><li>è¯´æ˜ï¼šä»¥ä¸Šé›†åˆå‡é‡‡ç”¨ä¿®é¥°æ¨¡å¼è®¾è®¡ï¼Œå°†éçº¿ç¨‹å®‰å…¨çš„é›†åˆåŒ…è£…åï¼Œåœ¨è°ƒç”¨æ–¹æ³•æ—¶åŒ…è£¹äº†ä¸€å±‚synchronizedä»£ç å—ã€‚å…¶å¹¶å‘æ€§å¹¶ä¸æ¯”é—ç•™çš„å®‰å…¨é›†åˆå¥½ã€‚</li></ul></li><li>java.util.concurrent.*</li></ul><p>é‡ç‚¹ä»‹ç»<code>java.util.concurrent.* </code>ä¸‹çš„çº¿ç¨‹å®‰å…¨é›†åˆç±»ï¼Œå¯ä»¥å‘ç°å®ƒä»¬æœ‰è§„å¾‹ï¼Œé‡Œé¢åŒ…å«ä¸‰ç±»å…³é”®è¯ï¼š Blockingã€CopyOnWriteã€Concurrent</p><ul><li>Blocking å¤§éƒ¨åˆ†å®ç°åŸºäºé”ï¼Œå¹¶æä¾›ç”¨æ¥é˜»å¡çš„æ–¹æ³•</li><li>CopyOnWrite ä¹‹ç±»å®¹å™¨ä¿®æ”¹å¼€é”€ç›¸å¯¹è¾ƒé‡</li><li>Concurrent ç±»å‹çš„å®¹å™¨<ul><li>å†…éƒ¨å¾ˆå¤šæ“ä½œä½¿ç”¨ cas ä¼˜åŒ–ï¼Œä¸€èˆ¬å¯ä»¥æä¾›è¾ƒé«˜ååé‡</li><li>å¼±ä¸€è‡´æ€§<ul><li>éå†æ—¶å¼±ä¸€è‡´æ€§ï¼Œä¾‹å¦‚ï¼Œå½“åˆ©ç”¨è¿­ä»£å™¨éå†æ—¶ï¼Œå¦‚æœå®¹å™¨å‘ç”Ÿä¿®æ”¹ï¼Œè¿­ä»£å™¨ä»ç„¶å¯ä»¥ç»§ç»­è¿›è¡Œé å†ï¼Œè¿™æ—¶å†…å®¹æ˜¯æ—§çš„</li><li>æ±‚å¤§å°å¼±ä¸€è‡´æ€§ï¼Œsize æ“ä½œæœªå¿…æ˜¯ 100% å‡†ç¡®</li><li>è¯»å–å¼±ä¸€è‡´æ€§</li></ul></li></ul></li></ul><blockquote><p>éå†æ—¶å¦‚æœå‘ç”Ÿäº†ä¿®æ”¹ï¼Œå¯¹äºéå®‰å…¨å®¹å™¨æ¥è®²ï¼Œä½¿ç”¨ <strong>fail-fast</strong> æœºåˆ¶ä¹Ÿå°±æ˜¯è®©éå†ç«‹åˆ»å¤±è´¥ï¼ŒæŠ›å‡º ConcurrentModificationExceptionï¼Œä¸å†ç»§ç»­éå†</p></blockquote><h2 id=concurrenthashmap><a href=#concurrenthashmap class=header-anchor>#</a>
ConcurrentHashMap</h2><h3 id=font-colorgreenåº”ç”¨ä¹‹å•è¯è®¡æ•°font><a href=#font-colorgreen%e5%ba%94%e7%94%a8%e4%b9%8b%e5%8d%95%e8%af%8d%e8%ae%a1%e6%95%b0font class=header-anchor>#</a>
<font color=green>åº”ç”¨ä¹‹å•è¯è®¡æ•°</font></h3><p><strong>æ­å»ºç»ƒä¹ ç¯å¢ƒï¼š</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-459-1><a class=lnlinks href=#hl-459-1> 1</a>
</span><span class=lnt id=hl-459-2><a class=lnlinks href=#hl-459-2> 2</a>
</span><span class=lnt id=hl-459-3><a class=lnlinks href=#hl-459-3> 3</a>
</span><span class=lnt id=hl-459-4><a class=lnlinks href=#hl-459-4> 4</a>
</span><span class=lnt id=hl-459-5><a class=lnlinks href=#hl-459-5> 5</a>
</span><span class=lnt id=hl-459-6><a class=lnlinks href=#hl-459-6> 6</a>
</span><span class=lnt id=hl-459-7><a class=lnlinks href=#hl-459-7> 7</a>
</span><span class=lnt id=hl-459-8><a class=lnlinks href=#hl-459-8> 8</a>
</span><span class=lnt id=hl-459-9><a class=lnlinks href=#hl-459-9> 9</a>
</span><span class=lnt id=hl-459-10><a class=lnlinks href=#hl-459-10>10</a>
</span><span class=lnt id=hl-459-11><a class=lnlinks href=#hl-459-11>11</a>
</span><span class=lnt id=hl-459-12><a class=lnlinks href=#hl-459-12>12</a>
</span><span class=lnt id=hl-459-13><a class=lnlinks href=#hl-459-13>13</a>
</span><span class=lnt id=hl-459-14><a class=lnlinks href=#hl-459-14>14</a>
</span><span class=lnt id=hl-459-15><a class=lnlinks href=#hl-459-15>15</a>
</span><span class=lnt id=hl-459-16><a class=lnlinks href=#hl-459-16>16</a>
</span><span class=lnt id=hl-459-17><a class=lnlinks href=#hl-459-17>17</a>
</span><span class=lnt id=hl-459-18><a class=lnlinks href=#hl-459-18>18</a>
</span><span class=lnt id=hl-459-19><a class=lnlinks href=#hl-459-19>19</a>
</span><span class=lnt id=hl-459-20><a class=lnlinks href=#hl-459-20>20</a>
</span><span class=lnt id=hl-459-21><a class=lnlinks href=#hl-459-21>21</a>
</span><span class=lnt id=hl-459-22><a class=lnlinks href=#hl-459-22>22</a>
</span><span class=lnt id=hl-459-23><a class=lnlinks href=#hl-459-23>23</a>
</span><span class=lnt id=hl-459-24><a class=lnlinks href=#hl-459-24>24</a>
</span><span class=lnt id=hl-459-25><a class=lnlinks href=#hl-459-25>25</a>
</span><span class=lnt id=hl-459-26><a class=lnlinks href=#hl-459-26>26</a>
</span><span class=lnt id=hl-459-27><a class=lnlinks href=#hl-459-27>27</a>
</span><span class=lnt id=hl-459-28><a class=lnlinks href=#hl-459-28>28</a>
</span><span class=lnt id=hl-459-29><a class=lnlinks href=#hl-459-29>29</a>
</span><span class=lnt id=hl-459-30><a class=lnlinks href=#hl-459-30>30</a>
</span><span class=lnt id=hl-459-31><a class=lnlinks href=#hl-459-31>31</a>
</span><span class=lnt id=hl-459-32><a class=lnlinks href=#hl-459-32>32</a>
</span><span class=lnt id=hl-459-33><a class=lnlinks href=#hl-459-33>33</a>
</span><span class=lnt id=hl-459-34><a class=lnlinks href=#hl-459-34>34</a>
</span><span class=lnt id=hl-459-35><a class=lnlinks href=#hl-459-35>35</a>
</span><span class=lnt id=hl-459-36><a class=lnlinks href=#hl-459-36>36</a>
</span><span class=lnt id=hl-459-37><a class=lnlinks href=#hl-459-37>37</a>
</span><span class=lnt id=hl-459-38><a class=lnlinks href=#hl-459-38>38</a>
</span><span class=lnt id=hl-459-39><a class=lnlinks href=#hl-459-39>39</a>
</span><span class=lnt id=hl-459-40><a class=lnlinks href=#hl-459-40>40</a>
</span><span class=lnt id=hl-459-41><a class=lnlinks href=#hl-459-41>41</a>
</span><span class=lnt id=hl-459-42><a class=lnlinks href=#hl-459-42>42</a>
</span><span class=lnt id=hl-459-43><a class=lnlinks href=#hl-459-43>43</a>
</span><span class=lnt id=hl-459-44><a class=lnlinks href=#hl-459-44>44</a>
</span><span class=lnt id=hl-459-45><a class=lnlinks href=#hl-459-45>45</a>
</span><span class=lnt id=hl-459-46><a class=lnlinks href=#hl-459-46>46</a>
</span><span class=lnt id=hl-459-47><a class=lnlinks href=#hl-459-47>47</a>
</span><span class=lnt id=hl-459-48><a class=lnlinks href=#hl-459-48>48</a>
</span><span class=lnt id=hl-459-49><a class=lnlinks href=#hl-459-49>49</a>
</span><span class=lnt id=hl-459-50><a class=lnlinks href=#hl-459-50>50</a>
</span><span class=lnt id=hl-459-51><a class=lnlinks href=#hl-459-51>51</a>
</span><span class=lnt id=hl-459-52><a class=lnlinks href=#hl-459-52>52</a>
</span><span class=lnt id=hl-459-53><a class=lnlinks href=#hl-459-53>53</a>
</span><span class=lnt id=hl-459-54><a class=lnlinks href=#hl-459-54>54</a>
</span><span class=lnt id=hl-459-55><a class=lnlinks href=#hl-459-55>55</a>
</span><span class=lnt id=hl-459-56><a class=lnlinks href=#hl-459-56>56</a>
</span><span class=lnt id=hl-459-57><a class=lnlinks href=#hl-459-57>57</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//åœ¨mainæ–¹æ³•ä¸­å®ç°ä¸¤ä¸ªæ¥å£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å¼€å¯26ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨getæ–¹æ³•è·å–mapï¼Œä»å¯¹åº”çš„æ–‡ä»¶è¯»å–å•è¯å¹¶å­˜å‚¨åˆ°listä¸­ï¼Œæœ€åè°ƒç”¨acceptæ–¹æ³•è¿›è¡Œç»Ÿè®¡ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w>  </span><span class=nf>calculate</span><span class=p>(</span><span class=n>Supplier</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>supplier</span><span class=p>,</span><span class=w> </span><span class=n>BiConsumer</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>consumer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>supplier</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CountDownLatch</span><span class=p>(</span><span class=n>26</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>27</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>read</span><span class=p>(</span><span class=n>list</span><span class=p>,</span><span class=n>k</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>consumer</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>count</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>count</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>map</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//è¯»å•è¯æ–¹æ³•çš„å®ç°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>read</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>element</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileReader</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.txt&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>((</span><span class=n>element</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reader</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>element</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//ç”Ÿæˆæµ‹è¯•æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>construct</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;abcdefghijklmnopqrstuvwxyz&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=na>length</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>200</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>str</span><span class=p>.</span><span class=na>charAt</span><span class=p>(</span><span class=n>i</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Collections</span><span class=p>.</span><span class=na>shuffle</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>26</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>PrintWriter</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PrintWriter</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileWriter</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.txt&#34;</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>collect</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>subList</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>200</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>200</span><span class=p>).</span><span class=na>stream</span><span class=p>().</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>joining</span><span class=p>(</span><span class=s>&#34;\n&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>collect</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=å®ç°ä¸€><a href=#%e5%ae%9e%e7%8e%b0%e4%b8%80 class=header-anchor>#</a>
å®ç°ä¸€ï¼š</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-460-1><a class=lnlinks href=#hl-460-1> 1</a>
</span><span class=lnt id=hl-460-2><a class=lnlinks href=#hl-460-2> 2</a>
</span><span class=lnt id=hl-460-3><a class=lnlinks href=#hl-460-3> 3</a>
</span><span class=lnt id=hl-460-4><a class=lnlinks href=#hl-460-4> 4</a>
</span><span class=lnt id=hl-460-5><a class=lnlinks href=#hl-460-5> 5</a>
</span><span class=lnt id=hl-460-6><a class=lnlinks href=#hl-460-6> 6</a>
</span><span class=lnt id=hl-460-7><a class=lnlinks href=#hl-460-7> 7</a>
</span><span class=lnt id=hl-460-8><a class=lnlinks href=#hl-460-8> 8</a>
</span><span class=lnt id=hl-460-9><a class=lnlinks href=#hl-460-9> 9</a>
</span><span class=lnt id=hl-460-10><a class=lnlinks href=#hl-460-10>10</a>
</span><span class=lnt id=hl-460-11><a class=lnlinks href=#hl-460-11>11</a>
</span><span class=lnt id=hl-460-12><a class=lnlinks href=#hl-460-12>12</a>
</span><span class=lnt id=hl-460-13><a class=lnlinks href=#hl-460-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ›å»º map é›†åˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ›å»º ConcurrentHashMap å¯¹ä¸å¯¹ï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿›è¡Œè®¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>word</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Integer</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>word</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>newValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>word</span><span class=p>,</span><span class=w> </span><span class=n>newValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-461-1><a class=lnlinks href=#hl-461-1>1</a>
</span><span class=lnt id=hl-461-2><a class=lnlinks href=#hl-461-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>{</span><span class=nv>a</span><span class=o>=</span>186, <span class=nv>b</span><span class=o>=</span>192, <span class=nv>c</span><span class=o>=</span>187, <span class=nv>d</span><span class=o>=</span>184, <span class=nv>e</span><span class=o>=</span>185, <span class=nv>f</span><span class=o>=</span>185, <span class=nv>g</span><span class=o>=</span>176, <span class=nv>h</span><span class=o>=</span>185, <span class=nv>i</span><span class=o>=</span>193, <span class=nv>j</span><span class=o>=</span>189, <span class=nv>k</span><span class=o>=</span>187, <span class=nv>l</span><span class=o>=</span>157, <span class=nv>m</span><span class=o>=</span>189, <span class=nv>n</span><span class=o>=</span>181, <span class=nv>o</span><span class=o>=</span>180, <span class=nv>p</span><span class=o>=</span>178, <span class=nv>q</span><span class=o>=</span>185, <span class=nv>r</span><span class=o>=</span>188, <span class=nv>s</span><span class=o>=</span>181, <span class=nv>t</span><span class=o>=</span>183, <span class=nv>u</span><span class=o>=</span>177, <span class=nv>v</span><span class=o>=</span>186, <span class=nv>w</span><span class=o>=</span>188, <span class=nv>x</span><span class=o>=</span>178, <span class=nv>y</span><span class=o>=</span>189, <span class=nv>z</span><span class=o>=</span>186<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=m>47</span>
</span></span></code></pre></td></tr></table></div></div><p>é”™è¯¯åŸå› ï¼š</p><ul><li>ConcurrentHashMapè™½ç„¶æ¯ä¸ªæ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¤šä¸ªæ–¹æ³•çš„ç»„åˆå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li></ul><h5 id=æ­£ç¡®ç­”æ¡ˆä¸€><a href=#%e6%ad%a3%e7%a1%ae%e7%ad%94%e6%a1%88%e4%b8%80 class=header-anchor>#</a>
æ­£ç¡®ç­”æ¡ˆä¸€ï¼š</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-462-1><a class=lnlinks href=#hl-462-1>1</a>
</span><span class=lnt id=hl-462-2><a class=lnlinks href=#hl-462-2>2</a>
</span><span class=lnt id=hl-462-3><a class=lnlinks href=#hl-462-3>3</a>
</span><span class=lnt id=hl-462-4><a class=lnlinks href=#hl-462-4>4</a>
</span><span class=lnt id=hl-462-5><a class=lnlinks href=#hl-462-5>5</a>
</span><span class=lnt id=hl-462-6><a class=lnlinks href=#hl-462-6>6</a>
</span><span class=lnt id=hl-462-7><a class=lnlinks href=#hl-462-7>7</a>
</span><span class=lnt id=hl-462-8><a class=lnlinks href=#hl-462-8>8</a>
</span><span class=lnt id=hl-462-9><a class=lnlinks href=#hl-462-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>LongAdder</span><span class=o>&gt;</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>word</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ³¨æ„ä¸èƒ½ä½¿ç”¨ putIfAbsentï¼Œæ­¤æ–¹æ³•è¿”å›çš„æ˜¯ä¸Šä¸€æ¬¡çš„ valueï¼Œé¦–æ¬¡è°ƒç”¨è¿”å› null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>computeIfAbsent</span><span class=p>(</span><span class=n>word</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LongAdder</span><span class=p>()).</span><span class=na>increment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯´æ˜ï¼š</p><ul><li>computIfAbsentæ–¹æ³•çš„ä½œç”¨æ˜¯ï¼šå½“mapä¸­ä¸å­˜åœ¨ä»¥å‚æ•°1ä¸ºkeyå¯¹åº”çš„valueæ—¶ï¼Œä¼šå°†å‚æ•°2å‡½æ•°å¼æ¥å£çš„è¿”å›å€¼ä½œä¸ºvalueï¼Œputè¿›mapä¸­ï¼Œç„¶åè¿”å›è¯¥valueã€‚å¦‚æœå­˜åœ¨keyï¼Œåˆ™ç›´æ¥è¿”å›value</li><li>ä»¥ä¸Šä¸¤éƒ¨å‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li></ul><h5 id=æ­£ç¡®ç­”æ¡ˆäºŒ><a href=#%e6%ad%a3%e7%a1%ae%e7%ad%94%e6%a1%88%e4%ba%8c class=header-anchor>#</a>
æ­£ç¡®ç­”æ¡ˆäºŒï¼š</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-463-1><a class=lnlinks href=#hl-463-1>1</a>
</span><span class=lnt id=hl-463-2><a class=lnlinks href=#hl-463-2>2</a>
</span><span class=lnt id=hl-463-3><a class=lnlinks href=#hl-463-3>3</a>
</span><span class=lnt id=hl-463-4><a class=lnlinks href=#hl-463-4>4</a>
</span><span class=lnt id=hl-463-5><a class=lnlinks href=#hl-463-5>5</a>
</span><span class=lnt id=hl-463-6><a class=lnlinks href=#hl-463-6>6</a>
</span><span class=lnt id=hl-463-7><a class=lnlinks href=#hl-463-7>7</a>
</span><span class=lnt id=hl-463-8><a class=lnlinks href=#hl-463-8>8</a>
</span><span class=lnt id=hl-463-9><a class=lnlinks href=#hl-463-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>demo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>word</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>words</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å‡½æ•°å¼ç¼–ç¨‹ï¼Œæ— éœ€åŸå­å˜é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>merge</span><span class=p>(</span><span class=n>word</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>::</span><span class=n>sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=font-colorblue-concurrenthashmap-åŸç†font><a href=#font-colorblue-concurrenthashmap-%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>* ConcurrentHashMap åŸç†</font></h3><h4 id=jdk-7-hashmap-å¹¶å‘æ­»é“¾><a href=#jdk-7-hashmap-%e5%b9%b6%e5%8f%91%e6%ad%bb%e9%93%be class=header-anchor>#</a>
JDK 7 HashMap å¹¶å‘æ­»é“¾</h4><h5 id=æµ‹è¯•ä»£ç ><a href=#%e6%b5%8b%e8%af%95%e4%bb%a3%e7%a0%81 class=header-anchor>#</a>
æµ‹è¯•ä»£ç </h5><p>æ³¨æ„</p><ul><li>è¦åœ¨ JDK 7 ä¸‹è¿è¡Œï¼Œå¦åˆ™æ‰©å®¹æœºåˆ¶å’Œ hash çš„è®¡ç®—æ–¹æ³•éƒ½å˜äº†</li><li>ä»¥ä¸‹æµ‹è¯•ä»£ç æ˜¯ç²¾å¿ƒå‡†å¤‡çš„ï¼Œä¸è¦éšä¾¿æ”¹åŠ¨</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-464-1><a class=lnlinks href=#hl-464-1> 1</a>
</span><span class=lnt id=hl-464-2><a class=lnlinks href=#hl-464-2> 2</a>
</span><span class=lnt id=hl-464-3><a class=lnlinks href=#hl-464-3> 3</a>
</span><span class=lnt id=hl-464-4><a class=lnlinks href=#hl-464-4> 4</a>
</span><span class=lnt id=hl-464-5><a class=lnlinks href=#hl-464-5> 5</a>
</span><span class=lnt id=hl-464-6><a class=lnlinks href=#hl-464-6> 6</a>
</span><span class=lnt id=hl-464-7><a class=lnlinks href=#hl-464-7> 7</a>
</span><span class=lnt id=hl-464-8><a class=lnlinks href=#hl-464-8> 8</a>
</span><span class=lnt id=hl-464-9><a class=lnlinks href=#hl-464-9> 9</a>
</span><span class=lnt id=hl-464-10><a class=lnlinks href=#hl-464-10>10</a>
</span><span class=lnt id=hl-464-11><a class=lnlinks href=#hl-464-11>11</a>
</span><span class=lnt id=hl-464-12><a class=lnlinks href=#hl-464-12>12</a>
</span><span class=lnt id=hl-464-13><a class=lnlinks href=#hl-464-13>13</a>
</span><span class=lnt id=hl-464-14><a class=lnlinks href=#hl-464-14>14</a>
</span><span class=lnt id=hl-464-15><a class=lnlinks href=#hl-464-15>15</a>
</span><span class=lnt id=hl-464-16><a class=lnlinks href=#hl-464-16>16</a>
</span><span class=lnt id=hl-464-17><a class=lnlinks href=#hl-464-17>17</a>
</span><span class=lnt id=hl-464-18><a class=lnlinks href=#hl-464-18>18</a>
</span><span class=lnt id=hl-464-19><a class=lnlinks href=#hl-464-19>19</a>
</span><span class=lnt id=hl-464-20><a class=lnlinks href=#hl-464-20>20</a>
</span><span class=lnt id=hl-464-21><a class=lnlinks href=#hl-464-21>21</a>
</span><span class=lnt id=hl-464-22><a class=lnlinks href=#hl-464-22>22</a>
</span><span class=lnt id=hl-464-23><a class=lnlinks href=#hl-464-23>23</a>
</span><span class=lnt id=hl-464-24><a class=lnlinks href=#hl-464-24>24</a>
</span><span class=lnt id=hl-464-25><a class=lnlinks href=#hl-464-25>25</a>
</span><span class=lnt id=hl-464-26><a class=lnlinks href=#hl-464-26>26</a>
</span><span class=lnt id=hl-464-27><a class=lnlinks href=#hl-464-27>27</a>
</span><span class=lnt id=hl-464-28><a class=lnlinks href=#hl-464-28>28</a>
</span><span class=lnt id=hl-464-29><a class=lnlinks href=#hl-464-29>29</a>
</span><span class=lnt id=hl-464-30><a class=lnlinks href=#hl-464-30>30</a>
</span><span class=lnt id=hl-464-31><a class=lnlinks href=#hl-464-31>31</a>
</span><span class=lnt id=hl-464-32><a class=lnlinks href=#hl-464-32>32</a>
</span><span class=lnt id=hl-464-33><a class=lnlinks href=#hl-464-33>33</a>
</span><span class=lnt id=hl-464-34><a class=lnlinks href=#hl-464-34>34</a>
</span><span class=lnt id=hl-464-35><a class=lnlinks href=#hl-464-35>35</a>
</span><span class=lnt id=hl-464-36><a class=lnlinks href=#hl-464-36>36</a>
</span><span class=lnt id=hl-464-37><a class=lnlinks href=#hl-464-37>37</a>
</span><span class=lnt id=hl-464-38><a class=lnlinks href=#hl-464-38>38</a>
</span><span class=lnt id=hl-464-39><a class=lnlinks href=#hl-464-39>39</a>
</span><span class=lnt id=hl-464-40><a class=lnlinks href=#hl-464-40>40</a>
</span><span class=lnt id=hl-464-41><a class=lnlinks href=#hl-464-41>41</a>
</span><span class=lnt id=hl-464-42><a class=lnlinks href=#hl-464-42>42</a>
</span><span class=lnt id=hl-464-43><a class=lnlinks href=#hl-464-43>43</a>
</span><span class=lnt id=hl-464-44><a class=lnlinks href=#hl-464-44>44</a>
</span><span class=lnt id=hl-464-45><a class=lnlinks href=#hl-464-45>45</a>
</span><span class=lnt id=hl-464-46><a class=lnlinks href=#hl-464-46>46</a>
</span><span class=lnt id=hl-464-47><a class=lnlinks href=#hl-464-47>47</a>
</span><span class=lnt id=hl-464-48><a class=lnlinks href=#hl-464-48>48</a>
</span><span class=lnt id=hl-464-49><a class=lnlinks href=#hl-464-49>49</a>
</span><span class=lnt id=hl-464-50><a class=lnlinks href=#hl-464-50>50</a>
</span><span class=lnt id=hl-464-51><a class=lnlinks href=#hl-464-51>51</a>
</span><span class=lnt id=hl-464-52><a class=lnlinks href=#hl-464-52>52</a>
</span><span class=lnt id=hl-464-53><a class=lnlinks href=#hl-464-53>53</a>
</span><span class=lnt id=hl-464-54><a class=lnlinks href=#hl-464-54>54</a>
</span><span class=lnt id=hl-464-55><a class=lnlinks href=#hl-464-55>55</a>
</span><span class=lnt id=hl-464-56><a class=lnlinks href=#hl-464-56>56</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æµ‹è¯• java 7 ä¸­å“ªäº›æ•°å­—çš„ hash ç»“æœç›¸ç­‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;é•¿åº¦ä¸º16æ—¶ï¼Œæ¡¶ä¸‹æ ‡ä¸º1çš„key&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>64</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>16</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;é•¿åº¦ä¸º32æ—¶ï¼Œæ¡¶ä¸‹æ ‡ä¸º1çš„key&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>64</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>32</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1, 35, 16, 50 å½“å¤§å°ä¸º16æ—¶ï¼Œå®ƒä»¬åœ¨ä¸€ä¸ªæ¡¶å†…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ”¾ 12 ä¸ªå…ƒç´ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>4</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>5</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>6</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>7</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>8</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>9</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>16</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰©å®¹å‰å¤§å°[main]:&#34;</span><span class=o>+</span><span class=n>map</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ”¾ç¬¬ 13 ä¸ªå…ƒç´ , å‘ç”Ÿæ‰©å®¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>50</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰©å®¹åå¤§å°[Thread-0]:&#34;</span><span class=o>+</span><span class=n>map</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ”¾ç¬¬ 13 ä¸ªå…ƒç´ , å‘ç”Ÿæ‰©å®¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>50</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ‰©å®¹åå¤§å°[Thread-1]:&#34;</span><span class=o>+</span><span class=n>map</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hash</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>k</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>0</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sun</span><span class=p>.</span><span class=na>misc</span><span class=p>.</span><span class=na>Hashing</span><span class=p>.</span><span class=na>stringHash32</span><span class=p>((</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>k</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=n>k</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>20</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>12</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>7</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=æ­»é“¾å¤ç°><a href=#%e6%ad%bb%e9%93%be%e5%a4%8d%e7%8e%b0 class=header-anchor>#</a>
æ­»é“¾å¤ç°</h5><p>è°ƒè¯•å·¥å…·ä½¿ç”¨ idea</p><p>åœ¨ HashMap æºç  590 è¡ŒåŠ æ–­ç‚¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-465-1><a class=lnlinks href=#hl-465-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span><span class=w> </span><span class=n>newCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ–­ç‚¹çš„æ¡ä»¶å¦‚ä¸‹ï¼Œç›®çš„æ˜¯è®© HashMap åœ¨æ‰©å®¹ä¸º 32 æ—¶ï¼Œå¹¶ä¸”çº¿ç¨‹ä¸º Thread-0 æˆ– Thread-1 æ—¶åœä¸‹æ¥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-466-1><a class=lnlinks href=#hl-466-1>1</a>
</span><span class=lnt id=hl-466-2><a class=lnlinks href=#hl-466-2>2</a>
</span><span class=lnt id=hl-466-3><a class=lnlinks href=#hl-466-3>3</a>
</span><span class=lnt id=hl-466-4><a class=lnlinks href=#hl-466-4>4</a>
</span><span class=lnt id=hl-466-5><a class=lnlinks href=#hl-466-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>newTable</span><span class=p>.</span><span class=na>length</span><span class=o>==</span><span class=n>32</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;Thread-0&#34;</span><span class=p>)</span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;Thread-1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ–­ç‚¹æš‚åœæ–¹å¼é€‰æ‹© Threadï¼Œå¦åˆ™åœ¨è°ƒè¯• Thread-0 æ—¶ï¼ŒThread-1 æ— æ³•æ¢å¤è¿è¡Œ</p><p>è¿è¡Œä»£ç ï¼Œç¨‹åºåœ¨é¢„æ–™çš„æ–­ç‚¹ä½ç½®åœäº†ä¸‹æ¥ï¼Œè¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-467-1><a class=lnlinks href=#hl-467-1>1</a>
</span><span class=lnt id=hl-467-2><a class=lnlinks href=#hl-467-2>2</a>
</span><span class=lnt id=hl-467-3><a class=lnlinks href=#hl-467-3>3</a>
</span><span class=lnt id=hl-467-4><a class=lnlinks href=#hl-467-4>4</a>
</span><span class=lnt id=hl-467-5><a class=lnlinks href=#hl-467-5>5</a>
</span><span class=lnt id=hl-467-6><a class=lnlinks href=#hl-467-6>6</a>
</span><span class=lnt id=hl-467-7><a class=lnlinks href=#hl-467-7>7</a>
</span><span class=lnt id=hl-467-8><a class=lnlinks href=#hl-467-8>8</a>
</span><span class=lnt id=hl-467-9><a class=lnlinks href=#hl-467-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>é•¿åº¦ä¸º16æ—¶ï¼Œæ¡¶ä¸‹æ ‡ä¸º1çš„key 
</span></span><span class=line><span class=cl><span class=m>1</span> 
</span></span><span class=line><span class=cl><span class=m>16</span> 
</span></span><span class=line><span class=cl><span class=m>35</span> 
</span></span><span class=line><span class=cl><span class=m>50</span> 
</span></span><span class=line><span class=cl>é•¿åº¦ä¸º32æ—¶ï¼Œæ¡¶ä¸‹æ ‡ä¸º1çš„key 
</span></span><span class=line><span class=cl><span class=m>1</span> 
</span></span><span class=line><span class=cl><span class=m>35</span> 
</span></span><span class=line><span class=cl>æ‰©å®¹å‰å¤§å°<span class=o>[</span>main<span class=o>]</span>:12 
</span></span></code></pre></td></tr></table></div></div><p>æ¥ä¸‹æ¥è¿›å…¥æ‰©å®¹æµç¨‹è°ƒè¯•</p><p>åœ¨ HashMap æºç  594 è¡ŒåŠ æ–­ç‚¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-468-1><a class=lnlinks href=#hl-468-1>1</a>
</span><span class=lnt id=hl-468-2><a class=lnlinks href=#hl-468-2>2</a>
</span><span class=lnt id=hl-468-3><a class=lnlinks href=#hl-468-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w> </span><span class=c1>// 593</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rehash</span><span class=p>)</span><span class=w> </span><span class=c1>// 594</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™æ˜¯ä¸ºäº†è§‚å¯Ÿ e èŠ‚ç‚¹å’Œ next èŠ‚ç‚¹çš„çŠ¶æ€ï¼ŒThread-0 å•æ­¥æ‰§è¡Œåˆ° 594 è¡Œï¼Œå† 594 å¤„å†æ·»åŠ ä¸€ä¸ªæ–­ç‚¹ï¼ˆæ¡ä»¶ Thread.currentThread().getName().equals(&ldquo;Thread-0&rdquo;)ï¼‰</p><p>è¿™æ—¶å¯ä»¥åœ¨ Variables é¢æ¿è§‚å¯Ÿåˆ° e å’Œ next å˜é‡ï¼Œä½¿ç”¨<code>view as -> Object</code>æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-469-1><a class=lnlinks href=#hl-469-1>1</a>
</span><span class=lnt id=hl-469-2><a class=lnlinks href=#hl-469-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>e</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>16</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>next</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>16</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨ Threads é¢æ¿é€‰ä¸­ Thread-1 æ¢å¤è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºæ–°çš„å†…å®¹å¦‚ä¸‹ï¼ŒThread-1 æ‰©å®¹å·²å®Œæˆ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-470-1><a class=lnlinks href=#hl-470-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>newTable</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-471-1><a class=lnlinks href=#hl-471-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>æ‰©å®¹åå¤§å°:13 
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ—¶ Thread-0 è¿˜åœåœ¨ 594 å¤„ï¼Œ Variables é¢æ¿å˜é‡çš„çŠ¶æ€å·²ç»å˜åŒ–ä¸º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-472-1><a class=lnlinks href=#hl-472-1>1</a>
</span><span class=lnt id=hl-472-2><a class=lnlinks href=#hl-472-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>e</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>next</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸ºä»€ä¹ˆå‘¢ï¼Œå› ä¸º Thread-1 æ‰©å®¹æ—¶é“¾è¡¨ä¹Ÿæ˜¯ååŠ å…¥çš„å…ƒç´ æ”¾å…¥é“¾è¡¨å¤´ï¼Œå› æ­¤é“¾è¡¨å°±å€’è¿‡æ¥äº†ï¼Œä½† Thread-1 è™½ç„¶ç»“ æœæ­£ç¡®ï¼Œä½†å®ƒç»“æŸå Thread-0 è¿˜è¦ç»§ç»­è¿è¡Œ</p><p>æ¥ä¸‹æ¥å°±å¯ä»¥å•æ­¥è°ƒè¯•ï¼ˆF8ï¼‰è§‚å¯Ÿæ­»é“¾çš„äº§ç”Ÿäº†</p><p>ä¸‹ä¸€è½®å¾ªç¯åˆ° 594ï¼Œå°† e æ¬è¿åˆ° newTable é“¾è¡¨å¤´</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-473-1><a class=lnlinks href=#hl-473-1>1</a>
</span><span class=lnt id=hl-473-2><a class=lnlinks href=#hl-473-2>2</a>
</span><span class=lnt id=hl-473-3><a class=lnlinks href=#hl-473-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>newTable</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>e</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>next</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸‹ä¸€è½®å¾ªç¯åˆ° 594ï¼Œå°† e æ¬è¿åˆ° newTable é“¾è¡¨å¤´</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-474-1><a class=lnlinks href=#hl-474-1>1</a>
</span><span class=lnt id=hl-474-2><a class=lnlinks href=#hl-474-2>2</a>
</span><span class=lnt id=hl-474-3><a class=lnlinks href=#hl-474-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>newTable</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>e</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>null</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>next</span><span class=w> </span><span class=kc>null</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>å†çœ‹çœ‹æºç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-475-1><a class=lnlinks href=#hl-475-1>1</a>
</span><span class=lnt id=hl-475-2><a class=lnlinks href=#hl-475-2>2</a>
</span><span class=lnt id=hl-475-3><a class=lnlinks href=#hl-475-3>3</a>
</span><span class=lnt id=hl-475-4><a class=lnlinks href=#hl-475-4>4</a>
</span><span class=lnt id=hl-475-5><a class=lnlinks href=#hl-475-5>5</a>
</span><span class=lnt id=hl-475-6><a class=lnlinks href=#hl-475-6>6</a>
</span><span class=lnt id=hl-475-7><a class=lnlinks href=#hl-475-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è¿™æ—¶ e (1,35)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è€Œ newTable[1] (35,1)-&gt;(1,35) å› ä¸ºæ˜¯åŒä¸€ä¸ªå¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>newTable</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å†å°è¯•å°† e ä½œä¸ºé“¾è¡¨å¤´, æ­»é“¾å·²æˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è™½ç„¶ next æ˜¯ null, ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªé“¾è¡¨çš„å¤åˆ¶, ä½†æ­»é“¾å·²ç»å½¢æˆäº†</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=æºç åˆ†æ-2><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-2 class=header-anchor>#</a>
<strong>æºç åˆ†æ</strong></h5><p>HashMap çš„å¹¶å‘æ­»é“¾å‘ç”Ÿåœ¨æ‰©å®¹æ—¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-476-1><a class=lnlinks href=#hl-476-1> 1</a>
</span><span class=lnt id=hl-476-2><a class=lnlinks href=#hl-476-2> 2</a>
</span><span class=lnt id=hl-476-3><a class=lnlinks href=#hl-476-3> 3</a>
</span><span class=lnt id=hl-476-4><a class=lnlinks href=#hl-476-4> 4</a>
</span><span class=lnt id=hl-476-5><a class=lnlinks href=#hl-476-5> 5</a>
</span><span class=lnt id=hl-476-6><a class=lnlinks href=#hl-476-6> 6</a>
</span><span class=lnt id=hl-476-7><a class=lnlinks href=#hl-476-7> 7</a>
</span><span class=lnt id=hl-476-8><a class=lnlinks href=#hl-476-8> 8</a>
</span><span class=lnt id=hl-476-9><a class=lnlinks href=#hl-476-9> 9</a>
</span><span class=lnt id=hl-476-10><a class=lnlinks href=#hl-476-10>10</a>
</span><span class=lnt id=hl-476-11><a class=lnlinks href=#hl-476-11>11</a>
</span><span class=lnt id=hl-476-12><a class=lnlinks href=#hl-476-12>12</a>
</span><span class=lnt id=hl-476-13><a class=lnlinks href=#hl-476-13>13</a>
</span><span class=lnt id=hl-476-14><a class=lnlinks href=#hl-476-14>14</a>
</span><span class=lnt id=hl-476-15><a class=lnlinks href=#hl-476-15>15</a>
</span><span class=lnt id=hl-476-16><a class=lnlinks href=#hl-476-16>16</a>
</span><span class=lnt id=hl-476-17><a class=lnlinks href=#hl-476-17>17</a>
</span><span class=lnt id=hl-476-18><a class=lnlinks href=#hl-476-18>18</a>
</span><span class=lnt id=hl-476-19><a class=lnlinks href=#hl-476-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å°† table è¿ç§»è‡³ newTable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>transfer</span><span class=p>(</span><span class=n>Entry</span><span class=o>[]</span><span class=w> </span><span class=n>newTable</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>rehash</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>newCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>table</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 1 å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rehash</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>indexFor</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=p>,</span><span class=w> </span><span class=n>newCapacity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 2 å¤„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å°†æ–°å…ƒç´ åŠ å…¥ newTable[i], åŸ newTable[i] ä½œä¸ºæ–°å…ƒç´ çš„ next</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newTable</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å‡è®¾ map ä¸­åˆå§‹å…ƒç´ æ˜¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-477-1><a class=lnlinks href=#hl-477-1> 1</a>
</span><span class=lnt id=hl-477-2><a class=lnlinks href=#hl-477-2> 2</a>
</span><span class=lnt id=hl-477-3><a class=lnlinks href=#hl-477-3> 3</a>
</span><span class=lnt id=hl-477-4><a class=lnlinks href=#hl-477-4> 4</a>
</span><span class=lnt id=hl-477-5><a class=lnlinks href=#hl-477-5> 5</a>
</span><span class=lnt id=hl-477-6><a class=lnlinks href=#hl-477-6> 6</a>
</span><span class=lnt id=hl-477-7><a class=lnlinks href=#hl-477-7> 7</a>
</span><span class=lnt id=hl-477-8><a class=lnlinks href=#hl-477-8> 8</a>
</span><span class=lnt id=hl-477-9><a class=lnlinks href=#hl-477-9> 9</a>
</span><span class=lnt id=hl-477-10><a class=lnlinks href=#hl-477-10>10</a>
</span><span class=lnt id=hl-477-11><a class=lnlinks href=#hl-477-11>11</a>
</span><span class=lnt id=hl-477-12><a class=lnlinks href=#hl-477-12>12</a>
</span><span class=lnt id=hl-477-13><a class=lnlinks href=#hl-477-13>13</a>
</span><span class=lnt id=hl-477-14><a class=lnlinks href=#hl-477-14>14</a>
</span><span class=lnt id=hl-477-15><a class=lnlinks href=#hl-477-15>15</a>
</span><span class=lnt id=hl-477-16><a class=lnlinks href=#hl-477-16>16</a>
</span><span class=lnt id=hl-477-17><a class=lnlinks href=#hl-477-17>17</a>
</span><span class=lnt id=hl-477-18><a class=lnlinks href=#hl-477-18>18</a>
</span><span class=lnt id=hl-477-19><a class=lnlinks href=#hl-477-19>19</a>
</span><span class=lnt id=hl-477-20><a class=lnlinks href=#hl-477-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>åŸå§‹é“¾è¡¨</span><span class=err>ï¼Œ</span><span class=n>æ ¼å¼</span><span class=err>ï¼š</span><span class=o>[</span><span class=n>ä¸‹æ ‡</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=n>next</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>16</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>16</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>çº¿ç¨‹</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>æ‰§è¡Œåˆ°</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=n>å¤„</span><span class=w> </span><span class=err>ï¼Œ</span><span class=n>æ­¤æ—¶å±€éƒ¨å˜é‡</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=nf>ä¸º</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=n>35</span><span class=p>)</span><span class=err>ï¼Œ</span><span class=n>è€Œå±€éƒ¨å˜é‡</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=nf>ä¸º</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>16</span><span class=p>)</span><span class=w> </span><span class=n>çº¿ç¨‹</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>æŒ‚èµ·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>çº¿ç¨‹</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=n>å¼€å§‹æ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ç¬¬ä¸€æ¬¡å¾ªç¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ç¬¬äºŒæ¬¡å¾ªç¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ç¬¬ä¸‰æ¬¡å¾ªç¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>17</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>16</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>åˆ‡æ¢å›çº¿ç¨‹</span><span class=w> </span><span class=n>a</span><span class=err>ï¼Œ</span><span class=n>æ­¤æ—¶å±€éƒ¨å˜é‡</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=n>å’Œ</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=n>è¢«æ¢å¤</span><span class=err>ï¼Œ</span><span class=n>å¼•ç”¨æ²¡å˜ä½†å†…å®¹å˜äº†</span><span class=err>ï¼š</span><span class=n>e</span><span class=w> </span><span class=nf>çš„å†…å®¹è¢«æ”¹ä¸º</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=err>ï¼Œ</span><span class=n>è€Œ</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=n>çš„å†…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>å®¹è¢«æ”¹ä¸º</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=n>å¹¶é“¾å‘</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ç¬¬ä¸€æ¬¡å¾ªç¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ç¬¬äºŒæ¬¡å¾ªç¯</span><span class=err>ï¼Œ</span><span class=n>æ³¨æ„è¿™æ—¶</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=nf>æ˜¯</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=n>å¹¶é“¾å‘</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=n>æ‰€ä»¥</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=nf>åˆæ˜¯</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ç¬¬ä¸‰æ¬¡å¾ªç¯</span><span class=err>ï¼Œ</span><span class=n>e</span><span class=w> </span><span class=nf>æ˜¯</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=kc>null</span><span class=p>)</span><span class=err>ï¼Œ</span><span class=n>è€Œ</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=n>æ˜¯</span><span class=w> </span><span class=kc>null</span><span class=err>ï¼Œ</span><span class=n>ä½†</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=n>è¢«æ”¾å…¥é“¾è¡¨å¤´</span><span class=err>ï¼Œ</span><span class=n>è¿™æ ·</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=n>å˜æˆäº†</span><span class=w> </span><span class=n>35</span><span class=w> </span><span class=err>ï¼ˆ</span><span class=n>2</span><span class=w> </span><span class=n>å¤„</span><span class=err>ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=n>35</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>35</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=o>-&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=n>35</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>å·²ç»æ˜¯æ­»é“¾äº†</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>å°ç»“</strong></p><ul><li>ç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸ºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨äº†éçº¿ç¨‹å®‰å…¨çš„ map é›†åˆ</li><li>JDK 8 è™½ç„¶å°†æ‰©å®¹ç®—æ³•åšäº†è°ƒæ•´ï¼Œä¸å†å°†å…ƒç´ åŠ å…¥é“¾è¡¨å¤´ï¼ˆè€Œæ˜¯ä¿æŒä¸æ‰©å®¹å‰ä¸€æ ·çš„é¡ºåºï¼‰ï¼Œä½†ä»ä¸æ„å‘³ç€èƒ½ å¤Ÿåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹èƒ½å¤Ÿå®‰å…¨æ‰©å®¹ï¼Œè¿˜ä¼šå‡ºç°å…¶å®ƒé—®é¢˜ï¼ˆå¦‚æ‰©å®¹ä¸¢æ•°æ®ï¼‰</li></ul><h4 id=jdk-8-concurrenthashmap><a href=#jdk-8-concurrenthashmap class=header-anchor>#</a>
JDK 8 ConcurrentHashMap</h4><h5 id=é‡è¦å±æ€§å’Œå†…éƒ¨ç±»><a href=#%e9%87%8d%e8%a6%81%e5%b1%9e%e6%80%a7%e5%92%8c%e5%86%85%e9%83%a8%e7%b1%bb class=header-anchor>#</a>
é‡è¦å±æ€§å’Œå†…éƒ¨ç±»</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-478-1><a class=lnlinks href=#hl-478-1> 1</a>
</span><span class=lnt id=hl-478-2><a class=lnlinks href=#hl-478-2> 2</a>
</span><span class=lnt id=hl-478-3><a class=lnlinks href=#hl-478-3> 3</a>
</span><span class=lnt id=hl-478-4><a class=lnlinks href=#hl-478-4> 4</a>
</span><span class=lnt id=hl-478-5><a class=lnlinks href=#hl-478-5> 5</a>
</span><span class=lnt id=hl-478-6><a class=lnlinks href=#hl-478-6> 6</a>
</span><span class=lnt id=hl-478-7><a class=lnlinks href=#hl-478-7> 7</a>
</span><span class=lnt id=hl-478-8><a class=lnlinks href=#hl-478-8> 8</a>
</span><span class=lnt id=hl-478-9><a class=lnlinks href=#hl-478-9> 9</a>
</span><span class=lnt id=hl-478-10><a class=lnlinks href=#hl-478-10>10</a>
</span><span class=lnt id=hl-478-11><a class=lnlinks href=#hl-478-11>11</a>
</span><span class=lnt id=hl-478-12><a class=lnlinks href=#hl-478-12>12</a>
</span><span class=lnt id=hl-478-13><a class=lnlinks href=#hl-478-13>13</a>
</span><span class=lnt id=hl-478-14><a class=lnlinks href=#hl-478-14>14</a>
</span><span class=lnt id=hl-478-15><a class=lnlinks href=#hl-478-15>15</a>
</span><span class=lnt id=hl-478-16><a class=lnlinks href=#hl-478-16>16</a>
</span><span class=lnt id=hl-478-17><a class=lnlinks href=#hl-478-17>17</a>
</span><span class=lnt id=hl-478-18><a class=lnlinks href=#hl-478-18>18</a>
</span><span class=lnt id=hl-478-19><a class=lnlinks href=#hl-478-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// é»˜è®¤ä¸º 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å½“åˆå§‹åŒ–æ—¶, ä¸º -1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å½“æ‰©å®¹æ—¶, ä¸º -(1 + æ‰©å®¹çº¿ç¨‹æ•°)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å½“åˆå§‹åŒ–æˆ–æ‰©å®¹å®Œæˆåï¼Œä¸º ä¸‹ä¸€æ¬¡çš„æ‰©å®¹çš„é˜ˆå€¼å¤§å°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>sizeCtl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æ•´ä¸ª ConcurrentHashMap å°±æ˜¯ä¸€ä¸ª Node[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// hash è¡¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>table</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æ‰©å®¹æ—¶çš„ æ–° hash è¡¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>transient</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>nextTable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// æ‰©å®¹æ—¶å¦‚æœæŸä¸ª bin è¿ç§»å®Œæ¯•, ç”¨ ForwardingNode ä½œä¸ºæ—§ table bin çš„å¤´ç»“ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ForwardingNode</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ç”¨åœ¨ compute ä»¥åŠ computeIfAbsent æ—¶, ç”¨æ¥å ä½, è®¡ç®—å®Œæˆåæ›¿æ¢ä¸ºæ™®é€š Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ReservationNode</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä½œä¸º treebin çš„å¤´èŠ‚ç‚¹, å­˜å‚¨ root å’Œ first</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>TreeBin</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä½œä¸º treebin çš„èŠ‚ç‚¹, å­˜å‚¨ parent, left, right</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>TreeNode</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=é‡è¦æ–¹æ³•><a href=#%e9%87%8d%e8%a6%81%e6%96%b9%e6%b3%95 class=header-anchor>#</a>
é‡è¦æ–¹æ³•</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-479-1><a class=lnlinks href=#hl-479-1>1</a>
</span><span class=lnt id=hl-479-2><a class=lnlinks href=#hl-479-2>2</a>
</span><span class=lnt id=hl-479-3><a class=lnlinks href=#hl-479-3>3</a>
</span><span class=lnt id=hl-479-4><a class=lnlinks href=#hl-479-4>4</a>
</span><span class=lnt id=hl-479-5><a class=lnlinks href=#hl-479-5>5</a>
</span><span class=lnt id=hl-479-6><a class=lnlinks href=#hl-479-6>6</a>
</span><span class=lnt id=hl-479-7><a class=lnlinks href=#hl-479-7>7</a>
</span><span class=lnt id=hl-479-8><a class=lnlinks href=#hl-479-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// è·å– Node[] ä¸­ç¬¬ i ä¸ª Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=nf>tabAt</span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// cas ä¿®æ”¹ Node[] ä¸­ç¬¬ i ä¸ª Node çš„å€¼, c ä¸ºæ—§å€¼, v ä¸ºæ–°å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>casTabAt</span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ç›´æ¥ä¿®æ”¹ Node[] ä¸­ç¬¬ i ä¸ª Node çš„å€¼, v ä¸ºæ–°å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setTabAt</span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=æ„é€ å™¨åˆ†æ><a href=#%e6%9e%84%e9%80%a0%e5%99%a8%e5%88%86%e6%9e%90 class=header-anchor>#</a>
æ„é€ å™¨åˆ†æ</h5><p>å¯ä»¥çœ‹åˆ°å®ç°äº†æ‡’æƒ°åˆå§‹åŒ–ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ä»…ä»…è®¡ç®—äº† table çš„å¤§å°ï¼Œä»¥ååœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‰ä¼šçœŸæ­£åˆ›å»º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-480-1><a class=lnlinks href=#hl-480-1> 1</a>
</span><span class=lnt id=hl-480-2><a class=lnlinks href=#hl-480-2> 2</a>
</span><span class=lnt id=hl-480-3><a class=lnlinks href=#hl-480-3> 3</a>
</span><span class=lnt id=hl-480-4><a class=lnlinks href=#hl-480-4> 4</a>
</span><span class=lnt id=hl-480-5><a class=lnlinks href=#hl-480-5> 5</a>
</span><span class=lnt id=hl-480-6><a class=lnlinks href=#hl-480-6> 6</a>
</span><span class=lnt id=hl-480-7><a class=lnlinks href=#hl-480-7> 7</a>
</span><span class=lnt id=hl-480-8><a class=lnlinks href=#hl-480-8> 8</a>
</span><span class=lnt id=hl-480-9><a class=lnlinks href=#hl-480-9> 9</a>
</span><span class=lnt id=hl-480-10><a class=lnlinks href=#hl-480-10>10</a>
</span><span class=lnt id=hl-480-11><a class=lnlinks href=#hl-480-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ConcurrentHashMap</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>initialCapacity</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>loadFactor</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>loadFactor</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>initialCapacity</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>initialCapacity</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=p>)</span><span class=w> </span><span class=c1>// Use at least as many bins</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>initialCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=p>;</span><span class=w> </span><span class=c1>// as estimated threads</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)(</span><span class=n>1</span><span class=p>.</span><span class=na>0</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>initialCapacity</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>loadFactor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// tableSizeFor ä»ç„¶æ˜¯ä¿è¯è®¡ç®—çš„å¤§å°æ˜¯ 2^n, å³ 16,32,64 ... </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>cap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>MAXIMUM_CAPACITY</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MAXIMUM_CAPACITY</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>tableSizeFor</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>size</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>sizeCtl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=getæµç¨‹><a href=#get%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
getæµç¨‹</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-481-1><a class=lnlinks href=#hl-481-1> 1</a>
</span><span class=lnt id=hl-481-2><a class=lnlinks href=#hl-481-2> 2</a>
</span><span class=lnt id=hl-481-3><a class=lnlinks href=#hl-481-3> 3</a>
</span><span class=lnt id=hl-481-4><a class=lnlinks href=#hl-481-4> 4</a>
</span><span class=lnt id=hl-481-5><a class=lnlinks href=#hl-481-5> 5</a>
</span><span class=lnt id=hl-481-6><a class=lnlinks href=#hl-481-6> 6</a>
</span><span class=lnt id=hl-481-7><a class=lnlinks href=#hl-481-7> 7</a>
</span><span class=lnt id=hl-481-8><a class=lnlinks href=#hl-481-8> 8</a>
</span><span class=lnt id=hl-481-9><a class=lnlinks href=#hl-481-9> 9</a>
</span><span class=lnt id=hl-481-10><a class=lnlinks href=#hl-481-10>10</a>
</span><span class=lnt id=hl-481-11><a class=lnlinks href=#hl-481-11>11</a>
</span><span class=lnt id=hl-481-12><a class=lnlinks href=#hl-481-12>12</a>
</span><span class=lnt id=hl-481-13><a class=lnlinks href=#hl-481-13>13</a>
</span><span class=lnt id=hl-481-14><a class=lnlinks href=#hl-481-14>14</a>
</span><span class=lnt id=hl-481-15><a class=lnlinks href=#hl-481-15>15</a>
</span><span class=lnt id=hl-481-16><a class=lnlinks href=#hl-481-16>16</a>
</span><span class=lnt id=hl-481-17><a class=lnlinks href=#hl-481-17>17</a>
</span><span class=lnt id=hl-481-18><a class=lnlinks href=#hl-481-18>18</a>
</span><span class=lnt id=hl-481-19><a class=lnlinks href=#hl-481-19>19</a>
</span><span class=lnt id=hl-481-20><a class=lnlinks href=#hl-481-20>20</a>
</span><span class=lnt id=hl-481-21><a class=lnlinks href=#hl-481-21>21</a>
</span><span class=lnt id=hl-481-22><a class=lnlinks href=#hl-481-22>22</a>
</span><span class=lnt id=hl-481-23><a class=lnlinks href=#hl-481-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>;</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>eh</span><span class=p>;</span><span class=w> </span><span class=n>K</span><span class=w> </span><span class=n>ek</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// spread æ–¹æ³•èƒ½ç¡®ä¿è¿”å›ç»“æœæ˜¯æ­£æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>spread</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>hashCode</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tabAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>h</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœå¤´ç»“ç‚¹å·²ç»æ˜¯è¦æŸ¥æ‰¾çš„ key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>eh</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>h</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>ek</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>ek</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>ek</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>val</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// hash ä¸ºè´Ÿæ•°è¡¨ç¤ºè¯¥ bin åœ¨æ‰©å®¹ä¸­æˆ–æ˜¯ treebin, è¿™æ—¶è°ƒç”¨ find æ–¹æ³•æ¥æŸ¥æ‰¾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>eh</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>find</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>val</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ­£å¸¸éå†é“¾è¡¨, ç”¨ equals æ¯”è¾ƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>((</span><span class=n>ek</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>ek</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>ek</span><span class=p>))))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>val</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“ï¼š</p><ul><li>å¦‚æœtableä¸ä¸ºç©ºä¸”é•¿åº¦å¤§äº0ä¸”ç´¢å¼•ä½ç½®æœ‰å…ƒç´ <ul><li>if å¤´èŠ‚ç‚¹keyçš„hashå€¼ç›¸ç­‰<ul><li>å¤´èŠ‚ç‚¹çš„keyæŒ‡å‘åŒä¸€ä¸ªåœ°å€æˆ–è€…equals<ul><li>è¿”å›value</li></ul></li></ul></li><li>else if å¤´èŠ‚ç‚¹çš„hashä¸ºè´Ÿæ•°ï¼ˆbinåœ¨æ‰©å®¹æˆ–è€…æ˜¯treebinï¼‰<ul><li>è°ƒç”¨findæ–¹æ³•æŸ¥æ‰¾</li></ul></li><li>è¿›å…¥å¾ªç¯ï¼ˆeä¸ä¸ºç©ºï¼‰ï¼š<ul><li>èŠ‚ç‚¹keyçš„hashå€¼ç›¸ç­‰ï¼Œä¸”keyæŒ‡å‘åŒä¸€ä¸ªåœ°å€æˆ–equals<ul><li>è¿”å›value</li></ul></li></ul></li></ul></li><li>è¿”å›null</li></ul><h5 id=put-æµç¨‹><a href=#put-%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
put æµç¨‹</h5><p>ä»¥ä¸‹æ•°ç»„ç®€ç§°ï¼ˆtableï¼‰ï¼Œé“¾è¡¨ç®€ç§°ï¼ˆbinï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-482-1><a class=lnlinks href=#hl-482-1>  1</a>
</span><span class=lnt id=hl-482-2><a class=lnlinks href=#hl-482-2>  2</a>
</span><span class=lnt id=hl-482-3><a class=lnlinks href=#hl-482-3>  3</a>
</span><span class=lnt id=hl-482-4><a class=lnlinks href=#hl-482-4>  4</a>
</span><span class=lnt id=hl-482-5><a class=lnlinks href=#hl-482-5>  5</a>
</span><span class=lnt id=hl-482-6><a class=lnlinks href=#hl-482-6>  6</a>
</span><span class=lnt id=hl-482-7><a class=lnlinks href=#hl-482-7>  7</a>
</span><span class=lnt id=hl-482-8><a class=lnlinks href=#hl-482-8>  8</a>
</span><span class=lnt id=hl-482-9><a class=lnlinks href=#hl-482-9>  9</a>
</span><span class=lnt id=hl-482-10><a class=lnlinks href=#hl-482-10> 10</a>
</span><span class=lnt id=hl-482-11><a class=lnlinks href=#hl-482-11> 11</a>
</span><span class=lnt id=hl-482-12><a class=lnlinks href=#hl-482-12> 12</a>
</span><span class=lnt id=hl-482-13><a class=lnlinks href=#hl-482-13> 13</a>
</span><span class=lnt id=hl-482-14><a class=lnlinks href=#hl-482-14> 14</a>
</span><span class=lnt id=hl-482-15><a class=lnlinks href=#hl-482-15> 15</a>
</span><span class=lnt id=hl-482-16><a class=lnlinks href=#hl-482-16> 16</a>
</span><span class=lnt id=hl-482-17><a class=lnlinks href=#hl-482-17> 17</a>
</span><span class=lnt id=hl-482-18><a class=lnlinks href=#hl-482-18> 18</a>
</span><span class=lnt id=hl-482-19><a class=lnlinks href=#hl-482-19> 19</a>
</span><span class=lnt id=hl-482-20><a class=lnlinks href=#hl-482-20> 20</a>
</span><span class=lnt id=hl-482-21><a class=lnlinks href=#hl-482-21> 21</a>
</span><span class=lnt id=hl-482-22><a class=lnlinks href=#hl-482-22> 22</a>
</span><span class=lnt id=hl-482-23><a class=lnlinks href=#hl-482-23> 23</a>
</span><span class=lnt id=hl-482-24><a class=lnlinks href=#hl-482-24> 24</a>
</span><span class=lnt id=hl-482-25><a class=lnlinks href=#hl-482-25> 25</a>
</span><span class=lnt id=hl-482-26><a class=lnlinks href=#hl-482-26> 26</a>
</span><span class=lnt id=hl-482-27><a class=lnlinks href=#hl-482-27> 27</a>
</span><span class=lnt id=hl-482-28><a class=lnlinks href=#hl-482-28> 28</a>
</span><span class=lnt id=hl-482-29><a class=lnlinks href=#hl-482-29> 29</a>
</span><span class=lnt id=hl-482-30><a class=lnlinks href=#hl-482-30> 30</a>
</span><span class=lnt id=hl-482-31><a class=lnlinks href=#hl-482-31> 31</a>
</span><span class=lnt id=hl-482-32><a class=lnlinks href=#hl-482-32> 32</a>
</span><span class=lnt id=hl-482-33><a class=lnlinks href=#hl-482-33> 33</a>
</span><span class=lnt id=hl-482-34><a class=lnlinks href=#hl-482-34> 34</a>
</span><span class=lnt id=hl-482-35><a class=lnlinks href=#hl-482-35> 35</a>
</span><span class=lnt id=hl-482-36><a class=lnlinks href=#hl-482-36> 36</a>
</span><span class=lnt id=hl-482-37><a class=lnlinks href=#hl-482-37> 37</a>
</span><span class=lnt id=hl-482-38><a class=lnlinks href=#hl-482-38> 38</a>
</span><span class=lnt id=hl-482-39><a class=lnlinks href=#hl-482-39> 39</a>
</span><span class=lnt id=hl-482-40><a class=lnlinks href=#hl-482-40> 40</a>
</span><span class=lnt id=hl-482-41><a class=lnlinks href=#hl-482-41> 41</a>
</span><span class=lnt id=hl-482-42><a class=lnlinks href=#hl-482-42> 42</a>
</span><span class=lnt id=hl-482-43><a class=lnlinks href=#hl-482-43> 43</a>
</span><span class=lnt id=hl-482-44><a class=lnlinks href=#hl-482-44> 44</a>
</span><span class=lnt id=hl-482-45><a class=lnlinks href=#hl-482-45> 45</a>
</span><span class=lnt id=hl-482-46><a class=lnlinks href=#hl-482-46> 46</a>
</span><span class=lnt id=hl-482-47><a class=lnlinks href=#hl-482-47> 47</a>
</span><span class=lnt id=hl-482-48><a class=lnlinks href=#hl-482-48> 48</a>
</span><span class=lnt id=hl-482-49><a class=lnlinks href=#hl-482-49> 49</a>
</span><span class=lnt id=hl-482-50><a class=lnlinks href=#hl-482-50> 50</a>
</span><span class=lnt id=hl-482-51><a class=lnlinks href=#hl-482-51> 51</a>
</span><span class=lnt id=hl-482-52><a class=lnlinks href=#hl-482-52> 52</a>
</span><span class=lnt id=hl-482-53><a class=lnlinks href=#hl-482-53> 53</a>
</span><span class=lnt id=hl-482-54><a class=lnlinks href=#hl-482-54> 54</a>
</span><span class=lnt id=hl-482-55><a class=lnlinks href=#hl-482-55> 55</a>
</span><span class=lnt id=hl-482-56><a class=lnlinks href=#hl-482-56> 56</a>
</span><span class=lnt id=hl-482-57><a class=lnlinks href=#hl-482-57> 57</a>
</span><span class=lnt id=hl-482-58><a class=lnlinks href=#hl-482-58> 58</a>
</span><span class=lnt id=hl-482-59><a class=lnlinks href=#hl-482-59> 59</a>
</span><span class=lnt id=hl-482-60><a class=lnlinks href=#hl-482-60> 60</a>
</span><span class=lnt id=hl-482-61><a class=lnlinks href=#hl-482-61> 61</a>
</span><span class=lnt id=hl-482-62><a class=lnlinks href=#hl-482-62> 62</a>
</span><span class=lnt id=hl-482-63><a class=lnlinks href=#hl-482-63> 63</a>
</span><span class=lnt id=hl-482-64><a class=lnlinks href=#hl-482-64> 64</a>
</span><span class=lnt id=hl-482-65><a class=lnlinks href=#hl-482-65> 65</a>
</span><span class=lnt id=hl-482-66><a class=lnlinks href=#hl-482-66> 66</a>
</span><span class=lnt id=hl-482-67><a class=lnlinks href=#hl-482-67> 67</a>
</span><span class=lnt id=hl-482-68><a class=lnlinks href=#hl-482-68> 68</a>
</span><span class=lnt id=hl-482-69><a class=lnlinks href=#hl-482-69> 69</a>
</span><span class=lnt id=hl-482-70><a class=lnlinks href=#hl-482-70> 70</a>
</span><span class=lnt id=hl-482-71><a class=lnlinks href=#hl-482-71> 71</a>
</span><span class=lnt id=hl-482-72><a class=lnlinks href=#hl-482-72> 72</a>
</span><span class=lnt id=hl-482-73><a class=lnlinks href=#hl-482-73> 73</a>
</span><span class=lnt id=hl-482-74><a class=lnlinks href=#hl-482-74> 74</a>
</span><span class=lnt id=hl-482-75><a class=lnlinks href=#hl-482-75> 75</a>
</span><span class=lnt id=hl-482-76><a class=lnlinks href=#hl-482-76> 76</a>
</span><span class=lnt id=hl-482-77><a class=lnlinks href=#hl-482-77> 77</a>
</span><span class=lnt id=hl-482-78><a class=lnlinks href=#hl-482-78> 78</a>
</span><span class=lnt id=hl-482-79><a class=lnlinks href=#hl-482-79> 79</a>
</span><span class=lnt id=hl-482-80><a class=lnlinks href=#hl-482-80> 80</a>
</span><span class=lnt id=hl-482-81><a class=lnlinks href=#hl-482-81> 81</a>
</span><span class=lnt id=hl-482-82><a class=lnlinks href=#hl-482-82> 82</a>
</span><span class=lnt id=hl-482-83><a class=lnlinks href=#hl-482-83> 83</a>
</span><span class=lnt id=hl-482-84><a class=lnlinks href=#hl-482-84> 84</a>
</span><span class=lnt id=hl-482-85><a class=lnlinks href=#hl-482-85> 85</a>
</span><span class=lnt id=hl-482-86><a class=lnlinks href=#hl-482-86> 86</a>
</span><span class=lnt id=hl-482-87><a class=lnlinks href=#hl-482-87> 87</a>
</span><span class=lnt id=hl-482-88><a class=lnlinks href=#hl-482-88> 88</a>
</span><span class=lnt id=hl-482-89><a class=lnlinks href=#hl-482-89> 89</a>
</span><span class=lnt id=hl-482-90><a class=lnlinks href=#hl-482-90> 90</a>
</span><span class=lnt id=hl-482-91><a class=lnlinks href=#hl-482-91> 91</a>
</span><span class=lnt id=hl-482-92><a class=lnlinks href=#hl-482-92> 92</a>
</span><span class=lnt id=hl-482-93><a class=lnlinks href=#hl-482-93> 93</a>
</span><span class=lnt id=hl-482-94><a class=lnlinks href=#hl-482-94> 94</a>
</span><span class=lnt id=hl-482-95><a class=lnlinks href=#hl-482-95> 95</a>
</span><span class=lnt id=hl-482-96><a class=lnlinks href=#hl-482-96> 96</a>
</span><span class=lnt id=hl-482-97><a class=lnlinks href=#hl-482-97> 97</a>
</span><span class=lnt id=hl-482-98><a class=lnlinks href=#hl-482-98> 98</a>
</span><span class=lnt id=hl-482-99><a class=lnlinks href=#hl-482-99> 99</a>
</span><span class=lnt id=hl-482-100><a class=lnlinks href=#hl-482-100>100</a>
</span><span class=lnt id=hl-482-101><a class=lnlinks href=#hl-482-101>101</a>
</span><span class=lnt id=hl-482-102><a class=lnlinks href=#hl-482-102>102</a>
</span><span class=lnt id=hl-482-103><a class=lnlinks href=#hl-482-103>103</a>
</span><span class=lnt id=hl-482-104><a class=lnlinks href=#hl-482-104>104</a>
</span><span class=lnt id=hl-482-105><a class=lnlinks href=#hl-482-105>105</a>
</span><span class=lnt id=hl-482-106><a class=lnlinks href=#hl-482-106>106</a>
</span><span class=lnt id=hl-482-107><a class=lnlinks href=#hl-482-107>107</a>
</span><span class=lnt id=hl-482-108><a class=lnlinks href=#hl-482-108>108</a>
</span><span class=lnt id=hl-482-109><a class=lnlinks href=#hl-482-109>109</a>
</span><span class=lnt id=hl-482-110><a class=lnlinks href=#hl-482-110>110</a>
</span><span class=lnt id=hl-482-111><a class=lnlinks href=#hl-482-111>111</a>
</span><span class=lnt id=hl-482-112><a class=lnlinks href=#hl-482-112>112</a>
</span><span class=lnt id=hl-482-113><a class=lnlinks href=#hl-482-113>113</a>
</span><span class=lnt id=hl-482-114><a class=lnlinks href=#hl-482-114>114</a>
</span><span class=lnt id=hl-482-115><a class=lnlinks href=#hl-482-115>115</a>
</span><span class=lnt id=hl-482-116><a class=lnlinks href=#hl-482-116>116</a>
</span><span class=lnt id=hl-482-117><a class=lnlinks href=#hl-482-117>117</a>
</span><span class=lnt id=hl-482-118><a class=lnlinks href=#hl-482-118>118</a>
</span><span class=lnt id=hl-482-119><a class=lnlinks href=#hl-482-119>119</a>
</span><span class=lnt id=hl-482-120><a class=lnlinks href=#hl-482-120>120</a>
</span><span class=lnt id=hl-482-121><a class=lnlinks href=#hl-482-121>121</a>
</span><span class=lnt id=hl-482-122><a class=lnlinks href=#hl-482-122>122</a>
</span><span class=lnt id=hl-482-123><a class=lnlinks href=#hl-482-123>123</a>
</span><span class=lnt id=hl-482-124><a class=lnlinks href=#hl-482-124>124</a>
</span><span class=lnt id=hl-482-125><a class=lnlinks href=#hl-482-125>125</a>
</span><span class=lnt id=hl-482-126><a class=lnlinks href=#hl-482-126>126</a>
</span><span class=lnt id=hl-482-127><a class=lnlinks href=#hl-482-127>127</a>
</span><span class=lnt id=hl-482-128><a class=lnlinks href=#hl-482-128>128</a>
</span><span class=lnt id=hl-482-129><a class=lnlinks href=#hl-482-129>129</a>
</span><span class=lnt id=hl-482-130><a class=lnlinks href=#hl-482-130>130</a>
</span><span class=lnt id=hl-482-131><a class=lnlinks href=#hl-482-131>131</a>
</span><span class=lnt id=hl-482-132><a class=lnlinks href=#hl-482-132>132</a>
</span><span class=lnt id=hl-482-133><a class=lnlinks href=#hl-482-133>133</a>
</span><span class=lnt id=hl-482-134><a class=lnlinks href=#hl-482-134>134</a>
</span><span class=lnt id=hl-482-135><a class=lnlinks href=#hl-482-135>135</a>
</span><span class=lnt id=hl-482-136><a class=lnlinks href=#hl-482-136>136</a>
</span><span class=lnt id=hl-482-137><a class=lnlinks href=#hl-482-137>137</a>
</span><span class=lnt id=hl-482-138><a class=lnlinks href=#hl-482-138>138</a>
</span><span class=lnt id=hl-482-139><a class=lnlinks href=#hl-482-139>139</a>
</span><span class=lnt id=hl-482-140><a class=lnlinks href=#hl-482-140>140</a>
</span><span class=lnt id=hl-482-141><a class=lnlinks href=#hl-482-141>141</a>
</span><span class=lnt id=hl-482-142><a class=lnlinks href=#hl-482-142>142</a>
</span><span class=lnt id=hl-482-143><a class=lnlinks href=#hl-482-143>143</a>
</span><span class=lnt id=hl-482-144><a class=lnlinks href=#hl-482-144>144</a>
</span><span class=lnt id=hl-482-145><a class=lnlinks href=#hl-482-145>145</a>
</span><span class=lnt id=hl-482-146><a class=lnlinks href=#hl-482-146>146</a>
</span><span class=lnt id=hl-482-147><a class=lnlinks href=#hl-482-147>147</a>
</span><span class=lnt id=hl-482-148><a class=lnlinks href=#hl-482-148>148</a>
</span><span class=lnt id=hl-482-149><a class=lnlinks href=#hl-482-149>149</a>
</span><span class=lnt id=hl-482-150><a class=lnlinks href=#hl-482-150>150</a>
</span><span class=lnt id=hl-482-151><a class=lnlinks href=#hl-482-151>151</a>
</span><span class=lnt id=hl-482-152><a class=lnlinks href=#hl-482-152>152</a>
</span><span class=lnt id=hl-482-153><a class=lnlinks href=#hl-482-153>153</a>
</span><span class=lnt id=hl-482-154><a class=lnlinks href=#hl-482-154>154</a>
</span><span class=lnt id=hl-482-155><a class=lnlinks href=#hl-482-155>155</a>
</span><span class=lnt id=hl-482-156><a class=lnlinks href=#hl-482-156>156</a>
</span><span class=lnt id=hl-482-157><a class=lnlinks href=#hl-482-157>157</a>
</span><span class=lnt id=hl-482-158><a class=lnlinks href=#hl-482-158>158</a>
</span><span class=lnt id=hl-482-159><a class=lnlinks href=#hl-482-159>159</a>
</span><span class=lnt id=hl-482-160><a class=lnlinks href=#hl-482-160>160</a>
</span><span class=lnt id=hl-482-161><a class=lnlinks href=#hl-482-161>161</a>
</span><span class=lnt id=hl-482-162><a class=lnlinks href=#hl-482-162>162</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>putVal</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>final</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>putVal</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>onlyIfAbsent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NullPointerException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å…¶ä¸­ spread æ–¹æ³•ä¼šç»¼åˆé«˜ä½ä½ä½, å…·æœ‰æ›´å¥½çš„ hash æ€§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>spread</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>hashCode</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>binCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// f æ˜¯é“¾è¡¨å¤´èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// fh æ˜¯é“¾è¡¨å¤´ç»“ç‚¹çš„ hash</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// i æ˜¯é“¾è¡¨åœ¨ table ä¸­çš„ä¸‹æ ‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>fh</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¦åˆ›å»º table</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tab</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// åˆå§‹åŒ– table ä½¿ç”¨äº† cas, æ— éœ€ synchronized åˆ›å»ºæˆåŠŸ, è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>initTable</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¦åˆ›å»ºé“¾è¡¨å¤´èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tabAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>hash</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ·»åŠ é“¾è¡¨å¤´ä½¿ç”¨äº† cas, æ— éœ€ synchronized</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>casTabAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¸®å¿™æ‰©å®¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>fh</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>hash</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MOVED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¸®å¿™ä¹‹å, è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helpTransfer</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>V</span><span class=w> </span><span class=n>oldVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// é”ä½é“¾è¡¨å¤´èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å†æ¬¡ç¡®è®¤é“¾è¡¨å¤´èŠ‚ç‚¹æ²¡æœ‰è¢«ç§»åŠ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tabAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// é“¾è¡¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fh</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>binCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// éå†é“¾è¡¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>;;</span><span class=w> </span><span class=o>++</span><span class=n>binCount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>K</span><span class=w> </span><span class=n>ek</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// æ‰¾åˆ°ç›¸åŒçš„ key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>((</span><span class=n>ek</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                 </span><span class=p>(</span><span class=n>ek</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>ek</span><span class=p>))))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>oldVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>val</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// æ›´æ–°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>onlyIfAbsent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>e</span><span class=p>.</span><span class=na>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>pred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// å·²ç»æ˜¯æœ€åçš„èŠ‚ç‚¹äº†, æ–°å¢ Node, è¿½åŠ è‡³é“¾è¡¨å°¾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>pred</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                          </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// çº¢é»‘æ ‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>TreeBin</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>binCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// putTreeVal ä¼šçœ‹ key æ˜¯å¦å·²ç»åœ¨æ ‘ä¸­, æ˜¯, åˆ™è¿”å›å¯¹åº”çš„ TreeNode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>TreeBin</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=n>f</span><span class=p>).</span><span class=na>putTreeVal</span><span class=p>(</span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                              </span><span class=n>value</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>oldVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>val</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>onlyIfAbsent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>p</span><span class=p>.</span><span class=na>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// é‡Šæ”¾é“¾è¡¨å¤´èŠ‚ç‚¹çš„é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>binCount</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>binCount</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>TREEIFY_THRESHOLD</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å¦‚æœé“¾è¡¨é•¿åº¦ &gt;= æ ‘åŒ–é˜ˆå€¼(8), è¿›è¡Œé“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>treeifyBin</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>oldVal</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>oldVal</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¢åŠ  size è®¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>addCount</span><span class=p>(</span><span class=n>1L</span><span class=p>,</span><span class=w> </span><span class=n>binCount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=nf>initTable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>sc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sizeCtl</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>yield</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°è¯•å°† sizeCtl è®¾ç½®ä¸º -1ï¼ˆè¡¨ç¤ºåˆå§‹åŒ– tableï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>U</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>SIZECTL</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è·å¾—é”, åˆ›å»º table, è¿™æ—¶å…¶å®ƒçº¿ç¨‹ä¼šåœ¨ while() å¾ªç¯ä¸­ yield ç›´è‡³ table åˆ›å»º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>sc</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>DEFAULT_CAPACITY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>nt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=p>)</span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;?</span><span class=p>,</span><span class=o>?&gt;[</span><span class=n>n</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sizeCtl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>tab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// check æ˜¯ä¹‹å‰ binCount çš„ä¸ªæ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addCount</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>check</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CounterCell</span><span class=o>[]</span><span class=w> </span><span class=n>as</span><span class=p>;</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å·²ç»æœ‰äº† counterCells, å‘ cell ç´¯åŠ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>counterCells</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¿˜æ²¡æœ‰, å‘ baseCount ç´¯åŠ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>!</span><span class=n>U</span><span class=p>.</span><span class=na>compareAndSwapLong</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>BASECOUNT</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>baseCount</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CounterCell</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>m</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>uncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è¿˜æ²¡æœ‰ counterCells</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>as</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è¿˜æ²¡æœ‰ cell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=o>[</span><span class=n>ThreadLocalRandom</span><span class=p>.</span><span class=na>getProbe</span><span class=p>()</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>m</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// cell cas å¢åŠ è®¡æ•°å¤±è´¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=p>(</span><span class=n>uncontended</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>U</span><span class=p>.</span><span class=na>compareAndSwapLong</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>CELLVALUE</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>value</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// åˆ›å»ºç´¯åŠ å•å…ƒæ•°ç»„å’Œcell, ç´¯åŠ é‡è¯•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fullAddCount</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>uncontended</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>check</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å–å…ƒç´ ä¸ªæ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sumCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>check</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>nt</span><span class=p>;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)(</span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sizeCtl</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>MAXIMUM_CAPACITY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resizeStamp</span><span class=p>(</span><span class=n>n</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>sc</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>RESIZE_STAMP_SHIFT</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>sc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MAX_RESIZERS</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>nt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextTable</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>transferIndex</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// newtable å·²ç»åˆ›å»ºäº†ï¼Œå¸®å¿™æ‰©å®¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>U</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>SIZECTL</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>transfer</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>nt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// éœ€è¦æ‰©å®¹ï¼Œè¿™æ—¶ newtable æœªåˆ›å»º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>U</span><span class=p>.</span><span class=na>compareAndSwapInt</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>SIZECTL</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                         </span><span class=p>(</span><span class=n>rs</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>RESIZE_STAMP_SHIFT</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>2</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>transfer</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sumCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“ï¼š</p><ul><li>è¿›å…¥forå¾ªç¯ï¼š<ul><li>if tableä¸ºnullæˆ–è€…é•¿åº¦ ä¸º0<ul><li>åˆå§‹åŒ–è¡¨</li></ul></li><li>else if ç´¢å¼•å¤„æ— èŠ‚ç‚¹<ul><li>åˆ›å»ºèŠ‚ç‚¹ï¼Œå¡«å…¥keyå’Œvalueï¼Œæ”¾å…¥tableï¼Œé€€å‡ºå¾ªç¯</li></ul></li><li>else if ç´¢å¼•å¤„èŠ‚ç‚¹çš„hashå€¼ä¸ºMOVEï¼ˆForwardingNodeï¼‰ï¼Œè¡¨ç¤ºæ­£åœ¨æ‰©å®¹å’Œè¿ç§»<ul><li>å¸®å¿™</li></ul></li><li>else<ul><li>é”ä½å¤´èŠ‚ç‚¹<ul><li>if å†æ¬¡ç¡®è®¤å¤´èŠ‚ç‚¹æ²¡æœ‰è¢«ç§»åŠ¨<ul><li>if å¤´èŠ‚ç‚¹hashå€¼å¤§äº0ï¼ˆè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼‰<ul><li>éå†é“¾è¡¨æ‰¾åˆ°å¯¹åº”keyï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºã€‚</li></ul></li><li>else if èŠ‚ç‚¹ä¸ºçº¢é»‘æ ‘èŠ‚ç‚¹<ul><li>è°ƒç”¨<code>putTreeVal</code>æŸ¥çœ‹æ˜¯å¦æœ‰å¯¹åº”keyçš„æ•°èŠ‚ç‚¹<ul><li>å¦‚æœæœ‰ä¸”ä¸ºè¦†ç›–æ¨¡å¼ï¼Œå°†å€¼è¦†ç›–ï¼Œè¿”å›æ—§å€¼</li><li>å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºå¹¶æ’å…¥ï¼Œè¿”å›null</li></ul></li></ul></li></ul></li><li>è§£é”</li></ul></li><li>if binCountä¸ä¸º0<ul><li>å¦‚æœbinCountå¤§äºæ ‘åŒ–é˜ˆå€¼8<ul><li>æ ‘åŒ–</li></ul></li><li>å¦‚æœæ—§å€¼ä¸ä¸ºnull<ul><li>è¿”å›æ—§å€¼</li></ul></li><li>break</li></ul></li></ul></li></ul></li><li>å¢åŠ sizeè®¡æ•°</li><li>return null</li></ul><h5 id=size-è®¡ç®—æµç¨‹><a href=#size-%e8%ae%a1%e7%ae%97%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
size è®¡ç®—æµç¨‹</h5><p>size è®¡ç®—å®é™…å‘ç”Ÿåœ¨ putï¼Œremove æ”¹å˜é›†åˆå…ƒç´ çš„æ“ä½œä¹‹ä¸­</p><ul><li>æ²¡æœ‰ç«äº‰å‘ç”Ÿï¼Œå‘ baseCount ç´¯åŠ è®¡æ•°</li><li>æœ‰ç«äº‰å‘ç”Ÿï¼Œæ–°å»º counterCellsï¼Œå‘å…¶ä¸­çš„ä¸€ä¸ª cell ç´¯åŠ è®¡<ul><li>counterCells åˆå§‹æœ‰ä¸¤ä¸ª cell</li><li>å¦‚æœè®¡æ•°ç«äº‰æ¯”è¾ƒæ¿€çƒˆï¼Œä¼šåˆ›å»ºæ–°çš„ cell æ¥ç´¯åŠ è®¡æ•°</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-483-1><a class=lnlinks href=#hl-483-1> 1</a>
</span><span class=lnt id=hl-483-2><a class=lnlinks href=#hl-483-2> 2</a>
</span><span class=lnt id=hl-483-3><a class=lnlinks href=#hl-483-3> 3</a>
</span><span class=lnt id=hl-483-4><a class=lnlinks href=#hl-483-4> 4</a>
</span><span class=lnt id=hl-483-5><a class=lnlinks href=#hl-483-5> 5</a>
</span><span class=lnt id=hl-483-6><a class=lnlinks href=#hl-483-6> 6</a>
</span><span class=lnt id=hl-483-7><a class=lnlinks href=#hl-483-7> 7</a>
</span><span class=lnt id=hl-483-8><a class=lnlinks href=#hl-483-8> 8</a>
</span><span class=lnt id=hl-483-9><a class=lnlinks href=#hl-483-9> 9</a>
</span><span class=lnt id=hl-483-10><a class=lnlinks href=#hl-483-10>10</a>
</span><span class=lnt id=hl-483-11><a class=lnlinks href=#hl-483-11>11</a>
</span><span class=lnt id=hl-483-12><a class=lnlinks href=#hl-483-12>12</a>
</span><span class=lnt id=hl-483-13><a class=lnlinks href=#hl-483-13>13</a>
</span><span class=lnt id=hl-483-14><a class=lnlinks href=#hl-483-14>14</a>
</span><span class=lnt id=hl-483-15><a class=lnlinks href=#hl-483-15>15</a>
</span><span class=lnt id=hl-483-16><a class=lnlinks href=#hl-483-16>16</a>
</span><span class=lnt id=hl-483-17><a class=lnlinks href=#hl-483-17>17</a>
</span><span class=lnt id=hl-483-18><a class=lnlinks href=#hl-483-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>size</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sumCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>n</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0L</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>n</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>sumCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CounterCell</span><span class=o>[]</span><span class=w> </span><span class=n>as</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>counterCells</span><span class=p>;</span><span class=w> </span><span class=n>CounterCell</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°† baseCount è®¡æ•°ä¸æ‰€æœ‰ cell è®¡æ•°ç´¯åŠ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>baseCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>as</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>as</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>as</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=æ€»ç»“><a href=#%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
æ€»ç»“</h5><p><strong>Java 8</strong> æ•°ç»„ï¼ˆNodeï¼‰ +ï¼ˆ é“¾è¡¨ Node | çº¢é»‘æ ‘ TreeNode ï¼‰ ä»¥ä¸‹æ•°ç»„ç®€ç§°ï¼ˆtableï¼‰ï¼Œé“¾è¡¨ç®€ç§°ï¼ˆbinï¼‰</p><ul><li>åˆå§‹åŒ–ï¼Œä½¿ç”¨ cas æ¥ä¿è¯å¹¶å‘å®‰å…¨ï¼Œæ‡’æƒ°åˆå§‹åŒ– table</li><li>æ ‘åŒ–ï¼Œå½“ table.length &lt; 64 æ—¶ï¼Œå…ˆå°è¯•æ‰©å®¹ï¼Œè¶…è¿‡ 64 æ—¶ï¼Œå¹¶ä¸” bin.length > 8 æ—¶ï¼Œä¼šå°†é“¾è¡¨æ ‘åŒ–ï¼Œæ ‘åŒ–è¿‡ç¨‹ ä¼šç”¨ synchronized é”ä½é“¾è¡¨å¤´</li><li>putï¼Œå¦‚æœè¯¥ bin å°šæœªåˆ›å»ºï¼Œåªéœ€è¦ä½¿ç”¨ cas åˆ›å»º binï¼›å¦‚æœå·²ç»æœ‰äº†ï¼Œé”ä½é“¾è¡¨å¤´è¿›è¡Œåç»­ put æ“ä½œï¼Œå…ƒç´  æ·»åŠ è‡³ bin çš„å°¾éƒ¨</li><li>getï¼Œæ— é”æ“ä½œä»…éœ€è¦ä¿è¯å¯è§æ€§ï¼Œæ‰©å®¹è¿‡ç¨‹ä¸­ get æ“ä½œæ‹¿åˆ°çš„æ˜¯ ForwardingNode å®ƒä¼šè®© get æ“ä½œåœ¨æ–° table è¿›è¡Œæœç´¢</li><li>æ‰©å®¹ï¼Œæ‰©å®¹æ—¶ä»¥ bin ä¸ºå•ä½è¿›è¡Œï¼Œéœ€è¦å¯¹ bin è¿›è¡Œ synchronizedï¼Œä½†è¿™æ—¶å¦™çš„æ˜¯å…¶å®ƒç«äº‰çº¿ç¨‹ä¹Ÿä¸æ˜¯æ— äº‹å¯ åšï¼Œå®ƒä»¬ä¼šå¸®åŠ©æŠŠå…¶å®ƒ bin è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹æ—¶å¹³å‡åªæœ‰ 1/6 çš„èŠ‚ç‚¹ä¼šæŠŠå¤åˆ¶åˆ°æ–° table ä¸­</li><li>sizeï¼Œå…ƒç´ ä¸ªæ•°ä¿å­˜åœ¨ baseCount ä¸­ï¼Œå¹¶å‘æ—¶çš„ä¸ªæ•°å˜åŠ¨ä¿å­˜åœ¨ CounterCell[] å½“ä¸­ã€‚æœ€åç»Ÿè®¡æ•°é‡æ—¶ç´¯åŠ  å³å¯</li></ul><p>æºç åˆ†æ <a class=link href=http://www.importnew.com/28263.html target=_blank rel=noopener>http://www.importnew.com/28263.html
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><p>å…¶å®ƒå®ç° <a class=link href=https://github.com/boundary/high-scale-lib target=_blank rel=noopener>Cliff Click&rsquo;s high scale lib
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><h4 id=jdk-7-concurrenthashmap><a href=#jdk-7-concurrenthashmap class=header-anchor>#</a>
JDK 7 ConcurrentHashMap</h4><p>å®ƒç»´æŠ¤äº†ä¸€ä¸ª segment æ•°ç»„ï¼Œæ¯ä¸ª segment å¯¹åº”ä¸€æŠŠé”</p><ul><li>ä¼˜ç‚¹ï¼šå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„ segmentï¼Œå®é™…æ˜¯æ²¡æœ‰å†²çªçš„ï¼Œè¿™ä¸ jdk8 ä¸­æ˜¯ç±»ä¼¼çš„</li><li>ç¼ºç‚¹ï¼šSegments æ•°ç»„é»˜è®¤å¤§å°ä¸º16ï¼Œè¿™ä¸ªå®¹é‡åˆå§‹åŒ–æŒ‡å®šåå°±ä¸èƒ½æ”¹å˜äº†ï¼Œå¹¶ä¸”ä¸æ˜¯æ‡’æƒ°åˆå§‹åŒ–</li></ul><h5 id=æ„é€ å™¨åˆ†æ-1><a href=#%e6%9e%84%e9%80%a0%e5%99%a8%e5%88%86%e6%9e%90-1 class=header-anchor>#</a>
æ„é€ å™¨åˆ†æ</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-484-1><a class=lnlinks href=#hl-484-1> 1</a>
</span><span class=lnt id=hl-484-2><a class=lnlinks href=#hl-484-2> 2</a>
</span><span class=lnt id=hl-484-3><a class=lnlinks href=#hl-484-3> 3</a>
</span><span class=lnt id=hl-484-4><a class=lnlinks href=#hl-484-4> 4</a>
</span><span class=lnt id=hl-484-5><a class=lnlinks href=#hl-484-5> 5</a>
</span><span class=lnt id=hl-484-6><a class=lnlinks href=#hl-484-6> 6</a>
</span><span class=lnt id=hl-484-7><a class=lnlinks href=#hl-484-7> 7</a>
</span><span class=lnt id=hl-484-8><a class=lnlinks href=#hl-484-8> 8</a>
</span><span class=lnt id=hl-484-9><a class=lnlinks href=#hl-484-9> 9</a>
</span><span class=lnt id=hl-484-10><a class=lnlinks href=#hl-484-10>10</a>
</span><span class=lnt id=hl-484-11><a class=lnlinks href=#hl-484-11>11</a>
</span><span class=lnt id=hl-484-12><a class=lnlinks href=#hl-484-12>12</a>
</span><span class=lnt id=hl-484-13><a class=lnlinks href=#hl-484-13>13</a>
</span><span class=lnt id=hl-484-14><a class=lnlinks href=#hl-484-14>14</a>
</span><span class=lnt id=hl-484-15><a class=lnlinks href=#hl-484-15>15</a>
</span><span class=lnt id=hl-484-16><a class=lnlinks href=#hl-484-16>16</a>
</span><span class=lnt id=hl-484-17><a class=lnlinks href=#hl-484-17>17</a>
</span><span class=lnt id=hl-484-18><a class=lnlinks href=#hl-484-18>18</a>
</span><span class=lnt id=hl-484-19><a class=lnlinks href=#hl-484-19>19</a>
</span><span class=lnt id=hl-484-20><a class=lnlinks href=#hl-484-20>20</a>
</span><span class=lnt id=hl-484-21><a class=lnlinks href=#hl-484-21>21</a>
</span><span class=lnt id=hl-484-22><a class=lnlinks href=#hl-484-22>22</a>
</span><span class=lnt id=hl-484-23><a class=lnlinks href=#hl-484-23>23</a>
</span><span class=lnt id=hl-484-24><a class=lnlinks href=#hl-484-24>24</a>
</span><span class=lnt id=hl-484-25><a class=lnlinks href=#hl-484-25>25</a>
</span><span class=lnt id=hl-484-26><a class=lnlinks href=#hl-484-26>26</a>
</span><span class=lnt id=hl-484-27><a class=lnlinks href=#hl-484-27>27</a>
</span><span class=lnt id=hl-484-28><a class=lnlinks href=#hl-484-28>28</a>
</span><span class=lnt id=hl-484-29><a class=lnlinks href=#hl-484-29>29</a>
</span><span class=lnt id=hl-484-30><a class=lnlinks href=#hl-484-30>30</a>
</span><span class=lnt id=hl-484-31><a class=lnlinks href=#hl-484-31>31</a>
</span><span class=lnt id=hl-484-32><a class=lnlinks href=#hl-484-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>ConcurrentHashMap</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>initialCapacity</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>loadFactor</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>loadFactor</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>initialCapacity</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>concurrencyLevel</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>MAX_SEGMENTS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>concurrencyLevel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MAX_SEGMENTS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ssize å¿…é¡»æ˜¯ 2^n, å³ 2, 4, 8, 16 ... è¡¨ç¤ºäº† segments æ•°ç»„çš„å¤§å°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>sshift</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ssize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>ssize</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>concurrencyLevel</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>++</span><span class=n>sshift</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ssize</span><span class=w> </span><span class=o>&lt;&lt;=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// segmentShift é»˜è®¤æ˜¯ 32 - 4 = 28</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>segmentShift</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>32</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>sshift</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// segmentMask é»˜è®¤æ˜¯ 15 å³ 0000 0000 0000 1111</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>segmentMask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ssize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>initialCapacity</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>MAXIMUM_CAPACITY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>initialCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MAXIMUM_CAPACITY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>initialCapacity</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>ssize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>ssize</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>initialCapacity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>++</span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>cap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MIN_SEGMENT_TABLE_CAPACITY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>cap</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cap</span><span class=w> </span><span class=o>&lt;&lt;=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ›å»º segments and segments[0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>s0</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>loadFactor</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>cap</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>loadFactor</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=p>)</span><span class=k>new</span><span class=w> </span><span class=n>HashEntry</span><span class=o>[</span><span class=n>cap</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>ss</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=p>)</span><span class=k>new</span><span class=w> </span><span class=n>Segment</span><span class=o>[</span><span class=n>ssize</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>putOrderedObject</span><span class=p>(</span><span class=n>ss</span><span class=p>,</span><span class=w> </span><span class=n>SBASE</span><span class=p>,</span><span class=w> </span><span class=n>s0</span><span class=p>);</span><span class=w> </span><span class=c1>// ordered write of segments[0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>segments</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ss</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ„é€ å®Œæˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317180837785.png width=900 height=600 loading=lazy decoding=async alt=image-20220317180837785 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å¯ä»¥çœ‹åˆ° ConcurrentHashMap æ²¡æœ‰å®ç°æ‡’æƒ°åˆå§‹åŒ–ï¼Œç©ºé—´å ç”¨ä¸å‹å¥½</p><p>å…¶ä¸­ this.segmentShift å’Œ this.segmentMask çš„ä½œç”¨æ˜¯å†³å®šå°† key çš„ hash ç»“æœåŒ¹é…åˆ°å“ªä¸ª segment</p><p>ä¾‹å¦‚ï¼Œæ ¹æ®æŸä¸€ hash å€¼æ±‚ segment ä½ç½®ï¼Œå…ˆå°†é«˜ä½å‘ä½ä½ç§»åŠ¨ this.segmentShift ä½</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317180919562.png width=900 height=600 loading=lazy decoding=async alt=image-20220317180919562 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>ç»“æœå†ä¸ this.segmentMask åšä½äºè¿ç®—ï¼Œæœ€ç»ˆå¾—åˆ° 1010 å³ä¸‹æ ‡ä¸º 10 çš„ segment</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317180935914.png width=900 height=600 loading=lazy decoding=async alt=image-20220317180935914 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=put-æµç¨‹-1><a href=#put-%e6%b5%81%e7%a8%8b-1 class=header-anchor>#</a>
put æµç¨‹</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-485-1><a class=lnlinks href=#hl-485-1> 1</a>
</span><span class=lnt id=hl-485-2><a class=lnlinks href=#hl-485-2> 2</a>
</span><span class=lnt id=hl-485-3><a class=lnlinks href=#hl-485-3> 3</a>
</span><span class=lnt id=hl-485-4><a class=lnlinks href=#hl-485-4> 4</a>
</span><span class=lnt id=hl-485-5><a class=lnlinks href=#hl-485-5> 5</a>
</span><span class=lnt id=hl-485-6><a class=lnlinks href=#hl-485-6> 6</a>
</span><span class=lnt id=hl-485-7><a class=lnlinks href=#hl-485-7> 7</a>
</span><span class=lnt id=hl-485-8><a class=lnlinks href=#hl-485-8> 8</a>
</span><span class=lnt id=hl-485-9><a class=lnlinks href=#hl-485-9> 9</a>
</span><span class=lnt id=hl-485-10><a class=lnlinks href=#hl-485-10>10</a>
</span><span class=lnt id=hl-485-11><a class=lnlinks href=#hl-485-11>11</a>
</span><span class=lnt id=hl-485-12><a class=lnlinks href=#hl-485-12>12</a>
</span><span class=lnt id=hl-485-13><a class=lnlinks href=#hl-485-13>13</a>
</span><span class=lnt id=hl-485-14><a class=lnlinks href=#hl-485-14>14</a>
</span><span class=lnt id=hl-485-15><a class=lnlinks href=#hl-485-15>15</a>
</span><span class=lnt id=hl-485-16><a class=lnlinks href=#hl-485-16>16</a>
</span><span class=lnt id=hl-485-17><a class=lnlinks href=#hl-485-17>17</a>
</span><span class=lnt id=hl-485-18><a class=lnlinks href=#hl-485-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NullPointerException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è®¡ç®—å‡º segment ä¸‹æ ‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>hash</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>segmentShift</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>segmentMask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å¾— segment å¯¹è±¡, åˆ¤æ–­æ˜¯å¦ä¸º null, æ˜¯åˆ™åˆ›å»ºè¯¥ segment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>getObject</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>(</span><span class=n>segments</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>j</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>SSHIFT</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>SBASE</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¿™æ—¶ä¸èƒ½ç¡®å®šæ˜¯å¦çœŸçš„ä¸º null, å› ä¸ºå…¶å®ƒçº¿ç¨‹ä¹Ÿå‘ç°è¯¥ segment ä¸º null,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å› æ­¤åœ¨ ensureSegment é‡Œç”¨ cas æ–¹å¼ä¿è¯è¯¥ segment å®‰å…¨æ€§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ensureSegment</span><span class=p>(</span><span class=n>j</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿›å…¥ segment çš„put æµç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>segment ç»§æ‰¿äº†å¯é‡å…¥é”ï¼ˆReentrantLockï¼‰ï¼Œå®ƒçš„ put æ–¹æ³•ä¸º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-486-1><a class=lnlinks href=#hl-486-1> 1</a>
</span><span class=lnt id=hl-486-2><a class=lnlinks href=#hl-486-2> 2</a>
</span><span class=lnt id=hl-486-3><a class=lnlinks href=#hl-486-3> 3</a>
</span><span class=lnt id=hl-486-4><a class=lnlinks href=#hl-486-4> 4</a>
</span><span class=lnt id=hl-486-5><a class=lnlinks href=#hl-486-5> 5</a>
</span><span class=lnt id=hl-486-6><a class=lnlinks href=#hl-486-6> 6</a>
</span><span class=lnt id=hl-486-7><a class=lnlinks href=#hl-486-7> 7</a>
</span><span class=lnt id=hl-486-8><a class=lnlinks href=#hl-486-8> 8</a>
</span><span class=lnt id=hl-486-9><a class=lnlinks href=#hl-486-9> 9</a>
</span><span class=lnt id=hl-486-10><a class=lnlinks href=#hl-486-10>10</a>
</span><span class=lnt id=hl-486-11><a class=lnlinks href=#hl-486-11>11</a>
</span><span class=lnt id=hl-486-12><a class=lnlinks href=#hl-486-12>12</a>
</span><span class=lnt id=hl-486-13><a class=lnlinks href=#hl-486-13>13</a>
</span><span class=lnt id=hl-486-14><a class=lnlinks href=#hl-486-14>14</a>
</span><span class=lnt id=hl-486-15><a class=lnlinks href=#hl-486-15>15</a>
</span><span class=lnt id=hl-486-16><a class=lnlinks href=#hl-486-16>16</a>
</span><span class=lnt id=hl-486-17><a class=lnlinks href=#hl-486-17>17</a>
</span><span class=lnt id=hl-486-18><a class=lnlinks href=#hl-486-18>18</a>
</span><span class=lnt id=hl-486-19><a class=lnlinks href=#hl-486-19>19</a>
</span><span class=lnt id=hl-486-20><a class=lnlinks href=#hl-486-20>20</a>
</span><span class=lnt id=hl-486-21><a class=lnlinks href=#hl-486-21>21</a>
</span><span class=lnt id=hl-486-22><a class=lnlinks href=#hl-486-22>22</a>
</span><span class=lnt id=hl-486-23><a class=lnlinks href=#hl-486-23>23</a>
</span><span class=lnt id=hl-486-24><a class=lnlinks href=#hl-486-24>24</a>
</span><span class=lnt id=hl-486-25><a class=lnlinks href=#hl-486-25>25</a>
</span><span class=lnt id=hl-486-26><a class=lnlinks href=#hl-486-26>26</a>
</span><span class=lnt id=hl-486-27><a class=lnlinks href=#hl-486-27>27</a>
</span><span class=lnt id=hl-486-28><a class=lnlinks href=#hl-486-28>28</a>
</span><span class=lnt id=hl-486-29><a class=lnlinks href=#hl-486-29>29</a>
</span><span class=lnt id=hl-486-30><a class=lnlinks href=#hl-486-30>30</a>
</span><span class=lnt id=hl-486-31><a class=lnlinks href=#hl-486-31>31</a>
</span><span class=lnt id=hl-486-32><a class=lnlinks href=#hl-486-32>32</a>
</span><span class=lnt id=hl-486-33><a class=lnlinks href=#hl-486-33>33</a>
</span><span class=lnt id=hl-486-34><a class=lnlinks href=#hl-486-34>34</a>
</span><span class=lnt id=hl-486-35><a class=lnlinks href=#hl-486-35>35</a>
</span><span class=lnt id=hl-486-36><a class=lnlinks href=#hl-486-36>36</a>
</span><span class=lnt id=hl-486-37><a class=lnlinks href=#hl-486-37>37</a>
</span><span class=lnt id=hl-486-38><a class=lnlinks href=#hl-486-38>38</a>
</span><span class=lnt id=hl-486-39><a class=lnlinks href=#hl-486-39>39</a>
</span><span class=lnt id=hl-486-40><a class=lnlinks href=#hl-486-40>40</a>
</span><span class=lnt id=hl-486-41><a class=lnlinks href=#hl-486-41>41</a>
</span><span class=lnt id=hl-486-42><a class=lnlinks href=#hl-486-42>42</a>
</span><span class=lnt id=hl-486-43><a class=lnlinks href=#hl-486-43>43</a>
</span><span class=lnt id=hl-486-44><a class=lnlinks href=#hl-486-44>44</a>
</span><span class=lnt id=hl-486-45><a class=lnlinks href=#hl-486-45>45</a>
</span><span class=lnt id=hl-486-46><a class=lnlinks href=#hl-486-46>46</a>
</span><span class=lnt id=hl-486-47><a class=lnlinks href=#hl-486-47>47</a>
</span><span class=lnt id=hl-486-48><a class=lnlinks href=#hl-486-48>48</a>
</span><span class=lnt id=hl-486-49><a class=lnlinks href=#hl-486-49>49</a>
</span><span class=lnt id=hl-486-50><a class=lnlinks href=#hl-486-50>50</a>
</span><span class=lnt id=hl-486-51><a class=lnlinks href=#hl-486-51>51</a>
</span><span class=lnt id=hl-486-52><a class=lnlinks href=#hl-486-52>52</a>
</span><span class=lnt id=hl-486-53><a class=lnlinks href=#hl-486-53>53</a>
</span><span class=lnt id=hl-486-54><a class=lnlinks href=#hl-486-54>54</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>onlyIfAbsent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°è¯•åŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tryLock</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœä¸æˆåŠŸ, è¿›å…¥ scanAndLockForPut æµç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœæ˜¯å¤šæ ¸ cpu æœ€å¤š tryLock 64 æ¬¡, è¿›å…¥ lock æµç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åœ¨å°è¯•æœŸé—´, è¿˜å¯ä»¥é¡ºä¾¿çœ‹è¯¥èŠ‚ç‚¹åœ¨é“¾è¡¨ä¸­æœ‰æ²¡æœ‰, å¦‚æœæ²¡æœ‰é¡ºä¾¿åˆ›å»ºå‡ºæ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>scanAndLockForPut</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ‰§è¡Œåˆ°è¿™é‡Œ segment å·²ç»è¢«æˆåŠŸåŠ é”, å¯ä»¥å®‰å…¨æ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>V</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>hash</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entryAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ›´æ–°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>K</span><span class=w> </span><span class=n>k</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>k</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>onlyIfAbsent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>++</span><span class=n>modCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ–°å¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 1) ä¹‹å‰ç­‰å¾…é”æ—¶, node å·²ç»è¢«åˆ›å»º, next æŒ‡å‘é“¾è¡¨å¤´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>node</span><span class=p>.</span><span class=na>setNext</span><span class=p>(</span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 2) åˆ›å»ºæ–° node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>first</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 3) æ‰©å®¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>threshold</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>MAXIMUM_CAPACITY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>rehash</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å°† node ä½œä¸ºé“¾è¡¨å¤´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setEntryAt</span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>index</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>++</span><span class=n>modCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>oldValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>oldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=rehash-æµç¨‹><a href=#rehash-%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
rehash æµç¨‹</h5><p>å‘ç”Ÿåœ¨ put ä¸­ï¼Œå› ä¸ºæ­¤æ—¶å·²ç»è·å¾—äº†é”ï¼Œå› æ­¤ rehash æ—¶ä¸éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-487-1><a class=lnlinks href=#hl-487-1> 1</a>
</span><span class=lnt id=hl-487-2><a class=lnlinks href=#hl-487-2> 2</a>
</span><span class=lnt id=hl-487-3><a class=lnlinks href=#hl-487-3> 3</a>
</span><span class=lnt id=hl-487-4><a class=lnlinks href=#hl-487-4> 4</a>
</span><span class=lnt id=hl-487-5><a class=lnlinks href=#hl-487-5> 5</a>
</span><span class=lnt id=hl-487-6><a class=lnlinks href=#hl-487-6> 6</a>
</span><span class=lnt id=hl-487-7><a class=lnlinks href=#hl-487-7> 7</a>
</span><span class=lnt id=hl-487-8><a class=lnlinks href=#hl-487-8> 8</a>
</span><span class=lnt id=hl-487-9><a class=lnlinks href=#hl-487-9> 9</a>
</span><span class=lnt id=hl-487-10><a class=lnlinks href=#hl-487-10>10</a>
</span><span class=lnt id=hl-487-11><a class=lnlinks href=#hl-487-11>11</a>
</span><span class=lnt id=hl-487-12><a class=lnlinks href=#hl-487-12>12</a>
</span><span class=lnt id=hl-487-13><a class=lnlinks href=#hl-487-13>13</a>
</span><span class=lnt id=hl-487-14><a class=lnlinks href=#hl-487-14>14</a>
</span><span class=lnt id=hl-487-15><a class=lnlinks href=#hl-487-15>15</a>
</span><span class=lnt id=hl-487-16><a class=lnlinks href=#hl-487-16>16</a>
</span><span class=lnt id=hl-487-17><a class=lnlinks href=#hl-487-17>17</a>
</span><span class=lnt id=hl-487-18><a class=lnlinks href=#hl-487-18>18</a>
</span><span class=lnt id=hl-487-19><a class=lnlinks href=#hl-487-19>19</a>
</span><span class=lnt id=hl-487-20><a class=lnlinks href=#hl-487-20>20</a>
</span><span class=lnt id=hl-487-21><a class=lnlinks href=#hl-487-21>21</a>
</span><span class=lnt id=hl-487-22><a class=lnlinks href=#hl-487-22>22</a>
</span><span class=lnt id=hl-487-23><a class=lnlinks href=#hl-487-23>23</a>
</span><span class=lnt id=hl-487-24><a class=lnlinks href=#hl-487-24>24</a>
</span><span class=lnt id=hl-487-25><a class=lnlinks href=#hl-487-25>25</a>
</span><span class=lnt id=hl-487-26><a class=lnlinks href=#hl-487-26>26</a>
</span><span class=lnt id=hl-487-27><a class=lnlinks href=#hl-487-27>27</a>
</span><span class=lnt id=hl-487-28><a class=lnlinks href=#hl-487-28>28</a>
</span><span class=lnt id=hl-487-29><a class=lnlinks href=#hl-487-29>29</a>
</span><span class=lnt id=hl-487-30><a class=lnlinks href=#hl-487-30>30</a>
</span><span class=lnt id=hl-487-31><a class=lnlinks href=#hl-487-31>31</a>
</span><span class=lnt id=hl-487-32><a class=lnlinks href=#hl-487-32>32</a>
</span><span class=lnt id=hl-487-33><a class=lnlinks href=#hl-487-33>33</a>
</span><span class=lnt id=hl-487-34><a class=lnlinks href=#hl-487-34>34</a>
</span><span class=lnt id=hl-487-35><a class=lnlinks href=#hl-487-35>35</a>
</span><span class=lnt id=hl-487-36><a class=lnlinks href=#hl-487-36>36</a>
</span><span class=lnt id=hl-487-37><a class=lnlinks href=#hl-487-37>37</a>
</span><span class=lnt id=hl-487-38><a class=lnlinks href=#hl-487-38>38</a>
</span><span class=lnt id=hl-487-39><a class=lnlinks href=#hl-487-39>39</a>
</span><span class=lnt id=hl-487-40><a class=lnlinks href=#hl-487-40>40</a>
</span><span class=lnt id=hl-487-41><a class=lnlinks href=#hl-487-41>41</a>
</span><span class=lnt id=hl-487-42><a class=lnlinks href=#hl-487-42>42</a>
</span><span class=lnt id=hl-487-43><a class=lnlinks href=#hl-487-43>43</a>
</span><span class=lnt id=hl-487-44><a class=lnlinks href=#hl-487-44>44</a>
</span><span class=lnt id=hl-487-45><a class=lnlinks href=#hl-487-45>45</a>
</span><span class=lnt id=hl-487-46><a class=lnlinks href=#hl-487-46>46</a>
</span><span class=lnt id=hl-487-47><a class=lnlinks href=#hl-487-47>47</a>
</span><span class=lnt id=hl-487-48><a class=lnlinks href=#hl-487-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>rehash</span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>oldTable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>oldCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldTable</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>newCapacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldCapacity</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>threshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>newCapacity</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>loadFactor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>newTable</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=p>)</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashEntry</span><span class=o>[</span><span class=n>newCapacity</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>sizeMask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newCapacity</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>oldCapacity</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldTable</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sizeMask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=c1>// Single node on list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>newTable</span><span class=o>[</span><span class=n>idx</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// Reuse consecutive sequence at same slot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>lastRun</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>lastIdx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>idx</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è¿‡ä¸€éé“¾è¡¨, å°½å¯èƒ½æŠŠ rehash å idx ä¸å˜çš„èŠ‚ç‚¹é‡ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=n>last</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sizeMask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>lastIdx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lastIdx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>k</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lastRun</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>newTable</span><span class=o>[</span><span class=n>lastIdx</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastRun</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å‰©ä½™èŠ‚ç‚¹éœ€è¦æ–°å»º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>lastRun</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>V</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>hash</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sizeMask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=o>[</span><span class=n>k</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>newTable</span><span class=o>[</span><span class=n>k</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>key</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ‰©å®¹å®Œæˆ, æ‰åŠ å…¥æ–°çš„èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>nodeIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sizeMask</span><span class=p>;</span><span class=w> </span><span class=c1>// add the new node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>node</span><span class=p>.</span><span class=na>setNext</span><span class=p>(</span><span class=n>newTable</span><span class=o>[</span><span class=n>nodeIndex</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>newTable</span><span class=o>[</span><span class=n>nodeIndex</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ›¿æ¢ä¸ºæ–°çš„ HashEntry table</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newTable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é™„ï¼Œè°ƒè¯•ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-488-1><a class=lnlinks href=#hl-488-1> 1</a>
</span><span class=lnt id=hl-488-2><a class=lnlinks href=#hl-488-2> 2</a>
</span><span class=lnt id=hl-488-3><a class=lnlinks href=#hl-488-3> 3</a>
</span><span class=lnt id=hl-488-4><a class=lnlinks href=#hl-488-4> 4</a>
</span><span class=lnt id=hl-488-5><a class=lnlinks href=#hl-488-5> 5</a>
</span><span class=lnt id=hl-488-6><a class=lnlinks href=#hl-488-6> 6</a>
</span><span class=lnt id=hl-488-7><a class=lnlinks href=#hl-488-7> 7</a>
</span><span class=lnt id=hl-488-8><a class=lnlinks href=#hl-488-8> 8</a>
</span><span class=lnt id=hl-488-9><a class=lnlinks href=#hl-488-9> 9</a>
</span><span class=lnt id=hl-488-10><a class=lnlinks href=#hl-488-10>10</a>
</span><span class=lnt id=hl-488-11><a class=lnlinks href=#hl-488-11>11</a>
</span><span class=lnt id=hl-488-12><a class=lnlinks href=#hl-488-12>12</a>
</span><span class=lnt id=hl-488-13><a class=lnlinks href=#hl-488-13>13</a>
</span><span class=lnt id=hl-488-14><a class=lnlinks href=#hl-488-14>14</a>
</span><span class=lnt id=hl-488-15><a class=lnlinks href=#hl-488-15>15</a>
</span><span class=lnt id=hl-488-16><a class=lnlinks href=#hl-488-16>16</a>
</span><span class=lnt id=hl-488-17><a class=lnlinks href=#hl-488-17>17</a>
</span><span class=lnt id=hl-488-18><a class=lnlinks href=#hl-488-18>18</a>
</span><span class=lnt id=hl-488-19><a class=lnlinks href=#hl-488-19>19</a>
</span><span class=lnt id=hl-488-20><a class=lnlinks href=#hl-488-20>20</a>
</span><span class=lnt id=hl-488-21><a class=lnlinks href=#hl-488-21>21</a>
</span><span class=lnt id=hl-488-22><a class=lnlinks href=#hl-488-22>22</a>
</span><span class=lnt id=hl-488-23><a class=lnlinks href=#hl-488-23>23</a>
</span><span class=lnt id=hl-488-24><a class=lnlinks href=#hl-488-24>24</a>
</span><span class=lnt id=hl-488-25><a class=lnlinks href=#hl-488-25>25</a>
</span><span class=lnt id=hl-488-26><a class=lnlinks href=#hl-488-26>26</a>
</span><span class=lnt id=hl-488-27><a class=lnlinks href=#hl-488-27>27</a>
</span><span class=lnt id=hl-488-28><a class=lnlinks href=#hl-488-28>28</a>
</span><span class=lnt id=hl-488-29><a class=lnlinks href=#hl-488-29>29</a>
</span><span class=lnt id=hl-488-30><a class=lnlinks href=#hl-488-30>30</a>
</span><span class=lnt id=hl-488-31><a class=lnlinks href=#hl-488-31>31</a>
</span><span class=lnt id=hl-488-32><a class=lnlinks href=#hl-488-32>32</a>
</span><span class=lnt id=hl-488-33><a class=lnlinks href=#hl-488-33>33</a>
</span><span class=lnt id=hl-488-34><a class=lnlinks href=#hl-488-34>34</a>
</span><span class=lnt id=hl-488-35><a class=lnlinks href=#hl-488-35>35</a>
</span><span class=lnt id=hl-488-36><a class=lnlinks href=#hl-488-36>36</a>
</span><span class=lnt id=hl-488-37><a class=lnlinks href=#hl-488-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>segmentIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>hash</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>28</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>15</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>segmentIndex</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>4</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>8</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>segmentIndex</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>2</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>4</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                               </span><span class=s>&#34;\t&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>8</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>15</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 2 æ‰©å®¹ä¸º 4 15 çš„ hash%8 ä¸å…¶ä»–ä¸åŒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>169</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>197</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 4 æ‰©å®¹ä¸º 8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>341</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>484</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>545</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 8 æ‰©å®¹ä¸º 16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>912</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>941</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ok&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hash</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>k</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>0</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>h</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>String</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sun</span><span class=p>.</span><span class=na>misc</span><span class=p>.</span><span class=na>Hashing</span><span class=p>.</span><span class=na>stringHash32</span><span class=p>((</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>k</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=n>k</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Spread bits to regularize both segment and index locations,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// using variant of single-word Wang/Jenkins hash.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>15</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>0xffffcd7d</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>6</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>h</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>14</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>16</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=get-æµç¨‹><a href=#get-%e6%b5%81%e7%a8%8b class=header-anchor>#</a>
get æµç¨‹</h5><p>get æ—¶å¹¶æœªåŠ é”ï¼Œç”¨äº† UNSAFE æ–¹æ³•ä¿è¯äº†å¯è§æ€§ï¼Œæ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œget å…ˆå‘ç”Ÿå°±ä»æ—§è¡¨å–å†…å®¹ï¼Œget åå‘ç”Ÿå°±ä»æ–° è¡¨å–å†…å®¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-489-1><a class=lnlinks href=#hl-489-1> 1</a>
</span><span class=lnt id=hl-489-2><a class=lnlinks href=#hl-489-2> 2</a>
</span><span class=lnt id=hl-489-3><a class=lnlinks href=#hl-489-3> 3</a>
</span><span class=lnt id=hl-489-4><a class=lnlinks href=#hl-489-4> 4</a>
</span><span class=lnt id=hl-489-5><a class=lnlinks href=#hl-489-5> 5</a>
</span><span class=lnt id=hl-489-6><a class=lnlinks href=#hl-489-6> 6</a>
</span><span class=lnt id=hl-489-7><a class=lnlinks href=#hl-489-7> 7</a>
</span><span class=lnt id=hl-489-8><a class=lnlinks href=#hl-489-8> 8</a>
</span><span class=lnt id=hl-489-9><a class=lnlinks href=#hl-489-9> 9</a>
</span><span class=lnt id=hl-489-10><a class=lnlinks href=#hl-489-10>10</a>
</span><span class=lnt id=hl-489-11><a class=lnlinks href=#hl-489-11>11</a>
</span><span class=lnt id=hl-489-12><a class=lnlinks href=#hl-489-12>12</a>
</span><span class=lnt id=hl-489-13><a class=lnlinks href=#hl-489-13>13</a>
</span><span class=lnt id=hl-489-14><a class=lnlinks href=#hl-489-14>14</a>
</span><span class=lnt id=hl-489-15><a class=lnlinks href=#hl-489-15>15</a>
</span><span class=lnt id=hl-489-16><a class=lnlinks href=#hl-489-16>16</a>
</span><span class=lnt id=hl-489-17><a class=lnlinks href=#hl-489-17>17</a>
</span><span class=lnt id=hl-489-18><a class=lnlinks href=#hl-489-18>18</a>
</span><span class=lnt id=hl-489-19><a class=lnlinks href=#hl-489-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w> </span><span class=c1>// manually integrate access methods to reduce overhead</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// u ä¸º segment å¯¹è±¡åœ¨æ•°ç»„ä¸­çš„åç§»é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>u</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(((</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>segmentShift</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>segmentMask</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>SSHIFT</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>SBASE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// s å³ä¸º segment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>getObjectVolatile</span><span class=p>(</span><span class=n>segments</span><span class=p>,</span><span class=w> </span><span class=n>u</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>tab</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>table</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HashEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>UNSAFE</span><span class=p>.</span><span class=na>getObjectVolatile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=p>(</span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=kt>long</span><span class=p>)(((</span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>h</span><span class=p>))</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>TSHIFT</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>TBASE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>K</span><span class=w> </span><span class=n>k</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>k</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=size-è®¡ç®—æµç¨‹-1><a href=#size-%e8%ae%a1%e7%ae%97%e6%b5%81%e7%a8%8b-1 class=header-anchor>#</a>
size è®¡ç®—æµç¨‹</h5><ul><li>è®¡ç®—å…ƒç´ ä¸ªæ•°å‰ï¼Œå…ˆä¸åŠ é”è®¡ç®—ä¸¤æ¬¡ï¼Œå¦‚æœå‰åä¸¤æ¬¡ç»“æœå¦‚ä¸€æ ·ï¼Œè®¤ä¸ºä¸ªæ•°æ­£ç¡®è¿”å›</li><li>å¦‚æœä¸ä¸€æ ·ï¼Œè¿›è¡Œé‡è¯•ï¼Œé‡è¯•æ¬¡æ•°è¶…è¿‡ 3ï¼Œå°†æ‰€æœ‰ segment é”ä½ï¼Œé‡æ–°è®¡ç®—ä¸ªæ•°è¿”å›</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-490-1><a class=lnlinks href=#hl-490-1> 1</a>
</span><span class=lnt id=hl-490-2><a class=lnlinks href=#hl-490-2> 2</a>
</span><span class=lnt id=hl-490-3><a class=lnlinks href=#hl-490-3> 3</a>
</span><span class=lnt id=hl-490-4><a class=lnlinks href=#hl-490-4> 4</a>
</span><span class=lnt id=hl-490-5><a class=lnlinks href=#hl-490-5> 5</a>
</span><span class=lnt id=hl-490-6><a class=lnlinks href=#hl-490-6> 6</a>
</span><span class=lnt id=hl-490-7><a class=lnlinks href=#hl-490-7> 7</a>
</span><span class=lnt id=hl-490-8><a class=lnlinks href=#hl-490-8> 8</a>
</span><span class=lnt id=hl-490-9><a class=lnlinks href=#hl-490-9> 9</a>
</span><span class=lnt id=hl-490-10><a class=lnlinks href=#hl-490-10>10</a>
</span><span class=lnt id=hl-490-11><a class=lnlinks href=#hl-490-11>11</a>
</span><span class=lnt id=hl-490-12><a class=lnlinks href=#hl-490-12>12</a>
</span><span class=lnt id=hl-490-13><a class=lnlinks href=#hl-490-13>13</a>
</span><span class=lnt id=hl-490-14><a class=lnlinks href=#hl-490-14>14</a>
</span><span class=lnt id=hl-490-15><a class=lnlinks href=#hl-490-15>15</a>
</span><span class=lnt id=hl-490-16><a class=lnlinks href=#hl-490-16>16</a>
</span><span class=lnt id=hl-490-17><a class=lnlinks href=#hl-490-17>17</a>
</span><span class=lnt id=hl-490-18><a class=lnlinks href=#hl-490-18>18</a>
</span><span class=lnt id=hl-490-19><a class=lnlinks href=#hl-490-19>19</a>
</span><span class=lnt id=hl-490-20><a class=lnlinks href=#hl-490-20>20</a>
</span><span class=lnt id=hl-490-21><a class=lnlinks href=#hl-490-21>21</a>
</span><span class=lnt id=hl-490-22><a class=lnlinks href=#hl-490-22>22</a>
</span><span class=lnt id=hl-490-23><a class=lnlinks href=#hl-490-23>23</a>
</span><span class=lnt id=hl-490-24><a class=lnlinks href=#hl-490-24>24</a>
</span><span class=lnt id=hl-490-25><a class=lnlinks href=#hl-490-25>25</a>
</span><span class=lnt id=hl-490-26><a class=lnlinks href=#hl-490-26>26</a>
</span><span class=lnt id=hl-490-27><a class=lnlinks href=#hl-490-27>27</a>
</span><span class=lnt id=hl-490-28><a class=lnlinks href=#hl-490-28>28</a>
</span><span class=lnt id=hl-490-29><a class=lnlinks href=#hl-490-29>29</a>
</span><span class=lnt id=hl-490-30><a class=lnlinks href=#hl-490-30>30</a>
</span><span class=lnt id=hl-490-31><a class=lnlinks href=#hl-490-31>31</a>
</span><span class=lnt id=hl-490-32><a class=lnlinks href=#hl-490-32>32</a>
</span><span class=lnt id=hl-490-33><a class=lnlinks href=#hl-490-33>33</a>
</span><span class=lnt id=hl-490-34><a class=lnlinks href=#hl-490-34>34</a>
</span><span class=lnt id=hl-490-35><a class=lnlinks href=#hl-490-35>35</a>
</span><span class=lnt id=hl-490-36><a class=lnlinks href=#hl-490-36>36</a>
</span><span class=lnt id=hl-490-37><a class=lnlinks href=#hl-490-37>37</a>
</span><span class=lnt id=hl-490-38><a class=lnlinks href=#hl-490-38>38</a>
</span><span class=lnt id=hl-490-39><a class=lnlinks href=#hl-490-39>39</a>
</span><span class=lnt id=hl-490-40><a class=lnlinks href=#hl-490-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>size</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Try a few times to get accurate count. On failure due to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// continuous async changes in table, resort to locking.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;[]</span><span class=w> </span><span class=n>segments</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>segments</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>overflow</span><span class=p>;</span><span class=w> </span><span class=c1>// true if size overflows 32 bits</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>sum</span><span class=p>;</span><span class=w> </span><span class=c1>// sum of modCounts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0L</span><span class=p>;</span><span class=w> </span><span class=c1>// previous sum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>retries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=c1>// first iteration isn&#39;t retry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>retries</span><span class=o>++</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>RETRIES_BEFORE_LOCK</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è¶…è¿‡é‡è¯•æ¬¡æ•°, éœ€è¦åˆ›å»ºæ‰€æœ‰ segment å¹¶åŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>segments</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>j</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ensureSegment</span><span class=p>(</span><span class=n>j</span><span class=p>).</span><span class=na>lock</span><span class=p>();</span><span class=w> </span><span class=c1>// force creation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>overflow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>segments</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>j</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Segment</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>seg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>segmentAt</span><span class=p>(</span><span class=n>segments</span><span class=p>,</span><span class=w> </span><span class=n>j</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>seg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>seg</span><span class=p>.</span><span class=na>modCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seg</span><span class=p>.</span><span class=na>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>overflow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sum</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>last</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>retries</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>RETRIES_BEFORE_LOCK</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>segments</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>j</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>segmentAt</span><span class=p>(</span><span class=n>segments</span><span class=p>,</span><span class=w> </span><span class=n>j</span><span class=p>).</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>overflow</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=blockingqueue><a href=#blockingqueue class=header-anchor>#</a>
BlockingQueue</h2><h3 id=font-colorblue-blockingqueue-åŸç†font><a href=#font-colorblue-blockingqueue-%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>* BlockingQueue åŸç†</font></h3><h4 id=åŸºæœ¬çš„å…¥é˜Ÿå‡ºé˜Ÿ><a href=#%e5%9f%ba%e6%9c%ac%e7%9a%84%e5%85%a5%e9%98%9f%e5%87%ba%e9%98%9f class=header-anchor>#</a>
åŸºæœ¬çš„å…¥é˜Ÿå‡ºé˜Ÿ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-491-1><a class=lnlinks href=#hl-491-1> 1</a>
</span><span class=lnt id=hl-491-2><a class=lnlinks href=#hl-491-2> 2</a>
</span><span class=lnt id=hl-491-3><a class=lnlinks href=#hl-491-3> 3</a>
</span><span class=lnt id=hl-491-4><a class=lnlinks href=#hl-491-4> 4</a>
</span><span class=lnt id=hl-491-5><a class=lnlinks href=#hl-491-5> 5</a>
</span><span class=lnt id=hl-491-6><a class=lnlinks href=#hl-491-6> 6</a>
</span><span class=lnt id=hl-491-7><a class=lnlinks href=#hl-491-7> 7</a>
</span><span class=lnt id=hl-491-8><a class=lnlinks href=#hl-491-8> 8</a>
</span><span class=lnt id=hl-491-9><a class=lnlinks href=#hl-491-9> 9</a>
</span><span class=lnt id=hl-491-10><a class=lnlinks href=#hl-491-10>10</a>
</span><span class=lnt id=hl-491-11><a class=lnlinks href=#hl-491-11>11</a>
</span><span class=lnt id=hl-491-12><a class=lnlinks href=#hl-491-12>12</a>
</span><span class=lnt id=hl-491-13><a class=lnlinks href=#hl-491-13>13</a>
</span><span class=lnt id=hl-491-14><a class=lnlinks href=#hl-491-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractQueue</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>implements</span><span class=w> </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>E</span><span class=w> </span><span class=n>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> 		* ä¸‹åˆ—ä¸‰ç§æƒ…å†µä¹‹ä¸€
</span></span></span><span class=line><span class=cl><span class=cm> 		* - çœŸæ­£çš„åç»§èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=cm> 		* - è‡ªå·±, å‘ç”Ÿåœ¨å‡ºé˜Ÿæ—¶
</span></span></span><span class=line><span class=cl><span class=cm> 		* - null, è¡¨ç¤ºæ˜¯æ²¡æœ‰åç»§èŠ‚ç‚¹, æ˜¯æœ€åäº†
</span></span></span><span class=line><span class=cl><span class=cm> 		*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Node</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=åˆå§‹åŒ–é“¾è¡¨><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e9%93%be%e8%a1%a8 class=header-anchor>#</a>
åˆå§‹åŒ–é“¾è¡¨</h5><p><code>last = head = new Node(null);</code>Dummy èŠ‚ç‚¹ç”¨æ¥å ä½ï¼Œitem ä¸º null</p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220316215902936.png width=900 height=600 loading=lazy decoding=async alt=image-20220316215902936 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=å½“ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ><a href=#%e5%bd%93%e4%b8%80%e4%b8%aa%e8%8a%82%e7%82%b9%e5%85%a5%e9%98%9f class=header-anchor>#</a>
å½“ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ</h5><p><code>last = last.next = node;</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220316215925456.png width=900 height=600 loading=lazy decoding=async alt=image-20220316215925456 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p>å†æ¥ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ<code>last = last.next = node;</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220316215949461.png width=900 height=600 loading=lazy decoding=async alt=image-20220316215949461 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h5 id=å‡ºé˜Ÿ><a href=#%e5%87%ba%e9%98%9f class=header-anchor>#</a>
å‡ºé˜Ÿ</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-492-1><a class=lnlinks href=#hl-492-1> 1</a>
</span><span class=lnt id=hl-492-2><a class=lnlinks href=#hl-492-2> 2</a>
</span><span class=lnt id=hl-492-3><a class=lnlinks href=#hl-492-3> 3</a>
</span><span class=lnt id=hl-492-4><a class=lnlinks href=#hl-492-4> 4</a>
</span><span class=lnt id=hl-492-5><a class=lnlinks href=#hl-492-5> 5</a>
</span><span class=lnt id=hl-492-6><a class=lnlinks href=#hl-492-6> 6</a>
</span><span class=lnt id=hl-492-7><a class=lnlinks href=#hl-492-7> 7</a>
</span><span class=lnt id=hl-492-8><a class=lnlinks href=#hl-492-8> 8</a>
</span><span class=lnt id=hl-492-9><a class=lnlinks href=#hl-492-9> 9</a>
</span><span class=lnt id=hl-492-10><a class=lnlinks href=#hl-492-10>10</a>
</span><span class=lnt id=hl-492-11><a class=lnlinks href=#hl-492-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//ä¸´æ—¶å˜é‡hç”¨æ¥æŒ‡å‘å“¨å…µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//firstç”¨æ¥æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>h</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w> </span><span class=c1>// help GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//headèµ‹å€¼ä¸ºfirstï¼Œè¡¨ç¤ºfirstèŠ‚ç‚¹å°±æ˜¯ä¸‹ä¸€ä¸ªå“¨å…µã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>E</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//åˆ é™¤firstèŠ‚ç‚¹ä¸­çš„æ•°æ®ï¼Œè¡¨ç¤ºçœŸæ­£æˆä¸ºäº†å“¨å…µï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å‡ºé˜Ÿã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>first</span><span class=p>.</span><span class=na>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>h = head</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317142826808.png width=900 height=600 loading=lazy decoding=async alt=image-20220317142826808 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><code>first = h.next</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317142906729.png width=900 height=600 loading=lazy decoding=async alt=image-20220317142906729 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><code>h.next = h</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317142924725.png width=900 height=600 loading=lazy decoding=async alt=image-20220317142924725 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><p><code>head = first</code></p><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317142942832.png width=900 height=600 loading=lazy decoding=async alt=image-20220317142942832 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-493-1><a class=lnlinks href=#hl-493-1>1</a>
</span><span class=lnt id=hl-493-2><a class=lnlinks href=#hl-493-2>2</a>
</span><span class=lnt id=hl-493-3><a class=lnlinks href=#hl-493-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>E</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first</span><span class=p>.</span><span class=na>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>first</span><span class=p>.</span><span class=na>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=https://logan.1357810.xyz/notgit/juc/image-20220317143001497.png width=900 height=600 loading=lazy decoding=async alt=image-20220317143001497 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></p><h4 id=åŠ é”åˆ†æ><a href=#%e5%8a%a0%e9%94%81%e5%88%86%e6%9e%90 class=header-anchor>#</a>
åŠ é”åˆ†æ</h4><p><strong>é«˜æ˜ä¹‹å¤„</strong>åœ¨äºç”¨äº†ä¸¤æŠŠé”å’Œ dummy èŠ‚ç‚¹</p><ul><li>ç”¨ä¸€æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œæœ€å¤šåªå…è®¸æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ˆç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…ï¼ŒäºŒé€‰ä¸€ï¼‰æ‰§è¡Œ</li><li>ç”¨ä¸¤æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ<ul><li>æ¶ˆè´¹è€…ä¸æ¶ˆè´¹è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</li><li>ç”Ÿäº§è€…ä¸ç”Ÿäº§è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</li></ul></li></ul><p>çº¿ç¨‹å®‰å…¨åˆ†æ</p><ul><li>å½“èŠ‚ç‚¹æ€»æ•°å¤§äº 2 æ—¶ï¼ˆåŒ…æ‹¬ dummy èŠ‚ç‚¹ï¼‰ï¼ŒputLock ä¿è¯çš„æ˜¯ last èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ï¼ŒtakeLock ä¿è¯çš„æ˜¯ head èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ã€‚ä¸¤æŠŠé”ä¿è¯äº†å…¥é˜Ÿå’Œå‡ºé˜Ÿæ²¡æœ‰ç«äº‰</li><li>å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 2 æ—¶ï¼ˆå³ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹ï¼‰è¿™æ—¶å€™ï¼Œä»ç„¶æ˜¯ä¸¤æŠŠé”é”ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸ä¼šç«äº‰</li><li>å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 1 æ—¶ï¼ˆå°±ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼‰è¿™æ—¶ take çº¿ç¨‹ä¼šè¢« notEmpty æ¡ä»¶é˜»å¡ï¼Œæœ‰ç«äº‰ï¼Œä¼šé˜»å¡</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-494-1><a class=lnlinks href=#hl-494-1>1</a>
</span><span class=lnt id=hl-494-2><a class=lnlinks href=#hl-494-2>2</a>
</span><span class=lnt id=hl-494-3><a class=lnlinks href=#hl-494-3>3</a>
</span><span class=lnt id=hl-494-4><a class=lnlinks href=#hl-494-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ç”¨äº put(é˜»å¡) offer(éé˜»å¡)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>putLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ç”¨æˆ· take(é˜»å¡) poll(éé˜»å¡)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>takeLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>put æ“ä½œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-495-1><a class=lnlinks href=#hl-495-1> 1</a>
</span><span class=lnt id=hl-495-2><a class=lnlinks href=#hl-495-2> 2</a>
</span><span class=lnt id=hl-495-3><a class=lnlinks href=#hl-495-3> 3</a>
</span><span class=lnt id=hl-495-4><a class=lnlinks href=#hl-495-4> 4</a>
</span><span class=lnt id=hl-495-5><a class=lnlinks href=#hl-495-5> 5</a>
</span><span class=lnt id=hl-495-6><a class=lnlinks href=#hl-495-6> 6</a>
</span><span class=lnt id=hl-495-7><a class=lnlinks href=#hl-495-7> 7</a>
</span><span class=lnt id=hl-495-8><a class=lnlinks href=#hl-495-8> 8</a>
</span><span class=lnt id=hl-495-9><a class=lnlinks href=#hl-495-9> 9</a>
</span><span class=lnt id=hl-495-10><a class=lnlinks href=#hl-495-10>10</a>
</span><span class=lnt id=hl-495-11><a class=lnlinks href=#hl-495-11>11</a>
</span><span class=lnt id=hl-495-12><a class=lnlinks href=#hl-495-12>12</a>
</span><span class=lnt id=hl-495-13><a class=lnlinks href=#hl-495-13>13</a>
</span><span class=lnt id=hl-495-14><a class=lnlinks href=#hl-495-14>14</a>
</span><span class=lnt id=hl-495-15><a class=lnlinks href=#hl-495-15>15</a>
</span><span class=lnt id=hl-495-16><a class=lnlinks href=#hl-495-16>16</a>
</span><span class=lnt id=hl-495-17><a class=lnlinks href=#hl-495-17>17</a>
</span><span class=lnt id=hl-495-18><a class=lnlinks href=#hl-495-18>18</a>
</span><span class=lnt id=hl-495-19><a class=lnlinks href=#hl-495-19>19</a>
</span><span class=lnt id=hl-495-20><a class=lnlinks href=#hl-495-20>20</a>
</span><span class=lnt id=hl-495-21><a class=lnlinks href=#hl-495-21>21</a>
</span><span class=lnt id=hl-495-22><a class=lnlinks href=#hl-495-22>22</a>
</span><span class=lnt id=hl-495-23><a class=lnlinks href=#hl-495-23>23</a>
</span><span class=lnt id=hl-495-24><a class=lnlinks href=#hl-495-24>24</a>
</span><span class=lnt id=hl-495-25><a class=lnlinks href=#hl-495-25>25</a>
</span><span class=lnt id=hl-495-26><a class=lnlinks href=#hl-495-26>26</a>
</span><span class=lnt id=hl-495-27><a class=lnlinks href=#hl-495-27>27</a>
</span><span class=lnt id=hl-495-28><a class=lnlinks href=#hl-495-28>28</a>
</span><span class=lnt id=hl-495-29><a class=lnlinks href=#hl-495-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//LinkedBlockingQueueä¸æ”¯æŒç©ºå…ƒç´ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NullPointerException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>putLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>putLock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// count ç”¨æ¥ç»´æŠ¤å…ƒç´ è®¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>putLock</span><span class=p>.</span><span class=na>lockInterruptibly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ»¡äº†ç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å€’è¿‡æ¥è¯»å°±å¥½: ç­‰å¾… notFull</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notFull</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æœ‰ç©ºä½, å…¥é˜Ÿä¸”è®¡æ•°åŠ ä¸€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enqueue</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é™¤äº†è‡ªå·± put ä»¥å¤–, é˜Ÿåˆ—è¿˜æœ‰ç©ºä½, ç”±è‡ªå·±å«é†’å…¶ä»– put çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notFull</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>putLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœé˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªå…ƒç´ , å«é†’ take çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¿™é‡Œè°ƒç”¨çš„æ˜¯ notEmpty.signal() è€Œä¸æ˜¯ notEmpty.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>signalNotEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>take æ“ä½œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-496-1><a class=lnlinks href=#hl-496-1> 1</a>
</span><span class=lnt id=hl-496-2><a class=lnlinks href=#hl-496-2> 2</a>
</span><span class=lnt id=hl-496-3><a class=lnlinks href=#hl-496-3> 3</a>
</span><span class=lnt id=hl-496-4><a class=lnlinks href=#hl-496-4> 4</a>
</span><span class=lnt id=hl-496-5><a class=lnlinks href=#hl-496-5> 5</a>
</span><span class=lnt id=hl-496-6><a class=lnlinks href=#hl-496-6> 6</a>
</span><span class=lnt id=hl-496-7><a class=lnlinks href=#hl-496-7> 7</a>
</span><span class=lnt id=hl-496-8><a class=lnlinks href=#hl-496-8> 8</a>
</span><span class=lnt id=hl-496-9><a class=lnlinks href=#hl-496-9> 9</a>
</span><span class=lnt id=hl-496-10><a class=lnlinks href=#hl-496-10>10</a>
</span><span class=lnt id=hl-496-11><a class=lnlinks href=#hl-496-11>11</a>
</span><span class=lnt id=hl-496-12><a class=lnlinks href=#hl-496-12>12</a>
</span><span class=lnt id=hl-496-13><a class=lnlinks href=#hl-496-13>13</a>
</span><span class=lnt id=hl-496-14><a class=lnlinks href=#hl-496-14>14</a>
</span><span class=lnt id=hl-496-15><a class=lnlinks href=#hl-496-15>15</a>
</span><span class=lnt id=hl-496-16><a class=lnlinks href=#hl-496-16>16</a>
</span><span class=lnt id=hl-496-17><a class=lnlinks href=#hl-496-17>17</a>
</span><span class=lnt id=hl-496-18><a class=lnlinks href=#hl-496-18>18</a>
</span><span class=lnt id=hl-496-19><a class=lnlinks href=#hl-496-19>19</a>
</span><span class=lnt id=hl-496-20><a class=lnlinks href=#hl-496-20>20</a>
</span><span class=lnt id=hl-496-21><a class=lnlinks href=#hl-496-21>21</a>
</span><span class=lnt id=hl-496-22><a class=lnlinks href=#hl-496-22>22</a>
</span><span class=lnt id=hl-496-23><a class=lnlinks href=#hl-496-23>23</a>
</span><span class=lnt id=hl-496-24><a class=lnlinks href=#hl-496-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>take</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>E</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>takeLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>takeLock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>takeLock</span><span class=p>.</span><span class=na>lockInterruptibly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notEmpty</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dequeue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=p>.</span><span class=na>getAndDecrement</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notEmpty</span><span class=p>.</span><span class=na>signal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>takeLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœé˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªç©ºä½æ—¶, å«é†’ put çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œå‡ºé˜Ÿ, ç¬¬ä¸€ä¸ªçº¿ç¨‹æ»¡è¶³ c == capacity, ä½†åç»­çº¿ç¨‹ c &lt; capacity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>capacity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¿™é‡Œè°ƒç”¨çš„æ˜¯ notFull.signal() è€Œä¸æ˜¯ notFull.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>signalNotFull</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>ç”± put å”¤é†’ put æ˜¯ä¸ºäº†é¿å…ä¿¡å·ä¸è¶³</p></blockquote><h4 id=æ€§èƒ½æ¯”è¾ƒ><a href=#%e6%80%a7%e8%83%bd%e6%af%94%e8%be%83 class=header-anchor>#</a>
æ€§èƒ½æ¯”è¾ƒ</h4><p>ä¸»è¦åˆ—ä¸¾ LinkedBlockingQueue ä¸ ArrayBlockingQueue çš„æ€§èƒ½æ¯”è¾ƒ</p><ul><li>Linked æ”¯æŒæœ‰ç•Œï¼ŒArray å¼ºåˆ¶æœ‰ç•Œ</li><li>Linked å®ç°æ˜¯é“¾è¡¨ï¼ŒArray å®ç°æ˜¯æ•°ç»„</li><li>Linked æ˜¯æ‡’æƒ°çš„ï¼Œè€Œ Array éœ€è¦æå‰åˆå§‹åŒ– Node æ•°ç»„</li><li>Linked æ¯æ¬¡å…¥é˜Ÿä¼šç”Ÿæˆæ–° Nodeï¼Œè€Œ Array çš„ Node æ˜¯æå‰åˆ›å»ºå¥½çš„</li><li>Linked ä¸¤æŠŠé”ï¼ŒArray ä¸€æŠŠé”</li></ul><h2 id=concurrentlinkedqueue><a href=#concurrentlinkedqueue class=header-anchor>#</a>
ConcurrentLinkedQueue</h2><p>ConcurrentLinkedQueue çš„è®¾è®¡ä¸ LinkedBlockingQueue éå¸¸åƒï¼Œä¹Ÿæ˜¯</p><ul><li>ä¸¤æŠŠã€é”ã€‘ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ</li><li>dummy èŠ‚ç‚¹çš„å¼•å…¥è®©ä¸¤æŠŠã€é”ã€‘å°†æ¥é”ä½çš„æ˜¯ä¸åŒå¯¹è±¡ï¼Œé¿å…ç«äº‰</li><li>åªæ˜¯è¿™ã€é”ã€‘ä½¿ç”¨äº† cas æ¥å®ç°</li></ul><p>äº‹å®ä¸Šï¼ŒConcurrentLinkedQueue åº”ç”¨è¿˜æ˜¯éå¸¸å¹¿æ³›çš„</p><p>ä¾‹å¦‚ä¹‹å‰è®²çš„ Tomcat çš„ Connector ç»“æ„æ—¶ï¼ŒAcceptor ä½œä¸ºç”Ÿäº§è€…å‘ Poller æ¶ˆè´¹è€…ä¼ é€’äº‹ä»¶ä¿¡æ¯æ—¶ï¼Œæ­£æ˜¯é‡‡ç”¨äº† ConcurrentLinkedQueue å°† SocketChannel ç»™ Poller ä½¿ç”¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-497-1><a class=lnlinks href=#hl-497-1> 1</a>
</span><span class=lnt id=hl-497-2><a class=lnlinks href=#hl-497-2> 2</a>
</span><span class=lnt id=hl-497-3><a class=lnlinks href=#hl-497-3> 3</a>
</span><span class=lnt id=hl-497-4><a class=lnlinks href=#hl-497-4> 4</a>
</span><span class=lnt id=hl-497-5><a class=lnlinks href=#hl-497-5> 5</a>
</span><span class=lnt id=hl-497-6><a class=lnlinks href=#hl-497-6> 6</a>
</span><span class=lnt id=hl-497-7><a class=lnlinks href=#hl-497-7> 7</a>
</span><span class=lnt id=hl-497-8><a class=lnlinks href=#hl-497-8> 8</a>
</span><span class=lnt id=hl-497-9><a class=lnlinks href=#hl-497-9> 9</a>
</span><span class=lnt id=hl-497-10><a class=lnlinks href=#hl-497-10>10</a>
</span><span class=lnt id=hl-497-11><a class=lnlinks href=#hl-497-11>11</a>
</span><span class=lnt id=hl-497-12><a class=lnlinks href=#hl-497-12>12</a>
</span><span class=lnt id=hl-497-13><a class=lnlinks href=#hl-497-13>13</a>
</span><span class=lnt id=hl-497-14><a class=lnlinks href=#hl-497-14>14</a>
</span><span class=lnt id=hl-497-15><a class=lnlinks href=#hl-497-15>15</a>
</span><span class=lnt id=hl-497-16><a class=lnlinks href=#hl-497-16>16</a>
</span><span class=lnt id=hl-497-17><a class=lnlinks href=#hl-497-17>17</a>
</span><span class=lnt id=hl-497-18><a class=lnlinks href=#hl-497-18>18</a>
</span><span class=lnt id=hl-497-19><a class=lnlinks href=#hl-497-19>19</a>
</span><span class=lnt id=hl-497-20><a class=lnlinks href=#hl-497-20>20</a>
</span><span class=lnt id=hl-497-21><a class=lnlinks href=#hl-497-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>graph LR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>subgraph Connector-&gt;NIO EndPoint
</span></span><span class=line><span class=cl>t1(LimitLatch)
</span></span><span class=line><span class=cl>t2(Acceptor)
</span></span><span class=line><span class=cl>t3(SocketChannel 1)
</span></span><span class=line><span class=cl>t4(SocketChannel 2)
</span></span><span class=line><span class=cl>t5(Poller)
</span></span><span class=line><span class=cl>subgraph Executor
</span></span><span class=line><span class=cl>t7(worker1)
</span></span><span class=line><span class=cl>t8(worker2)
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>t1 --&gt; t2
</span></span><span class=line><span class=cl>t2 --&gt; t3
</span></span><span class=line><span class=cl>t2 --&gt; t4
</span></span><span class=line><span class=cl>t3 --æœ‰è¯»--&gt; t5
</span></span><span class=line><span class=cl>t4 --æœ‰è¯»--&gt; t5
</span></span><span class=line><span class=cl>t5 --socketProcessor--&gt; t7
</span></span><span class=line><span class=cl>t5 --socketProcessor--&gt; t8
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><h3 id=font-colorblueconcurrentlinkedqueue-åŸç†font><a href=#font-colorblueconcurrentlinkedqueue-%e5%8e%9f%e7%90%86font class=header-anchor>#</a>
<font color=blue>*ConcurrentLinkedQueue åŸç†</font></h3><h4 id=æ¨¡ä»¿-concurrentlinkedqueue><a href=#%e6%a8%a1%e4%bb%bf-concurrentlinkedqueue class=header-anchor>#</a>
æ¨¡ä»¿ ConcurrentLinkedQueue</h4><p>åˆå§‹ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-498-1><a class=lnlinks href=#hl-498-1>  1</a>
</span><span class=lnt id=hl-498-2><a class=lnlinks href=#hl-498-2>  2</a>
</span><span class=lnt id=hl-498-3><a class=lnlinks href=#hl-498-3>  3</a>
</span><span class=lnt id=hl-498-4><a class=lnlinks href=#hl-498-4>  4</a>
</span><span class=lnt id=hl-498-5><a class=lnlinks href=#hl-498-5>  5</a>
</span><span class=lnt id=hl-498-6><a class=lnlinks href=#hl-498-6>  6</a>
</span><span class=lnt id=hl-498-7><a class=lnlinks href=#hl-498-7>  7</a>
</span><span class=lnt id=hl-498-8><a class=lnlinks href=#hl-498-8>  8</a>
</span><span class=lnt id=hl-498-9><a class=lnlinks href=#hl-498-9>  9</a>
</span><span class=lnt id=hl-498-10><a class=lnlinks href=#hl-498-10> 10</a>
</span><span class=lnt id=hl-498-11><a class=lnlinks href=#hl-498-11> 11</a>
</span><span class=lnt id=hl-498-12><a class=lnlinks href=#hl-498-12> 12</a>
</span><span class=lnt id=hl-498-13><a class=lnlinks href=#hl-498-13> 13</a>
</span><span class=lnt id=hl-498-14><a class=lnlinks href=#hl-498-14> 14</a>
</span><span class=lnt id=hl-498-15><a class=lnlinks href=#hl-498-15> 15</a>
</span><span class=lnt id=hl-498-16><a class=lnlinks href=#hl-498-16> 16</a>
</span><span class=lnt id=hl-498-17><a class=lnlinks href=#hl-498-17> 17</a>
</span><span class=lnt id=hl-498-18><a class=lnlinks href=#hl-498-18> 18</a>
</span><span class=lnt id=hl-498-19><a class=lnlinks href=#hl-498-19> 19</a>
</span><span class=lnt id=hl-498-20><a class=lnlinks href=#hl-498-20> 20</a>
</span><span class=lnt id=hl-498-21><a class=lnlinks href=#hl-498-21> 21</a>
</span><span class=lnt id=hl-498-22><a class=lnlinks href=#hl-498-22> 22</a>
</span><span class=lnt id=hl-498-23><a class=lnlinks href=#hl-498-23> 23</a>
</span><span class=lnt id=hl-498-24><a class=lnlinks href=#hl-498-24> 24</a>
</span><span class=lnt id=hl-498-25><a class=lnlinks href=#hl-498-25> 25</a>
</span><span class=lnt id=hl-498-26><a class=lnlinks href=#hl-498-26> 26</a>
</span><span class=lnt id=hl-498-27><a class=lnlinks href=#hl-498-27> 27</a>
</span><span class=lnt id=hl-498-28><a class=lnlinks href=#hl-498-28> 28</a>
</span><span class=lnt id=hl-498-29><a class=lnlinks href=#hl-498-29> 29</a>
</span><span class=lnt id=hl-498-30><a class=lnlinks href=#hl-498-30> 30</a>
</span><span class=lnt id=hl-498-31><a class=lnlinks href=#hl-498-31> 31</a>
</span><span class=lnt id=hl-498-32><a class=lnlinks href=#hl-498-32> 32</a>
</span><span class=lnt id=hl-498-33><a class=lnlinks href=#hl-498-33> 33</a>
</span><span class=lnt id=hl-498-34><a class=lnlinks href=#hl-498-34> 34</a>
</span><span class=lnt id=hl-498-35><a class=lnlinks href=#hl-498-35> 35</a>
</span><span class=lnt id=hl-498-36><a class=lnlinks href=#hl-498-36> 36</a>
</span><span class=lnt id=hl-498-37><a class=lnlinks href=#hl-498-37> 37</a>
</span><span class=lnt id=hl-498-38><a class=lnlinks href=#hl-498-38> 38</a>
</span><span class=lnt id=hl-498-39><a class=lnlinks href=#hl-498-39> 39</a>
</span><span class=lnt id=hl-498-40><a class=lnlinks href=#hl-498-40> 40</a>
</span><span class=lnt id=hl-498-41><a class=lnlinks href=#hl-498-41> 41</a>
</span><span class=lnt id=hl-498-42><a class=lnlinks href=#hl-498-42> 42</a>
</span><span class=lnt id=hl-498-43><a class=lnlinks href=#hl-498-43> 43</a>
</span><span class=lnt id=hl-498-44><a class=lnlinks href=#hl-498-44> 44</a>
</span><span class=lnt id=hl-498-45><a class=lnlinks href=#hl-498-45> 45</a>
</span><span class=lnt id=hl-498-46><a class=lnlinks href=#hl-498-46> 46</a>
</span><span class=lnt id=hl-498-47><a class=lnlinks href=#hl-498-47> 47</a>
</span><span class=lnt id=hl-498-48><a class=lnlinks href=#hl-498-48> 48</a>
</span><span class=lnt id=hl-498-49><a class=lnlinks href=#hl-498-49> 49</a>
</span><span class=lnt id=hl-498-50><a class=lnlinks href=#hl-498-50> 50</a>
</span><span class=lnt id=hl-498-51><a class=lnlinks href=#hl-498-51> 51</a>
</span><span class=lnt id=hl-498-52><a class=lnlinks href=#hl-498-52> 52</a>
</span><span class=lnt id=hl-498-53><a class=lnlinks href=#hl-498-53> 53</a>
</span><span class=lnt id=hl-498-54><a class=lnlinks href=#hl-498-54> 54</a>
</span><span class=lnt id=hl-498-55><a class=lnlinks href=#hl-498-55> 55</a>
</span><span class=lnt id=hl-498-56><a class=lnlinks href=#hl-498-56> 56</a>
</span><span class=lnt id=hl-498-57><a class=lnlinks href=#hl-498-57> 57</a>
</span><span class=lnt id=hl-498-58><a class=lnlinks href=#hl-498-58> 58</a>
</span><span class=lnt id=hl-498-59><a class=lnlinks href=#hl-498-59> 59</a>
</span><span class=lnt id=hl-498-60><a class=lnlinks href=#hl-498-60> 60</a>
</span><span class=lnt id=hl-498-61><a class=lnlinks href=#hl-498-61> 61</a>
</span><span class=lnt id=hl-498-62><a class=lnlinks href=#hl-498-62> 62</a>
</span><span class=lnt id=hl-498-63><a class=lnlinks href=#hl-498-63> 63</a>
</span><span class=lnt id=hl-498-64><a class=lnlinks href=#hl-498-64> 64</a>
</span><span class=lnt id=hl-498-65><a class=lnlinks href=#hl-498-65> 65</a>
</span><span class=lnt id=hl-498-66><a class=lnlinks href=#hl-498-66> 66</a>
</span><span class=lnt id=hl-498-67><a class=lnlinks href=#hl-498-67> 67</a>
</span><span class=lnt id=hl-498-68><a class=lnlinks href=#hl-498-68> 68</a>
</span><span class=lnt id=hl-498-69><a class=lnlinks href=#hl-498-69> 69</a>
</span><span class=lnt id=hl-498-70><a class=lnlinks href=#hl-498-70> 70</a>
</span><span class=lnt id=hl-498-71><a class=lnlinks href=#hl-498-71> 71</a>
</span><span class=lnt id=hl-498-72><a class=lnlinks href=#hl-498-72> 72</a>
</span><span class=lnt id=hl-498-73><a class=lnlinks href=#hl-498-73> 73</a>
</span><span class=lnt id=hl-498-74><a class=lnlinks href=#hl-498-74> 74</a>
</span><span class=lnt id=hl-498-75><a class=lnlinks href=#hl-498-75> 75</a>
</span><span class=lnt id=hl-498-76><a class=lnlinks href=#hl-498-76> 76</a>
</span><span class=lnt id=hl-498-77><a class=lnlinks href=#hl-498-77> 77</a>
</span><span class=lnt id=hl-498-78><a class=lnlinks href=#hl-498-78> 78</a>
</span><span class=lnt id=hl-498-79><a class=lnlinks href=#hl-498-79> 79</a>
</span><span class=lnt id=hl-498-80><a class=lnlinks href=#hl-498-80> 80</a>
</span><span class=lnt id=hl-498-81><a class=lnlinks href=#hl-498-81> 81</a>
</span><span class=lnt id=hl-498-82><a class=lnlinks href=#hl-498-82> 82</a>
</span><span class=lnt id=hl-498-83><a class=lnlinks href=#hl-498-83> 83</a>
</span><span class=lnt id=hl-498-84><a class=lnlinks href=#hl-498-84> 84</a>
</span><span class=lnt id=hl-498-85><a class=lnlinks href=#hl-498-85> 85</a>
</span><span class=lnt id=hl-498-86><a class=lnlinks href=#hl-498-86> 86</a>
</span><span class=lnt id=hl-498-87><a class=lnlinks href=#hl-498-87> 87</a>
</span><span class=lnt id=hl-498-88><a class=lnlinks href=#hl-498-88> 88</a>
</span><span class=lnt id=hl-498-89><a class=lnlinks href=#hl-498-89> 89</a>
</span><span class=lnt id=hl-498-90><a class=lnlinks href=#hl-498-90> 90</a>
</span><span class=lnt id=hl-498-91><a class=lnlinks href=#hl-498-91> 91</a>
</span><span class=lnt id=hl-498-92><a class=lnlinks href=#hl-498-92> 92</a>
</span><span class=lnt id=hl-498-93><a class=lnlinks href=#hl-498-93> 93</a>
</span><span class=lnt id=hl-498-94><a class=lnlinks href=#hl-498-94> 94</a>
</span><span class=lnt id=hl-498-95><a class=lnlinks href=#hl-498-95> 95</a>
</span><span class=lnt id=hl-498-96><a class=lnlinks href=#hl-498-96> 96</a>
</span><span class=lnt id=hl-498-97><a class=lnlinks href=#hl-498-97> 97</a>
</span><span class=lnt id=hl-498-98><a class=lnlinks href=#hl-498-98> 98</a>
</span><span class=lnt id=hl-498-99><a class=lnlinks href=#hl-498-99> 99</a>
</span><span class=lnt id=hl-498-100><a class=lnlinks href=#hl-498-100>100</a>
</span><span class=lnt id=hl-498-101><a class=lnlinks href=#hl-498-101>101</a>
</span><span class=lnt id=hl-498-102><a class=lnlinks href=#hl-498-102>102</a>
</span><span class=lnt id=hl-498-103><a class=lnlinks href=#hl-498-103>103</a>
</span><span class=lnt id=hl-498-104><a class=lnlinks href=#hl-498-104>104</a>
</span><span class=lnt id=hl-498-105><a class=lnlinks href=#hl-498-105>105</a>
</span><span class=lnt id=hl-498-106><a class=lnlinks href=#hl-498-106>106</a>
</span><span class=lnt id=hl-498-107><a class=lnlinks href=#hl-498-107>107</a>
</span><span class=lnt id=hl-498-108><a class=lnlinks href=#hl-498-108>108</a>
</span><span class=lnt id=hl-498-109><a class=lnlinks href=#hl-498-109>109</a>
</span><span class=lnt id=hl-498-110><a class=lnlinks href=#hl-498-110>110</a>
</span><span class=lnt id=hl-498-111><a class=lnlinks href=#hl-498-111>111</a>
</span><span class=lnt id=hl-498-112><a class=lnlinks href=#hl-498-112>112</a>
</span><span class=lnt id=hl-498-113><a class=lnlinks href=#hl-498-113>113</a>
</span><span class=lnt id=hl-498-114><a class=lnlinks href=#hl-498-114>114</a>
</span><span class=lnt id=hl-498-115><a class=lnlinks href=#hl-498-115>115</a>
</span><span class=lnt id=hl-498-116><a class=lnlinks href=#hl-498-116>116</a>
</span><span class=lnt id=hl-498-117><a class=lnlinks href=#hl-498-117>117</a>
</span><span class=lnt id=hl-498-118><a class=lnlinks href=#hl-498-118>118</a>
</span><span class=lnt id=hl-498-119><a class=lnlinks href=#hl-498-119>119</a>
</span><span class=lnt id=hl-498-120><a class=lnlinks href=#hl-498-120>120</a>
</span><span class=lnt id=hl-498-121><a class=lnlinks href=#hl-498-121>121</a>
</span><span class=lnt id=hl-498-122><a class=lnlinks href=#hl-498-122>122</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>cn.itcast.concurrent.thirdpart.test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Collection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Iterator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Queue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.atomic.AtomicReference</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test3</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MyQueue</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MyQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=s>&#34;3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>queue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>MyQueue</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Queue</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StringBuilder</span><span class=w> </span><span class=n>sb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringBuilder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>get</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>E</span><span class=w> </span><span class=n>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>item</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sb</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>item</span><span class=p>).</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;-&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sb</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sb</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>size</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isEmpty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>contains</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=nf>iterator</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=nf>toArray</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=o>[]</span><span class=w> </span><span class=nf>toArray</span><span class=p>(</span><span class=n>T</span><span class=o>[]</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>remove</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>containsAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>addAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>removeAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>retainAll</span><span class=p>(</span><span class=n>Collection</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>clear</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>remove</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>element</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>peek</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MyQueue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>last</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>dequeue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*Node&lt;E&gt; h = head;
</span></span></span><span class=line><span class=cl><span class=cm> 		Node&lt;E&gt; first = h.next;
</span></span></span><span class=line><span class=cl><span class=cm> 		h.next = h;
</span></span></span><span class=line><span class=cl><span class=cm> 		head = first;
</span></span></span><span class=line><span class=cl><span class=cm>        E x = first.item;
</span></span></span><span class=line><span class=cl><span class=cm> 		first.item = null;
</span></span></span><span class=line><span class=cl><span class=cm> 		return x;*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=nf>poll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>offer</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>volatile</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=n>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>Node</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>item</span><span class=p>,</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>offer</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-499-1><a class=lnlinks href=#hl-499-1> 1</a>
</span><span class=lnt id=hl-499-2><a class=lnlinks href=#hl-499-2> 2</a>
</span><span class=lnt id=hl-499-3><a class=lnlinks href=#hl-499-3> 3</a>
</span><span class=lnt id=hl-499-4><a class=lnlinks href=#hl-499-4> 4</a>
</span><span class=lnt id=hl-499-5><a class=lnlinks href=#hl-499-5> 5</a>
</span><span class=lnt id=hl-499-6><a class=lnlinks href=#hl-499-6> 6</a>
</span><span class=lnt id=hl-499-7><a class=lnlinks href=#hl-499-7> 7</a>
</span><span class=lnt id=hl-499-8><a class=lnlinks href=#hl-499-8> 8</a>
</span><span class=lnt id=hl-499-9><a class=lnlinks href=#hl-499-9> 9</a>
</span><span class=lnt id=hl-499-10><a class=lnlinks href=#hl-499-10>10</a>
</span><span class=lnt id=hl-499-11><a class=lnlinks href=#hl-499-11>11</a>
</span><span class=lnt id=hl-499-12><a class=lnlinks href=#hl-499-12>12</a>
</span><span class=lnt id=hl-499-13><a class=lnlinks href=#hl-499-13>13</a>
</span><span class=lnt id=hl-499-14><a class=lnlinks href=#hl-499-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>offer</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å–å°¾èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// S1: çœŸæ­£å°¾èŠ‚ç‚¹çš„ next æ˜¯ null, cas ä» null åˆ°æ–°èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è¿™æ—¶çš„ last å·²ç»æ˜¯å€’æ•°ç¬¬äºŒ, next ä¸ä¸ºç©ºäº†, å…¶å®ƒçº¿ç¨‹çš„ cas è‚¯å®šå¤±è´¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// S2: æ›´æ–° last ä¸ºå€’æ•°ç¬¬ä¸€çš„èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=copyonwritearraylist><a href=#copyonwritearraylist class=header-anchor>#</a>
CopyOnWriteArrayList</h2><p><code>CopyOnWriteArraySet</code>æ˜¯å®ƒçš„é©¬ç”² åº•å±‚å®ç°é‡‡ç”¨äº† å†™å…¥æ—¶æ‹·è´ çš„æ€æƒ³ï¼Œå¢åˆ æ”¹æ“ä½œä¼šå°†åº•å±‚æ•°ç»„æ‹·è´ä¸€ä»½ï¼Œæ›´ æ”¹æ“ä½œåœ¨æ–°æ•°ç»„ä¸Šæ‰§è¡Œï¼Œè¿™æ—¶ä¸å½±å“å…¶å®ƒçº¿ç¨‹çš„<strong>å¹¶å‘è¯»</strong>ï¼Œ<strong>è¯»å†™åˆ†ç¦»</strong>ã€‚ ä»¥æ–°å¢ä¸ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-500-1><a class=lnlinks href=#hl-500-1> 1</a>
</span><span class=lnt id=hl-500-2><a class=lnlinks href=#hl-500-2> 2</a>
</span><span class=lnt id=hl-500-3><a class=lnlinks href=#hl-500-3> 3</a>
</span><span class=lnt id=hl-500-4><a class=lnlinks href=#hl-500-4> 4</a>
</span><span class=lnt id=hl-500-5><a class=lnlinks href=#hl-500-5> 5</a>
</span><span class=lnt id=hl-500-6><a class=lnlinks href=#hl-500-6> 6</a>
</span><span class=lnt id=hl-500-7><a class=lnlinks href=#hl-500-7> 7</a>
</span><span class=lnt id=hl-500-8><a class=lnlinks href=#hl-500-8> 8</a>
</span><span class=lnt id=hl-500-9><a class=lnlinks href=#hl-500-9> 9</a>
</span><span class=lnt id=hl-500-10><a class=lnlinks href=#hl-500-10>10</a>
</span><span class=lnt id=hl-500-11><a class=lnlinks href=#hl-500-11>11</a>
</span><span class=lnt id=hl-500-12><a class=lnlinks href=#hl-500-12>12</a>
</span><span class=lnt id=hl-500-13><a class=lnlinks href=#hl-500-13>13</a>
</span><span class=lnt id=hl-500-14><a class=lnlinks href=#hl-500-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å–æ—§çš„æ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>es</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getArray</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>es</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‹·è´æ–°çš„æ•°ç»„ï¼ˆè¿™é‡Œæ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œä½†ä¸å½±å“å…¶å®ƒè¯»çº¿ç¨‹ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>es</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>copyOf</span><span class=p>(</span><span class=n>es</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ·»åŠ æ–°å…ƒç´ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>es</span><span class=o>[</span><span class=n>len</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ›¿æ¢æ—§çš„æ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setArray</span><span class=p>(</span><span class=n>es</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>è¿™é‡Œçš„æºç ç‰ˆæœ¬æ˜¯ Java 11ï¼Œåœ¨ Java 1.8 ä¸­ä½¿ç”¨çš„æ˜¯å¯é‡å…¥é”è€Œä¸æ˜¯ synchronized</p></blockquote><p>å…¶å®ƒè¯»æ“ä½œå¹¶æœªåŠ é”ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-501-1><a class=lnlinks href=#hl-501-1>1</a>
</span><span class=lnt id=hl-501-2><a class=lnlinks href=#hl-501-2>2</a>
</span><span class=lnt id=hl-501-3><a class=lnlinks href=#hl-501-3>3</a>
</span><span class=lnt id=hl-501-4><a class=lnlinks href=#hl-501-4>4</a>
</span><span class=lnt id=hl-501-5><a class=lnlinks href=#hl-501-5>5</a>
</span><span class=lnt id=hl-501-6><a class=lnlinks href=#hl-501-6>6</a>
</span><span class=lnt id=hl-501-7><a class=lnlinks href=#hl-501-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>forEach</span><span class=p>(</span><span class=n>Consumer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>action</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Objects</span><span class=p>.</span><span class=na>requireNonNull</span><span class=p>(</span><span class=n>action</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>getArray</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>E</span><span class=p>)</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>action</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é€‚åˆã€è¯»å¤šå†™å°‘ã€çš„åº”ç”¨åœºæ™¯</p><h5 id=get-å¼±ä¸€è‡´æ€§image-20220317202641399httpslogan1357810xyznotgitjucimage-20220317202641399png><a href=#get-%e5%bc%b1%e4%b8%80%e8%87%b4%e6%80%a7image-20220317202641399httpslogan1357810xyznotgitjucimage-20220317202641399png class=header-anchor>#</a>
get å¼±ä¸€è‡´æ€§
<img src=https://logan.1357810.xyz/notgit/juc/image-20220317202641399.png width=900 height=600 loading=lazy decoding=async alt=image-20220317202641399 class="gallery-image link-image" data-flex-grow=20 data-flex-basis=20px></h5><div class=table-wrapper><table><thead><tr><th style=text-align:center>æ—¶é—´ç‚¹</th><th style=text-align:center>æ“ä½œ</th></tr></thead><tbody><tr><td style=text-align:center>1</td><td style=text-align:center>Thread-0 getArray()</td></tr><tr><td style=text-align:center>2</td><td style=text-align:center>Thread-1 getArray()</td></tr><tr><td style=text-align:center>3</td><td style=text-align:center>Thread-1 setArray(arrayCopy)</td></tr><tr><td style=text-align:center>4</td><td style=text-align:center>Thread-0 array[index]</td></tr></tbody></table></div><blockquote><p>ä¸å®¹æ˜“æµ‹è¯•ï¼Œä½†é—®é¢˜ç¡®å®å­˜åœ¨</p></blockquote><h5 id=è¿­ä»£å™¨å¼±ä¸€è‡´æ€§><a href=#%e8%bf%ad%e4%bb%a3%e5%99%a8%e5%bc%b1%e4%b8%80%e8%87%b4%e6%80%a7 class=header-anchor>#</a>
è¿­ä»£å™¨å¼±ä¸€è‡´æ€§</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-502-1><a class=lnlinks href=#hl-502-1> 1</a>
</span><span class=lnt id=hl-502-2><a class=lnlinks href=#hl-502-2> 2</a>
</span><span class=lnt id=hl-502-3><a class=lnlinks href=#hl-502-3> 3</a>
</span><span class=lnt id=hl-502-4><a class=lnlinks href=#hl-502-4> 4</a>
</span><span class=lnt id=hl-502-5><a class=lnlinks href=#hl-502-5> 5</a>
</span><span class=lnt id=hl-502-6><a class=lnlinks href=#hl-502-6> 6</a>
</span><span class=lnt id=hl-502-7><a class=lnlinks href=#hl-502-7> 7</a>
</span><span class=lnt id=hl-502-8><a class=lnlinks href=#hl-502-8> 8</a>
</span><span class=lnt id=hl-502-9><a class=lnlinks href=#hl-502-9> 9</a>
</span><span class=lnt id=hl-502-10><a class=lnlinks href=#hl-502-10>10</a>
</span><span class=lnt id=hl-502-11><a class=lnlinks href=#hl-502-11>11</a>
</span><span class=lnt id=hl-502-12><a class=lnlinks href=#hl-502-12>12</a>
</span><span class=lnt id=hl-502-13><a class=lnlinks href=#hl-502-13>13</a>
</span><span class=lnt id=hl-502-14><a class=lnlinks href=#hl-502-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CopyOnWriteArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>iter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>list</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleep1s</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//æ­¤æ—¶ä¸»çº¿ç¨‹çš„iteratorä¾æ—§æŒ‡å‘æ—§çš„æ•°ç»„ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>iter</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>iter</span><span class=p>.</span><span class=na>next</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>ä¸è¦è§‰å¾—å¼±ä¸€è‡´æ€§å°±ä¸å¥½</p><ul><li>æ•°æ®åº“çš„ MVCC éƒ½æ˜¯å¼±ä¸€è‡´æ€§çš„è¡¨ç°</li><li>å¹¶å‘é«˜å’Œä¸€è‡´æ€§æ˜¯çŸ›ç›¾çš„ï¼Œéœ€è¦æƒè¡¡</li></ul></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/juc/>Juc</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>æœ€åæ›´æ–°äº 2024å¹´5æœˆ8æ—¥ 21:39</span></section></footer></article><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/waline/2.9.1/waline.min.css crossorigin=anonymous><script src=https://cdn.bootcdn.net/ajax/libs/waline/2.9.1/waline.min.js crossorigin=anonymous></script><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],lang:"zh-cn",locale:{admin:"Admin",placeholder:null},requiredMeta:["nick"],serverURL:"https://waline.wssw.fun/"})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 &nbsp;&nbsp;by &nbsp; logan</section><section class=powerby>å‘è¡¨äº†88ç¯‡æ–‡ç«  Â·
æ€»è®¡565.78kå­—</section><section class=powerby><div class=powerby><span id=busuanzi_container_site_pv>æœ¬ç«™æ€»è®¿é—®é‡<span id=busuanzi_value_site_pv></span>æ¬¡
</span><span id=busuanzi_container_site_uv>æœ¬ç«™è®¿å®¢æ•°<span id=busuanzi_value_site_uv></span>äººæ¬¡</span></div></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.js crossorigin=anonymous defer></script><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.css crossorigin=anonymous><script src=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js crossorigin=anonymous defer></script><link rel=preload as=style onload='this.rel="stylesheet"' href=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css crossorigin=anonymous></main></div><script type=text/javascript src=/ts/main.js defer></script><a href=javascript:void(0) class=right_things id=back-to-top title=è¿”å›é¡¶éƒ¨></a><style>html{scroll-behavior:smooth}#back-to-top{z-index:998!important;transition:1.5s ease,opacity 2s ease,visibility 2s ease,right .8s ease;opacity:0;display:inline-block;visibility:hidden;position:fixed;bottom:10px;right:10px;width:55px;height:55px;font-size:30px;text-align:center;line-height:50px;border-radius:20px;box-shadow:var(--shadow-l1);cursor:pointer;color:var(--body-text-color);background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #241348 0%, #4d0404 100%); }}#back-to-top:before{content:' ';display:inline-block;position:relative;top:0;transform:rotate(135deg);height:10px;width:10px;border-width:0 0 2px 2px;border-style:solid}#back-to-top:hover{transform:scale(1.1,1.1);background-image:linear-gradient(-225deg,#E3FDF5 0%,#FFE6FA 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #432581 0%, #861818 100%); }}#back-to-top:hover:before{border-color:#2674e0}@media screen and (max-width:768px){#back-to-top{width:35px;height:35px;font-size:10px;right:15px}}</style><script>function resizeRight(){var t=document.querySelectorAll(".right_things"),e=window.innerWidth;t.length>0&&t.forEach(function(t){e>2100?t.style.right="280px":e>1800?t.style.right="120px":e<1800&&(t.style.right="10px")})}window.addEventListener("resize",function(){requestAnimationFrame(resizeRight)});function backToTop(){window.scrollTo({top:0,behavior:"smooth"})}window.onload=function(){requestAnimationFrame(resizeRight);var t=this.document.documentElement.scrollTop||this.document.body.scrollTop,e=this.document.getElementById("back-to-top");t>0?(e.style.visibility="visible",e.style.opacity="1"):(e.style.opacity="0",e.style.visibility="hidden")},window.onscroll=function(){var t=this.document.documentElement.scrollTop||this.document.body.scrollTop,e=this.document.getElementById("back-to-top");t<400?(e.style.opacity="0",e.style.visibility="hidden"):(e.style.visibility="visible",e.style.opacity="1",e.addEventListener("click",backToTop,!1))}</script><style>.toggle-toc-inner,.toggle-toc-inner svg{z-index:1!important;pointer-events:none}.toggle-toc-inner{width:100%;height:100%;display:flex;align-items:center;justify-content:center}.toggle-toc-inner svg{display:none}#toc-container{display:none;position:fixed;bottom:120px;right:80px;padding:10px;border:1px solid #96979a50;border-radius:var(--card-border-radius);box-shadow:rgba(14,30,37,.12)0 2px 4px,rgba(14,30,37,.32)0 2px 16px;z-index:997!important;max-height:80vh;overflow-y:auto;width:auto;max-width:290px;background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(45deg, #8baaaa 0%, #ae8b9c 100%); color: #FFFFFFB2; }}#TableOfContents{background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(45deg, #8baaaa 0%, #ae8b9c 100%); }}#TableOfContents a:hover{font-weight:bolder}[data-scheme=dark] #TableOfContents a{color:#212223}[data-scheme=dark] #TableOfContents a:hover{color:#052ed3}#toggle-toc{transition:1.5s ease,opacity 2s ease,visibility 2s ease,right .8s ease;opacity:0;display:block;visibility:hidden;position:fixed;bottom:75px;right:10px;width:55px;height:55px;font-size:1.7rem;padding:5px;z-index:1000!important;border:0 solid #96979a50;border-radius:20px;box-shadow:var(--shadow-l1);color:#707070;cursor:pointer;background-image:linear-gradient(-20deg,#e9defa 0%,#fbfcdb 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #241348 0%, #4d0404 100%); color: #FFFFFFB2; } animation: jump 0.3s 4;animation-delay:.6s}#toggle-toc:hover{transform:scale(1.1,1.1);background-image:linear-gradient(-225deg,#E3FDF5 0%,#FFE6FA 100%); [data-scheme="dark"] & { background-image: linear-gradient(60deg, #432581 0%, #861818 100%); }}.widget--toc #TableOfContents{overflow-x:auto;max-height:66vh;width:auto}.toggle-toc-inner::before{content:'ç›®å½•'}@media screen and (max-width:768px){#toggle-toc{width:35px;height:35px;font-size:10px;bottom:60px;right:15px}.toggle-toc-inner::before{content:''}.toggle-toc-inner svg{display:block}#toc-container{bottom:100px;right:60px}}</style><a id=toggle-toc class=right_things title=ç›®å½• href=javascript:void(0)><div class=toggle-toc-inner><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></div></a><section class="widget archives" id=toc-container><h2 class=section-title>ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#2è¿›ç¨‹ä¸çº¿ç¨‹>2.è¿›ç¨‹ä¸çº¿ç¨‹</a><ol><li><a href=#21-è¿›ç¨‹ä¸çº¿ç¨‹>2.1 è¿›ç¨‹ä¸çº¿ç¨‹</a><ol><li><a href=#è¿›ç¨‹>è¿›ç¨‹</a></li><li><a href=#çº¿ç¨‹>çº¿ç¨‹</a></li><li><a href=#äºŒè€…å¯¹æ¯”>äºŒè€…å¯¹æ¯”</a></li></ol></li><li><a href=#22-å¹¶è¡Œä¸å¹¶å‘>2.2 å¹¶è¡Œä¸å¹¶å‘</a></li><li><a href=#23-åº”ç”¨>2.3 åº”ç”¨</a><ol><li><a href=#textcolorgreenåº”ç”¨ä¹‹å¼‚æ­¥è°ƒç”¨æ¡ˆä¾‹1->$\textcolor{Green}{*åº”ç”¨ä¹‹å¼‚æ­¥è°ƒç”¨ï¼ˆæ¡ˆä¾‹1ï¼‰} $</a><ol><li><a href=#éœ€è¦ç­‰å¾…ç»“æœ>éœ€è¦ç­‰å¾…ç»“æœ</a><ol><li><a href=#future-å®ç°åŒæ­¥>Future å®ç°ï¼ˆåŒæ­¥ï¼‰</a></li><li><a href=#è‡ªå®šä¹‰å®ç°åŒæ­¥>è‡ªå®šä¹‰å®ç°ï¼ˆåŒæ­¥ï¼‰</a></li><li><a href=#completablefuture-å®ç°å¼‚æ­¥>CompletableFuture å®ç°ï¼ˆå¼‚æ­¥ï¼‰</a></li><li><a href=#blockingqueue-å®ç°å¼‚æ­¥>BlockingQueue å®ç°ï¼ˆå¼‚æ­¥ï¼‰</a></li></ol></li><li><a href=#ä¸éœ€ç­‰å¾…ç»“æœ>ä¸éœ€ç­‰å¾…ç»“æœ</a><ol><li><a href=#æ™®é€šçº¿ç¨‹å®ç°>æ™®é€šçº¿ç¨‹å®ç°</a></li><li><a href=#çº¿ç¨‹æ± å®ç°>çº¿ç¨‹æ± å®ç°</a></li><li><a href=#completablefuture-å®ç°>CompletableFuture å®ç°</a></li></ol></li></ol></li><li><a href=#textcolorgreenåº”ç”¨ä¹‹æé«˜æ•ˆç‡æ¡ˆä¾‹1->$\textcolor{Green}{*åº”ç”¨ä¹‹æé«˜æ•ˆç‡ï¼ˆæ¡ˆä¾‹1ï¼‰ }$</a><ol><li><ol><li><a href=#1è®¾è®¡>1.è®¾è®¡</a></li><li><a href=#2ç»“è®º>2.ç»“è®º</a></li></ol></li></ol></li></ol></li></ol></li><li><a href=#3java-çº¿ç¨‹>3.Java çº¿ç¨‹</a><ol><li><a href=#31-åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹>3.1 åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹</a><ol><li><a href=#æ–¹æ³•ä¸€ç›´æ¥ä½¿ç”¨-thread>æ–¹æ³•ä¸€ï¼Œç›´æ¥ä½¿ç”¨ Thread</a></li><li><a href=#æ–¹æ³•äºŒä½¿ç”¨-runnable-é…åˆ-thread>æ–¹æ³•äºŒï¼Œä½¿ç”¨ Runnable é…åˆ Thread</a><ol><li><ol><li><a href=#thread-ä¸-runnable-çš„å…³ç³»>Thread ä¸ Runnable çš„å…³ç³»</a></li><li><a href=#å°ç»“>å°ç»“</a></li></ol></li></ol></li><li><a href=#æ–¹æ³•ä¸‰futuretask-é…åˆ-thread>æ–¹æ³•ä¸‰ï¼ŒFutureTask é…åˆ Thread</a></li></ol></li><li><a href=#32-è§‚å¯Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ>3.2 è§‚å¯Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</a></li><li><a href=#33-æŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•>3.3 æŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•</a><ol><li><a href=#windows>windows</a></li><li><a href=#linux>Linux</a></li><li><a href=#java>Java</a></li></ol></li><li><a href=#textcolorblue34--åŸç†ä¹‹çº¿ç¨‹è¿è¡Œ->$\textcolor{Blue}{3.4 * åŸç†ä¹‹çº¿ç¨‹è¿è¡Œ} $</a><ol><li><a href=#æ ˆä¸æ ˆå¸§>æ ˆä¸æ ˆå¸§</a></li><li><a href=#çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢thread-context-switch>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰</a></li></ol></li><li><a href=#35å¸¸è§æ–¹æ³•>3.5å¸¸è§æ–¹æ³•</a></li><li><a href=#36-start-ä¸-run>3.6 start ä¸ run</a><ol><li><a href=#è°ƒç”¨-run>è°ƒç”¨ run</a></li><li><a href=#è°ƒç”¨start>è°ƒç”¨start</a></li><li><a href=#å°ç»“-1>å°ç»“</a></li></ol></li><li><a href=#37-sleep-ä¸-yield>3.7 sleep ä¸ yield</a><ol><li><a href=#sleep>sleep</a></li><li><a href=#yield>yield</a></li><li><a href=#çº¿ç¨‹ä¼˜å…ˆçº§>çº¿ç¨‹ä¼˜å…ˆçº§</a></li><li><a href=#æµ‹è¯•ä¼˜å…ˆçº§å’Œyield>æµ‹è¯•ä¼˜å…ˆçº§å’Œyield</a></li><li><a href=#textcolorgreen-åº”ç”¨ä¹‹é™åˆ¶æ¡ˆä¾‹1-->$\textcolor{Green}{* åº”ç”¨ä¹‹é™åˆ¶ï¼ˆæ¡ˆä¾‹1ï¼‰ } $</a><ol><li><a href=#sleep-å®ç°>sleep å®ç°</a></li><li><a href=#wait-å®ç°>wait å®ç°</a></li><li><a href=#æ¡ä»¶å˜é‡å®ç°>æ¡ä»¶å˜é‡å®ç°</a></li></ol></li></ol></li><li><a href=#38-join-æ–¹æ³•è¯¦è§£>3.8 join æ–¹æ³•è¯¦è§£</a><ol><li><a href=#ä¸ºä»€ä¹ˆéœ€è¦-join>ä¸ºä»€ä¹ˆéœ€è¦ join</a></li><li><a href=#textcolorgreen-åº”ç”¨ä¹‹åŒæ­¥æ¡ˆä¾‹1>$\textcolor{green}{* åº”ç”¨ä¹‹åŒæ­¥ï¼ˆæ¡ˆä¾‹1ï¼‰}$</a></li><li><a href=#æœ‰æ—¶æ•ˆçš„join>æœ‰æ—¶æ•ˆçš„join</a></li></ol></li><li><a href=#39-interruptæ–¹æ³•è¯¦è§£>3.9 interruptæ–¹æ³•è¯¦è§£</a><ol><li><a href=#interruptè¯´æ˜><code>Interrupt</code>è¯´æ˜</a></li><li><a href=#æ‰“æ–­-sleepwaitjoin-çš„çº¿ç¨‹>æ‰“æ–­ sleepï¼Œwaitï¼Œjoin çš„çº¿ç¨‹</a></li><li><a href=#æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹>æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹</a></li><li><a href=#font-colororange-æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢font><font color=orange>* æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢</font></a><ol><li><a href=#é”™è¯¯æ€è·¯>é”™è¯¯æ€è·¯</a></li><li><a href=#ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼>ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</a><ol><li><a href=#åˆ©ç”¨-isinterrupted>åˆ©ç”¨ isInterrupted</a></li><li><a href=#åˆ©ç”¨åœæ­¢æ ‡è®°>åˆ©ç”¨åœæ­¢æ ‡è®°</a></li></ol></li></ol></li><li><a href=#æ‰“æ–­-park-çº¿ç¨‹>æ‰“æ–­ park çº¿ç¨‹</a></li></ol></li><li><a href=#310-ä¸æ¨èçš„æ–¹æ³•>3.10 ä¸æ¨èçš„æ–¹æ³•</a></li><li><a href=#311-ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹>3.11 ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹</a></li><li><a href=#312-äº”ç§çŠ¶æ€>3.12 äº”ç§çŠ¶æ€</a></li><li><a href=#313-å…­ç§çŠ¶æ€>3.13 å…­ç§çŠ¶æ€</a></li><li><a href=#314-ä¹ é¢˜>3.14 ä¹ é¢˜</a><ol><li><a href=#textcolorgreen-åº”ç”¨ä¹‹ç»Ÿç­¹çƒ§æ°´æ³¡èŒ¶>$\textcolor{green}{* åº”ç”¨ä¹‹ç»Ÿç­¹ï¼ˆçƒ§æ°´æ³¡èŒ¶ï¼‰}$</a><ol><li><a href=#è§£æ³•1join>è§£æ³•1ï¼šjoin</a></li><li><a href=#è§£æ³•2waitnotify>è§£æ³•2ï¼šwait/notify</a></li><li><a href=#è§£æ³•3ç¬¬ä¸‰è€…åè°ƒ>è§£æ³•3ï¼šç¬¬ä¸‰è€…åè°ƒ</a></li></ol></li></ol></li><li><a href=#æœ¬ç« å°ç»“>æœ¬ç« å°ç»“</a></li></ol></li><li><a href=#4å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹>4.å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹</a><ol><li><a href=#41å…±äº«å¸¦æ¥çš„é—®é¢˜>4.1å…±äº«å¸¦æ¥çš„é—®é¢˜</a><ol><li><ol><li><ol><li><a href=#javaä»£ç ç¤ºä¾‹><strong>Javaä»£ç ç¤ºä¾‹</strong></a></li><li><a href=#é—®é¢˜åˆ†æ><strong>é—®é¢˜åˆ†æ</strong></a></li><li><a href=#ä¸´ç•ŒåŒº-critical-section><strong>ä¸´ç•ŒåŒº Critical Section</strong></a></li><li><a href=#ç«æ€æ¡ä»¶-race-condition><strong>ç«æ€æ¡ä»¶ Race Condition</strong></a></li></ol></li></ol></li></ol></li><li><a href=#42-synchronized-è§£å†³æ–¹æ¡ˆ>4.2 synchronized è§£å†³æ–¹æ¡ˆ</a><ol><li><ol><li><ol><li><a href=#textcolorgreenåº”ç”¨ä¹‹äº’æ–¥>*<em>$\textcolor{green}{<em>åº”ç”¨ä¹‹äº’æ–¥}$</em></em></a></li><li><a href=#synchronized><strong>synchronized</strong></a></li><li><a href=#é¢å‘å¯¹è±¡æ”¹è¿›><strong>é¢å‘å¯¹è±¡æ”¹è¿›</strong></a></li></ol></li></ol></li></ol></li><li><a href=#43-æ–¹æ³•ä¸Šçš„-synchronized>4.3 æ–¹æ³•ä¸Šçš„ synchronized</a><ol><li><ol><li><ol><li><a href=#ä¸åŠ -synchronized-çš„æ–¹æ³•><strong>ä¸åŠ  synchronized çš„æ–¹æ³•</strong></a></li><li><a href=#æ‰€è°“çš„çº¿ç¨‹å…«é”><strong>æ‰€è°“çš„â€œçº¿ç¨‹å…«é”â€</strong></a></li></ol></li></ol></li></ol></li><li><a href=#44-å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ>4.4 å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ</a><ol><li><ol><li><ol><li><a href=#æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨><strong>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</strong></a></li><li><a href=#å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨><strong>å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</strong></a></li><li><a href=#å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ><strong>å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨åˆ†æ</strong></a></li><li><a href=#å¸¸è§çº¿ç¨‹å®‰å…¨ç±»><strong>å¸¸è§çº¿ç¨‹å®‰å…¨ç±»</strong></a></li><li><a href=#å®ä¾‹åˆ†æ>å®ä¾‹åˆ†æ</a></li></ol></li></ol></li></ol></li><li><a href=#45-ä¹ é¢˜>4.5 ä¹ é¢˜</a><ol><li><ol><li><ol><li><a href=#å–ç¥¨ç»ƒä¹ >å–ç¥¨ç»ƒä¹ </a></li><li><a href=#è½¬è´¦ç»ƒä¹ >è½¬è´¦ç»ƒä¹ </a></li></ol></li></ol></li></ol></li><li><a href=#46-monitor-æ¦‚å¿µ>4.6 Monitor æ¦‚å¿µ</a><ol><li><a href=#java-å¯¹è±¡å¤´><strong>Java å¯¹è±¡å¤´</strong></a></li><li><a href=#font-colorblue-åŸç†ä¹‹monitoré”font><font color=blue>* åŸç†ä¹‹Monitor(é”)</font></a></li><li><a href=#font-colorblue-åŸç†ä¹‹-synchronizedfont><font color=blue>* åŸç†ä¹‹ synchronized</font></a></li><li><a href=#font-colorblue-åŸç†ä¹‹-synchronized-è¿›é˜¶font><font color=blue>* åŸç†ä¹‹ synchronized è¿›é˜¶</font></a><ol><li><a href=#è½»é‡çº§é”>è½»é‡çº§é”</a></li><li><a href=#é”è†¨èƒ€>é”è†¨èƒ€</a></li><li><a href=#è‡ªæ—‹ä¼˜åŒ–>è‡ªæ—‹ä¼˜åŒ–</a></li><li><a href=#åå‘é”>åå‘é”</a><ol><li><a href=#åå‘çŠ¶æ€>åå‘çŠ¶æ€</a></li><li><a href=#æ’¤é”€---è°ƒç”¨å¯¹è±¡-hashcode>æ’¤é”€ - è°ƒç”¨å¯¹è±¡ hashCode</a></li><li><a href=#æ’¤é”€---å…¶å®ƒçº¿ç¨‹ä½¿ç”¨å¯¹è±¡>æ’¤é”€ - å…¶å®ƒçº¿ç¨‹ä½¿ç”¨å¯¹è±¡</a></li><li><a href=#æ’¤é”€---è°ƒç”¨-waitnotify>æ’¤é”€ - è°ƒç”¨ wait/notify</a></li><li><a href=#æ‰¹é‡é‡åå‘><strong>æ‰¹é‡é‡åå‘</strong></a></li><li><a href=#æ‰¹é‡æ’¤é”€>æ‰¹é‡æ’¤é”€</a></li><li><a href=#é”æ¶ˆé™¤>é”æ¶ˆé™¤</a></li></ol></li></ol></li></ol></li><li><a href=#47-wait-notify>4.7 wait notify</a><ol><li><ol><li><a href=#font-colorblue-åŸç†ä¹‹-wait--notifyfont><font color=blue>* åŸç†ä¹‹ wait / notify</font></a></li><li><a href=#api-ä»‹ç»><strong>API ä»‹ç»</strong></a></li></ol></li></ol></li><li><a href=#48-wait-notify-çš„æ­£ç¡®å§¿åŠ¿>4.8 wait notify çš„æ­£ç¡®å§¿åŠ¿</a><ol><li><ol><li><a href=#sleeplong-n-å’Œ-waitlong-n-çš„åŒºåˆ«><code>sleep(long n)</code> å’Œ <code>wait(long n)</code> çš„åŒºåˆ«</a></li><li><a href=#step-1>step 1</a></li><li><a href=#step-2>step 2</a></li><li><a href=#step-3>step 3</a></li><li><a href=#step-4>step 4</a></li><li><a href=#step-5>step 5</a></li><li><a href=#textcolororangeæ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ>$\textcolor{orange}{*æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ}$</a><ol><li><a href=#1å®šä¹‰><strong>1.å®šä¹‰</strong></a></li><li><a href=#2å®ç°><strong>2.å®ç°</strong></a></li><li><a href=#3å¸¦è¶…æ—¶ç‰ˆ-guardedobject><strong>3.å¸¦è¶…æ—¶ç‰ˆ GuardedObject</strong></a></li><li><a href=#textcolorblue-åŸç†ä¹‹-join>$\textcolor{blue}{* åŸç†ä¹‹ join}$</a></li><li><a href=#4å¤šä»»åŠ¡ç‰ˆguardedobject><strong>4.å¤šä»»åŠ¡ç‰ˆ</strong>GuardedObject</a></li></ol></li><li><a href=#textcolororange-æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…>$\textcolor{orange}{* æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…}$</a><ol><li><a href=#1å®šä¹‰-1>1.å®šä¹‰</a></li><li><a href=#2å®ç°-1>2.å®ç°</a></li></ol></li></ol></li></ol></li><li><a href=#49-park--unpark>4.9 Park & Unpark</a><ol><li><ol><li><ol><li><a href=#åŸºæœ¬ä½¿ç”¨>åŸºæœ¬ä½¿ç”¨</a></li><li><a href=#ç‰¹ç‚¹>ç‰¹ç‚¹</a></li><li><a href=#textcolorblue-åŸç†ä¹‹parkå’Œunpark>$\textcolor{blue}{* åŸç†ä¹‹parkå’Œunpark}$</a></li></ol></li></ol></li></ol></li><li><a href=#410-é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢>4.10 é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢</a><ol><li><ol><li><ol><li><a href=#æƒ…å†µ-1-new----runnable>æƒ…å†µ 1 <code>NEW --> RUNNABLE</code></a></li><li><a href=#æƒ…å†µ-2-runnable----waiting>æƒ…å†µ 2 <code>RUNNABLE &lt;--> WAITING</code></a></li><li><a href=#æƒ…å†µ-3-runnable----waiting>æƒ…å†µ 3 <code>RUNNABLE &lt;--> WAITING</code></a></li><li><a href=#æƒ…å†µ-4-runnable----waiting>æƒ…å†µ 4 <code>RUNNABLE &lt;--> WAITING</code></a></li><li><a href=#æƒ…å†µ-5-runnable----timed_waiting>æƒ…å†µ 5 <code>RUNNABLE &lt;--> TIMED_WAITING</code></a></li><li><a href=#æƒ…å†µ-6-runnable----timed_waiting>æƒ…å†µ 6 <code>RUNNABLE &lt;--> TIMED_WAITING</code></a></li><li><a href=#æƒ…å†µ-7-runnable----timed_waiting>æƒ…å†µ 7 <code>RUNNABLE &lt;--> TIMED_WAITING</code></a></li><li><a href=#æƒ…å†µ-8-runnable----timed_waiting>æƒ…å†µ 8 <code>RUNNABLE &lt;--> TIMED_WAITING</code></a></li><li><a href=#æƒ…å†µ-9-runnable----blocked>æƒ…å†µ 9 <code>RUNNABLE &lt;--> BLOCKED</code></a></li><li><a href=#æƒ…å†µ-10-runnable----terminated>æƒ…å†µ 10 <code>RUNNABLE &lt;--> TERMINATED</code></a></li></ol></li></ol></li></ol></li><li><a href=#411-å¤šæŠŠé”>4.11 å¤šæŠŠé”</a></li><li><a href=#412-æ´»è·ƒæ€§>4.12 æ´»è·ƒæ€§</a><ol><li><ol><li><ol><li><a href=#æ­»é”><strong>æ­»é”</strong></a></li><li><a href=#å®šä½æ­»é”><strong>å®šä½æ­»é”</strong></a></li><li><a href=#æ´»é”><strong>æ´»é”</strong></a></li><li><a href=#é¥¥é¥¿><strong>é¥¥é¥¿</strong></a></li></ol></li></ol></li></ol></li><li><a href=#413-reentrantlock>4.13 ReentrantLock</a><ol><li><ol><li><a href=#å¯é‡å…¥>å¯é‡å…¥</a></li><li><a href=#å¯æ‰“æ–­>å¯æ‰“æ–­</a></li><li><a href=#é”è¶…æ—¶>é”è¶…æ—¶</a></li><li><a href=#å…¬å¹³é”>å…¬å¹³é”</a></li><li><a href=#æ¡ä»¶å˜é‡>æ¡ä»¶å˜é‡</a><ol><li><a href=#ä½¿ç”¨è¦ç‚¹>ä½¿ç”¨è¦ç‚¹</a></li><li><a href=#è¯¦ç»†api>è¯¦ç»†API</a></li></ol></li><li><a href=#font-colororange-åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶font><font color=orange>* åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</font></a><ol><li><a href=#å›ºå®šè¿è¡Œé¡ºåº>å›ºå®šè¿è¡Œé¡ºåº</a></li><li><a href=#äº¤æ›¿è¾“å‡º>äº¤æ›¿è¾“å‡º</a></li></ol></li></ol></li></ol></li><li><a href=#æœ¬ç« å°ç»“-1>æœ¬ç« å°ç»“</a></li></ol></li><li><a href=#5å…±äº«æ¨¡å‹ä¹‹å†…å­˜>5.å…±äº«æ¨¡å‹ä¹‹å†…å­˜</a><ol><li><a href=#51-java-å†…å­˜æ¨¡å‹>5.1 Java å†…å­˜æ¨¡å‹</a></li><li><a href=#52-å¯è§æ€§>5.2 å¯è§æ€§</a><ol><li><ol><li><a href=#é€€ä¸å‡ºçš„å¾ªç¯>é€€ä¸å‡ºçš„å¾ªç¯</a></li><li><a href=#è§£å†³æ–¹æ³•>è§£å†³æ–¹æ³•</a></li><li><a href=#å¯è§æ€§-vs-åŸå­æ€§>å¯è§æ€§ vs åŸå­æ€§</a></li><li><a href=#font-colororange-æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢font-1><font color=orange>* æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢</font></a><ol><li><a href=#1é”™è¯¯æ€è·¯>1.é”™è¯¯æ€è·¯</a></li><li><a href=#2ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼>2.ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</a></li><li><a href=#åˆ©ç”¨volatileä¿®é¥°çš„åœæ­¢æ ‡è®°>åˆ©ç”¨volatileä¿®é¥°çš„åœæ­¢æ ‡è®°</a></li></ol></li><li><a href=#font-colororange-æ¨¡å¼ä¹‹-balkingfont><font color=orange>* æ¨¡å¼ä¹‹ Balking</font></a><ol><li><a href=#1å®šä¹‰-2>1.å®šä¹‰</a></li><li><a href=#2å®ç°-2>2.å®ç°</a></li></ol></li></ol></li></ol></li><li><a href=#53-æœ‰åºæ€§>5.3 æœ‰åºæ€§</a><ol><li><ol><li><a href=#font-colorblue-åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œfont><font color=blue>* åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ</font></a><ol><li><a href=#åè¯>åè¯</a></li><li><a href=#æŒ‡ä»¤é‡æ’åºä¼˜åŒ–>æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</a></li><li><a href=#æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨>æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨</a></li><li><a href=#superscalar-å¤„ç†å™¨>SuperScalar å¤„ç†å™¨</a></li></ol></li><li><a href=#è¯¡å¼‚çš„ç»“æœ>è¯¡å¼‚çš„ç»“æœ</a></li><li><a href=#è§£å†³æ–¹æ³•-1>è§£å†³æ–¹æ³•</a></li><li><a href=#font-colorblue-åŸç†ä¹‹-volatilefont><font color=blue>* åŸç†ä¹‹ volatile</font></a><ol><li><a href=#å¦‚ä½•ä¿è¯å¯è§æ€§>å¦‚ä½•ä¿è¯å¯è§æ€§</a></li><li><a href=#å¦‚ä½•ä¿è¯æœ‰åºæ€§>å¦‚ä½•ä¿è¯æœ‰åºæ€§</a></li><li><a href=#double-checked-locking-é—®é¢˜>double-checked locking é—®é¢˜</a></li><li><a href=#double-checked-locking-è§£å†³>double-checked locking è§£å†³</a></li></ol></li><li><a href=#happens-before>happens-before</a></li><li><a href=#ä¹ é¢˜>ä¹ é¢˜</a><ol><li><a href=#balking-æ¨¡å¼ä¹ é¢˜>balking æ¨¡å¼ä¹ é¢˜</a></li><li><a href=#çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜>çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜</a></li></ol></li></ol></li></ol></li><li><a href=#æœ¬ç« å°ç»“-2>æœ¬ç« å°ç»“</a></li></ol></li><li><a href=#6å…±äº«æ¨¡å‹ä¹‹æ— é”>6.å…±äº«æ¨¡å‹ä¹‹æ— é”</a><ol><li><a href=#61-é—®é¢˜æå‡º-åº”ç”¨ä¹‹äº’æ–¥>6.1 é—®é¢˜æå‡º (åº”ç”¨ä¹‹äº’æ–¥)</a><ol><li><ol><li><ol><li><a href=#ä¸ºä»€ä¹ˆä¸å®‰å…¨><strong>ä¸ºä»€ä¹ˆä¸å®‰å…¨</strong></a></li><li><a href=#è§£å†³æ€è·¯-é”æ‚²è§‚äº’æ–¥><strong>è§£å†³æ€è·¯-é”</strong>ï¼ˆæ‚²è§‚äº’æ–¥ï¼‰</a></li><li><a href=#è§£å†³æ€è·¯-æ— é”ä¹è§‚é‡è¯•><strong>è§£å†³æ€è·¯-æ— é”</strong>ï¼ˆä¹è§‚é‡è¯•ï¼‰</a></li></ol></li></ol></li></ol></li><li><a href=#62-cas-ä¸-volatile>6.2 CAS ä¸ volatile</a><ol><li><ol><li><ol><li><a href=#æ…¢åŠ¨ä½œåˆ†æ>æ…¢åŠ¨ä½œåˆ†æ</a></li><li><a href=#volatile>volatile</a></li><li><a href=#cas-çš„ç‰¹ç‚¹>CAS çš„ç‰¹ç‚¹</a></li></ol></li></ol></li></ol></li><li><a href=#63-åŸå­æ•´æ•°>6.3 åŸå­æ•´æ•°</a></li><li><a href=#64-åŸå­å¼•ç”¨>6.4 åŸå­å¼•ç”¨</a><ol><li><ol><li><ol><li><a href=#ä¸å®‰å…¨å®ç°><strong>ä¸å®‰å…¨å®ç°</strong></a></li><li><a href=#å®‰å…¨å®ç°-ä½¿ç”¨é”><strong>å®‰å…¨å®ç°-ä½¿ç”¨é”</strong></a></li><li><a href=#å®‰å…¨å®ç°-ä½¿ç”¨-cas><strong>å®‰å…¨å®ç°-ä½¿ç”¨ CAS</strong></a></li><li><a href=#aba-é—®é¢˜åŠè§£å†³>ABA é—®é¢˜åŠè§£å†³</a></li></ol></li></ol></li></ol></li><li><a href=#65-åŸå­æ•°ç»„>6.5 åŸå­æ•°ç»„</a></li><li><a href=#66-å­—æ®µæ›´æ–°å™¨>6.6 å­—æ®µæ›´æ–°å™¨</a></li><li><a href=#67-åŸå­ç´¯åŠ å™¨>6.7 åŸå­ç´¯åŠ å™¨</a><ol><li><ol><li><a href=#ç´¯åŠ å™¨æ€§èƒ½æ¯”è¾ƒ>ç´¯åŠ å™¨æ€§èƒ½æ¯”è¾ƒ</a></li><li><a href=#font-colorblue-åŸç†ä¹‹ä¼ªå…±äº«cpu-ç¼“å­˜ç»“æ„font><font color=blue>* åŸç†ä¹‹ä¼ªå…±äº«(CPU ç¼“å­˜ç»“æ„)</font></a><ol><li><a href=#cpu-ç¼“å­˜ç»“æ„><strong>CPU ç¼“å­˜ç»“æ„</strong></a></li><li><a href=#cpu-ç¼“å­˜è¯»><strong>CPU ç¼“å­˜è¯»</strong></a></li><li><a href=#cpu-ç¼“å­˜ä¸€è‡´æ€§><strong>CPU ç¼“å­˜ä¸€è‡´æ€§</strong></a></li><li><a href=#å†…å­˜å±éšœ><strong>å†…å­˜å±éšœ</strong></a></li></ol></li><li><a href=#font-colorblue-æºç ä¹‹-longadderfont><font color=blue>* æºç ä¹‹ LongAdder</font></a></li><li><a href=#ä¸è¿ç®—å’Œå–æ¨¡çš„å…³ç³»>ä¸è¿ç®—å’Œå–æ¨¡çš„å…³ç³»</a></li></ol></li></ol></li><li><a href=#68-unsafe>6.8 Unsafe</a><ol><li><ol><li><a href=#æ¦‚è¿°>æ¦‚è¿°</a></li><li><a href=#unsafe-cas-æ“ä½œ>Unsafe CAS æ“ä½œ</a><ol><li><a href=#unsafeå®ç°å­—æ®µæ›´æ–°>unsafeå®ç°å­—æ®µæ›´æ–°</a></li><li><a href=#unsafeå®ç°åŸå­æ•´æ•°>unsafeå®ç°åŸå­æ•´æ•°</a></li><li><a href=#æ‰‹åŠ¨å®ç°åŸå­æ•´æ•°å®Œæ•´ç‰ˆæµ‹è¯•>æ‰‹åŠ¨å®ç°åŸå­æ•´æ•°å®Œæ•´ç‰ˆ+æµ‹è¯•</a></li></ol></li></ol></li></ol></li><li><a href=#69-è‡ªå®šä¹‰casé”><strong>6.9 è‡ªå®šä¹‰casé”</strong></a></li><li><a href=#æœ¬ç« å°ç»“-3>æœ¬ç« å°ç»“</a></li></ol></li><li><a href=#7å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜>7.å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜</a><ol><li><a href=#71-æ—¥æœŸè½¬æ¢çš„é—®é¢˜>7.1 æ—¥æœŸè½¬æ¢çš„é—®é¢˜</a><ol><li><ol><li><ol><li><a href=#é—®é¢˜æå‡º>é—®é¢˜æå‡º</a></li><li><a href=#æ€è·¯---åŒæ­¥é”>æ€è·¯ - åŒæ­¥é”</a></li><li><a href=#æ€è·¯---ä¸å¯å˜>æ€è·¯ - ä¸å¯å˜</a></li></ol></li></ol></li></ol></li><li><a href=#72-ä¸å¯å˜è®¾è®¡>7.2 ä¸å¯å˜è®¾è®¡</a><ol><li><ol><li><a href=#stringç±»çš„è®¾è®¡>Stringç±»çš„è®¾è®¡</a></li><li><a href=#final-çš„ä½¿ç”¨>final çš„ä½¿ç”¨</a></li><li><a href=#ä¿æŠ¤æ€§æ‹·è´>ä¿æŠ¤æ€§æ‹·è´</a></li><li><a href=#font-colororangeæ¨¡å¼ä¹‹äº«å…ƒfont><font color=orange>*æ¨¡å¼ä¹‹äº«å…ƒ</font></a><ol><li><a href=#ç®€ä»‹>ç®€ä»‹</a></li><li><a href=#ä½“ç°>ä½“ç°</a></li><li><a href=#æ‰‹åŠ¨å®ç°ä¸€ä¸ªè¿æ¥æ± >æ‰‹åŠ¨å®ç°ä¸€ä¸ªè¿æ¥æ± </a></li></ol></li><li><a href=#font-colorblue-åŸç†ä¹‹-finalfont><font color=blue>* åŸç†ä¹‹ final</font></a><ol><li><a href=#è®¾ç½®-final-å˜é‡çš„åŸç†>è®¾ç½® final å˜é‡çš„åŸç†</a></li><li><a href=#è¯»å–finalå˜é‡åŸç†>è¯»å–finalå˜é‡åŸç†</a></li><li><a href=#finalæ€»ç»“>finalæ€»ç»“</a></li></ol></li></ol></li></ol></li><li><a href=#73-æ— çŠ¶æ€>7.3 æ— çŠ¶æ€</a></li></ol></li><li><a href=#8å…±äº«æ¨¡å‹ä¹‹å·¥å…·>8.å…±äº«æ¨¡å‹ä¹‹å·¥å…·</a><ol><li><a href=#çº¿ç¨‹æ± >çº¿ç¨‹æ± </a><ol><li><ol><li><a href=#è‡ªå®šä¹‰çº¿ç¨‹æ± >è‡ªå®šä¹‰çº¿ç¨‹æ± </a></li><li><a href=#threadpoolexecutor>ThreadPoolExecutor</a><ol><li><a href=#çº¿ç¨‹æ± çŠ¶æ€>çº¿ç¨‹æ± çŠ¶æ€</a></li><li><a href=#æ„é€ æ–¹æ³•>æ„é€ æ–¹æ³•</a></li><li><a href=#å·¥ä½œæ–¹å¼>å·¥ä½œæ–¹å¼</a></li><li><a href=#newfixedthreadpool>newFixedThreadPool</a></li><li><a href=#newcachedthreadpool>newCachedThreadPool</a></li><li><a href=#newsinglethreadexecutor>newSingleThreadExecutor</a></li><li><a href=#æäº¤ä»»åŠ¡>æäº¤ä»»åŠ¡</a></li><li><a href=#å…³é—­çº¿ç¨‹æ± >å…³é—­çº¿ç¨‹æ± </a></li><li><a href=#font-colororangeæ¨¡å¼ä¹‹-worker-threadfont><font color=orange>*æ¨¡å¼ä¹‹ Worker Thread</font></a></li><li><a href=#ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± >ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </a></li><li><a href=#æ­£ç¡®å¤„ç†æ‰§è¡Œä»»åŠ¡å¼‚å¸¸>æ­£ç¡®å¤„ç†æ‰§è¡Œä»»åŠ¡å¼‚å¸¸</a></li><li><a href=#font-colorgreen-åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡font><font color=green>* åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡</font></a></li><li><a href=#tomcat-çº¿ç¨‹æ± >Tomcat çº¿ç¨‹æ± </a></li></ol></li><li><a href=#forkjoin>Fork/Join</a><ol><li><a href=#æ¦‚å¿µ>æ¦‚å¿µ</a></li><li><a href=#font-colorgreenåº”ç”¨ä¹‹æ±‚å’Œfont><font color=green>åº”ç”¨ä¹‹æ±‚å’Œ</font></a></li></ol></li></ol></li></ol></li><li><a href=#font-colorblueaqs-åŸç†font><font color=blue>*AQS åŸç†</font></a><ol><li><a href=#æ¦‚è¿°-1>æ¦‚è¿°</a></li><li><a href=#å®ç°ä¸å¯é‡å…¥é”>å®ç°ä¸å¯é‡å…¥é”</a><ol><li><ol><li><a href=#è‡ªå®šä¹‰åŒæ­¥å™¨><strong>è‡ªå®šä¹‰åŒæ­¥å™¨</strong></a></li><li><a href=#è‡ªå®šä¹‰é”><strong>è‡ªå®šä¹‰é”</strong></a></li></ol></li></ol></li><li><a href=#å¿ƒå¾—>å¿ƒå¾—</a><ol><li><ol><li><a href=#èµ·æº><strong>èµ·æº</strong></a></li><li><a href=#ç›®æ ‡><strong>ç›®æ ‡</strong></a></li><li><a href=#è®¾è®¡><strong>è®¾è®¡</strong></a></li><li><a href=#ä¸»è¦ç”¨åˆ°-aqs-çš„å¹¶å‘å·¥å…·ç±»>ä¸»è¦ç”¨åˆ° AQS çš„å¹¶å‘å·¥å…·ç±»</a></li></ol></li></ol></li></ol></li><li><a href=#reentrantlock-åŸç†>ReentrantLock åŸç†</a><ol><li><a href=#éå…¬å¹³é”å®ç°åŸç†>éå…¬å¹³é”å®ç°åŸç†</a><ol><li><ol><li><a href=#åŠ é”è§£é”æµç¨‹>åŠ é”è§£é”æµç¨‹</a></li><li><a href=#åŠ é”æºç >åŠ é”æºç </a></li><li><a href=#è§£é”æºç >è§£é”æºç </a></li></ol></li></ol></li><li><a href=#å¯é‡å…¥åŸç†>å¯é‡å…¥åŸç†</a></li><li><a href=#å¯æ‰“æ–­åŸç†>å¯æ‰“æ–­åŸç†</a></li><li><a href=#å…¬å¹³é”å®ç°åŸç†>å…¬å¹³é”å®ç°åŸç†</a></li><li><a href=#æ¡ä»¶å˜é‡å®ç°åŸç†>æ¡ä»¶å˜é‡å®ç°åŸç†</a><ol><li><a href=#await-æµç¨‹>await æµç¨‹</a></li><li><a href=#signal-æµç¨‹>signal æµç¨‹</a></li><li><a href=#æºç >æºç </a></li></ol></li></ol></li><li><a href=#è¯»å†™é”>è¯»å†™é”</a><ol><li><a href=#reentrantreadwritelock>ReentrantReadWriteLock</a></li><li><a href=#font-colorgreen-åº”ç”¨ä¹‹ç¼“å­˜font><font color=green>* åº”ç”¨ä¹‹ç¼“å­˜</font></a><ol><li><ol><li><a href=#ç¼“å­˜æ›´æ–°ç­–ç•¥>ç¼“å­˜æ›´æ–°ç­–ç•¥</a></li><li><a href=#è¯»å†™é”å®ç°ä¸€è‡´æ€§ç¼“å­˜>è¯»å†™é”å®ç°ä¸€è‡´æ€§ç¼“å­˜</a></li></ol></li></ol></li><li><a href=#font-colorblue-è¯»å†™é”åŸç†font><font color=blue>* è¯»å†™é”åŸç†</font></a><ol><li><a href=#å›¾è§£æµç¨‹>å›¾è§£æµç¨‹</a></li><li><a href=#æºç åˆ†æ>æºç åˆ†æ</a><ol><li><a href=#å†™é”ä¸Šé”æµç¨‹><strong>å†™é”ä¸Šé”æµç¨‹</strong></a></li><li><a href=#å†™é”é‡Šæ”¾æµç¨‹><strong>å†™é”é‡Šæ”¾æµç¨‹</strong></a></li><li><a href=#è¯»é”ä¸Šé”æµç¨‹><strong>è¯»é”ä¸Šé”æµç¨‹</strong></a></li><li><a href=#è¯»é”é‡Šæ”¾æµç¨‹><strong>è¯»é”é‡Šæ”¾æµç¨‹</strong></a></li></ol></li></ol></li><li><a href=#stampedlock>StampedLock</a></li></ol></li><li><a href=#semaphore>Semaphore</a><ol><li><a href=#åŸºæœ¬ä½¿ç”¨-1>åŸºæœ¬ä½¿ç”¨</a></li><li><a href=#font-colorgreen-semaphore-åº”ç”¨font><font color=green>* Semaphore åº”ç”¨</font></a></li><li><a href=#font-colorblue-semaphore-åŸç†font><font color=blue>* Semaphore åŸç†</font></a><ol><li><a href=#åŠ é”è§£é”æµç¨‹-1>åŠ é”è§£é”æµç¨‹</a></li><li><a href=#æºç åˆ†æ-1>æºç åˆ†æ</a><ol><li><a href=#åŠ é”æµç¨‹æ€»ç»“>åŠ é”æµç¨‹æ€»ç»“ï¼š</a></li><li><a href=#è§£é”æµç¨‹æ€»ç»“>è§£é”æµç¨‹æ€»ç»“ï¼š</a></li></ol></li><li><a href=#ä¸ºä»€ä¹ˆè¦æœ‰-propagate>ä¸ºä»€ä¹ˆè¦æœ‰ PROPAGATE</a></li></ol></li></ol></li><li><a href=#countdownlatch>CountdownLatch</a><ol><li><a href=#font-colorgreen-åº”ç”¨ä¹‹åŒæ­¥ç­‰å¾…å¤šçº¿ç¨‹å‡†å¤‡å®Œæ¯•font><font color=green>* åº”ç”¨ä¹‹åŒæ­¥ç­‰å¾…å¤šçº¿ç¨‹å‡†å¤‡å®Œæ¯•</font></a></li><li><a href=#font-colorgreen-åº”ç”¨ä¹‹åŒæ­¥ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸfont><font color=green>* åº”ç”¨ä¹‹åŒæ­¥ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸ</font></a></li></ol></li><li><a href=#cyclicbarrier>CyclicBarrier</a></li><li><a href=#çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°>çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°</a></li><li><a href=#concurrenthashmap>ConcurrentHashMap</a><ol><li><a href=#font-colorgreenåº”ç”¨ä¹‹å•è¯è®¡æ•°font><font color=green>åº”ç”¨ä¹‹å•è¯è®¡æ•°</font></a><ol><li><ol><li><a href=#å®ç°ä¸€>å®ç°ä¸€ï¼š</a></li><li><a href=#æ­£ç¡®ç­”æ¡ˆä¸€>æ­£ç¡®ç­”æ¡ˆä¸€ï¼š</a></li><li><a href=#æ­£ç¡®ç­”æ¡ˆäºŒ>æ­£ç¡®ç­”æ¡ˆäºŒï¼š</a></li></ol></li></ol></li><li><a href=#font-colorblue-concurrenthashmap-åŸç†font><font color=blue>* ConcurrentHashMap åŸç†</font></a><ol><li><a href=#jdk-7-hashmap-å¹¶å‘æ­»é“¾>JDK 7 HashMap å¹¶å‘æ­»é“¾</a><ol><li><a href=#æµ‹è¯•ä»£ç >æµ‹è¯•ä»£ç </a></li><li><a href=#æ­»é“¾å¤ç°>æ­»é“¾å¤ç°</a></li><li><a href=#æºç åˆ†æ-2><strong>æºç åˆ†æ</strong></a></li></ol></li><li><a href=#jdk-8-concurrenthashmap>JDK 8 ConcurrentHashMap</a><ol><li><a href=#é‡è¦å±æ€§å’Œå†…éƒ¨ç±»>é‡è¦å±æ€§å’Œå†…éƒ¨ç±»</a></li><li><a href=#é‡è¦æ–¹æ³•>é‡è¦æ–¹æ³•</a></li><li><a href=#æ„é€ å™¨åˆ†æ>æ„é€ å™¨åˆ†æ</a></li><li><a href=#getæµç¨‹>getæµç¨‹</a></li><li><a href=#put-æµç¨‹>put æµç¨‹</a></li><li><a href=#size-è®¡ç®—æµç¨‹>size è®¡ç®—æµç¨‹</a></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ol></li><li><a href=#jdk-7-concurrenthashmap>JDK 7 ConcurrentHashMap</a><ol><li><a href=#æ„é€ å™¨åˆ†æ-1>æ„é€ å™¨åˆ†æ</a></li><li><a href=#put-æµç¨‹-1>put æµç¨‹</a></li><li><a href=#rehash-æµç¨‹>rehash æµç¨‹</a></li><li><a href=#get-æµç¨‹>get æµç¨‹</a></li><li><a href=#size-è®¡ç®—æµç¨‹-1>size è®¡ç®—æµç¨‹</a></li></ol></li></ol></li></ol></li><li><a href=#blockingqueue>BlockingQueue</a><ol><li><a href=#font-colorblue-blockingqueue-åŸç†font><font color=blue>* BlockingQueue åŸç†</font></a><ol><li><a href=#åŸºæœ¬çš„å…¥é˜Ÿå‡ºé˜Ÿ>åŸºæœ¬çš„å…¥é˜Ÿå‡ºé˜Ÿ</a><ol><li><a href=#åˆå§‹åŒ–é“¾è¡¨>åˆå§‹åŒ–é“¾è¡¨</a></li><li><a href=#å½“ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ>å½“ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ</a></li><li><a href=#å‡ºé˜Ÿ>å‡ºé˜Ÿ</a></li></ol></li><li><a href=#åŠ é”åˆ†æ>åŠ é”åˆ†æ</a></li><li><a href=#æ€§èƒ½æ¯”è¾ƒ>æ€§èƒ½æ¯”è¾ƒ</a></li></ol></li></ol></li><li><a href=#concurrentlinkedqueue>ConcurrentLinkedQueue</a><ol><li><a href=#font-colorblueconcurrentlinkedqueue-åŸç†font><font color=blue>*ConcurrentLinkedQueue åŸç†</font></a><ol><li><a href=#æ¨¡ä»¿-concurrentlinkedqueue>æ¨¡ä»¿ ConcurrentLinkedQueue</a></li></ol></li></ol></li><li><a href=#copyonwritearraylist>CopyOnWriteArrayList</a><ol><li><ol><li><ol><li><a href=#get-å¼±ä¸€è‡´æ€§image-20220317202641399httpslogan1357810xyznotgitjucimage-20220317202641399png>get å¼±ä¸€è‡´æ€§<img src=https://logan.1357810.xyz/notgit/juc/image-20220317202641399.png alt=image-20220317202641399></a></li><li><a href=#è¿­ä»£å™¨å¼±ä¸€è‡´æ€§>è¿­ä»£å™¨å¼±ä¸€è‡´æ€§</a></li></ol></li></ol></li></ol></li></ol></li></ol></nav></div></section><script>var toggleButton=document.getElementById("toggle-toc"),tocContainer=document.getElementById("toc-container"),scrollThreshold=400;function extracted(){var e=window.scrollY||window.pageYOffset;e>=scrollThreshold?(toggleButton.style.visibility="visible",toggleButton.style.opacity="1"):(toggleButton.style.opacity="0",toggleButton.style.visibility="hidden")}window.addEventListener("scroll",function(){extracted()}),window.onload=function(){extracted()},toggleButton.addEventListener("click",function(e){tocContainer.style.display==="none"||tocContainer.style.display===""?tocContainer.style.display="block":tocContainer.style.display="none",e.stopPropagation()}),"ontouchstart"in window||toggleButton.addEventListener("mouseover",function(){tocContainer.style.display="block"}),document.addEventListener("click",function(e){!tocContainer.contains(e.target)&&!toggleButton.contains(e.target)&&e.target!==toggleButton&&e.target!==tocContainer&&(tocContainer.style.display="none")})</script><script src=https://cdn.bootcdn.net/ajax/libs/nprogress/0.2.0/nprogress.min.js crossorigin=anonymous></script><div class=top-scroll-bar></div><style>.top-scroll-bar,.page-load-progress-bar{position:fixed;top:0;left:0;z-index:9999;display:none;width:0;height:4px;border-radius:5px;background-image:linear-gradient(to right,#5a0ca6 0%,rgba(208,114,155,.84) 50%,#29d 100%); [data-scheme="light"] & { background-image: linear-gradient(to right, #78ee6e 0%, #5069e3 50%, #29d 100%); }}#nprogress{pointer-events:none}#nprogress .my_bar{background-image:linear-gradient(to right,#5a0ca6 0%,rgba(208,114,155,.84) 50%,#29d 100%); [data-scheme="light"] & { background-image: linear-gradient(to right, #78ee6e 0%, #5069e3 50%, #29d 100%); } position: fixed;z-index:9999;top:0;left:0;border-radius:10px;width:100%;height:5px}#nprogress .my_peg{display:block;position:absolute;right:0;width:100px;height:100%;box-shadow:0 0 10px #29d,0 0 5px #29d;opacity:1;-webkit-transform:rotate(3deg)translate(0,-4px);-ms-transform:rotate(3deg)translate(0,-4px);transform:rotate(3deg)translate(0,-4px)}#nprogress .my_spinner{display:block;position:fixed;z-index:1031;top:15px;right:15px}#nprogress .my_spinner-icon{width:25px;height:25px;box-sizing:border-box;border:solid 3px transparent;border-top-color:#29d;border-left-color:#29d;border-radius:50%;-webkit-animation:nprogress-spinner 400ms linear infinite;animation:nprogress-spinner 400ms linear infinite}.nprogress-custom-parent{overflow:hidden;position:relative}.nprogress-custom-parent #nprogress .my_spinner,.nprogress-custom-parent #nprogress .my_bar{position:absolute}@-webkit-keyframes nprogress-spinner{0%{-webkit-transform:rotate(0)}100%{-webkit-transform:rotate(360deg)}}@keyframes nprogress-spinner{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style><script>var my_template='<div class="my_bar" role="bar"><div class="my_peg"></div></div><div class="my_spinner" role="spinner"><div class="my_spinner-icon"></div></div>';NProgress.configure({template:my_template}),NProgress.start(),document.addEventListener("readystatechange",()=>{if(document.readyState==="interactive"&&NProgress.inc(.6),document.readyState==="complete"){NProgress.done(!0),NProgress.configure({template:my_template,minimum:0,trickle:!1,showSpinner:!1});var e=document.querySelector(".top-scroll-bar");window.addEventListener("scroll",function(){var t=document.documentElement.scrollTop||document.body.scrollTop,n=document.documentElement.scrollHeight-document.documentElement.clientHeight,s=t/n*100;e.style.width=s+"%",e.style.display="block"})}})</script><script>function loadScript(e,t){var n=document.querySelector('script[src="'+e+'"]'),s=!1;n.onload=function(){s||(s=!0,t&&window[t]())},n.onreadystatechange=function(){!s&&(n.readyState==="loaded"||n.readyState==="complete")&&(s=!0,t&&window[t]())}}</script></body></html>